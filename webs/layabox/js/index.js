webpackJsonp([0],[,,function(t,e,i){var n,r;n=[i,e,i(0),i(3),i(1),i(4),i(5),i(6)],void 0!==(r=function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),new(function(){function t(){Laya3D.init(0,0,!0),Laya.stage.scaleMode=Laya.Stage.SCALE_FULL,Laya.stage.screenMode=Laya.Stage.SCREEN_NONE,Laya.Stat.show();var t=Laya.stage.addChild(new Laya.Scene),e=t.addChild(new Laya.Camera(0,.1,100));e.transform.translate(new Laya.Vector3(0,3,3)),e.transform.rotate(new Laya.Vector3(-30,0,0),!0,!1),e.clearColor=null;var i=t.addChild(new Laya.DirectionLight);i.ambientColor=new Laya.Vector3(.6,.6,.6),i.specularColor=new Laya.Vector3(.6,.6,.6),i.diffuseColor=new Laya.Vector3(1.6,1.6,1.6),i.direction=new Laya.Vector3(1,-1,0);var n=t.addChild(new Laya.MeshSprite3D(new Laya.BoxMesh(1,1,1)));n.transform.rotate(new Laya.Vector3(0,45,0),!1,!1);var r=new Laya.StandardMaterial;r.diffuseTexture=Laya.Texture2D.load("res/layabox.png"),n.meshRender.material=r;var a=new Laya.Vector3(1,1,0);Laya.timer.loop(10,null,function(){n.transform.rotate(a,!0,!1)})}return t}())}.apply(e,n))&&(t.exports=r)},function(t,e){},function(t,e,i){var n,r;!function(t,e,i){var n=(i.un,i.uns,i.static),r=i.class,a=i.getset,s=i.__newvec,o=laya.maths.Arith,l=laya.maths.Bezier,h=laya.resource.Bitmap,u=laya.utils.Browser,_=laya.utils.Byte,c=laya.utils.Color,d=(laya.filters.ColorFilter,i.Config),f=laya.resource.Context,m=(laya.events.Event,laya.filters.Filter),p=laya.display.Graphics,v=laya.resource.HTMLCanvas,g=(laya.utils.HTMLChar,laya.resource.HTMLImage),E=laya.resource.HTMLSubImage,x=(laya.utils.Handler,laya.net.Loader,laya.maths.Matrix),T=laya.maths.Point,S=laya.maths.Rectangle,D=laya.renders.Render,M=(laya.renders.RenderContext,laya.renders.RenderSprite),y=laya.resource.Resource,A=laya.resource.ResourceManager,I=laya.utils.RunDriver,R=laya.display.Sprite,C=laya.display.Stage,b=laya.utils.Stat,w=laya.utils.StringKey,N=(laya.display.css.Style,laya.system.System),P=laya.display.Text,L=laya.resource.Texture,O=(laya.display.css.TransformInfo,laya.net.URL,laya.utils.Utils),V=laya.utils.VectorGraphManager;laya.utils.WordText;i.interface("laya.webgl.shapes.IShape"),i.interface("laya.webgl.submit.ISubmit"),i.interface("laya.webgl.text.ICharSegment"),i.interface("laya.webgl.canvas.save.ISaveData"),i.interface("laya.webgl.resource.IMergeAtlasBitmap"),i.interface("laya.filters.IFilterActionGL","laya.filters.IFilterAction");var F=function(){function t(){}r(t,"laya.filters.webgl.FilterActionGL");var e=t.prototype;return i.imps(e,{"laya.filters.IFilterActionGL":!0}),e.setValue=function(t){},e.setValueMix=function(t){},e.apply3d=function(t,e,i,n,r){return null},e.apply=function(t){return null},a(0,e,"typeMix",function(){return 0}),t}(),B=function(){function t(){}return r(t,"laya.webgl.shader.ShaderValue"),t}(),U=function(){function t(t,e,n){this._atlasID=0,this._width=0,this._height=0,this._texCount=0,this._rowInfo=null,this._cells=null,this._failSize=new i,void 0===t&&(t=0),void 0===e&&(e=0),void 0===n&&(n=0),this._cells=null,this._rowInfo=null,this._init(t,e),this._atlasID=n}var e,i;r(t,"laya.webgl.atlas.AtlasGrid");var n=t.prototype;return n.getAltasID=function(){return this._atlasID},n.setAltasID=function(t){t>=0&&(this._atlasID=t)},n.addTex=function(t,e,i){var n=this._get(e,i);return 0==n.ret?n:(this._fill(n.x,n.y,e,i,t),this._texCount++,n)},n._release=function(){null!=this._cells&&(this._cells.length=0,this._cells=null),this._rowInfo&&(this._rowInfo.length=0,this._rowInfo=null)},n._init=function(t,i){if(this._width=t,this._height=i,this._release(),0==this._width)return!1;this._cells=new Uint8Array(this._width*this._height*3),this._rowInfo=s(this._height);for(var n=0;n<this._height;n++)this._rowInfo[n]=new e;return this._clear(),!0},n._get=function(t,e){var i=new G;if(t>=this._failSize.width&&e>=this._failSize.height)return i;for(var n=-1,r=-1,a=this._width,s=this._height,o=this._cells,l=0;l<s;l++)if(!(this._rowInfo[l].spaceCount<t))for(var h=0;h<a;){var u=3*(l*a+h);if(0!=o[u]||o[u+1]<t||o[u+2]<e)h+=o[u+1];else{n=h,r=l;for(var _=0;_<t;_++)if(o[3*_+u+2]<e){n=-1;break}if(!(n<0))return i.ret=!0,i.x=n,i.y=r,i;h+=o[u+1]}}return i},n._fill=function(t,e,i,n,r){var a=this._width,s=this._height;this._check(t+i<=a&&e+n<=s);for(var o=e;o<n+e;++o){this._check(this._rowInfo[o].spaceCount>=i),this._rowInfo[o].spaceCount-=i;for(var l=0;l<i;l++){var h=3*(t+o*a+l);this._check(0==this._cells[h]),this._cells[h]=r,this._cells[h+1]=i,this._cells[h+2]=n}}if(t>0)for(o=0;o<n;++o){var u=0;for(l=t-1;l>=0&&0==this._cells[3*((e+o)*a+l)];--l,++u);for(l=u;l>0;--l)this._cells[3*((e+o)*a+t-l)+1]=l,this._check(l>0)}if(e>0)for(l=t;l<t+i;++l){for(u=0,o=e-1;o>=0&&0==this._cells[3*(l+o*a)];--o,u++);for(o=u;o>0;--o)this._cells[3*(l+(e-o)*a)+2]=o,this._check(o>0)}},n._check=function(t){0==t&&console.log("xtexMerger 错误啦")},n._clear=function(){this._texCount=0;for(var t=0;t<this._height;t++)this._rowInfo[t].spaceCount=this._width;for(var e=0;e<this._height;e++)for(var i=0;i<this._width;i++){var n=3*(e*this._width+i);this._cells[n]=0,this._cells[n+1]=this._width-i,this._cells[n+2]=this._width-e}this._failSize.width=this._width+1,this._failSize.height=this._height+1},t.__init$=function(){e=function(){function t(){this.spaceCount=0}return r(t,""),t}(),i=function(){function t(){this.width=0,this.height=0}return r(t,""),t}()},t}(),H=function(){function t(t,e,i,n){this._currentAtlasCount=0,this._maxAtlaserCount=0,this._width=0,this._height=0,this._gridSize=0,this._gridNumX=0,this._gridNumY=0,this._init=!1,this._curAtlasIndex=0,this._setAtlasParam=!1,this._atlaserArray=null,this._needGC=!1,this._setAtlasParam=!0,this._width=t,this._height=e,this._gridSize=i,this._maxAtlaserCount=n,this._gridNumX=t/i,this._gridNumY=e/i,this._curAtlasIndex=0,this._atlaserArray=[]}r(t,"laya.webgl.atlas.AtlasResourceManager");var e=t.prototype;return e.setAtlasParam=function(e,i,n,r){if(1==this._setAtlasParam)return t._sid_=0,this._width=e,this._height=i,this._gridSize=n,this._maxAtlaserCount=r,this._gridNumX=e/n,this._gridNumY=i/n,this._curAtlasIndex=0,this.freeAll(),!0;throw console.log("设置大图合集参数错误，只能在开始页面设置各种参数"),-1},e.pushData=function(e){var i=e.bitmap,n=-1,r=null,a=0,s=0,o=0;for(a=0,s=this._atlaserArray.length;a<s&&(o=(this._curAtlasIndex+a)%s,r=this._atlaserArray[o],-1==(n=r.findBitmapIsExist(i)));a++);if(-1!=n){var l=r.InAtlasWebGLImagesOffsetValue[n];return m=l[0],p=l[1],r.addToAtlas(e,m,p),!0}this._setAtlasParam=!1;for(var h=Math.ceil((e.bitmap.width+2)/this._gridSize),u=Math.ceil((e.bitmap.height+2)/this._gridSize),_=!1,c=0;c<2;c++){var d=this._maxAtlaserCount;for(a=0;a<d;a++){o=(this._curAtlasIndex+a)%d,this._atlaserArray.length-1>=o||this._atlaserArray.push(new At(this._gridNumX,this._gridNumY,this._width,this._height,t._sid_++));var f=this._atlaserArray[o],m=0,p=0,v=f.addTex(1,h,u);if(v.ret){m=v.x*this._gridSize+1,p=v.y*this._gridSize+1,i.lock=!0,f.addToAtlasTexture(i,m,p),f.addToAtlas(e,m,p),_=!0,this._curAtlasIndex=o;break}}if(_)break;this._atlaserArray.push(new At(this._gridNumX,this._gridNumY,this._width,this._height,t._sid_++)),this._needGC=!0,this.garbageCollection(),this._curAtlasIndex=this._atlaserArray.length-1}return _||console.log(">>>AtlasManager pushData error"),_},e.addToAtlas=function(t){laya.webgl.atlas.AtlasResourceManager.instance.pushData(t)},e.garbageCollection=function(){if(!0===this._needGC){for(var t=this._atlaserArray.length-this._maxAtlaserCount,e=0;e<t;e++)this._atlaserArray[e].dispose(),console.log("AtlasResourceManager:Dispose the inner Atlas。");console.log(">>>>altas garbageCollection ="+t),this._atlaserArray.splice(0,t),this._needGC=!1}return!0},e.freeAll=function(){for(var t=0,e=this._atlaserArray.length;t<e;t++)this._atlaserArray[t].dispose();this._atlaserArray.length=0,this._curAtlasIndex=0},e.getAtlaserCount=function(){return this._atlaserArray.length},e.getAtlaserByIndex=function(t){return this._atlaserArray[t]},a(1,t,"instance",function(){return t._Instance||(t._Instance=new t(laya.webgl.atlas.AtlasResourceManager.atlasTextureWidth,laya.webgl.atlas.AtlasResourceManager.atlasTextureHeight,16,laya.webgl.atlas.AtlasResourceManager.maxTextureCount)),t._Instance}),a(1,t,"enabled",function(){return d.atlasEnable}),a(1,t,"atlasLimitWidth",function(){return t._atlasLimitWidth},function(e){t._atlasLimitWidth=e}),a(1,t,"atlasLimitHeight",function(){return t._atlasLimitHeight},function(e){t._atlasLimitHeight=e}),t._enable=function(){d.atlasEnable=!0},t._disable=function(){d.atlasEnable=!1},t.__init__=function(){t.atlasTextureWidth=2048,t.atlasTextureHeight=2048,t.maxTextureCount=6,t.atlasLimitWidth=512,t.atlasLimitHeight=512},t._atlasLimitWidth=0,t._atlasLimitHeight=0,t.gridSize=16,t.atlasTextureWidth=0,t.atlasTextureHeight=0,t.maxTextureCount=0,t._atlasRestore=0,t.BOARDER_TYPE_NO=0,t.BOARDER_TYPE_RIGHT=1,t.BOARDER_TYPE_LEFT=2,t.BOARDER_TYPE_BOTTOM=4,t.BOARDER_TYPE_TOP=8,t.BOARDER_TYPE_ALL=15,t._sid_=0,t._Instance=null,t}(),G=function(){function t(){this.x=0,this.y=0,this.ret=!1,this.ret=!1,this.x=0,this.y=0}return r(t,"laya.webgl.atlas.MergeFillInfo"),t}(),z=function(){function t(){}return r(t,"laya.webgl.canvas.BlendMode"),t._init_=function(e){t.fns=[t.BlendNormal,t.BlendAdd,t.BlendMultiply,t.BlendScreen,t.BlendOverlay,t.BlendLight,t.BlendMask,t.BlendDestinationOut],t.targetFns=[t.BlendNormalTarget,t.BlendAddTarget,t.BlendMultiplyTarget,t.BlendScreenTarget,t.BlendOverlayTarget,t.BlendLightTarget,t.BlendMask,t.BlendDestinationOut]},t.BlendNormal=function(t){t.blendFunc(1,771)},t.BlendAdd=function(t){t.blendFunc(1,772)},t.BlendMultiply=function(t){t.blendFunc(774,771)},t.BlendScreen=function(t){t.blendFunc(1,1)},t.BlendOverlay=function(t){t.blendFunc(1,769)},t.BlendLight=function(t){t.blendFunc(1,1)},t.BlendNormalTarget=function(t){t.blendFunc(1,771)},t.BlendAddTarget=function(t){t.blendFunc(1,772)},t.BlendMultiplyTarget=function(t){t.blendFunc(774,771)},t.BlendScreenTarget=function(t){t.blendFunc(1,1)},t.BlendOverlayTarget=function(t){t.blendFunc(1,769)},t.BlendLightTarget=function(t){t.blendFunc(1,1)},t.BlendMask=function(t){t.blendFunc(0,770)},t.BlendDestinationOut=function(t){t.blendFunc(0,0)},t.activeBlendFunction=null,t.NORMAL="normal",t.ADD="add",t.MULTIPLY="multiply",t.SCREEN="screen",t.LIGHT="light",t.OVERLAY="overlay",t.DESTINATIONOUT="destination-out",t.fns=[],t.targetFns=[],n(t,["NAMES",function(){return this.NAMES=["normal","add","multiply","screen","overlay","light","mask","destination-out"]},"TOINT",function(){return this.TOINT={normal:0,add:1,multiply:2,screen:3,lighter:1,overlay:4,light:5,mask:6,"destination-out":7}}]),t}(),k=function(){function t(t){this._color=c.create("black"),this.setValue(t)}r(t,"laya.webgl.canvas.DrawStyle");var e=t.prototype;return e.setValue=function(t){if(t){if("string"==typeof t)return void(this._color=c.create(t));if(t instanceof laya.utils.Color)return void(this._color=t)}},e.reset=function(){this._color=c.create("black")},e.equal=function(t){return"string"==typeof t?this._color.strColor===t:t instanceof laya.utils.Color&&this._color.numColor===t.numColor},e.toColorStr=function(){return this._color.strColor},t.create=function(e){if(e){var i;if("string"==typeof e?i=c.create(e):e instanceof laya.utils.Color&&(i=e),i)return i._drawStyle||(i._drawStyle=new t(e))}return laya.webgl.canvas.DrawStyle.DEFAULT},n(t,["DEFAULT",function(){return this.DEFAULT=new t("#000000")}]),t}(),W=function(){function t(){this._x=0,this._y=0,this.dirty=!1,this.offset=0,this.count=0,this.geoStart=0,this.tempArray=[],this.closePath=!1,this.geomatrys=[];Et.mainContext;this.ib=qt.create(35048),this.vb=Qt.create(5)}r(t,"laya.webgl.canvas.Path");var e=t.prototype;return e.addPoint=function(t,e){this.tempArray.push(t,e)},e.getEndPointX=function(){return this.tempArray[this.tempArray.length-2]},e.getEndPointY=function(){return this.tempArray[this.tempArray.length-1]},e.polygon=function(t,e,i,n,r,a){var s;return this.geomatrys.push(this._curGeomatry=s=new bt(t,e,i,n,r,a)),n||(s.fill=!1),void 0==a&&(s.borderWidth=0),s},e.setGeomtry=function(t){this.geomatrys.push(this._curGeomatry=t)},e.drawLine=function(t,e,i,n,r){var a;return this.closePath?this.geomatrys.push(this._curGeomatry=a=new Ct(t,e,i,n,r)):this.geomatrys.push(this._curGeomatry=a=new Rt(t,e,i,n,r)),a.fill=!1,a},e.update=function(){var t=this.ib._byteLength,e=this.geomatrys.length;this.offset=t;for(var i=this.geoStart;i<e;i++)this.geomatrys[i].getData(this.ib,this.vb,this.vb._byteLength/20);this.geoStart=e,this.count=(this.ib._byteLength-t)/mt.BYTES_PIDX},e.reset=function(){this.vb.clear(),this.ib.clear(),this.offset=this.count=this.geoStart=0,this.geomatrys.length=0},e.recover=function(){this._curGeomatry=null,this.vb.destory(),this.vb=null,this.ib.destory(),this.ib=null},t}(),X=function(){function t(){}r(t,"laya.webgl.canvas.save.SaveBase");var e=t.prototype;return i.imps(e,{"laya.webgl.canvas.save.ISaveData":!0}),e.isSaveMark=function(){return!1},e.restore=function(e){this._dataObj[this._valueName]=this._value,t._cache[t._cache._length++]=this,this._newSubmit&&(e._curSubmit=at.RENDERBASE,e._renderKey=0)},t._createArray=function(){var t=[];return t._length=0,t},t._init=function(){var e=t._namemap={};return e[1]="ALPHA",e[2]="fillStyle",e[8]="font",e[256]="lineWidth",e[512]="strokeStyle",e[8192]="_mergeID",e[1024]=e[2048]=e[4096]=[],e[16384]="textBaseline",e[32768]="textAlign",e[65536]="_nBlendType",e[1048576]="shader",e[2097152]="filters",e},t.save=function(e,i,n,r){if((e._saveMark._saveuse&i)!==i){e._saveMark._saveuse|=i;var a=t._cache,s=a._length>0?a[--a._length]:new t;s._value=n[s._valueName=t._namemap[i]],s._dataObj=n,s._newSubmit=r;var o=e._save;o[o._length++]=s}},n(t,["_cache",function(){return this._cache=laya.webgl.canvas.save.SaveBase._createArray()},"_namemap",function(){return this._namemap=t._init()}]),t}(),Y=function(){function t(){this._clipRect=new S}r(t,"laya.webgl.canvas.save.SaveClipRect");var e=t.prototype;return i.imps(e,{"laya.webgl.canvas.save.ISaveData":!0}),e.isSaveMark=function(){return!1},e.restore=function(e){e._clipRect=this._clipSaveRect,t._cache[t._cache._length++]=this,this._submitScissor.submitLength=e._submits._length-this._submitScissor.submitIndex,e._curSubmit=at.RENDERBASE,e._renderKey=0},t.save=function(e,i){if(131072!=(131072&e._saveMark._saveuse)){e._saveMark._saveuse|=131072;var n=t._cache,r=n._length>0?n[--n._length]:new t;r._clipSaveRect=e._clipRect,e._clipRect=r._clipRect.copyFrom(e._clipRect),r._submitScissor=i;var a=e._save;a[a._length++]=r}},n(t,["_cache",function(){return this._cache=X._createArray()}]),t}(),Z=function(){function t(){this._contextX=0,this._contextY=0,this._clipRect=new S,this._rect=new S,this._matrix=new x}r(t,"laya.webgl.canvas.save.SaveClipRectStencil");var e=t.prototype;return i.imps(e,{"laya.webgl.canvas.save.ISaveData":!0}),e.isSaveMark=function(){return!1},e.restore=function(e){ut.restore(e,this._rect,this._saveMatrix,this._contextX,this._contextY),e._clipRect=this._clipSaveRect,e._curMat=this._saveMatrix,e._x=this._contextX,e._y=this._contextY,t._cache[t._cache._length++]=this,e._curSubmit=at.RENDERBASE},t.save=function(e,i,n,r,a,s,o,l,h,u){if(262144!=(262144&e._saveMark._saveuse)){e._saveMark._saveuse|=262144;var _=t._cache,c=_._length>0?_[--_._length]:new t;c._clipSaveRect=e._clipRect,c._clipRect.setTo(o,l,h,u),e._clipRect=c._clipRect,c._rect.x=n,c._rect.y=r,c._rect.width=a,c._rect.height=s,c._contextX=e._x,c._contextY=e._y,c._saveMatrix=e._curMat,e._curMat.copyTo(c._matrix),e._curMat=c._matrix,c._submitStencil=i;var d=e._save;d[d._length++]=c}},n(t,["_cache",function(){return this._cache=X._createArray()}]),t}(),K=function(){function t(){this._saveuse=0}r(t,"laya.webgl.canvas.save.SaveMark");var e=t.prototype;return i.imps(e,{"laya.webgl.canvas.save.ISaveData":!0}),e.isSaveMark=function(){return!0},e.restore=function(e){e._saveMark=this._preSaveMark,t._no[t._no._length++]=this},t.Create=function(e){var i=t._no,n=i._length>0?i[--i._length]:new t;return n._saveuse=0,n._preSaveMark=e._saveMark,e._saveMark=n,n},n(t,["_no",function(){return this._no=X._createArray()}]),t}(),j=function(){function t(){this._matrix=new x}r(t,"laya.webgl.canvas.save.SaveTransform");var e=t.prototype;return i.imps(e,{"laya.webgl.canvas.save.ISaveData":!0}),e.isSaveMark=function(){return!1},e.restore=function(e){e._curMat=this._savematrix,t._no[t._no._length++]=this},t.save=function(e){var i=e._saveMark;if(2048!=(2048&i._saveuse)){i._saveuse|=2048;var n=t._no,r=n._length>0?n[--n._length]:new t;r._savematrix=e._curMat,e._curMat=e._curMat.copyTo(r._matrix);var a=e._save;a[a._length++]=r}},n(t,["_no",function(){return this._no=X._createArray()}]),t}(),q=function(){function t(){}r(t,"laya.webgl.canvas.save.SaveTranslate");var e=t.prototype;return i.imps(e,{"laya.webgl.canvas.save.ISaveData":!0}),e.isSaveMark=function(){return!1},e.restore=function(e){e._curMat;e._x=this._x,e._y=this._y,t._no[t._no._length++]=this},t.save=function(e){var i=t._no,n=i._length>0?i[--i._length]:new t;n._x=e._x,n._y=e._y;var r=e._save;r[r._length++]=n},n(t,["_no",function(){return this._no=X._createArray()}]),t}(),Q=function(){function t(){this.target=null,this.repaint=!1,this._width=NaN,this._height=NaN,this._sp=null,this._clipRect=new S}r(t,"laya.webgl.resource.RenderTargetMAX");var e=t.prototype;return e.setSP=function(t){this._sp=t},e.size=function(t,e){var n=this;if(this._width===t&&this._height===e)return void this.target.size(t,e);this.repaint=!0,this._width=t,this._height=e,this.target?this.target.size(t,e):this.target=Lt.create(t,e),this.target.hasListener("recovered")||this.target.on("recovered",this,function(t){i.timer.callLater(n._sp,n._sp.repaint)})},e._flushToTarget=function(t,e){if(!e._destroy){var i=vt.worldScissorTest,n=vt.worldClipRect;vt.worldClipRect=this._clipRect,this._clipRect.x=this._clipRect.y=0,this._clipRect.width=this._width,this._clipRect.height=this._height,vt.worldScissorTest=!1,Et.mainContext.disable(3089);var r=vt.worldAlpha,a=vt.worldMatrix4,s=vt.worldMatrix,o=vt.worldFilters,l=vt.worldShaderDefines;if(vt.worldMatrix=x.EMPTY,vt.restoreTempArray(),vt.worldMatrix4=vt.TEMPMAT4_ARRAY,vt.worldAlpha=1,vt.worldFilters=null,vt.worldShaderDefines=null,Pt.activeShader=null,e.start(),d.showCanvasMark?e.clear(0,1,0,.3):e.clear(0,0,0,0),t.flush(),e.end(),Pt.activeShader=null,vt.worldAlpha=r,vt.worldMatrix4=a,vt.worldMatrix=s,vt.worldFilters=o,vt.worldShaderDefines=l,vt.worldScissorTest=i,i){var h=vt.height-n.y-n.height;Et.mainContext.scissor(n.x,h,n.width,n.height),Et.mainContext.enable(3089)}vt.worldClipRect=n}},e.flush=function(t){this.repaint&&(this._flushToTarget(t,this.target),this.repaint=!1)},e.drawTo=function(t,e,i,n,r){t.drawTexture(this.target.getTexture(),e,i,n,r,0,0)},e.destroy=function(){this.target&&(this.target.destroy(),this.target=null,this._sp=null)},t}(),$=function(){function t(){this.ALPHA=1,this.shaderType=0,this.defines=new It}return r(t,"laya.webgl.shader.d2.Shader2D"),t.prototype.destroy=function(){this.defines=null,this.filters=null,this.glTexture=null,this.strokeStyle=null,this.fillStyle=null},t.__init__=function(){Yt.addInclude("parts/ColorFilter_ps_uniform.glsl","uniform vec4 colorAlpha;\nuniform mat4 colorMat;"),Yt.addInclude("parts/ColorFilter_ps_logic.glsl","mat4 alphaMat =colorMat;\n\nalphaMat[0][3] *= gl_FragColor.a;\nalphaMat[1][3] *= gl_FragColor.a;\nalphaMat[2][3] *= gl_FragColor.a;\n\ngl_FragColor = gl_FragColor * alphaMat;\ngl_FragColor += colorAlpha/255.0*gl_FragColor.a;\n"),Yt.addInclude("parts/GlowFilter_ps_uniform.glsl","uniform vec4 u_color;\nuniform float u_strength;\nuniform float u_blurX;\nuniform float u_blurY;\nuniform float u_offsetX;\nuniform float u_offsetY;\nuniform float u_textW;\nuniform float u_textH;"),Yt.addInclude("parts/GlowFilter_ps_logic.glsl","const float c_IterationTime = 10.0;\nfloat floatIterationTotalTime = c_IterationTime * c_IterationTime;\nvec4 vec4Color = vec4(0.0,0.0,0.0,0.0);\nvec2 vec2FilterDir = vec2(-(u_offsetX)/u_textW,-(u_offsetY)/u_textH);\nvec2 vec2FilterOff = vec2(u_blurX/u_textW/c_IterationTime * 2.0,u_blurY/u_textH/c_IterationTime * 2.0);\nfloat maxNum = u_blurX * u_blurY;\nvec2 vec2Off = vec2(0.0,0.0);\nfloat floatOff = c_IterationTime/2.0;\nfor(float i = 0.0;i<=c_IterationTime; ++i){\n\tfor(float j = 0.0;j<=c_IterationTime; ++j){\n\t\tvec2Off = vec2(vec2FilterOff.x * (i - floatOff),vec2FilterOff.y * (j - floatOff));\n\t\tvec4Color += texture2D(texture, v_texcoord + vec2FilterDir + vec2Off)/floatIterationTotalTime;\n\t}\n}\ngl_FragColor = vec4(u_color.rgb,vec4Color.a * u_strength);\ngl_FragColor.rgb *= gl_FragColor.a;"),Yt.addInclude("parts/BlurFilter_ps_logic.glsl","gl_FragColor =   blur();\ngl_FragColor.w*=alpha;"),Yt.addInclude("parts/BlurFilter_ps_uniform.glsl","uniform vec4 strength_sig2_2sig2_gauss1;\nuniform vec2 blurInfo;\n\n#define PI 3.141593\n\n//float sigma=strength/3.0;//3σ以外影响很小。即当σ=1的时候，半径为3\n//float sig2 = sigma*sigma;\n//float _2sig2 = 2.0*sig2;\n//return 1.0/(2*PI*sig2)*exp(-(x*x+y*y)/_2sig2)\n//float gauss1 = 1.0/(2.0*PI*sig2);\n\nfloat getGaussian(float x, float y){\n    return strength_sig2_2sig2_gauss1.w*exp(-(x*x+y*y)/strength_sig2_2sig2_gauss1.z);\n}\n\nvec4 blur(){\n    const float blurw = 9.0;\n    vec4 vec4Color = vec4(0.0,0.0,0.0,0.0);\n    vec2 halfsz=vec2(blurw,blurw)/2.0/blurInfo;    \n    vec2 startpos=v_texcoord-halfsz;\n    vec2 ctexcoord = startpos;\n    vec2 step = 1.0/blurInfo;  //每个像素      \n    \n    for(float y = 0.0;y<=blurw; ++y){\n        ctexcoord.x=startpos.x;\n        for(float x = 0.0;x<=blurw; ++x){\n            //TODO 纹理坐标的固定偏移应该在vs中处理\n            vec4Color += texture2D(texture, ctexcoord)*getGaussian(x-blurw/2.0,y-blurw/2.0);\n            ctexcoord.x+=step.x;\n        }\n        ctexcoord.y+=step.y;\n    }\n    return vec4Color;\n}"),Yt.addInclude("parts/ColorAdd_ps_uniform.glsl","uniform vec4 colorAdd;\n"),Yt.addInclude("parts/ColorAdd_ps_logic.glsl","gl_FragColor = vec4(colorAdd.rgb,colorAdd.a*gl_FragColor.a);\ngl_FragColor.xyz *= colorAdd.a;");var t,e;t="attribute vec4 position;\nattribute vec2 texcoord;\nuniform vec2 size;\n\n#ifdef WORLDMAT\nuniform mat4 mmat;\n#endif\nvarying vec2 v_texcoord;\nvoid main() {\n  #ifdef WORLDMAT\n  vec4 pos=mmat*position;\n  gl_Position =vec4((pos.x/size.x-0.5)*2.0,(0.5-pos.y/size.y)*2.0,pos.z,1.0);\n  #else\n  gl_Position =vec4((position.x/size.x-0.5)*2.0,(0.5-position.y/size.y)*2.0,position.z,1.0);\n  #endif\n  \n  v_texcoord = texcoord;\n}",e='precision mediump float;\n//precision highp float;\nvarying vec2 v_texcoord;\nuniform sampler2D texture;\nuniform float alpha;\n#include?BLUR_FILTER  "parts/BlurFilter_ps_uniform.glsl";\n#include?COLOR_FILTER "parts/ColorFilter_ps_uniform.glsl";\n#include?GLOW_FILTER "parts/GlowFilter_ps_uniform.glsl";\n#include?COLOR_ADD "parts/ColorAdd_ps_uniform.glsl";\n\nvoid main() {\n   vec4 color= texture2D(texture, v_texcoord);\n   color.a*=alpha;\n   color.rgb*=alpha;\n   gl_FragColor=color;\n   #include?COLOR_ADD "parts/ColorAdd_ps_logic.glsl";   \n   #include?BLUR_FILTER  "parts/BlurFilter_ps_logic.glsl";\n   #include?COLOR_FILTER "parts/ColorFilter_ps_logic.glsl";\n   #include?GLOW_FILTER "parts/GlowFilter_ps_logic.glsl";\n}',Yt.preCompile2D(0,1,t,e,null),t="attribute vec4 position;\nuniform vec2 size;\nuniform mat4 mmat;\nvoid main() {\n  vec4 pos=mmat*position;\n  gl_Position =vec4((pos.x/size.x-0.5)*2.0,(0.5-pos.y/size.y)*2.0,pos.z,1.0);\n}",e='precision mediump float;\nuniform vec4 color;\nuniform float alpha;\n#include?COLOR_FILTER "parts/ColorFilter_ps_uniform.glsl";\nvoid main() {\n\tvec4 a = vec4(color.r, color.g, color.b, color.a);\n\ta.w = alpha;\n\ta.xyz *= alpha;\n\tgl_FragColor = a;\n\t#include?COLOR_FILTER "parts/ColorFilter_ps_logic.glsl";\n}',Yt.preCompile2D(0,2,t,e,null),t="attribute vec4 position;\nattribute vec3 a_color;\nuniform mat4 mmat;\nuniform mat4 u_mmat2;\nuniform vec2 u_pos;\nuniform vec2 size;\nvarying vec3 color;\nvoid main(){\n  vec4 tPos = vec4(position.x + u_pos.x,position.y + u_pos.y,position.z,position.w);\n  vec4 pos=mmat*u_mmat2*tPos;\n  gl_Position =vec4((pos.x/size.x-0.5)*2.0,(0.5-pos.y/size.y)*2.0,pos.z,1.0);\n  color=a_color;\n}",e="precision mediump float;\n//precision mediump float;\nvarying vec3 color;\nuniform float alpha;\nvoid main(){\n\t//vec4 a=vec4(color.r, color.g, color.b, 1);\n\t//a.a*=alpha;\n    gl_FragColor=vec4(color.r, color.g, color.b, alpha);\n\tgl_FragColor.rgb*=alpha;\n}",Yt.preCompile2D(0,4,t,e,null),t="attribute vec4 position;\nattribute vec2 texcoord;\nuniform vec2 size;\n\n#ifdef WORLDMAT\nuniform mat4 mmat;\n#endif\nvarying vec2 v_texcoord;\nvoid main() {\n  #ifdef WORLDMAT\n  vec4 pos=mmat*position;\n  gl_Position =vec4((pos.x/size.x-0.5)*2.0,(0.5-pos.y/size.y)*2.0,pos.z,1.0);\n  #else\n  gl_Position =vec4((position.x/size.x-0.5)*2.0,(0.5-position.y/size.y)*2.0,position.z,1.0);\n  #endif\n  \n  v_texcoord = texcoord;\n}",e='#ifdef FSHIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n//precision highp float;\nvarying vec2 v_texcoord;\nuniform sampler2D texture;\nuniform float alpha;\nuniform vec4 u_TexRange;\nuniform vec2 u_offset;\n#include?BLUR_FILTER  "parts/BlurFilter_ps_uniform.glsl";\n#include?COLOR_FILTER "parts/ColorFilter_ps_uniform.glsl";\n#include?GLOW_FILTER "parts/GlowFilter_ps_uniform.glsl";\n#include?COLOR_ADD "parts/ColorAdd_ps_uniform.glsl";\n\nvoid main() {\n   vec2 newTexCoord;\n   newTexCoord.x = mod(u_offset.x + v_texcoord.x,u_TexRange.y) + u_TexRange.x;\n   newTexCoord.y = mod(u_offset.y + v_texcoord.y,u_TexRange.w) + u_TexRange.z;\n   vec4 color= texture2D(texture, newTexCoord);\n   color.a*=alpha;\n   gl_FragColor=color;\n   #include?COLOR_ADD "parts/ColorAdd_ps_logic.glsl";   \n   #include?BLUR_FILTER  "parts/BlurFilter_ps_logic.glsl";\n   #include?COLOR_FILTER "parts/ColorFilter_ps_logic.glsl";\n   #include?GLOW_FILTER "parts/GlowFilter_ps_logic.glsl";\n}',Yt.preCompile2D(0,256,t,e,null),t="attribute vec2 position;\nattribute vec2 texcoord;\nattribute vec4 color;\nuniform vec2 size;\nuniform float offsetX;\nuniform float offsetY;\nuniform mat4 mmat;\nuniform mat4 u_mmat2;\nvarying vec2 v_texcoord;\nvarying vec4 v_color;\nvoid main() {\n  vec4 pos=mmat*u_mmat2*vec4(offsetX+position.x,offsetY+position.y,0,1 );\n  gl_Position = vec4((pos.x/size.x-0.5)*2.0,(0.5-pos.y/size.y)*2.0,pos.z,1.0);\n  v_color = color;\n  v_color.rgb *= v_color.a;\n  v_texcoord = texcoord;  \n}",e="precision mediump float;\nvarying vec2 v_texcoord;\nvarying vec4 v_color;\nuniform sampler2D texture;\nuniform float alpha;\nvoid main() {\n\tvec4 t_color = texture2D(texture, v_texcoord);\n\tgl_FragColor = t_color.rgba * v_color;\n\tgl_FragColor *= alpha;\n}",Yt.preCompile2D(0,512,t,e,null)},t}(),J=function(){function t(t,e,i){this._value=0,this._name2int=t,this._int2name=e,this._int2nameMap=i}r(t,"laya.webgl.shader.ShaderDefines");var e=t.prototype;return e.add=function(t){return"string"==typeof t&&(t=this._name2int[t]),this._value|=t,this._value},e.addInt=function(t){return this._value|=t,this._value},e.remove=function(t){return"string"==typeof t&&(t=this._name2int[t]),this._value&=~t,this._value},e.isDefine=function(t){return(this._value&t)===t},e.getValue=function(){return this._value},e.setValue=function(t){this._value=t},e.toNameDic=function(){var e=this._int2nameMap[this._value];return e||t._toText(this._value,this._int2name,this._int2nameMap)},t._reg=function(t,e,i,n){i[t]=e,n[e]=t},t._toText=function(t,e,i){var n=i[t];if(n)return n;for(var r={},a=1,s=0;s<32&&!((a=1<<s)>t);s++)if(t&a){var o=e[a];o&&(r[o]="")}return i[t]=r,r},t._toInt=function(t,e){for(var i=t.split("."),n=0,r=0,a=i.length;r<a;r++){var s=e[i[r]];if(!s)throw new Error("Defines to int err:"+t+"/"+i[r]);n|=s}return n},t}(),tt=function(){function t(){this.mVBBuffer=null,this.mIBBuffer=null,this.mVBData=null,this.mIBData=null,this.mEleNum=0,this.mTexture=null,this.transform=null,this._vs=null,this._ps=null,this._indexStart=-1,this._verticles=null,this._uvs=null,this._tempMatrix=new x}r(t,"laya.webgl.shader.d2.skinAnishader.SkinMesh");var e=t.prototype;return e.init=function(e,i,n){if(i)this._vs=i;else{this._vs=[];var r=e.width,a=e.height;this._vs.push(0,0,0,0,1,1,1,1),this._vs.push(r,0,1,0,1,1,1,1),this._vs.push(r,a,1,1,1,1,1,1),this._vs.push(0,a,0,1,1,1,1,1)}n?this._ps=n:(t._defaultPS||(t._defaultPS=[],t._defaultPS.push(0,1,3,3,1,2)),this._ps=t._defaultPS),this.mVBData=new Float32Array(this._vs),this.mIBData=new Uint16Array(this._ps.length),this.mIBData.start=-1,this.mEleNum=this._ps.length,this.mTexture=e},e.init2=function(t,e,i,n,r){this.transform&&(this.transform=null),i?this._ps=i:(this._ps=[],this._ps.push(0,1,3,3,1,2)),this._verticles=n,this._uvs=r,this.mEleNum=this._ps.length,this.mTexture=t,(D.isConchNode||D.isConchApp)&&(this._initMyData(),this.mVBData=new Float32Array(this._vs))},e._initMyData=function(){var e=0,i=0,n=this._verticles.length,r=4*n;this._vs=t._tempVS;var a=!1;if(D.isConchNode||D.isConchApp?(this._vs.length=r,a=!0):this._vs.length<r&&(this._vs.length=r,a=!0),t._tVSLen=r,a)for(;e<r;)this._vs[e]=this._verticles[i],this._vs[e+1]=this._verticles[i+1],this._vs[e+2]=this._uvs[i],this._vs[e+3]=this._uvs[i+1],this._vs[e+4]=1,this._vs[e+5]=1,this._vs[e+6]=1,this._vs[e+7]=1,e+=8,i+=2;else for(;e<r;)this._vs[e]=this._verticles[i],this._vs[e+1]=this._verticles[i+1],this._vs[e+2]=this._uvs[i],this._vs[e+3]=this._uvs[i+1],e+=8,i+=2},e.getData2=function(e,i,n){this.mVBBuffer=e,this.mIBBuffer=i,this._initMyData(),e.appendEx2(this._vs,Float32Array,t._tVSLen,4),this._indexStart=i._byteLength;var r;r=t._tempIB,r.length<this._ps.length&&(r.length=this._ps.length);for(var a=0,s=this._ps.length;a<s;a++)r[a]=this._ps[a]+n;i.appendEx2(r,Uint16Array,this._ps.length,2)},e.getData=function(t,e,i){if(this.mVBBuffer=t,this.mIBBuffer=e,t.append(this.mVBData),this._indexStart=e._byteLength,this.mIBData.start!=i){for(var n=0,r=this._ps.length;n<r;n++)this.mIBData[n]=this._ps[n]+i;this.mIBData.start=i}e.append(this.mIBData)},e.render=function(t,e,i){if(D.isWebGL&&this.mTexture){t._renderKey=0,t._shader2D.glTexture=null,et.getInstance().addSkinMesh(this);var n=at.createShape(t,this.mIBBuffer,this.mVBBuffer,this.mEleNum,this._indexStart,Dt.create(512,0));this.transform||(this.transform=x.EMPTY),this.transform.translate(e,i),x.mul(this.transform,t._curMat,this._tempMatrix),this.transform.translate(-e,-i);var r=n.shaderValue,a=r.u_mmat2||vt.getMatrArray();vt.mat2MatArray(this._tempMatrix,a),r.textureHost=this.mTexture,r.offsetX=0,r.offsetY=0,r.u_mmat2=a,r.ALPHA=t._shader2D.ALPHA,t._submits[t._submits._length++]=n}else D.isConchApp&&this.mTexture&&(this.transform||(this.transform=x.EMPTY),t.setSkinMesh&&t.setSkinMesh(e,i,this._ps,this.mVBData,this.mEleNum,0,this.mTexture,this.transform))},t._tempVS=[],t._tempIB=[],t._defaultPS=null,t._tVSLen=0,t}(),et=function(){function t(){this.ib=null,this.vb=null;Et.mainContext;this.ib=qt.create(35048),this.vb=Qt.create(8)}r(t,"laya.webgl.shader.d2.skinAnishader.SkinMeshBuffer");var e=t.prototype;return e.addSkinMesh=function(t){t.getData2(this.vb,this.ib,this.vb._byteLength/32)},e.reset=function(){this.vb.clear(),this.ib.clear()},t.getInstance=function(){return t.instance=t.instance||new t},t.instance=null,t}(),it=function(){function t(t,e,i,n,r,a,s,o,l){this.r0=0,this.fill=!0,this.r1=Math.PI/2,void 0===l&&(l=0),this.x=t,this.y=e,this.width=i,this.height=n,this.edges=r,this.color=a,this.borderWidth=s,this.borderColor=o}r(t,"laya.webgl.shapes.BasePoly");var e=t.prototype;return i.imps(e,{"laya.webgl.shapes.IShape":!0}),e.getData=function(t,e,i){},e.rebuild=function(t){},e.setMatrix=function(t){},e.needUpdate=function(t){return!0},e.sector=function(t,e,i){var n=this.x,r=this.y,a=this.edges,s=(this.r1-this.r0)/a,o=this.width,l=this.height,h=this.color,u=(h>>16&255)/255,_=(h>>8&255)/255,c=(255&h)/255;t.push(n,r,u,_,c);for(var d=0;d<a+1;d++)t.push(n+Math.sin(s*d+this.r0)*o,r+Math.cos(s*d+this.r0)*l),t.push(u,_,c);for(d=0;d<a;d++)e.push(i,i+d+1,i+d+2)},e.createLine2=function(t,e,i,n,r,a){var s,o,l,h,u,_,c,d,f,m,p,v,g,E,x,T,S,D,M,y,A=t.concat(),I=r,R=this.borderColor,C=(R>>16&255)/255,b=(R>>8&255)/255,w=(255&R)/255,N=A.length/2,P=n,L=i/2;l=A[0],h=A[1],u=A[2],_=A[3],f=-(h-_),m=l-u,y=Math.sqrt(f*f+m*m),f=f/y*L,m=m/y*L,I.push(l-f+this.x,h-m+this.y,C,b,w,l+f+this.x,h+m+this.y,C,b,w);for(var O=1;O<N-1;O++)l=A[2*(O-1)],h=A[2*(O-1)+1],u=A[2*O],_=A[2*O+1],c=A[2*(O+1)],d=A[2*(O+1)+1],f=-(h-_),m=l-u,y=Math.sqrt(f*f+m*m),f=f/y*L,m=m/y*L,p=-(_-d),v=u-c,y=Math.sqrt(p*p+v*v),p=p/y*L,v=v/y*L,g=-m+h-(-m+_),E=-f+u-(-f+l),x=(-f+l)*(-m+_)-(-f+u)*(-m+h),T=-v+d-(-v+_),S=-p+u-(-p+c),D=(-p+c)*(-v+_)-(-p+u)*(-v+d),M=g*S-T*E,Math.abs(M)<.1?(M+=10.1,I.push(u-f+this.x,_-m+this.y,C,b,w,u+f+this.x,_+m+this.y,C,b,w)):(s=(E*D-S*x)/M,o=(T*x-g*D)/M,(s-u)*(s-u)+(o-_)+(o-_),I.push(s+this.x,o+this.y,C,b,w,u-(s-u)+this.x,_-(o-_)+this.y,C,b,w));l=A[A.length-4],h=A[A.length-3],u=A[A.length-2],_=A[A.length-1],f=-(h-_),m=l-u,y=Math.sqrt(f*f+m*m),f=f/y*L,m=m/y*L,I.push(u-f+this.x,_-m+this.y,C,b,w,u+f+this.x,_+m+this.y,C,b,w);var V=a;for(O=1;O<V;O++)e.push(P+2*(O-1),P+2*(O-1)+1,P+2*O+1,P+2*O+1,P+2*O,P+2*(O-1));return I},e.createLine=function(t,e,i,n){var r=t.concat(),a=t,s=this.borderColor,o=(s>>16&255)/255,l=(s>>8&255)/255,h=(255&s)/255;r.splice(0,5);var u,_,c,d,f,m,p,v,g,E,x,T,S,D,M,y,A,I,R,C,b=r.length/5,w=n,N=i/2;c=r[0],d=r[1],f=r[5],m=r[6],g=-(d-m),E=c-f,C=Math.sqrt(g*g+E*E),g=g/C*N,E=E/C*N,a.push(c-g,d-E,o,l,h,c+g,d+E,o,l,h);for(var P=1;P<b-1;P++)c=r[5*(P-1)],d=r[5*(P-1)+1],f=r[5*P],m=r[5*P+1],p=r[5*(P+1)],v=r[5*(P+1)+1],g=-(d-m),E=c-f,C=Math.sqrt(g*g+E*E),g=g/C*N,E=E/C*N,x=-(m-v),T=f-p,C=Math.sqrt(x*x+T*T),x=x/C*N,T=T/C*N,S=-E+d-(-E+m),D=-g+f-(-g+c),M=(-g+c)*(-E+m)-(-g+f)*(-E+d),y=-T+v-(-T+m),A=-x+f-(-x+p),I=(-x+p)*(-T+m)-(-x+f)*(-T+v),R=S*A-y*D,Math.abs(R)<.1?(R+=10.1,a.push(f-g,m-E,o,l,h,f+g,m+E,o,l,h)):(u=(D*I-A*M)/R,_=(y*M-S*I)/R,(u-f)*(u-f)+(_-m)+(_-m),a.push(u,_,o,l,h,f-(u-f),m-(_-m),o,l,h));c=r[r.length-10],d=r[r.length-9],f=r[r.length-5],m=r[r.length-4],g=-(d-m),E=c-f,C=Math.sqrt(g*g+E*E),g=g/C*N,E=E/C*N,a.push(f-g,m-E,o,l,h,f+g,m+E,o,l,h);var L=this.edges+1;for(P=1;P<L;P++)e.push(w+2*(P-1),w+2*(P-1)+1,w+2*P+1,w+2*P+1,w+2*P,w+2*(P-1));return a},e.createLoopLine=function(t,e,i,n,r,a){var s=t.concat(),o=r||t,l=this.borderColor,h=(l>>16&255)/255,u=(l>>8&255)/255,_=(255&l)/255;s.splice(0,5);var c=[s[0],s[1]],d=[s[s.length-5],s[s.length-4]],f=d[0]+.5*(c[0]-d[0]),m=d[1]+.5*(c[1]-d[1]);s.unshift(f,m,0,0,0),s.push(f,m,0,0,0);var p,v,g,E,x,T,S,D,M,y,A,I,R,C,b,w,N,P,L,O,V=s.length/5,F=n,B=i/2;g=s[0],E=s[1],x=s[5],T=s[6],M=-(E-T),y=g-x,O=Math.sqrt(M*M+y*y),M=M/O*B,y=y/O*B,o.push(g-M,E-y,h,u,_,g+M,E+y,h,u,_);for(var U=1;U<V-1;U++)g=s[5*(U-1)],E=s[5*(U-1)+1],x=s[5*U],T=s[5*U+1],S=s[5*(U+1)],D=s[5*(U+1)+1],M=-(E-T),y=g-x,O=Math.sqrt(M*M+y*y),M=M/O*B,y=y/O*B,A=-(T-D),I=x-S,O=Math.sqrt(A*A+I*I),A=A/O*B,I=I/O*B,R=-y+E-(-y+T),C=-M+x-(-M+g),b=(-M+g)*(-y+T)-(-M+x)*(-y+E),w=-I+D-(-I+T),N=-A+x-(-A+S),P=(-A+S)*(-I+T)-(-A+x)*(-I+D),L=R*N-w*C,Math.abs(L)<.1?(L+=10.1,o.push(x-M,T-y,h,u,_,x+M,T+y,h,u,_)):(p=(C*P-N*b)/L,v=(w*b-R*P)/L,(p-x)*(p-x)+(v-T)+(v-T),o.push(p,v,h,u,_,x-(p-x),T-(v-T),h,u,_));a&&(e=a);var H=this.edges+1;for(U=1;U<H;U++)e.push(F+2*(U-1),F+2*(U-1)+1,F+2*U+1,F+2*U+1,F+2*U,F+2*(U-1));return e.push(F+2*(U-1),F+2*(U-1)+1,F+1,F+1,F,F+2*(U-1)),o},t}(),nt=function(){function t(){}return r(t,"laya.webgl.shapes.Earcut"),t.earcut=function(e,i,n){n=n||2;var r=i&&i.length,a=r?i[0]*n:e.length,s=t.linkedList(e,0,a,n,!0),o=[];if(!s)return o;var l,h,u,_,c,d,f;if(r&&(s=t.eliminateHoles(e,i,s,n)),e.length>80*n){l=u=e[0],h=_=e[1];for(var m=n;m<a;m+=n)c=e[m],d=e[m+1],c<l&&(l=c),d<h&&(h=d),c>u&&(u=c),d>_&&(_=d);f=Math.max(u-l,_-h),f=0!==f?1/f:0}return t.earcutLinked(s,o,n,l,h,f),o},t.linkedList=function(e,i,n,r,a){var s,o;if(a===t.signedArea(e,i,n,r)>0)for(s=i;s<n;s+=r)o=t.insertNode(s,e[s],e[s+1],o);else for(s=n-r;s>=i;s-=r)o=t.insertNode(s,e[s],e[s+1],o);return o&&t.equals(o,o.next)&&(t.removeNode(o),o=o.next),o},t.filterPoints=function(e,i){if(!e)return e;i||(i=e);var n,r=e;do{if(n=!1,r.steiner||!t.equals(r,r.next)&&0!==t.area(r.prev,r,r.next))r=r.next;else{if(t.removeNode(r),(r=i=r.prev)===r.next)break;n=!0}}while(n||r!==i);return i},t.earcutLinked=function(e,i,n,r,a,s,o){if(e){!o&&s&&t.indexCurve(e,r,a,s);for(var l,h,u=e;e.prev!==e.next;)if(l=e.prev,h=e.next,s?t.isEarHashed(e,r,a,s):t.isEar(e))i.push(l.i/n),i.push(e.i/n),i.push(h.i/n),t.removeNode(e),e=h.next,u=h.next;else if((e=h)===u){o?1===o?(e=t.cureLocalIntersections(e,i,n),t.earcutLinked(e,i,n,r,a,s,2)):2===o&&t.splitEarcut(e,i,n,r,a,s):t.earcutLinked(t.filterPoints(e,null),i,n,r,a,s,1);break}}},t.isEar=function(e){var i=e.prev,n=e,r=e.next;if(t.area(i,n,r)>=0)return!1;for(var a=e.next.next;a!==e.prev;){if(t.pointInTriangle(i.x,i.y,n.x,n.y,r.x,r.y,a.x,a.y)&&t.area(a.prev,a,a.next)>=0)return!1;a=a.next}return!0},t.isEarHashed=function(e,i,n,r){var a=e.prev,s=e,o=e.next;if(t.area(a,s,o)>=0)return!1;for(var l=a.x<s.x?a.x<o.x?a.x:o.x:s.x<o.x?s.x:o.x,h=a.y<s.y?a.y<o.y?a.y:o.y:s.y<o.y?s.y:o.y,u=a.x>s.x?a.x>o.x?a.x:o.x:s.x>o.x?s.x:o.x,_=a.y>s.y?a.y>o.y?a.y:o.y:s.y>o.y?s.y:o.y,c=t.zOrder(l,h,i,n,r),d=t.zOrder(u,_,i,n,r),f=e.nextZ;f&&f.z<=d;){if(f!==e.prev&&f!==e.next&&t.pointInTriangle(a.x,a.y,s.x,s.y,o.x,o.y,f.x,f.y)&&t.area(f.prev,f,f.next)>=0)return!1;f=f.nextZ}for(f=e.prevZ;f&&f.z>=c;){if(f!==e.prev&&f!==e.next&&t.pointInTriangle(a.x,a.y,s.x,s.y,o.x,o.y,f.x,f.y)&&t.area(f.prev,f,f.next)>=0)return!1;f=f.prevZ}return!0},t.cureLocalIntersections=function(e,i,n){var r=e;do{var a=r.prev,s=r.next.next;!t.equals(a,s)&&t.intersects(a,r,r.next,s)&&t.locallyInside(a,s)&&t.locallyInside(s,a)&&(i.push(a.i/n),i.push(r.i/n),i.push(s.i/n),t.removeNode(r),t.removeNode(r.next),r=e=s),r=r.next}while(r!==e);return r},t.splitEarcut=function(e,i,n,r,a,s){var o=e;do{for(var l=o.next.next;l!==o.prev;){if(o.i!==l.i&&t.isValidDiagonal(o,l)){var h=t.splitPolygon(o,l);return o=t.filterPoints(o,o.next),h=t.filterPoints(h,h.next),t.earcutLinked(o,i,n,r,a,s),void t.earcutLinked(h,i,n,r,a,s)}l=l.next}o=o.next}while(o!==e)},t.eliminateHoles=function(e,i,n,r){var a,s,o,l,h,u=[];for(a=0,s=i.length;a<s;a++)o=i[a]*r,l=a<s-1?i[a+1]*r:e.length,h=t.linkedList(e,o,l,r,!1),h===h.next&&(h.steiner=!0),u.push(t.getLeftmost(h));for(u.sort(t.compareX),a=0;a<u.length;a++)t.eliminateHole(u[a],n),n=t.filterPoints(n,n.next);return n},t.compareX=function(t,e){return t.x-e.x},t.eliminateHole=function(e,i){if(i=t.findHoleBridge(e,i)){var n=t.splitPolygon(i,e);t.filterPoints(n,n.next)}},t.findHoleBridge=function(e,i){var n,r=i,a=e.x,s=e.y,o=-1/0;do{if(s<=r.y&&s>=r.next.y&&r.next.y!==r.y){var l=r.x+(s-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(l<=a&&l>o){if(o=l,l===a){if(s===r.y)return r;if(s===r.next.y)return r.next}n=r.x<r.next.x?r:r.next}}r=r.next}while(r!==i);if(!n)return null;if(a===o)return n.prev;var h,u=n,_=n.x,c=n.y,d=1/0;for(r=n.next;r!==u;)a>=r.x&&r.x>=_&&a!==r.x&&t.pointInTriangle(s<c?a:o,s,_,c,s<c?o:a,s,r.x,r.y)&&((h=Math.abs(s-r.y)/(a-r.x))<d||h===d&&r.x>n.x)&&t.locallyInside(r,e)&&(n=r,d=h),r=r.next;return n},t.indexCurve=function(e,i,n,r){var a=e;do{null===a.z&&(a.z=t.zOrder(a.x,a.y,i,n,r)),a.prevZ=a.prev,a.nextZ=a.next,a=a.next}while(a!==e);a.prevZ.nextZ=null,a.prevZ=null,t.sortLinked(a)},t.sortLinked=function(t){var e,i,n,r,a,s,o,l,h=1;do{for(i=t,t=null,a=null,s=0;i;){for(s++,n=i,o=0,e=0;e<h&&(o++,n=n.nextZ);e++);for(l=h;o>0||l>0&&n;)0!==o&&(0===l||!n||i.z<=n.z)?(r=i,i=i.nextZ,o--):(r=n,n=n.nextZ,l--),a?a.nextZ=r:t=r,r.prevZ=a,a=r;i=n}a.nextZ=null,h*=2}while(s>1);return t},t.zOrder=function(t,e,i,n,r){return t=32767*(t-i)*r,e=32767*(e-n)*r,t=16711935&(t|t<<8),t=252645135&(t|t<<4),t=858993459&(t|t<<2),t=1431655765&(t|t<<1),e=16711935&(e|e<<8),e=252645135&(e|e<<4),e=858993459&(e|e<<2),e=1431655765&(e|e<<1),t|e<<1},t.getLeftmost=function(t){var e=t,i=t;do{e.x<i.x&&(i=e),e=e.next}while(e!==t);return i},t.pointInTriangle=function(t,e,i,n,r,a,s,o){return(r-s)*(e-o)-(t-s)*(a-o)>=0&&(t-s)*(n-o)-(i-s)*(e-o)>=0&&(i-s)*(a-o)-(r-s)*(n-o)>=0},t.isValidDiagonal=function(e,i){return e.next.i!==i.i&&e.prev.i!==i.i&&!t.intersectsPolygon(e,i)&&t.locallyInside(e,i)&&t.locallyInside(i,e)&&t.middleInside(e,i)},t.area=function(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)},t.equals=function(t,e){return t.x===e.x&&t.y===e.y},t.intersects=function(e,i,n,r){return!!(t.equals(e,i)&&t.equals(n,r)||t.equals(e,r)&&t.equals(n,i))||t.area(e,i,n)>0!=t.area(e,i,r)>0&&t.area(n,r,e)>0!=t.area(n,r,i)>0},t.intersectsPolygon=function(e,i){var n=e;do{if(n.i!==e.i&&n.next.i!==e.i&&n.i!==i.i&&n.next.i!==i.i&&t.intersects(n,n.next,e,i))return!0;n=n.next}while(n!==e);return!1},t.locallyInside=function(e,i){return t.area(e.prev,e,e.next)<0?t.area(e,i,e.next)>=0&&t.area(e,e.prev,i)>=0:t.area(e,i,e.prev)<0||t.area(e,e.next,i)<0},t.middleInside=function(t,e){var i=t,n=!1,r=(t.x+e.x)/2,a=(t.y+e.y)/2;do{i.y>a!=i.next.y>a&&i.next.y!==i.y&&r<(i.next.x-i.x)*(a-i.y)/(i.next.y-i.y)+i.x&&(n=!n),i=i.next}while(i!==t);return n},t.splitPolygon=function(t,e){var i=new rt(t.i,t.x,t.y),n=new rt(e.i,e.x,e.y),r=t.next,a=e.prev;return t.next=e,e.prev=t,i.next=r,r.prev=i,n.next=i,i.prev=n,a.next=n,n.prev=a,n},t.insertNode=function(t,e,i,n){var r=new rt(t,e,i);return n?(r.next=n.next,r.prev=n,n.next.prev=r,n.next=r):(r.prev=r,r.next=r),r},t.removeNode=function(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)},t.signedArea=function(t,e,i,n){for(var r=0,a=e,s=i-n;a<i;a+=n)r+=(t[s]-t[a])*(t[a+1]+t[s+1]),s=a;return r},t}(),rt=function(){function t(t,e,i){this.i=null,this.x=null,this.y=null,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=null,this.i=t,this.x=e,this.y=i,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}return r(t,"laya.webgl.shapes.EarcutNode"),t}(),at=(function(){function t(t,e,i,n,r,a,s){this.lineWidth=t,this.lineColor=e,this.lineAlpha=i,this.fillColor=n,this.fillAlpha=r,this.shape=s,this.fill=a}r(t,"laya.webgl.shapes.GeometryData");var e=t.prototype;e.clone=function(){return new t(this.lineWidth,this.lineColor,this.lineAlpha,this.fillColor,this.fillAlpha,this.fill,this.shape)},e.getIndexData=function(){return null},e.getVertexData=function(){return null},e.destroy=function(){this.shape=null}}(),function(){function t(t){if(t instanceof Float32Array)this.points=t;else if(t instanceof Array){t.length;this.points=new Float32Array(t)}}r(t,"laya.webgl.shapes.Vertex");var e=t.prototype;i.imps(e,{"laya.webgl.shapes.IShape":!0}),e.getData=function(t,e,i){},e.needUpdate=function(t){return!1},e.rebuild=function(t){},e.setMatrix=function(t){}}(),function(){function t(t){void 0===t&&(t=1e4),this._renderType=t}r(t,"laya.webgl.submit.Submit");var e=t.prototype;return i.imps(e,{"laya.webgl.submit.ISubmit":!0}),e.releaseRender=function(){var e=t._cache;e[e._length++]=this,this.shaderValue.release(),this._vb=null},e.getRenderType=function(){return this._renderType},e.renderSubmit=function(){if(0===this._numEle)return 1;var t=this.shaderValue.textureHost;if(t){var e=t.source;if(!t.bitmap||!e)return 1;this.shaderValue.texture=e}this._vb.bind_upload(this._ib);var i=Et.mainContext;return this.shaderValue.upload(),z.activeBlendFunction!==this._blendFn&&(i.enable(3042),this._blendFn(i),z.activeBlendFunction=this._blendFn),b.drawCall++,b.trianglesFaces+=this._numEle/3,i.drawElements(4,this._numEle,5123,this._startIdx),1},t.__init__=function(){var e=t.RENDERBASE=new t(-1);e.shaderValue=new Dt(0,0),e.shaderValue.ALPHA=-1234},t.createSubmit=function(e,i,n,r,a){var s=t._cache._length?t._cache[--t._cache._length]:new t;null==n&&(n=s._selfVb||(s._selfVb=Qt.create(-1)),n.clear(),r=0),s._ib=i,s._vb=n,s._startIdx=r*mt.BYTES_PIDX,s._numEle=0;var o=e._nBlendType;s._blendFn=e._targets?z.targetFns[o]:z.fns[o],s.shaderValue=a,s.shaderValue.setValue(e._shader2D);var l=e._shader2D.filters;return l&&s.shaderValue.setFilters(l),s},t.createShape=function(e,i,n,r,a,s){var o=t._cache._length?t._cache[--t._cache._length]:new t;o._ib=i,o._vb=n,o._numEle=r,o._startIdx=a,o.shaderValue=s,o.shaderValue.setValue(e._shader2D);var l=e._nBlendType;return o._blendFn=e._targets?z.targetFns[l]:z.fns[l],o},t.TYPE_2D=1e4,t.TYPE_CANVAS=10003,t.TYPE_CMDSETRT=10004,t.TYPE_CUSTOM=10005,t.TYPE_BLURRT=10006,t.TYPE_CMDDESTORYPRERT=10007,t.TYPE_DISABLESTENCIL=10008,t.TYPE_OTHERIBVB=10009,t.TYPE_PRIMITIVE=10010,t.TYPE_RT=10011,t.TYPE_BLUR_RT=10012,t.TYPE_TARGET=10013,t.TYPE_CHANGE_VALUE=10014,t.TYPE_SHAPE=10015,t.TYPE_TEXTURE=10016,t.TYPE_FILLTEXTURE=10017,t.RENDERBASE=null,n(t,["_cache",function(){return this._cache=(t._cache=[],t._cache._length=0,t._cache)}]),t}()),st=function(){function t(){this.fun=null,this.args=null}r(t,"laya.webgl.submit.SubmitCMD");var e=t.prototype;return i.imps(e,{"laya.webgl.submit.ISubmit":!0}),e.renderSubmit=function(){return this.fun.apply(null,this.args),1},e.getRenderType=function(){return 0},e.releaseRender=function(){var e=t._cache;e[e._length++]=this},t.create=function(e,i){var n=t._cache._length?t._cache[--t._cache._length]:new t;return n.fun=i,n.args=e,n},n(t,["_cache",function(){return this._cache=(t._cache=[],t._cache._length=0,t._cache)}]),t}(),ot=function(){function t(){this.variables={}}r(t,"laya.webgl.submit.SubmitCMDScope");var e=t.prototype;return e.getValue=function(t){return this.variables[t]},e.addValue=function(t,e){return this.variables[t]=e},e.setValue=function(t,e){return this.variables.hasOwnProperty(t)?this.variables[t]=e:null},e.clear=function(){for(var t in this.variables)delete this.variables[t]},e.recycle=function(){this.clear(),t.POOL.push(this)},t.create=function(){var e=t.POOL.pop();return e||(e=new t),e},t.POOL=[],t}(),lt=function(){function t(){this.offset=0,this.startIndex=0,this._mat=x.create()}r(t,"laya.webgl.submit.SubmitOtherIBVB");var e=t.prototype;return i.imps(e,{"laya.webgl.submit.ISubmit":!0}),e.releaseRender=function(){var e=t._cache;e[e._length++]=this},e.getRenderType=function(){return 10009},e.renderSubmit=function(){var e=this._shaderValue.textureHost;if(e){var i=e.source;if(!e.bitmap||!i)return 1;this._shaderValue.texture=i}this._vb.bind_upload(this._ib);var n=vt.worldMatrix4,r=x.TEMP;x.mulPre(this._mat,n[0],n[1],n[4],n[5],n[12],n[13],r);var a=vt.worldMatrix4=t.tempMatrix4;a[0]=r.a,a[1]=r.b,a[4]=r.c,a[5]=r.d,a[12]=r.tx,a[13]=r.ty,this._shader._offset=this.offset,this._shaderValue.refresh(),this._shader.upload(this._shaderValue),this._shader._offset=0;var s=Et.mainContext;return z.activeBlendFunction!==this._blendFn&&(s.enable(3042),this._blendFn(s),z.activeBlendFunction=this._blendFn),b.drawCall++,b.trianglesFaces+=this._numEle/3,s.drawElements(4,this._numEle,5123,this.startIndex),vt.worldMatrix4=n,Pt.activeShader=null,1},t.create=function(e,i,n,r,a,s,o,l,h){void 0===h&&(h=0);var u=t._cache._length?t._cache[--t._cache._length]:new t;u._ib=n,u._vb=i,u._numEle=r,u._shader=a,u._shaderValue=s;var _=e._nBlendType;switch(u._blendFn=e._targets?z.targetFns[_]:z.fns[_],h){case 0:u.offset=0,u.startIndex=l/(mt.BYTES_PE*i.vertexStride)*1.5,u.startIndex*=mt.BYTES_PIDX;break;case 1:u.startIndex=o,u.offset=l}return u},n(t,["_cache",function(){return this._cache=(t._cache=[],t._cache._length=0,t._cache)},"tempMatrix4",function(){return this.tempMatrix4=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}]),t}(),ht=function(){function t(){this.submitIndex=0,this.submitLength=0,this.context=null,this.clipRect=new S,this.screenRect=new S}r(t,"laya.webgl.submit.SubmitScissor");var e=t.prototype;return i.imps(e,{"laya.webgl.submit.ISubmit":!0}),e._scissor=function(t,e,i,n){var r=vt.worldMatrix4,a=r[0],s=r[5],o=r[12],l=r[13];if(t=t*a+o,e=e*s+l,i*=a,n*=s,i<1||n<1)return!1;var h=t+i,u=e+n;t<0&&(t=0,i=h-t),e<0&&(e=0,n=u-e);var _=vt.worldClipRect;if(t=Math.max(t,_.x),e=Math.max(e,_.y),i=Math.min(h,_.right)-t,n=Math.min(u,_.bottom)-e,i<1||n<1)return!1;var c=vt.worldScissorTest;return this.screenRect.copyFrom(_),_.x=t,_.y=e,_.width=i,_.height=n,vt.worldScissorTest=!0,e=vt.height-e-n,Et.mainContext.scissor(t,e,i,n),Et.mainContext.enable(3089),this.context.submitElement(this.submitIndex,this.submitIndex+this.submitLength),c?(e=vt.height-this.screenRect.y-this.screenRect.height,Et.mainContext.scissor(this.screenRect.x,e,this.screenRect.width,this.screenRect.height),Et.mainContext.enable(3089)):(Et.mainContext.disable(3089),vt.worldScissorTest=!1),_.copyFrom(this.screenRect),!0},e._scissorWithTagart=function(t,e,i,n){if(i<1||n<1)return!1;var r=t+i,a=e+n;t<0&&(t=0,i=r-t),e<0&&(e=0,n=a-e);var s=vt.worldClipRect;if(t=Math.max(t,s.x),e=Math.max(e,s.y),i=Math.min(r,s.right)-t,n=Math.min(a,s.bottom)-e,i<1||n<1)return!1;var o=vt.worldScissorTest;return this.screenRect.copyFrom(s),vt.worldScissorTest=!0,s.x=t,s.y=e,s.width=i,s.height=n,e=vt.height-e-n,Et.mainContext.scissor(t,e,i,n),Et.mainContext.enable(3089),this.context.submitElement(this.submitIndex,this.submitIndex+this.submitLength),o?(e=vt.height-this.screenRect.y-this.screenRect.height,Et.mainContext.scissor(this.screenRect.x,e,this.screenRect.width,this.screenRect.height),Et.mainContext.enable(3089)):(Et.mainContext.disable(3089),vt.worldScissorTest=!1),s.copyFrom(this.screenRect),!0},e.renderSubmit=function(){return this.submitLength=Math.min(this.context._submits._length-1,this.submitLength),this.submitLength<1||this.clipRect.width<1||this.clipRect.height<1?this.submitLength+1:(this.context._targets?this._scissorWithTagart(this.clipRect.x,this.clipRect.y,this.clipRect.width,this.clipRect.height):this._scissor(this.clipRect.x,this.clipRect.y,this.clipRect.width,this.clipRect.height),this.submitLength+1)},e.getRenderType=function(){return 0},e.releaseRender=function(){var e=t._cache;e[e._length++]=this,this.context=null},t.create=function(e){var i=t._cache._length?t._cache[--t._cache._length]:new t;return i.context=e,i},n(t,["_cache",function(){return this._cache=(t._cache=[],t._cache._length=0,t._cache)}]),t}(),ut=function(){function t(){this.step=0,this.blendMode=null,this.level=0}r(t,"laya.webgl.submit.SubmitStencil");var e=t.prototype;return i.imps(e,{"laya.webgl.submit.ISubmit":!0}),e.renderSubmit=function(){switch(this.step){case 1:this.do1();break;case 2:this.do2();break;case 3:this.do3();break;case 4:this.do4();break;case 5:this.do5();break;case 6:this.do6();break;case 7:this.do7();break;case 8:this.do8()}return 1},e.getRenderType=function(){return 0},e.releaseRender=function(){var e=t._cache;e[e._length++]=this},e.do1=function(){var t=Et.mainContext;t.enable(2960),t.clear(1024),t.colorMask(!1,!1,!1,!1),t.stencilFunc(514,this.level,255),t.stencilOp(7680,7680,7682)},e.do2=function(){var t=Et.mainContext;t.stencilFunc(514,this.level+1,255),t.colorMask(!0,!0,!0,!0),t.stencilOp(7680,7680,7680)},e.do3=function(){var t=Et.mainContext;t.colorMask(!0,!0,!0,!0),t.stencilOp(7680,7680,7680),t.clear(1024),t.disable(2960)},e.do4=function(){var t=Et.mainContext;0==this.level&&(t.enable(2960),t.clear(1024)),t.colorMask(!1,!1,!1,!1),t.stencilFunc(519,0,255),t.stencilOp(7680,7680,7682)},e.do5=function(){var t=Et.mainContext;t.stencilFunc(514,this.level,255),t.colorMask(!0,!0,!0,!0),t.stencilOp(7680,7680,7680)},e.do6=function(){var t=Et.mainContext;z.targetFns[z.TOINT[this.blendMode]](t)},e.do7=function(){var t=Et.mainContext;t.colorMask(!1,!1,!1,!1),t.stencilOp(7680,7680,7683)},e.do8=function(){var t=Et.mainContext;t.colorMask(!0,!0,!0,!0),t.stencilFunc(514,this.level,255),t.stencilOp(7680,7680,7680)},t.restore=function(e,i,n,r,a){var s;if(e._renderKey=0,t._mask>0&&t._mask--,0==t._mask)s=laya.webgl.submit.SubmitStencil.create(3),e.addRenderObject(s),e._curSubmit=at.RENDERBASE;else{s=laya.webgl.submit.SubmitStencil.create(7),e.addRenderObject(s);var o=e._vb;o._byteLength;if(pt.fillRectImgVb(o,null,i.x,i.y,i.width,i.height,L.DEF_UV,n,r,a,0,0)){e._shader2D.glTexture=null;var l=e._curSubmit=at.createSubmit(e,e._ib,o,(o._byteLength-64)/32*3,Dt.create(2,0));l.shaderValue.ALPHA=1,e._submits[e._submits._length++]=l,e._curSubmit._numEle+=6,e._curSubmit=at.RENDERBASE}else alert("clipRect calc stencil rect error");s=laya.webgl.submit.SubmitStencil.create(8),e.addRenderObject(s)}},t.restore2=function(e,i){var n;e._renderKey=0,t._mask>0&&t._mask--,0==t._mask?(n=laya.webgl.submit.SubmitStencil.create(3),e.addRenderObject(n),e._curSubmit=at.RENDERBASE):(n=laya.webgl.submit.SubmitStencil.create(7),e.addRenderObject(n),e._submits[e._submits._length++]=i,n=laya.webgl.submit.SubmitStencil.create(8),e.addRenderObject(n))},t.create=function(e){var i=t._cache._length?t._cache[--t._cache._length]:new t;return i.step=e,5==e&&++t._mask,i.level=t._mask,i},t._mask=0,n(t,["_cache",function(){return this._cache=(t._cache=[],t._cache._length=0,t._cache)}]),t}(),_t=function(){function t(){this._renderType=0,this._vb=null,this._ib=null,this._startIdx=0,this._numEle=0,this.shaderValue=null,this.blendType=0,this.proName=null,this.scope=null}r(t,"laya.webgl.submit.SubmitTarget");var e=t.prototype;return i.imps(e,{"laya.webgl.submit.ISubmit":!0}),e.renderSubmit=function(){this._vb.bind_upload(this._ib);var t=this.scope.getValue(this.proName);return t&&(this.shaderValue.texture=t.source,this.shaderValue.strength&&!this.shaderValue.blurInfo&&(this.shaderValue.blurInfo=[t.width,t.height]),this.shaderValue.upload(),this.blend(),b.drawCall++,b.trianglesFaces+=this._numEle/3,Et.mainContext.drawElements(4,this._numEle,5123,this._startIdx)),1},e.blend=function(){if(z.activeBlendFunction!==z.fns[this.blendType]){var t=Et.mainContext;t.enable(3042),z.fns[this.blendType](t),z.activeBlendFunction=z.fns[this.blendType]}},e.getRenderType=function(){return 0},e.releaseRender=function(){var e=t._cache;e[e._length++]=this},t.create=function(e,i,n,r,a,s){var o=t._cache._length?t._cache[--t._cache._length]:new t;return o._ib=i,o._vb=n,o.proName=s,o._startIdx=r*mt.BYTES_PIDX,o._numEle=0,o.blendType=e._nBlendType,o.shaderValue=a,o.shaderValue.setValue(e._shader2D),o},n(t,["_cache",function(){return this._cache=(t._cache=[],t._cache._length=0,t._cache)}]),t}(),ct=function(){function t(){this._sourceStr=null}r(t,"laya.webgl.text.CharSegment");var e=t.prototype;return i.imps(e,{"laya.webgl.text.ICharSegment":!0}),e.textToSpit=function(t){this._sourceStr=t},e.getChar=function(t){return this._sourceStr.charAt(t)},e.getCharCode=function(t){return this._sourceStr.charCodeAt(t)},e.length=function(){return this._sourceStr.length},t}(),dt=function(){function t(){}var e;return r(t,"laya.webgl.text.DrawText"),t.__init__=function(){t._charsTemp=new Array,t._drawValue=new e,t._charSeg=new ct},t.customCharSeg=function(e){t._charSeg=e},t.getChar=function(e,i,n){var r=kt.createOneChar(e,n);return-1!=i&&(t._charsCache[i]=r),r},t._drawSlow=function(e,i,n,r,a,s,o,l,h,u,_,c,d,f,m){var p,v,g=t._drawValue.value(s,l,h,u,d,f,m),E=0,x=0,T=t._charsTemp,S=0,D=NaN;if(r)for(T.length=r.length,E=0,x=r.length;E<x;E++)v=r[E],D=v.charNum+g.txtID,T[E]=p=t._charsCache[D]||t.getChar(v.char,D,g),p.active();else{var M=n instanceof laya.utils.WordText?n.toString():n;if(P.CharacterCache){t._charSeg.textToSpit(M);var y=t._charSeg.length();for(T.length=y,E=0,x=y;E<x;E++)D=t._charSeg.getCharCode(E)+g.txtID,T[E]=p=t._charsCache[D]||t.getChar(t._charSeg.getChar(E),D,g),p.active(),S+=p.cw}else T.length=0,p=t.getChar(M,-1,g),p.active(),S+=p.cw,T[0]=p}var A=0;null!==o&&"left"!==o&&(A=-("center"==o?S/2:S));var I,R,C=NaN,b=0;if(r)for(E=0,x=T.length;E<x;E++)p=T[E],p.isSpace||(v=r[E],C=p.borderSize,I=p.texture,i._drawText(I,_+A+v.x*d-C,c+v.y*f-C,I.width,I.height,a,0,0,0,0));else{for(E=0,x=T.length;E<x;E++)p=T[E],p.isSpace||(C=p.borderSize,I=p.texture,i._drawText(I,_+A-C,c-C,I.width,I.height,a,0,0,0,0),e&&(R=e[b++],R||(R=e[b-1]=[]),R[0]=I,R[1]=A-C,R[2]=-C)),A+=p.cw;e&&(e.length=b)}},t._drawFast=function(t,e,i,n,r){for(var a,s,o=0,l=t.length;o<l;o++)s=t[o],a=s[0],a.active(),e._drawText(a,n+s[1],r+s[2],a.width,a.height,i,0,0,0,0)},t.drawText=function(e,n,r,a,s,o,l,h,u,_,c,f){if(void 0===f&&(f=0),!(n&&0===n.length||r&&0===r.length)){var m=a.a,p=a.d;(0!==a.b||0!==a.c)&&(m=p=1);var v=1!==m||1!==p;if(v&&i.stage.transform){var g=i.stage.transform;v=g.a===m&&g.d===p}else v=!1;if(v){a=a.copyTo(St._tmpMatrix);var E=a.tx,x=a.ty;a.scale(1/m,1/p),a._checkTransform(),_*=m,c*=p,_+=E-a.tx,c+=x-a.ty}else m=p=1;if(r)t._drawSlow(null,e,n,r,a,s,o,l,h,u,_,c,m,p,f);else{if(null===n.toUpperCase){var T=m+1e5*p,S=n;return void(S.changed||S.id!==T?(S.id=T,S.changed=!1,t._drawSlow(S.save,e,n,r,a,s,o,l,h,u,_,c,m,p,f)):t._drawFast(S.save,e,a,_,c))}var D=n+s.toString()+l+h+u+m+p+o,M=t._textsCache[D];P.CharacterCache?M?t._drawFast(M,e,a,_,c):(t._textsCache.__length||(t._textsCache.__length=0),t._textsCache.__length>d.WebGLTextCacheCount&&(t._textsCache={},t._textsCache.__length=0,t._curPoolIndex=0),t._textCachesPool[t._curPoolIndex]?(M=t._textsCache[D]=t._textCachesPool[t._curPoolIndex],M.length=0):t._textCachesPool[t._curPoolIndex]=M=t._textsCache[D]=[],t._textsCache.__length++,t._curPoolIndex++,t._drawSlow(M,e,n,r,a,s,o,l,h,u,_,c,m,p,f)):t._drawSlow(M,e,n,r,a,s,o,l,h,u,_,c,m,p,f)}}},t._charsTemp=null,t._textCachesPool=[],t._curPoolIndex=0,t._charsCache={},t._textsCache={},t._drawValue=null,t.d=[],t._charSeg=null,t.__init$=function(){e=function(){function t(){}return r(t,""),t.prototype.value=function(e,i,n,r,a,s,o){this.font=e,this.fillColor=i,this.borderColor=n,this.lineWidth=r,this.scaleX=a,this.scaleY=s,this.underLine=o;var l=e.toString()+a+s+r+i+n+o;return this.txtID=t._keymap[l],this.txtID||(this.txtID=1e-7*++t._keymapCount,t._keymap[l]=this.txtID),this},t.clear=function(){t._keymap={},t._keymapCount=1},t._keymap={},t._keymapCount=1,t}()},t}(),ft=function(){function t(e){this._index=0,this._size=14,this._italic=-2,t._cache2=t._cache2||[],this.setFont(e||"14px Arial")}r(t,"laya.webgl.text.FontInContext");var e=t.prototype;return e.setFont=function(e){var i=t._cache2[e];if(i)this._words=i[0],this._size=i[1];else{this._words=e.split(" ");for(var n=0,r=this._words.length;n<r;n++)if(this._words[n].indexOf("px")>0){this._index=n;break}this._size=parseInt(this._words[this._index]),t._cache2[e]=[this._words,this._size]}this._text=null,this._italic=-2},e.getItalic=function(){return-2===this._italic&&(this._italic=this.hasType("italic")),this._italic},e.hasType=function(t){for(var e=0,i=this._words.length;e<i;e++)if(this._words[e]===t)return e;return-1},e.removeType=function(t){for(var e=0,i=this._words.length;e<i;e++)if(this._words[e]===t){this._words.splice(e,1),this._index>e&&this._index--;break}this._text=null,this._italic=-2},e.copyTo=function(t){return t._text=this._text,t._size=this._size,t._index=this._index,t._words=this._words.slice(),t._italic=-2,t},e.toString=function(){return this._text?this._text:this._text=this._words.join(" ")},a(0,e,"size",function(){return this._size},function(t){this._size=t,this._words[this._index]=t+"px",this._text=null}),t.create=function(e){var i=t._cache[e];return i||(i=t._cache[e]=new t(e))},t._cache={},t._cache2=null,n(t,["EMPTY",function(){return this.EMPTY=new t}]),t}(),mt=function(){function t(){}return r(t,"laya.webgl.utils.CONST3D2D"),t._TMPARRAY=[],t._OFFSETX=0,t._OFFSETY=0,n(t,["BYTES_PE",function(){return this.BYTES_PE=Float32Array.BYTES_PER_ELEMENT},"BYTES_PIDX",function(){return this.BYTES_PIDX=Uint16Array.BYTES_PER_ELEMENT},"defaultMatrix4",function(){return this.defaultMatrix4=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},"defaultMinusYMatrix4",function(){return this.defaultMinusYMatrix4=[1,0,0,0,0,-1,0,0,0,0,1,0,0,0,0,1]},"uniformMatrix3",function(){return this.uniformMatrix3=[1,0,0,0,0,1,0,0,0,0,1,0]}]),t}(),pt=function(){function t(){}return r(t,"laya.webgl.utils.GlUtils"),t.make2DProjection=function(t,e,i){return[2/t,0,0,0,0,-2/e,0,0,0,0,2/i,0,-1,1,0,1]},t.fillIBQuadrangle=function(t,e){if(e>65535/4)throw Error("IBQuadrangle count:"+e+" must<:"+Math.floor(65535/4));e=Math.floor(e),t._resizeBuffer(6*(e+1)*2,!1),t.byteLength=t.bufferLength;for(var i=t.getUint16Array(),n=0,r=0;r<e;r++)i[n++]=4*r,i[n++]=4*r+2,i[n++]=4*r+1,i[n++]=4*r,i[n++]=4*r+3,i[n++]=4*r+2;return t.setNeedUpload(),!0},t.expandIBQuadrangle=function(e,i){e.bufferLength>=6*i*2||t.fillIBQuadrangle(e,i)},t.mathCeilPowerOfTwo=function(t){return t--,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t},t.fillQuadrangleImgVb=function(t,e,i,n,r,a,s,o){"use strict";var l=16+(t._byteLength>>2);t.byteLength=l<<2;var h=t.getFloat32Array();l-=16,h[l+2]=r[0],h[l+3]=r[1],h[l+6]=r[2],h[l+7]=r[3],h[l+10]=r[4],h[l+11]=r[5],h[l+14]=r[6],h[l+15]=r[7];var u=a.a,_=a.b,c=a.c,d=a.d;if(1!==u||0!==_||0!==c||1!==d){a.bTransform=!0;var f=a.tx+s,m=a.ty+o;h[l]=(n[0]+e)*u+(n[1]+i)*c+f,h[l+1]=(n[0]+e)*_+(n[1]+i)*d+m,h[l+4]=(n[2]+e)*u+(n[3]+i)*c+f,h[l+5]=(n[2]+e)*_+(n[3]+i)*d+m,h[l+8]=(n[4]+e)*u+(n[5]+i)*c+f,h[l+9]=(n[4]+e)*_+(n[5]+i)*d+m,h[l+12]=(n[6]+e)*u+(n[7]+i)*c+f,h[l+13]=(n[6]+e)*_+(n[7]+i)*d+m}else a.bTransform=!1,e+=a.tx+s,i+=a.ty+o,h[l]=e+n[0],h[l+1]=i+n[1],h[l+4]=e+n[2],h[l+5]=i+n[3],h[l+8]=e+n[4],h[l+9]=i+n[5],h[l+12]=e+n[6],h[l+13]=i+n[7];return t._upload=!0,!0},t.fillTranglesVB=function(t,e,i,n,r,a,s){var o=(t._byteLength>>2)+n.length;t.byteLength=o<<2;var l=t.getFloat32Array();o-=n.length;for(var h=n.length,u=r.a,_=r.b,c=r.c,d=r.d,f=0;f<h;f+=4)if(l[o+f+2]=n[f+2],l[o+f+3]=n[f+3],1!==u||0!==_||0!==c||1!==d){r.bTransform=!0;var m=r.tx+a,p=r.ty+s;l[o+f]=(n[f]+e)*u+(n[f+1]+i)*c+m,l[o+f+1]=(n[f]+e)*_+(n[f+1]+i)*d+p}else r.bTransform=!1,e+=r.tx+a,i+=r.ty+s,l[o+f]=e+n[f],l[o+f+1]=i+n[f+1];return t._upload=!0,!0},t.copyPreImgVb=function(t,e,i){var n=t._byteLength>>2;t.byteLength=n+16<<2;for(var r=t.getFloat32Array(),a=0,s=n-16;a<4;a++)r[n]=r[s]+e,++n,++s,r[n]=r[s]+i,++n,++s,r[n]=r[s],++n,++s,r[n]=r[s],++n,++s;t._upload=!0},t.fillRectImgVb=function(t,e,i,n,r,a,s,o,l,h,u,_,c){void 0===c&&(c=!1);var d,f,m,p,v,g,E,x,T,S,D,M,y,A,I,R,C=1,b=o.a,w=o.b,N=o.c,P=o.d,L=e&&e.width<99999999;if(1!==b||0!==w||0!==N||1!==P?(o.bTransform=!0,0===w&&0===N&&(C=23,T=r+i,S=a+n,D=o.tx+l,M=o.ty+h,d=b*i+D,m=b*T+D,f=P*n+M,p=P*S+M)):(C=23,o.bTransform=!1,d=i+o.tx+l,m=d+r,f=n+o.ty+h,p=f+a),L&&(v=e.x,g=e.y,E=e.width+v,x=e.height+g),1!==C){if(Math.min(d,m)>=E)return!1;if(Math.min(f,p)>=x)return!1;if(Math.max(m,d)<=v)return!1;if(Math.max(p,f)<=g)return!1}var O=t._byteLength>>2;t.byteLength=O+16<<2;var V=t.getFloat32Array();switch(V[O+2]=s[0],V[O+3]=s[1],V[O+6]=s[2],V[O+7]=s[3],V[O+10]=s[4],V[O+11]=s[5],V[O+14]=s[6],V[O+15]=s[7],C){case 1:D=o.tx+l,M=o.ty+h,T=r+i,S=a+n;var F=i,B=n,U=b*F,H=N*B,G=P*B,z=w*F,k=b*T,W=N*S,X=P*S,Y=w*T;c?(y=U+H+D,I=Math.round(y)-y,A=G+z+M,R=Math.round(A)-A,V[O]=y+I,V[O+1]=A+R,V[O+4]=k+H+D+I,V[O+5]=G+Y+M+R,V[O+8]=k+W+D+I,V[O+9]=X+Y+M+R,V[O+12]=U+W+D+I,V[O+13]=X+z+M+R):(V[O]=U+H+D,V[O+1]=G+z+M,V[O+4]=k+H+D,V[O+5]=G+Y+M,V[O+8]=k+W+D,V[O+9]=X+Y+M,V[O+12]=U+W+D,V[O+13]=X+z+M);break;case 23:c?(y=d+u,I=Math.round(y)-y,A=f,R=Math.round(A)-A,V[O]=y+I,V[O+1]=A+R,V[O+4]=m+u+I,V[O+5]=f+R,V[O+8]=m+I,V[O+9]=p+R,V[O+12]=d+I,V[O+13]=p+R):(V[O]=d+u,V[O+1]=f,V[O+4]=m+u,V[O+5]=f,V[O+8]=m,V[O+9]=p,V[O+12]=d,V[O+13]=p)}return t._upload=!0,!0},t.fillLineVb=function(e,i,n,r,a,s,o,l){"use strict";var h=.5*o,u=t._fillLineArray,_=-(r-s),c=n-a,d=Math.sqrt(_*_+c*c);_/=d,c/=d,_*=h,c*=h,u[0]=n-_,u[1]=r-c,u[4]=n+_,u[5]=r+c,u[8]=a+_,u[9]=s+c,u[12]=a-_,u[13]=s-c,l&&l.transformPointArray(u,u);var f=16+(e._byteLength>>2);return e.byteLength=f<<2,e.insertData(u,f-16),!0},n(t,["_fillLineArray",function(){return this._fillLineArray=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]}]),t}(),vt=(function(){function t(){}r(t,"laya.webgl.utils.MatirxArray"),t.ArrayMul=function(e,i,n){if(!e)return void t.copyArray(i,n);if(!i)return void t.copyArray(e,n);for(var r=NaN,a=NaN,s=NaN,o=NaN,l=0;l<4;l++)r=e[l],a=e[l+4],s=e[l+8],o=e[l+12],n[l]=r*i[0]+a*i[1]+s*i[2]+o*i[3],n[l+4]=r*i[4]+a*i[5]+s*i[6]+o*i[7],n[l+8]=r*i[8]+a*i[9]+s*i[10]+o*i[11],n[l+12]=r*i[12]+a*i[13]+s*i[14]+o*i[15]},t.copyArray=function(t,e){if(t&&e)for(var i=0;i<t.length;i++)e[i]=t[i]}}(),function(){function t(){}return r(t,"laya.webgl.utils.RenderState2D"),t.getMatrArray=function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},t.mat2MatArray=function(e,i){var n=e,r=i;return r[0]=n.a,r[1]=n.b,r[2]=t.EMPTYMAT4_ARRAY[2],r[3]=t.EMPTYMAT4_ARRAY[3],r[4]=n.c,r[5]=n.d,r[6]=t.EMPTYMAT4_ARRAY[6],r[7]=t.EMPTYMAT4_ARRAY[7],r[8]=t.EMPTYMAT4_ARRAY[8],r[9]=t.EMPTYMAT4_ARRAY[9],r[10]=t.EMPTYMAT4_ARRAY[10],r[11]=t.EMPTYMAT4_ARRAY[11],r[12]=n.tx,r[13]=n.ty,r[14]=t.EMPTYMAT4_ARRAY[14],r[15]=t.EMPTYMAT4_ARRAY[15],i},t.restoreTempArray=function(){t.TEMPMAT4_ARRAY[0]=1,t.TEMPMAT4_ARRAY[1]=0,t.TEMPMAT4_ARRAY[4]=0,t.TEMPMAT4_ARRAY[5]=1,t.TEMPMAT4_ARRAY[12]=0,t.TEMPMAT4_ARRAY[13]=0},t.clear=function(){t.worldScissorTest=!1,t.worldShaderDefines=null,t.worldFilters=null,t.worldAlpha=1,t.worldClipRect.x=t.worldClipRect.y=0,t.worldClipRect.width=t.width,t.worldClipRect.height=t.height,t.curRenderTarget=null},t._MAXSIZE=99999999,t.worldAlpha=1,t.worldScissorTest=!1,t.worldFilters=null,t.worldShaderDefines=null,t.curRenderTarget=null,t.width=0,t.height=0,n(t,["EMPTYMAT4_ARRAY",function(){return this.EMPTYMAT4_ARRAY=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},"TEMPMAT4_ARRAY",function(){return this.TEMPMAT4_ARRAY=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},"worldMatrix4",function(){return this.worldMatrix4=t.TEMPMAT4_ARRAY},"worldMatrix",function(){return this.worldMatrix=new x},"worldClipRect",function(){return this.worldClipRect=new S(0,0,99999999,99999999)}]),t}()),gt=function(){function t(t,i,n,r,a){function s(t){var i=[],n=new e(i);return o._compileToTree(n,t.split("\n"),0,i,a),n}var o=this,l=u.now();this._VS=s(i),this._PS=s(n),this._nameMap=r,u.now()-l>2&&console.log("ShaderCompile use time:"+(u.now()-l)+"  size:"+i.length+"/"+n.length)}var e,i;r(t,"laya.webgl.utils.ShaderCompile");var a=t.prototype;return a._compileToTree=function(i,n,r,a,s){var o,l,h,u,_,c,d,f=0,m=0,p=0,v=0;for(m=r;m<n.length;m++)if(h=n[m],!(h.length<1)&&0!==(f=h.indexOf("//"))){if(f>=0&&(h=h.substr(0,f)),o=d||new e(a),d=null,o.text=h,o.noCompile=!0,(f=h.indexOf("#"))>=0){for(u="#",v=f+1,p=h.length;v<p;v++){var g=h.charAt(v);if(" "===g||"\t"===g||"?"===g)break;u+=g}switch(o.name=u,u){case"#ifdef":case"#ifndef":if(o.src=h,o.noCompile=null!=h.match(/[!&|()=<>]/),o.noCompile?console.log("function():Boolean{return "+h.substr(f+o.name.length)+"}"):(c=h.replace(/^\s*/,"").split(/\s+/),o.setCondition(c[1],"#ifdef"===u?1:2),o.text="//"+o.text),o.setParent(i),i=o,s)for(c=h.substr(v).split(t._splitToWordExps3),v=0;v<c.length;v++)h=c[v],h.length&&(s[h]=!0);continue;case"#if":if(o.src=h,o.noCompile=!0,o.setParent(i),i=o,s)for(c=h.substr(v).split(t._splitToWordExps3),v=0;v<c.length;v++)h=c[v],h.length&&"defined"!=h&&(s[h]=!0);continue;case"#else":o.src=h,i=i.parent,l=i.childs[i.childs.length-1],o.noCompile=l.noCompile,o.noCompile||(o.condition=l.condition,o.conditionType=1==l.conditionType?2:1,o.text="//"+o.text+" "+l.text+" "+o.conditionType),o.setParent(i),i=o;continue;case"#endif":i=i.parent,l=i.childs[i.childs.length-1],o.noCompile=l.noCompile,o.noCompile||(o.text="//"+o.text),o.setParent(i);continue;case"#include":c=t.splitToWords(h,null);var E=t.includes[c[1]];if(!E)throw"ShaderCompile error no this include file:"+c[1];if((f=c[0].indexOf("?"))<0){o.setParent(i),h=E.getWith("with"==c[2]?c[3]:null),this._compileToTree(o,h.split("\n"),0,a,s),o.text="";continue}o.setCondition(c[0].substr(f+1),1),o.text=E.getWith("with"==c[2]?c[3]:null);break;case"#import":c=t.splitToWords(h,null),_=c[1],a.push({node:o,file:t.includes[_],ofs:o.text.length});continue}}else{if((l=i.childs[i.childs.length-1])&&!l.name){a.length>0&&t.splitToWords(h,l),d=o,l.text+="\n"+h;continue}a.length>0&&t.splitToWords(h,o)}o.setParent(i)}},a.createShader=function(t,e,i){var n={},r="";if(t)for(var a in t)r+="#define "+a+"\n",n[a]=!0;var s=this._VS.toscript(n,[]),o=this._PS.toscript(n,[]);return(i||Yt.create)(r+s.join("\n"),r+o.join("\n"),e,this._nameMap)},t._parseOne=function(e,i,n,r,a,s){var o={type:t.shaderParamsMap[n[r+1]],name:n[r+2],size:isNaN(parseInt(n[r+3]))?1:parseInt(n[r+3])};return s&&("attribute"==a?e.push(o):i.push(o)),":"==n[r+3]&&(o.type=n[r+4],r+=2),r+=2},t.addInclude=function(e,n){if(!n||0===n.length)throw new Error("add shader include file err:"+e);if(t.includes[e])throw new Error("add shader include file err, has add:"+e);t.includes[e]=new i(n)},t.preGetParams=function(e,i){var n=[e,i],r={},a=[],s=[],o={},l=[];r.attributes=a,r.uniforms=s,r.defines=o;for(var h=0,u=0,_=0;_<2;_++){n[_]=n[_].replace(t._removeAnnotation,"");var c,d=n[_].match(t._reg);for(h=0,u=d.length;h<u;h++){var f=d[h];if("attribute"==f||"uniform"==f)h=t._parseOne(a,s,d,h,f,!0);else{if("#define"==f){f=d[++h],l[f]=1;continue}if("#ifdef"==f){c=d[++h];o[c]=o[c]||[];for(h++;h<u;h++)if("attribute"==(f=d[h])||"uniform"==f)h=t._parseOne(a,s,d,h,f,l[c]);else if("#else"==f)for(h++;h<u;h++)if("attribute"==(f=d[h])||"uniform"==f)h=t._parseOne(a,s,d,h,f,!l[c]);else if("#endif"==f)break}}}}return r},t.splitToWords=function(t,e){for(var i,n,r=[],a=-1,s=0,o=t.length;s<o;s++)if(i=t.charAt(s)," \t=+-*/&%!<>()'\",;".indexOf(i)>=0){if(a>=0&&s-a>1&&(n=t.substr(a,s-a),r.push(n)),'"'==i||"'"==i){var l=t.indexOf(i,s+1);if(l<0)throw"Sharder err:"+t;r.push(t.substr(s+1,l-s-1)),s=l,a=-1;continue}"("==i&&e&&r.length>0&&(n=r[r.length-1]+";","vec4;main;".indexOf(n)<0&&(e.useFuns+=n)),a=-1}else a<0&&(a=s);return a<o&&o-a>1&&(n=t.substr(a,o-a),r.push(n)),r},t.IFDEF_NO=0,t.IFDEF_YES=1,t.IFDEF_ELSE=2,t.IFDEF_PARENT=3,t.includes={},n(t,["_removeAnnotation",function(){return this._removeAnnotation=new RegExp("(/\\*([^*]|[\\r\\\n]|(\\*+([^*/]|[\\r\\n])))*\\*+/)|(//.*)","g")},"_reg",function(){return this._reg=new RegExp("(\".*\")|('.*')|([#\\w\\*-\\.+/()=<>{}\\\\]+)|([,;:\\\\])","g")},"_splitToWordExps",function(){return this._splitToWordExps=new RegExp("[(\".*\")]+|[('.*')]+|([ \\t=\\+\\-*/&%!<>!%(),;])","g")},"shaderParamsMap",function(){return this.shaderParamsMap={float:5126,int:5124,bool:35670,vec2:35664,vec3:35665,vec4:35666,ivec2:35667,ivec3:35668,ivec4:35669,bvec2:35671,bvec3:35672,bvec4:35673,mat2:35674,mat3:35675,mat4:35676,sampler2D:35678,samplerCube:35680}},"_splitToWordExps3",function(){return this._splitToWordExps3=new RegExp("[ \\t=\\+\\-*/&%!<>!%(),;\\|]","g")}]),t.__init$=function(){e=function(){function t(t){this.childs=[],this.text="",this.parent=null,this.name=null,this.noCompile=!1,this.includefiles=null,this.condition=null,this.conditionType=0,this.useFuns="",this.z=0,this.src=null,this.includefiles=t}r(t,"");var e=t.prototype;return e.setParent=function(t){t.childs.push(this),this.z=t.z+1,this.parent=t},e.setCondition=function(t,e){t&&(this.conditionType=e,t=t.replace(/(\s*$)/g,""),this.condition=function(){return this[t]},this.condition.__condition=t)},e.toscript=function(e,i){return this._toscript(e,i,++t.__id)},e._toscript=function(t,e,i){if(this.childs.length<1&&!this.text)return e;e.length;if(this.condition){var n=!!this.condition.call(t);if(2===this.conditionType&&(n=!n),!n)return e}if(this.text&&e.push(this.text),this.childs.length>0&&this.childs.forEach(function(n,r,a){n._toscript(t,e,i)}),this.includefiles.length>0&&this.useFuns.length>0)for(var r,a=0,s=this.includefiles.length;a<s;a++)this.includefiles[a].curUseID!=i&&(r=this.includefiles[a].file.getFunsScript(this.useFuns),r.length>0&&(this.includefiles[a].curUseID=i,e[0]=r+e[0]));return e},t.__id=1,t}(),i=function(){function e(e){this.script=null,this.codes={},this.funs={},this.curUseID=-1,this.funnames="",this.script=e;for(var i=0,n=0,r=0;;){if((i=e.indexOf("#begin",i))<0)break;for(r=i+5;;){if((r=e.indexOf("#end",r))<0)break;if("i"!==e.charAt(r+4))break;r+=5}if(r<0)throw"add include err,no #end:"+e;n=e.indexOf("\n",i);var a=t.splitToWords(e.substr(i,n-i),null);"code"==a[1]?this.codes[a[2]]=e.substr(n+1,r-n-1):"function"==a[1]&&(n=e.indexOf("function",i),n+="function".length,this.funs[a[3]]=e.substr(n+1,r-n-1),this.funnames+=a[3]+";"),i=r+1}}r(e,"");var i=e.prototype;return i.getWith=function(t){var e=t?this.codes[t]:this.script;if(!e)throw"get with error:"+t;return e},i.getFunsScript=function(t){var e="";for(var i in this.funs)t.indexOf(i+";")>=0&&(e+=this.funs[i]);return e},e}()},t}(),Et=function(){function t(){}return r(t,"laya.webgl.WebGL"),t._uint8ArraySlice=function(){for(var t=this,e=t.length,i=new Uint8Array(t.length),n=0;n<e;n++)i[n]=t[n];return i},t._float32ArraySlice=function(){for(var t=this,e=t.length,i=new Float32Array(t.length),n=0;n<e;n++)i[n]=t[n];return i},t._uint16ArraySlice=function(t){var e,i=arguments,n=this,r=0,a=0;if(0===i.length)for(r=n.length,e=new Uint16Array(r),a=0;a<r;a++)e[a]=n[a];else if(2===i.length){var s=i[0],o=i[1];if(o>s)for(r=o-s,e=new Uint16Array(r),a=s;a<o;a++)e[a-s]=n[a];else e=new Uint16Array(0)}return e},t.expandContext=function(){var t=f.prototype,e=CanvasRenderingContext2D.prototype;e.fillTrangles=t.fillTrangles,Zt.__int__(null),e.setIBVB=function(t,e,i,n,r,a,s,o,l,h){void 0===l&&(l=0),void 0===h&&(h=0),null===i&&(this._ib=this._ib||qt.QuadrangleIB,i=this._ib,pt.expandIBQuadrangle(i,n._byteLength/64+8)),this._setIBVB(t,e,i,n,r,a,s,o,l,h)},e.fillTrangles=function(t,e,i,n,r){this._curMat=this._curMat||x.create(),this._vb=this._vb||Qt.create(),this._ib||(this._ib=qt.create(),pt.fillIBQuadrangle(this._ib,s/4));var a=this._vb,s=n.length>>4;pt.fillTranglesVB(a,e,i,n,r||this._curMat,0,0),pt.expandIBQuadrangle(this._ib,a._byteLength/64+8);var o=new Dt(1,0);o.textureHost=t;var l=new jt("attribute vec2 position; attribute vec2 texcoord; uniform vec2 size; uniform mat4 mmat; varying vec2 v_texcoord; void main() { vec4 p=vec4(position.xy,0.0,1.0);vec4 pos=mmat*p; gl_Position =vec4((pos.x/size.x-0.5)*2.0,(0.5-pos.y/size.y)*2.0,pos.z,1.0); v_texcoord = texcoord; }","precision mediump float; varying vec2 v_texcoord; uniform sampler2D texture; void main() {vec4 color= texture2D(texture, v_texcoord); color.a*=1.0; gl_FragColor= color;}");a._vertType=3,this._setIBVB(e,i,this._ib,a,6*s,r,l,o,0,0)}},t.enable=function(){if(u.__init__(),D.isConchApp&&!D.isConchWebGL)return I.skinAniSprite=function(){return new tt},t.expandContext(),!1;if(I.getWebGLContext=function(t){for(var e,i=["webgl","experimental-webgl","webkit-3d","moz-webgl"],n=0;n<i.length;n++){try{e=t.getContext(i[n],{stencil:d.isStencil,alpha:d.isAlpha,antialias:d.isAntialias,premultipliedAlpha:d.premultipliedAlpha,preserveDrawingBuffer:d.preserveDrawingBuffer})}catch(t){}if(e)return e}return null},t.mainContext=I.getWebGLContext(D._mainCanvas),null==t.mainContext)return!1;if(D.isWebGL)return!0;g.create=function(t,e){return new $t(t,e)},E.create=function(t,e,i,n,r,a,s){return new Xt(t,e,i,n,r,a,s)},D.WebGL=t,D.isWebGL=!0,dt.__init__(),I.createRenderSprite=function(t,e){return new Mt(t,e)},I.createWebGLContext2D=function(t){return new St(t)},I.changeWebGLSize=function(t,e){laya.webgl.WebGL.onStageResize(t,e)},I.createGraphics=function(){return new Tt};var e=I.createFilterAction;return I.createFilterAction=e||function(t){return new yt},I.clear=function(t){vt.worldScissorTest&&laya.webgl.WebGL.mainContext.disable(3089);var e=D.context.ctx,i=0==e._submits._length||d.preserveDrawingBuffer?c.create(t)._color:C._wgColor;i&&e.clearBG(i[0],i[1],i[2],i[3]),vt.clear()},I.addToAtlas=function(t,e){void 0===e&&(e=!1);var n=t.bitmap;if(!D.optimizeTextureMemory(t.url,t))return void(n.enableMerageInAtlas=!1);i.__typeof(n,"laya.webgl.resource.IMergeAtlasBitmap")&&n.allowMerageInAtlas&&n.on("recovered",t,t.addTextureToAtlas)},I.isAtlas=function(t){return t instanceof laya.webgl.atlas.AtlasWebGLCanvas},H._enable(),I.beginFlush=function(){for(var t=H.instance,e=t.getAtlaserCount(),i=0;i<e;i++){var n=t.getAtlaserByIndex(i).texture;n._flashCacheImageNeedFlush&&I.flashFlushImage(n)}},I.drawToCanvas=function(t,e,i,n,r,a){(i<=0||n<=0)&&console.log("[error] canvasWidth and canvasHeight should greater than zero"),r-=t.x,a-=t.y;var s=Lt.create(i,n,6408,5121,0,!1);s.start(),s.clear(0,0,0,0),D.context.clear(),M.renders[e]._fun(t,D.context,r,vt.height-n+a),D.context.flush(),s.end();var o=s.getData(0,0,s.width,s.height);s.recycle();var l=new zt;l._canvas=u.createElement("canvas"),l.size(i,n);var h=l._canvas.getContext("2d");u.canvas.size(i,n);var _=u.context,c=_.createImageData(i,n);return c.data.set(new Uint8ClampedArray(o.buffer)),l._imgData=c,_.putImageData(c,0,0),h.save(),h.translate(0,n),h.scale(1,-1),h.drawImage(u.canvas.source,0,0),h.restore(),l},I.createFilterAction=function(t){var e;switch(t){case 32:e=new yt}return e},I.addTextureToAtlas=function(t){t._uvID++,H._atlasRestore++,t.bitmap.enableMerageInAtlas&&H.instance.addToAtlas(t)},I.getTexturePixels=function(t,e,i,n,r){D.context.ctx.clear();var a=new R;a.graphics.drawTexture(t,-e,-i);var s=Lt.create(n,r);s.start(),s.clear(0,0,0,0),a.render(D.context,0,0),D.context.ctx.flush(),s.end();for(var o=s.getData(0,0,n,r),l=[],h=0,u=r-1;u>=0;u--)for(var _=0;_<n;_++)h=4*(u*n+_),l.push(o[h]),l.push(o[h+1]),l.push(o[h+2]),l.push(o[h+3]);return l},I.skinAniSprite=function(){return new tt},v.create=function(t,e){var i=new zt;return i._imgData=e,i.flipY=!1,i},m._filterStart=function(t,e,i,n,r){var a=t.getValue("bounds"),s=Lt.create(a.width,a.height);if(s.start(),s.clear(0,0,0,0),t.addValue("src",s),t.addValue("ScissorTest",vt.worldScissorTest),vt.worldScissorTest){var o=new S;o.copyFrom(i.ctx._clipRect),t.addValue("clipRect",o),vt.worldScissorTest=!1,laya.webgl.WebGL.mainContext.disable(3089)}},m._filterEnd=function(t,e,i,n,r){var a=t.getValue("bounds");t.getValue("src").end();var s=Lt.create(a.width,a.height);s.start(),s.clear(0,0,0,0),t.addValue("out",s),e._set$P("_filterCache",s),e._set$P("_isHaveGlowFilter",t.getValue("_isHaveGlowFilter"))},m._EndTarget=function(t,e){if(t.getValue("src").recycle(),t.getValue("out").end(),t.getValue("ScissorTest")){vt.worldScissorTest=!0,laya.webgl.WebGL.mainContext.enable(3089),e.ctx.save();var i=t.getValue("clipRect");e.ctx.clipRect(i.x,i.y,i.width,i.height)}},m._useSrc=function(t){var e=t.getValue("out");e.end(),e=t.getValue("src"),e.start(),e.clear(0,0,0,0)},m._endSrc=function(t){t.getValue("src").end()},m._useOut=function(t){var e=t.getValue("src");e.end(),e=t.getValue("out"),e.start(),e.clear(0,0,0,0)},m._endOut=function(t){t.getValue("out").end()},m._recycleScope=function(t){t.recycle()},m._filter=function(t,e,i,n){var r=this._next;if(r){var a=t.filters,s=a.length;if(1==s&&32==a[0].type)return e.ctx.save(),e.ctx.setFilters([a[0]]),r._fun.call(r,t,e,i,n),void e.ctx.restore();var o,l,h=ot.create(),u=T.TEMP,_=e.ctx._getTransformMatrix(),c=x.create();_.copyTo(c);var d=0,f=0,p=!1,v=t._$P._filterCache?t._$P._filterCache:null;if(!v||t._repaint){p=t._isHaveGlowFilter(),h.addValue("_isHaveGlowFilter",p),p&&(d=50,f=25),l=new S,l.copyFrom(t.getSelfBounds()),l.x+=t.x,l.y+=t.y,l.x-=t.pivotX+4,l.y-=t.pivotY+4;var g=l.x,E=l.y;if(l.width+=d+8,l.height+=d+8,u.x=l.x*c.a+l.y*c.c,u.y=l.y*c.d+l.x*c.b,l.x=u.x,l.y=u.y,u.x=l.width*c.a+l.height*c.c,u.y=l.height*c.d+l.width*c.b,l.width=u.x,l.height=u.y,l.width<=0||l.height<=0)return;v&&v.recycle(),h.addValue("bounds",l);var D=st.create([h,t,e,0,0],m._filterStart);e.addRenderObject(D),e.ctx._renderKey=0,e.ctx._shader2D.glTexture=null;var M=t.x-g+f,y=t.y-E+f;r._fun.call(r,t,e,M,y),D=st.create([h,t,e,0,0],m._filterEnd),e.addRenderObject(D);for(var A=0;A<s;A++){0!=A&&(D=st.create([h],m._useSrc),e.addRenderObject(D),o=Dt.create(1,0),x.TEMP.identity(),e.ctx.drawTarget(h,0,0,l.width,l.height,x.TEMP,"out",o,null,z.TOINT.overlay),D=st.create([h],m._useOut),e.addRenderObject(D));a[A].action.apply3d(h,t,e,0,0)}D=st.create([h,e],m._EndTarget),e.addRenderObject(D)}else{if(p=!!t._$P._isHaveGlowFilter&&t._$P._isHaveGlowFilter,p&&(d=50,f=25),l=t.getBounds(),l.width<=0||l.height<=0)return;l.width+=d,l.height+=d,u.x=l.x*c.a+l.y*c.c,u.y=l.y*c.d+l.x*c.b,l.x=u.x,l.y=u.y,u.x=l.width*c.a+l.height*c.c,u.y=l.height*c.d+l.width*c.b,l.width=u.x,l.height=u.y,h.addValue("out",v)}i=i-f-t.x,n=n-f-t.y,u.setTo(i,n),c.transformPoint(u),i=u.x+l.x,n=u.y+l.y,o=Dt.create(1,0),x.TEMP.identity(),e.ctx.drawTarget(h,i,n,l.width,l.height,x.TEMP,"out",o,null,z.TOINT.overlay),D=st.create([h],m._recycleScope),e.addRenderObject(D),c.destroy()}},Float32Array.prototype.slice||(Float32Array.prototype.slice=t._float32ArraySlice),Uint16Array.prototype.slice||(Uint16Array.prototype.slice=t._uint16ArraySlice),Uint8Array.prototype.slice||(Uint8Array.prototype.slice=t._uint8ArraySlice),!0},t.onStageResize=function(e,i){null!=t.mainContext&&(t.mainContext.viewport(0,0,e,i),vt.width=e,vt.height=i)},t.onInvalidGLRes=function(){H.instance.freeAll(),A.releaseContentManagers(!0),t.doNodeRepaint(i.stage),t.mainContext.viewport(0,0,vt.width,vt.height),i.stage.event("devicelost")},t.doNodeRepaint=function(e){0==e.numChildren&&e.repaint();for(var i=0;i<e.numChildren;i++)t.doNodeRepaint(e.getChildAt(i))},t.init=function(e,i,n){t.mainCanvas=e,v._createContext=function(t){return new St(t)},zt._createContext=function(t){return new St(t)};var r=laya.webgl.WebGL.mainContext;if(null!=r.getShaderPrecisionFormat){var a=r.getShaderPrecisionFormat(35633,36338),s=r.getShaderPrecisionFormat(35632,36338);t.shaderHighPrecision=!(!a.precision||!s.precision)}else t.shaderHighPrecision=!1;if(t.compressAstc=r.getExtension("WEBGL_compressed_texture_astc"),t.compressAtc=r.getExtension("WEBGL_compressed_texture_atc"),t.compressEtc=r.getExtension("WEBGL_compressed_texture_etc"),t.compressEtc1=r.getExtension("WEBGL_compressed_texture_etc1"),t.compressPvrtc=r.getExtension("WEBGL_compressed_texture_pvrtc"),t.compressS3tc=r.getExtension("WEBGL_compressed_texture_s3tc"),t.compressS3tc_srgb=r.getExtension("WEBGL_compressed_texture_s3tc_srgb"),r.deleteTexture1=r.deleteTexture,r.deleteTexture=function(t){t==xt.curBindTexValue&&(xt.curBindTexValue=null),r.deleteTexture1(t)},t.onStageResize(i,n),null==t.mainContext)throw new Error("webGL getContext err!");N.__init__(),H.__init__(),It.__init__(),at.__init__(),St.__init__(),Dt.__init__(),$.__init__(),Zt.__int__(r),z._init_(r),D.isConchApp&&conch.setOnInvalidGLRes(t.onInvalidGLRes)},t.compressAstc=null,t.compressAtc=null,t.compressEtc=null,t.compressEtc1=null,t.compressPvrtc=null,t.compressS3tc=null,t.compressS3tc_srgb=null,t.mainCanvas=null,t.mainContext=null,t.antialias=!0,t.shaderHighPrecision=!1,n(t,["_bg_null",function(){return this._bg_null=[0,0,0,0]}]),t}(),xt=function(){function t(){}return r(t,"laya.webgl.WebGLContext"),t.UseProgram=function(e){return t._useProgram!==e&&(Et.mainContext.useProgram(e),t._useProgram=e,!0)},t.setDepthTest=function(e,i){i!==t._depthTest&&(t._depthTest=i,i?e.enable(2929):e.disable(2929))},t.setDepthMask=function(e,i){i!==t._depthMask&&(t._depthMask=i,e.depthMask(i))},t.setDepthFunc=function(e,i){i!==t._depthFunc&&(t._depthFunc=i,e.depthFunc(i))},t.setBlend=function(e,i){i!==t._blend&&(t._blend=i,i?e.enable(3042):e.disable(3042))},t.setBlendFunc=function(e,i,n){(i!==t._sFactor||n!==t._dFactor)&&(t._sFactor=i,t._dFactor=n,e.blendFunc(i,n))},t.setCullFace=function(e,i){i!==t._cullFace&&(t._cullFace=i,i?e.enable(2884):e.disable(2884))},t.setFrontFace=function(e,i){i!==t._frontFace&&(t._frontFace=i,e.frontFace(i))},t.bindTexture=function(e,i,n){e.bindTexture(i,n),t.curBindTexTarget=i,t.curBindTexValue=n},t.DEPTH_BUFFER_BIT=256,t.STENCIL_BUFFER_BIT=1024,t.COLOR_BUFFER_BIT=16384,t.POINTS=0,t.LINES=1,t.LINE_LOOP=2,t.LINE_STRIP=3,t.TRIANGLES=4,t.TRIANGLE_STRIP=5,t.TRIANGLE_FAN=6,t.ZERO=0,t.ONE=1,t.SRC_COLOR=768,t.ONE_MINUS_SRC_COLOR=769,t.SRC_ALPHA=770,t.ONE_MINUS_SRC_ALPHA=771,t.DST_ALPHA=772,t.ONE_MINUS_DST_ALPHA=773,t.DST_COLOR=774,t.ONE_MINUS_DST_COLOR=775,t.SRC_ALPHA_SATURATE=776,t.FUNC_ADD=32774,t.BLEND_EQUATION=32777,t.BLEND_EQUATION_RGB=32777,t.BLEND_EQUATION_ALPHA=34877,t.FUNC_SUBTRACT=32778,t.FUNC_REVERSE_SUBTRACT=32779,t.BLEND_DST_RGB=32968,t.BLEND_SRC_RGB=32969,t.BLEND_DST_ALPHA=32970,t.BLEND_SRC_ALPHA=32971,t.CONSTANT_COLOR=32769,t.ONE_MINUS_CONSTANT_COLOR=32770,t.CONSTANT_ALPHA=32771,t.ONE_MINUS_CONSTANT_ALPHA=32772,t.BLEND_COLOR=32773,t.ARRAY_BUFFER=34962,t.ELEMENT_ARRAY_BUFFER=34963,t.ARRAY_BUFFER_BINDING=34964,t.ELEMENT_ARRAY_BUFFER_BINDING=34965,t.STREAM_DRAW=35040,t.STATIC_DRAW=35044,t.DYNAMIC_DRAW=35048,t.BUFFER_SIZE=34660,t.BUFFER_USAGE=34661,t.CURRENT_VERTEX_ATTRIB=34342,t.FRONT=1028,t.BACK=1029,t.CULL_FACE=2884,t.FRONT_AND_BACK=1032,t.BLEND=3042,t.DITHER=3024,t.STENCIL_TEST=2960,t.DEPTH_TEST=2929,t.SCISSOR_TEST=3089,t.POLYGON_OFFSET_FILL=32823,t.SAMPLE_ALPHA_TO_COVERAGE=32926,t.SAMPLE_COVERAGE=32928,t.NO_ERROR=0,t.INVALID_ENUM=1280,t.INVALID_VALUE=1281,t.INVALID_OPERATION=1282,t.OUT_OF_MEMORY=1285,t.CW=2304,t.CCW=2305,t.LINE_WIDTH=2849,t.ALIASED_POINT_SIZE_RANGE=33901,t.ALIASED_LINE_WIDTH_RANGE=33902,t.CULL_FACE_MODE=2885,t.FRONT_FACE=2886,t.DEPTH_RANGE=2928,t.DEPTH_WRITEMASK=2930,t.DEPTH_CLEAR_VALUE=2931,t.DEPTH_FUNC=2932,t.STENCIL_CLEAR_VALUE=2961,t.STENCIL_FUNC=2962,t.STENCIL_FAIL=2964,t.STENCIL_PASS_DEPTH_FAIL=2965,t.STENCIL_PASS_DEPTH_PASS=2966,t.STENCIL_REF=2967,t.STENCIL_VALUE_MASK=2963,t.STENCIL_WRITEMASK=2968,t.STENCIL_BACK_FUNC=34816,t.STENCIL_BACK_FAIL=34817,t.STENCIL_BACK_PASS_DEPTH_FAIL=34818,t.STENCIL_BACK_PASS_DEPTH_PASS=34819,t.STENCIL_BACK_REF=36003,t.STENCIL_BACK_VALUE_MASK=36004,t.STENCIL_BACK_WRITEMASK=36005,t.VIEWPORT=2978,t.SCISSOR_BOX=3088,t.COLOR_CLEAR_VALUE=3106,t.COLOR_WRITEMASK=3107,t.UNPACK_ALIGNMENT=3317,t.PACK_ALIGNMENT=3333,t.MAX_TEXTURE_SIZE=3379,t.MAX_VIEWPORT_DIMS=3386,t.SUBPIXEL_BITS=3408,t.RED_BITS=3410,t.GREEN_BITS=3411,t.BLUE_BITS=3412,t.ALPHA_BITS=3413,t.DEPTH_BITS=3414,t.STENCIL_BITS=3415,t.POLYGON_OFFSET_UNITS=10752,t.POLYGON_OFFSET_FACTOR=32824,t.TEXTURE_BINDING_2D=32873,t.SAMPLE_BUFFERS=32936,t.SAMPLES=32937,t.SAMPLE_COVERAGE_VALUE=32938,t.SAMPLE_COVERAGE_INVERT=32939,t.NUM_COMPRESSED_TEXTURE_FORMATS=34466,t.COMPRESSED_TEXTURE_FORMATS=34467,t.DONT_CARE=4352,t.FASTEST=4353,t.NICEST=4354,t.GENERATE_MIPMAP_HINT=33170,t.BYTE=5120,t.UNSIGNED_BYTE=5121,t.SHORT=5122,t.UNSIGNED_SHORT=5123,t.INT=5124,t.UNSIGNED_INT=5125,t.FLOAT=5126,t.DEPTH_COMPONENT=6402,t.ALPHA=6406,t.RGB=6407,t.RGBA=6408,t.LUMINANCE=6409,t.LUMINANCE_ALPHA=6410,t.UNSIGNED_SHORT_4_4_4_4=32819,t.UNSIGNED_SHORT_5_5_5_1=32820,t.UNSIGNED_SHORT_5_6_5=33635,t.FRAGMENT_SHADER=35632,t.VERTEX_SHADER=35633,t.MAX_VERTEX_ATTRIBS=34921,t.MAX_VERTEX_UNIFORM_VECTORS=36347,t.MAX_VARYING_VECTORS=36348,t.MAX_COMBINED_TEXTURE_IMAGE_UNITS=35661,t.MAX_VERTEX_TEXTURE_IMAGE_UNITS=35660,t.MAX_TEXTURE_IMAGE_UNITS=34930,t.MAX_FRAGMENT_UNIFORM_VECTORS=36349,t.SHADER_TYPE=35663,t.DELETE_STATUS=35712,t.LINK_STATUS=35714,t.VALIDATE_STATUS=35715,t.ATTACHED_SHADERS=35717,t.ACTIVE_UNIFORMS=35718,t.ACTIVE_ATTRIBUTES=35721,t.SHADING_LANGUAGE_VERSION=35724,t.CURRENT_PROGRAM=35725,t.NEVER=512,t.LESS=513,t.EQUAL=514,t.LEQUAL=515,t.GREATER=516,t.NOTEQUAL=517,t.GEQUAL=518,t.ALWAYS=519,t.KEEP=7680,t.REPLACE=7681,t.INCR=7682,t.DECR=7683,t.INVERT=5386,t.INCR_WRAP=34055,t.DECR_WRAP=34056,t.VENDOR=7936,t.RENDERER=7937,t.VERSION=7938,t.NEAREST=9728,t.LINEAR=9729,t.NEAREST_MIPMAP_NEAREST=9984,t.LINEAR_MIPMAP_NEAREST=9985,t.NEAREST_MIPMAP_LINEAR=9986,t.LINEAR_MIPMAP_LINEAR=9987,t.TEXTURE_MAG_FILTER=10240,t.TEXTURE_MIN_FILTER=10241,t.TEXTURE_WRAP_S=10242,t.TEXTURE_WRAP_T=10243,t.TEXTURE_2D=3553,t.TEXTURE=5890,t.TEXTURE_CUBE_MAP=34067,t.TEXTURE_BINDING_CUBE_MAP=34068,t.TEXTURE_CUBE_MAP_POSITIVE_X=34069,t.TEXTURE_CUBE_MAP_NEGATIVE_X=34070,t.TEXTURE_CUBE_MAP_POSITIVE_Y=34071,t.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072,t.TEXTURE_CUBE_MAP_POSITIVE_Z=34073,t.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074,t.MAX_CUBE_MAP_TEXTURE_SIZE=34076,t.TEXTURE0=33984,t.TEXTURE1=33985,t.TEXTURE2=33986,t.TEXTURE3=33987,t.TEXTURE4=33988,t.TEXTURE5=33989,t.TEXTURE6=33990,t.TEXTURE7=33991,t.TEXTURE8=33992,t.TEXTURE9=33993,t.TEXTURE10=33994,t.TEXTURE11=33995,t.TEXTURE12=33996,t.TEXTURE13=33997,t.TEXTURE14=33998,t.TEXTURE15=33999,t.TEXTURE16=34e3,t.TEXTURE17=34001,t.TEXTURE18=34002,t.TEXTURE19=34003,t.TEXTURE20=34004,t.TEXTURE21=34005,t.TEXTURE22=34006,t.TEXTURE23=34007,t.TEXTURE24=34008,t.TEXTURE25=34009,t.TEXTURE26=34010,t.TEXTURE27=34011,t.TEXTURE28=34012,t.TEXTURE29=34013,t.TEXTURE30=34014,t.TEXTURE31=34015,t.ACTIVE_TEXTURE=34016,t.REPEAT=10497,t.CLAMP_TO_EDGE=33071,t.MIRRORED_REPEAT=33648,t.FLOAT_VEC2=35664,t.FLOAT_VEC3=35665,t.FLOAT_VEC4=35666,t.INT_VEC2=35667,t.INT_VEC3=35668,t.INT_VEC4=35669,t.BOOL=35670,t.BOOL_VEC2=35671,t.BOOL_VEC3=35672,t.BOOL_VEC4=35673,t.FLOAT_MAT2=35674,t.FLOAT_MAT3=35675,t.FLOAT_MAT4=35676,t.SAMPLER_2D=35678,t.SAMPLER_CUBE=35680,t.VERTEX_ATTRIB_ARRAY_ENABLED=34338,t.VERTEX_ATTRIB_ARRAY_SIZE=34339,t.VERTEX_ATTRIB_ARRAY_STRIDE=34340,t.VERTEX_ATTRIB_ARRAY_TYPE=34341,t.VERTEX_ATTRIB_ARRAY_NORMALIZED=34922,t.VERTEX_ATTRIB_ARRAY_POINTER=34373,t.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING=34975,t.COMPILE_STATUS=35713,t.LOW_FLOAT=36336,t.MEDIUM_FLOAT=36337,t.HIGH_FLOAT=36338,t.LOW_INT=36339,t.MEDIUM_INT=36340,t.HIGH_INT=36341,t.FRAMEBUFFER=36160,t.RENDERBUFFER=36161,t.RGBA4=32854,t.RGB5_A1=32855,t.RGB565=36194,t.DEPTH_COMPONENT16=33189,t.STENCIL_INDEX=6401,t.STENCIL_INDEX8=36168,t.DEPTH_STENCIL=34041,t.RENDERBUFFER_WIDTH=36162,t.RENDERBUFFER_HEIGHT=36163,t.RENDERBUFFER_INTERNAL_FORMAT=36164,t.RENDERBUFFER_RED_SIZE=36176,t.RENDERBUFFER_GREEN_SIZE=36177,t.RENDERBUFFER_BLUE_SIZE=36178,t.RENDERBUFFER_ALPHA_SIZE=36179,t.RENDERBUFFER_DEPTH_SIZE=36180,t.RENDERBUFFER_STENCIL_SIZE=36181,t.FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE=36048,t.FRAMEBUFFER_ATTACHMENT_OBJECT_NAME=36049,t.FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL=36050,t.FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE=36051,t.COLOR_ATTACHMENT0=36064,t.DEPTH_ATTACHMENT=36096,t.STENCIL_ATTACHMENT=36128,t.DEPTH_STENCIL_ATTACHMENT=33306,t.NONE=0,t.FRAMEBUFFER_COMPLETE=36053,t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT=36054,t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT=36055,t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS=36057,t.FRAMEBUFFER_UNSUPPORTED=36061,t.FRAMEBUFFER_BINDING=36006,t.RENDERBUFFER_BINDING=36007,t.MAX_RENDERBUFFER_SIZE=34024,t.INVALID_FRAMEBUFFER_OPERATION=1286,t.UNPACK_FLIP_Y_WEBGL=37440,t.UNPACK_PREMULTIPLY_ALPHA_WEBGL=37441,t.CONTEXT_LOST_WEBGL=37442,t.UNPACK_COLORSPACE_CONVERSION_WEBGL=37443,t.BROWSER_DEFAULT_WEBGL=37444,t._useProgram=null,t._depthTest=!0,t._depthMask=!0,t._blend=!1,t._cullFace=!1,t.curBindTexTarget=null,t.curBindTexValue=null,n(t,["_depthFunc",function(){return this._depthFunc=513},"_sFactor",function(){return this._sFactor=1},"_dFactor",function(){return this._dFactor=0},"_frontFace",function(){return this._frontFace=2305}]),t}(),Tt=function(t){function e(){e.__super.call(this)}r(e,"laya.webgl.display.GraphicsGL",t);var i=e.prototype;return i.setShader=function(t){this._saveToCmd(D.context._setShader,[t])},i.setIBVB=function(t,e,i,n,r,a){this._saveToCmd(D.context._setIBVB,[t,e,i,n,r,a])},i.drawParticle=function(t,e,i){var n=I.createParticleTemplate2D(i);n.x=t,n.y=e,this._saveToCmd(D.context._drawParticle,[n])},e}(p),St=function(t){function e(t){this._x=0,this._y=0,this._id=++e._COUNT,this._path=null,this._drawCount=1,this._maxNumEle=0,this._clear=!1,this._isMain=!1,this._atlasResourceChange=0,this._submits=null,this._curSubmit=null,this._ib=null,this._vb=null,this._nBlendType=0,this._saveMark=null,this._shader2D=null,this.mId=-1,this.mHaveKey=!1,this.mHaveLineKey=!1,this.mX=0,this.mY=0,e.__super.call(this),this._width=99999999,this._height=99999999,this._clipRect=e.MAXCLIPRECT,this.mOutPoint,this._canvas=t,e._contextcount++,D.isFlash?(this._ib=qt.create(35044),pt.fillIBQuadrangle(this._ib,16)):this._ib=qt.QuadrangleIB,this.clear()}var s;r(e,"laya.webgl.canvas.WebGLContext2D",t);var o=e.prototype;return o.setIsMainContext=function(){this._isMain=!0},o.clearBG=function(t,e,i,n){var r=Et.mainContext;r.clearColor(t,e,i,n),r.clear(16384)},o._getSubmits=function(){return this._submits},o._releaseMem=function(){if(this._submits){this._curMat.destroy(),this._curMat=null,this._shader2D.destroy(),this._shader2D=null;for(var t=0,e=this._submits._length;t<e;t++)this._submits[t].releaseRender();this._submits.length=0,this._submits._length=0,this._submits=null,this._curSubmit=null,this._path&&this._path.recover(),this._path=null,this._other&&(this._other.font=null),this._save=null,this._vb&&(this._vb.releaseResource(),this._vb.destroy(),this._vb.destory(),this._vb=null)}},o.destroy=function(){--e._contextcount,this.sprite=null,this._releaseMem(),this._targets&&this._targets.destroy(),this._targets=null,this._canvas=null,this._ib&&this._ib!=qt.QuadrangleIB&&this._ib.releaseResource()},o.clear=function(){this._submits||(this._other=s.DEFAULT,this._curMat=x.create(),this._vb=Qt.create(-1),this._submits=[],this._save=[K.Create(this)],this._save.length=10,this._shader2D=new $),this._vb.clear(),this._targets&&(this._targets.repaint=!0),this._other=s.DEFAULT,this._clear=!0,this._repaint=!1,this._drawCount=1,this._renderKey=0,this._other.lineWidth=this._shader2D.ALPHA=1,this._nBlendType=0,this._clipRect=e.MAXCLIPRECT,this._curSubmit=at.RENDERBASE,this._shader2D.glTexture=null,this._shader2D.fillStyle=this._shader2D.strokeStyle=k.DEFAULT;for(var t=0,i=this._submits._length;t<i;t++)this._submits[t].releaseRender();this._submits._length=0,this._curMat.identity(),this._other.clear(),this._saveMark=this._save[0],this._save._length=1},o.size=function(t,e){if(this._width!=t||this._height!=e)if(0==t||0==e){0!=this._vb._byteLength&&(this._width=t,this._height=e,this._vb.clear(),this._vb.upload());for(var i=0,n=this._submits._length;i<n;i++)this._submits[i].releaseRender();this._submits.length=0,this._submits._length=0,this._curSubmit=null,this._path&&this._path.recover(),this._path=null,this.sprite=null,this._targets&&this._targets.destroy(),this._targets=null}else this._width=t,this._height=e,this._targets&&this._targets.size(t,e),this._canvas.memorySize-=this._canvas.memorySize;0===t&&0===e&&this._releaseMem()},o._getTransformMatrix=function(){return this._curMat},o.translate=function(t,e){0===t&&0===e||(q.save(this),this._curMat.bTransform&&(j.save(this),this._curMat.transformPointN(T.TEMP.setTo(t,e)),t=T.TEMP.x,e=T.TEMP.y),this._x+=t,this._y+=e)},o.save=function(){this._save[this._save._length++]=K.Create(this)},o.restore=function(){var t=this._save._length;if(!(t<1))for(var e=t-1;e>=0;e--){var i=this._save[e];if(i.restore(this),i.isSaveMark())return void(this._save._length=e)}},o._fillText=function(t,e,i,n,r,a,s,o,l,h){void 0===h&&(h=0);var u=this._shader2D,_=this._curSubmit.shaderValue,d=r?ft.create(r):this._other.font;if(H.enabled)u.ALPHA!==_.ALPHA&&(u.glTexture=null),dt.drawText(this,t,e,this._curMat,d,l||this._other.textAlign,a,s,o,i,n,h);else{var f=(this._shader2D.defines.getValue(),a?c.create(a)._color:u.colorAdd);u.ALPHA===_.ALPHA&&f===u.colorAdd&&_.colorAdd===u.colorAdd||(u.glTexture=null,u.colorAdd=f),dt.drawText(this,t,e,this._curMat,d,l||this._other.textAlign,a,s,o,i,n,h)}},o.fillWords=function(t,e,i,n,r,a){this._fillText(null,t,e,i,n,r,null,-1,null,a)},o.fillBorderWords=function(t,e,i,n,r,a,s){this._fillBorderText(null,t,e,i,n,r,a,s,null)},o.fillText=function(t,e,i,n,r,a){this._fillText(t,null,e,i,n,r,null,-1,a)},o.strokeText=function(t,e,i,n,r,a,s){this._fillText(t,null,e,i,n,null,r,a||1,s)},o.fillBorderText=function(t,e,i,n,r,a,s,o){this._fillBorderText(t,null,e,i,n,r,a,s,o)},o._fillBorderText=function(t,i,n,r,a,s,o,l,h){if(!H.enabled)return this._fillText(t,i,n,r,a,null,o,l||1,h),void this._fillText(t,i,n,r,a,s,null,-1,h);var u=this._shader2D,_=this._curSubmit.shaderValue;u.ALPHA!==_.ALPHA&&(u.glTexture=null);var c=a?(e._fontTemp.setFont(a),e._fontTemp):this._other.font;dt.drawText(this,t,i,this._curMat,c,h||this._other.textAlign,s,o,l||1,n,r,0)},o.fillRect=function(t,e,i,n,r){var a=this._vb;if(pt.fillRectImgVb(a,this._clipRect,t,e,i,n,L.DEF_UV,this._curMat,this._x,this._y,0,0)){this._renderKey=0;var s=this._shader2D.fillStyle;r&&(this._shader2D.fillStyle=k.create(r));var o=this._shader2D,l=this._curSubmit.shaderValue;if(o.fillStyle!==l.fillStyle||o.ALPHA!==l.ALPHA){o.glTexture=null;var h=this._curSubmit=at.createSubmit(this,this._ib,a,(a._byteLength-64)/32*3,Dt.create(2,0));h.shaderValue.color=o.fillStyle._color._color,h.shaderValue.ALPHA=o.ALPHA,this._submits[this._submits._length++]=h}this._curSubmit._numEle+=6,this._shader2D.fillStyle=s}},o.fillTexture=function(t,e,n,r,a,s,o,l){if(!(t.loaded&&t.bitmap&&t.source))return void(this.sprite&&i.timer.callLater(this,this._repaintSprite));var h=this._vb,u=t.bitmap.width,_=t.bitmap.height,c=t.uv,d=o.x%t.width,f=o.y%t.height;if(u!=l.w||_!=l.h){if(!l.w&&!l.h)switch(l.oy=l.ox=0,s){case"repeat":l.width=r,l.height=a;break;case"repeat-x":l.width=r,f<0?t.height+f>a?l.height=a:l.height=t.height+f:(l.oy=f,t.height+f>a?l.height=a-f:l.height=t.height);break;case"repeat-y":d<0?t.width+d>r?l.width=r:l.width=t.width+d:(l.ox=d,t.width+d>r?l.width=r-d:l.width=t.width),l.height=a;break;default:l.width=r,l.height=a}l.w=u,l.h=_,l.uv=[0,0,l.width/u,0,l.width/u,l.height/_,0,l.height/_]}if(e+=l.ox,n+=l.oy,d-=l.ox,f-=l.oy,pt.fillRectImgVb(h,this._clipRect,e,n,l.width,l.height,l.uv,this._curMat,this._x,this._y,0,0)){this._renderKey=0;var m=Nt.create(this,this._ib,h,(h._byteLength-64)/32*3,Dt.create(256,0));this._submits[this._submits._length++]=m;var p=m.shaderValue;p.textureHost=t;var v=c[0]*u,g=c[1]*_,E=(c[2]-c[0])*u,x=(c[5]-c[3])*_,T=-d/u,S=-f/_;p.u_TexRange[0]=v/u,p.u_TexRange[1]=E/u,p.u_TexRange[2]=g/_,p.u_TexRange[3]=x/_,p.u_offset[0]=T,p.u_offset[1]=S,H.enabled&&!this._isMain&&m.addTexture(t,(h._byteLength>>2)-16),this._curSubmit=m,m._renderType=10017,m._numEle+=6}},o.setShader=function(t){X.save(this,1048576,this._shader2D,!0),this._shader2D.shader=t},o.setFilters=function(t){X.save(this,2097152,this._shader2D,!0),this._shader2D.filters=t,this._curSubmit=at.RENDERBASE,this._renderKey=0,this._drawCount++},o.drawTexture=function(t,e,i,n,r,a,s){this._drawTextureM(t,e,i,n,r,a,s,null,1)},o.addTextureVb=function(t,e,i){var n=this._curSubmit._vb||this._vb,r=n._byteLength>>2;n.byteLength=r+16<<2;for(var a=n.getFloat32Array(),s=0;s<16;s+=4)a[r++]=t[s]+e,a[r++]=t[s+1]+i,a[r++]=t[s+2],a[r++]=t[s+3];this._curSubmit._numEle+=6,this._maxNumEle=Math.max(this._maxNumEle,this._curSubmit._numEle),n._upload=!0},o.willDrawTexture=function(t,e){if(!(t.loaded&&t.bitmap&&t.source))return this.sprite&&i.timer.callLater(this,this._repaintSprite),0;var n=t.bitmap,r=n.id+this._shader2D.ALPHA*e+10016;if(r==this._renderKey)return r;var a=this._shader2D,s=a.ALPHA,o=this._curSubmit.shaderValue;a.ALPHA*=e,this._renderKey=r,this._drawCount++,a.glTexture=n;var l=this._vb,h=null,u=l._byteLength/32*3;return h=Nt.create(this,this._ib,l,u,Dt.create(1,0)),this._submits[this._submits._length++]=h,h.shaderValue.textureHost=t,h._renderType=10016,h._preIsSameTextureShader=10016===this._curSubmit._renderType&&a.ALPHA===o.ALPHA,this._curSubmit=h,a.ALPHA=s,r},o.drawTextures=function(t,n,r,a){if(!(t.loaded&&t.bitmap&&t.source))return void(this.sprite&&i.timer.callLater(this,this._repaintSprite));var s=this._clipRect;if(this._clipRect=e.MAXCLIPRECT,!this._drawTextureM(t,n[0],n[1],t.width,t.height,r,a,null,1))return void alert("drawTextures err");if(this._clipRect=s,b.drawCall++,!(n.length<4)){for(var o=this._curSubmit._vb||this._vb,l=this._curMat.a,h=this._curMat.d,u=2,_=n.length;u<_;u+=2)pt.copyPreImgVb(o,(n[u]-n[u-2])*l,(n[u+1]-n[u-1])*h),this._curSubmit._numEle+=6;this._maxNumEle=Math.max(this._maxNumEle,this._curSubmit._numEle)}},o._drawTextureM=function(t,e,n,r,a,s,o,l,h){if(!t.loaded||!t.source)return this.sprite&&i.timer.callLater(this,this._repaintSprite),!1;var u=this._curSubmit._vb||this._vb,_=t.bitmap;e+=s,n+=o,this._drawCount++;var c=_.id+this._shader2D.ALPHA*h+10016;if(c!=this._renderKey){this._renderKey=c;var d=this._curSubmit.shaderValue,f=this._shader2D,m=f.ALPHA;f.ALPHA*=h,f.glTexture=_;var p=this._vb,v=null,g=p._byteLength/32*3;v=Nt.create(this,this._ib,p,g,Dt.create(1,0)),this._submits[this._submits._length++]=v,v.shaderValue.textureHost=t,v._renderType=10016,v._preIsSameTextureShader=10016===this._curSubmit._renderType&&f.ALPHA===d.ALPHA,this._curSubmit=v,u=this._curSubmit._vb||this._vb,f.ALPHA=m}return!!pt.fillRectImgVb(u,this._clipRect,e,n,r||t.width,a||t.height,t.uv,l||this._curMat,this._x,this._y,0,0)&&(H.enabled&&!this._isMain&&this._curSubmit.addTexture(t,(u._byteLength>>2)-16),this._curSubmit._numEle+=6,this._maxNumEle=Math.max(this._maxNumEle,this._curSubmit._numEle),!0)},o._repaintSprite=function(){this.sprite&&this.sprite.repaint()},o._drawText=function(t,e,i,n,r,a,s,o,l,h){var u=t.bitmap;this._drawCount++;var _=u.id+this._shader2D.ALPHA+10016;if(_!=this._renderKey){this._renderKey=_;var c=this._curSubmit.shaderValue,d=this._shader2D;d.glTexture=u;var f=this._vb,m=null,p=f._byteLength/32*3;m=H.enabled?Nt.create(this,this._ib,f,p,Dt.create(1,0)):Nt.create(this,this._ib,f,p,Kt.create()),m._preIsSameTextureShader=10016===this._curSubmit._renderType&&d.ALPHA===c.ALPHA,this._submits[this._submits._length++]=m,m.shaderValue.textureHost=t,m._renderType=10016,this._curSubmit=m}t.active();var v=this._curSubmit._vb||this._vb;pt.fillRectImgVb(v,this._clipRect,e+s,i+o,n||t.width,r||t.height,t.uv,a||this._curMat,this._x,this._y,l,h,!0)&&(H.enabled&&!this._isMain&&this._curSubmit.addTexture(t,(v._byteLength>>2)-16),this._curSubmit._numEle+=6,this._maxNumEle=Math.max(this._maxNumEle,this._curSubmit._numEle))},o.drawTextureWithTransform=function(t,i,n,r,a,s,o,l,h){if(!s)return void this._drawTextureM(t,i,n,r,a,o,l,null,h);var u=this._curMat,_=this._x,c=this._y;(0!==o||0!==l)&&(this._x=o*u.a+l*u.c,this._y=l*u.d+o*u.b),s&&u.bTransform?(x.mul(s,u,e._tmpMatrix),s=e._tmpMatrix,s._checkTransform()):(this._x+=u.tx,this._y+=u.ty),this._drawTextureM(t,i,n,r,a,0,0,s,h),this._x=_,this._y=c},o.fillQuadrangle=function(t,e,i,n,r){var a=this._curSubmit,s=this._vb,o=this._shader2D,l=a.shaderValue;if(this._renderKey=0,t.bitmap){var h=t.bitmap;o.glTexture==h&&o.ALPHA===l.ALPHA||(o.glTexture=h,a=this._curSubmit=at.createSubmit(this,this._ib,s,s._byteLength/32*3,Dt.create(1,0)),a.shaderValue.glTexture=h,this._submits[this._submits._length++]=a),pt.fillQuadrangleImgVb(s,e,i,n,t.uv,r||this._curMat,this._x,this._y)}else a.shaderValue.fillStyle&&a.shaderValue.fillStyle.equal(t)&&o.ALPHA===l.ALPHA||(o.glTexture=null,a=this._curSubmit=at.createSubmit(this,this._ib,s,s._byteLength/32*3,Dt.create(2,0)),a.shaderValue.defines.add(2),a.shaderValue.fillStyle=k.create(t),this._submits[this._submits._length++]=a),pt.fillQuadrangleImgVb(s,e,i,n,L.DEF_UV,r||this._curMat,this._x,this._y);a._numEle+=6},o.drawTexture2=function(t,i,n,r,a,s,o,l){if(0!=s){var h=this._curMat;if(this._x=t*h.a+i*h.c,this._y=i*h.d+t*h.b,a&&(h.bTransform||a.bTransform?(x.mul(a,h,e._tmpMatrix),a=e._tmpMatrix):(this._x+=a.tx+h.tx,this._y+=a.ty+h.ty,a=x.EMPTY)),1!==s||o){var u=this._shader2D.ALPHA,_=this._nBlendType;this._shader2D.ALPHA=s,o&&(this._nBlendType=z.TOINT(o)),this._drawTextureM(l[0],l[1]-n,l[2]-r,l[3],l[4],0,0,a,1),this._shader2D.ALPHA=u,this._nBlendType=_}else this._drawTextureM(l[0],l[1]-n,l[2]-r,l[3],l[4],0,0,a,1);this._x=this._y=0}},o.drawCanvas=function(t,e,i,n,r){var a=t.context;if(this._renderKey=0,a._targets)this._submits[this._submits._length++]=wt.create(a,0,null),this._curSubmit=at.RENDERBASE,a._targets.drawTo(this,e,i,n,r);else{var s=this._submits[this._submits._length++]=wt.create(a,this._shader2D.ALPHA,this._shader2D.filters),o=n/t.width,l=r/t.height,h=s._matrix;this._curMat.copyTo(h),1!=o&&1!=l&&h.scale(o,l);var u=h.tx,_=h.ty;h.tx=h.ty=0,h.transformPoint(T.TEMP.setTo(e,i)),h.translate(T.TEMP.x+u,T.TEMP.y+_),this._curSubmit=at.RENDERBASE}d.showCanvasMark&&(this.save(),this.lineWidth=4,this.strokeStyle=a._targets?"yellow":"green",this.strokeRect(e-1,i-1,n+2,r+2,1),this.strokeRect(e,i,n,r,1),this.restore())},o.drawTarget=function(t,e,i,n,r,a,s,o,l,h){void 0===h&&(h=-1);var u=this._vb;if(pt.fillRectImgVb(u,this._clipRect,e,i,n,r,l||L.DEF_UV,a||this._curMat,this._x,this._y,0,0)){this._renderKey=0;this._shader2D.glTexture=null;var _=(this._curSubmit.shaderValue,this._curSubmit=_t.create(this,this._ib,u,(u._byteLength-64)/32*3,o,s));_.blendType=-1==h?this._nBlendType:h,_.scope=t,this._submits[this._submits._length++]=_,this._curSubmit._numEle+=6}},o.transform=function(t,e,i,n,r,a){j.save(this),x.mul(x.TEMP.setTo(t,e,i,n,r,a),this._curMat,this._curMat),this._curMat._checkTransform()},o.setTransformByMatrix=function(t){t.copyTo(this._curMat)},o.transformByMatrix=function(t){j.save(this),x.mul(t,this._curMat,this._curMat),this._curMat._checkTransform()},o.rotate=function(t){j.save(this),this._curMat.rotateEx(t)},o.scale=function(t,e){j.save(this),this._curMat.scaleEx(t,e)},o.clipRect=function(t,e,i,n){if(0!=this._curMat.b||0!=this._curMat.c){this._renderKey=0;var r=ut.create(4);this.addRenderObject(r);var a=this._vb,s=a._byteLength>>2;if(pt.fillRectImgVb(a,null,t,e,i,n,L.DEF_UV,this._curMat,this._x,this._y,0,0)){this._shader2D.glTexture=null;var o=this._curSubmit=at.createSubmit(this,this._ib,a,(a._byteLength-64)/32*3,Dt.create(2,0));o.shaderValue.ALPHA=1,this._submits[this._submits._length++]=o,this._curSubmit._numEle+=6}else alert("clipRect calc stencil rect error");var l=ut.create(5);this.addRenderObject(l);var h=a.getFloat32Array(),u=Math.min(Math.min(Math.min(h[s+0],h[s+4]),h[s+8]),h[s+12]),_=Math.max(Math.max(Math.max(h[s+0],h[s+4]),h[s+8]),h[s+12]),c=Math.min(Math.min(Math.min(h[s+1],h[s+5]),h[s+9]),h[s+13]),d=Math.max(Math.max(Math.max(h[s+1],h[s+5]),h[s+9]),h[s+13]);Z.save(this,l,t,e,i,n,u,c,_-u,d-c),this._curSubmit=at.RENDERBASE}else{i*=this._curMat.a,n*=this._curMat.d;var f=T.TEMP;this._curMat.transformPoint(f.setTo(t,e)),i<0&&(f.x=f.x+i,i=-i),n<0&&(f.y=f.y+n,n=-n),this._renderKey=0;var m=this._curSubmit=ht.create(this);this._submits[this._submits._length++]=m,m.submitIndex=this._submits._length,m.submitLength=9999999,Y.save(this,m);var p=this._clipRect,v=p.x,g=p.y,E=f.x+i,x=f.y+n;v<f.x&&(p.x=f.x),g<f.y&&(p.y=f.y),p.width=Math.min(E,v+p.width)-p.x,p.height=Math.min(x,g+p.height)-p.y,this._shader2D.glTexture=null,m.clipRect.copyFrom(p),this._curSubmit=at.RENDERBASE}},o.setIBVB=function(t,e,i,n,r,a,s,o,l,h,u){if(void 0===l&&(l=0),void 0===h&&(h=0),void 0===u&&(u=0),null===i){if(D.isFlash){var _=n;_._selfIB||(_._selfIB=qt.create(35044)),_._selfIB.clear(),i=_._selfIB}else i=this._ib;pt.expandIBQuadrangle(i,n._byteLength/(4*n.vertexStride*4))}if(!o||!s)throw Error("setIBVB must input:shader shaderValues");var c=lt.create(this,n,i,r,s,o,l,h,u);a||(a=x.EMPTY),a.translate(t,e),x.mul(a,this._curMat,c._mat),a.translate(-t,-e),this._submits[this._submits._length++]=c,this._curSubmit=at.RENDERBASE,this._renderKey=0},o.addRenderObject=function(t){this._submits[this._submits._length++]=t},o.fillTrangles=function(t,e,i,n,r){var a=this._curSubmit,s=this._vb,o=this._shader2D,l=a.shaderValue,h=n.length>>4,u=t.bitmap;this._renderKey=0,o.glTexture==u&&o.ALPHA===l.ALPHA||(a=this._curSubmit=at.createSubmit(this,this._ib,s,s._byteLength/32*3,Dt.create(1,0)),a.shaderValue.textureHost=t,this._submits[this._submits._length++]=a),pt.fillTranglesVB(s,e,i,n,r||this._curMat,this._x,this._y),a._numEle+=6*h},o.submitElement=function(t,e){var i=this._submits;for(e<0&&(e=i._length);t<e;)t+=i[t].renderSubmit()},o.finish=function(){Et.mainContext.finish()},o.flush=function(){var t=Math.max(this._vb._byteLength/64,this._maxNumEle/6)+8;if(t>this._ib.bufferLength/12&&pt.expandIBQuadrangle(this._ib,t),!this._isMain&&H.enabled&&H._atlasRestore>this._atlasResourceChange){this._atlasResourceChange=H._atlasRestore;for(var e=this._submits,i=0,n=e._length;i<n;i++){var r=e[i];10016===r.getRenderType()&&r.checkTexture()}}return this.submitElement(0,this._submits._length),this._path&&this._path.reset(),et.instance&&et.getInstance().reset(),this._curSubmit=at.RENDERBASE,this._renderKey=0,this._submits._length},o.setPathId=function(t){if(this.mId=t,-1!=this.mId){this.mHaveKey=!1;var e=V.getInstance();e.shapeDic[this.mId]&&(this.mHaveKey=!0),this.mHaveLineKey=!1,e.shapeLineDic[this.mId]&&(this.mHaveLineKey=!0)}},o.movePath=function(t,e){var i=t,n=e;t=this._curMat.a*i+this._curMat.c*n+this._curMat.tx,e=this._curMat.b*i+this._curMat.d*n+this._curMat.ty,this.mX+=t,this.mY+=e},o.beginPath=function(){var t=this._getPath();t.tempArray.length=0,t.closePath=!1,this.mX=0,this.mY=0},o.closePath=function(){this._path.closePath=!0},o.fill=function(t){void 0===t&&(t=!1);var e=this._getPath();this.drawPoly(0,0,e.tempArray,this.fillStyle._color.numColor,0,0,t)},o.stroke=function(){var t=this._getPath();if(this.lineWidth>0){if(-1==this.mId)t.drawLine(0,0,t.tempArray,this.lineWidth,this.strokeStyle._color.numColor);else if(this.mHaveLineKey){var e=V.getInstance().shapeLineDic[this.mId];e.rebuild(t.tempArray),t.setGeomtry(e)}else V.getInstance().addLine(this.mId,t.drawLine(0,0,t.tempArray,this.lineWidth,this.strokeStyle._color.numColor));t.update();var i=[this.mX,this.mY],n=at.createShape(this,t.ib,t.vb,t.count,t.offset,Dt.create(4,0));n.shaderValue.ALPHA=this._shader2D.ALPHA,n.shaderValue.u_pos=i,n.shaderValue.u_mmat2=vt.TEMPMAT4_ARRAY,this._submits[this._submits._length++]=n}},o.line=function(t,e,i,n,r,a){var s=this._curSubmit,o=this._vb;if(pt.fillLineVb(o,this._clipRect,t,e,i,n,r,a)){this._renderKey=0;var l=this._shader2D,h=s.shaderValue;l.strokeStyle===h.strokeStyle&&l.ALPHA===h.ALPHA||(l.glTexture=null,s=this._curSubmit=at.createSubmit(this,this._ib,o,(o._byteLength-64)/32*3,Dt.create(2,0)),s.shaderValue.strokeStyle=l.strokeStyle,s.shaderValue.mainID=2,s.shaderValue.ALPHA=l.ALPHA,this._submits[this._submits._length++]=s),s._numEle+=6}},o.moveTo=function(t,e,i){void 0===i&&(i=!0);var n=this._getPath();if(i){var r=t,a=e;t=this._curMat.a*r+this._curMat.c*a,e=this._curMat.b*r+this._curMat.d*a}n.addPoint(t,e)},o.lineTo=function(t,e,i){void 0===i&&(i=!0);var n=this._getPath();if(i){var r=t,a=e;t=this._curMat.a*r+this._curMat.c*a,e=this._curMat.b*r+this._curMat.d*a}n.addPoint(t,e)},o.drawCurves=function(t,e,i){this.setPathId(-1),this.beginPath(),this.strokeStyle=i[3],this.lineWidth=i[4];var n=i[2];t+=i[0],e+=i[1],this.movePath(t,e),this.moveTo(n[0],n[1]);for(var r=2,a=n.length;r<a;)this.quadraticCurveTo(n[r++],n[r++],n[r++],n[r++]);this.stroke()},o.arcTo=function(t,i,n,r,a){if(-1==this.mId||!this.mHaveKey){var s=0,o=0,l=0,h=this._getPath();this._curMat.copyTo(e._tmpMatrix),e._tmpMatrix.tx=e._tmpMatrix.ty=0,e._tempPoint.setTo(h.getEndPointX(),h.getEndPointY()),e._tmpMatrix.invertTransformPoint(e._tempPoint);var u=e._tempPoint.x-t,_=e._tempPoint.y-i,c=Math.sqrt(u*u+_*_);if(!(c<=1e-6)){var d=u/c,f=_/c,m=n-t,p=r-i,v=m*m+p*p,g=Math.sqrt(v);if(!(g<=1e-6)){var E=m/g,x=p/g,T=d+E,S=f+x,D=Math.sqrt(T*T+S*S);if(!(D<=1e-6)){var M=T/D,y=S/D,A=Math.acos(M*d+y*f),I=Math.PI/2-A;c=a/Math.tan(I);var R=c*d+t,C=c*f+i,b=Math.sqrt(c*c+a*a),w=t+M*b,N=i+y*b,P=d*x-f*E,L=0,O=0,V=0;if(P>=0){L=2*I;var F=L/e.SEGNUM;O=Math.sin(F),V=Math.cos(F)}else L=2*-I,F=L/e.SEGNUM,O=Math.sin(F),V=Math.cos(F);o=this._curMat.a*R+this._curMat.c*C,l=this._curMat.b*R+this._curMat.d*C,o==this._path.getEndPointX()&&l==this._path.getEndPointY()||h.addPoint(o,l);var B=R-w,U=C-N;for(s=0;s<e.SEGNUM;s++){var H=B*V+U*O,G=-B*O+U*V;o=H+w,l=G+N,t=this._curMat.a*o+this._curMat.c*l,i=this._curMat.b*o+this._curMat.d*l,o=t,l=i,o==this._path.getEndPointX()&&l==this._path.getEndPointY()||h.addPoint(o,l),B=H,U=G}}}}}},o.arc=function(t,e,i,n,r,a,s){if(void 0===a&&(a=!1),void 0===s&&(s=!0),-1!=this.mId){var o=V.getInstance().shapeDic[this.mId];if(o&&this.mHaveKey&&!o.needUpdate(this._curMat))return;t=0,e=0}var l=0,h=0,u=0,_=0,c=0,d=0,f=0,m=0,p=0,v=0;if(h=r-n,a)if(Math.abs(h)>=2*Math.PI)h=2*-Math.PI;else for(;h>0;)h-=2*Math.PI;else if(Math.abs(h)>=2*Math.PI)h=2*Math.PI;else for(;h<0;)h+=2*Math.PI;v=i<101?Math.max(10,h*i/5):i<201?Math.max(10,h*i/20):Math.max(10,h*i/40),u=h/v/2,_=Math.abs(4/3*(1-Math.cos(u))/Math.sin(u)),a&&(_=-_);var g=this._getPath(),E=NaN,x=NaN;for(p=0;p<=v;p++)l=n+h*(p/v),c=Math.cos(l),d=Math.sin(l),f=t+c*i,m=e+d*i,s&&(E=f,x=m,f=this._curMat.a*E+this._curMat.c*x,m=this._curMat.b*E+this._curMat.d*x),f==this._path.getEndPointX()&&m==this._path.getEndPointY()||g.addPoint(f,m);c=Math.cos(r),d=Math.sin(r),f=t+c*i,m=e+d*i,s&&(E=f,x=m,f=this._curMat.a*E+this._curMat.c*x,m=this._curMat.b*E+this._curMat.d*x),f==this._path.getEndPointX()&&m==this._path.getEndPointY()||g.addPoint(f,m)},o.quadraticCurveTo=function(t,e,i,n){var r=l.I,a=i,s=n;i=this._curMat.a*a+this._curMat.c*s,n=this._curMat.b*a+this._curMat.d*s,a=t,s=e,t=this._curMat.a*a+this._curMat.c*s,e=this._curMat.b*a+this._curMat.d*s;for(var o=r.getBezierPoints([this._path.getEndPointX(),this._path.getEndPointY(),t,e,i,n],30,2),h=0,u=o.length/2;h<u;h++)this.lineTo(o[2*h],o[2*h+1],!1);this.lineTo(i,n,!1)},o.rect=function(t,e,i,n){this._other=this._other.make(),this._other.path||(this._other.path=new W),this._other.path.rect(t,e,i,n)},o.strokeRect=function(t,e,i,n,r){var a=.5*r;this.line(t-a,e,t+i+a,e,r,this._curMat),this.line(t+i,e,t+i,e+n,r,this._curMat),this.line(t,e,t,e+n,r,this._curMat),this.line(t-a,e+n,t+i+a,e+n,r,this._curMat)},o.clip=function(){},o.drawPoly=function(t,e,i,n,r,a,s){void 0===s&&(s=!1),this._renderKey=0,this._shader2D.glTexture=null;var o=this._getPath();if(-1==this.mId)o.polygon(t,e,i,n,r||1,a);else if(this.mHaveKey){var l=V.getInstance().shapeDic[this.mId];l.setMatrix(this._curMat),l.rebuild(o.tempArray),o.setGeomtry(l)}else{var h=o.polygon(t,e,i,n,r||1,a);V.getInstance().addShape(this.mId,h),h.setMatrix(this._curMat)}o.update();var u,_=[this.mX,this.mY];if(u=at.createShape(this,o.ib,o.vb,o.count,o.offset,Dt.create(4,0)),u.shaderValue.ALPHA=this._shader2D.ALPHA,u.shaderValue.u_pos=_,u.shaderValue.u_mmat2=vt.EMPTYMAT4_ARRAY,this._submits[this._submits._length++]=u,r>0){if(this.mHaveLineKey){var c=V.getInstance().shapeLineDic[this.mId];c.rebuild(o.tempArray),o.setGeomtry(c)}else V.getInstance().addShape(this.mId,o.drawLine(t,e,i,r,a));o.update(),u=at.createShape(this,o.ib,o.vb,o.count,o.offset,Dt.create(4,0)),u.shaderValue.ALPHA=this._shader2D.ALPHA,u.shaderValue.u_mmat2=vt.EMPTYMAT4_ARRAY,this._submits[this._submits._length++]=u}},o.drawParticle=function(t,e,i){i.x=t,i.y=e,this._submits[this._submits._length++]=i},o._getPath=function(){return this._path||(this._path=new W)},a(0,o,"globalCompositeOperation",function(){return z.NAMES[this._nBlendType]},function(t){var e=z.TOINT[t];null==e||this._nBlendType===e||(X.save(this,65536,this,!0),this._curSubmit=at.RENDERBASE,this._renderKey=0,this._nBlendType=e)}),a(0,o,"strokeStyle",function(){return this._shader2D.strokeStyle},function(t){this._shader2D.strokeStyle.equal(t)||(X.save(this,512,this._shader2D,!1),this._shader2D.strokeStyle=k.create(t))}),a(0,o,"globalAlpha",function(){return this._shader2D.ALPHA},function(t){(t=Math.floor(1e3*t)/1e3)!=this._shader2D.ALPHA&&(X.save(this,1,this._shader2D,!0),this._shader2D.ALPHA=t)}),a(0,o,"asBitmap",null,function(t){if(t){if(this._targets||(this._targets=new Q),this._targets.repaint=!0,!this._width||!this._height)throw Error("asBitmap no size!");this._targets.setSP(this.sprite),this._targets.size(this._width,this._height)}else this._targets=null}),a(0,o,"fillStyle",function(){return this._shader2D.fillStyle},function(t){this._shader2D.fillStyle.equal(t)||(X.save(this,2,this._shader2D,!1),this._shader2D.fillStyle=k.create(t))}),a(0,o,"textAlign",function(){return this._other.textAlign},function(t){this._other.textAlign===t||(this._other=this._other.make(),X.save(this,32768,this._other,!1),this._other.textAlign=t)}),a(0,o,"lineWidth",function(){return this._other.lineWidth},function(t){this._other.lineWidth===t||(this._other=this._other.make(),X.save(this,256,this._other,!1),this._other.lineWidth=t)}),a(0,o,"textBaseline",function(){return this._other.textBaseline},function(t){this._other.textBaseline===t||(this._other=this._other.make(),X.save(this,16384,this._other,!1),this._other.textBaseline=t)}),a(0,o,"font",null,function(t){t!=this._other.font.toString()&&(this._other=this._other.make(),X.save(this,8,this._other,!1),this._other.font===ft.EMPTY?this._other.font=new ft(t):this._other.font.setFont(t))}),e.__init__=function(){s.DEFAULT=new s},e._SUBMITVBSIZE=32e3,e._MAXSIZE=99999999,e._RECTVBSIZE=16,e._COUNT=0,e.SEGNUM=32,e._contextcount=0,n(e,["_tempPoint",function(){return this._tempPoint=new T},"MAXCLIPRECT",function(){return this.MAXCLIPRECT=new S(0,0,99999999,99999999)},"_tmpMatrix",function(){return this._tmpMatrix=new x},"_fontTemp",function(){return this._fontTemp=new ft},"_drawStyleTemp",function(){return this._drawStyleTemp=new k(null)}]),e.__init$=function(){s=function(){function t(){this.lineWidth=1,this.path=null,this.textAlign=null,this.textBaseline=null,this.font=ft.EMPTY}r(t,"");var e=t.prototype;return e.clear=function(){this.lineWidth=1,this.path&&this.path.clear(),this.textAlign=this.textBaseline=null,this.font=ft.EMPTY},e.make=function(){return this===t.DEFAULT?new t:this},t.DEFAULT=null,t}()},e}(f),Dt=function(t){function e(t,i){this.size=[0,0],this.alpha=1,this.ALPHA=1,this.subID=0,this._cacheID=0,e.__super.call(this),this.defines=new It,this.position=e._POSITION,this.mainID=t,this.subID=i,this.textureHost=null,this.texture=null,this.fillStyle=null,this.color=null,this.strokeStyle=null,this.colorAdd=null,this.glTexture=null,this.u_mmat2=null,this._cacheID=t|i,this._inClassCache=e._cache[this._cacheID],t>0&&!this._inClassCache&&(this._inClassCache=e._cache[this._cacheID]=[],this._inClassCache._length=0),this.clear()}r(e,"laya.webgl.shader.d2.value.Value2D",t);var i=e.prototype;return i.setValue=function(t){},i.refresh=function(){var t=this.size;return t[0]=vt.width,t[1]=vt.height,this.alpha=this.ALPHA*vt.worldAlpha,this.mmat=vt.worldMatrix4,this},i._ShaderWithCompile=function(){return Yt.withCompile2D(0,this.mainID,this.defines.toNameDic(),this.mainID|this.defines._value,jt.create)},i._withWorldShaderDefines=function(){var t=vt.worldShaderDefines,e=Yt.sharders[this.mainID|this.defines._value|t.getValue()];if(!e){var i,n,r={};i=this.defines.toNameDic();for(n in i)r[n]="";i=t.toNameDic();for(n in i)r[n]="";e=Yt.withCompile2D(0,this.mainID,r,this.mainID|this.defines._value|t.getValue(),jt.create)}var a=vt.worldFilters;if(!a)return e;for(var s,o=a.length,l=0;l<o;l++)(s=a[l])&&s.action.setValue(this);return e},i.upload=function(){var t=vt;this.alpha=this.ALPHA*t.worldAlpha,vt.worldMatrix4!==vt.TEMPMAT4_ARRAY&&this.defines.add(128),Et.shaderHighPrecision&&this.defines.add(1024);var e,i=t.worldShaderDefines?this._withWorldShaderDefines():Yt.sharders[this.mainID|this.defines._value]||this._ShaderWithCompile();this.size[0]=t.width,this.size[1]=t.height,this.mmat=t.worldMatrix4,Pt.activeShader!==i?(i._shaderValueWidth!==t.width||i._shaderValueHeight!==t.height?(i._shaderValueWidth=t.width,i._shaderValueHeight=t.height):e=i._params2dQuick2||i._make2dQuick2(),i.upload(this,e)):(i._shaderValueWidth!==t.width||i._shaderValueHeight!==t.height?(i._shaderValueWidth=t.width,i._shaderValueHeight=t.height):e=i._params2dQuick1||i._make2dQuick1(),i.upload(this,e))},i.setFilters=function(t){if(this.filters=t,t)for(var e,i=t.length,n=0;n<i;n++)(e=t[n])&&(this.defines.add(e.type),e.action.setValue(this))},i.clear=function(){this.defines.setValue(this.subID)},i.release=function(){this._inClassCache[this._inClassCache._length++]=this,this.fillStyle=null,this.strokeStyle=null,this.clear()},e._initone=function(t,i){e._typeClass[t]=i,e._cache[t]=[],e._cache[t]._length=0},e.__init__=function(){e._POSITION=[2,5126,!1,4*mt.BYTES_PE,0],e._TEXCOORD=[2,5126,!1,4*mt.BYTES_PE,2*mt.BYTES_PE],e._initone(2,Ft),e._initone(4,Ht),e._initone(256,Bt),e._initone(512,Vt),e._initone(1,Ut),e._initone(65,Kt),e._initone(9,Ut)},e.create=function(t,i){var n=e._cache[t|i];return n._length?n[--n._length]:new e._typeClass[t|i](i)},e._POSITION=null,e._TEXCOORD=null,e._cache=[],e._typeClass=[],n(e,["TEMPMAT4_ARRAY",function(){return this.TEMPMAT4_ARRAY=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}]),e}(B),Mt=function(t){function e(t,i){e.__super.call(this,t,i)}r(e,"laya.webgl.utils.RenderSprite3D",t);var i=e.prototype;return i.onCreate=function(t){switch(t){case 8:return void(this._fun=this._blend);case 4:return void(this._fun=this._transform)}},i._mask=function(t,i,n,r){var a,s,o=this._next,l=t.mask;if(l){i.ctx.save();var h=i.ctx.globalCompositeOperation,u=new S;if(u.copyFrom(l.getBounds()),u.width=Math.round(u.width),u.height=Math.round(u.height),u.x=Math.round(u.x),u.y=Math.round(u.y),u.width>0&&u.height>0){var _=t._style._tf,c=ot.create();c.addValue("bounds",u),a=st.create([c,i],laya.webgl.utils.RenderSprite3D.tmpTarget),i.addRenderObject(a),l.render(i,-u.x,-u.y),a=st.create([c],laya.webgl.utils.RenderSprite3D.endTmpTarget),i.addRenderObject(a),i.ctx.save(),i.clipRect(n-_.translateX+u.x,r-_.translateY+u.y,u.width,u.height),o._fun.call(o,t,i,n,r),i.ctx.restore(),s=ut.create(6),h=i.ctx.globalCompositeOperation,s.blendMode="mask",i.addRenderObject(s),x.TEMP.identity();var d=Dt.create(1,0),f=L.INV_UV,m=u.width,p=u.height;(u.width<32||u.height<32)&&(f=e.tempUV,f[0]=0,f[1]=0,f[2]=u.width>=32?1:u.width/32,f[3]=0,f[4]=u.width>=32?1:u.width/32,f[5]=u.height>=32?1:u.height/32,f[6]=0,f[7]=u.height>=32?1:u.height/32,u.width=u.width>=32?u.width:32,u.height=u.height>=32?u.height:32,f[1]*=-1,f[3]*=-1,f[5]*=-1,f[7]*=-1,f[1]+=1,f[3]+=1,f[5]+=1,f[7]+=1),i.ctx.drawTarget(c,n+u.x-_.translateX,r+u.y-_.translateY,m,p,x.TEMP,"tmpTarget",d,f,6),a=st.create([c],laya.webgl.utils.RenderSprite3D.recycleTarget),i.addRenderObject(a),s=ut.create(6),s.blendMode=h,i.addRenderObject(s)}i.ctx.restore()}else o._fun.call(o,t,i,n,r)},i._blend=function(t,e,i,n){var r=t._style,a=this._next;r.blendMode?(e.ctx.save(),e.ctx.globalCompositeOperation=r.blendMode,a._fun.call(a,t,e,i,n),e.ctx.restore()):a._fun.call(a,t,e,i,n)},i._transform=function(t,e,i,n){"use strict";var r=t.transform,a=this._next;if(r&&a!=M.NORENDER){var s=e.ctx;t._style;r.tx=i,r.ty=n;var o=s._getTransformMatrix(),l=o.clone();x.mul(r,o,o),o._checkTransform(),r.tx=r.ty=0,a._fun.call(a,t,e,0,0),l.copyTo(o),l.destroy()}else a._fun.call(a,t,e,i,n)},e.tmpTarget=function(t,e){var i=t.getValue("bounds"),n=Lt.create(i.width,i.height);n.start(),n.clear(0,0,0,0),t.addValue("tmpTarget",n)},e.endTmpTarget=function(t){t.getValue("tmpTarget").end()},e.recycleTarget=function(t){t.getValue("tmpTarget").recycle(),t.recycle()},n(e,["tempUV",function(){return this.tempUV=new Array(8)}]),e}(M),yt=function(t){function e(){this.data=null,e.__super.call(this)}r(e,"laya.filters.webgl.ColorFilterActionGL",t);var n=e.prototype;return i.imps(n,{"laya.filters.IFilterActionGL":!0}),n.setValue=function(t){t.colorMat=this.data._mat,t.colorAlpha=this.data._alpha},n.apply3d=function(t,e,i,n,r){var a=t.getValue("bounds"),s=Dt.create(1,0);s.setFilters([this.data]);var o=x.TEMP;o.identity(),i.ctx.drawTarget(t,0,0,a.width,a.height,o,"src",s)},e}(F),At=function(t){function e(t,i,n,r,a){this._atlasCanvas=null,this._inAtlasTextureKey=null,this._inAtlasTextureBitmapValue=null,this._inAtlasTextureOriUVValue=null,this._InAtlasWebGLImagesKey=null,this._InAtlasWebGLImagesOffsetValue=null,e.__super.call(this,t,i,a),this._inAtlasTextureKey=[],this._inAtlasTextureBitmapValue=[],this._inAtlasTextureOriUVValue=[],this._InAtlasWebGLImagesKey={},this._InAtlasWebGLImagesOffsetValue=[],this._atlasCanvas=new Gt,this._atlasCanvas._atlaser=this,this._atlasCanvas.width=n,this._atlasCanvas.height=r,this._atlasCanvas.activeResource(),this._atlasCanvas.lock=!0}r(e,"laya.webgl.atlas.Atlaser",t);var i=e.prototype;return i.computeUVinAtlasTexture=function(t,e,i,n){var r=H.atlasTextureWidth,a=H.atlasTextureHeight,s=i/r,o=n/a,l=(i+t.bitmap.width)/r,h=(n+t.bitmap.height)/a,u=t.bitmap.width/r,_=t.bitmap.height/a;t.uv=[s+e[0]*u,o+e[1]*_,l-(1-e[2])*u,o+e[3]*_,l-(1-e[4])*u,h-(1-e[5])*_,s+e[6]*u,h-(1-e[7])*_]},i.findBitmapIsExist=function(t){if(t instanceof laya.webgl.resource.WebGLImage){var e=t,i=e.url,n=this._InAtlasWebGLImagesKey[i||e.id];if(n)return n.offsetInfoID}return-1},i.addToAtlasTexture=function(t,e,i){if(t instanceof laya.webgl.resource.WebGLImage){var n=t,r=n.url;this._InAtlasWebGLImagesKey[r||n.id]={bitmap:t,offsetInfoID:this._InAtlasWebGLImagesOffsetValue.length},this._InAtlasWebGLImagesOffsetValue.push([e,i])}this._atlasCanvas.texSubImage2D(e,i,t.atlasSource),t.clearAtlasSource()},i.addToAtlas=function(t,e,i){t._atlasID=this._inAtlasTextureKey.length;var n=t.uv.slice(),r=t.bitmap;this._inAtlasTextureKey.push(t),this._inAtlasTextureOriUVValue.push(n),this._inAtlasTextureBitmapValue.push(r),this.computeUVinAtlasTexture(t,n,e,i),t.bitmap=this._atlasCanvas},i.clear=function(){for(var t=0,e=this._inAtlasTextureKey.length;t<e;t++)this._inAtlasTextureKey[t].bitmap=this._inAtlasTextureBitmapValue[t],this._inAtlasTextureKey[t].uv=this._inAtlasTextureOriUVValue[t],this._inAtlasTextureKey[t]._atlasID=-1,this._inAtlasTextureKey[t].bitmap.lock=!1,this._inAtlasTextureKey[t].bitmap.releaseResource();this._inAtlasTextureKey.length=0,this._inAtlasTextureBitmapValue.length=0,this._inAtlasTextureOriUVValue.length=0,this._InAtlasWebGLImagesKey=null,this._InAtlasWebGLImagesOffsetValue.length=0},i.dispose=function(){this.clear(),this._atlasCanvas.destroy()},a(0,i,"InAtlasWebGLImagesOffsetValue",function(){return this._InAtlasWebGLImagesOffsetValue}),a(0,i,"texture",function(){return this._atlasCanvas}),a(0,i,"inAtlasWebGLImagesKey",function(){return this._InAtlasWebGLImagesKey}),e}(U),It=function(t){function e(){e.__super.call(this,e.__name2int,e.__int2name,e.__int2nameMap)}return r(e,"laya.webgl.shader.d2.ShaderDefines2D",t),e.__init__=function(){e.reg("TEXTURE2D",1),e.reg("COLOR2D",2),e.reg("PRIMITIVE",4),e.reg("GLOW_FILTER",8),e.reg("BLUR_FILTER",16),e.reg("COLOR_FILTER",32),e.reg("COLOR_ADD",64),e.reg("WORLDMAT",128),e.reg("FILLTEXTURE",256),e.reg("FSHIGHPRECISION",1024)},e.reg=function(t,i){J._reg(t,i,e.__name2int,e.__int2name)},e.toText=function(t,e,i){return J._toText(t,e,i)},e.toInt=function(t){return J._toInt(t,e.__name2int)},e.TEXTURE2D=1,e.COLOR2D=2,e.PRIMITIVE=4,e.FILTERGLOW=8,e.FILTERBLUR=16,e.FILTERCOLOR=32,e.COLORADD=64,e.WORLDMAT=128,e.FILLTEXTURE=256,e.SKINMESH=512,e.SHADERDEFINE_FSHIGHPRECISION=1024,e.__name2int={},e.__int2name=[],e.__int2nameMap=[],e}(J),Rt=(function(t){function e(t,i,n,r,a,s,o){e.__super.call(this,t,i,n,r,40,a,s,o)}r(e,"laya.webgl.shapes.Ellipse",t)}(it),function(t){function e(t,i,n,r,a){this._points=[],this.rebuild(n),e.__super.call(this,t,i,0,0,0,a,r,a,0)}r(e,"laya.webgl.shapes.Line",t);var i=e.prototype;return i.rebuild=function(t){var e=t.length;e!=this._points.length&&(this.mUint16Array=new Uint16Array(6*(e/2-1)),this.mFloat32Array=new Float32Array(5*e)),this._points.length=0;for(var i=NaN,n=NaN,r=-1,a=-1,s=t.length/2,o=0;o<s;o++)i=t[2*o],n=t[2*o+1],(Math.abs(r-i)>.01||Math.abs(a-n)>.01)&&this._points.push(i,n),r=i,a=n},i.getData=function(t,e,i){var n=[],r=[];this.borderWidth>0&&this.createLine2(this._points,n,this.borderWidth,i,r,this._points.length/2),this.mUint16Array.set(n,0),this.mFloat32Array.set(r,0),t.append(this.mUint16Array),e.append(this.mFloat32Array)},e}(it)),Ct=function(t){function e(t,i,n,r,a){this._points=[];for(var s=NaN,o=NaN,l=-1,h=-1,u=n.length/2-1,_=0;_<u;_++)s=n[2*_],o=n[2*_+1],(Math.abs(l-s)>.01||Math.abs(h-o)>.01)&&this._points.push(s,o),l=s,h=o;s=n[2*u],o=n[2*u+1],l=this._points[0],h=this._points[1],(Math.abs(l-s)>.01||Math.abs(h-o)>.01)&&this._points.push(s,o),e.__super.call(this,t,i,0,0,this._points.length/2,0,r,a)}r(e,"laya.webgl.shapes.LoopLine",t);var i=e.prototype;return i.getData=function(t,e,i){if(this.borderWidth>0){for(var n=this.color,r=(n>>16&255)/255,a=(n>>8&255)/255,s=(255&n)/255,o=[],l=0,h=0,u=[],_=Math.floor(this._points.length/2),c=0;c<_;c++)l=this._points[2*c],h=this._points[2*c+1],o.push(this.x+l,this.y+h,r,a,s);this.createLoopLine(o,u,this.borderWidth,i+o.length/5),t.append(new Uint16Array(u)),e.append(new Float32Array(o))}},i.createLoopLine=function(t,e,i,n,r,a){var s=(t.length,t.concat()),o=r||t,l=this.borderColor,h=(l>>16&255)/255,u=(l>>8&255)/255,_=(255&l)/255,c=[s[0],s[1]],d=[s[s.length-5],s[s.length-4]],f=d[0]+.5*(c[0]-d[0]),m=d[1]+.5*(c[1]-d[1]);s.unshift(f,m,0,0,0),s.push(f,m,0,0,0);var p,v,g,E,x,T,S,D,M,y,A,I,R,C,b,w,N,P,L,O,V=s.length/5,F=n,B=i/2;g=s[0],E=s[1],x=s[5],T=s[6],M=-(E-T),y=g-x,O=Math.sqrt(M*M+y*y),M=M/O*B,y=y/O*B,o.push(g-M,E-y,h,u,_,g+M,E+y,h,u,_);for(var U=1;U<V-1;U++)g=s[5*(U-1)],E=s[5*(U-1)+1],x=s[5*U],T=s[5*U+1],S=s[5*(U+1)],D=s[5*(U+1)+1],M=-(E-T),y=g-x,O=Math.sqrt(M*M+y*y),M=M/O*B,y=y/O*B,A=-(T-D),I=x-S,O=Math.sqrt(A*A+I*I),A=A/O*B,I=I/O*B,R=-y+E-(-y+T),C=-M+x-(-M+g),b=(-M+g)*(-y+T)-(-M+x)*(-y+E),w=-I+D-(-I+T),N=-A+x-(-A+S),P=(-A+S)*(-I+T)-(-A+x)*(-I+D),L=R*N-w*C,Math.abs(L)<.1?(L+=10.1,o.push(x-M,T-y,h,u,_,x+M,T+y,h,u,_)):(p=(C*P-N*b)/L,v=(w*b-R*P)/L,(p-x)*(p-x)+(v-T)+(v-T),o.push(p,v,h,u,_,x-(p-x),T-(v-T),h,u,_));a&&(e=a);var H=this.edges+1;for(U=1;U<H;U++)e.push(F+2*(U-1),F+2*(U-1)+1,F+2*U+1,F+2*U+1,F+2*U,F+2*(U-1));return e.push(F+2*(U-1),F+2*(U-1)+1,F+1,F+1,F,F+2*(U-1)),o},e}(it),bt=function(t){function e(t,i,n,r,a,s){this._points=null,this._start=-1,this._repaint=!1,this.earcutTriangles=null,this._mat=x.create(),this._points=n.slice(0,n.length),e.__super.call(this,t,i,0,0,this._points.length/2,r,a,s)}r(e,"laya.webgl.shapes.Polygon",t);var i=e.prototype;return i.rebuild=function(t){this._repaint||(this._points.length=0,this._points=this._points.concat(t))},i.setMatrix=function(t){t.copyTo(this._mat)},i.needUpdate=function(t){return this._repaint=this._mat.a==t.a&&this._mat.b==t.b&&this._mat.c==t.c&&this._mat.d==t.d&&this._mat.tx==t.tx&&this._mat.ty==t.ty,!this._repaint},i.getData=function(t,e,i){var n,r=0,a=this._points,s=0;if(this.mUint16Array&&this.mFloat32Array&&this._repaint){if(this._start!=i){for(this._start=i,n=[],s=this.earcutTriangles.length,r=0;r<s;r++)n.push(this.earcutTriangles[r]+i);this.mUint16Array=new Uint16Array(n)}}else{this._start=i,n=[];var o=[],l=[],h=this.color,u=(h>>16&255)/255,_=(h>>8&255)/255,c=(255&h)/255;for(s=Math.floor(a.length/2),r=0;r<s;r++)o.push(this.x+a[2*r],this.y+a[2*r+1],u,_,c),l.push(this.x+a[2*r],this.y+a[2*r+1]);for(this.earcutTriangles=nt.earcut(l,null,2),s=this.earcutTriangles.length,r=0;r<s;r++)n.push(this.earcutTriangles[r]+i);this.mUint16Array=new Uint16Array(n),this.mFloat32Array=new Float32Array(o)}t.append(this.mUint16Array),e.append(this.mFloat32Array)},e}(it),wt=function(t){function e(){this._matrix=new x,this._matrix4=mt.defaultMatrix4.concat(),e.__super.call(this,1e4),this.shaderValue=new Dt(0,0)}r(e,"laya.webgl.submit.SubmitCanvas",t);var i=e.prototype;return i.renderSubmit=function(){if(this._ctx_src._targets)return this._ctx_src._targets.flush(this._ctx_src),1;var t=vt.worldAlpha,e=vt.worldMatrix4,i=vt.worldMatrix,n=vt.worldFilters,r=vt.worldShaderDefines,a=this.shaderValue,s=this._matrix,o=this._matrix4,l=x.TEMP;return x.mul(s,i,l),o[0]=l.a,o[1]=l.b,o[4]=l.c,o[5]=l.d,o[12]=l.tx,o[13]=l.ty,vt.worldMatrix=l.clone(),vt.worldMatrix4=o,vt.worldAlpha=vt.worldAlpha*a.alpha,a.filters&&a.filters.length&&(vt.worldFilters=a.filters,vt.worldShaderDefines=a.defines),this._ctx_src.flush(),vt.worldAlpha=t,vt.worldMatrix4=e,vt.worldMatrix.destroy(),vt.worldMatrix=i,vt.worldFilters=n,vt.worldShaderDefines=r,1},i.releaseRender=function(){var t=e._cache;this._ctx_src=null,t[t._length++]=this},i.getRenderType=function(){return 10003},e.create=function(t,i,n){var r=e._cache._length?e._cache[--e._cache._length]:new e;r._ctx_src=t;var a=r.shaderValue;return a.alpha=i,a.defines.setValue(0),n&&n.length&&a.setFilters(n),r},n(e,["_cache",function(){return this._cache=(e._cache=[],e._cache._length=0,e._cache)}]),e}(at),Nt=function(t){function e(t){this._preIsSameTextureShader=!1,this._isSameTexture=!0,this._texs=new Array,this._texsID=new Array,this._vbPos=new Array,void 0===t&&(t=1e4),e.__super.call(this,t)}r(e,"laya.webgl.submit.SubmitTexture",t);var i=e.prototype;return i.releaseRender=function(){var t=e._cache;t[t._length++]=this,this.shaderValue.release(),this._preIsSameTextureShader=!1,this._vb=null,this._texs.length=0,this._vbPos.length=0,this._isSameTexture=!0},i.addTexture=function(t,e){this._texsID[this._texs.length]=t._uvID,this._texs.push(t),this._vbPos.push(e)},i.checkTexture=function(){if(this._texs.length<1)return void(this._isSameTexture=!0);var t=this.shaderValue.textureHost,e=t.bitmap;if(null!==e)for(var i=this._vb.getFloat32Array(),n=0,r=this._texs.length;n<r;n++){var a=this._texs[n];a.active();var s=a.uv;if(this._texsID[n]!==a._uvID){this._texsID[n]=a._uvID;var o=this._vbPos[n];i[o+2]=s[0],i[o+3]=s[1],i[o+6]=s[2],i[o+7]=s[3],i[o+10]=s[4],i[o+11]=s[5],i[o+14]=s[6],i[o+15]=s[7],this._vb.setNeedUpload()}a.bitmap!==e&&(this._isSameTexture=!1)}},i.renderSubmit=function(){if(0===this._numEle)return e._shaderSet=!1,1;var t=this.shaderValue.textureHost;if(t){var i=t.source;if(!t.bitmap||!i)return e._shaderSet=!1,1;this.shaderValue.texture=i}this._vb.bind_upload(this._ib);var n=Et.mainContext;if(z.activeBlendFunction!==this._blendFn&&(n.enable(3042),this._blendFn(n),z.activeBlendFunction=this._blendFn),b.drawCall++,b.trianglesFaces+=this._numEle/3,this._preIsSameTextureShader&&Pt.activeShader&&e._shaderSet?Pt.activeShader.uploadTexture2D(this.shaderValue.texture):this.shaderValue.upload(),e._shaderSet=!0,this._texs.length>1&&!this._isSameTexture)for(var r=t.bitmap,a=0,s=Pt.activeShader,o=0,l=this._texs.length;o<l;o++){var h=this._texs[o];h.bitmap===r&&o+1!==l||(s.uploadTexture2D(h.source),n.drawElements(4,6*(o-a+1),5123,this._startIdx+6*a*mt.BYTES_PIDX),r=h.bitmap,a=o)}else n.drawElements(4,this._numEle,5123,this._startIdx);return 1},e.create=function(t,i,n,r,a){var s=e._cache._length?e._cache[--e._cache._length]:new e;null==n&&(n=s._selfVb||(s._selfVb=Qt.create(-1)),n.clear(),r=0),s._ib=i,s._vb=n,s._startIdx=r*mt.BYTES_PIDX,s._numEle=0;var o=t._nBlendType;s._blendFn=t._targets?z.targetFns[o]:z.fns[o],s.shaderValue=a,s.shaderValue.setValue(t._shader2D);var l=t._shader2D.filters;return l&&s.shaderValue.setFilters(l),s},e._shaderSet=!0,n(e,["_cache",function(){return this._cache=(e._cache=[],e._cache._length=0,e._cache)}]),e}(at),Pt=function(t){function e(){e.__super.call(this),this.lock=!0}return r(e,"laya.webgl.shader.BaseShader",t),e.activeShader=null,e.bindShader=null,e}(y),Lt=function(t){function e(t,i,n,r,a,s,o,l,h){this._type=0,this._svWidth=NaN,this._svHeight=NaN,this._preRenderTarget=null,this._alreadyResolved=!1,this._looked=!1,this._surfaceFormat=0,this._surfaceType=0,this._depthStencilFormat=0,this._mipMap=!1,this._repeat=!1,this._minFifter=0,this._magFifter=0,this._destroy=!1,void 0===n&&(n=6408),void 0===r&&(r=5121),void 0===a&&(a=34041),void 0===s&&(s=!1),void 0===o&&(o=!1),void 0===l&&(l=-1),void 0===h&&(h=-1),this._type=1,this._w=t,this._h=i,this._surfaceFormat=n,this._surfaceType=r,this._depthStencilFormat=a,this._mipMap=s,this._repeat=o,this._minFifter=l,this._magFifter=h,this._createWebGLRenderTarget(),this.bitmap.lock=!0,e.__super.call(this,this.bitmap,L.INV_UV)}r(e,"laya.webgl.resource.RenderTarget2D",t);var n=e.prototype;return i.imps(n,{"laya.resource.IDispose":!0}),n.getType=function(){return this._type},n.getTexture=function(){return this},n.size=function(t,e){this._w==t&&this._h==e||(this._w=t,this._h=e,this.release(),0!=this._w&&0!=this._h&&this._createWebGLRenderTarget())},n.release=function(){this.destroy()},n.recycle=function(){e.POOL.push(this)},n.start=function(){var t=Et.mainContext;return this._preRenderTarget=vt.curRenderTarget,vt.curRenderTarget=this,t.bindFramebuffer(36160,this.bitmap.frameBuffer),this._alreadyResolved=!1,1==this._type&&(t.viewport(0,0,this._w,this._h),this._svWidth=vt.width,this._svHeight=vt.height,vt.width=this._w,vt.height=this._h,Pt.activeShader=null),this},n.clear=function(t,e,i,n){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=1);var r=Et.mainContext;r.clearColor(t,e,i,n);var a=16384;switch(this._depthStencilFormat){case 33189:a|=256;break;case 36168:a|=1024;break;case 34041:a|=256,a|=1024}r.clear(a)},n.end=function(){var t=Et.mainContext;t.bindFramebuffer(36160,this._preRenderTarget?this._preRenderTarget.bitmap.frameBuffer:null),this._alreadyResolved=!0,vt.curRenderTarget=this._preRenderTarget,1==this._type?(t.viewport(0,0,this._svWidth,this._svHeight),vt.width=this._svWidth,vt.height=this._svHeight,Pt.activeShader=null):t.viewport(0,0,i.stage.width,i.stage.height)},n.getData=function(t,e,i,n){var r=Et.mainContext;if(r.bindFramebuffer(36160,this.bitmap.frameBuffer),!(36053===r.checkFramebufferStatus(36160)))return r.bindFramebuffer(36160,null),null;var a=new Uint8Array(this._w*this._h*4);return r.readPixels(t,e,i,n,this._surfaceFormat,this._surfaceType,a),r.bindFramebuffer(36160,null),a},n.destroy=function(e){void 0===e&&(e=!1),this._destroy||(this._loaded=!1,this.bitmap.offAll(),this.bitmap.disposeResource(),this.bitmap.dispose(),this.offAll(),this.bitmap=null,this._alreadyResolved=!1,this._destroy=!0,t.prototype.destroy.call(this))},n.dispose=function(){},n._createWebGLRenderTarget=function(){this.bitmap=new Wt(this.width,this.height,this._surfaceFormat,this._surfaceType,this._depthStencilFormat,this._mipMap,this._repeat,this._minFifter,this._magFifter),this.bitmap.activeResource(),this._alreadyResolved=!0,this._destroy=!1,this._loaded=!0,this.bitmap.on("recovered",this,function(t){this.event("recovered")})},a(0,n,"surfaceFormat",function(){return this._surfaceFormat}),a(0,n,"magFifter",function(){return this._magFifter}),a(0,n,"surfaceType",function(){return this._surfaceType}),a(0,n,"mipMap",function(){return this._mipMap}),a(0,n,"depthStencilFormat",function(){return this._depthStencilFormat}),a(0,n,"minFifter",function(){return this._minFifter}),a(0,n,"source",function(){return this._alreadyResolved?i.superGet(L,this,"source"):null}),e.create=function(t,i,n,r,a,s,o,l,h){void 0===n&&(n=6408),void 0===r&&(r=5121),void 0===a&&(a=34041),void 0===s&&(s=!1),void 0===o&&(o=!1),void 0===l&&(l=-1),void 0===h&&(h=-1);var u=e.POOL.pop();return u||(u=new e(t,i)),u.bitmap&&u._w==t&&u._h==i&&u._surfaceFormat==n&&u._surfaceType==r&&u._depthStencilFormat==a&&u._mipMap==s&&u._repeat==o&&u._minFifter==l&&u._magFifter==h||(u._w=t,u._h=i,u._surfaceFormat=n,u._surfaceType=r,u._depthStencilFormat=a,u._mipMap=s,u._repeat=o,u._minFifter=l,u._magFifter=h,u.release(),u._createWebGLRenderTarget()),u},e.TYPE2D=1,e.TYPE3D=2,e.POOL=[],e}(L),Ot=function(t){function e(){this._glBuffer=null,this._buffer=null,this._bufferType=0,this._bufferUsage=0,this._byteLength=0,e.__super.call(this),e._gl=Et.mainContext}r(e,"laya.webgl.utils.Buffer",t);var i=e.prototype;return i._bind=function(){this.activeResource(),e._bindActive[this._bufferType]!==this._glBuffer&&(34962===this._bufferType&&(e._bindVertexBuffer=this._glBuffer),e._gl.bindBuffer(this._bufferType,e._bindActive[this._bufferType]=this._glBuffer),Pt.activeShader=null)},i.recreateResource=function(){this._glBuffer||(this._glBuffer=e._gl.createBuffer()),this.completeCreate()},i.disposeResource=function(){this._glBuffer&&(Et.mainContext.deleteBuffer(this._glBuffer),this._glBuffer=null),this.memorySize=0},a(0,i,"bufferUsage",function(){return this._bufferUsage}),e._gl=null,e._bindActive={},e._bindVertexBuffer=null,e._enableAtributes=[],e}(y),Vt=function(t){function e(t){this.texcoord=null,this.offsetX=300,this.offsetY=0,e.__super.call(this,512,0);var i=8*mt.BYTES_PE;this.position=[2,5126,!1,i,0],this.texcoord=[2,5126,!1,i,2*mt.BYTES_PE],this.color=[4,5126,!1,i,4*mt.BYTES_PE]}return r(e,"laya.webgl.shader.d2.skinAnishader.SkinSV",t),e}(Dt),Ft=function(t){function e(t){e.__super.call(this,2,0),this.color=[]}return r(e,"laya.webgl.shader.d2.value.Color2dSV",t),e.prototype.setValue=function(t){t.fillStyle&&(this.color=t.fillStyle._color._color),t.strokeStyle&&(this.color=t.strokeStyle._color._color)},e}(Dt),Bt=function(t){function e(t){this.u_colorMatrix=null,this.strength=0,this.colorMat=null,this.colorAlpha=null,this.u_TexRange=[0,1,0,1],this.u_offset=[0,0],this.texcoord=Dt._TEXCOORD,e.__super.call(this,256,0)}r(e,"laya.webgl.shader.d2.value.FillTextureSV",t);var i=e.prototype;return i.setValue=function(t){this.ALPHA=t.ALPHA,t.filters&&this.setFilters(t.filters)},i.clear=function(){this.texture=null,this.shader=null,this.defines.setValue(0)},e}(Dt),Ut=function(t){function e(t){this.u_colorMatrix=null,this.strength=0,this.blurInfo=null,this.colorMat=null,this.colorAlpha=null,this.texcoord=Dt._TEXCOORD,void 0===t&&(t=0),e.__super.call(this,1,t)}r(e,"laya.webgl.shader.d2.value.TextureSV",t);var i=e.prototype;return i.setValue=function(t){this.ALPHA=t.ALPHA,t.filters&&this.setFilters(t.filters)},i.clear=function(){this.texture=null,this.shader=null,this.defines.setValue(0)},e}(Dt),Ht=function(t){function e(t){this.a_color=null,this.u_pos=[0,0],e.__super.call(this,4,0),this.position=[2,5126,!1,5*mt.BYTES_PE,0],this.a_color=[3,5126,!1,5*mt.BYTES_PE,2*mt.BYTES_PE]}return r(e,"laya.webgl.shader.d2.value.PrimitiveSV",t),e}(Dt),Gt=function(t){function e(){this._atlaser=null,this._flashCacheImage=null,this._flashCacheImageNeedFlush=!1,e.__super.call(this)}r(e,"laya.webgl.atlas.AtlasWebGLCanvas",t);var i=e.prototype;return i.recreateResource=function(){var t=Et.mainContext,e=this._source=t.createTexture(),i=xt.curBindTexTarget,n=xt.curBindTexValue;xt.bindTexture(t,3553,e),t.texImage2D(3553,0,6408,this._w,this._h,0,6408,5121,null),t.texParameteri(3553,10241,9729),t.texParameteri(3553,10240,9729),t.texParameteri(3553,10242,33071),t.texParameteri(3553,10243,33071),i&&n&&xt.bindTexture(t,i,n),this.memorySize=this._w*this._h*4,this.completeCreate()},i.disposeResource=function(){this._source&&(Et.mainContext.deleteTexture(this._source),this._source=null,this.memorySize=0)},i.texSubImage2D=function(t,e,i){if(D.isFlash){this._flashCacheImage||(this._flashCacheImage=g.create(""),this._flashCacheImage._image.createCanvas(this._w,this._h));var n=i.bitmapdata;this._flashCacheImage._image.copyPixels(n,0,0,n.width,n.height,t,e),this._flashCacheImageNeedFlush||(this._flashCacheImageNeedFlush=!0)}else{var r=Et.mainContext,a=xt.curBindTexTarget,s=xt.curBindTexValue;xt.bindTexture(r,3553,this._source),r.pixelStorei(37441,!0),t-1>=0&&r.texSubImage2D(3553,0,t-1,e,6408,5121,i),t+1<=this._w&&r.texSubImage2D(3553,0,t+1,e,6408,5121,i),e-1>=0&&r.texSubImage2D(3553,0,t,e-1,6408,5121,i),e+1<=this._h&&r.texSubImage2D(3553,0,t,e+1,6408,5121,i),r.texSubImage2D(3553,0,t,e,6408,5121,i),r.pixelStorei(37441,!1),a&&s&&xt.bindTexture(r,a,s)}},i.texSubImage2DPixel=function(t,e,i,n,r){var a=Et.mainContext,s=xt.curBindTexTarget,o=xt.curBindTexValue;xt.bindTexture(a,3553,this._source);var l=new Uint8Array(r.data);a.pixelStorei(37441,!0),a.texSubImage2D(3553,0,t,e,i,n,6408,5121,l),a.pixelStorei(37441,!1),s&&o&&xt.bindTexture(a,s,o)},a(0,i,"width",t.prototype._$get_width,function(t){this._w=t}),a(0,i,"height",t.prototype._$get_height,function(t){this._h=t}),e}(h),zt=function(t){function e(){this.flipY=!0,this.premulAlpha=!1,this.alwaysChange=!1,e.__super.call(this)}r(e,"laya.webgl.resource.WebGLCanvas",t);var i=e.prototype;return i.getCanvas=function(){return this._canvas},i.clear=function(){this._ctx&&this._ctx.clear()},i.destroy=function(){this._ctx&&this._ctx.destroy(),this._ctx=null},i._setContext=function(t){this._ctx=t},i.getContext=function(t,i){return this._ctx?this._ctx:this._ctx=e._createContext(this)},i.size=function(t,e){this._w==t&&this._h==e||(this._w=t,this._h=e,this._ctx&&this._ctx.size(t,e),this._canvas&&(this._canvas.height=e,this._canvas.width=t))},i.activeResource=function(t){void 0===t&&(t=!1),this._source||this.recreateResource()},i.recreateResource=function(){this.createWebGlTexture(),this.completeCreate()},i.disposeResource=function(){this._source&&!this.iscpuSource&&(Et.mainContext.deleteTexture(this._source),this._source=null,this.memorySize=0)},i.createWebGlTexture=function(){var t=Et.mainContext;this._canvas;var e=this._source=t.createTexture();this.iscpuSource=!1;var i=xt.curBindTexTarget,n=xt.curBindTexValue;xt.bindTexture(t,3553,e),t.pixelStorei(37440,this.flipY?1:0),this.premulAlpha&&t.pixelStorei(37441,!0),t.texImage2D(3553,0,6408,6408,5121,this._imgData),this.premulAlpha&&t.pixelStorei(37441,!1),t.texParameteri(3553,10240,9729),t.texParameteri(3553,10241,9729),t.texParameteri(3553,10242,33071),t.texParameteri(3553,10243,33071),t.pixelStorei(37440,0),this.memorySize=this._w*this._h*4,i&&n&&xt.bindTexture(t,i,n)},i.reloadCanvasData=function(){var t=Et.mainContext;if(!this._source)throw"reloadCanvasData error, gl texture not created!";var e=xt.curBindTexTarget,i=xt.curBindTexValue;xt.bindTexture(t,3553,this._source),this.premulAlpha&&t.pixelStorei(37441,!0),t.texImage2D(3553,0,6408,6408,5121,this._imgData),this.premulAlpha&&t.pixelStorei(37441,!1),t.pixelStorei(37440,0),e&&i&&xt.bindTexture(t,e,i)},i.texSubImage2D=function(t,e,i){var n=Et.mainContext,r=xt.curBindTexTarget,a=xt.curBindTexValue;xt.bindTexture(n,3553,this._source),n.pixelStorei(37441,!0),n.texSubImage2D(3553,0,e,i,6408,5121,t._source),n.pixelStorei(37441,!1),r&&a&&xt.bindTexture(n,r,a)},i.toBase64=function(t,e,i){var n=null;this._canvas&&(n=this._canvas.toDataURL(t,e)),i.call(this,n)},a(0,i,"context",function(){return this._ctx}),a(0,i,"source",function(){return this.alwaysChange&&this.reloadCanvasData(),this._source}),a(0,i,"asBitmap",null,function(t){this._ctx&&(this._ctx.asBitmap=t)}),e._createContext=null,e}(h),kt=function(t){function e(t,i){this.CborderSize=12,e.__super.call(this),this.char=t,this.isSpace=" "===t,this.xs=i.scaleX,this.ys=i.scaleY,this.font=i.font.toString(),this.fontSize=i.font.size,this.fillColor=i.fillColor,this.borderColor=i.borderColor,this.lineWidth=i.lineWidth,this.underLine=i.underLine;var n,r=D.isConchApp;r?(n=ConchTextCanvas,n._source=ConchTextCanvas,n._source.canvas=ConchTextCanvas):n=u.canvas.source,this.canvas=n,this._enableMerageInAtlas=!0,this._ctx=r?n:this.canvas.getContext("2d",void 0);var a=O.measureText(this.char,this.font);this.cw=a.width*this.xs,this.ch=(a.height||this.fontSize)*this.ys,this.onresize(this.cw+2*this.CborderSize,this.ch+2*this.CborderSize),this.texture=new L(this)}r(e,"laya.webgl.resource.WebGLCharImage",t);var n=e.prototype;return i.imps(n,{"laya.webgl.resource.IMergeAtlasBitmap":!0}),n.active=function(){this.texture.active()},n.recreateResource=function(){var t=D.isConchApp;if(this.onresize(this.cw+2*this.CborderSize,this.ch+2*this.CborderSize),this.canvas&&(this.canvas.height=this._h,this.canvas.width=this._w),t){var e=this.fontSize;1==this.xs&&1==this.ys||(e=parseInt(e*(this.xs>this.ys?this.xs:this.ys)+""));var i="normal 100 "+e+"px Arial";this.borderColor&&(i+=" 1 "+this.borderColor),this._ctx.font=i,this._ctx.textBaseline="top",this._ctx.fillStyle=this.fillColor,this._ctx.fillText(this.char,this.CborderSize,this.CborderSize,null,null,null)}else{if(this._ctx.save(),this._ctx.clearRect(0,0,this.cw+2*this.CborderSize,this.ch+2*this.CborderSize),this._ctx.font=this.font,P.RightToLeft&&(this._ctx.textAlign="end"),this._ctx.textBaseline="top",this._ctx.translate(this.CborderSize,this.CborderSize),1==this.xs&&1==this.ys||this._ctx.scale(this.xs,this.ys),this.fillColor&&this.borderColor?(this._ctx.strokeStyle=this.borderColor,this._ctx.lineWidth=this.lineWidth,this._ctx.strokeText(this.char,0,0,null,null,0,null),this._ctx.fillStyle=this.fillColor,this._ctx.fillText(this.char,0,0,null,null,null)):-1===this.lineWidth?(this._ctx.fillStyle=this.fillColor?this.fillColor:"white",this._ctx.fillText(this.char,0,0,null,null,null)):(this._ctx.strokeStyle=this.borderColor?this.borderColor:"white",this._ctx.lineWidth=this.lineWidth,this._ctx.strokeText(this.char,0,0,null,null,0,null)),this.underLine){this._ctx.lineWidth=1,this._ctx.strokeStyle=this.fillColor,this._ctx.beginPath(),this._ctx.moveTo(0,this.fontSize+1);var n=this._ctx.measureText(this.char).width+1;this._ctx.lineTo(n,this.fontSize+1),this._ctx.stroke()}this._ctx.restore()}this.borderSize=this.CborderSize,this.completeCreate()},n.onresize=function(t,e){this._w=t,this._h=e,this._allowMerageInAtlas=!0},n.clearAtlasSource=function(){},a(0,n,"allowMerageInAtlas",function(){return this._allowMerageInAtlas}),a(0,n,"atlasSource",function(){return this.canvas}),a(0,n,"enableMerageInAtlas",function(){return this._enableMerageInAtlas},function(t){this._enableMerageInAtlas=t}),e.createOneChar=function(t,i){return new e(t,i)},e}(h),Wt=function(t){function e(t,i,n,r,a,s,o,l,h){void 0===n&&(n=6408),void 0===r&&(r=5121),void 0===a&&(a=34041),void 0===s&&(s=!1),void 0===o&&(o=!1),void 0===l&&(l=-1),void 0===h&&(h=1),e.__super.call(this),this._w=t,this._h=i,this._surfaceFormat=n,this._surfaceType=r,this._depthStencilFormat=a,this._mipMap=s,this._repeat=o,this._minFifter=l,this._magFifter=h}r(e,"laya.webgl.resource.WebGLRenderTarget",t);var i=e.prototype;return i.recreateResource=function(){var t=Et.mainContext;this._frameBuffer||(this._frameBuffer=t.createFramebuffer()),this._source||(this._source=t.createTexture());var e=xt.curBindTexTarget,i=xt.curBindTexValue;xt.bindTexture(t,3553,this._source),t.texImage2D(3553,0,6408,this._w,this._h,0,this._surfaceFormat,this._surfaceType,null);var n=this._minFifter,r=this._magFifter,a=this._repeat?10497:33071,s=o.isPOT(this._w,this._h);if(s?(this._mipMap?-1!==n||(n=9987):-1!==n||(n=9729),-1!==r||(r=9729),t.texParameteri(3553,10241,n),t.texParameteri(3553,10240,r),t.texParameteri(3553,10242,a),t.texParameteri(3553,10243,a),this._mipMap&&t.generateMipmap(3553)):(-1!==n||(n=9729),-1!==r||(r=9729),t.texParameteri(3553,10241,n),t.texParameteri(3553,10240,r),t.texParameteri(3553,10242,33071),t.texParameteri(3553,10243,33071)),t.bindFramebuffer(36160,this._frameBuffer),t.framebufferTexture2D(36160,36064,3553,this._source,0),this._depthStencilFormat)switch(this._depthStencilBuffer||(this._depthStencilBuffer=t.createRenderbuffer()),t.bindRenderbuffer(36161,this._depthStencilBuffer),t.renderbufferStorage(36161,this._depthStencilFormat,this._w,this._h),this._depthStencilFormat){case 33189:t.framebufferRenderbuffer(36160,36096,36161,this._depthStencilBuffer);break;case 36168:t.framebufferRenderbuffer(36160,36128,36161,this._depthStencilBuffer);break;case 34041:t.framebufferRenderbuffer(36160,33306,36161,this._depthStencilBuffer)}t.bindFramebuffer(36160,null),e&&i&&xt.bindTexture(t,e,i),t.bindRenderbuffer(36161,null),s&&this._mipMap?this.memorySize=this._w*this._h*4*(1+1/3):this.memorySize=this._w*this._h*4,this.completeCreate()},i.disposeResource=function(){this._frameBuffer&&(Et.mainContext.deleteTexture(this._source),Et.mainContext.deleteFramebuffer(this._frameBuffer),Et.mainContext.deleteRenderbuffer(this._depthStencilBuffer),this._source=null,this._frameBuffer=null,this._depthStencilBuffer=null,this.memorySize=0)},a(0,i,"depthStencilBuffer",function(){return this._depthStencilBuffer}),a(0,i,"frameBuffer",function(){return this._frameBuffer}),e}(h),Xt=function(t){function e(t,i,n,r,a,s,o){this.offsetX=0,this.offsetY=0,e.__super.call(this),this.repeat=!0,this.mipmap=!1,this.minFifter=-1,this.magFifter=-1,this.atlasImage=s,this.canvas=t,this._ctx=t.getContext("2d",void 0),this._w=r,this._h=a,this.offsetX=i,this.offsetY=n,this.src=o,this._enableMerageInAtlas=!0,H.enabled&&this._w<H.atlasLimitWidth&&this._h<H.atlasLimitHeight?this._allowMerageInAtlas=!0:this._allowMerageInAtlas=!1}r(e,"laya.webgl.resource.WebGLSubImage",t);var n=e.prototype;return i.imps(n,{"laya.webgl.resource.IMergeAtlasBitmap":!0}),n.size=function(t,e){this._w=t,this._h=e,this._ctx&&this._ctx.size(t,e),this.canvas&&(this.canvas.height=e,this.canvas.width=t)},n.recreateResource=function(){this.size(this._w,this._h),this._ctx.drawImage(this.atlasImage,this.offsetX,this.offsetY,this._w,this._h,0,0,this._w,this._h),this._allowMerageInAtlas&&this._enableMerageInAtlas?this.memorySize=0:this.createWebGlTexture(),this.completeCreate()},n.createWebGlTexture=function(){var t=Et.mainContext;if(!this.canvas)throw"create GLTextur err:no data:"+this.canvas;var e=this._source=t.createTexture(),i=xt.curBindTexTarget,n=xt.curBindTexValue;xt.bindTexture(t,3553,e),t.pixelStorei(37441,!0),t.texImage2D(3553,0,6408,6408,5121,this.canvas),t.pixelStorei(37441,!1);var r=this.minFifter,a=this.magFifter,s=this.repeat?10497:33071,l=o.isPOT(this.width,this.height);l?(this.mipmap?-1!==r||(r=9987):-1!==r||(r=9729),-1!==a||(a=9729),t.texParameteri(3553,10240,a),t.texParameteri(3553,10241,r),t.texParameteri(3553,10242,s),t.texParameteri(3553,10243,s),this.mipmap&&t.generateMipmap(3553)):(-1!==r||(r=9729),-1!==a||(a=9729),t.texParameteri(3553,10241,r),t.texParameteri(3553,10240,a),t.texParameteri(3553,10242,33071),t.texParameteri(3553,10243,33071)),i&&n&&xt.bindTexture(t,i,n),this.canvas=null,l&&this.mipmap?this.memorySize=this._w*this._h*4*(1+1/3):this.memorySize=this._w*this._h*4},n.disposeResource=function(){H.enabled&&this._allowMerageInAtlas||!this._source||(Et.mainContext.deleteTexture(this._source),this._source=null,this.memorySize=0)},n.clearAtlasSource=function(){},a(0,n,"allowMerageInAtlas",function(){return this._allowMerageInAtlas}),a(0,n,"atlasSource",function(){return this.canvas}),a(0,n,"enableMerageInAtlas",function(){return this._allowMerageInAtlas},function(t){this._allowMerageInAtlas=t}),e}(h),Yt=function(t){function e(t,i,n,r){if(this.customCompile=!1,this._curActTexIndex=0,this.tag={},this._program=null,this._params=null,this._paramsMap={},this._offset=0,e.__super.call(this),!t||!i)throw"Shader Error";(D.isConchApp||D.isFlash)&&(this.customCompile=!0),this._id=++e._count,this._vs=t,this._ps=i,this._nameMap=r||{},null!=n&&(e.sharders[n]=this)}r(e,"laya.webgl.shader.Shader",t);var i=e.prototype;return i.recreateResource=function(){this._compile(),this.completeCreate(),this.memorySize=0},i.disposeResource=function(){Et.mainContext.deleteShader(this._vshader),Et.mainContext.deleteShader(this._pshader),Et.mainContext.deleteProgram(this._program),this._vshader=this._pshader=this._program=null,this._params=null,this._paramsMap={},this.memorySize=0,this._curActTexIndex=0},i._compile=function(){if(this._vs&&this._ps&&!this._params){this._reCompile=!0,this._params=[];var t,i=[this._vs,this._ps];this.customCompile&&(t=gt.preGetParams(this._vs,this._ps));var n=Et.mainContext;if(this._program=n.createProgram(),this._vshader=e._createShader(n,i[0],35633),this._pshader=e._createShader(n,i[1],35632),n.attachShader(this._program,this._vshader),n.attachShader(this._program,this._pshader),n.linkProgram(this._program),!this.customCompile&&!n.getProgramParameter(this._program,35714))throw n.getProgramInfoLog(this._program);var r,a,s=0,o=0,l=this.customCompile?t.attributes.length:n.getProgramParameter(this._program,35721);for(s=0;s<l;s++){var h=this.customCompile?t.attributes[s]:n.getActiveAttrib(this._program,s);a=n.getAttribLocation(this._program,h.name),r={vartype:"attribute",glfun:null,ivartype:0,attrib:h,location:a,name:h.name,type:h.type,isArray:!1,isSame:!1,preValue:null,indexOfParams:0},this._params.push(r)}var u=this.customCompile?t.uniforms.length:n.getProgramParameter(this._program,35718);for(s=0;s<u;s++){var _=this.customCompile?t.uniforms[s]:n.getActiveUniform(this._program,s);a=n.getUniformLocation(this._program,_.name),r={vartype:"uniform",glfun:null,ivartype:1,attrib:h,location:a,name:_.name,type:_.type,isArray:!1,isSame:!1,preValue:null,indexOfParams:0},r.name.indexOf("[0]")>0&&(r.name=r.name.substr(0,r.name.length-3),r.isArray=!0,r.location=n.getUniformLocation(this._program,r.name)),this._params.push(r)}for(s=0,o=this._params.length;s<o;s++)if(r=this._params[s],r.indexOfParams=s,r.index=1,r.value=[r.location,null],r.codename=r.name,r.name=this._nameMap[r.codename]?this._nameMap[r.codename]:r.codename,this._paramsMap[r.name]=r,r._this=this,r.uploadedValue=[],"attribute"!==r.vartype)switch(r.type){case 5124:r.fun=r.isArray?this._uniform1iv:this._uniform1i;break;case 5126:r.fun=r.isArray?this._uniform1fv:this._uniform1f;break;case 35664:r.fun=r.isArray?this._uniform_vec2v:this._uniform_vec2;break;case 35665:r.fun=r.isArray?this._uniform_vec3v:this._uniform_vec3;break;case 35666:r.fun=r.isArray?this._uniform_vec4v:this._uniform_vec4;break;case 35678:r.fun=this._uniform_sampler2D;break;case 35680:r.fun=this._uniform_samplerCube;break;case 35676:r.glfun=n.uniformMatrix4fv,r.fun=this._uniformMatrix4fv;break;case 35670:r.fun=this._uniform1i;break;case 35674:case 35675:default:throw new Error("compile shader err!")}else r.fun=this._attribute}},i.getUniform=function(t){return this._paramsMap[t]},i._attribute=function(t,e){var i=Et.mainContext,n=Ot._enableAtributes,r=t.location;return n[r]||i.enableVertexAttribArray(r),i.vertexAttribPointer(r,e[0],e[1],e[2],e[3],e[4]+this._offset),n[r]=Ot._bindVertexBuffer,1},i._uniform1f=function(t,e){var i=t.uploadedValue;return i[0]!==e?(Et.mainContext.uniform1f(t.location,i[0]=e),1):0},i._uniform1fv=function(t,e){if(e.length<4){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]||i[2]!==e[2]||i[3]!==e[3]?(Et.mainContext.uniform1fv(t.location,e),i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],1):0}return Et.mainContext.uniform1fv(t.location,e),1},i._uniform_vec2=function(t,e){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]?(Et.mainContext.uniform2f(t.location,i[0]=e[0],i[1]=e[1]),1):0},i._uniform_vec2v=function(t,e){if(e.length<2){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]||i[2]!==e[2]||i[3]!==e[3]?(Et.mainContext.uniform2fv(t.location,e),i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],1):0}return Et.mainContext.uniform2fv(t.location,e),1},i._uniform_vec3=function(t,e){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]||i[2]!==e[2]?(Et.mainContext.uniform3f(t.location,i[0]=e[0],i[1]=e[1],i[2]=e[2]),1):0},i._uniform_vec3v=function(t,e){return Et.mainContext.uniform3fv(t.location,e),1},i._uniform_vec4=function(t,e){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]||i[2]!==e[2]||i[3]!==e[3]?(Et.mainContext.uniform4f(t.location,i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3]),1):0},i._uniform_vec4v=function(t,e){return Et.mainContext.uniform4fv(t.location,e),1},i._uniformMatrix2fv=function(t,e){return Et.mainContext.uniformMatrix2fv(t.location,!1,e),1},i._uniformMatrix3fv=function(t,e){return Et.mainContext.uniformMatrix3fv(t.location,!1,e),1},i._uniformMatrix4fv=function(t,e){return Et.mainContext.uniformMatrix4fv(t.location,!1,e),1},i._uniform1i=function(t,e){var i=t.uploadedValue;return i[0]!==e?(Et.mainContext.uniform1i(t.location,i[0]=e),1):0},i._uniform1iv=function(t,e){return Et.mainContext.uniform1iv(t.location,e),1},i._uniform_ivec2=function(t,e){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]?(Et.mainContext.uniform2i(t.location,i[0]=e[0],i[1]=e[1]),1):0},i._uniform_ivec2v=function(t,e){return Et.mainContext.uniform2iv(t.location,e),1},i._uniform_vec3i=function(t,e){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]||i[2]!==e[2]?(Et.mainContext.uniform3i(t.location,i[0]=e[0],i[1]=e[1],i[2]=e[2]),1):0},i._uniform_vec3vi=function(t,e){return Et.mainContext.uniform3iv(t.location,e),1},i._uniform_vec4i=function(t,e){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]||i[2]!==e[2]||i[3]!==e[3]?(Et.mainContext.uniform4i(t.location,i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3]),1):0},i._uniform_vec4vi=function(t,e){return Et.mainContext.uniform4iv(t.location,e),1},i._uniform_sampler2D=function(t,i){var n=Et.mainContext,r=t.uploadedValue;return null==r[0]?(r[0]=this._curActTexIndex,n.uniform1i(t.location,this._curActTexIndex),n.activeTexture(e._TEXTURES[this._curActTexIndex]),xt.bindTexture(n,3553,i),this._curActTexIndex++,1):(n.activeTexture(e._TEXTURES[r[0]]),xt.bindTexture(n,3553,i),0)},i._uniform_samplerCube=function(t,i){var n=Et.mainContext,r=t.uploadedValue;return null==r[0]?(r[0]=this._curActTexIndex,n.uniform1i(t.location,this._curActTexIndex),n.activeTexture(e._TEXTURES[this._curActTexIndex]),xt.bindTexture(n,34067,i),this._curActTexIndex++,1):(n.activeTexture(e._TEXTURES[r[0]]),xt.bindTexture(n,34067,i),0)},i._noSetValue=function(t){console.log("no....:"+t.name)},i.uploadOne=function(t,e){this.activeResource(),xt.UseProgram(this._program);var i=this._paramsMap[t];i.fun.call(this,i,e)},i.uploadTexture2D=function(t){b.shaderCall++;var e=Et.mainContext;e.activeTexture(33984),xt.bindTexture(e,3553,t)},i.upload=function(t,e){Pt.activeShader=Pt.bindShader=this,this._lastUseFrameCount===b.loopCount||this.activeResource(),xt.UseProgram(this._program),this._reCompile?(e=this._params,this._reCompile=!1):e=e||this._params;for(var i,n,r=(Et.mainContext,e.length),a=0,s=0;s<r;s++)i=e[s],null!==(n=t[i.name])&&(a+=i.fun.call(this,i,n));b.shaderCall+=a},i.uploadArray=function(t,e,i){Pt.activeShader=this,Pt.bindShader=this,this.activeResource(),xt.UseProgram(this._program);for(var n,r,a=(this._params,0),s=e-2;s>=0;s-=2)(r=this._paramsMap[t[s]])&&null!=(n=t[s+1])&&(i&&i[r.name]&&i[r.name].bind(),a+=r.fun.call(this,r,n));b.shaderCall+=a},i.getParams=function(){return this._params},e.getShader=function(t){return e.sharders[t]},e.create=function(t,i,n,r){return new e(t,i,n,r)},e.withCompile=function(t,i,n,r){if(n&&e.sharders[n])return e.sharders[n];var a=e._preCompileShader[2e-4*t];if(!a)throw new Error("withCompile shader err!"+t);return a.createShader(i,n,r)},e.withCompile2D=function(t,i,n,r,a){if(r&&e.sharders[r])return e.sharders[r];var s=e._preCompileShader[2e-4*t+i];if(!s)throw new Error("withCompile shader err!"+t+" "+i);return s.createShader(n,r,a)},e.addInclude=function(t,e){gt.addInclude(t,e)},e.preCompile=function(t,i,n,r){var a=2e-4*t;e._preCompileShader[a]=new gt(a,i,n,r)},e.preCompile2D=function(t,i,n,r,a){var s=2e-4*t+i;e._preCompileShader[s]=new gt(s,n,r,a)},e._createShader=function(t,e,i){var n=t.createShader(i);return t.shaderSource(n,e),t.compileShader(n),n},e._count=0,e._preCompileShader={},e.SHADERNAME2ID=2e-4,n(e,["_TEXTURES",function(){return this._TEXTURES=[33984,33985,33986,33987,33988,33989,33990,,33991,33992]},"nameKey",function(){return this.nameKey=new w},"sharders",function(){return this.sharders=(e.sharders=[],e.sharders.length=32,e.sharders)}]),e}(Pt),Zt=function(t){function e(){this._maxsize=0,this._upload=!0,this._uploadSize=0,e.__super.call(this),this.lock=!0}r(e,"laya.webgl.utils.Buffer2D",t);var i=e.prototype;return i._bufferData=function(){this._maxsize=Math.max(this._maxsize,this._byteLength),b.loopCount%30==0&&(this._buffer.byteLength>this._maxsize+64&&(this.memorySize=this._buffer.byteLength,this._buffer=this._buffer.slice(0,this._maxsize+64),this._checkArrayUse()),this._maxsize=this._byteLength),this._uploadSize<this._buffer.byteLength&&(this._uploadSize=this._buffer.byteLength,Ot._gl.bufferData(this._bufferType,this._uploadSize,this._bufferUsage),this.memorySize=this._uploadSize),Ot._gl.bufferSubData(this._bufferType,0,this._buffer)},i._bufferSubData=function(t,e,i){if(void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),this._maxsize=Math.max(this._maxsize,this._byteLength),b.loopCount%30==0&&(this._buffer.byteLength>this._maxsize+64&&(this.memorySize=this._buffer.byteLength,this._buffer=this._buffer.slice(0,this._maxsize+64),this._checkArrayUse()),this._maxsize=this._byteLength),this._uploadSize<this._buffer.byteLength&&(this._uploadSize=this._buffer.byteLength,Ot._gl.bufferData(this._bufferType,this._uploadSize,this._bufferUsage),this.memorySize=this._uploadSize),e||i){var n=this._buffer.slice(e,i);Ot._gl.bufferSubData(this._bufferType,t,n)}else Ot._gl.bufferSubData(this._bufferType,t,this._buffer)},i._checkArrayUse=function(){},i._bind_upload=function(){return!!this._upload&&(this._upload=!1,this._bind(),this._bufferData(),!0)},i._bind_subUpload=function(t,e,i){return void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),!!this._upload&&(this._upload=!1,this._bind(),this._bufferSubData(t,e,i),!0)},i._resizeBuffer=function(t,e){if(t<this._buffer.byteLength)return this;if(this.memorySize=t,e&&this._buffer&&this._buffer.byteLength>0){var i=new ArrayBuffer(t);new Uint8Array(i).set(new Uint8Array(this._buffer),0),this._buffer=i}else this._buffer=new ArrayBuffer(t);return this._checkArrayUse(),this._upload=!0,this},i.append=function(t){this._upload=!0;var e,i=0;i=t.byteLength,t instanceof Uint8Array?(this._resizeBuffer(this._byteLength+i,!0),e=new Uint8Array(this._buffer,this._byteLength)):t instanceof Uint16Array?(this._resizeBuffer(this._byteLength+i,!0),e=new Uint16Array(this._buffer,this._byteLength)):t instanceof Float32Array&&(this._resizeBuffer(this._byteLength+i,!0),e=new Float32Array(this._buffer,this._byteLength)),e.set(t,0),this._byteLength+=i,this._checkArrayUse()},i.appendEx=function(t,e){this._upload=!0;var i,n=0;n=t.byteLength,this._resizeBuffer(this._byteLength+n,!0),i=new e(this._buffer,this._byteLength),i.set(t,0),this._byteLength+=n,this._checkArrayUse()},i.appendEx2=function(t,e,i,n){void 0===n&&(n=1),this._upload=!0;var r,a=0;a=i*n,this._resizeBuffer(this._byteLength+a,!0),r=new e(this._buffer,this._byteLength);var s=0;for(s=0;s<i;s++)r[s]=t[s];this._byteLength+=a,this._checkArrayUse()},i.getBuffer=function(){return this._buffer},i.setNeedUpload=function(){this._upload=!0},i.getNeedUpload=function(){return this._upload},i.upload=function(){var t=this._bind_upload();return Ot._gl.bindBuffer(this._bufferType,null),Ot._bindActive[this._bufferType]=null,Pt.activeShader=null,t},i.subUpload=function(t,e,i){void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0);var n=this._bind_subUpload();return Ot._gl.bindBuffer(this._bufferType,null),Ot._bindActive[this._bufferType]=null,Pt.activeShader=null,n},i.disposeResource=function(){t.prototype.disposeResource.call(this),this._upload=!0,this._uploadSize=0},i.clear=function(){this._byteLength=0,this._upload=!0},a(0,i,"bufferLength",function(){return this._buffer.byteLength}),a(0,i,"byteLength",null,function(t){this._byteLength!==t&&(t<=this._buffer.byteLength||this._resizeBuffer(2*t+256,!0),this._byteLength=t)}),e.__int__=function(t){qt.QuadrangleIB=qt.create(35044),pt.fillIBQuadrangle(qt.QuadrangleIB,16)},e.FLOAT32=4,e.SHORT=2,e}(Ot),Kt=(function(t){function e(t){this.u_blurX=!1,this.u_color=null,this.u_offset=null,this.u_strength=NaN,this.u_texW=0,this.u_texH=0,e.__super.call(this,9)}r(e,"laya.webgl.shader.d2.value.GlowSV",t);var i=e.prototype;i.setValue=function(e){t.prototype.setValue.call(this,e)},i.clear=function(){t.prototype.clear.call(this)}}(Ut),function(t){function e(t){e.__super.call(this,64),this.defines.add(64)}r(e,"laya.webgl.shader.d2.value.TextSV",t);var i=e.prototype;return i.release=function(){e.pool[e._length++]=this,this.clear()},i.clear=function(){t.prototype.clear.call(this)},e.create=function(){return e._length?e.pool[--e._length]:new e(null)},e.pool=[],e._length=0,e}(Ut)),jt=function(t){function e(t,i,n,r){this._params2dQuick1=null,this._params2dQuick2=null,this._shaderValueWidth=NaN,this._shaderValueHeight=NaN,e.__super.call(this,t,i,n,r)}r(e,"laya.webgl.shader.d2.Shader2X",t);var i=e.prototype;return i.upload2dQuick1=function(t){this.upload(t,this._params2dQuick1||this._make2dQuick1())},i._make2dQuick1=function(){if(!this._params2dQuick1){this.activeResource(),this._params2dQuick1=[];for(var t,e=this._params,i=0,n=e.length;i<n;i++)t=e[i],(D.isFlash||"size"!==t.name&&"position"!==t.name&&"texcoord"!==t.name)&&this._params2dQuick1.push(t)}return this._params2dQuick1},i.disposeResource=function(){t.prototype.disposeResource.call(this),this._params2dQuick1=null,this._params2dQuick2=null},i.upload2dQuick2=function(t){this.upload(t,this._params2dQuick2||this._make2dQuick2())},i._make2dQuick2=function(){if(!this._params2dQuick2){this.activeResource(),this._params2dQuick2=[];for(var t,e=this._params,i=0,n=e.length;i<n;i++)t=e[i],(D.isFlash||"size"!==t.name)&&this._params2dQuick2.push(t)}return this._params2dQuick2},e.create=function(t,i,n,r){return new e(t,i,n,r)},e}(Yt),qt=function(t){function e(t){this._uint8Array=null,this._uint16Array=null,void 0===t&&(t=35044),e.__super.call(this),this._bufferUsage=t,this._bufferType=34963,D.isFlash||(this._buffer=new ArrayBuffer(8))}r(e,"laya.webgl.utils.IndexBuffer2D",t);var i=e.prototype;return i._checkArrayUse=function(){this._uint8Array&&(this._uint8Array=new Uint8Array(this._buffer)),this._uint16Array&&(this._uint16Array=new Uint16Array(this._buffer))},i.getUint8Array=function(){return this._uint8Array||(this._uint8Array=new Uint8Array(this._buffer))},i.getUint16Array=function(){return this._uint16Array||(this._uint16Array=new Uint16Array(this._buffer))},i.destory=function(){this._uint16Array=null,this._uint8Array=null,this._buffer=null},e.QuadrangleIB=null,e.create=function(t){return void 0===t&&(t=35044),new e(t)},e}(Zt),Qt=function(t){function e(t,i){this._floatArray32=null,this._vertexStride=0,e.__super.call(this),this._vertexStride=t,this._bufferUsage=i,this._bufferType=34962,D.isFlash||(this._buffer=new ArrayBuffer(8)),this.getFloat32Array()}r(e,"laya.webgl.utils.VertexBuffer2D",t);var i=e.prototype;return i.getFloat32Array=function(){return this._floatArray32||(this._floatArray32=new Float32Array(this._buffer))},i.bind=function(t){t&&t._bind(),this._bind()},i.insertData=function(t,e){this.getFloat32Array().set(t,e),this._upload=!0},i.bind_upload=function(t){t._bind_upload()||t._bind(),this._bind_upload()||this._bind()},i._checkArrayUse=function(){this._floatArray32&&(this._floatArray32=new Float32Array(this._buffer))},i.disposeResource=function(){t.prototype.disposeResource.call(this);for(var e=Ot._enableAtributes,i=0;i<10;i++)Et.mainContext.disableVertexAttribArray(i),e[i]=null},i.destory=function(){this._byteLength=0,this._upload=!0,this._buffer=null,this._floatArray32=null},a(0,i,"vertexStride",function(){return this._vertexStride}),e.create=function(t,i){return void 0===i&&(i=35048),new e(t,i)},e}(Zt),$t=function(t){function e(t,i,n,r){if(this._format=0,this._mipmap=!1,this._allowMerageInAtlas=!1,this._enableMerageInAtlas=!1,this.repeat=!1,this._image=null,this.minFifter=0,this.magFifter=0,void 0===n&&(n=6408),void 0===r&&(r=!0),e.__super.call(this,t,i),this._format=n,this._mipmap=r,this.repeat=!1,this.minFifter=-1,this.magFifter=-1,"string"==typeof t)this._url=t,this._src=t,this._image=new u.window.Image,i&&(i.onload&&(this.onload=i.onload),i.onerror&&(this.onerror=i.onerror),i.onCreate&&i.onCreate(this)),this._image.crossOrigin=t&&0==t.indexOf("data:")?null:"",t&&(this._image.src=t);else if(t instanceof ArrayBuffer){this._src=i,this._url=this._src;var a=new _(t);a.readUTFBytes(4),a.readUTFBytes(2),a.getInt16();a.endian="bigEndian",this._w=a.getInt16(),this._h=a.getInt16();a.getInt16(),a.getInt16();this._image=new Uint8Array(t,a.pos),this._format=Et.compressEtc1.COMPRESSED_RGB_ETC1_WEBGL,H.enabled&&this._w<H.atlasLimitWidth&&this._h<H.atlasLimitHeight?this._allowMerageInAtlas=!0:this._allowMerageInAtlas=!1}else this._src=i,this._url=this._src,this._image=t.source||t,this.onresize();this._$5__enableMerageInAtlas=!0}r(e,"laya.webgl.resource.WebGLImage",t);var n=e.prototype;return i.imps(n,{"laya.webgl.resource.IMergeAtlasBitmap":!0}),n._init_=function(t,e){},n._createWebGlTexture=function(){if(!this._image)throw"create GLTextur err:no data:"+this._image;var t=Et.mainContext,e=this._source=t.createTexture(),i=xt.curBindTexTarget,n=xt.curBindTexValue;switch(xt.bindTexture(t,3553,e),t.pixelStorei(37441,!0),this._format){case 6408:t.texImage2D(3553,0,this._format,6408,5121,this._image);break;case Et.compressEtc1.COMPRESSED_RGB_ETC1_WEBGL:t.compressedTexImage2D(3553,0,this._format,this._w,this._h,0,this._image)}t.pixelStorei(37441,!1);var r=this.minFifter,a=this.magFifter,s=this.repeat?10497:33071,l=o.isPOT(this._w,this._h);l?(this.mipmap?-1!==r||(r=9987):-1!==r||(r=9729),-1!==a||(a=9729),t.texParameteri(3553,10241,r),t.texParameteri(3553,10240,a),t.texParameteri(3553,10242,s),t.texParameteri(3553,10243,s),this.mipmap&&t.generateMipmap(3553)):(-1!==r||(r=9729),-1!==a||(a=9729),t.texParameteri(3553,10241,r),t.texParameteri(3553,10240,a),t.texParameteri(3553,10242,33071),t.texParameteri(3553,10243,33071)),i&&n&&xt.bindTexture(t,i,n),this._image.onload=null,this._image=null,l&&this.mipmap?this.memorySize=this._w*this._h*4*(1+1/3):this.memorySize=this._w*this._h*4,this._recreateLock=!1},n.recreateResource=function(){var t=this;if(null!=this._src&&""!==this._src)if(this._needReleaseAgain=!1,this._image){if(this._recreateLock)return;this._allowMerageInAtlas&&this._$5__enableMerageInAtlas?(this.memorySize=0,this._recreateLock=!1):this._createWebGlTexture(),this.completeCreate()}else{this._recreateLock=!0;var e=this;this._image=new u.window.Image,this._image.crossOrigin=0==this._src.indexOf("data:")?null:"",this._image.onload=function(){if(e._needReleaseAgain)return e._needReleaseAgain=!1,e._image.onload=null,void(e._image=null);e._allowMerageInAtlas&&e._enableMerageInAtlas?(t.memorySize=0,t._recreateLock=!1):e._createWebGlTexture(),e.completeCreate()},this._image.src=this._src}},n.disposeResource=function(){this._recreateLock&&(this._needReleaseAgain=!0),this._source&&(Et.mainContext.deleteTexture(this._source),this._source=null,this._image=null,this.memorySize=0)},n.onresize=function(){this._w=this._image.width,this._h=this._image.height,H.enabled&&this._w<H.atlasLimitWidth&&this._h<H.atlasLimitHeight?this._allowMerageInAtlas=!0:this._allowMerageInAtlas=!1},n.clearAtlasSource=function(){this._image=null},a(0,n,"format",function(){return this._format}),a(0,n,"enableMerageInAtlas",function(){return this._$5__enableMerageInAtlas},function(t){this._$5__enableMerageInAtlas=t}),a(0,n,"mipmap",function(){return this._mipmap}),a(0,n,"allowMerageInAtlas",function(){return this._allowMerageInAtlas}),a(0,n,"atlasSource",function(){return this._image}),a(0,n,"onload",null,function(t){var e=this;this._onload=t,this._image&&(this._image.onload=null!=this._onload?function(){e.onresize(),e._onload()}:null)}),a(0,n,"onerror",null,function(t){var e=this;this._onerror=t,this._image&&(this._image.onerror=null!=this._onerror?function(){e._onerror()}:null)}),e}(g);i.__init([dt,U,St,gt])}(window,document,Laya),n=[i,e],void 0!==(r=function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0});for(var i in Laya){var n=Laya[i];n&&n.__isclass&&(e[i]=n)}}.apply(e,n))&&(t.exports=r)},function(t,e,i){var n,r;!function(t,e,i){var n=(i.un,i.uns,i.static),r=i.class,a=i.getset,s=i.__newvec,o=laya.maths.Bezier,l=laya.utils.Browser,h=laya.utils.Byte,u=(laya.events.Event,laya.events.EventDispatcher),_=laya.display.Graphics,c=laya.resource.HTMLCanvas,d=laya.utils.Handler,f=laya.net.Loader,m=laya.maths.MathUtil,p=laya.maths.Matrix,v=(laya.display.Node,laya.maths.Point,laya.maths.Rectangle),g=laya.renders.Render,E=(laya.renders.RenderContext,laya.resource.Resource),x=laya.utils.RunDriver,T=laya.display.Sprite,S=laya.utils.Stat,D=laya.resource.Texture,M=laya.net.URL,y=laya.utils.Utils,A=function(){function t(){this.nodes=null,this.name=null,this.playTime=NaN,this.bone3DMap=null,this.totalKeyframeDatasLength=0}return r(t,"laya.ani.AnimationContent"),t}(),I=function(){function t(){this.name=null,this.parentIndex=0,this.parent=null,this.keyframeWidth=0,this.lerpType=0,this.interpolationMethod=null,this.childs=null,this.keyFrame=null,this.playTime=NaN,this.extenData=null,this.dataOffset=0}return r(t,"laya.ani.AnimationNodeContent"),t}(),R=function(){function t(){}return r(t,"laya.ani.AnimationParser01"),t.parse=function(t,e){var i=e.__getBuffer(),n=0,r=0,a=0,s=0,o=0,l=0,u=0,_=e.readUTFString();t._aniClassName=_;var c,d=e.readUTFString().split("\n"),f=e.getUint8(),m=e.getUint32(),p=e.getUint32();m>0&&(c=i.slice(m,p));var v=new h(c);for(p>0&&(t._publicExtData=i.slice(p,i.byteLength)),t._useParent=!!e.getUint8(),t._anis.length=f,n=0;n<f;n++){var g=t._anis[n]=new A;g.nodes=new Array;var E=g.name=d[e.getUint16()];t._aniMap[E]=n,g.bone3DMap={},g.playTime=e.getFloat32();var x=g.nodes.length=e.getUint8();for(g.totalKeyframeDatasLength=0,r=0;r<x;r++){var T=g.nodes[r]=new I;T.childs=[];var S=e.getInt16();S>=0&&(T.name=d[S],g.bone3DMap[T.name]=r),T.keyFrame=new Array,T.parentIndex=e.getInt16(),-1==T.parentIndex?T.parent=null:T.parent=g.nodes[T.parentIndex],T.lerpType=e.getUint8();var D=e.getUint32();v.pos=D;var M=T.keyframeWidth=v.getUint16();if(g.totalKeyframeDatasLength+=M,0===T.lerpType||1===T.lerpType)for(T.interpolationMethod=[],T.interpolationMethod.length=M,a=0;a<M;a++)T.interpolationMethod[a]=it.interpolation[v.getUint8()];null!=T.parent&&T.parent.childs.push(T);var y=e.getUint16();y>0&&(T.extenData=i.slice(e.pos,e.pos+y),e.pos+=y);var R=e.getUint16();T.keyFrame.length=R;var C,b=0;for(a=0,s=R;a<s;a++){if(C=T.keyFrame[a]=new Q,C.duration=e.getFloat32(),C.startTime=b,2===T.lerpType){C.interpolationData=[];var w=e.getUint8(),N=0;switch(N=e.getFloat32()){case 254:for(C.interpolationData.length=M,u=0;u<M;u++)C.interpolationData[u]=0;break;case 255:for(C.interpolationData.length=M,u=0;u<M;u++)C.interpolationData[u]=5;break;default:for(C.interpolationData.push(N),l=1;l<w;l++)C.interpolationData.push(e.getFloat32())}}for(C.data=new Float32Array(M),o=0;o<M;o++)C.data[o]=e.getFloat32(),C.data[o]>-1e-8&&C.data[o]<1e-8&&(C.data[o]=0);b+=C.duration}C.startTime=g.playTime,T.playTime=g.playTime,t._calculateKeyFrame(T,R,M)}}},t}(),C=function(){function t(){}return r(t,"laya.ani.AnimationParser02"),t.READ_DATA=function(){t._DATA.offset=t._reader.getUint32(),t._DATA.size=t._reader.getUint32()},t.READ_BLOCK=function(){for(var e=t._BLOCK.count=t._reader.getUint16(),i=t._BLOCK.blockStarts=[],n=t._BLOCK.blockLengths=[],r=0;r<e;r++)i.push(t._reader.getUint32()),n.push(t._reader.getUint32())},t.READ_STRINGS=function(){var e=t._reader.getUint32(),i=t._reader.getUint16(),n=t._reader.pos;t._reader.pos=e+t._DATA.offset;for(var r=0;r<i;r++)t._strings[r]=t._reader.readUTFString();t._reader.pos=n},t.parse=function(e,i){t._templet=e,t._reader=i;i.__getBuffer();t.READ_DATA(),t.READ_BLOCK(),t.READ_STRINGS();for(var n=0,r=t._BLOCK.count;n<r;n++){var a=i.getUint16(),s=t._strings[a],o=t["READ_"+s];if(null==o)throw new Error("model file err,no this function:"+a+" "+s);o.call()}},t.READ_ANIMATIONS=function(){var e=t._reader,i=e.__getBuffer(),n=0,r=0,a=0,s=0,o=e.getUint16(),l=[];for(l.length=o,n=0;n<o;n++)l[n]=it.interpolation[e.getByte()];var h=e.getUint8();for(t._templet._anis.length=h,n=0;n<h;n++){var u=t._templet._anis[n]={};u.nodes=new Array;var _=u.name=t._strings[e.getUint16()];t._templet._aniMap[_]=n,u.bone3DMap={},u.playTime=e.getFloat32();var c=u.nodes.length=e.getInt16();for(u.totalKeyframeDatasLength=0,r=0;r<c;r++){var d=u.nodes[r]={};d.keyframeWidth=o,d.childs=[];var f=e.getUint16();f>=0&&(d.name=t._strings[f],u.bone3DMap[d.name]=r),d.keyFrame=new Array,d.parentIndex=e.getInt16(),-1==d.parentIndex?d.parent=null:d.parent=u.nodes[d.parentIndex],u.totalKeyframeDatasLength+=o,d.interpolationMethod=l,null!=d.parent&&d.parent.childs.push(d);var m=e.getUint16();d.keyFrame.length=m;var p=null,v=null;for(a=0,s=m;a<s;a++){p=d.keyFrame[a]={},p.startTime=e.getFloat32(),v&&(v.duration=p.startTime-v.startTime);var g=t._DATA.offset,E=e.getUint32(),x=4*o,T=i.slice(g+E,g+E+x);p.data=new Float32Array(T),v=p}p.duration=0,d.playTime=u.playTime,t._templet._calculateKeyFrame(d,m,o)}}},t._templet=null,t._reader=null,t._strings=[],n(t,["_BLOCK",function(){return this._BLOCK={count:0}},"_DATA",function(){return this._DATA={offset:0,size:0}}]),t}(),b=(function(){function t(){}r(t,"laya.ani.AnimationState"),t.stopped=0,t.paused=1,t.playing=2}(),function(){function t(){this.name=null,this.root=null,this.parentBone=null,this.length=10,this.transform=null,this.inheritScale=!0,this.inheritRotation=!0,this.rotation=NaN,this.resultRotation=NaN,this.d=-1,this._tempMatrix=null,this._sprite=null,this.resultTransform=new j,this.resultMatrix=new p,this._children=[]}r(t,"laya.ani.bone.Bone");var e=t.prototype;return e.setTempMatrix=function(t){this._tempMatrix=t;var e,i=0,n=0;for(i=0,n=this._children.length;i<n;i++)e=this._children[i],e.setTempMatrix(this._tempMatrix)},e.update=function(t){this.rotation=this.transform.skX;var e;if(t)e=this.resultTransform.getMatrix(),p.mul(e,t,this.resultMatrix),this.resultRotation=this.rotation;else if(this.resultRotation=this.rotation+this.parentBone.resultRotation,this.parentBone)if(this.inheritRotation&&this.inheritScale)e=this.resultTransform.getMatrix(),p.mul(e,this.parentBone.resultMatrix,this.resultMatrix);else{var i=this.parentBone,n=NaN,r=NaN,a=NaN,s=this.parentBone.resultMatrix;e=this.resultTransform.getMatrix();var o=s.a*e.tx+s.c*e.ty+s.tx,l=s.b*e.tx+s.d*e.ty+s.ty,h=new p;this.inheritRotation?(n=Math.atan2(i.resultMatrix.b,i.resultMatrix.a),r=Math.cos(n),a=Math.sin(n),h.setTo(r,a,-a,r,0,0),p.mul(this._tempMatrix,h,p.TEMP),p.TEMP.copyTo(h),e=this.resultTransform.getMatrix(),p.mul(e,h,this.resultMatrix),this.resultTransform.scX*this.resultTransform.scY<0&&this.resultMatrix.rotate(.5*Math.PI),this.resultMatrix.tx=o,this.resultMatrix.ty=l):(this.inheritScale,e=this.resultTransform.getMatrix(),p.TEMP.identity(),p.TEMP.d=this.d,p.mul(e,p.TEMP,this.resultMatrix),this.resultMatrix.tx=o,this.resultMatrix.ty=l)}else e=this.resultTransform.getMatrix(),e.copyTo(this.resultMatrix);var u,_=0,c=0;for(_=0,c=this._children.length;_<c;_++)u=this._children[_],u.update()},e.updateChild=function(){var t,e=0,i=0;for(e=0,i=this._children.length;e<i;e++)t=this._children[e],t.update()},e.setRotation=function(t){this._sprite&&(this._sprite.rotation=180*t/Math.PI)},e.updateDraw=function(e,n){t.ShowBones&&!t.ShowBones[this.name]||(this._sprite?(this._sprite.x=e+this.resultMatrix.tx,this._sprite.y=n+this.resultMatrix.ty):(this._sprite=new T,this._sprite.graphics.drawCircle(0,0,5,"#ff0000"),this._sprite.graphics.drawLine(0,0,this.length,0,"#00ff00"),this._sprite.graphics.fillText(this.name,0,0,"20px Arial","#00ff00","center"),i.stage.addChild(this._sprite),this._sprite.x=e+this.resultMatrix.tx,this._sprite.y=n+this.resultMatrix.ty));var r,a=0,s=0;for(a=0,s=this._children.length;a<s;a++)r=this._children[a],r.updateDraw(e,n)},e.addChild=function(t){this._children.push(t),t.parentBone=this},e.findBone=function(t){if(this.name==t)return this;var e,i,n=0,r=0;for(n=0,r=this._children.length;n<r;n++)if(e=this._children[n],i=e.findBone(t))return i;return null},e.localToWorld=function(t){var e=t[0],i=t[1];t[0]=e*this.resultMatrix.a+i*this.resultMatrix.c+this.resultMatrix.tx,t[1]=e*this.resultMatrix.b+i*this.resultMatrix.d+this.resultMatrix.ty},t.ShowBones={},t}()),w=function(){function t(){this.name=null,this.parent=null,this.attachmentName=null,this.srcDisplayIndex=-1,this.type="src",this.templet=null,this.currSlotData=null,this.currTexture=null,this.currDisplayData=null,this.displayIndex=-1,this._diyTexture=null,this._parentMatrix=null,this._resultMatrix=null,this._replaceDic={},this._curDiyUV=null,this._curDiyVS=null,this._skinSprite=null,this.deformData=null,this._mVerticleArr=null}r(t,"laya.ani.bone.BoneSlot");var e=t.prototype;return e.showSlotData=function(t,e){void 0===e&&(e=!0),this.currSlotData=t,e&&(this.displayIndex=this.srcDisplayIndex),this.currDisplayData=null,this.currTexture=null},e.showDisplayByName=function(t){this.currSlotData&&this.showDisplayByIndex(this.currSlotData.getDisplayByName(t))},e.replaceDisplayByName=function(t,e){if(this.currSlotData){var i=0;i=this.currSlotData.getDisplayByName(t);var n=0;n=this.currSlotData.getDisplayByName(e),this.replaceDisplayByIndex(i,n)}},e.replaceDisplayByIndex=function(t,e){this.currSlotData&&(this._replaceDic[t]=e,this.displayIndex==t&&this.showDisplayByIndex(t))},e.showDisplayByIndex=function(t){if(null!=this._replaceDic[t]&&(t=this._replaceDic[t]),this.currSlotData&&t>-1&&t<this.currSlotData.displayArr.length){if(this.displayIndex=t,this.currDisplayData=this.currSlotData.displayArr[t],this.currDisplayData){var e=this.currDisplayData.name;this.currTexture=this.templet.getTexture(e),this.currTexture&&!g.isConchApp&&0==this.currDisplayData.type&&this.currDisplayData.uvs&&(this.currTexture=this.currDisplayData.createTexture(this.currTexture))}}else this.displayIndex=-1,this.currDisplayData=null,this.currTexture=null},e.replaceSkin=function(t){this._diyTexture=t,this._curDiyUV&&(this._curDiyUV.length=0),this.currDisplayData&&this._diyTexture==this.currDisplayData.texture&&(this._diyTexture=null)},e.setParentMatrix=function(t){this._parentMatrix=t},e.draw=function(e,i,n,r){if(void 0===n&&(n=!1),void 0===r&&(r=1),(null!=this._diyTexture||null!=this.currTexture)&&null!=this.currDisplayData||this.currDisplayData&&3==this.currDisplayData.type){var a=this.currTexture;this._diyTexture&&(a=this._diyTexture);var s;switch(this.currDisplayData.type){case 0:if(e){var o=this.getDisplayMatrix();if(this._parentMatrix){var l=!1;if(o){p.mul(o,this._parentMatrix,p.TEMP);var h;if(n?(null==this._resultMatrix&&(this._resultMatrix=new p),h=this._resultMatrix):h=new p,!g.isWebGL&&this.currDisplayData.uvs||g.isWebGL&&this._diyTexture&&this.currDisplayData.uvs){var u=t._tempMatrix;u.identity(),this.currDisplayData.uvs[1]>this.currDisplayData.uvs[5]&&(u.d=-1),this.currDisplayData.uvs[0]>this.currDisplayData.uvs[4]&&this.currDisplayData.uvs[1]>this.currDisplayData.uvs[5]&&(l=!0,u.rotate(-Math.PI/2)),p.mul(u,p.TEMP,h)}else p.TEMP.copyTo(h);l?e.drawTexture(a,-this.currDisplayData.height/2,-this.currDisplayData.width/2,this.currDisplayData.height,this.currDisplayData.width,h):e.drawTexture(a,-this.currDisplayData.width/2,-this.currDisplayData.height/2,this.currDisplayData.width,this.currDisplayData.height,h)}}}break;case 1:if(n?(null==this._skinSprite&&(this._skinSprite=t.createSkinMesh()),s=this._skinSprite):s=t.createSkinMesh(),null==s)return;var _;if(null==this.currDisplayData.bones){var c=this.currDisplayData.weights;this.deformData&&(c=this.deformData);var d;this._diyTexture?(this._curDiyUV||(this._curDiyUV=[]),0==this._curDiyUV.length&&(this._curDiyUV=q.getRelativeUV(this.currTexture.uv,this.currDisplayData.uvs,this._curDiyUV),this._curDiyUV=q.getAbsoluteUV(this._diyTexture.uv,this._curDiyUV,this._curDiyUV)),d=this._curDiyUV):d=this.currDisplayData.uvs,this._mVerticleArr=c;this.currDisplayData.triangles.length;_=this.currDisplayData.triangles,s.init2(a,null,_,this._mVerticleArr,d);var f=this.getDisplayMatrix();if(this._parentMatrix&&f){p.mul(f,this._parentMatrix,p.TEMP);var m;n?(null==this._resultMatrix&&(this._resultMatrix=new p),m=this._resultMatrix):m=new p,p.TEMP.copyTo(m),s.transform=m}}else this.skinMesh(i,s,r);e.drawSkin(s);break;case 2:if(n?(null==this._skinSprite&&(this._skinSprite=t.createSkinMesh()),s=this._skinSprite):s=t.createSkinMesh(),null==s)return;this.skinMesh(i,s,r),e.drawSkin(s)}}},e.skinMesh=function(t,e,i){var n,r=this.currTexture,a=this.currDisplayData.bones;this._diyTexture?(r=this._diyTexture,this._curDiyUV||(this._curDiyUV=[]),0==this._curDiyUV.length&&(this._curDiyUV=q.getRelativeUV(this.currTexture.uv,this.currDisplayData.uvs,this._curDiyUV),this._curDiyUV=q.getAbsoluteUV(this._diyTexture.uv,this._curDiyUV,this._curDiyUV)),n=this._curDiyUV):n=this.currDisplayData.uvs;var s,o,l=this.currDisplayData.weights,h=this.currDisplayData.triangles,u=0,_=0,c=0,d=NaN,f=NaN,m=0,p=0,v=[],g=0,E=0;if(this.deformData&&this.deformData.length>0){var x=0;for(g=0,E=a.length;g<E;){for(c=a[g++]+g,u=0,_=0;g<c;g++)o=t[a[g]],d=l[m]+this.deformData[x++],f=l[m+1]+this.deformData[x++],p=l[m+2],u+=(d*o.a+f*o.c+o.tx)*p,_+=(d*o.b+f*o.d+o.ty)*p,m+=3;v.push(u,_)}}else for(g=0,E=a.length;g<E;){for(c=a[g++]+g,u=0,_=0;g<c;g++)o=t[a[g]],d=l[m],f=l[m+1],p=l[m+2],u+=(d*o.a+f*o.c+o.tx)*p,_+=(d*o.b+f*o.d+o.ty)*p,m+=3;v.push(u,_)}this._mVerticleArr=v,s=h,e.init2(r,null,s,this._mVerticleArr,n)},e.drawBonePoint=function(t){t&&this._parentMatrix&&t.drawCircle(this._parentMatrix.tx,this._parentMatrix.ty,5,"#ff0000")},e.getDisplayMatrix=function(){return this.currDisplayData?this.currDisplayData.transform.getMatrix():null},e.getMatrix=function(){return this._resultMatrix},e.copy=function(){var e=new t;return e.type="copy",e.name=this.name,e.attachmentName=this.attachmentName,e.srcDisplayIndex=this.srcDisplayIndex,e.parent=this.parent,e.displayIndex=this.displayIndex,e.templet=this.templet,e.currSlotData=this.currSlotData,e.currTexture=this.currTexture,e.currDisplayData=this.currDisplayData,e},t.createSkinMesh=function(){return g.isWebGL||g.isConchApp?x.skinAniSprite():g.isWebGL?null:rt.useSimpleMeshInCanvas?new nt:new et},n(t,["_tempMatrix",function(){return this._tempMatrix=new p}]),t}(),N=function(){function t(){this.mesh=null,this.transform=null,this.context=null,this.mode=0}r(t,"laya.ani.bone.canvasmesh.CanvasMeshRender");var e=t.prototype;return e.renderToContext=function(t){this.context=t.ctx||t,this.mesh&&(0==this.mode?this._renderWithIndexes(this.mesh):this._renderNoIndexes(this.mesh))},e._renderNoIndexes=function(t){var e=0,i=t.vertices.length/2,n=0;for(e=0;e<i-2;e++)n=2*e,this._renderDrawTriangle(t,n,n+2,n+4)},e._renderWithIndexes=function(t){var e=t.indexes,i=0,n=e.length;for(i=0;i<n;i+=3){var r=2*e[i],a=2*e[i+1],s=2*e[i+2];this._renderDrawTriangle(t,r,a,s)}},e._renderDrawTriangle=function(t,e,i,n){var r=this.context,a=t.uvs,s=t.vertices,o=t.texture,l=o.bitmap,h=l.source,u=o.width,_=o.height,c=l.width,d=l.height,f=NaN,m=NaN,p=NaN,v=NaN,g=NaN,E=NaN;if(t.useUvTransform){var x=t.uvTransform;f=(a[e]*x.a+a[e+1]*x.c+x.tx)*c,m=(a[i]*x.a+a[i+1]*x.c+x.tx)*c,p=(a[n]*x.a+a[n+1]*x.c+x.tx)*c,v=(a[e]*x.b+a[e+1]*x.d+x.ty)*d,g=(a[i]*x.b+a[i+1]*x.d+x.ty)*d,E=(a[n]*x.b+a[n+1]*x.d+x.ty)*d}else f=a[e]*c,m=a[i]*c,p=a[n]*c,v=a[e+1]*d,g=a[i+1]*d,E=a[n+1]*d;var T=s[e],S=s[i],D=s[n],M=s[e+1],y=s[i+1],A=s[n+1];if(t.canvasPadding>0){var I=t.canvasPadding,R=t.canvasPadding,C=(T+S+D)/3,b=(M+y+A)/3,w=T-C,N=M-b,P=Math.sqrt(w*w+N*N);T=C+w/P*(P+I),M=b+N/P*(P+R),w=S-C,N=y-b,P=Math.sqrt(w*w+N*N),S=C+w/P*(P+I),y=b+N/P*(P+R),w=D-C,N=A-b,P=Math.sqrt(w*w+N*N),D=C+w/P*(P+I),A=b+N/P*(P+R)}if(r.save(),this.transform){var L=this.transform;r.transform(L.a,L.b,L.c,L.d,L.tx,L.ty)}r.beginPath(),r.moveTo(T,M),r.lineTo(S,y),r.lineTo(D,A),r.closePath(),r.clip();var O=f*g+v*p+m*E-g*p-v*m-f*E,V=1/O,F=T*g+v*D+S*E-g*D-v*S-T*E,B=f*S+T*p+m*D-S*p-T*m-f*D,U=f*g*D+v*S*p+T*m*E-T*g*p-v*m*D-f*S*E,H=M*g+v*A+y*E-g*A-v*y-M*E,G=f*y+M*p+m*A-y*p-M*m-f*A,z=f*g*A+v*y*p+M*m*E-M*g*p-v*m*A-f*y*E;r.transform(F*V,H*V,B*V,G*V,U*V,z*V),r.drawImage(h,o.uv[0]*c,o.uv[1]*d,u,_,o.uv[0]*c,o.uv[1]*d,u,_),r.restore()},t}(),P=function(){function t(){this.texture=null,this.uvs=[0,0,1,0,1,1,0,1],this.vertices=[0,0,100,0,100,100,0,100],this.indexes=[0,1,3,3,1,2],this.uvTransform=null,this.useUvTransform=!1,this.canvasPadding=1}return r(t,"laya.ani.bone.canvasmesh.MeshData"),t.prototype.getBounds=function(){return v._getWrapRec(this.vertices)},t}(),L=function(){function t(){this.skinName=null,this.deformSlotDataList=[]}return r(t,"laya.ani.bone.DeformAniData"),t}(),O=function(){function t(){this.deformSlotDisplayList=[]}return r(t,"laya.ani.bone.DeformSlotData"),t}(),V=function(){function t(){this.boneSlot=null,this.slotIndex=-1,this.attachment=null,this.deformData=null,this.frameIndex=0,this.timeList=[],this.vectices=[],this.tweenKeyList=[]}r(t,"laya.ani.bone.DeformSlotDisplayData");var e=t.prototype;return e.binarySearch1=function(t,e){var i=0,n=t.length-2;if(0==n)return 1;for(var r=n>>>1;;){if(t[Math.floor(r+1)]<=e?i=r+1:n=r,i==n)return i+1;r=i+n>>>1}return 0},e.apply=function(t,e,i){if(void 0===i&&(i=1),t+=.05,!(this.timeList.length<=0)){var n=0;if(!(t<this.timeList[0])){var r=this.vectices[0].length,a=[],s=this.binarySearch1(this.timeList,t);if(this.frameIndex=s,t>=this.timeList[this.timeList.length-1]){var o=this.vectices[this.vectices.length-1];if(i<1)for(n=0;n<r;n++)a[n]+=(o[n]-a[n])*i;else for(n=0;n<r;n++)a[n]=o[n];return void(this.deformData=a)}var l=(this.tweenKeyList[this.frameIndex],this.vectices[this.frameIndex-1]),h=this.vectices[this.frameIndex],u=this.timeList[this.frameIndex-1],_=this.timeList[this.frameIndex];i=this.tweenKeyList[s-1]?(t-u)/(_-u):0;var c=NaN;for(n=0;n<r;n++)c=l[n],a[n]=c+(h[n]-c)*i;this.deformData=a}}},t}(),F=function(){function t(){this.time=NaN,this.drawOrder=[]}return r(t,"laya.ani.bone.DrawOrderData"),t}(),B=function(){function t(){this.name=null,this.intValue=0,this.floatValue=NaN,this.stringValue=null,this.time=NaN}return r(t,"laya.ani.bone.EventData"),t}(),U=function(){function t(t,e){this._targetBone=null,this._bones=null,this._data=null,this.name=null,this.mix=NaN,this.bendDirection=NaN,this.isSpine=!0,this._sp=null,this.isDebug=!1,this._data=t,this._targetBone=e[t.targetBoneIndex],this.isSpine=t.isSpine,null==this._bones&&(this._bones=[]),this._bones.length=0;for(var i=0,n=t.boneIndexs.length;i<n;i++)this._bones.push(e[t.boneIndexs[i]]);this.name=t.name,this.mix=t.mix,this.bendDirection=t.bendDirection}r(t,"laya.ani.bone.IkConstraint");var e=t.prototype;return e.apply=function(){switch(this._bones.length){case 1:this._applyIk1(this._bones[0],this._targetBone.resultMatrix.tx,this._targetBone.resultMatrix.ty,this.mix);break;case 2:this.isSpine?this._applyIk2(this._bones[0],this._bones[1],this._targetBone.resultMatrix.tx,this._targetBone.resultMatrix.ty,this.bendDirection,this.mix):this._applyIk3(this._bones[0],this._bones[1],this._targetBone.resultMatrix.tx,this._targetBone.resultMatrix.ty,this.bendDirection,this.mix)}},e._applyIk1=function(e,i,n,r){var a=e.parentBone,s=1/(a.resultMatrix.a*a.resultMatrix.d-a.resultMatrix.b*a.resultMatrix.c),o=i-a.resultMatrix.tx,l=n-a.resultMatrix.ty,h=(o*a.resultMatrix.d-l*a.resultMatrix.c)*s-e.transform.x,u=(l*a.resultMatrix.a-o*a.resultMatrix.b)*s-e.transform.y,_=Math.atan2(u,h)*t.radDeg-0-e.transform.skX;e.transform.scX<0&&(_+=180),_>180?_-=360:_<-180&&(_+=360),e.transform.skX=e.transform.skY=e.transform.skX+_*r,e.update()},e.updatePos=function(t,e){this._sp&&this._sp.pos(t,e)},e._applyIk2=function(e,n,r,a,s,o){if(0!=o){var l=e.resultTransform.x,h=e.resultTransform.y,u=e.transform.scX,_=e.transform.scY,c=n.transform.scX,d=0,f=0,m=0;u<0?(u=-u,d=180,m=-1):(d=0,m=1),_<0&&(_=-_,m=-m),c<0?(c=-c,f=180):f=0;var p=n.resultTransform.x,v=NaN,g=NaN,E=NaN,x=e.resultMatrix.a,S=e.resultMatrix.c,D=e.resultMatrix.b,M=e.resultMatrix.d,y=Math.abs(u-_)<=1e-4;y?(v=n.resultTransform.y,g=x*p+S*v+e.resultMatrix.tx,E=D*p+M*v+e.resultMatrix.ty):(v=0,g=x*p+e.resultMatrix.tx,E=D*p+e.resultMatrix.ty),this.isDebug&&(this._sp||(this._sp=new T,i.stage.addChild(this._sp)),this._sp.graphics.clear(),this._sp.graphics.drawCircle(r,a,15,"#ffff00"),this._sp.graphics.drawCircle(g,E,15,"#ff00ff")),e.setRotation(Math.atan2(E-e.resultMatrix.ty,g-e.resultMatrix.tx));var A=e.parentBone;x=A.resultMatrix.a,S=A.resultMatrix.c,D=A.resultMatrix.b,M=A.resultMatrix.d;var I=1/(x*M-S*D),R=r-A.resultMatrix.tx,C=a-A.resultMatrix.ty,b=(R*M-C*S)*I-l,w=(C*x-R*D)*I-h;R=g-A.resultMatrix.tx,C=E-A.resultMatrix.ty;var N=(R*M-C*S)*I-l,P=(C*x-R*D)*I-h,L=Math.sqrt(N*N+P*P),O=n.length*c,V=NaN,F=NaN;if(y){O*=u;var B=(b*b+w*w-L*L-O*O)/(2*L*O);B<-1?B=-1:B>1&&(B=1),F=Math.acos(B)*s,x=L+O*B,S=O*Math.sin(F),V=Math.atan2(w*x-b*S,b*x+w*S)}else{x=u*O,S=_*O;var U=x*x,H=S*S,G=b*b+w*w,z=Math.atan2(w,b);D=H*L*L+U*G-U*H;var k=-2*H*L,W=H-U;if((M=k*k-4*W*D)>0){var X=Math.sqrt(M);k<0&&(X=-X),X=-(k+X)/2;var Y=X/W,Z=D/X,K=Math.abs(Y)<Math.abs(Z)?Y:Z;K*K<=G&&(C=Math.sqrt(G-K*K)*s,V=z-Math.atan2(C,K),F=Math.atan2(C/_,(K-L)/u))}var j=0,q=Number.MAX_VALUE,Q=0,$=0,J=0,tt=0,et=0,it=0;R=L+x,M=R*R,M>tt&&(J=0,tt=M,et=R),R=L-x,M=R*R,M<q&&(j=Math.PI,q=M,Q=R);var nt=Math.acos(-x*L/(U-H));R=x*Math.cos(nt)+L,C=S*Math.sin(nt),M=R*R+C*C,M<q&&(j=nt,q=M,Q=R,$=C),M>tt&&(J=nt,tt=M,et=R,it=C),G<=(q+tt)/2?(V=z-Math.atan2($*s,Q),F=j*s):(V=z-Math.atan2(it*s,et),F=J*s)}var rt=Math.atan2(v,p)*m,at=e.resultTransform.skX;V=(V-rt)*t.radDeg+d-at,V>180?V-=360:V<-180&&(V+=360),e.resultTransform.x=l,e.resultTransform.y=h,e.resultTransform.skX=e.resultTransform.skY=at+V*o,at=n.resultTransform.skX,at%=360,F=((F+rt)*t.radDeg-0)*m+f-at,F>180?F-=360:F<-180&&(F+=360),n.resultTransform.x=p,n.resultTransform.y=v,n.resultTransform.skX=n.resultTransform.skY=n.resultTransform.skY+F*o,e.update()}},e._applyIk3=function(e,n,r,a,s,o){if(0!=o){var l=NaN,h=NaN,u=n.resultMatrix.a*n.length,_=n.resultMatrix.b*n.length,c=u*u+_*_,d=Math.sqrt(c),f=e.resultMatrix.tx,m=e.resultMatrix.ty,p=n.resultMatrix.tx,v=n.resultMatrix.ty,g=p-f,E=v-m,x=g*g+E*E,S=Math.sqrt(x);g=r-e.resultMatrix.tx,E=a-e.resultMatrix.ty;var D=g*g+E*E,M=Math.sqrt(D);if(d+S<=M||M+d<=S||M+S<=d){var y=NaN;y=d+S<=M?1:-1,p=f+y*(r-f)*S/M,v=m+y*(a-m)*S/M}else{var A=(x-c+D)/(2*D),I=Math.sqrt(x-A*A*D)/M,R=f+g*A,C=m+E*A,b=-E*I,w=g*I;s>0?(p=R-b,v=C-w):(p=R+b,v=C+w)}l=p,h=v,this.isDebug&&(this._sp||(this._sp=new T,i.stage.addChild(this._sp)),this._sp.graphics.clear(),this._sp.graphics.drawCircle(f,m,15,"#ff00ff"),this._sp.graphics.drawCircle(r,a,15,"#ffff00"),this._sp.graphics.drawCircle(l,h,15,"#ff00ff"));var N=NaN;N=Math.atan2(h-e.resultMatrix.ty,l-e.resultMatrix.tx),e.setRotation(N);var P;P=t._tempMatrix,P.identity(),P.rotate(N),P.scale(e.resultMatrix.getScaleX(),e.resultMatrix.getScaleY()),P.translate(e.resultMatrix.tx,e.resultMatrix.ty),P.copyTo(e.resultMatrix),e.updateChild();var L=NaN;L=Math.atan2(a-h,r-l),n.setRotation(L);var O;O=t._tempMatrix,O.identity(),O.rotate(L),O.scale(n.resultMatrix.getScaleX(),n.resultMatrix.getScaleY()),O.translate(l,h),P.copyTo(n.resultMatrix),n.updateChild()}},n(t,["radDeg",function(){return this.radDeg=180/Math.PI},"degRad",function(){return this.degRad=Math.PI/180},"_tempMatrix",function(){return this._tempMatrix=new p}]),t}(),H=function(){function t(){this.name=null,this.targetBoneName=null,this.bendDirection=1,this.mix=1,this.isSpine=!0,this.targetBoneIndex=-1,this.boneNames=[],this.boneIndexs=[]}return r(t,"laya.ani.bone.IkConstraintData"),t}(),G=function(){function t(){}return r(t,"laya.ani.bone.MeshTools"),t.findEdge=function(t,e,i){void 0===e&&(e=0),void 0===i&&(i=!0);var n=0,r=0,a=0;for(r=t.length,a=-1,n=0;n<r;n+=2)(a<0||i==t[a+e]<t[n+e])&&(a=n);return a},t.findBestTriangle=function(e){var i=0;i=t.findEdge(e,1,!0);var n=0;n=t.findEdge(e,1,!1);var r=0;r=t.findEdge(e,0,!0);var a=0;a=t.findEdge(e,0,!1);var s;return s=t._bestTriangle,s.length=0,s.push(r,a),s.indexOf(i)<0&&s.push(i),s.indexOf(n)<0&&s.push(n),s},t.solveMesh=function(e,i){i=i||[],i.length=0;var n;n=e.uvs;var r;r=e.vertices;var a,s;s=t.findBestTriangle(n);var o=0,l=0,h=0;o=s[0],l=s[1],h=s[2],t._absArr.length=0,a=t.solvePoints(e.texture.uv,n[o],n[o+1],n[l]-n[o],n[l+1]-n[o+1],n[h]-n[o],n[h+1]-n[o+1],t._absArr);return t.transPoints(a,r[o],r[o+1],r[l]-r[o],r[l+1]-r[o+1],r[h]-r[o],r[h+1]-r[o+1],i)},t.solvePoints=function(e,i,n,r,a,s,o,l){l=l||[];var h=0,u=0;u=e.length;var _;for(h=0;h<u;h+=2)_=t.solve2(e[h],e[h+1],i,n,r,a,s,o),l.push(_[0],_[1]);return l},t.transPoints=function(e,i,n,r,a,s,o,l){l=l||[];var h=0,u=0;u=e.length;for(h=0;h<u;h+=2)t.transPoint(e[h],e[h+1],i,n,r,a,s,o,l);return l},t.transPoint=function(t,e,i,n,r,a,s,o,l){l=l||[];var h=NaN,u=NaN;return h=i+r*t+s*e,u=n+a*t+o*e,l.push(h,u),l},t.solve2=function(e,i,n,r,a,s,o,l,h,u){void 0===h&&(h=!1),u=u||[];var _=NaN,c=NaN;if(0==a)return t.solve2(e,i,n,r,o,l,a,s,!0,u);var d=NaN,f=NaN;return d=e-n,f=i-r,c=(f-d*s/a)/(l-o*s/a),_=(d-c*o)/a,h?u.push(c,_):u.push(_,c),u},t.solve=function(e,i,n,r){return t.solve2(e.x,e.y,i.x,i.y,n.x,n.y,r.x,r.y)},t._bestTriangle=[],t._absArr=[],t}(),z=function(){function t(t,e){this.target=null,this.data=null,this.bones=null,this.position=NaN,this.spacing=NaN,this.rotateMix=NaN,this.translateMix=NaN,this._debugKey=!1,this._spaces=null,this._segments=[],this._curves=[],this.data=t,this.position=t.position,this.spacing=t.spacing,this.rotateMix=t.rotateMix,this.translateMix=t.translateMix,this.bones=[];for(var i=this.data.bones,n=0,r=i.length;n<r;n++)this.bones.push(e[i[n]])}r(t,"laya.ani.bone.PathConstraint");var e=t.prototype;return e.apply=function(t,e){if(this.target){var i=this.translateMix,n=this.translateMix,r=n>0,a=this.data.spacingMode,s="length"==a,o=this.data.rotateMode,l="tangent"==o,h="chainScale"==o,u=[],_=this.bones.length,c=l?_:_+1,d=[];this._spaces=d,d[0]=this.position;var f=this.spacing;if(h||s)for(var m=0,p=c-1;m<p;){var v=this.bones[m],g=v.length,E=g*v.resultMatrix.a,x=g*v.resultMatrix.b;g=Math.sqrt(E*E+x*x),h&&(u[m]=g),d[++m]=s?Math.max(0,g+f):f}else for(m=1;m<c;m++)d[m]=f;var T=this.computeWorldPositions(this.target,t,e,c,l,"percent"==this.data.positionMode,"percent"==a);if(this._debugKey){for(m=0;m<T.length;m++)e.drawCircle(T[m++],T[m++],5,"#00ff00");var S=[];for(m=0;m<T.length;m++)S.push(T[m++],T[m++]);e.drawLines(0,0,S,"#ff0000")}var D=T[0],M=T[1],y=this.data.offsetRotation,A="chain"==o&&0==y,I=NaN;for(m=0,I=3;m<_;m++,I+=3){v=this.bones[m],v.resultMatrix.tx+=(D-v.resultMatrix.tx)*i,v.resultMatrix.ty+=(M-v.resultMatrix.ty)*i,E=T[I],x=T[I+1];var R=E-D,C=x-M;if(h&&0!=(g=u[m])){var b=(Math.sqrt(R*R+C*C)/g-1)*n+1;v.resultMatrix.a*=b,v.resultMatrix.c*=b}if(D=E,M=x,r){var w=v.resultMatrix.a,N=v.resultMatrix.c,P=v.resultMatrix.b,L=v.resultMatrix.d,O=NaN,V=NaN,F=NaN;O=l?T[I-1]:0==d[m+1]?T[I+2]:Math.atan2(C,R),O-=Math.atan2(P,w)-y/180*Math.PI,A&&(V=Math.cos(O),F=Math.sin(O),g=v.length,D+=(g*(V*w-F*P)-R)*n,M+=(g*(F*w+V*P)-C)*n),O>Math.PI?O-=2*Math.PI:O<-Math.PI&&(O+=2*Math.PI),O*=n,V=Math.cos(O),F=Math.sin(O),v.resultMatrix.a=V*w-F*P,v.resultMatrix.c=V*N-F*L,v.resultMatrix.b=F*w+V*P,v.resultMatrix.d=F*N+V*L}}}},e.computeWorldVertices2=function(e,i,n,r,a,s){var o,l,h=e.currDisplayData.bones,u=e.currDisplayData.weights,_=e.currDisplayData.triangles,c=0,d=0,f=0,m=0,p=0,v=0,g=0,E=0,x=0,T=0,S=0;if(null!=h){for(c=0;c<n;c+=2)m=h[d],d+=m+1,f+=m;var D=i;for(p=s,v=3*f;p<r;p+=2){for(g=0,E=0,m=h[d++],m+=d;d<m;d++,v+=3){o=D[h[d]].resultMatrix,x=u[v],T=u[v+1];var M=u[v+2];g+=(x*o.a+T*o.c+o.tx)*M,E+=(x*o.b+T*o.d+o.ty)*M}a[p]=g,a[p+1]=E}}else{_||(_=u),e.deformData&&(_=e.deformData);var y;if(y=e.parent,i)for(S=i.length,c=0;c<S;c++)if(i[c].name==y){l=i[c];break}var A;l&&(A=l.resultMatrix),A||(A=t._tempMt);var I=A.tx,R=A.ty,C=A.a,b=A.b,w=A.c,N=A.d;for(l&&(N*=l.d),d=n,p=s;p<r;d+=2,p+=2)x=_[d],T=_[d+1],a[p]=x*C+T*b+I,a[p+1]=-(x*w+T*N+R)}},e.computeWorldPositions=function(t,e,i,n,r,a,s){var o=(t.currDisplayData.bones,t.currDisplayData.weights,t.currDisplayData.triangles,[]),l=0,h=t.currDisplayData.verLen,u=this.position,_=this._spaces,c=[],d=[],f=h/6,m=-1,p=NaN,v=0,g=0,E=NaN,x=NaN,T=NaN,S=NaN;if(f--,h-=4,this.computeWorldVertices2(t,e,2,h,o,0),this._debugKey)for(l=0;l<o.length;)i.drawCircle(o[l++],o[l++],10,"#ff0000");c=o,this._curves.length=f;var D=this._curves;p=0;var M=c[0],y=c[1],A=0,I=0,R=0,C=0,b=0,w=0,N=NaN,P=NaN,L=NaN,O=NaN,V=NaN,F=NaN,B=NaN,U=NaN,H=0;for(l=0,H=2;l<f;l++,H+=6)A=c[H],I=c[H+1],R=c[H+2],C=c[H+3],b=c[H+4],w=c[H+5],N=.1875*(M-2*A+R),P=.1875*(y-2*I+C),L=.09375*(3*(A-R)-M+b),O=.09375*(3*(I-C)-y+w),V=2*N+L,F=2*P+O,B=.75*(A-M)+N+.16666667*L,U=.75*(I-y)+P+.16666667*O,p+=Math.sqrt(B*B+U*U),B+=V,U+=F,V+=L,F+=O,p+=Math.sqrt(B*B+U*U),B+=V,U+=F,p+=Math.sqrt(B*B+U*U),B+=V+L,U+=F+O,p+=Math.sqrt(B*B+U*U),D[l]=p,M=b,y=w;if(a&&(u*=p),s)for(l=0;l<n;l++)_[l]*=p;var G=this._segments,z=0,k=0;for(l=0,v=0,g=0,k=0;l<n;l++,v+=3)if(x=_[l],u+=x,(E=u)<0)this.addBeforePosition(E,c,0,d,v);else if(E>p)this.addAfterPosition(E-p,c,h-4,d,v);else{for(;;g++)if(S=D[g],!(E>S)){0==g?E/=S:(T=D[g-1],E=(E-T)/(S-T));break}if(g!=m){m=g;var W=6*g;for(M=c[W],y=c[W+1],A=c[W+2],I=c[W+3],R=c[W+4],C=c[W+5],b=c[W+6],w=c[W+7],N=.03*(M-2*A+R),P=.03*(y-2*I+C),L=.006*(3*(A-R)-M+b),O=.006*(3*(I-C)-y+w),V=2*N+L,F=2*P+O,B=.3*(A-M)+N+.16666667*L,U=.3*(I-y)+P+.16666667*O,z=Math.sqrt(B*B+U*U),G[0]=z,W=1;W<8;W++)B+=V,U+=F,V+=L,F+=O,z+=Math.sqrt(B*B+U*U),G[W]=z;B+=V,U+=F,z+=Math.sqrt(B*B+U*U),G[8]=z,B+=V+L,U+=F+O,z+=Math.sqrt(B*B+U*U),G[9]=z,k=0}for(E*=z;;k++)if(S=G[k],!(E>S)){0==k?E/=S:(T=G[k-1],E=k+(E-T)/(S-T));break}this.addCurvePosition(.1*E,M,y,A,I,R,C,b,w,d,v,r||l>0&&0==x)}return d},e.addBeforePosition=function(t,e,i,n,r){var a=e[i],s=e[i+1],o=e[i+2]-a,l=e[i+3]-s,h=Math.atan2(l,o);n[r]=a+t*Math.cos(h),n[r+1]=s+t*Math.sin(h),n[r+2]=h},e.addAfterPosition=function(t,e,i,n,r){var a=e[i+2],s=e[i+3],o=a-e[i],l=s-e[i+1],h=Math.atan2(l,o);n[r]=a+t*Math.cos(h),n[r+1]=s+t*Math.sin(h),n[r+2]=h},e.addCurvePosition=function(t,e,i,n,r,a,s,o,l,h,u,_){0==t&&(t=1e-4);var c=t*t,d=c*t,f=1-t,m=f*f,p=m*f,v=f*t,g=3*v,E=f*g,x=g*t,T=e*p+n*E+a*x+o*d,S=i*p+r*E+s*x+l*d;h[u]=T,h[u+1]=S,h[u+2]=_?Math.atan2(S-(i*m+r*v*2+s*c),T-(e*m+n*v*2+a*c)):0},t.NONE=-1,t.BEFORE=-2,t.AFTER=-3,n(t,["_tempMt",function(){return this._tempMt=new p}]),t}(),k=function(){function t(){this.name=null,this.target=null,this.positionMode=null,this.spacingMode=null,this.rotateMode=null,this.offsetRotation=NaN,this.position=NaN,this.spacing=NaN,this.rotateMix=NaN,this.translateMix=NaN,this.bones=[]}return r(t,"laya.ani.bone.PathConstraintData"),t}(),W=function(){function t(){this.name=null,this.slotArr=[]}return r(t,"laya.ani.bone.SkinData"),t}(),X=function(){function t(){this.name=null,this.attachmentName=null,this.type=0,this.transform=null,this.width=NaN,this.height=NaN,this.texture=null,this.bones=null,this.uvs=null,this.weights=null,this.triangles=null,this.vertices=null,this.lengths=null,this.verLen=0}r(t,"laya.ani.bone.SkinSlotDisplayData");var e=t.prototype;return e.createTexture=function(t){return this.texture?this.texture:(this.texture=new D(t.bitmap,this.uvs),this.uvs[0]>this.uvs[4]&&this.uvs[1]>this.uvs[5]?(this.texture.width=t.height,this.texture.height=t.width,this.texture.offsetX=-t.offsetX,this.texture.offsetY=-t.offsetY,this.texture.sourceWidth=t.sourceHeight,this.texture.sourceHeight=t.sourceWidth):(this.texture.width=t.width,this.texture.height=t.height,this.texture.offsetX=-t.offsetX,this.texture.offsetY=-t.offsetY,this.texture.sourceWidth=t.sourceWidth,this.texture.sourceHeight=t.sourceHeight),g.isWebGL||this.uvs[1]>this.uvs[5]&&(this.texture.offsetY=this.texture.sourceHeight-this.texture.height-this.texture.offsetY),this.texture)},e.destory=function(){this.texture&&this.texture.destroy()},t}(),Y=function(){function t(){this.name=null,this.displayArr=[]}return r(t,"laya.ani.bone.SlotData"),t.prototype.getDisplayByName=function(t){for(var e,i=0,n=this.displayArr.length;i<n;i++)if(e=this.displayArr[i],e.attachmentName==t)return i;return-1},t}(),Z=function(){function t(t,e){this._data=null,this._bones=null,this.target=null,this.rotateMix=NaN,this.translateMix=NaN,this.scaleMix=NaN,this.shearMix=NaN,this._temp=s(2,0),this._data=t,null==this._bones&&(this._bones=[]),this.target=e[t.targetIndex];var i=0,n=0;for(i=0,n=t.boneIndexs.length;i<n;i++)this._bones.push(e[t.boneIndexs[i]]);this.rotateMix=t.rotateMix,this.translateMix=t.translateMix,this.scaleMix=t.scaleMix,this.shearMix=t.shearMix}return r(t,"laya.ani.bone.TfConstraint"),t.prototype.apply=function(){for(var t,e=this.target.resultMatrix.a,i=this.target.resultMatrix.b,n=this.target.resultMatrix.c,r=this.target.resultMatrix.d,a=0,s=this._bones.length;a<s;a++){if(t=this._bones[a],this.rotateMix>0){var o=t.resultMatrix.a,l=t.resultMatrix.b,h=t.resultMatrix.c,u=t.resultMatrix.d,_=Math.atan2(n,e)-Math.atan2(h,o)+this._data.offsetRotation*Math.PI/180;_>Math.PI?_-=2*Math.PI:_<-Math.PI&&(_+=2*Math.PI),_*=this.rotateMix;var c=Math.cos(_),d=Math.sin(_);t.resultMatrix.a=c*o-d*h,t.resultMatrix.b=c*l-d*u,t.resultMatrix.c=d*o+c*h,t.resultMatrix.d=d*l+c*u}if(this.translateMix&&(this._temp[0]=this._data.offsetX,this._temp[1]=this._data.offsetY,this.target.localToWorld(this._temp),t.resultMatrix.tx+=(this._temp[0]-t.resultMatrix.tx)*this.translateMix,t.resultMatrix.ty+=(this._temp[1]-t.resultMatrix.ty)*this.translateMix,t.updateChild()),this.scaleMix>0){var f=Math.sqrt(t.resultMatrix.a*t.resultMatrix.a+t.resultMatrix.c*t.resultMatrix.c),m=Math.sqrt(e*e+n*n),p=f>1e-5?(f+(m-f+this._data.offsetScaleX)*this.scaleMix)/f:0;t.resultMatrix.a*=p,t.resultMatrix.c*=p,f=Math.sqrt(t.resultMatrix.b*t.resultMatrix.b+t.resultMatrix.d*t.resultMatrix.d),m=Math.sqrt(i*i+r*r),p=f>1e-5?(f+(m-f+this._data.offsetScaleY)*this.scaleMix)/f:0,t.resultMatrix.b*=p,t.resultMatrix.d*=p}if(this.shearMix>0){l=t.resultMatrix.b,u=t.resultMatrix.d;var v=Math.atan2(u,l);_=Math.atan2(r,i)-Math.atan2(n,e)-(v-Math.atan2(t.resultMatrix.c,t.resultMatrix.a)),_>Math.PI?_-=2*Math.PI:_<-Math.PI&&(_+=2*Math.PI),_=v+(_+this._data.offsetShearY*Math.PI/180)*this.shearMix,p=Math.sqrt(l*l+u*u),t.resultMatrix.b=Math.cos(_)*p,t.resultMatrix.d=Math.sin(_)*p}}},t}(),K=function(){function t(){this.name=null,this.targetIndex=0,this.rotateMix=NaN,this.translateMix=NaN,this.scaleMix=NaN,this.shearMix=NaN,this.offsetRotation=NaN,this.offsetX=NaN,this.offsetY=NaN,this.offsetScaleX=NaN,this.offsetScaleY=NaN,this.offsetShearY=NaN,this.boneIndexs=[]}return r(t,"laya.ani.bone.TfConstraintData"),t}(),j=function(){function t(){this.skX=0,this.skY=0,this.scX=1,this.scY=1,this.x=0,this.y=0,this.skewX=0,this.skewY=0,this.mMatrix=null}r(t,"laya.ani.bone.Transform");var e=t.prototype;return e.initData=function(t){void 0!=t.x&&(this.x=t.x),void 0!=t.y&&(this.y=t.y),void 0!=t.skX&&(this.skX=t.skX),void 0!=t.skY&&(this.skY=t.skY),void 0!=t.scX&&(this.scX=t.scX),void 0!=t.scY&&(this.scY=t.scY)},e.getMatrix=function(){var t;return t=this.mMatrix?this.mMatrix:this.mMatrix=new p,t.identity(),t.scale(this.scX,this.scY),(this.skewX||this.skewY)&&this.skew(t,this.skewX*Math.PI/180,this.skewY*Math.PI/180),t.rotate(this.skX*Math.PI/180),t.translate(this.x,this.y),t},e.skew=function(t,e,i){var n=Math.sin(i),r=Math.cos(i),a=Math.sin(e),s=Math.cos(e);return t.setTo(t.a*s-t.b*n,t.a*a+t.b*r,t.c*s-t.d*n,t.c*a+t.d*r,t.tx*s-t.ty*n,t.tx*a+t.ty*r),t},t}(),q=function(){function t(){}return r(t,"laya.ani.bone.UVTools"),t.getRelativeUV=function(t,e,i){var n=t[0],r=t[2]-t[0],a=t[1],s=t[5]-t[1];i||(i=[]),i.length=e.length;var o=0,l=0;l=i.length;var h=1/r,u=1/s;for(o=0;o<l;o+=2)i[o]=(e[o]-n)*h,i[o+1]=(e[o+1]-a)*u;return i},t.getAbsoluteUV=function(t,e,i){if(0==t[0]&&0==t[1]&&1==t[4]&&1==t[5])return i?(y.copyArray(i,e),i):e;var n=t[0],r=t[2]-t[0],a=t[1],s=t[5]-t[1];i||(i=[]),i.length=e.length;var o=0,l=0;for(l=i.length,o=0;o<l;o+=2)i[o]=e[o]*r+n,i[o+1]=e[o+1]*s+a;return i},t}(),Q=function(){function t(){this.startTime=NaN,this.duration=NaN,this.interpolationData=null,this.data=null,this.nextData=null}return r(t,"laya.ani.KeyFramesContent"),t}(),$=function(){function t(){}return r(t,"laya.ani.math.BezierLerp"),t.getBezierRate=function(e,i,n,r,a){var s=t._getBezierParamKey(i,n,r,a),o=100*s+e;if(t._bezierResultCache[o])return t._bezierResultCache[o];var l=t._getBezierPoints(i,n,r,a,s),h=0,u=0;for(u=l.length,h=0;h<u;h+=2)if(e<=l[h])return t._bezierResultCache[o]=l[h+1],l[h+1];return t._bezierResultCache[o]=1,1},t._getBezierParamKey=function(t,e,i,n){return 100*(100*(100*(100*t+e)+i)+n)},t._getBezierPoints=function(e,i,n,r,a){if(t._bezierPointsCache[a])return t._bezierPointsCache[a];var s;s=[0,0,e,i,n,r,1,1];var l;l=new o;var h;return h=l.getBezierPoints(s,100,3),t._bezierPointsCache[a]=h,h},t._bezierResultCache={},t._bezierPointsCache={},t}(),J=function(t){function e(){this._destroyed=!1,this._templet=null,this._currentTime=NaN,this._currentFrameTime=NaN,this._playStart=NaN,this._playEnd=NaN,this._playDuration=NaN,this._overallDuration=NaN,this._stopWhenCircleFinish=!1,this._elapsedPlaybackTime=NaN,this._startUpdateLoopCount=NaN,this._currentAnimationClipIndex=0,this._currentKeyframeIndex=0,this._paused=!1,this._cacheFrameRate=0,this._cacheFrameRateInterval=NaN,this._cachePlayRate=NaN,this._fullFrames=null,this.isCache=!0,this.playbackRate=1,this.returnToZeroStopped=!1,e.__super.call(this),this._destroyed=!1,this._currentAnimationClipIndex=-1,this._currentKeyframeIndex=-1,this._currentTime=0,this._overallDuration=Number.MAX_VALUE,this._stopWhenCircleFinish=!1,this._elapsedPlaybackTime=0,this._startUpdateLoopCount=-1,this._cachePlayRate=1,this.cacheFrameRate=60,this.returnToZeroStopped=!1}r(e,"laya.ani.AnimationPlayer",t);var n=e.prototype;return i.imps(n,{"laya.resource.IDestroy":!0}),n._onTempletLoadedComputeFullKeyframeIndices=function(t,e,i){this._templet===i&&this._cachePlayRate===t&&this._cacheFrameRate===e&&this._computeFullKeyframeIndices()},n._computeFullKeyframeIndices=function(){for(var t=this._fullFrames=[],e=this._templet,i=this._cacheFrameRateInterval*this._cachePlayRate,n=0,r=e.getAnimationCount();n<r;n++){for(var a=[],s=0,o=e.getAnimation(n).nodes.length;s<o;s++){for(var l=e.getAnimation(n).nodes[s],h=Math.floor(l.playTime/i+.01),u=new Uint16Array(h+1),_=-1,c=0,d=l.keyFrame.length;c<d;c++){var f=l.keyFrame[c],m=f.startTime,p=m+f.duration+i;do{for(var v=Math.floor(m/i+.5),g=_+1;g<v;g++)u[g]=c;_=v,u[v]=c,m+=i}while(m<=p)}a.push(u)}t.push(a)}},n._onAnimationTempletLoaded=function(){this.destroyed||this._calculatePlayDuration()},n._calculatePlayDuration=function(){if(0!==this.state){var t=this._templet.getAniDuration(this._currentAnimationClipIndex);0===this._playEnd&&(this._playEnd=t),this._playEnd>t&&(this._playEnd=t),this._playDuration=this._playEnd-this._playStart}},n._setPlayParams=function(t,e){this._currentTime=t,this._currentKeyframeIndex=Math.max(Math.floor(this.currentPlayTime/e+.01),0),this._currentFrameTime=this._currentKeyframeIndex*e},n._setPlayParamsWhenStop=function(t,e){this._currentTime=t,this._currentKeyframeIndex=Math.max(Math.floor(t/e+.01),0),this._currentFrameTime=this._currentKeyframeIndex*e,this._currentAnimationClipIndex=-1},n._update=function(t){if(-1!==this._currentAnimationClipIndex&&!this._paused&&this._templet&&this._templet.loaded){var e=this._cacheFrameRateInterval*this._cachePlayRate,i=0;this._startUpdateLoopCount!==S.loopCount&&(i=t*this.playbackRate,this._elapsedPlaybackTime+=i);var n=this.playDuration;if(0!==this._overallDuration&&this._elapsedPlaybackTime>=this._overallDuration||0===this._overallDuration&&this._elapsedPlaybackTime>=n)return this._setPlayParamsWhenStop(n,e),void this.event("stopped");if(i+=this._currentTime,n>0)if(i>=n)do{if(i-=n,this._stopWhenCircleFinish)return this._setPlayParamsWhenStop(n,e),this._stopWhenCircleFinish=!1,void this.event("stopped");i<n&&(this._setPlayParams(i,e),this.event("complete"))}while(i>=n);else this._setPlayParams(i,e);else{if(this._stopWhenCircleFinish)return this._setPlayParamsWhenStop(n,e),this._stopWhenCircleFinish=!1,void this.event("stopped");this._currentTime=this._currentFrameTime=this._currentKeyframeIndex=0,this.event("complete")}}},n._destroy=function(){this.offAll(),this._templet=null,this._fullFrames=null,this._destroyed=!0},n.play=function(t,e,i,n,r){if(void 0===t&&(t=0),void 0===e&&(e=1),void 0===i&&(i=2147483647),void 0===n&&(n=0),void 0===r&&(r=0),!this._templet)throw new Error("AnimationPlayer:templet must not be null,maybe you need to set url.");if(i<0||n<0||r<0)throw new Error("AnimationPlayer:overallDuration,playStart and playEnd must large than zero.");if(0!==r&&n>r)throw new Error("AnimationPlayer:start must less than end.");this._currentTime=0,this._currentFrameTime=0,this._elapsedPlaybackTime=0,this.playbackRate=e,this._overallDuration=i,this._playStart=n,this._playEnd=r,this._paused=!1,this._currentAnimationClipIndex=t,this._currentKeyframeIndex=0,this._startUpdateLoopCount=S.loopCount,this.event("played"),this._templet.loaded?this._calculatePlayDuration():this._templet.once("loaded",this,this._onAnimationTempletLoaded),this._update(0)},n.playByFrame=function(t,e,i,n,r,a){void 0===t&&(t=0),void 0===e&&(e=1),void 0===i&&(i=2147483647),void 0===n&&(n=0),void 0===r&&(r=0),void 0===a&&(a=30);var s=1e3/a;this.play(t,e,i,n*s,r*s)},n.stop=function(t){void 0===t&&(t=!0),t?(this._currentTime=this._currentFrameTime=this._currentKeyframeIndex=0,this._currentAnimationClipIndex=-1,this.event("stopped")):this._stopWhenCircleFinish=!0},a(0,n,"playEnd",function(){return this._playEnd}),a(0,n,"templet",function(){return this._templet},function(t){0===!this.state&&this.stop(!0),this._templet!==t&&(this._templet=t,t.loaded?this._computeFullKeyframeIndices():t.once("loaded",this,this._onTempletLoadedComputeFullKeyframeIndices,[this._cachePlayRate,this._cacheFrameRate]))}),a(0,n,"playStart",function(){return this._playStart}),a(0,n,"playDuration",function(){return this._playDuration}),a(0,n,"state",function(){return-1===this._currentAnimationClipIndex?0:this._paused?1:2}),a(0,n,"currentKeyframeIndex",function(){return this._currentKeyframeIndex}),a(0,n,"overallDuration",function(){return this._overallDuration}),a(0,n,"currentFrameTime",function(){return this._currentFrameTime}),a(0,n,"currentAnimationClipIndex",function(){return this._currentAnimationClipIndex}),a(0,n,"currentPlayTime",function(){return this._currentTime+this._playStart}),a(0,n,"cachePlayRate",function(){return this._cachePlayRate},function(t){this._cachePlayRate!==t&&(this._cachePlayRate=t,this._templet&&(this._templet.loaded?this._computeFullKeyframeIndices():this._templet.once("loaded",this,this._onTempletLoadedComputeFullKeyframeIndices,[t,this._cacheFrameRate])))}),a(0,n,"cacheFrameRate",function(){return this._cacheFrameRate},function(t){this._cacheFrameRate!==t&&(this._cacheFrameRate=t,this._cacheFrameRateInterval=1e3/this._cacheFrameRate,this._templet&&(this._templet.loaded?this._computeFullKeyframeIndices():this._templet.once("loaded",this,this._onTempletLoadedComputeFullKeyframeIndices,[this._cachePlayRate,t])))}),a(0,n,"currentTime",null,function(t){if(-1!==this._currentAnimationClipIndex&&this._templet&&this._templet.loaded){if(t<this._playStart||t>this._playEnd)throw new Error("AnimationPlayer:value must large than playStartTime,small than playEndTime.");this._startUpdateLoopCount=S.loopCount;var e=this._cacheFrameRateInterval*this._cachePlayRate;this._currentTime=t,this._currentKeyframeIndex=Math.max(Math.floor(this.currentPlayTime/e),0),this._currentFrameTime=this._currentKeyframeIndex*e}}),a(0,n,"paused",function(){return this._paused},function(t){this._paused=t,t&&this.event("paused")}),a(0,n,"cacheFrameRateInterval",function(){return this._cacheFrameRateInterval}),a(0,n,"destroyed",function(){return this._destroyed}),e}(u),tt=function(t){function e(){e.__super.call(this),g.isConchNode&&(this.drawSkin=function(t){t.transform||(t.transform=p.EMPTY),this.setSkinMesh&&this.setSkinMesh(t._ps,t.mVBData,t.mEleNum,0,t.mTexture,t.transform)})}return r(e,"laya.ani.GraphicsAni",t),e.prototype.drawSkin=function(t){var e=[t];this._saveToCmd(g._context._drawSkin,e)},e}(_),et=function(t){function e(){e.__super.call(this),this.mesh=new P}r(e,"laya.ani.bone.canvasmesh.SkinMeshCanvas",t);var i=e.prototype;return i.init2=function(t,e,i,n,r){this.transform&&(this.transform=null);var a;i?a=i:(a=[],a.push(0,1,3,3,1,2)),this.mesh.texture=t,this.mesh.indexes=a,this.mesh.vertices=n,this.mesh.uvs=r},i.render=function(t,i,n){this.mesh.texture&&(this.transform?(this.transform.translate(i,n),this.renderToContext(t),this.transform.translate(-i,-n)):(this.transform=e._tempMatrix,this.transform.identity(),this.transform.translate(i,n),this.renderToContext(t),this.transform.translate(-i,-n),this.transform=null))},n(e,["_tempMatrix",function(){return this._tempMatrix=new p}]),e}(N),it=function(t){function e(){this._aniMap={},this.unfixedLastAniIndex=-1,e.__super.call(this),this._anis=new Array}r(e,"laya.ani.AnimationTemplet",t);var a=e.prototype;return a.parse=function(t){var e=new h(t);this._aniVersion=e.readUTFString(),R.parse(this,e)},a._calculateKeyFrame=function(t,e,i){var n=t.keyFrame;n[e]=n[0];for(var r=0;r<e;r++){var a=n[r];a.nextData=0===a.duration?a.data:n[r+1].data}n.length--},a.onAsynLoaded=function(t,e,i){var n=new h(e);switch(this._aniVersion=n.readUTFString(),this._aniVersion){case"LAYAANIMATION:02":C.parse(this,n);break;default:R.parse(this,n)}this._endLoaded()},a.disposeResource=function(){this._aniVersion=null,this._anis=null,this._aniMap=null,this._publicExtData=null,this.unfixedCurrentFrameIndexes=null,this.unfixedCurrentTimes=null,this.unfixedKeyframes=null,this._aniClassName=null,this._animationDatasCache=null},a.getAnimationCount=function(){return this._anis.length},a.getAnimation=function(t){return this._anis[t]},a.getAniDuration=function(t){return this._anis[t].playTime},a.getNodes=function(t){return this._anis[t].nodes},a.getNodeIndexWithName=function(t,e){return this._anis[t].bone3DMap[e]},a.getNodeCount=function(t){return this._anis[t].nodes.length},a.getTotalkeyframesLength=function(t){return this._anis[t].totalKeyframeDatasLength},a.getPublicExtData=function(){return this._publicExtData},a.getAnimationDataWithCache=function(t,e,i,n){var r=e[i];if(r){var a=r[t];return a?a[n]:null}return null},a.setAnimationDataWithCache=function(t,e,i,n,r){var a=e[i]||(e[i]={});(a[t]||(a[t]=[]))[n]=r},a.getOriginalData=function(t,i,n,r,a){for(var s=this._anis[t],o=s.nodes,l=0,h=0,u=o.length,_=0;h<u;h++){var c,d=o[h];c=d.keyFrame[n[h][r]],d.dataOffset=_;var f=a-c.startTime,m=d.lerpType;if(m)switch(m){case 0:case 1:for(l=0;l<d.keyframeWidth;)l+=d.interpolationMethod[l](d,l,i,_+l,c.data,f,null,c.duration,c.nextData);break;case 2:var p=c.interpolationData,v=p.length,g=0;for(l=0;l<v;){var E=p[l];switch(E){case 6:case 7:l+=e.interpolation[E](d,g,i,_+g,c.data,f,null,c.duration,c.nextData,p,l+1);break;default:l+=e.interpolation[E](d,g,i,_+g,c.data,f,null,c.duration,c.nextData)}g++}}else for(l=0;l<d.keyframeWidth;)l+=d.interpolationMethod[l](d,l,i,_+l,c.data,f,null,c.duration,c.nextData);_+=d.keyframeWidth}},a.getNodesCurrentFrameIndex=function(t,e){var i=this._anis[t],n=i.nodes;t!==this.unfixedLastAniIndex&&(this.unfixedCurrentFrameIndexes=new Uint32Array(n.length),this.unfixedCurrentTimes=new Float32Array(n.length),this.unfixedLastAniIndex=t);for(var r=0,a=n.length;r<a;r++){var s=n[r];for(e<this.unfixedCurrentTimes[r]&&(this.unfixedCurrentFrameIndexes[r]=0),this.unfixedCurrentTimes[r]=e;this.unfixedCurrentFrameIndexes[r]<s.keyFrame.length&&!(s.keyFrame[this.unfixedCurrentFrameIndexes[r]].startTime>this.unfixedCurrentTimes[r]);)this.unfixedCurrentFrameIndexes[r]++;this.unfixedCurrentFrameIndexes[r]--}return this.unfixedCurrentFrameIndexes},a.getOriginalDataUnfixedRate=function(t,i,n){var r=this._anis[t],a=r.nodes;t!==this.unfixedLastAniIndex&&(this.unfixedCurrentFrameIndexes=new Uint32Array(a.length),this.unfixedCurrentTimes=new Float32Array(a.length),this.unfixedKeyframes=s(a.length),this.unfixedLastAniIndex=t);for(var o=0,l=0,h=a.length,u=0;l<h;l++){var _=a[l];for(n<this.unfixedCurrentTimes[l]&&(this.unfixedCurrentFrameIndexes[l]=0),this.unfixedCurrentTimes[l]=n;this.unfixedCurrentFrameIndexes[l]<_.keyFrame.length&&!(_.keyFrame[this.unfixedCurrentFrameIndexes[l]].startTime>this.unfixedCurrentTimes[l]);)this.unfixedKeyframes[l]=_.keyFrame[this.unfixedCurrentFrameIndexes[l]],this.unfixedCurrentFrameIndexes[l]++;var c=this.unfixedKeyframes[l];_.dataOffset=u;var d=n-c.startTime;if(_.lerpType)switch(_.lerpType){case 0:case 1:for(o=0;o<_.keyframeWidth;)o+=_.interpolationMethod[o](_,o,i,u+o,c.data,d,null,c.duration,c.nextData);break;case 2:var f=c.interpolationData,m=f.length,p=0;for(o=0;o<m;){var v=f[o];switch(v){case 6:case 7:o+=e.interpolation[v](_,p,i,u+p,c.data,d,null,c.duration,c.nextData,f,o+1);break;default:o+=e.interpolation[v](_,p,i,u+p,c.data,d,null,c.duration,c.nextData)}p++}}else for(o=0;o<_.keyframeWidth;)o+=_.interpolationMethod[o](_,o,i,u+o,c.data,d,null,c.duration,c.nextData);u+=_.keyframeWidth}},e._LinearInterpolation_0=function(t,e,i,n,r,a,s,o,l,h){var u=0===o?0:a/o;return i[n]=(1-u)*r[e]+u*l[e],1},e._QuaternionInterpolation_1=function(t,e,i,n,r,a,s,o,l,h){var u=0===o?0:a/o;return m.slerpQuaternionArray(r,e,l,e,u,i,n),4},e._AngleInterpolation_2=function(t,e,i,n,r,a,s,o,l,h){return 0},e._RadiansInterpolation_3=function(t,e,i,n,r,a,s,o,l,h){return 0},e._Matrix4x4Interpolation_4=function(t,e,i,n,r,a,s,o,l,h){for(var u=0;u<16;u++,e++)i[n+u]=r[e]+a*s[e];return 16},e._NoInterpolation_5=function(t,e,i,n,r,a,s,o,l,h){return i[n]=r[e],1},e._BezierInterpolation_6=function(t,e,i,n,r,a,s,o,l,h,u){return void 0===u&&(u=0),i[n]=r[e]+(l[e]-r[e])*$.getBezierRate(a/o,h[u],h[u+1],h[u+2],h[u+3]),5},e._BezierInterpolation_7=function(t,e,i,n,r,a,s,o,l,h,u){return void 0===u&&(u=0),i[n]=h[u+4]+h[u+5]*$.getBezierRate((.001*a+h[u+6])/h[u+7],h[u],h[u+1],h[u+2],h[u+3]),9},e.load=function(t){return i.loader.create(t,null,null,e)},n(e,["interpolation",function(){return this.interpolation=[e._LinearInterpolation_0,e._QuaternionInterpolation_1,e._AngleInterpolation_2,e._RadiansInterpolation_3,e._Matrix4x4Interpolation_4,e._NoInterpolation_5,e._BezierInterpolation_6,e._BezierInterpolation_7]}]),e}(E),nt=(function(t){function e(){this.isCached=!1,this.canvas=null,this.tex=null,this.rec=null,e.__super.call(this)}r(e,"laya.ani.bone.canvasmesh.CacheAbleSkinMesh",t);var i=e.prototype;i.getCanvasPic=function(){var t=new c("2D"),i=t.getContext("2d");this.rec=this.mesh.getBounds(),t.size(this.rec.width,this.rec.height);var n;return n=this.transform,this.transform=e.tempMt,this.transform.identity(),this.transform.translate(-this.rec.x,-this.rec.y),this.renderToContext(i),this.transform.translate(+this.rec.x,+this.rec.y),this.transform=n,new D(t)},i.render=function(t,e,i){this.mesh.texture&&(this.isCached||(this.isCached=!0,this.tex=this.getCanvasPic()),this.transform?(this.transform.translate(e,i),this._renderTextureToContext(t),this.transform.translate(-e,-i)):(this.transform=et._tempMatrix,this.transform.identity(),this.transform.translate(e,i),this._renderTextureToContext(t),this.transform.translate(-e,-i),this.transform=null))},i._renderTextureToContext=function(t){this.context=t.ctx||t,t.save();var e;if(e=this.tex,this.transform){var i=this.transform;t.transform(i.a,i.b,i.c,i.d,i.tx,i.ty)}this.rec=this.mesh.getBounds(),t.translate(this.rec.x,this.rec.y),t.drawTexture(e,0,0,e.width,e.height,0,0),t.restore()},n(e,["tempMt",function(){return this.tempMt=new p}])}(et),function(t){function e(){this.cacheOK=!1,this.cacheCmdOK=!1,this.transformCmds=[],this.drawCmds=[],e.__super.call(this),this.tempMesh=new P}r(e,"laya.ani.bone.canvasmesh.SimpleSkinMeshCanvas",t);var i=e.prototype;return i.init2=function(e,i,n,r,a){t.prototype.init2.call(this,e,i,n,r,a),this.cacheOK=!1,this.cacheCmdOK=!1,this.transformCmds.length=6,this.drawCmds.length=9},i.renderToContext=function(t){if(this.context=t.ctx||t,this.mesh){if(this.mesh.uvs.length<=8)return void(0==this.mode?this._renderWithIndexes(this.mesh):this._renderNoIndexes(this.mesh));this.cacheOK||(this.tempMesh.texture=this.mesh.texture,this.tempMesh.uvs=this.mesh.texture.uv,this.tempMesh.vertices=G.solveMesh(this.mesh,this.tempMesh.vertices),this.cacheOK=!0),0==this.mode?this._renderWithIndexes(this.tempMesh):this._renderNoIndexes(this.tempMesh)}},i._renderWithIndexes=function(t){if(this.cacheCmdOK)return void this.renderByCache(t);var e=t.indexes,i=0,n=e.length;for(n>1&&(n=1),i=0;i<n;i+=3){var r=2*e[i],a=2*e[i+1],s=2*e[i+2];this._renderDrawTriangle(t,r,a,s)}this.cacheCmdOK=!0},i._renderDrawTriangle=function(t,e,i,n){var r=this.context,a=t.uvs,s=t.vertices,o=t.texture,l=o.bitmap,h=l.source,u=o.width,_=o.height,c=l.width,d=l.height,f=NaN,m=NaN,p=NaN,v=NaN,g=NaN,E=NaN;if(t.useUvTransform){var x=t.uvTransform;f=(a[e]*x.a+a[e+1]*x.c+x.tx)*c,m=(a[i]*x.a+a[i+1]*x.c+x.tx)*c,p=(a[n]*x.a+a[n+1]*x.c+x.tx)*c,v=(a[e]*x.b+a[e+1]*x.d+x.ty)*d,g=(a[i]*x.b+a[i+1]*x.d+x.ty)*d,E=(a[n]*x.b+a[n+1]*x.d+x.ty)*d}else f=a[e]*c,m=a[i]*c,p=a[n]*c,v=a[e+1]*d,g=a[i+1]*d,E=a[n+1]*d;var T=s[e],S=s[i],D=s[n],M=s[e+1],y=s[i+1],A=s[n+1],I=f*g+v*p+m*E-g*p-v*m-f*E,R=1/I,C=T*g+v*D+S*E-g*D-v*S-T*E,b=f*S+T*p+m*D-S*p-T*m-f*D,w=f*g*D+v*S*p+T*m*E-T*g*p-v*m*D-f*S*E,N=M*g+v*A+y*E-g*A-v*y-M*E,P=f*y+M*p+m*A-y*p-M*m-f*A,L=f*g*A+v*y*p+M*m*E-M*g*p-v*m*A-f*y*E;if(this.transformCmds[0]=C*R,this.transformCmds[1]=N*R,this.transformCmds[2]=b*R,this.transformCmds[3]=P*R,this.transformCmds[4]=w*R,this.transformCmds[5]=L*R,this.drawCmds[0]=h,this.drawCmds[1]=o.uv[0]*c,this.drawCmds[2]=o.uv[1]*d,this.drawCmds[3]=u,this.drawCmds[4]=_,this.drawCmds[5]=o.uv[0]*c,this.drawCmds[6]=o.uv[1]*d,this.drawCmds[7]=u,this.drawCmds[8]=_,r.save(),this.transform){var O=this.transform;r.transform(O.a,O.b,O.c,O.d,O.tx,O.ty)}r.transform.apply(r,this.transformCmds),r.drawImage.apply(r,this.drawCmds),r.restore()},i.renderByCache=function(t){var e=this.context;if(e.save(),this.transform){var i=this.transform;e.transform(i.a,i.b,i.c,i.d,i.tx,i.ty)}e.transform.apply(e,this.transformCmds),e.drawImage.apply(e,this.drawCmds),e.restore()},e}(et)),rt=function(t){function e(t,i){this._templet=null,this._player=null,this._curOriginalData=null,this._boneMatrixArray=[],this._lastTime=0,this._currAniName=null,this._currAniIndex=-1,this._pause=!0,this._aniClipIndex=-1,this._clipIndex=-1,this._skinIndex=0,this._skinName="default",this._aniMode=0,this._graphicsCache=null,this._boneSlotDic=null,this._bindBoneBoneSlotDic=null,this._boneSlotArray=null,this._index=-1,this._total=-1,this._indexControl=!1,this._aniPath=null,this._texturePath=null,this._complete=null,this._loadAniMode=0,this._yReverseMatrix=null,this._ikArr=null,this._tfArr=null,this._pathDic=null,this._rootBone=null,this._boneList=null,this._aniSectionDic=null,this._eventIndex=0,this._drawOrderIndex=0,this._drawOrder=null,this._lastAniClipIndex=-1,this._lastUpdateAniClipIndex=-1,e.__super.call(this),void 0===i&&(i=0),t&&this.init(t,i)}r(e,"laya.ani.bone.Skeleton",t);var n=e.prototype;return n.init=function(t,e){void 0===e&&(e=0);var i=0,n=0;if(1==e)for(this._graphicsCache=[],i=0,n=t.getAnimationCount();i<n;i++)this._graphicsCache.push([]);if(this._yReverseMatrix=t.yReverseMatrix,this._aniMode=e,this._templet=t,this._player=new J,this._player.cacheFrameRate=t.rate,this._player.templet=t,this._player.play(),this._parseSrcBoneMatrix(),this._boneList=t.mBoneArr,this._rootBone=t.mRootBone,this._aniSectionDic=t.aniSectionDic,t.ikArr.length>0)for(this._ikArr=[],i=0,n=t.ikArr.length;i<n;i++)this._ikArr.push(new U(t.ikArr[i],this._boneList));if(t.pathArr.length>0){var r,a;null==this._pathDic&&(this._pathDic={});var s;for(i=0,n=t.pathArr.length;i<n;i++)r=t.pathArr[i],a=new z(r,this._boneList),s=this._boneSlotDic[r.name],s&&(a=new z(r,this._boneList),a.target=s),this._pathDic[r.name]=a}if(t.tfArr.length>0)for(this._tfArr=[],i=0,n=t.tfArr.length;i<n;i++)this._tfArr.push(new Z(t.tfArr[i],this._boneList));if(t.skinDataArray.length>0){var o=this._templet.skinDataArray[this._skinIndex];this._skinName=o.name}this._player.on("played",this,this._onPlay),this._player.on("stopped",this,this._onStop),this._player.on("paused",this,this._onPause)},n.load=function(t,e,n){void 0===n&&(n=0),this._aniPath=t,this._complete=e,this._loadAniMode=n,i.loader.load([{url:t,type:"arraybuffer"}],d.create(this,this._onLoaded))},n._onLoaded=function(){var t=f.getRes(this._aniPath);if(null!=t){null==at.TEMPLET_DICTIONARY&&(at.TEMPLET_DICTIONARY={});var e;e=at.TEMPLET_DICTIONARY[this._aniPath],e?e.isParseFail?this._parseFail():e.isParserComplete?this._parseComplete():(e.on("complete",this,this._parseComplete),e.on("error",this,this._parseFail)):(e=new at,e._setUrl(this._aniPath),at.TEMPLET_DICTIONARY[this._aniPath]=e,e.on("complete",this,this._parseComplete),e.on("error",this,this._parseFail),e.isParserComplete=!1,e.parseData(null,t))}},n._parseComplete=function(){var t=at.TEMPLET_DICTIONARY[this._aniPath];t&&(this.init(t,this._loadAniMode),this.play(0,!0)),this._complete&&this._complete.runWith(this)},n._parseFail=function(){console.log("[Error]:"+this._aniPath+"解析失败")},n._onPlay=function(){this.event("played")},n._onStop=function(){var t,e=this._templet.eventAniArr,i=e[this._aniClipIndex];if(i&&this._eventIndex<i.length)for(;this._eventIndex<i.length;this._eventIndex++)t=i[this._eventIndex],t.time>=this._player.playStart&&t.time<=this._player.playEnd&&this.event("label",t);this._eventIndex=0,this._drawOrder=null,this.event("stopped")},n._onPause=function(){this.event("paused")},n._parseSrcBoneMatrix=function(){var t=0,e=0;for(e=this._templet.srcBoneMatrixArr.length,t=0;t<e;t++)this._boneMatrixArray.push(new p);if(0==this._aniMode)this._boneSlotDic=this._templet.boneSlotDic,this._bindBoneBoneSlotDic=this._templet.bindBoneBoneSlotDic,this._boneSlotArray=this._templet.boneSlotArray;else{null==this._boneSlotDic&&(this._boneSlotDic={}),null==this._bindBoneBoneSlotDic&&(this._bindBoneBoneSlotDic={}),null==this._boneSlotArray&&(this._boneSlotArray=[]);var i,n,r=this._templet.boneSlotArray;for(t=0,e=r.length;t<e;t++)i=r[t],n=this._bindBoneBoneSlotDic[i.parent],null==n&&(this._bindBoneBoneSlotDic[i.parent]=n=[]),this._boneSlotDic[i.name]=i=i.copy(),n.push(i),this._boneSlotArray.push(i)}},n._emitMissedEvents=function(t,e,i){void 0===i&&(i=0);var n=this._templet.eventAniArr,r=n[this._player.currentAnimationClipIndex];if(r){var a,s=0,o=0;for(o=r.length,s=i;s<o;s++)a=r[s],a.time>=this._player.playStart&&a.time<=this._player.playEnd&&this.event("label",a)}},n._update=function(t){if(void 0===t&&(t=!0),!(this._pause||t&&this._indexControl)){var e=this.timer.currTimer,i=this._player.currentKeyframeIndex,n=e-this._lastTime;if(t?this._player._update(n):i=-1,this._lastTime=e,this._player&&(this._index=this._clipIndex=this._player.currentKeyframeIndex,!(this._index<0||n>0&&this._clipIndex==i&&this._lastUpdateAniClipIndex==this._aniClipIndex))){this._lastUpdateAniClipIndex=this._aniClipIndex,i>this._clipIndex&&0!=this._eventIndex&&(this._emitMissedEvents(this._player.playStart,this._player.playEnd,this._eventIndex),this._eventIndex=0);var r,a=this._templet.eventAniArr,s=a[this._aniClipIndex];s&&this._eventIndex<s.length&&(r=s[this._eventIndex],r.time>=this._player.playStart&&r.time<=this._player.playEnd?this._player.currentPlayTime>=r.time&&(this.event("label",r),this._eventIndex++):this._eventIndex++);var o;if(0==this._aniMode){if(o=this._templet.getGrahicsDataWithCache(this._aniClipIndex,this._clipIndex))return void(this.graphics!=o&&(this.graphics=o));var l=0,h=0;for(h=this._clipIndex;!this._templet.getGrahicsDataWithCache(this._aniClipIndex,h-1)&&h>0;)h--;if(h<this._clipIndex)for(l=h;l<this._clipIndex;l++)this._createGraphics(l)}else if(1==this._aniMode){if(o=this._getGrahicsDataWithCache(this._aniClipIndex,this._clipIndex))return void(this.graphics!=o&&(this.graphics=o));for(h=this._clipIndex;!this._getGrahicsDataWithCache(this._aniClipIndex,h-1)&&h>0;)h--;if(h<this._clipIndex)for(l=h;l<this._clipIndex;l++)this._createGraphics(l)}this._createGraphics()}}},n._createGraphics=function(t){void 0===t&&(t=-1),-1==t&&(t=this._clipIndex);var e,i=t*this._player.cacheFrameRateInterval,n=this._templet.drawOrderAniArr,r=n[this._aniClipIndex];if(r&&r.length>0)for(this._drawOrderIndex=0,e=r[this._drawOrderIndex];i>=e.time&&(this._drawOrder=e.drawOrder,!(++this._drawOrderIndex>=r.length));)e=r[this._drawOrderIndex];var a;0==this._aniMode||1==this._aniMode?this.graphics=new tt:this.graphics instanceof laya.ani.GraphicsAni?this.graphics.clear():this.graphics=new tt,a=this.graphics;var s=this._templet.getNodes(this._aniClipIndex);this._templet.getOriginalData(this._aniClipIndex,this._curOriginalData,this._player._fullFrames[this._aniClipIndex],t,i);var o,l,u,_,c=this._aniSectionDic[this._aniClipIndex],d=0,f=0,m=0,v=0,g=0,E=this._templet.srcBoneMatrixArr.length;for(f=0,g=c[0];f<E;f++)_=this._boneList[f],u=this._templet.srcBoneMatrixArr[f],_.resultTransform.scX=u.scX*this._curOriginalData[d++],_.resultTransform.skX=u.skX+this._curOriginalData[d++],_.resultTransform.skY=u.skY+this._curOriginalData[d++],_.resultTransform.scY=u.scY*this._curOriginalData[d++],_.resultTransform.x=u.x+this._curOriginalData[d++],_.resultTransform.y=u.y+this._curOriginalData[d++],8===this._templet.tMatrixDataLen&&(_.resultTransform.skewX=u.skewX+this._curOriginalData[d++],_.resultTransform.skewY=u.skewY+this._curOriginalData[d++]);var x,T={},S={};for(g+=c[1];f<g;f++)x=s[f],T[x.name]=this._curOriginalData[d++],S[x.name]=this._curOriginalData[d++],this._curOriginalData[d++],this._curOriginalData[d++],this._curOriginalData[d++],this._curOriginalData[d++];var D={},M={};for(g+=c[2];f<g;f++)x=s[f],D[x.name]=this._curOriginalData[d++],M[x.name]=this._curOriginalData[d++],this._curOriginalData[d++],this._curOriginalData[d++],this._curOriginalData[d++],this._curOriginalData[d++];if(this._pathDic){var y;for(g+=c[3];f<g;f++)if(x=s[f],y=this._pathDic[x.name]){var A=new h(x.extenData);switch(A.getByte()){case 1:y.position=this._curOriginalData[d++];break;case 2:y.spacing=this._curOriginalData[d++];break;case 3:y.rotateMix=this._curOriginalData[d++],y.translateMix=this._curOriginalData[d++]}}}if(this._yReverseMatrix?this._rootBone.update(this._yReverseMatrix):this._rootBone.update(p.TEMP.identity()),this._ikArr){var I;for(f=0,g=this._ikArr.length;f<g;f++)I=this._ikArr[f],D.hasOwnProperty(I.name)&&(I.bendDirection=D[I.name]),M.hasOwnProperty(I.name)&&(I.mix=M[I.name]),I.apply()}if(this._pathDic)for(var R in this._pathDic)y=this._pathDic[R],y.apply(this._boneList,a);if(this._tfArr){var C;for(f=0,v=this._tfArr.length;f<v;f++)C=this._tfArr[f],C.apply()}for(f=0,v=this._boneList.length;f<v;f++)if(_=this._boneList[f],l=this._bindBoneBoneSlotDic[_.name],_.resultMatrix.copyTo(this._boneMatrixArray[f]),l)for(m=0,g=l.length;m<g;m++)(o=l[m])&&o.setParentMatrix(_.resultMatrix);var b,w={},N=this._templet.deformAniArr;if(N&&N.length>0){if(this._lastAniClipIndex!=this._aniClipIndex)for(this._lastAniClipIndex=this._aniClipIndex,f=0,g=this._boneSlotArray.length;f<g;f++)o=this._boneSlotArray[f],o.deformData=null;var P=N[this._aniClipIndex];b=P.default,this._setDeform(b,w,this._boneSlotArray,i);var L;for(L in P)"default"!=L&&L!=this._skinName&&(b=P[L],this._setDeform(b,w,this._boneSlotArray,i));b=P[this._skinName],this._setDeform(b,w,this._boneSlotArray,i)}var O,V,F;if(this._drawOrder)for(f=0,g=this._drawOrder.length;f<g;f++)o=this._boneSlotArray[this._drawOrder[f]],O=T[o.name],V=S[o.name],isNaN(V)||(a.save(),a.alpha(V)),isNaN(O)||-2==O||(this._templet.attachmentNames?o.showDisplayByName(this._templet.attachmentNames[O]):o.showDisplayByIndex(O)),w[this._drawOrder[f]]?(F=w[this._drawOrder[f]],o.currDisplayData&&F[o.currDisplayData.attachmentName]?o.deformData=F[o.currDisplayData.attachmentName]:o.deformData=null):o.deformData=null,isNaN(V)?o.draw(a,this._boneMatrixArray,2==this._aniMode):o.draw(a,this._boneMatrixArray,2==this._aniMode,V),isNaN(V)||a.restore();else for(f=0,g=this._boneSlotArray.length;f<g;f++)o=this._boneSlotArray[f],O=T[o.name],V=S[o.name],isNaN(V)||(a.save(),a.alpha(V)),isNaN(O)||-2==O||(this._templet.attachmentNames?o.showDisplayByName(this._templet.attachmentNames[O]):o.showDisplayByIndex(O)),w[f]?(F=w[f],o.currDisplayData&&F[o.currDisplayData.attachmentName]?o.deformData=F[o.currDisplayData.attachmentName]:o.deformData=null):o.deformData=null,isNaN(V)?o.draw(a,this._boneMatrixArray,2==this._aniMode):o.draw(a,this._boneMatrixArray,2==this._aniMode,V),isNaN(V)||a.restore();0==this._aniMode?this._templet.setGrahicsDataWithCache(this._aniClipIndex,t,a):1==this._aniMode&&this._setGrahicsDataWithCache(this._aniClipIndex,t,a)},n._setDeform=function(t,e,i,n){if(t){var r,a,s,o=0,l=0,h=0;if(t)for(o=0,l=t.deformSlotDataList.length;o<l;o++)for(r=t.deformSlotDataList[o],h=0;h<r.deformSlotDisplayList.length;h++)a=r.deformSlotDisplayList[h],s=i[a.slotIndex],a.apply(n,s),e[a.slotIndex]||(e[a.slotIndex]={}),e[a.slotIndex][a.attachment]=a.deformData}},n.getAnimNum=function(){return this._templet.getAnimationCount()},n.getAniNameByIndex=function(t){return this._templet.getAniNameByIndex(t)},n.getSlotByName=function(t){return this._boneSlotDic[t]},n.showSkinByName=function(t,e){void 0===e&&(e=!0),this.showSkinByIndex(this._templet.getSkinIndexByName(t),e)},n.showSkinByIndex=function(t,e){void 0===e&&(e=!0);for(var i=0;i<this._boneSlotArray.length;i++)this._boneSlotArray[i].showSlotData(null,e);if(this._templet.showSkinByIndex(this._boneSlotDic,t,e)){var n=this._templet.skinDataArray[t];this._skinIndex=t,this._skinName=n.name}this._clearCache()},n.showSlotSkinByIndex=function(t,e){if(0!=this._aniMode){var i=this.getSlotByName(t);i&&i.showDisplayByIndex(e),this._clearCache()}},n.showSlotSkinByName=function(t,e){if(0!=this._aniMode){var i=this.getSlotByName(t);i&&i.showDisplayByName(e),this._clearCache()}},n.replaceSlotSkinName=function(t,e,i){if(0!=this._aniMode){var n=this.getSlotByName(t);n&&n.replaceDisplayByName(e,i),this._clearCache()}},n.replaceSlotSkinByIndex=function(t,e,i){if(0!=this._aniMode){var n=this.getSlotByName(t);n&&n.replaceDisplayByIndex(e,i),this._clearCache()}},n.setSlotSkin=function(t,e){if(0!=this._aniMode){var i=this.getSlotByName(t);i&&i.replaceSkin(e),this._clearCache()}},n._clearCache=function(){if(1==this._aniMode)for(var t=0,e=this._graphicsCache.length;t<e;t++)this._graphicsCache[t].length=0},n.play=function(t,e,i,n,r,a){void 0===i&&(i=!0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===a&&(a=!0),this._indexControl=!1;var s=-1,o=NaN;if(o=e?2147483647:0,"string"==typeof t)for(var h=0,u=this._templet.getAnimationCount();h<u;h++){var _=this._templet.getAnimation(h);if(_&&t==_.name){s=h;break}}else s=t;s>-1&&s<this.getAnimNum()&&(this._aniClipIndex=s,(i||this._pause||this._currAniIndex!=s)&&(this._currAniIndex=s,this._curOriginalData=new Float32Array(this._templet.getTotalkeyframesLength(s)),this._drawOrder=null,this._eventIndex=0,this._player.play(s,this._player.playbackRate,o,n,r),a&&this._templet.showSkinByIndex(this._boneSlotDic,this._skinIndex),this._pause&&(this._pause=!1,this._lastTime=l.now(),this.timer.frameLoop(1,this,this._update,null,!0)),this._update()))},n.stop=function(){this._pause||(this._pause=!0,this._player&&this._player.stop(!0),this.timer.clear(this,this._update))},n.playbackRate=function(t){this._player&&(this._player.playbackRate=t)},n.paused=function(){this._pause||(this._pause=!0,this._player&&(this._player.paused=!0),this.timer.clear(this,this._update))},n.resume=function(){this._indexControl=!1,this._pause&&(this._pause=!1,this._player&&(this._player.paused=!1),this._lastTime=l.now(),this.timer.frameLoop(1,this,this._update,null,!0))},n._getGrahicsDataWithCache=function(t,e){return this._graphicsCache[t][e]},n._setGrahicsDataWithCache=function(t,e,i){this._graphicsCache[t][e]=i},n.destroy=function(e){void 0===e&&(e=!0),t.prototype.destroy.call(this,e),this._templet=null,this._player&&this._player.offAll(),this._player=null,this._curOriginalData=null,this._boneMatrixArray.length=0,this._lastTime=0,this.timer.clear(this,this._update)},a(0,n,"url",function(){return this._aniPath},function(t){this.load(t)}),a(0,n,"index",function(){return this._index},function(t){this.player&&(this._index=t,this._player.currentTime=1e3*this._index/this._player.cacheFrameRate,this._indexControl=!0,this._update(!1))}),a(0,n,"total",function(){return this._templet&&this._player?this._total=Math.floor(this._templet.getAniDuration(this._player.currentAnimationClipIndex)/1e3*this._player.cacheFrameRate):this._total=-1,this._total}),a(0,n,"templet",function(){return this._templet}),a(0,n,"player",function(){return this._player}),e.useSimpleMeshInCanvas=!1,e}(T),at=(function(t){function e(t){this._start=0,this._Pos=0,this._data=null,this._curIndex=0,this._preIndex=0,this._playIndex=0,this._playing=!1,this._ended=!0,this._count=0,this._ids=null,this._loadedImage={},this._idOfSprite=null,this._parentMovieClip=null,this._movieClipList=null,this._labels=null,this.basePath=null,this._atlasPath=null,this._url=null,this._isRoot=!1,this._completeHandler=null,this._endFrame=-1,this.interval=30,this.loop=!1,e.__super.call(this),this._ids={},this._idOfSprite=[],this._reset(),this._playing=!1,this._parentMovieClip=t,t?(this._isRoot=!1,this._movieClipList=t._movieClipList,this._movieClipList.push(this)):(this._movieClipList=[this],this._isRoot=!0,this._setUpNoticeType(1))}r(e,"laya.ani.swf.MovieClip",t);var s=e.prototype;s.destroy=function(e){void 0===e&&(e=!0),this._clear(),t.prototype.destroy.call(this,e)},s._setDisplay=function(e){t.prototype._setDisplay.call(this,e),this._isRoot&&this._$3__onDisplay(e)},s._$3__onDisplay=function(t){t?this.timer.loop(this.interval,this,this.updates,null,!0):this.timer.clear(this,this.updates)},s.updates=function(){if(!this._parentMovieClip){var t=0,e=0;for(e=this._movieClipList.length,t=0;t<e;t++)this._movieClipList[t]&&this._movieClipList[t]._update()}},s.addLabel=function(t,e){this._labels||(this._labels={}),this._labels[e]=t},s.removeLabel=function(t){if(t){if(!this._labels)for(var e in this._labels)if(this._labels[e]===t){delete this._labels[e];break}}else this._labels=null},s._update=function(){if(this._data&&this._playing){if(++this._playIndex>=this._count){if(!this.loop)return this._playIndex--,void this.stop();this._playIndex=0}if(this._parse(this._playIndex),this._labels&&this._labels[this._playIndex]&&this.event("label",this._labels[this._playIndex]),-1!=this._endFrame&&this._endFrame==this._playIndex){if(this._endFrame=-1,null!=this._completeHandler){var t=this._completeHandler;this._completeHandler=null,t.run()}this.stop()}}},s.stop=function(){this._playing=!1},s.gotoAndStop=function(t){this.index=t,this.stop()},s._clear=function(){if(this.stop(),this._idOfSprite.length=0,!this._parentMovieClip){this.timer.clear(this,this.updates);var t=0,e=0;for(e=this._movieClipList.length,t=0;t<e;t++)this._movieClipList[t]!=this&&this._movieClipList[t]._clear();this._movieClipList.length=0}this._atlasPath&&f.clearRes(this._atlasPath);var i;for(i in this._loadedImage)this._loadedImage[i]&&(f.clearRes(i),this._loadedImage[i]=!1);this.removeChildren(),this.graphics=null,this._parentMovieClip=null},s.play=function(t,e){void 0===t&&(t=0),void 0===e&&(e=!0),this.loop=e,this._playing=!0,this._data&&this._displayFrame(t)},s._displayFrame=function(t){void 0===t&&(t=-1),-1!=t&&(this._curIndex>t&&this._reset(),this._parse(t))},s._reset=function(t){void 0===t&&(t=!0),t&&1!=this._curIndex&&this.removeChildren(),this._preIndex=this._curIndex=-1,this._Pos=this._start},s._parse=function(t){var i,n,r,a=0,s=0,o=0,l=!1,h=this._idOfSprite,u=this._data;for(this._ended&&this._reset(),u.pos=this._Pos,this._ended=!1,this._playIndex=t,this._curIndex>t&&t<this._preIndex&&(this._reset(!0),u.pos=this._Pos);this._curIndex<=t&&!this._ended;)switch(u.getUint16()){case 12:if(a=u.getUint16(),s=this._ids[u.getUint16()],this._Pos=u.pos,u.pos=s,0==(o=u.getUint8())){var _=u.getUint16();if(!(n=h[a])){n=h[a]=new T;var c=new T;c.loadImage(this.basePath+_+".png"),this._loadedImage[this.basePath+_+".png"]=!0,n.addChild(c),c.size(u.getFloat32(),u.getFloat32());var d=u._getMatrix();c.transform=d}n.alpha=1}else 1==o&&(i=h[a],i||(h[a]=i=new e(this),i.interval=this.interval,i._ids=this._ids,i.basePath=this.basePath,i._setData(u,s),i._initState(),i.play(0)),i.alpha=1);u.pos=this._Pos;break;case 3:var f=h[u.getUint16()];f&&(this.addChild(f),f.zOrder=u.getUint16(),l=!0);break;case 4:f=h[u.getUint16()],f&&f.removeSelf();break;case 5:h[u.getUint16()][e._ValueList[u.getUint16()]]=u.getFloat32();break;case 6:h[u.getUint16()].visible=u.getUint8()>0;break;case 7:n=h[u.getUint16()];var m=n.transform||p.create();m.setTo(u.getFloat32(),u.getFloat32(),u.getFloat32(),u.getFloat32(),u.getFloat32(),u.getFloat32()),n.transform=m;break;case 8:h[u.getUint16()].setPos(u.getFloat32(),u.getFloat32());break;case 9:h[u.getUint16()].setSize(u.getFloat32(),u.getFloat32());break;case 10:h[u.getUint16()].alpha=u.getFloat32();break;case 11:h[u.getUint16()].setScale(u.getFloat32(),u.getFloat32());break;case 98:r=u.getString(),this.event(r),"stop"==r&&this.stop();break;case 99:this._curIndex=u.getUint16(),l&&this.updateZOrder();break;case 100:this._count=this._curIndex+1,this._ended=!0,this._playing&&(this.event("enterframe"),this.event("end"),this.event("complete")),this._reset(!1)}this._playing&&!this._ended&&this.event("enterframe"),this._Pos=u.pos},s._setData=function(t,e){this._data=t,this._start=e+3},s.load=function(t,e,n){void 0===e&&(e=!1),this._url=t=M.formatURL(t),e&&(this._atlasPath=n||t.split(".swf")[0]+".json"),this.stop(),this._clear(),this._movieClipList=[this];var r;r=[{url:t,type:"arraybuffer"}],this._atlasPath&&r.push({url:this._atlasPath,type:"atlas"}),i.loader.load(r,d.create(this,this._onLoaded))},s._onLoaded=function(){var t;if(!(t=f.getRes(this._url)))return void this.event("error","file not find");this.basePath=this._atlasPath?f.getAtlas(this._atlasPath).dir:this._url.split(".swf")[0]+"/image/",this._initData(t)},s._initState=function(){this._reset(),this._ended=!1;var t=this._playing;for(this._playing=!1,this._curIndex=0;!this._ended;)this._parse(++this._curIndex);this._playing=t},s._initData=function(t){this._data=new h(t);var e=0,i=this._data.getUint16();for(e=0;e<i;e++)this._ids[this._data.getInt16()]=this._data.getInt32();this.interval=1e3/this._data.getUint16(),this._setData(this._data,this._ids[32767]),this._initState(),this.play(0),this.event("loaded"),this._parentMovieClip||this.timer.loop(this.interval,this,this.updates,null,!0)},s.playTo=function(t,e,i){this._completeHandler=i,this._endFrame=e,this.play(t,!1)},a(0,s,"index",function(){return this._playIndex},function(t){this._playIndex=t,this._data&&this._displayFrame(this._playIndex),this._labels&&this._labels[t]&&this.event("label",this._labels[t])}),a(0,s,"count",function(){return this._count}),a(0,s,"playing",function(){return this._playing}),a(0,s,"url",null,function(t){this.load(t)}),n(e,["_ValueList",function(){return this._ValueList=["x","y","width","height","scaleX","scaleY","rotation","alpha"]}])}(T),function(t){function e(){this._mainTexture=null,this._textureJson=null,this._graphicsCache=[],this.srcBoneMatrixArr=[],this.ikArr=[],this.tfArr=[],this.pathArr=[],this.boneSlotDic={},this.bindBoneBoneSlotDic={},this.boneSlotArray=[],this.skinDataArray=[],this.skinDic={},this.subTextureDic={},this.isParseFail=!1,this.yReverseMatrix=null,this.drawOrderAniArr=[],this.eventAniArr=[],this.attachmentNames=null,this.deformAniArr=[],this._isDestroyed=!1,this._rate=30,this.isParserComplete=!1,this.aniSectionDic={},this._skBufferUrl=null,this._textureDic={},this._loadList=null,this._path=null,this.tMatrixDataLen=0,this.mRootBone=null,e.__super.call(this),this.skinSlotDisplayDataArr=[],this.mBoneArr=[]}r(e,"laya.ani.bone.Templet",t);var n=e.prototype;return n.loadAni=function(t){this._skBufferUrl=t,i.loader.load(t,d.create(this,this.onComplete),null,"arraybuffer")},n.onComplete=function(t){if(this._isDestroyed)return void this.destroy();var e=f.getRes(this._skBufferUrl);if(!e)return void this.event("error","load failed:"+this._skBufferUrl);this._path=this._skBufferUrl.slice(0,this._skBufferUrl.lastIndexOf("/"))+"/",this.parseData(null,e)},n.parseData=function(t,e,i){void 0===i&&(i=30),!this._path&&this.url&&(this._path=this.url.slice(0,this.url.lastIndexOf("/"))+"/"),this._mainTexture=t,this._mainTexture&&g.isWebGL&&t.bitmap&&(t.bitmap.enableMerageInAtlas=!1),this._rate=i,this.parse(e)},n.buildArmature=function(t){return void 0===t&&(t=0),new rt(this,t)},n.parse=function(i){t.prototype.parse.call(this,i),this._endLoaded(),this._aniVersion!=e.LAYA_ANIMATION_VISION&&(console.log("[Error] 版本不一致，请使用IDE版本配套的重新导出"+this._aniVersion+"->"+e.LAYA_ANIMATION_VISION),this._loaded=!1),this.loaded?this._mainTexture?this._parsePublicExtData():this._parseTexturePath():(this.event("error",this),this.isParseFail=!0)},n._parseTexturePath=function(){if(this._isDestroyed)return void this.destroy();var t=0;this._loadList=[];var e,n=new h(this.getPublicExtData()),r=0,a=0,s=0,o=n.getInt32(),l=n.readUTFString(),u=l.split("\n");for(t=0;t<o;t++)e=this._path+u[2*t],l=u[2*t+1],n.getFloat32(),n.getFloat32(),r=n.getFloat32(),a=n.getFloat32(),s=n.getFloat32(),isNaN(s)?0:s,s=n.getFloat32(),isNaN(s)?0:s,s=n.getFloat32(),isNaN(s)?r:s,s=n.getFloat32(),isNaN(s)?a:s,-1==this._loadList.indexOf(e)&&this._loadList.push(e);i.loader.load(this._loadList,d.create(this,this._textureComplete))},n._textureComplete=function(){for(var t,e,i=0,n=this._loadList.length;i<n;i++)e=this._loadList[i],t=this._textureDic[e]=f.getRes(e),g.isWebGL&&t&&t.bitmap&&(t.bitmap.enableMerageInAtlas=!1);this._parsePublicExtData()},n._parsePublicExtData=function(){var t=0,e=0,i=0,n=0,r=0;for(t=0,r=this.getAnimationCount();t<r;t++)this._graphicsCache.push([]);var a=!1;a="Dragon"!=this._aniClassName;var s,o,l=new h(this.getPublicExtData()),u=0,_=0,c=0,d=0,f=0,m=0,v=0,g=0,E=0,x=l.getInt32(),T=l.readUTFString(),S=T.split("\n");for(t=0;t<x;t++){if(s=this._mainTexture,o=this._path+S[2*t],T=S[2*t+1],null==this._mainTexture&&(s=this._textureDic[o]),!s)return this.event("error",this),void(this.isParseFail=!0);u=l.getFloat32(),_=l.getFloat32(),c=l.getFloat32(),d=l.getFloat32(),E=l.getFloat32(),f=isNaN(E)?0:E,E=l.getFloat32(),m=isNaN(E)?0:E,E=l.getFloat32(),v=isNaN(E)?c:E,E=l.getFloat32(),g=isNaN(E)?d:E,this.subTextureDic[T]=D.create(s,u,_,c,d,-f,-m,v,g)}this._mainTexture=s;var M,y=l.getUint16();for(t=0;t<y;t++)M=[],M.push(l.getUint16()),M.push(l.getUint16()),M.push(l.getUint16()),M.push(l.getUint16()),this.aniSectionDic[t]=M;var A,I,R,C,N,P=l.getInt16(),U={};for(t=0;t<P;t++)A=new b,0==t?N=A:A.root=N,A.d=a?-1:1,R=l.readUTFString(),C=l.readUTFString(),A.length=l.getFloat32(),1==l.getByte()&&(A.inheritRotation=!1),1==l.getByte()&&(A.inheritScale=!1),A.name=R,C&&(I=U[C],I?I.addChild(A):this.mRootBone=A),U[R]=A,this.mBoneArr.push(A);this.tMatrixDataLen=l.getUint16();var G,z=l.getUint16(),Z=Math.floor(z/this.tMatrixDataLen),q=this.srcBoneMatrixArr;for(t=0;t<Z;t++)G=new j,G.scX=l.getFloat32(),G.skX=l.getFloat32(),G.skY=l.getFloat32(),G.scY=l.getFloat32(),G.x=l.getFloat32(),G.y=l.getFloat32(),8===this.tMatrixDataLen&&(G.skewX=l.getFloat32(),G.skewY=l.getFloat32()),q.push(G),A=this.mBoneArr[t],A.transform=G;var Q,$=l.getUint16(),J=0;for(t=0;t<$;t++){for(Q=new H,J=l.getUint16(),e=0;e<J;e++)Q.boneNames.push(l.readUTFString()),Q.boneIndexs.push(l.getInt16());Q.name=l.readUTFString(),Q.targetBoneName=l.readUTFString(),Q.targetBoneIndex=l.getInt16(),Q.bendDirection=l.getFloat32(),Q.mix=l.getFloat32(),Q.isSpine=a,this.ikArr.push(Q)}var tt,et=l.getUint16(),it=0;for(t=0;t<et;t++){for(tt=new K,it=l.getUint16(),e=0;e<it;e++)tt.boneIndexs.push(l.getInt16());tt.name=l.getUTFString(),tt.targetIndex=l.getInt16(),tt.rotateMix=l.getFloat32(),tt.translateMix=l.getFloat32(),tt.scaleMix=l.getFloat32(),tt.shearMix=l.getFloat32(),tt.offsetRotation=l.getFloat32(),tt.offsetX=l.getFloat32(),tt.offsetY=l.getFloat32(),tt.offsetScaleX=l.getFloat32(),tt.offsetScaleY=l.getFloat32(),tt.offsetShearY=l.getFloat32(),this.tfArr.push(tt)}var nt,rt=l.getUint16(),at=0;for(t=0;t<rt;t++){for(nt=new k,nt.name=l.readUTFString(),at=l.getUint16(),e=0;e<at;e++)nt.bones.push(l.getInt16());nt.target=l.readUTFString(),nt.positionMode=l.readUTFString(),nt.spacingMode=l.readUTFString(),nt.rotateMode=l.readUTFString(),nt.offsetRotation=l.getFloat32(),nt.position=l.getFloat32(),nt.spacing=l.getFloat32(),nt.rotateMix=l.getFloat32(),nt.translateMix=l.getFloat32(),this.pathArr.push(nt)}var st,ot,lt,ht,ut=0,_t=0,ct=0,dt=NaN,ft=0,mt=l.getInt16();for(t=0;t<mt;t++){var pt=l.getUint8(),vt={};this.deformAniArr.push(vt);for(var gt=0;gt<pt;gt++)for(st=new L,st.skinName=l.getUTFString(),vt[st.skinName]=st,ut=l.getInt16(),e=0;e<ut;e++)for(ot=new O,st.deformSlotDataList.push(ot),_t=l.getInt16(),i=0;i<_t;i++)for(lt=new V,ot.deformSlotDisplayList.push(lt),lt.slotIndex=l.getInt16(),lt.attachment=l.getUTFString(),ct=l.getInt16(),n=0;n<ct;n++)for(1==l.getByte()?lt.tweenKeyList.push(!0):lt.tweenKeyList.push(!1),dt=l.getFloat32(),lt.timeList.push(dt),ht=[],lt.vectices.push(ht),ft=l.getInt16(),r=0;r<ft;r++)ht.push(l.getFloat32())}var Et,xt,Tt=l.getInt16(),St=0,Dt=0;for(t=0;t<Tt;t++){for(St=l.getInt16(),Et=[],e=0;e<St;e++){for(xt=new F,xt.time=l.getFloat32(),Dt=l.getInt16(),i=0;i<Dt;i++)xt.drawOrder.push(l.getInt16());Et.push(xt)}this.drawOrderAniArr.push(Et)}var Mt,yt,At=l.getInt16(),It=0;for(t=0;t<At;t++){for(It=l.getInt16(),Mt=[],e=0;e<It;e++)yt=new B,yt.name=l.getUTFString(),yt.intValue=l.getInt32(),yt.floatValue=l.getFloat32(),yt.stringValue=l.getUTFString(),yt.time=l.getFloat32(),Mt.push(yt);this.eventAniArr.push(Mt)}var Rt=l.getInt16();if(Rt>0)for(this.attachmentNames=[],t=0;t<Rt;t++)this.attachmentNames.push(l.getUTFString());var Ct,bt,wt=l.getInt16();for(t=0;t<wt;t++)Ct=new w,Ct.name=l.readUTFString(),Ct.parent=l.readUTFString(),Ct.attachmentName=l.readUTFString(),Ct.srcDisplayIndex=Ct.displayIndex=l.getInt16(),Ct.templet=this,this.boneSlotDic[Ct.name]=Ct,bt=this.bindBoneBoneSlotDic[Ct.parent],null==bt&&(this.bindBoneBoneSlotDic[Ct.parent]=bt=[]),bt.push(Ct),this.boneSlotArray.push(Ct);var Nt,Pt,Lt,Ot=l.readUTFString(),Vt=Ot.split("\n"),Ft=0,Bt=l.getUint8(),Ut=0,Ht=0,Gt=0,zt=0,kt=0,Wt=0,Xt=0;for(t=0;t<Bt;t++){for(Nt=new W,Nt.name=Vt[Ft++],Ut=l.getUint8(),e=0;e<Ut;e++){for(Pt=new Y,Pt.name=Vt[Ft++],Ct=this.boneSlotDic[Pt.name],Ht=l.getUint8(),i=0;i<Ht;i++){if(Lt=new X,this.skinSlotDisplayDataArr.push(Lt),Lt.name=Vt[Ft++],Lt.attachmentName=Vt[Ft++],Lt.transform=new j,Lt.transform.scX=l.getFloat32(),Lt.transform.skX=l.getFloat32(),Lt.transform.skY=l.getFloat32(),Lt.transform.scY=l.getFloat32(),Lt.transform.x=l.getFloat32(),Lt.transform.y=l.getFloat32(),Pt.displayArr.push(Lt),Lt.width=l.getFloat32(),Lt.height=l.getFloat32(),Lt.type=l.getUint8(),Lt.verLen=l.getUint16(),(P=l.getUint16())>0)for(Lt.bones=[],n=0;n<P;n++){var Yt=l.getUint16();Lt.bones.push(Yt)}if((Gt=l.getUint16())>0)for(Lt.uvs=[],n=0;n<Gt;n++)Lt.uvs.push(l.getFloat32());if((zt=l.getUint16())>0)for(Lt.weights=[],n=0;n<zt;n++)Lt.weights.push(l.getFloat32());if((kt=l.getUint16())>0)for(Lt.triangles=[],n=0;n<kt;n++)Lt.triangles.push(l.getUint16());if((Wt=l.getUint16())>0)for(Lt.vertices=[],n=0;n<Wt;n++)Lt.vertices.push(l.getFloat32());if((Xt=l.getUint16())>0)for(Lt.lengths=[],n=0;n<Xt;n++)Lt.lengths.push(l.getFloat32())}Nt.slotArr.push(Pt)}this.skinDic[Nt.name]=Nt,this.skinDataArray.push(Nt)}1==l.getUint8()?(this.yReverseMatrix=new p(1,0,0,-1,0,0),N&&N.setTempMatrix(this.yReverseMatrix)):N&&N.setTempMatrix(new p),this.showSkinByIndex(this.boneSlotDic,0),this.isParserComplete=!0,this.event("complete",this)},n.getTexture=function(t){var e=this.subTextureDic[t];return null==e?this._mainTexture:e},n.showSkinByIndex=function(t,e,i){if(void 0===i&&(i=!0),e<0&&e>=this.skinDataArray.length)return!1;var n,r,a=0,s=0,o=this.skinDataArray[e];if(o){for(a=0,s=o.slotArr.length;a<s;a++)(r=o.slotArr[a])&&(n=t[r.name])&&(n.showSlotData(r,i),i&&"undefined"!=n.attachmentName&&"null"!=n.attachmentName?n.showDisplayByName(n.attachmentName):n.showDisplayByIndex(n.displayIndex));return!0}return!1},n.getSkinIndexByName=function(t){for(var e,i=0,n=this.skinDataArray.length;i<n;i++)if(e=this.skinDataArray[i],e.name==t)return i;return-1},n.getGrahicsDataWithCache=function(t,e){return this._graphicsCache[t][e]},n.setGrahicsDataWithCache=function(t,e,i){this._graphicsCache[t][e]=i},n.destroy=function(){this._isDestroyed=!0;var t;for(var i in this.subTextureDic)(t=this.subTextureDic[i])&&t.destroy();var i;for(i in this._textureDic)(t=this._textureDic[i])&&t.destroy();for(var n,r=0,a=this.skinSlotDisplayDataArr.length;r<a;r++)n=this.skinSlotDisplayDataArr[r],n.destory();this.skinSlotDisplayDataArr.length=0,this.url&&delete e.TEMPLET_DICTIONARY[this.url],laya.resource.Resource.prototype.destroy.call(this)},n.getAniNameByIndex=function(t){var e=this.getAnimation(t);return e?e.name:null},a(0,n,"rate",function(){return this._rate},function(t){this._rate=t}),e.LAYA_ANIMATION_VISION="LAYAANIMATION:1.6.0",e.TEMPLET_DICTIONARY=null,e}(it))}(window,document,Laya),n=[i,e],void 0!==(r=function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0});for(var i in Laya){var n=Laya[i];n&&n.__isclass&&(e[i]=n)}}.apply(e,n))&&(t.exports=r)},function(t,e,i){var n,r;!function(t,e,i){var n=(i.un,i.uns,i.static),r=i.class,a=i.getset,s=i.__newvec,o=(laya.ani.AnimationContent,laya.ani.AnimationPlayer),l=(laya.ani.AnimationState,laya.ani.AnimationTemplet),h=laya.maths.Arith,u=laya.webgl.atlas.AtlasResourceManager,_=laya.webgl.shader.BaseShader,c=laya.utils.Browser,d=laya.webgl.utils.Buffer,f=laya.utils.Byte,m=(laya.ani.bone.canvasmesh.CacheAbleSkinMesh,laya.utils.ClassUtils),p=i.Config,v=(laya.events.Event,laya.events.EventDispatcher),g=laya.utils.Handler,E=laya.net.Loader,x=laya.net.LoaderManager,T=laya.maths.MathUtil,S=laya.display.Node,D=laya.renders.Render,M=(laya.renders.RenderContext,laya.renders.RenderSprite,laya.webgl.utils.RenderState2D),y=laya.resource.Resource,A=laya.utils.RunDriver,I=(laya.webgl.shader.Shader,laya.webgl.utils.ShaderCompile),R=laya.display.Sprite,C=laya.utils.Stat,b=laya.utils.StringKey,w=(laya.display.css.Style,laya.resource.Texture,laya.net.URL),N=laya.utils.Utils,P=laya.webgl.WebGL,L=laya.webgl.WebGLContext;laya.webgl.canvas.WebGLContext2D;i.interface("laya.d3.core.IClone"),i.interface("laya.d3.graphics.IVertex"),i.interface("laya.d3.core.render.IUpdate"),i.interface("laya.d3.core.scene.ITreeNode"),i.interface("laya.d3.core.render.IRenderable");var O=function(){function t(){}return r(t,"laya.d3.animation.AnimationClipParser01"),t.READ_DATA=function(){t._DATA.offset=t._reader.getUint32(),t._DATA.size=t._reader.getUint32()},t.READ_BLOCK=function(){for(var e=t._BLOCK.count=t._reader.getUint16(),i=t._BLOCK.blockStarts=[],n=t._BLOCK.blockLengths=[],r=0;r<e;r++)i.push(t._reader.getUint32()),n.push(t._reader.getUint32())},t.READ_STRINGS=function(){var e=t._reader.getUint32(),i=t._reader.getUint16(),n=t._reader.pos;t._reader.pos=e+t._DATA.offset;for(var r=0;r<i;r++)t._strings[r]=t._reader.readUTFString();t._reader.pos=n},t.parse=function(e,i){t._animationClip=e,t._reader=i;i.__getBuffer();t.READ_DATA(),t.READ_BLOCK(),t.READ_STRINGS();for(var n=0,r=t._BLOCK.count;n<r;n++){var a=i.getUint16(),s=t._strings[a],o=t["READ_"+s];if(null==o)throw new Error("model file err,no this function:"+a+" "+s);o.call()}},t.READ_ANIMATIONS=function(){var e,i=0,n=0,r=t._reader,a=r.__getBuffer(),s=[],o=r.getUint8();for(s.length=o,i=0;i<o;i++)s[i]=r.getUint16();var l=[],h=r.getUint16();for(l.length=h,i=0;i<h;i++)l[i]=r.getFloat32();var u=t._animationClip;u.name=t._strings[r.getUint16()];var _=u._duration=r.getFloat32();u.islooping=!!r.getByte(),u._frameRate=r.getInt16();var c=r.getInt16(),d=u._nodes=new Array;d.length=c,(u._publicClipDatas=[]).length=c;var f=u._nodesMap={},m=0,p=0;for(i=0;i<c;i++){e=d[i]=new H;var v=r.getUint16(),g=e.path=[];for(g.length=v,n=0;n<v;n++)g[n]=t._strings[r.getUint16()];var E=g.join("/"),x=f[E];x||(f[E]=x=[]),x.push(e);var T=r.getInt16();-1!==T&&(e.componentType=t._strings[T]);var S=B._propertyIndexDic[t._strings[r.getUint16()]];if(null==S)throw new Error("AnimationClipParser01:unknown property name.");var D=S<4,M=!D||D&&""===g[0];e._cacheProperty=M,M?m++:p++,e.propertyNameID=S;var y=s[r.getUint8()];e.keyFrameWidth=y/4;var A=e.keyFrames=[],I=A.length=r.getUint16(),R=null,C=NaN;for(n=0;n<I;n++){var b=A[n]=new U;C=b.startTime=l[r.getUint16()];var w=r.pos;b.inTangent=new Float32Array(a.slice(w,w+y)),r.pos+=y,w=r.pos,b.outTangent=new Float32Array(a.slice(w,w+y)),r.pos+=y,w=r.pos,b.data=new Float32Array(a.slice(w,w+y)),r.pos+=y,R&&(R.next=b,R.duration=C-R.startTime),R=b}b.next=null,b.duration=_-C}var N=u._nodeToCachePropertyMap=new Int32Array(c),P=u._cachePropertyMap=new Int32Array(m),L=u._unCachePropertyMap=new Int32Array(p);for(m=p=0,i=0;i<c;i++)e=d[i],e._cacheProperty?(N[i]=m,P[m++]=i):L[p++]=i},t._animationClip=null,t._reader=null,t._strings=[],n(t,["_BLOCK",function(){return this._BLOCK={count:0}},"_DATA",function(){return this._DATA={offset:0,size:0}}]),t}(),V=function(){function t(){}return r(t,"laya.d3.animation.AnimationClipParser02"),t.READ_DATA=function(){t._DATA.offset=t._reader.getUint32(),t._DATA.size=t._reader.getUint32()},t.READ_BLOCK=function(){for(var e=t._BLOCK.count=t._reader.getUint16(),i=t._BLOCK.blockStarts=[],n=t._BLOCK.blockLengths=[],r=0;r<e;r++)i.push(t._reader.getUint32()),n.push(t._reader.getUint32())},t.READ_STRINGS=function(){var e=t._reader.getUint32(),i=t._reader.getUint16(),n=t._reader.pos;t._reader.pos=e+t._DATA.offset;for(var r=0;r<i;r++)t._strings[r]=t._reader.readUTFString();t._reader.pos=n},t.parse=function(e,i){t._animationClip=e,t._reader=i;i.__getBuffer();t.READ_DATA(),t.READ_BLOCK(),t.READ_STRINGS();for(var n=0,r=t._BLOCK.count;n<r;n++){var a=i.getUint16(),s=t._strings[a],o=t["READ_"+s];if(null==o)throw new Error("model file err,no this function:"+a+" "+s);o.call()}},t.READ_ANIMATIONS=function(){var e,i=0,n=0,r=t._reader,a=r.__getBuffer(),s=[],o=r.getUint8();for(s.length=o,i=0;i<o;i++)s[i]=r.getUint16();var l=[],h=r.getUint16();for(l.length=h,i=0;i<h;i++)l[i]=r.getFloat32();var u=t._animationClip;u.name=t._strings[r.getUint16()];var _=u._duration=r.getFloat32();u.islooping=!!r.getByte(),u._frameRate=r.getInt16();var c=r.getInt16(),d=u._nodes=new Array;d.length=c,(u._publicClipDatas=[]).length=c;var f=u._nodesMap={},m=0,p=0;for(i=0;i<c;i++){e=d[i]=new H;var v=r.getUint16(),g=e.path=[];for(g.length=v,n=0;n<v;n++)g[n]=t._strings[r.getUint16()];var E=g.join("/"),x=f[E];x||(f[E]=x=[]),x.push(e);var T=r.getInt16();-1!==T&&(e.componentType=t._strings[T]);var S=B._propertyIndexDic[t._strings[r.getUint16()]];if(null==S)throw new Error("AnimationClipParser02:unknown property name.");var D=S<4,M=!D||D&&""===g[0];e._cacheProperty=M,M?m++:p++,e.propertyNameID=S;var y=s[r.getUint8()];e.keyFrameWidth=y/4;var A=e.keyFrames=[],I=A.length=r.getUint16(),R=null,C=NaN;for(n=0;n<I;n++){var b=A[n]=new U;C=b.startTime=l[r.getUint16()];var w=r.pos;b.inTangent=new Float32Array(a.slice(w,w+y)),r.pos+=y,w=r.pos,b.outTangent=new Float32Array(a.slice(w,w+y)),r.pos+=y,w=r.pos,b.data=new Float32Array(a.slice(w,w+y)),r.pos+=y,R&&(R.next=b,R.duration=C-R.startTime),R=b}b.next=null,b.duration=_-C}var N=r.getUint16();for(i=0;i<N;i++){var P=new F;P.time=r.getFloat32(),P.eventName=t._strings[r.getUint16()];var L,O=r.getUint16();for(O>0&&(P.params=L=[]),n=0;n<O;n++){switch(r.getByte()){case 0:L.push(!!r.getByte());break;case 1:L.push(r.getInt32());break;case 2:L.push(r.getFloat32());break;case 3:L.push(t._strings[r.getUint16()]);break;default:throw new Error("unknown type.")}}u.addEvent(P)}var V=u._nodeToCachePropertyMap=new Int32Array(c),G=u._cachePropertyMap=new Int32Array(m),z=u._unCachePropertyMap=new Int32Array(p);for(m=p=0,i=0;i<c;i++)e=d[i],e._cacheProperty?(V[i]=m,G[m++]=i):z[p++]=i},t._animationClip=null,t._reader=null,t._strings=[],n(t,["_BLOCK",function(){return this._BLOCK={count:0}},"_DATA",function(){return this._DATA={offset:0,size:0}}]),t}(),F=function(){function t(){this.time=NaN,this.eventName=null,this.params=null}return r(t,"laya.d3.animation.AnimationEvent"),t}(),B=function(){function t(){this._childs=[],this.transform=new $e(this)}r(t,"laya.d3.animation.AnimationNode");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.addChild=function(t){t._parent=this,t.transform.setParent(this.transform),this._childs.push(t)},e.removeChild=function(t){var e=this._childs.indexOf(t);-1!==e&&this._childs.splice(e,1)},e.getChildByName=function(t){for(var e=0,i=this._childs.length;e<i;e++){var n=this._childs[e];if(n.name===t)return n}return null},e.getChildByIndex=function(t){return this._childs[t]},e.getChildCount=function(){return this._childs.length},e.cloneTo=function(t){var e=t;e.name=this.name;for(var i=0,n=this._childs.length;i<n;i++){var r=this._childs[i],a=r.clone();e.addChild(a);var s=r.transform,o=a.transform;o.setLocalPosition(s.getLocalPosition()),o.setLocalRotation(s.getLocalRotation()),o.setLocalScale(s.getLocalScale()),o._localRotationEuler=s._localRotationEuler,o._setWorldMatrixIgnoreUpdate(s.getWorldMatrix())}},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},t.__init__=function(){t.registerAnimationNodeProperty("localPosition",t._getLocalPosition,t._setLocalPosition),t.registerAnimationNodeProperty("localRotation",t._getLocalRotation,t._setLocalRotation),t.registerAnimationNodeProperty("localScale",t._getLocalScale,t._setLocalScale),t.registerAnimationNodeProperty("localRotationEuler",t._getLocalRotationEuler,t._setLocalRotationEuler),t.registerAnimationNodeProperty("particleRender.sharedMaterial.tintColor",t._getParticleRenderSharedMaterialTintColor,t._setParticleRenderSharedMaterialTintColor),t.registerAnimationNodeProperty("meshRender.sharedMaterial.tilingOffset",t._getMeshRenderSharedMaterialTilingOffset,t._setMeshRenderSharedMaterialTilingOffset),t.registerAnimationNodeProperty("meshRender.sharedMaterial.albedoColor",t._getMeshRenderSharedMaterialAlbedo,t._setMeshRenderSharedMaterialAlbedo),t.registerAnimationNodeProperty("skinnedMeshRender.sharedMaterial.tilingOffset",t._getSkinnedMeshRenderSharedMaterialTilingOffset,t._setSkinnedMeshRenderSharedMaterialTilingOffset),t.registerAnimationNodeProperty("skinnedMeshRender.sharedMaterial.albedoColor",t._getSkinnedMeshRenderSharedMaterialAlbedo,t._setSkinnedMeshRenderSharedMaterialAlbedo),t.registerAnimationNodeProperty("meshRender.sharedMaterial.albedo",t._getMeshRenderSharedMaterialAlbedo,t._setMeshRenderSharedMaterialAlbedo),t.registerAnimationNodeProperty("skinnedMeshRender.sharedMaterial.albedo",t._getSkinnedMeshRenderSharedMaterialAlbedo,t._setSkinnedMeshRenderSharedMaterialAlbedo)},t.registerAnimationNodeProperty=function(e,i,n){if(t._propertyIndexDic[e])throw new Error("AnimationNode: this propertyName has registered.");t._propertyIndexDic[e]=t._propertyIDCounter,t._propertyGetFuncs[t._propertyIDCounter]=i,t._propertySetFuncs[t._propertyIDCounter]=n,t._propertyIDCounter++},t._getLocalPosition=function(t,e){return t?t.transform.getLocalPosition():e._transform.localPosition.elements},t._setLocalPosition=function(t,e,i){if(t)t.transform.setLocalPosition(i);else{var n=e._transform,r=n.localPosition;r.elements=i,n.localPosition=r}},t._getLocalRotation=function(t,e){return t?t.transform.getLocalRotation():e._transform.localRotation.elements},t._setLocalRotation=function(t,e,i){if(t)t.transform.setLocalRotation(i);else{var n=e._transform,r=n.localRotation;r.elements=i,n.localRotation=r}},t._getLocalScale=function(t,e){return t?t.transform.getLocalScale():e._transform.localScale.elements},t._setLocalScale=function(t,e,i){if(t)t.transform.setLocalScale(i);else{var n=e._transform,r=n.localScale;r.elements=i,n.localScale=r}},t._getLocalRotationEuler=function(t,e){return t?t.transform.getLocalRotationEuler():e._transform.localRotationEuler.elements},t._setLocalRotationEuler=function(t,e,i){if(t)t.transform.setLocalRotationEuler(i);else{var n=e._transform,r=n.localRotationEuler;r.elements=i,n.localRotationEuler=r}},t._getMeshRenderSharedMaterialTilingOffset=function(t,e){var i;if(t){var n=t.transform._entity;return n?(i=n.owner.meshRender.sharedMaterial,i.tilingOffset.elements):null}return i=e.meshRender.sharedMaterial,i.tilingOffset.elements},t._setMeshRenderSharedMaterialTilingOffset=function(t,e,i){var n,r;if(t){var a=t.transform._entity;a&&(n=a.owner.meshRender.material,r=n.tilingOffset,r.elements=i,n.tilingOffset=r)}else n=e.meshRender.material,r=n.tilingOffset,r.elements=i,n.tilingOffset=r},t._getMeshRenderSharedMaterialAlbedo=function(t,e){var i;if(t){var n=t.transform._entity;return n?(i=n.owner.meshRender.sharedMaterial,i.albedoColor.elements):null}return i=e.meshRender.sharedMaterial,i.albedoColor.elements},t._setMeshRenderSharedMaterialAlbedo=function(t,e,i){var n,r;if(t){var a=t.transform._entity;a&&(n=a.owner.meshRender.material,r=n.albedoColor,r.elements=i,n.albedoColor=r)}else n=e.meshRender.material,r=n.albedoColor,r.elements=i,n.albedoColor=r},t._getSkinnedMeshRenderSharedMaterialTilingOffset=function(t,e){var i;if(t){var n=t.transform._entity;return n?(i=n.owner.skinnedMeshRender.sharedMaterial,i.tilingOffset.elements):null}return i=e.skinnedMeshRender.sharedMaterial,i.tilingOffset.elements},t._setSkinnedMeshRenderSharedMaterialTilingOffset=function(t,e,i){var n,r;if(t){var a=t.transform._entity;a&&(n=a.owner.skinnedMeshRender.material,r=n.tilingOffset,r.elements=i,n.tilingOffset=r)}else n=e.skinnedMeshRender.material,r=n.tilingOffset,r.elements=i,n.tilingOffset=r},t._getSkinnedMeshRenderSharedMaterialAlbedo=function(t,e){var i;if(t){var n=t.transform._entity;return n?(i=n.owner.skinnedMeshRender.sharedMaterial,i.albedoColor.elements):null}return i=e.skinnedMeshRender.sharedMaterial,i.albedoColor.elements},t._setSkinnedMeshRenderSharedMaterialAlbedo=function(t,e,i){var n,r;if(t){var a=t.transform._entity;a&&(n=a.owner.skinnedMeshRender.material,r=n.albedoColor,r.elements=i,n.albedoColor=r)}else n=e.skinnedMeshRender.material,r=n.albedoColor,r.elements=i,n.albedoColor=r},t._getParticleRenderSharedMaterialTintColor=function(t,e){var i;if(t){var n=t.transform._entity;return n?(i=n.owner.particleRender.sharedMaterial,i.tintColor.elements):null}return i=e.particleRender.sharedMaterial,i.tintColor.elements},t._setParticleRenderSharedMaterialTintColor=function(t,e,i){var n,r;if(t){var a=t.transform._entity;a&&(n=a.owner.particleRender.material,r=n.tintColor,r.elements=i,n.tintColor=r)}else n=e.particleRender.material,r=n.tintColor,r.elements=i,n.tintColor=r},t._propertyIDCounter=0,t._propertyIndexDic={},t._propertySetFuncs=[],t._propertyGetFuncs=[],t}(),U=function(){function t(){this.startTime=NaN,this.inTangent=null,this.outTangent=null,this.data=null,this.duration=NaN,this.next=null}return r(t,"laya.d3.animation.Keyframe"),t}(),H=function(){function t(){this._cacheProperty=!1,this.path=null,this.componentType=null,this.propertyNameID=0,this.keyFrameWidth=0,this.defaultData=null,this.keyFrames=null}return r(t,"laya.d3.animation.KeyframeNode"),t}(),G=function(){function t(){this._tempVector30=new Pe,this._tempVector31=new Pe,this._tempVector32=new Pe,this._a=new Pe,this._b=new Pe,this._c=new Pe,this._d=new Pe}r(t,"laya.d3.core.glitter.SplineCurvePositionVelocity");var e=t.prototype;return e.Init=function(t,e,i,n){t.cloneTo(this._d),e.cloneTo(this._c),Pe.scale(t,2,this._a),Pe.scale(i,2,this._tempVector30),Pe.subtract(this._a,this._tempVector30,this._a),Pe.add(this._a,e,this._a),Pe.add(this._a,n,this._a),Pe.scale(i,3,this._b),Pe.scale(t,3,this._tempVector30),Pe.subtract(this._b,this._tempVector30,this._b),Pe.subtract(this._b,n,this._b),Pe.scale(e,2,this._tempVector30),Pe.subtract(this._b,this._tempVector30,this._b)},e.Slerp=function(t,e){Pe.scale(this._a,t*t*t,this._tempVector30),Pe.scale(this._b,t*t,this._tempVector31),Pe.scale(this._c,t,this._tempVector32),Pe.add(this._tempVector30,this._tempVector31,e),Pe.add(e,this._tempVector32,e),Pe.add(e,this._d,e)},t}(),z=function(){function t(t,e,i,n){this._datas=null,this._w=0,this._h=0,this._minHeight=NaN,this._maxHeight=NaN,this._datas=[],this._w=t,this._h=e,this._minHeight=i,this._maxHeight=n}r(t,"laya.d3.core.HeightMap");var e=t.prototype;return e._inBounds=function(t,e){return t>=0&&t<this._h&&e>=0&&e<this._w},e.getHeight=function(t,e){return this._inBounds(t,e)?this._datas[t][e]:NaN},a(0,e,"width",function(){return this._w}),a(0,e,"height",function(){return this._h}),a(0,e,"maxHeight",function(){return this._maxHeight}),a(0,e,"minHeight",function(){return this._minHeight}),t.creatFromMesh=function(e,i,n,r){for(var a=[],s=[],o=e.getSubMeshCount(),l=0;l<o;l++){for(var h=e.getSubMesh(l),u=h._getVertexBuffer(),_=u.getData(),c=[],d=0;d<_.length;d+=u.vertexDeclaration.vertexStride/4){var f=new Pe(_[d+0],_[d+1],_[d+2]);c.push(f)}a.push(c);var m=h._getIndexBuffer();s.push(m.getData())}var p=e.boundingBox,v=p.min.x,g=p.min.z,E=p.max.x,x=p.max.z,T=p.min.y,S=p.max.y,D=E-v,M=x-g,y=r.elements[0]=D/(i-1),A=r.elements[1]=M/(n-1),I=new t(i,n,T,S),R=t._tempRay,C=R.direction.elements;C[0]=0,C[1]=-1,C[2]=0;var b=S+.1;R.origin.elements[1]=b;for(var w=0;w<n;w++){var N=g+w*A;I._datas[w]=[];for(var P=0;P<i;P++){var L=v+P*y,O=R.origin.elements;O[0]=L,O[2]=N;var V=t._getPosition(R,a,s);I._datas[w][P]=V===Number.MAX_VALUE?NaN:b-V}}return I},t.createFromImage=function(e,i,n){for(var r=e.width,a=e.height,s=new t(r,a,i,n),o=(n-i)/254,l=e.getPixels(),h=0,u=0;u<a;u++)for(var _=s._datas[u]=[],c=0;c<r;c++){var d=l[h++],f=l[h++],m=l[h++],p=l[h++];_[c]=255==d&&255==f&&255==m&&255==p?NaN:(d+f+m)/3*o+i}return s},t._getPosition=function(t,e,i){for(var n=Number.MAX_VALUE,r=0;r<e.length;r++)for(var a=e[r],s=i[r],o=0;o<s.length;o+=3){var l=a[s[o+0]],h=a[s[o+1]],u=a[s[o+2]],_=Ze.rayIntersectsTriangle(t,l,h,u);!isNaN(_)&&_<n&&(n=_)}return n},n(t,["_tempRay",function(){return this._tempRay=new we(new Pe,new Pe)}]),t}(),k=function(){function t(){this._visible=!0,this._nonRigidbodyOffset=0,this._colliders=[]}r(t,"laya.d3.core.Layer");var e=t.prototype;return e._binarySearchIndex=function(){for(var e=0,i=t._collsionTestList.length-1,n=0;e<=i;){n=Math.floor((e+i)/2);var r=t._collsionTestList[n];if(r==this._number)return n;r>this._number?i=n-1:e=n+1}return e},e._addCollider=function(e){0===this._colliders.length&&t._collsionTestList.splice(this._binarySearchIndex(),0,this._number),e._isRigidbody?(this._colliders.unshift(e),this._nonRigidbodyOffset++):this._colliders.push(e)},e._removeCollider=function(e){var i=this._colliders.indexOf(e);i<this._nonRigidbodyOffset&&this._nonRigidbodyOffset--,this._colliders.splice(i,1),0===this._colliders.length&&t._collsionTestList.splice(t._collsionTestList.indexOf(this._number),1)},a(0,e,"number",function(){return this._number}),a(0,e,"visible",function(){return this._visible},function(e){this._visible=e,t._visibleLayers=e?t._visibleLayers|this.mask:t._visibleLayers&~this.mask}),a(0,e,"mask",function(){return this._mask}),a(1,t,"visibleLayers",function(){return t._visibleLayers},function(e){t._visibleLayers=e;for(var i=0,n=t._layerList.length;i<n;i++){var r=t._layerList[i];r._visible=0!=(r._mask&t._visibleLayers)}}),t.__init__=function(){t._layerList.length=31;for(var e=0;e<31;e++){var i=new t;t._layerList[e]=i,0===e?(i.name="Default Layer",i.visible=!0):(i.name="Layer-"+e,i.visible=!1),i._number=e,i._mask=Math.pow(2,e)}t.currentCreationLayer=t._layerList[0]},t.getLayerByNumber=function(e){if(e<0||e>30)throw new Error("无法返回指定Layer，该number超出范围！");return t._layerList[e]},t.getLayerByName=function(e){for(var i=0;i<31;i++)if(t._layerList[i].name===e)return t._layerList[i];throw new Error("无法返回指定Layer,该name不存在")},t.isVisible=function(e){return 0!=(e&t._currentCameraCullingMask&t._visibleLayers)},t._layerList=[],t._visibleLayers=2147483647,t._collsionTestList=[],t._currentCameraCullingMask=2147483647,t.maxCount=31,t.currentCreationLayer=null,t}(),W=function(){function t(t,e,i){this._time=NaN,this._minCount=0,this._maxCount=0,this._time=t,this._minCount=e,this._maxCount=i}r(t,"laya.d3.core.particleShuriKen.module.Burst");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(t){var e=t;e._time=this._time,e._minCount=this._minCount,e._maxCount=this._maxCount},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},a(0,e,"time",function(){return this._time}),a(0,e,"minCount",function(){return this._minCount}),a(0,e,"maxCount",function(){return this._maxCount}),t}(),X=function(){function t(t){this._color=null,this.enbale=!1,this._color=t}r(t,"laya.d3.core.particleShuriKen.module.ColorOverLifetime");var e=t.prototype;return e.cloneTo=function(t){var e=t;this._color.cloneTo(e._color),e.enbale=this.enbale},e.clone=function(){var t;switch(this._color.type){case 0:t=j.createByConstant(this._color.constant.clone());break;case 1:t=j.createByGradient(this._color.gradient.clone());break;case 2:t=j.createByRandomTwoConstant(this._color.constantMin.clone(),this._color.constantMax.clone());break;case 3:t=j.createByRandomTwoGradient(this._color.gradientMin.clone(),this._color.gradientMax.clone())}var e=new this.constructor(t);return e.enbale=this.enbale,e},a(0,e,"color",function(){return this._color}),t}(),Y=function(){function t(){this._destroyed=!1,this._emissionRate=0,this._bursts=null,this.enbale=!1,this._destroyed=!1,this.emissionRate=10,this._bursts=[]}r(t,"laya.d3.core.particleShuriKen.module.Emission");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0,"laya.resource.IDestroy":!0}),e._destroy=function(){this._bursts=null,this._destroyed=!0},e.getBurstsCount=function(){return this._bursts.length},e.getBurstByIndex=function(t){return this._bursts[t]},e.addBurst=function(t){var e=this._bursts.length;if(e>0)for(var i=0;i<e;i++)this._bursts[i].time>t.time&&this._bursts.splice(i,0,t);this._bursts.push(t)},e.removeBurst=function(t){var e=this._bursts.indexOf(t);-1!==e&&this._bursts.splice(e,1)},e.removeBurstByIndex=function(t){this._bursts.splice(t,1)},e.clearBurst=function(){this._bursts.length=0},e.cloneTo=function(t){var e=t,i=e._bursts;i.length=this._bursts.length;for(var n=0,r=this._bursts.length;n<r;n++){var a=i[n];a?this._bursts[n].cloneTo(a):i[n]=this._bursts[n].clone()}e._emissionRate=this._emissionRate,e.enbale=this.enbale},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},a(0,e,"destroyed",function(){return this._destroyed}),a(0,e,"emissionRate",function(){return this._emissionRate},function(t){if(t<0)throw new Error("ParticleBaseShape:emissionRate value must large or equal than 0.");this._emissionRate=t}),t}(),Z=function(){function t(){this._type=0,this._constant=0,this._overTime=null,this._constantMin=0,this._constantMax=0,this._overTimeMin=null,this._overTimeMax=null}r(t,"laya.d3.core.particleShuriKen.module.FrameOverTime");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(t){var e=t;e._type=this._type,e._constant=this._constant,this._overTime.cloneTo(e._overTime),e._constantMin=this._constantMin,e._constantMax=this._constantMax,this._overTimeMin.cloneTo(e._overTimeMin),this._overTimeMax.cloneTo(e._overTimeMax)},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},a(0,e,"frameOverTimeData",function(){return this._overTime}),a(0,e,"constant",function(){return this._constant}),a(0,e,"type",function(){return this._type}),a(0,e,"frameOverTimeDataMin",function(){return this._overTimeMin}),a(0,e,"constantMin",function(){return this._constantMin}),a(0,e,"frameOverTimeDataMax",function(){return this._overTimeMax}),a(0,e,"constantMax",function(){return this._constantMax}),t.createByConstant=function(e){var i=new t;return i._type=0,i._constant=e,i},t.createByOverTime=function(e){var i=new t;return i._type=1,i._overTime=e,i},t.createByRandomTwoConstant=function(e,i){var n=new t;return n._type=2,n._constantMin=e,n._constantMax=i,n},t.createByRandomTwoOverTime=function(e,i){var n=new t;return n._type=3,n._overTimeMin=e,n._overTimeMax=i,n},t}(),K=function(){function t(){this._type=0,this._separateAxes=!1,this._constant=NaN,this._constantSeparate=null,this._gradient=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._gradientW=null,this._constantMin=NaN,this._constantMax=NaN,this._constantMinSeparate=null,this._constantMaxSeparate=null,this._gradientMin=null,this._gradientMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null,this._gradientWMin=null,this._gradientWMax=null}r(t,"laya.d3.core.particleShuriKen.module.GradientAngularVelocity");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(t){var e=t;e._type=this._type,e._separateAxes=this._separateAxes,e._constant=this._constant,this._constantSeparate.cloneTo(e._constantSeparate),this._gradient.cloneTo(e._gradient),this._gradientX.cloneTo(e._gradientX),this._gradientY.cloneTo(e._gradientY),this._gradientZ.cloneTo(e._gradientZ),e._constantMin=this._constantMin,e._constantMax=this._constantMax,this._constantMinSeparate.cloneTo(e._constantMinSeparate),this._constantMaxSeparate.cloneTo(e._constantMaxSeparate),this._gradientMin.cloneTo(e._gradientMin),this._gradientMax.cloneTo(e._gradientMax),this._gradientXMin.cloneTo(e._gradientXMin),this._gradientXMax.cloneTo(e._gradientXMax),this._gradientYMin.cloneTo(e._gradientYMin),this._gradientYMax.cloneTo(e._gradientYMax),this._gradientZMin.cloneTo(e._gradientZMin),this._gradientZMax.cloneTo(e._gradientZMax)},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},a(0,e,"gradientZ",function(){return this._gradientZ}),a(0,e,"constant",function(){return this._constant}),a(0,e,"gradient",function(){return this._gradient}),a(0,e,"separateAxes",function(){return this._separateAxes}),a(0,e,"type",function(){return this._type}),a(0,e,"constantSeparate",function(){return this._constantSeparate}),a(0,e,"gradientX",function(){return this._gradientX}),a(0,e,"gradientY",function(){return this._gradientY}),a(0,e,"gradientW",function(){return this._gradientW}),a(0,e,"gradientMin",function(){return this._gradientMin}),a(0,e,"constantMin",function(){return this._constantMin}),a(0,e,"gradientMax",function(){return this._gradientMax}),a(0,e,"constantMax",function(){return this._constantMax}),a(0,e,"gradientWMin",function(){return this._gradientWMin}),a(0,e,"constantMinSeparate",function(){return this._constantMinSeparate}),a(0,e,"constantMaxSeparate",function(){return this._constantMaxSeparate}),a(0,e,"gradientXMin",function(){return this._gradientXMin}),a(0,e,"gradientXMax",function(){return this._gradientXMax}),a(0,e,"gradientWMax",function(){return this._gradientWMax}),a(0,e,"gradientYMin",function(){return this._gradientYMin}),a(0,e,"gradientYMax",function(){return this._gradientYMax}),a(0,e,"gradientZMin",function(){return this._gradientZMin}),a(0,e,"gradientZMax",function(){return this._gradientZMax}),t.createByConstant=function(e){var i=new t;return i._type=0,i._separateAxes=!1,i._constant=e,i},t.createByConstantSeparate=function(e){var i=new t;return i._type=0,i._separateAxes=!0,i._constantSeparate=e,i},t.createByGradient=function(e){var i=new t;return i._type=1,i._separateAxes=!1,i._gradient=e,i},t.createByGradientSeparate=function(e,i,n,r){var a=new t;return a._type=1,a._separateAxes=!0,a._gradientX=e,a._gradientY=i,a._gradientZ=n,a._gradientW=r,a},t.createByRandomTwoConstant=function(e,i){var n=new t;return n._type=2,n._separateAxes=!1,n._constantMin=e,n._constantMax=i,n},t.createByRandomTwoConstantSeparate=function(e,i){var n=new t;return n._type=2,n._separateAxes=!0,n._constantMinSeparate=e,n._constantMaxSeparate=i,n},t.createByRandomTwoGradient=function(e,i){var n=new t;return n._type=3,n._separateAxes=!1,n._gradientMin=e,n._gradientMax=i,n},t.createByRandomTwoGradientSeparate=function(e,i,n,r,a,s,o,l){var h=new t;return h._type=3,h._separateAxes=!0,h._gradientXMin=e,h._gradientXMax=i,h._gradientYMin=n,h._gradientYMax=r,h._gradientZMin=a,h._gradientZMax=s,h._gradientWMin=o,h._gradientWMax=l,h},t}(),j=function(){function t(){this._type=0,this._constant=null,this._constantMin=null,this._constantMax=null,this._gradient=null,this._gradientMin=null,this._gradientMax=null}r(t,"laya.d3.core.particleShuriKen.module.GradientColor");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(t){var e=t;e._type=this._type,this._constant.cloneTo(e._constant),this._constantMin.cloneTo(e._constantMin),this._constantMax.cloneTo(e._constantMax),this._gradient.cloneTo(e._gradient),this._gradientMin.cloneTo(e._gradientMin),this._gradientMax.cloneTo(e._gradientMax)},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},a(0,e,"gradient",function(){return this._gradient}),a(0,e,"constant",function(){return this._constant}),a(0,e,"type",function(){return this._type}),a(0,e,"gradientMin",function(){return this._gradientMin}),a(0,e,"constantMin",function(){return this._constantMin}),a(0,e,"gradientMax",function(){return this._gradientMax}),a(0,e,"constantMax",function(){return this._constantMax}),t.createByConstant=function(e){var i=new t;return i._type=0,i._constant=e,i},t.createByGradient=function(e){var i=new t;return i._type=1,i._gradient=e,i},t.createByRandomTwoConstant=function(e,i){var n=new t;return n._type=2,n._constantMin=e,n._constantMax=i,n},t.createByRandomTwoGradient=function(e,i){var n=new t;return n._type=3,n._gradientMin=e,n._gradientMax=i,n},t}(),q=function(){function t(){this._alphaCurrentLength=0,this._rgbCurrentLength=0,this._alphaElements=null,this._rgbElements=null,this._alphaElements=new Float32Array(8),this._rgbElements=new Float32Array(16)}r(t,"laya.d3.core.particleShuriKen.module.GradientDataColor");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.addAlpha=function(t,e){this._alphaCurrentLength<8?(6===this._alphaCurrentLength&&1!==t&&(t=1,console.log("GradientDataColor warning:the forth key is  be force set to 1.")),this._alphaElements[this._alphaCurrentLength++]=t,this._alphaElements[this._alphaCurrentLength++]=e):console.log("GradientDataColor warning:data count must lessEqual than 4")},e.addRGB=function(t,e){this._rgbCurrentLength<16?(12===this._rgbCurrentLength&&1!==t&&(t=1,console.log("GradientDataColor warning:the forth key is  be force set to 1.")),this._rgbElements[this._rgbCurrentLength++]=t,this._rgbElements[this._rgbCurrentLength++]=e.x,this._rgbElements[this._rgbCurrentLength++]=e.y,this._rgbElements[this._rgbCurrentLength++]=e.z):console.log("GradientDataColor warning:data count must lessEqual than 4")},e.cloneTo=function(t){var e=t,i=0,n=0;e._alphaCurrentLength=this._alphaCurrentLength;var r=e._alphaElements;for(r.length=this._alphaElements.length,i=0,n=this._alphaElements.length;i<n;i++)r[i]=this._alphaElements[i];e._rgbCurrentLength=this._rgbCurrentLength;var a=e._rgbElements;for(a.length=this._rgbElements.length,i=0,n=this._rgbElements.length;i<n;i++)a[i]=this._rgbElements[i]},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},a(0,e,"alphaGradientCount",function(){return this._alphaCurrentLength/2}),a(0,e,"rgbGradientCount",function(){return this._rgbCurrentLength/4}),t}(),Q=function(){function t(){this._currentLength=0,this._elements=null,this._elements=new Float32Array(8)}r(t,"laya.d3.core.particleShuriKen.module.GradientDataInt");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.add=function(t,e){this._currentLength<8?(6===this._currentLength&&1!==t&&(t=1,console.log("Warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=t,this._elements[this._currentLength++]=e):console.log("Warning:data count must lessEqual than 4")},e.cloneTo=function(t){var e=t;e._currentLength=this._currentLength;var i=e._elements;i.length=this._elements.length;for(var n=0,r=this._elements.length;n<r;n++)i[n]=this._elements[n]},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},a(0,e,"gradientCount",function(){return this._currentLength/2}),t}(),$=function(){function t(){this._currentLength=0,this._elements=null,this._elements=new Float32Array(8)}r(t,"laya.d3.core.particleShuriKen.module.GradientDataNumber");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.add=function(t,e){this._currentLength<8?(6===this._currentLength&&1!==t&&(t=1,console.log("GradientDataNumber warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=t,this._elements[this._currentLength++]=e):console.log("GradientDataNumber warning:data count must lessEqual than 4")},e.getKeyByIndex=function(t){return this._elements[2*t]},e.getValueByIndex=function(t){return this._elements[2*t+1]},e.getAverageValue=function(){for(var t=0,e=this._currentLength-2;t<e;t+=2){var i=this._elements[t+1];i+=this._elements[t+3],i*=this._elements[t+2]-this._elements[t]}return 0},e.cloneTo=function(t){var e=t;e._currentLength=this._currentLength;var i=e._elements;i.length=this._elements.length;for(var n=0,r=this._elements.length;n<r;n++)i[n]=this._elements[n]},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},a(0,e,"gradientCount",function(){return this._currentLength/2}),t}(),J=(function(){function t(){this._currentLength=0,this._elements=null,this._elements=new Float32Array(12)}r(t,"laya.d3.core.particleShuriKen.module.GradientDataVector2");var e=t.prototype;i.imps(e,{"laya.d3.core.IClone":!0}),e.add=function(t,e){this._currentLength<8?(6===this._currentLength&&1!==t&&(t=1,console.log("GradientDataVector2 warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=t,this._elements[this._currentLength++]=e.x,this._elements[this._currentLength++]=e.y):console.log("GradientDataVector2 warning:data count must lessEqual than 4")},e.cloneTo=function(t){var e=t;e._currentLength=this._currentLength;var i=e._elements;i.length=this._elements.length;for(var n=0,r=this._elements.length;n<r;n++)i[n]=this._elements[n]},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},a(0,e,"gradientCount",function(){return this._currentLength/3})}(),function(){function t(){this._type=0,this._separateAxes=!1,this._gradient=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._constantMin=NaN,this._constantMax=NaN,this._constantMinSeparate=null,this._constantMaxSeparate=null,this._gradientMin=null,this._gradientMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null}r(t,"laya.d3.core.particleShuriKen.module.GradientSize");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.getMaxSizeInGradient=function(){var t=0,e=0,i=-Number.MAX_VALUE;switch(this._type){case 0:if(this._separateAxes){for(t=0,e=this._gradientX.gradientCount;t<e;t++)i=Math.max(i,this._gradientX.getValueByIndex(t));for(t=0,e=this._gradientY.gradientCount;t<e;t++)i=Math.max(i,this._gradientY.getValueByIndex(t))}else for(t=0,e=this._gradient.gradientCount;t<e;t++)i=Math.max(i,this._gradient.getValueByIndex(t));break;case 1:this._separateAxes?(i=Math.max(this._constantMinSeparate.x,this._constantMaxSeparate.x),i=Math.max(i,this._constantMinSeparate.y),i=Math.max(i,this._constantMaxSeparate.y)):i=Math.max(this._constantMin,this._constantMax);break;case 2:if(this._separateAxes){for(t=0,e=this._gradientXMin.gradientCount;t<e;t++)i=Math.max(i,this._gradientXMin.getValueByIndex(t));for(t=0,e=this._gradientXMax.gradientCount;t<e;t++)i=Math.max(i,this._gradientXMax.getValueByIndex(t));for(t=0,e=this._gradientYMin.gradientCount;t<e;t++)i=Math.max(i,this._gradientYMin.getValueByIndex(t));for(t=0,e=this._gradientZMax.gradientCount;t<e;t++)i=Math.max(i,this._gradientZMax.getValueByIndex(t))}else{for(t=0,e=this._gradientMin.gradientCount;t<e;t++)i=Math.max(i,this._gradientMin.getValueByIndex(t));for(t=0,e=this._gradientMax.gradientCount;t<e;t++)i=Math.max(i,this._gradientMax.getValueByIndex(t))}}return i},e.cloneTo=function(t){var e=t;e._type=this._type,e._separateAxes=this._separateAxes,this._gradient.cloneTo(e._gradient),this._gradientX.cloneTo(e._gradientX),this._gradientY.cloneTo(e._gradientY),this._gradientZ.cloneTo(e._gradientZ),e._constantMin=this._constantMin,e._constantMax=this._constantMax,this._constantMinSeparate.cloneTo(e._constantMinSeparate),this._constantMaxSeparate.cloneTo(e._constantMaxSeparate),this._gradientMin.cloneTo(e._gradientMin),this._gradientMax.cloneTo(e._gradientMax),this._gradientXMin.cloneTo(e._gradientXMin),this._gradientXMax.cloneTo(e._gradientXMax),this._gradientYMin.cloneTo(e._gradientYMin),this._gradientYMax.cloneTo(e._gradientYMax),this._gradientZMin.cloneTo(e._gradientZMin),this._gradientZMax.cloneTo(e._gradientZMax)},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},a(0,e,"gradientZ",function(){return this._gradientZ}),a(0,e,"gradient",function(){return this._gradient}),a(0,e,"separateAxes",function(){return this._separateAxes}),a(0,e,"type",function(){return this._type}),a(0,e,"gradientMin",function(){return this._gradientMin}),a(0,e,"constantMin",function(){return this._constantMin}),a(0,e,"gradientX",function(){return this._gradientX}),a(0,e,"gradientY",function(){return this._gradientY}),a(0,e,"gradientMax",function(){return this._gradientMax}),a(0,e,"constantMax",function(){return this._constantMax}),a(0,e,"constantMinSeparate",function(){return this._constantMinSeparate}),a(0,e,"constantMaxSeparate",function(){return this._constantMaxSeparate}),a(0,e,"gradientXMin",function(){return this._gradientXMin}),a(0,e,"gradientXMax",function(){return this._gradientXMax}),a(0,e,"gradientYMin",function(){return this._gradientYMin}),a(0,e,"gradientYMax",function(){return this._gradientYMax}),a(0,e,"gradientZMin",function(){return this._gradientZMin}),a(0,e,"gradientZMax",function(){return this._gradientZMax}),t.createByGradient=function(e){var i=new t;return i._type=0,i._separateAxes=!1,i._gradient=e,i},t.createByGradientSeparate=function(e,i,n){var r=new t;return r._type=0,r._separateAxes=!0,r._gradientX=e,r._gradientY=i,r._gradientZ=n,r},t.createByRandomTwoConstant=function(e,i){var n=new t;return n._type=1,n._separateAxes=!1,n._constantMin=e,n._constantMax=i,n},t.createByRandomTwoConstantSeparate=function(e,i){var n=new t;return n._type=1,n._separateAxes=!0,n._constantMinSeparate=e,n._constantMaxSeparate=i,n},t.createByRandomTwoGradient=function(e,i){var n=new t;return n._type=2,n._separateAxes=!1,n._gradientMin=e,n._gradientMax=i,n},t.createByRandomTwoGradientSeparate=function(e,i,n,r,a,s){var o=new t;return o._type=2,o._separateAxes=!0,o._gradientXMin=e,o._gradientXMax=i,o._gradientYMin=n,o._gradientYMax=r,o._gradientZMin=a,o._gradientZMax=s,o},t}()),tt=function(){function t(){this._type=0,this._constant=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._constantMin=null,this._constantMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null}r(t,"laya.d3.core.particleShuriKen.module.GradientVelocity");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(t){var e=t;e._type=this._type,this._constant.cloneTo(e._constant),this._gradientX.cloneTo(e._gradientX),this._gradientY.cloneTo(e._gradientY),this._gradientZ.cloneTo(e._gradientZ),this._constantMin.cloneTo(e._constantMin),this._constantMax.cloneTo(e._constantMax),this._gradientXMin.cloneTo(e._gradientXMin),this._gradientXMax.cloneTo(e._gradientXMax),this._gradientYMin.cloneTo(e._gradientYMin),this._gradientYMax.cloneTo(e._gradientYMax),this._gradientZMin.cloneTo(e._gradientZMin),this._gradientZMax.cloneTo(e._gradientZMax)},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},a(0,e,"gradientZ",function(){return this._gradientZ}),a(0,e,"constant",function(){return this._constant}),a(0,e,"type",function(){return this._type}),a(0,e,"gradientXMax",function(){return this._gradientXMax}),a(0,e,"constantMin",function(){return this._constantMin}),a(0,e,"gradientX",function(){return this._gradientX}),a(0,e,"gradientY",function(){return this._gradientY}),a(0,e,"gradientXMin",function(){return this._gradientXMin}),a(0,e,"constantMax",function(){return this._constantMax}),a(0,e,"gradientYMin",function(){return this._gradientYMin}),a(0,e,"gradientYMax",function(){return this._gradientYMax}),a(0,e,"gradientZMin",function(){return this._gradientZMin}),a(0,e,"gradientZMax",function(){return this._gradientZMax}),t.createByConstant=function(e){var i=new t;return i._type=0,i._constant=e,i},t.createByGradient=function(e,i,n){var r=new t;return r._type=1,r._gradientX=e,r._gradientY=i,r._gradientZ=n,r},t.createByRandomTwoConstant=function(e,i){var n=new t;return n._type=2,n._constantMin=e,n._constantMax=i,n},t.createByRandomTwoGradient=function(e,i,n,r,a,s){var o=new t;return o._type=3,o._gradientXMin=e,o._gradientXMax=i,o._gradientYMin=n,o._gradientYMax=r,o._gradientZMin=a,o._gradientZMax=s,o},t}(),et=function(){function t(t){this._angularVelocity=null,this.enbale=!1,this._angularVelocity=t}r(t,"laya.d3.core.particleShuriKen.module.RotationOverLifetime");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(t){var e=t;this._angularVelocity.cloneTo(e._angularVelocity),e.enbale=this.enbale},e.clone=function(){var t;switch(this._angularVelocity.type){case 0:t=this._angularVelocity.separateAxes?K.createByConstantSeparate(this._angularVelocity.constantSeparate.clone()):K.createByConstant(this._angularVelocity.constant);break;case 1:t=this._angularVelocity.separateAxes?K.createByGradientSeparate(this._angularVelocity.gradientX.clone(),this._angularVelocity.gradientY.clone(),this._angularVelocity.gradientZ.clone(),this._angularVelocity.gradientW.clone()):K.createByGradient(this._angularVelocity.gradient.clone());break;case 2:t=this._angularVelocity.separateAxes?K.createByRandomTwoConstantSeparate(this._angularVelocity.constantMinSeparate.clone(),this._angularVelocity.constantMaxSeparate.clone()):K.createByRandomTwoConstant(this._angularVelocity.constantMin,this._angularVelocity.constantMax);break;case 3:t=this._angularVelocity.separateAxes?K.createByRandomTwoGradientSeparate(this._angularVelocity.gradientXMin.clone(),this._angularVelocity.gradientYMin.clone(),this._angularVelocity.gradientZMin.clone(),this._angularVelocity.gradientWMin.clone(),this._angularVelocity.gradientXMax.clone(),this._angularVelocity.gradientYMax.clone(),this._angularVelocity.gradientZMax.clone(),this._angularVelocity.gradientWMax.clone()):K.createByRandomTwoGradient(this._angularVelocity.gradientMin.clone(),this._angularVelocity.gradientMax.clone())}var e=new this.constructor(t);return e.enbale=this.enbale,e},a(0,e,"angularVelocity",function(){return this._angularVelocity}),t}(),it=function(){function t(){this.enable=!1,this.randomDirection=!1}r(t,"laya.d3.core.particleShuriKen.module.shape.BaseShape");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e._getShapeBoundBox=function(t){throw new Error("BaseShape: must override it.")},e._getSpeedBoundBox=function(t){throw new Error("BaseShape: must override it.")},e.generatePositionAndDirection=function(t,e,i,n){throw new Error("BaseShape: must override it.")},e._calculateProceduralBounds=function(t,e,i){this._getShapeBoundBox(t);var n=t.min,r=t.max;Pe.multiply(n,e,n),Pe.multiply(r,e,r);var a=new xe(new Pe,new Pe);this.randomDirection?(a.min=new Pe(-1,-1,-1),a.max=new Pe(1,1,1)):this._getSpeedBoundBox(a);var s=new xe(new Pe,new Pe),o=s.min,l=s.max;Pe.scale(a.min,i.y,o),Pe.scale(a.max,i.y,l),Pe.add(t.min,o,o),Pe.add(t.max,l,l),Pe.min(t.min,o,t.min),Pe.max(t.max,o,t.max);var h=new xe(new Pe,new Pe),u=h.min,_=h.max;Pe.scale(a.min,i.x,u),Pe.scale(a.max,i.x,_),Pe.min(h.min,_,o),Pe.max(h.min,_,l),Pe.min(t.min,o,t.min),Pe.max(t.max,o,t.max)},e.cloneTo=function(t){t.enable=this.enable},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},t}(),nt=function(){function t(){}return r(t,"laya.d3.core.particleShuriKen.module.shape.ShapeUtils"),t._randomPointUnitArcCircle=function(t,e,i){var n=e.elements,r=NaN;r=i?i.getFloat()*t:Math.random()*t,n[0]=Math.cos(r),n[1]=Math.sin(r)},t._randomPointInsideUnitArcCircle=function(e,i,n){var r=i.elements;t._randomPointUnitArcCircle(e,i,n);var a=NaN;a=n?Math.pow(n.getFloat(),.5):Math.pow(Math.random(),.5),r[0]=r[0]*a,r[1]=r[1]*a},t._randomPointUnitCircle=function(t,e){var i=t.elements,n=NaN;n=e?e.getFloat()*Math.PI*2:Math.random()*Math.PI*2,i[0]=Math.cos(n),i[1]=Math.sin(n)},t._randomPointInsideUnitCircle=function(e,i){var n=e.elements;t._randomPointUnitCircle(e);var r=NaN;r=i?Math.pow(i.getFloat(),.5):Math.pow(Math.random(),.5),n[0]=n[0]*r,n[1]=n[1]*r},t._randomPointUnitSphere=function(t,e){var i=t.elements,n=NaN,r=NaN;e?(n=i[2]=2*e.getFloat()-1,r=e.getFloat()*Math.PI*2):(n=i[2]=2*Math.random()-1,r=Math.random()*Math.PI*2);var a=Math.sqrt(1-n*n);i[0]=a*Math.cos(r),i[1]=a*Math.sin(r)},t._randomPointInsideUnitSphere=function(e,i){var n=e.elements;t._randomPointUnitSphere(e);var r=NaN;r=i?Math.pow(i.getFloat(),1/3):Math.pow(Math.random(),1/3),n[0]=n[0]*r,n[1]=n[1]*r,n[2]=n[2]*r},t._randomPointInsideHalfUnitBox=function(t,e){var i=t.elements;e?(i[0]=e.getFloat()-.5,i[1]=e.getFloat()-.5,i[2]=e.getFloat()-.5):(i[0]=Math.random()-.5,i[1]=Math.random()-.5,i[2]=Math.random()-.5)},t}(),rt=function(){function t(t){this._size=null,this.enbale=!1,this._size=t}r(t,"laya.d3.core.particleShuriKen.module.SizeOverLifetime");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(t){var e=t;this._size.cloneTo(e._size),e.enbale=this.enbale},e.clone=function(){var t;switch(this._size.type){case 0:t=this._size.separateAxes?J.createByGradientSeparate(this._size.gradientX.clone(),this._size.gradientY.clone(),this._size.gradientZ.clone()):J.createByGradient(this._size.gradient.clone());break;case 1:t=this._size.separateAxes?J.createByRandomTwoConstantSeparate(this._size.constantMinSeparate.clone(),this._size.constantMaxSeparate.clone()):J.createByRandomTwoConstant(this._size.constantMin,this._size.constantMax);break;case 2:t=this._size.separateAxes?J.createByRandomTwoGradientSeparate(this._size.gradientXMin.clone(),this._size.gradientYMin.clone(),this._size.gradientZMin.clone(),this._size.gradientXMax.clone(),this._size.gradientYMax.clone(),this._size.gradientZMax.clone()):J.createByRandomTwoGradient(this._size.gradientMin.clone(),this._size.gradientMax.clone())}var e=new this.constructor(t);return e.enbale=this.enbale,e},a(0,e,"size",function(){return this._size}),t}(),at=function(){function t(){this._type=0,this._constant=NaN,this._constantMin=NaN,this._constantMax=NaN}r(t,"laya.d3.core.particleShuriKen.module.StartFrame");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(t){var e=t;e._type=this._type,e._constant=this._constant,e._constantMin=this._constantMin,e._constantMax=this._constantMax},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},a(0,e,"constant",function(){return this._constant}),a(0,e,"type",function(){return this._type}),a(0,e,"constantMin",function(){return this._constantMin}),a(0,e,"constantMax",function(){return this._constantMax}),t.createByConstant=function(e){var i=new t;return i._type=0,i._constant=e,i},t.createByRandomTwoConstant=function(e,i){var n=new t;return n._type=1,n._constantMin=e,n._constantMax=i,n},t}(),st=function(){function t(t,e){this._frame=null,this._startFrame=null,this.tiles=null,this.type=0,this.randomRow=!1,this.rowIndex=0,this.cycles=0,this.enableUVChannels=0,this.enable=!1,this.tiles=new Ne(1,1),this.type=0,this.randomRow=!0,this.rowIndex=0,this.cycles=1,this.enableUVChannels=1,this._frame=t,this._startFrame=e}r(t,"laya.d3.core.particleShuriKen.module.TextureSheetAnimation");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(t){var e=t;this.tiles.cloneTo(e.tiles),e.type=this.type,e.randomRow=this.randomRow,this._frame.cloneTo(e._frame),this._startFrame.cloneTo(e._startFrame),e.cycles=this.cycles,e.enableUVChannels=this.enableUVChannels,e.enable=this.enable},e.clone=function(){var t;switch(this._frame.type){case 0:t=Z.createByConstant(this._frame.constant);break;case 1:t=Z.createByOverTime(this._frame.frameOverTimeData.clone());break;case 2:t=Z.createByRandomTwoConstant(this._frame.constantMin,this._frame.constantMax);break;case 3:t=Z.createByRandomTwoOverTime(this._frame.frameOverTimeDataMin.clone(),this._frame.frameOverTimeDataMax.clone())}var e;switch(this._startFrame.type){case 0:e=at.createByConstant(this._startFrame.constant);break;case 1:e=at.createByRandomTwoConstant(this._startFrame.constantMin,this._startFrame.constantMax)}var i=new this.constructor(t,e);return this.tiles.cloneTo(i.tiles),i.type=this.type,i.randomRow=this.randomRow,i.cycles=this.cycles,i.enableUVChannels=this.enableUVChannels,i.enable=this.enable,i},a(0,e,"frame",function(){return this._frame}),a(0,e,"startFrame",function(){return this._startFrame}),t}(),ot=function(){function t(t){this._velocity=null,this.enbale=!1,this.space=0,this._velocity=t}r(t,"laya.d3.core.particleShuriKen.module.VelocityOverLifetime");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.cloneTo=function(t){var e=t;this._velocity.cloneTo(e._velocity),e.enbale=this.enbale,e.space=this.space},e.clone=function(){var t;switch(this._velocity.type){case 0:t=tt.createByConstant(this._velocity.constant.clone());break;case 1:t=tt.createByGradient(this._velocity.gradientX.clone(),this._velocity.gradientY.clone(),this._velocity.gradientZ.clone());break;case 2:t=tt.createByRandomTwoConstant(this._velocity.constantMin.clone(),this._velocity.constantMax.clone());break;case 3:t=tt.createByRandomTwoGradient(this._velocity.gradientXMin.clone(),this._velocity.gradientYMin.clone(),this._velocity.gradientZMin.clone(),this._velocity.gradientXMax.clone(),this._velocity.gradientYMax.clone(),this._velocity.gradientZMax.clone())}var e=new this.constructor(t);return e.enbale=this.enbale,e.space=this.space,e},a(0,e,"velocity",function(){return this._velocity}),t}(),lt=function(){function t(){}return r(t,"laya.d3.core.particleShuriKen.ShurikenParticleData"),t._getStartLifetimeFromGradient=function(t,e){for(var i=1,n=t.gradientCount;i<n;i++){var r=t.getKeyByIndex(i);if(r>=e){var a=t.getKeyByIndex(i-1),s=(e-a)/(r-a);return T.lerp(t.getValueByIndex(i-1),t.getValueByIndex(i),s)}}throw new Error("ShurikenParticleData: can't get value foam startLifeTimeGradient.")},t._randomInvertRoationArray=function(t,e,i,n,r){var a=NaN;n?(n.seed=r[6],a=n.getFloat(),r[6]=n.seed):a=Math.random(),a<i?(e[0]=-t[0],e[1]=-t[1],e[2]=-t[2]):(e[0]=t[0],e[1]=t[1],e[2]=t[2])},t._randomInvertRoation=function(t,e,i,n){var r=NaN;return i?(i.seed=n[6],r=i.getFloat(),n[6]=i.seed):r=Math.random(),r<e&&(t=-t),t},t.create=function(e,i,n){var r=e.autoRandomSeed,a=e._rand,s=e._randomSeeds;switch(e.startColorType){case 0:var o=e.startColorConstant.elements;t.startColor[0]=o[0],t.startColor[1]=o[1],t.startColor[2]=o[2],t.startColor[3]=o[3];break;case 2:r?T.lerpVector4(e.startColorConstantMin.elements,e.startColorConstantMax.elements,Math.random(),t.startColor):(a.seed=s[3],T.lerpVector4(e.startColorConstantMin.elements,e.startColorConstantMax.elements,a.getFloat(),t.startColor),s[3]=a.seed)}var l=e.colorOverLifetime;if(l&&l.enbale){var h=l.color;switch(h.type){case 0:t.startColor[0]=t.startColor[0]*h.constant.x,t.startColor[1]=t.startColor[1]*h.constant.y,t.startColor[2]=t.startColor[2]*h.constant.z,t.startColor[3]=t.startColor[3]*h.constant.w;break;case 2:var u=NaN;r?u=Math.random():(a.seed=s[10],u=a.getFloat(),s[10]=a.seed);var _=h.constantMin,c=h.constantMax;t.startColor[0]=t.startColor[0]*T.lerp(_.x,c.x,u),t.startColor[1]=t.startColor[1]*T.lerp(_.y,c.y,u),t.startColor[2]=t.startColor[2]*T.lerp(_.z,c.z,u),t.startColor[3]=t.startColor[3]*T.lerp(_.w,c.w,u)}}var d=t.startSize;switch(e.startSizeType){case 0:if(e.threeDStartSize){var f=e.startSizeConstantSeparate;d[0]=f.x,d[1]=f.y,d[2]=f.z}else d[0]=d[1]=d[2]=e.startSizeConstant;break;case 2:if(e.threeDStartSize){var m=e.startSizeConstantMinSeparate,p=e.startSizeConstantMaxSeparate;r?(d[0]=T.lerp(m.x,p.x,Math.random()),d[1]=T.lerp(m.y,p.y,Math.random()),d[2]=T.lerp(m.z,p.z,Math.random())):(a.seed=s[4],d[0]=T.lerp(m.x,p.x,a.getFloat()),d[1]=T.lerp(m.y,p.y,a.getFloat()),d[2]=T.lerp(m.z,p.z,a.getFloat()),s[4]=a.seed)}else r?d[0]=d[1]=d[2]=T.lerp(e.startSizeConstantMin,e.startSizeConstantMax,Math.random()):(a.seed=s[4],d[0]=d[1]=d[2]=T.lerp(e.startSizeConstantMin,e.startSizeConstantMax,a.getFloat()),s[4]=a.seed)}var v=e.sizeOverLifetime;if(v&&v.enbale&&1===v.size.type){var g=v.size;if(g.separateAxes)r?(d[0]=d[0]*T.lerp(g.constantMinSeparate.x,g.constantMaxSeparate.x,Math.random()),d[1]=d[1]*T.lerp(g.constantMinSeparate.y,g.constantMaxSeparate.y,Math.random()),d[2]=d[2]*T.lerp(g.constantMinSeparate.z,g.constantMaxSeparate.z,Math.random())):(a.seed=s[11],d[0]=d[0]*T.lerp(g.constantMinSeparate.x,g.constantMaxSeparate.x,a.getFloat()),d[1]=d[1]*T.lerp(g.constantMinSeparate.y,g.constantMaxSeparate.y,a.getFloat()),d[2]=d[2]*T.lerp(g.constantMinSeparate.z,g.constantMaxSeparate.z,a.getFloat()),s[11]=a.seed);else{var E=NaN;r?E=T.lerp(g.constantMin,g.constantMax,Math.random()):(a.seed=s[11],E=T.lerp(g.constantMin,g.constantMax,a.getFloat()),s[11]=a.seed),d[0]=d[0]*E,d[1]=d[1]*E,d[2]=d[2]*E}}var x=i.renderMode;if(1!==x)switch(e.startRotationType){case 0:if(e.threeDStartRotation){var S=e.startRotationConstantSeparate,D=t._tempVector30.elements;t._randomInvertRoationArray(S.elements,D,e.randomizeRotationDirection,r?null:a,s),t.startRotation[0]=D[0],t.startRotation[1]=D[1],t.startRotation[2]=4!==x?-D[2]:D[2]}else t.startRotation[0]=t._randomInvertRoation(e.startRotationConstant,e.randomizeRotationDirection,r?null:a,s);break;case 2:if(e.threeDStartRotation){var M=e.startRotationConstantMinSeparate,y=e.startRotationConstantMaxSeparate,A=t._tempVector30.elements;r?(A[0]=T.lerp(M.x,y.x,Math.random()),A[1]=T.lerp(M.y,y.y,Math.random()),A[2]=T.lerp(M.z,y.z,Math.random())):(a.seed=s[5],A[0]=T.lerp(M.x,y.x,a.getFloat()),A[1]=T.lerp(M.y,y.y,a.getFloat()),A[2]=T.lerp(M.z,y.z,a.getFloat()),s[5]=a.seed),t._randomInvertRoationArray(A,A,e.randomizeRotationDirection,r?null:a,s),t.startRotation[0]=A[0],t.startRotation[1]=A[1],t.startRotation[2]=4!==x?-A[2]:A[2]}else r?t.startRotation[0]=t._randomInvertRoation(T.lerp(e.startRotationConstantMin,e.startRotationConstantMax,Math.random()),e.randomizeRotationDirection,r?null:a,s):(a.seed=s[5],t.startRotation[0]=t._randomInvertRoation(T.lerp(e.startRotationConstantMin,e.startRotationConstantMax,a.getFloat()),e.randomizeRotationDirection,r?null:a,s),s[5]=a.seed)}switch(e.startLifetimeType){case 0:t.startLifeTime=e.startLifetimeConstant;break;case 1:t.startLifeTime=t._getStartLifetimeFromGradient(e.startLifeTimeGradient,e.emissionTime);break;case 2:r?t.startLifeTime=T.lerp(e.startLifetimeConstantMin,e.startLifetimeConstantMax,Math.random()):(a.seed=s[7],t.startLifeTime=T.lerp(e.startLifetimeConstantMin,e.startLifetimeConstantMax,a.getFloat()),s[7]=a.seed);break;case 3:var I=e.emissionTime;r?t.startLifeTime=T.lerp(t._getStartLifetimeFromGradient(e.startLifeTimeGradientMin,I),t._getStartLifetimeFromGradient(e.startLifeTimeGradientMax,I),Math.random()):(a.seed=s[7],t.startLifeTime=T.lerp(t._getStartLifetimeFromGradient(e.startLifeTimeGradientMin,I),t._getStartLifetimeFromGradient(e.startLifeTimeGradientMax,I),a.getFloat()),s[7]=a.seed)}switch(e.startSpeedType){case 0:t.startSpeed=e.startSpeedConstant;break;case 2:r?t.startSpeed=T.lerp(e.startSpeedConstantMin,e.startSpeedConstantMax,Math.random()):(a.seed=s[8],t.startSpeed=T.lerp(e.startSpeedConstantMin,e.startSpeedConstantMax,a.getFloat()),s[8]=a.seed)}var R=e.textureSheetAnimation;if(R&&R.enable){var C=R.tiles,b=C.x,w=C.y,N=1/b,P=1/w,L=0,O=R.startFrame;switch(O.type){case 0:L=O.constant;break;case 1:r?L=T.lerp(O.constantMin,O.constantMax,Math.random()):(a.seed=s[14],L=T.lerp(O.constantMin,O.constantMax,a.getFloat()),s[14]=a.seed)}var V=R.frame;switch(V.type){case 0:L+=V.constant;break;case 2:r?L+=T.lerp(V.constantMin,V.constantMax,Math.random()):(a.seed=s[15],L+=T.lerp(V.constantMin,V.constantMax,a.getFloat()),s[15]=a.seed)}var F=0;switch(R.type){case 0:F=Math.floor(L/b);break;case 1:R.randomRow?r?F=Math.floor(Math.random()*w):(a.seed=s[13],F=Math.floor(a.getFloat()*w),s[13]=a.seed):F=R.rowIndex}var B=Math.floor(L%b);t.startUVInfo=t.startUVInfo,t.startUVInfo[0]=N,t.startUVInfo[1]=P,t.startUVInfo[2]=B*N,t.startUVInfo[3]=F*P}else t.startUVInfo=t.startUVInfo,t.startUVInfo[0]=1,t.startUVInfo[1]=1,t.startUVInfo[2]=0,t.startUVInfo[3]=0;switch(e.simulationSpace){case 0:var U=n.position.elements;t.simulationWorldPostion[0]=U[0],t.simulationWorldPostion[1]=U[1],t.simulationWorldPostion[2]=U[2];var H=n.rotation.elements;t.simulationWorldRotation[0]=H[0],t.simulationWorldRotation[1]=H[1],t.simulationWorldRotation[2]=H[2],t.simulationWorldRotation[3]=H[3];break;case 1:break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.")}},t.startLifeTime=NaN,t.startSpeed=NaN,n(t,["_tempVector30",function(){return this._tempVector30=new Pe},"_tempQuaternion",function(){return this._tempQuaternion=new Ce},"startColor",function(){return this.startColor=new Float32Array(4)},"startSize",function(){return this.startSize=new Float32Array(3)},"startRotation",function(){return this.startRotation=new Float32Array(3)},"startUVInfo",function(){return this.startUVInfo=new Float32Array(4)},"simulationWorldPostion",function(){return this.simulationWorldPostion=new Float32Array(3)},"simulationWorldRotation",function(){return this.simulationWorldRotation=new Float32Array(4)}]),t}(),ht=function(){function t(){this._tempInt0=0,this._tempInt1=0,this._tempUint0=0,this._tempUint1=0,this._tempUint2=0,this._tempUint3=0,this._tempUint4=0,this._tempUint5=0,this._tempUint6=0,this._tempUint7=0,this._tempNumver0=NaN,this._tempNumver1=NaN,this._tempNumver2=NaN,this._tempNumver3=NaN,this._floatSizePerVer=7,this._defaultBufferSize=600*this._floatSizePerVer,this._vb=null,this._posInVBData=0,this._ib=null,this._posInIBData=0,this._primitiveType=NaN,this._hasBegun=!1,this._numVertsPerPrimitive=0,this._camera=null,this._sharderNameID=0,this._shader=null,this._shaderCompile=null,this._vbData=new Float32Array(this._defaultBufferSize),this._ibData=new Uint16Array(this._defaultBufferSize),this._spriteShaderValue=new He,this._vb=Ki.create(t._vertexDeclaration,this._defaultBufferSize/this._floatSizePerVer,35048),this._ib=Zi.create("ushort",this._defaultBufferSize,35048),this._sharderNameID=Fi.nameKey.getID("LINE"),this._shaderCompile=ui._preCompileShader[this._sharderNameID]}r(t,"laya.d3.core.PhasorSpriter3D");var e=t.prototype;return e.line=function(t,e,i,n){return this._hasBegun&&1===this._primitiveType||this.drawLinesException(),(this._posInVBData+2*this._floatSizePerVer>this._vbData.length||this._posInIBData+2>this._ibData.length)&&this.flush(),this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(t.x,t.y,t.z,e.x,e.y,e.z,e.w),this.addVertex(i.x,i.y,i.z,n.x,n.y,n.z,n.w),this.addIndexes(this._tempUint0,this._tempUint0+1),this},e.circle=function(t,e,i,n,r,a){for(this._hasBegun&&1===this._primitiveType||this.drawLinesException(),this._tempUint0=2*e,(this._posInVBData+this._tempUint0*this._floatSizePerVer>this._vbData.length||this._posInIBData+2*this._tempUint0>this._ibData.length)&&this.flush(),this._tempUint1=this._posInVBData/this._floatSizePerVer,this._tempNumver0=0,this._tempInt0=0;this._tempNumver0<6.2832;this._tempNumver0=this._tempNumver0+3.1416/e,this._tempInt0++)this.addVertex(Math.sin(this._tempNumver0)*t,Math.cos(this._tempNumver0)*t,0,i,n,r,a),0===this._tempInt0?this.addIndexes(this._tempUint1):this._tempInt0===this._tempUint0-1?(this._tempUint2=this._tempUint1+this._tempInt0,this.addIndexes(this._tempUint2,this._tempUint2,this._tempUint1)):(this._tempUint2=this._tempUint1+this._tempInt0,this.addIndexes(this._tempUint2,this._tempUint2));return this},e.plane=function(t,e,i,n,r,a,s,o,l){return this._hasBegun&&4===this._primitiveType||this.drawTrianglesException(),(this._posInVBData+4*this._floatSizePerVer>this._vbData.length||this._posInIBData+6>this._ibData.length)&&this.flush(),this._tempNumver0=n/2,this._tempNumver1=r/2,this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(t-this._tempNumver0,e+this._tempNumver1,i,a,s,o,l),this.addVertex(t+this._tempNumver0,e+this._tempNumver1,i,a,s,o,l),this.addVertex(t-this._tempNumver0,e-this._tempNumver1,i,a,s,o,l),this.addVertex(t+this._tempNumver0,e-this._tempNumver1,i,a,s,o,l),this._tempUint1=this._tempUint0+1,this._tempUint2=this._tempUint0+2,this.addIndexes(this._tempUint0,this._tempUint1,this._tempUint2,this._tempUint2,this._tempUint1,this._tempUint0+3),this},e.box=function(t,e,i,n,r,a,s,o,l,h){return this._hasBegun&&4===this._primitiveType||this.drawTrianglesException(),(this._posInVBData+8*this._floatSizePerVer>this._vbData.length||this._posInIBData+36>this._ibData.length)&&this.flush(),this._tempNumver0=n/2,this._tempNumver1=r/2,this._tempNumver2=a/2,this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(t-this._tempNumver0,e+this._tempNumver1,i+this._tempNumver2,s,o,l,h),this.addVertex(t+this._tempNumver0,e+this._tempNumver1,i+this._tempNumver2,s,o,l,h),this.addVertex(t-this._tempNumver0,e-this._tempNumver1,i+this._tempNumver2,s,o,l,h),this.addVertex(t+this._tempNumver0,e-this._tempNumver1,i+this._tempNumver2,s,o,l,h),this.addVertex(t+this._tempNumver0,e+this._tempNumver1,i-this._tempNumver2,s,o,l,h),this.addVertex(t-this._tempNumver0,e+this._tempNumver1,i-this._tempNumver2,s,o,l,h),this.addVertex(t+this._tempNumver0,e-this._tempNumver1,i-this._tempNumver2,s,o,l,h),this.addVertex(t-this._tempNumver0,e-this._tempNumver1,i-this._tempNumver2,s,o,l,h),this._tempUint1=this._tempUint0+1,this._tempUint2=this._tempUint0+2,this._tempUint3=this._tempUint0+3,this._tempUint4=this._tempUint0+4,this._tempUint5=this._tempUint0+5,this._tempUint6=this._tempUint0+6,this._tempUint7=this._tempUint0+7,this.addIndexes(this._tempUint0,this._tempUint1,this._tempUint2,this._tempUint2,this._tempUint1,this._tempUint3,this._tempUint4,this._tempUint5,this._tempUint6,this._tempUint6,this._tempUint5,this._tempUint7,this._tempUint5,this._tempUint0,this._tempUint7,this._tempUint7,this._tempUint0,this._tempUint2,this._tempUint1,this._tempUint4,this._tempUint3,this._tempUint3,this._tempUint4,this._tempUint6,this._tempUint5,this._tempUint4,this._tempUint0,this._tempUint0,this._tempUint4,this._tempUint1,this._tempUint2,this._tempUint3,this._tempUint7,this._tempUint7,this._tempUint3,this._tempUint6),this},e.cone=function(t,e,i,n,r,a,s){for(this._hasBegun&&4===this._primitiveType||this.drawTrianglesException(),(this._posInVBData+(2*i+2)*this._floatSizePerVer>this._vbData.length||this._posInIBData+6*i>this._ibData.length)&&this.flush(),this._tempUint0=this._posInVBData,this._tempUint1=this._posInVBData/this._floatSizePerVer,this._tempNumver0=2*Math.PI/i,this.addVertexIndex(0,e,0,n,r,a,s,this._tempUint0),this.addVertexIndex(0,0,0,n,r,a,s,this._tempUint0+this._floatSizePerVer),this._tempInt0=2,this._tempNumver1=0,this._tempInt1=0;this._tempInt1<i;this._tempInt1++)this._tempNumver2=Math.cos(this._tempNumver1),this._tempNumver3=Math.sin(this._tempNumver1),this.addVertexIndex(t*this._tempNumver2,0,t*this._tempNumver3,n,r,a,s,this._tempUint0+this._tempInt0*this._floatSizePerVer),this.addIndexes(this._tempUint1,this._tempUint1+this._tempInt0),this._tempInt1==i-1?this.addIndexes(this._tempUint1+2):this.addIndexes(this._tempUint1+this._tempInt0+1),this.addVertexIndex(t*this._tempNumver2,0,t*this._tempNumver3,n,r,a,s,this._tempUint0+(this._tempInt0+i)*this._floatSizePerVer),this.addIndexes(this._tempUint1+1),this._tempInt1==i-1?this.addIndexes(this._tempUint1+i+2):this.addIndexes(this._tempUint1+this._tempInt0+i+1),this.addIndexes(this._tempUint1+this._tempInt0+i),this._tempInt0++,this._tempNumver1+=this._tempNumver0;return this},e.boundingBoxLine=function(t,e,i,n,r,a,s,o,l,h){return this._hasBegun&&1===this._primitiveType||this.drawLinesException(),(this._posInVBData+8*this._floatSizePerVer>this._vbData.length||this._posInIBData+48>this._ibData.length)&&this.flush(),this._tempUint0=this._posInVBData/this._floatSizePerVer,this.addVertex(t,r,a,s,o,l,h),this.addVertex(n,r,a,s,o,l,h),this.addVertex(t,e,a,s,o,l,h),this.addVertex(n,e,a,s,o,l,h),this.addVertex(n,r,i,s,o,l,h),this.addVertex(t,r,i,s,o,l,h),this.addVertex(n,e,i,s,o,l,h),this.addVertex(t,e,i,s,o,l,h),this._tempUint1=this._tempUint0+1,this._tempUint2=this._tempUint0+2,this._tempUint3=this._tempUint0+3,this._tempUint4=this._tempUint0+4,this._tempUint5=this._tempUint0+5,this._tempUint6=this._tempUint0+6,this._tempUint7=this._tempUint0+7,this.addIndexes(this._tempUint0,this._tempUint1,this._tempUint1,this._tempUint3,this._tempUint3,this._tempUint2,this._tempUint2,this._tempUint0,this._tempUint4,this._tempUint5,this._tempUint5,this._tempUint7,this._tempUint7,this._tempUint6,this._tempUint6,this._tempUint4,this._tempUint5,this._tempUint0,this._tempUint0,this._tempUint2,this._tempUint2,this._tempUint7,this._tempUint7,this._tempUint5,this._tempUint1,this._tempUint4,this._tempUint4,this._tempUint6,this._tempUint6,this._tempUint3,this._tempUint3,this._tempUint1,this._tempUint5,this._tempUint4,this._tempUint4,this._tempUint1,this._tempUint1,this._tempUint0,this._tempUint0,this._tempUint5,this._tempUint2,this._tempUint3,this._tempUint3,this._tempUint6,this._tempUint6,this._tempUint7,this._tempUint7,this._tempUint2),this},e.addVertex=function(t,e,i,n,r,a,s){return this._hasBegun||this.addVertexIndexException(),this._vbData[this._posInVBData]=t,this._vbData[this._posInVBData+1]=e,this._vbData[this._posInVBData+2]=i,this._vbData[this._posInVBData+3]=n,this._vbData[this._posInVBData+4]=r,this._vbData[this._posInVBData+5]=a,this._vbData[this._posInVBData+6]=s,this._posInVBData+=this._floatSizePerVer,this},e.addVertexIndex=function(t,e,i,n,r,a,s,o){return this._hasBegun||this.addVertexIndexException(),this._vbData[o]=t,this._vbData[o+1]=e,this._vbData[o+2]=i,this._vbData[o+3]=n,this._vbData[o+4]=r,this._vbData[o+5]=a,this._vbData[o+6]=s,o+=this._floatSizePerVer,o>this._posInVBData&&(this._posInVBData=o),this},e.addIndexes=function(t){var e=arguments;this._hasBegun||this.addVertexIndexException();for(var i=0;i<e.length;i++)this._ibData[this._posInIBData]=e[i],this._posInIBData++;return this},e.begin=function(t,e){return this._hasBegun&&this.beginException0(),1!==t&&4!==t&&this.beginException1(),this._primitiveType=t,this._camera=e,this._hasBegun=!0,this},e.end=function(){return this._hasBegun||this.endException(),this.flush(),this._hasBegun=!1,this},e.flush=function(){0!==this._posInVBData&&(this._ib.setData(this._ibData),this._vb.setData(this._vbData),this._vb._bind(),this._ib._bind(),this._shader=this._shaderCompile.withCompile(0,0,0),this._shader.bind(),this._shader.uploadAttributes(t._vertexDeclaration.shaderValues.data,null),this._spriteShaderValue.setValue(1,this._camera.projectionViewMatrix.elements),this._shader.uploadSpriteUniforms(this._spriteShaderValue.data),C.drawCall++,P.mainContext.drawElements(this._primitiveType,this._posInIBData,5123,0),this._posInIBData=0,this._posInVBData=0)},e.addVertexIndexException=function(){throw new Error("请先调用begin()函数")},e.beginException0=function(){throw new Error("调用begin()前请确保已成功调用end()！")},e.beginException1=function(){throw new Error("只支持“LINES”和“TRIANGLES”两种基元！")},e.endException=function(){throw new Error("调用end()前请确保已成功调用begin()！")},e.drawLinesException=function(){throw new Error("您必须确保在此之前已调用begin()且使用“LINES”基元！")},e.drawTrianglesException=function(){throw new Error("您必须确保在此之前已调用begin()且使用“TRIANGLES”基元！")},n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(28,[new It(0,"vector3",0),new It(12,"vector4",1)])}]),t}(),ut=function(){function t(){this._id=0,this._type=0,this._mainSortID=0,this._render=null,this._sprite3D=null,this._material=null,this._renderObj=null,this._staticBatch=null,this._tempBatchIndexStart=0,this._tempBatchIndexEnd=0,this._canDynamicBatch=!1,this._shaderValue=null,this._onPreRenderFunction=null,this._conchSubmesh=null,this._id=++t._uniqueIDCounter,this._canDynamicBatch=!0,this._shaderValue=new He,D.isConchNode&&(this._conchSubmesh=new ConchSubmesh)}r(t,"laya.d3.core.render.RenderElement");var e=t.prototype;return e.getDynamicBatchBakedVertexs=function(t){for(var e=this._renderObj._getVertexBuffer(t),i=e.getData().slice(),n=e.vertexDeclaration,r=n.getVertexElementByUsage(0).offset/4,a=n.getVertexElementByUsage(3).offset/4,s=this._sprite3D.transform,o=s.worldMatrix,l=s.rotation,h=n.vertexStride/4,u=0,_=i.length;u<_;u+=h){var c=u+r,d=u+a;qe.transformVector3ArrayToVector3ArrayCoordinate(i,c,o,i,c),qe.transformVector3ArrayByQuat(i,d,l,i,d)}return i},e.getBakedIndices=function(){return this._renderObj._getIndexBuffer().getData()},e._destroy=function(){this._staticBatch&&this._staticBatch._manager._garbageCollection(this)},a(0,e,"id",function(){return this._id}),a(0,e,"renderObj",function(){return this._renderObj},function(t){this._renderObj!==t&&(this._renderObj=t)}),t._uniqueIDCounter=0,t}(),_t=function(){function t(e){this._id=0,this._needSort=!1,this._renderElements=null,this._renderableRenderObjects=null,this._dynamicBatchCombineRenderElements=null,this._finalElements=null,this._scene=null,this._id=++t._uniqueIDCounter,this._needSort=!1,this._scene=e,this._renderElements=[],this._renderableRenderObjects=[],this._dynamicBatchCombineRenderElements=[]}r(t,"laya.d3.core.render.RenderQueue");var e=t.prototype;return e._sortOpaqueFunc=function(t,e){return t._render&&e._render?t._render._distanceForSort-e._render._distanceForSort:0},e._sortAlphaFunc=function(t,e){return t._render&&e._render?e._render._distanceForSort-t._render._distanceForSort:0},e._begainRenderElement=function(t,e,i){return!!e._beforeRender(t)},e._sortAlpha=function(e){t._cameraPosition=e,this._finalElements.sort(this._sortAlphaFunc)},e._sortOpaque=function(e){t._cameraPosition=e,this._finalElements.sort(this._sortOpaqueFunc)},e._preRender=function(t){this._finalElements=this._renderElements.concat(this._dynamicBatchCombineRenderElements)},e._render=function(t,e){for(var i,n,r,a,s,o,l=C.loopCount,h=this._scene,u=t.camera,_=(u.id,!1),c=0,d=this._finalElements.length;c<d;c++){var f,m,p,v=this._finalElements[c];if(null!=v._onPreRenderFunction&&v._onPreRenderFunction.call(v._sprite3D,t),0===v._type){if(t.owner=p=v._sprite3D,t.renderElement=v,p._preRenderUpdateComponents(t),f=v.renderObj,m=v._material,this._begainRenderElement(t,f,m)){if(i=f._getVertexBuffers(),n=f._getVertexBuffer(0),r=n.vertexDeclaration,a=t._shader=m._getShader(h._shaderDefineValue,r.shaderDefineValue,p._shaderDefineValue),_=a.bind()||l!==a._uploadLoopCount,i){if(a._uploadVertexBuffer!==i||_){for(var g=0;g<i.length;g++){var E=i[g];a.uploadAttributesX(E.vertexDeclaration.shaderValues.data,E)}a._uploadVertexBuffer=i}}else(a._uploadVertexBuffer!==n||_)&&(a.uploadAttributes(r.shaderValues.data,null),a._uploadVertexBuffer=n);(a._uploadScene!==h||_)&&(a.uploadSceneUniforms(h._shaderValues.data),a._uploadScene=h),(u!==a._uploadCamera||a._uploadSprite3D!==p||_)&&(a.uploadSpriteUniforms(p._shaderValues.data),a._uploadSprite3D=p),(u!==a._uploadCamera||_)&&(a.uploadCameraUniforms(u._shaderValues.data),a._uploadCamera=u),(a._uploadMaterial!==m||_)&&(m._upload(),a._uploadMaterial=m),s!==m?(m._setRenderStateBlendDepth(),m._setRenderStateFrontFace(e,p.transform),s=m,o=p):o!==p&&(m._setRenderStateFrontFace(e,p.transform),o=p),f._render(t),a._uploadLoopCount=l}p._postRenderUpdateComponents(t)}else if(2===v._type){v.renderObj;t.owner=p=v._sprite3D,t.renderElement=v,t._batchIndexStart=v._tempBatchIndexStart,t._batchIndexEnd=v._tempBatchIndexEnd,f=v.renderObj,m=v._material,this._begainRenderElement(t,f,m)&&(n=f._getVertexBuffer(0),r=n.vertexDeclaration,a=t._shader=m._getShader(h._shaderDefineValue,r.shaderDefineValue,p._shaderDefineValue),_=a.bind()||l!==a._uploadLoopCount,(a._uploadVertexBuffer!==n||_)&&(a.uploadAttributes(r.shaderValues.data,null),a._uploadVertexBuffer=n),(a._uploadScene!==h||_)&&(a.uploadSceneUniforms(h._shaderValues.data),a._uploadScene=h),(u!==a._uploadCamera||a._uploadSprite3D!==p||_)&&(a.uploadSpriteUniforms(p._shaderValues.data),a._uploadSprite3D=p),(u!==a._uploadCamera||_)&&(a.uploadCameraUniforms(u._shaderValues.data),a._uploadCamera=u),(a._uploadMaterial!==m||_)&&(m._upload(),a._uploadMaterial=m),s!==m?(m._setRenderStateBlendDepth(),m._setRenderStateFrontFace(e,p.transform),s=m,o=p):o!==p&&(m._setRenderStateFrontFace(e,p.transform),o=p),f._render(t),a._uploadLoopCount=l)}}},e._renderShadow=function(t,e){for(var i,n,r,a,s,o=C.loopCount,l=this._scene,h=t.camera,u=!1,_=0,c=this._finalElements.length;_<c;_++){var d,f,m,p=this._finalElements[_];0===p._type&&(t.owner=m=p._sprite3D,e||m._projectionViewWorldUpdateCamera===h&&m._projectionViewWorldUpdateLoopCount===C.loopCount||(m._render._renderUpdate(t._projectionViewMatrix),m._projectionViewWorldUpdateLoopCount=C.loopCount,m._projectionViewWorldUpdateCamera=h),t.renderElement=p,m._preRenderUpdateComponents(t),d=p.renderObj,f=p._material,this._begainRenderElement(t,d,null)&&(i=d._getVertexBuffer(0),n=i.vertexDeclaration,r=t._shader=f._getShader(l._shaderDefineValue,n.shaderDefineValue,m._shaderDefineValue),u=r.bind()||o!==r._uploadLoopCount,(r._uploadVertexBuffer!==i||u)&&(r.uploadAttributes(n.shaderValues.data,null),r._uploadVertexBuffer=i),(h!==r._uploadCamera||r._uploadSprite3D!==m||u)&&(r.uploadSpriteUniforms(m._shaderValues.data),r._uploadSprite3D=m),(h!==r._uploadCamera||u)&&(r.uploadCameraUniforms(h._shaderValues.data),r._uploadCamera=h),(r._uploadMaterial!==f||u)&&(f._upload(),r._uploadMaterial=f),r._uploadRenderElement,a!==f?(f._setRenderStateFrontFace(!1,m.transform),a=f,s=m):s!==m&&(f._setRenderStateFrontFace(!1,m.transform),s=m),d._render(t),r._uploadLoopCount=o),m._postRenderUpdateComponents(t))}},e._clearRenderElements=function(){this._dynamicBatchCombineRenderElements.length=0,this._renderElements.length=0,this._needSort=!0},e._addRenderElement=function(t){this._renderElements.push(t),this._needSort=!0},e._addDynamicBatchElement=function(t){this._dynamicBatchCombineRenderElements.push(t)},a(0,e,"id",function(){return this._id}),t._uniqueIDCounter=0,t.OPAQUE=1,t.TRANSPARENT=2,t._cameraPosition=null,t}(),ct=function(){function t(){this._staticBatch=null,this._batchIndexStart=0,this._batchIndexEnd=0,this._viewMatrix=null,this._projectionMatrix=null,this._projectionViewMatrix=null,this._viewport=null,this._shader=null,this.elapsedTime=NaN,this.scene=null,this.owner=null,this.renderElement=null,this.camera=null}return r(t,"laya.d3.core.render.RenderState"),t.clientWidth=0,t.clientHeight=0,t}(),dt=function(){function t(t,e){this._exactBox=null,this._relaxBox=null,this._scene=null,this._parent=null,this._currentDepth=0,this._boundingSphere=new Se(new Pe,0),this._corners=[new Pe,new Pe,new Pe,new Pe,new Pe,new Pe,new Pe,new Pe],this._boundingBoxCenter=new Pe,this._children=s(8),this._objects=[],this._tempBoundBoxCorners=[new Pe,new Pe,new Pe,new Pe,new Pe,new Pe,new Pe,new Pe],this._scene=t,this._currentDepth=e}r(t,"laya.d3.core.scene.OctreeNode");var e=t.prototype;return i.imps(e,{"laya.d3.core.scene.ITreeNode":!0}),e.init=function(t,e){var i=new Pe,n=new Pe;Pe.scale(e,-.5,i),Pe.scale(e,.5,n),Pe.add(i,t,i),Pe.add(n,t,n),this.exactBox=new xe(i,n),this.relaxBox=new xe(i,n)},e.addTreeNode=function(t){1===De.boxContainsBox(this._relaxBox,t.boundingBox)?this.addNodeDown(t,0):this.addObject(t)},e.addChild=function(e){var i=this._children[e];if(null==i){i=new t(this._scene,this._currentDepth+1),this._children[e]=i,i._parent=this,Pe.subtract(this._exactBox.max,this._exactBox.min,t.tempSize),Pe.multiply(t.tempSize,t._octreeSplit[e],t.tempCenter),Pe.add(this._exactBox.min,t.tempCenter,t.tempCenter),Pe.scale(t.tempSize,.25,t.tempSize);var n=new Pe,r=new Pe;Pe.subtract(t.tempCenter,t.tempSize,n),Pe.add(t.tempCenter,t.tempSize,r),i.exactBox=new xe(n,r),Pe.scale(t.tempSize,t.relax,t.tempSize);var a=new Pe,s=new Pe;Pe.subtract(t.tempCenter,t.tempSize,a),Pe.add(t.tempCenter,t.tempSize,s),i.relaxBox=new xe(a,s)}return i},e.addObject=function(t){t._treeNode=this,this._objects.push(t)},e.removeObject=function(t){if(t._treeNode!=this)return console.log("OctreeNode::removeObject error"),!1;var e=this._objects.indexOf(t);return-1!==e&&(this._objects.splice(e,1),!0)},e.clearObject=function(){this._objects.length=0},e.addNodeUp=function(t,e){this._parent&&1!==De.boxContainsBox(this._exactBox,t.boundingBox)?this._parent.addNodeUp(t,e-1):this.addNodeDown(t,e)},e.addNodeDown=function(t,e){if(e<this._scene.treeLevel){var i=this.inChildIndex(t.boundingBoxCenter),n=this.addChild(i);1===De.boxContainsBox(n._relaxBox,t.boundingBox)?n.addNodeDown(t,++e):this.addObject(t)}else this.addObject(t)},e.inChildIndex=function(t){return 4*(t.z<this._boundingBoxCenter.z?0:1)+2*(t.y<this._boundingBoxCenter.y?0:1)+(t.x<this._boundingBoxCenter.x?0:1)},e.updateObject=function(t){1===De.boxContainsBox(this._relaxBox,t.boundingBox)?(this.removeObject(t),t._treeNode=null,this.addNodeDown(t,this._currentDepth)):this._parent&&(this.removeObject(t),t._treeNode=null,this._parent.addNodeUp(t,this._currentDepth-1))},e.cullingObjects=function(t,e,i,n,r){var a=0,s=0,o=0,l=0,h=this._scene._dynamicBatchManager;for(a=0,o=this._objects.length;a<o;a++){var u=this._objects[a];if(k.isVisible(u._owner.layer.mask)&&u.enable){if(e&&(C.treeSpriteCollision+=1,0===t.containsBoundSphere(u.boundingSphere)))continue;u._renderUpdate(r),u._distanceForSort=Pe.distance(u.boundingSphere.center,n)+u.sortingFudge;var _=u._renderElements;for(s=0,l=_.length;s<l;s++){var c=_[s],d=c._staticBatch;if(d&&d._material===c._material)d._addBatchRenderElement(c);else{var f=c.renderObj;f.triangleCount<10&&1===f._vertexBufferCount&&f._getIndexBuffer()&&c._material.renderQueue<2&&c._canDynamicBatch&&!u._owner.isStatic?h._addPrepareRenderElement(c):this._scene.getRenderQueue(c._material.renderQueue)._addRenderElement(c)}}}}for(a=0;a<8;a++){var m=this._children[a];if(null!=m){var p=e;if(e){var v=t.containsBoundBox(m._relaxBox);if(C.treeNodeCollision+=1,0===v)continue;p=2===v}m.cullingObjects(t,p,i,n,r)}}},e.cullingShadowObjects=function(t,e,i,n,r){var a=0,s=0,o=0,l=0;this._scene._dynamicBatchManager;for(a=0,o=this._objects.length;a<o;a++){var h=this._objects[a];if(h.castShadow&&k.isVisible(h._owner.layer.mask)&&h.enable){if(i&&0===t[0].containsBoundSphere(h.boundingSphere))continue;for(var u=1,_=t.length;u<_;u++){var c=e[u-1];if(0!==t[u].containsBoundSphere(h.boundingSphere)){var d=h._renderElements;for(s=0,l=d.length;s<l;s++)c._addRenderElement(d[s])}}}}for(a=0;a<8;a++){var f=this._children[a];if(null!=f){var m=i;if(i){var p=t[0].containsBoundBox(f._relaxBox);if(0===p)continue;m=2===p}f.cullingShadowObjects(t,e,m,n,r)}}},e.cullingShadowObjectsOnePSSM=function(t,e,i,n,r,a){var s=e[0],o=0,l=0,h=0,u=0;for(o=0,h=this._objects.length;o<h;o++){var _=this._objects[o];if(_.castShadow&&k.isVisible(_._owner.layer.mask)&&_.enable){if(n&&0===t.containsBoundSphere(_.boundingSphere))continue;_._renderUpdate(i);var c=_._renderElements;for(l=0,u=c.length;l<u;l++)s._addRenderElement(c[l])}}for(o=0;o<8;o++){var d=this._children[o];if(null!=d){var f=n;if(n){var m=t.containsBoundBox(d._relaxBox);if(0===m)continue;f=2===m}d.cullingShadowObjectsOnePSSM(t,e,i,f,r,a)}}},e.renderBoudingBox=function(t){this._renderBoudingBox(t);for(var e=0;e<8;++e){var i=this._children[e];i&&i.renderBoudingBox(t)}},e.buildAllChild=function(t){if(t<this._scene.treeLevel)for(var e=0;e<8;e++){var i=this.addChild(e);i.buildAllChild(t+1)}},e._renderBoudingBox=function(t){},a(0,e,"exactBox",function(){return this._exactBox},function(t){this._exactBox=t,Pe.add(t.min,t.max,this._boundingBoxCenter),Pe.scale(this._boundingBoxCenter,.5,this._boundingBoxCenter)}),a(0,e,"relaxBox",function(){return this._relaxBox},function(t){this._relaxBox=t,t.getCorners(this._corners),Se.createfromPoints(this._corners,this._boundingSphere)}),t.debugMode=!1,t.relax=1.15,t.CHILDNUM=8,n(t,["tempVector0",function(){return this.tempVector0=new Pe},"tempSize",function(){return this.tempSize=new Pe},"tempCenter",function(){return this.tempCenter=new Pe},"_octreeSplit",function(){return this._octreeSplit=[new Pe(.25,.25,.25),new Pe(.75,.25,.25),new Pe(.25,.75,.25),new Pe(.75,.75,.25),new Pe(.25,.25,.75),new Pe(.75,.25,.75),new Pe(.25,.75,.75),new Pe(.75,.75,.75)]}]),t}(),ft=(function(){function t(){}r(t,"laya.d3.core.scene.SceneManager")}(),function(){function t(t,e,i,n){this.r=NaN,this.g=NaN,this.b=NaN,this.a=NaN,this.r=t,this.g=e,this.b=i,this.a=n}return r(t,"laya.d3.core.trail.module.Color",null,"Color$1"),n(t,["red",function(){return this.red=new t(1,0,0,1)},"green",function(){return this.green=new t(0,1,0,1)},"blue",function(){return this.blue=new t(0,0,1,1)},"cyan",function(){return this.cyan=new t(0,1,1,1)},"yellow",function(){return this.yellow=new t(1,.92,.016,1)},"magenta",function(){return this.magenta=new t(1,0,1,1)},"gray",function(){return this.gray=new t(.5,.5,.5,1)},"white",function(){return this.white=new t(1,1,1,1)},"black",function(){return this.black=new t(0,0,0,1)}]),t}()),mt=function(){function t(){this._mode=0,this._colorKeys=null,this._alphaKeys=null,this.index=0,this._colorKeyData=new Float32Array(40),this._alphaKeyData=new Float32Array(20),this._colorKeys=[],this._alphaKeys=[]}r(t,"laya.d3.core.trail.module.Gradient");var e=t.prototype;return e.setKeys=function(t,e){this._colorKeys=t,this.index=0;for(var i,n=0;n<t.length;n++){i=t[n];var r=i.color;this._colorKeyData[this.index++]=r.r,this._colorKeyData[this.index++]=r.g,this._colorKeyData[this.index++]=r.b,this._colorKeyData[this.index++]=i.time}this._alphaKeys=e,this.index=0;for(var a,s=0;s<e.length;s++)a=e[s],this._alphaKeyData[this.index++]=a.alpha,this._alphaKeyData[this.index++]=a.time},a(0,e,"mode",function(){return this._mode},function(t){this._mode=t}),a(0,e,"colorKeys",function(){return this._colorKeys},function(t){this._colorKeys=t,this.index=0;for(var e=0;e<t.length;e++){var i=t[e],n=i.color;this._colorKeyData[this.index++]=n.r,this._colorKeyData[this.index++]=n.g,this._colorKeyData[this.index++]=n.b,this._colorKeyData[this.index++]=i.time}}),a(0,e,"alphaKeys",function(){return this._alphaKeys},function(t){this._alphaKeys=t,this.index=0;for(var e=0;e<t.length;e++){var i=t[e];this._alphaKeyData[this.index++]=i.alpha,this._alphaKeyData[this.index++]=i.time}}),t}(),pt=function(){function t(t,e){this._alpha=NaN,this._time=NaN,this._alpha=t,this._time=e}r(t,"laya.d3.core.trail.module.GradientAlphaKey");var e=t.prototype;return a(0,e,"alpha",function(){return this._alpha},function(t){this._alpha=t}),a(0,e,"time",function(){return this._time},function(t){this._time=t}),t}(),vt=function(){function t(t,e){this._color=null,this._time=NaN,this._color=t,this._time=e}r(t,"laya.d3.core.trail.module.GradientColorKey");var e=t.prototype;return a(0,e,"color",function(){return this._color},function(t){this._color=t}),a(0,e,"time",function(){return this._time},function(t){this._time=t}),t}(),gt=(function(){function t(){}r(t,"laya.d3.core.trail.module.GradientMode"),t.Blend=0,t.Fixed=1}(),function(){function t(){}r(t,"laya.d3.core.trail.module.TextureMode"),t.Stretch=0,t.Tile=1}(),function(){function t(){this.time=NaN,this.inTangent=NaN,this.outTangent=NaN,this.value=NaN}return r(t,"laya.d3.core.trail.module.TrailKeyFrame"),t}()),Et=function(){function t(e){this._id=0,this._owner=null,this._camera=null,this._vertexBuffers=null,this._verticesCount=0,this._virtualVerticesCount=0,this._maxVerticesCount=256,this._vertices1=null,this._vertexBuffer1=null,this._floatCountPerVertices1=8,this._verticesIndex1=0,this._everyAddVerticeCount1=0,this._delLength=0,this._vertices2=null,this._vertexBuffer2=null,this._floatCountPerVertices2=1,this._everyGroupVertexBirthTime=null,this._VerticesToTailLength=null,this._everyVertexToPreVertexDistance=null,this._pointe=null,this._pointAtoBVector3e=null,this._isStart=!1,this._isFinish=!1,this._isDead=!1,this._curtime=NaN,this._curDisappearIndex=0,this._lastPosition=new Pe,this._curPosition=new Pe,this._delVector3=new Pe,this._lastFixedVertexPosition=new Pe,this._pointAtoBVector3=new Pe,this._pointA=new Pe,this._pointB=new Pe,this._owner=e,this._id=t.renderElementCount++,0==this._id?e._owner.transform.position.cloneTo(this._lastPosition):e._curSubTrailFinishPosition.cloneTo(this._lastPosition),this._everyGroupVertexBirthTime=[],this._VerticesToTailLength=new Float32Array(this._maxVerticesCount),this._everyVertexToPreVertexDistance=new Float32Array(this._maxVerticesCount),this._vertices1=new Float32Array(this._maxVerticesCount*this._floatCountPerVertices1),this._vertices2=new Float32Array(this._maxVerticesCount*this._floatCountPerVertices2),this._vertexBuffer1=new Ki(xt.vertexDeclaration1,this._maxVerticesCount,35044,!0),this._vertexBuffer2=new Ki(xt.vertexDeclaration2,this._maxVerticesCount,35044,!0),this._vertexBuffers=[],this._vertexBuffers.push(this._vertexBuffer1),this._vertexBuffers.push(this._vertexBuffer2)}r(t,"laya.d3.core.trail.TrailRenderElement");var e=t.prototype;return i.imps(e,{"laya.d3.core.render.IRenderable":!0}),e._updateTrail=function(){this._everyAddVerticeCount1=0,this._isStart||this._addTrailByFirstPosition(this._lastPosition,this._curPosition),this._addTrailByNextPosition(this._curPosition),this._vertexBuffer1.setData(this._vertices1,this._verticesIndex1,this._verticesIndex1,this._everyAddVerticeCount1),this._verticesIndex1+=this._everyAddVerticeCount1,this._curPosition.cloneTo(this._lastPosition),2==this._virtualVerticesCount&&(this._verticesIndex1-=2*this._floatCountPerVertices1)},e._addTrailByFirstPosition=function(t,e){Pe.subtract(e,t,this._delVector3),Pe.cross(this._delVector3,this._camera.forward,this._pointAtoBVector3),Pe.normalize(this._pointAtoBVector3,this._pointAtoBVector3),Pe.scale(this._pointAtoBVector3,this._owner.widthMultiplier/2,this._pointAtoBVector3),this._updateVerticesByPosition(t),t.cloneTo(this._lastFixedVertexPosition),this._verticesCount+=2,this._curtime=this._owner._hasLifeSubTrail?this._owner._curSubTrailFinishCurTime:this._owner._curtime,this._everyGroupVertexBirthTime.push(this._curtime),this._isStart=!0,this._owner._hasLifeSubTrail=!0},e._addTrailByNextPosition=function(t){Pe.subtract(t,this._lastFixedVertexPosition,this._delVector3),Pe.cross(this._delVector3,this._camera.forward,this._pointAtoBVector3),Pe.normalize(this._pointAtoBVector3,this._pointAtoBVector3),Pe.scale(this._pointAtoBVector3,this._owner.widthMultiplier/2,this._pointAtoBVector3),this._delLength=Pe.scalarLength(this._delVector3),this._delLength-this._owner.minVertexDistance>=Me.zeroTolerance?(this._owner._trailTotalLength+=this._delLength,this._owner._trailSupplementLength=0,this._updateVerticesByPosition(t),t.cloneTo(this._lastFixedVertexPosition),this._verticesCount+=2,this._virtualVerticesCount=0,this._everyGroupVertexBirthTime.push(this._owner._curtime),this._verticesCount==this._maxVerticesCount&&this._onTrailRenderElementFinish()):(this._owner._trailSupplementLength=this._delLength,this._updateVerticesByPosition(t),this._virtualVerticesCount=2)},e._updateVerticesByPosition=function(t){this._pointe=t.elements,this._pointAtoBVector3e=this._pointAtoBVector3.elements,this._curtime=this._owner._curtime,this._owner._hasLifeSubTrail&&0==this._isStart&&(this._pointe=this._owner._curSubTrailFinishPosition.elements,this._pointAtoBVector3e=this._owner._curSubTrailFinishDirection.elements,this._curtime=this._owner._curSubTrailFinishCurTime),this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._pointe[0],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._pointe[1],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._pointe[2],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=-this._pointAtoBVector3e[0],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=-this._pointAtoBVector3e[1],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=-this._pointAtoBVector3e[2],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._curtime,this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=1,this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._pointe[0],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._pointe[1],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._pointe[2],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._pointAtoBVector3e[0],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._pointAtoBVector3e[1],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._pointAtoBVector3e[2],this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=this._curtime,this._vertices1[this._verticesIndex1+this._everyAddVerticeCount1++]=0,this._VerticesToTailLength[this._verticesCount/2]=this._owner._trailTotalLength+this._owner._trailSupplementLength,0==this._owner._trailSupplementLength?this._everyVertexToPreVertexDistance[this._verticesCount/2]=this._delLength:this._everyVertexToPreVertexDistance[this._verticesCount/2]=this._isStart?this._owner._trailSupplementLength:0},e._updateVertexBuffer2=function(){var t=0,e=0,i=0,n=0;for(i=0,n=(this._verticesCount+this._virtualVerticesCount)/2;i<n;i++)e=0==this._owner.textureMode?(this._VerticesToTailLength[i]-this._owner._trailDeadLength)/(this._owner._trailTotalLength+this._owner._trailSupplementLength-this._owner._trailDeadLength):this._owner._trailTotalLength+this._owner._trailSupplementLength-this._VerticesToTailLength[i],this._vertices2[t++]=1-e,this._vertices2[t++]=1-e;this._vertexBuffer2.setData(this._vertices2,0,0,this._verticesCount+this._virtualVerticesCount)},e._onTrailRenderElementFinish=function(){this._lastFixedVertexPosition.cloneTo(this._owner._curSubTrailFinishPosition),this._pointAtoBVector3.cloneTo(this._owner._curSubTrailFinishDirection),this._owner._curSubTrailFinishCurTime=this._owner._curtime,this._isFinish=!0},e._updateDisappear=function(){var t=0,e=0;for(t=this._curDisappearIndex,e=(this._verticesCount+this._virtualVerticesCount)/2;t<e;t++)this._owner._curtime-this._everyGroupVertexBirthTime[t]>=this._owner.time+Me.zeroTolerance&&(this._curDisappearIndex++,this._owner._trailDeadLength+=this._everyVertexToPreVertexDistance[this._curDisappearIndex],this._curDisappearIndex>=(this._verticesCount+this._virtualVerticesCount)/2&&(this._isDead=!0))},e._beforeRender=function(t){return this._camera=t.camera,null!=this._camera&&(this._owner._owner.transform.position.cloneTo(this._curPosition),!this._isDead&&(this._verticesCount<this._maxVerticesCount?Pe.equals(this._lastPosition,this._curPosition)||this._updateTrail():this._isFinish&&(this._isFinish=!1,this._owner._curSubTrailFinished=!0),this._verticesCount>0)&&(this._updateVertexBuffer2(),this._updateDisappear(),!0))},e._render=function(t){this._isDead||(P.mainContext.drawArrays(5,2*this._curDisappearIndex,this._verticesCount+this._virtualVerticesCount-2*this._curDisappearIndex),C.drawCall++,C.trianglesFaces+=this._verticesCount+this._virtualVerticesCount-2*this._curDisappearIndex-2)},e._getVertexBuffer=function(t){return void 0===t&&(t=0),0===t?this._vertexBuffer1:1===t?this._vertexBuffer2:null},e._getVertexBuffers=function(){return this._vertexBuffers},e._getIndexBuffer=function(){return null},e._renderRuntime=function(t,e,i){},e.reActivate=function(){this._id=laya.d3.core.trail.TrailRenderElement.renderElementCount++,this._isStart=!1,this._isFinish=!1,this._isDead=!1,this._verticesCount=0,this._virtualVerticesCount=0,this._verticesIndex1=0,this._delLength=0,this._curDisappearIndex=0,this._everyGroupVertexBirthTime=[],this._owner._curSubTrailFinishPosition.cloneTo(this._lastPosition)},e._destroy=function(){this._vertexBuffer1.dispose(),this._vertexBuffer2.dispose(),this._vertices1=null,this._vertexBuffer1=null,this._vertices2=null,this._vertexBuffer2=null,this._vertexBuffers=null,this._everyGroupVertexBirthTime=null,this._VerticesToTailLength=null,this._everyVertexToPreVertexDistance=null,this._lastPosition=null,this._curPosition=null,this._delVector3=null,this._lastFixedVertexPosition=null,this._pointAtoBVector3=null,this._pointe=null,this._pointAtoBVector3e=null,this._pointA=null,this._pointB=null},a(0,e,"_vertexBufferCount",function(){return this._vertexBuffers.length}),a(0,e,"triangleCount",function(){return 0}),t.renderElementCount=0,t}(),xt=function(){function t(){}r(t,"laya.d3.core.trail.VertexTrail");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration1}),a(1,t,"vertexDeclaration1",function(){return t._vertexDeclaration1}),a(1,t,"vertexDeclaration2",function(){return t._vertexDeclaration2}),n(t,["_vertexDeclaration1",function(){return this._vertexDeclaration1=new At(32,[new It(0,"vector3",0),new It(12,"vector3",40),new It(24,"single",33),new It(28,"single",39)])},"_vertexDeclaration2",function(){return this._vertexDeclaration2=new At(4,[new It(0,"single",38)])}]),t}(),Tt=function(){function t(t){this._vertexDeclaration=null,this._vertexDatas=null,this._indexDatas=null,this._vertexBuffer=null,this._indexBuffer=null,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._combineRenderElements=null,this._materials=null,this._materialToRenderElementsOffsets=null,this._merageElements=null,this._combineRenderElementPool=null,this._combineRenderElementPoolIndex=0,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._combineRenderElements=[],this._materialToRenderElementsOffsets=[],this._materials=[],this._merageElements=[],this._combineRenderElementPool=[],this._combineRenderElementPoolIndex=0,this._vertexDeclaration=t}r(t,"laya.d3.graphics.DynamicBatch");var e=t.prototype;return i.imps(e,{"laya.d3.core.render.IRenderable":!0}),e._getVertexBuffer=function(t){return void 0===t&&(t=0),0===t?this._vertexBuffer:null},e._getIndexBuffer=function(){return this._indexBuffer},e._getCombineRenderElementFromPool=function(t,e,i){var n=this._combineRenderElementPool[this._combineRenderElementPoolIndex++];return n||(this._combineRenderElementPool[this._combineRenderElementPoolIndex-1]=n=new ut,n._sprite3D=new vn),n._sprite3D._render._renderUpdate(i),n},e._getRenderElement=function(e,i,n){this._vertexDatas||(this._vertexDatas=new Float32Array(this._vertexDeclaration.vertexStride/4*t.maxVertexCount),this._indexDatas=new Uint16Array(t.maxIndexCount),this._vertexBuffer=Ki.create(this._vertexDeclaration,t.maxVertexCount,35048),this._indexBuffer=Zi.create("ushort",t.maxIndexCount,35048)),this._merageElements.length=0;for(var r=0,a=0,s=0,o=this._combineRenderElements.length;s<o;s++){var l=this._combineRenderElements[s],h=l.getDynamicBatchBakedVertexs(0),u=l.getBakedIndices(),_=l._sprite3D.transform._isFrontFaceInvert,c=r/(this._vertexDeclaration.vertexStride/4),d=a,f=d+u.length;l._tempBatchIndexStart=d,l._tempBatchIndexEnd=f,this._indexDatas.set(u,a);var m=0;if(_)for(m=d;m<f;m+=3){this._indexDatas[m]=c+this._indexDatas[m];var p=this._indexDatas[m+1],v=this._indexDatas[m+2];this._indexDatas[m+1]=c+v,this._indexDatas[m+2]=c+p}else for(m=d;m<f;m+=3)this._indexDatas[m]=c+this._indexDatas[m],this._indexDatas[m+1]=c+this._indexDatas[m+1],this._indexDatas[m+2]=c+this._indexDatas[m+2];a+=u.length,this._vertexDatas.set(h,r),r+=h.length}for(this._vertexBuffer.setData(this._vertexDatas),this._indexBuffer.setData(this._indexDatas),this._combineRenderElementPoolIndex=0,s=0,o=this._materials.length;s<o;s++){var g=this._getCombineRenderElementFromPool(e,i,n);g._type=2,g._staticBatch=null,g.renderObj=this;var E=this._combineRenderElements[this._materialToRenderElementsOffsets[s]]._tempBatchIndexStart,x=s+1===this._materialToRenderElementsOffsets.length?a:this._combineRenderElements[this._materialToRenderElementsOffsets[s+1]]._tempBatchIndexStart;g._tempBatchIndexStart=E,g._tempBatchIndexEnd=x,g._material=this._materials[s],this._merageElements.push(g)}},e._addCombineRenderObjTest=function(e){var i=e.renderObj,n=this._currentCombineIndexCount+i._getIndexBuffer().indexCount;return!(this._currentCombineVertexCount+i._getVertexBuffer().vertexCount>t.maxVertexCount||n>t.maxIndexCount)},e._addCombineRenderObj=function(t){var e=t.renderObj;this._combineRenderElements.push(t),this._currentCombineIndexCount=this._currentCombineIndexCount+e._getIndexBuffer().indexCount,this._currentCombineVertexCount=this._currentCombineVertexCount+e._getVertexBuffer().vertexCount},e._addCombineMaterial=function(t){this._materials.push(t)},e._addMaterialToRenderElementOffset=function(t){this._materialToRenderElementsOffsets.push(t)},e._clearRenderElements=function(){this._combineRenderElements.length=0,this._materials.length=0,this._materialToRenderElementsOffsets.length=0,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0},e._addToRenderQueue=function(t,e,i,n){this._getRenderElement(e,i,n);for(var r=0,a=this._materials.length;r<a;r++)t.getRenderQueue(this._materials[r].renderQueue)._addDynamicBatchElement(this._merageElements[r])},e._beforeRender=function(t){return this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},e._render=function(t){var e=t._batchIndexEnd-t._batchIndexStart;P.mainContext.drawElements(4,e,5123,2*t._batchIndexStart),C.drawCall++,C.trianglesFaces+=e/3},e._getVertexBuffers=function(){return null},e._renderRuntime=function(t,e,i){},a(0,e,"_vertexBufferCount",function(){return 1}),a(0,e,"triangleCount",function(){return this._indexBuffer.indexCount/3}),a(0,e,"combineRenderElementsCount",function(){return this._combineRenderElements.length}),t.maxVertexCount=2e4,t.maxIndexCount=4e4,t.maxCombineTriangleCount=10,t}(),St=function(){function t(){this._dynamicBatches=null,this._prepareDynamicBatchCombineElements=null,this._dynamicBatches={},this._prepareDynamicBatchCombineElements=[]}r(t,"laya.d3.graphics.DynamicBatchManager");var e=t.prototype;return e.getDynamicBatch=function(t,e){var i,n=t.id.toString()+e;return this._dynamicBatches[n]?i=this._dynamicBatches[n]:this._dynamicBatches[n]=i=new Tt(t),i},e._garbageCollection=function(){for(var t in this._dynamicBatches)0===this._dynamicBatches[t].combineRenderElementsCount&&delete this._dynamicBatches[t]},e._addPrepareRenderElement=function(t){this._prepareDynamicBatchCombineElements.push(t)},e._finishCombineDynamicBatch=function(e){this._prepareDynamicBatchCombineElements.sort(t._sortPrepareDynamicBatch);for(var i,n,r,a,s,o,l,h,u=-1,_=!0,c=0,d=-1,f=0,m=this._prepareDynamicBatchCombineElements.length;f<m;f++){s=this._prepareDynamicBatchCombineElements[f];var p=s.renderObj._getVertexBuffer(0).vertexDeclaration,v=n!==p;v&&(c=0,n=p);var g=c!==u;if(g&&(u=c),(v||g)&&(o=this.getDynamicBatch(p,c),i=null),_)if(o._addCombineRenderObjTest(s)){if(a=s._material,i!==a)l&&(e.getRenderQueue(h._material.renderQueue)._addRenderElement(h),l=null,h=null,d=-1),l=a,d=o.combineRenderElementsCount,h=s,i=a;else if(l){var E=h.renderObj,x=s.renderObj;E._getVertexBuffer().vertexCount+x._getVertexBuffer().vertexCount>Tt.maxVertexCount||E._getIndexBuffer().indexCount+x._getIndexBuffer().indexCount>Tt.maxIndexCount?(e.getRenderQueue(h._material.renderQueue)._addRenderElement(h),l=a,d=o.combineRenderElementsCount,h=s):(o._addCombineMaterial(l),o._addMaterialToRenderElementOffset(d),o._addCombineRenderObj(h),l=null,h=null,d=-1,o._addCombineRenderObj(s))}else o._addCombineRenderObj(s);_=!0}else l&&(e.getRenderQueue(h._material.renderQueue)._addRenderElement(h),l=null,h=null,d=-1),c++,_=!1;else r=this._prepareDynamicBatchCombineElements[f-1],o._addMaterialToRenderElementOffset(o.combineRenderElementsCount),i=r._material,o._addCombineMaterial(i),o._addCombineRenderObj(r),_=!0,a=s._material,i!==a?(l=a,d=o.combineRenderElementsCount,h=s):o._addCombineRenderObj(s),i=a}l&&(e.getRenderQueue(h._material.renderQueue)._addRenderElement(h),l=null,h=null,d=-1),this._prepareDynamicBatchCombineElements.length=0},e._clearRenderElements=function(){for(var t in this._dynamicBatches)this._dynamicBatches[t]._clearRenderElements()},e._addToRenderQueue=function(t,e,i,n){for(var r in this._dynamicBatches){var a=this._dynamicBatches[r];a.combineRenderElementsCount>0&&a._addToRenderQueue(t,e,i,n)}},e.dispose=function(){this._dynamicBatches=null},t._sortPrepareDynamicBatch=function(t,e){return t._mainSortID-e._mainSortID},t}(),Dt=function(){function t(){}return r(t,"laya.d3.graphics.FrustumCulling"),t.renderShadowObjectCulling=function(t,e,i,n,r){var a=0,s=0,o=0,l=0;for(a=0,o=i.length;a<o;a++){var h=i[a];h&&h._clearRenderElements()}var u,_,c,d=t._cullingRenders;if(r>1){for(a=0,o=t._cullingRendersLength;a<o;a++)if(u=d[a],u.castShadow&&k.isVisible(u._owner.layer.mask)&&u.enable)for(var f=1,m=e.length;f<m;f++)if(_=i[f-1],0!==e[f].containsBoundSphere(u.boundingSphere))for(c=u._renderElements,s=0,l=c.length;s<l;s++)_._addRenderElement(c[s])}else for(a=0,o=t._cullingRendersLength;a<o;a++)if(u=d[a],u.castShadow&&k.isVisible(u._owner.layer.mask)&&u.enable&&0!==e[0].containsBoundSphere(u.boundingSphere))for(u._renderUpdate(n),_=i[0],c=u._renderElements,s=0,l=c.length;s<l;s++)_._addRenderElement(c[s])},t.renderShadowObjectCullingOctree=function(t,e,i,n,r){for(var a=0,s=i.length;a<s;a++){var o=i[a];o&&o._clearRenderElements()}r>1?t.treeRoot.cullingShadowObjects(e,i,!0,0,t):t.treeRoot.cullingShadowObjectsOnePSSM(e[0],i,n,!0,0,t)},t.renderObjectCulling=function(t,e,i,n,r,a){var s=0,o=0,l=0,h=0,u=e._quenes,_=e._dynamicBatchManager,c=e._cullingRenders;for(s=0,o=u.length;s<o;s++){var d=u[s];d&&d._clearRenderElements()}var f=Mt._staticBatchManagers;for(s=0,o=f.length;s<o;s++)f[s]._clearRenderElements();_._clearRenderElements();var m=i.transform.position;for(s=0,o=e._cullingRendersLength;s<o;s++){var p=c[s];if(k.isVisible(p._owner.layer.mask)&&p.enable&&0!==t.containsBoundSphere(p.boundingSphere)&&p._renderUpdate(a)){p._distanceForSort=Pe.distance(p.boundingSphere.center,m)+p.sortingFudge;var v=p._renderElements;for(l=0,h=v.length;l<h;l++){var g=v[l],E=g._staticBatch;if(E&&E._material===g._material)E._addBatchRenderElement(g);else{var x=g.renderObj;x.triangleCount<10&&1===x._vertexBufferCount&&x._getIndexBuffer()&&g._material.renderQueue<2&&g._canDynamicBatch&&!p._owner.isStatic?_._addPrepareRenderElement(g):e.getRenderQueue(g._material.renderQueue)._addRenderElement(g)}}}}for(s=0,o=f.length;s<o;s++)f[s]._addToRenderQueue(e,n,r,a);_._finishCombineDynamicBatch(e),_._addToRenderQueue(e,n,r,a)},t.renderObjectCullingOctree=function(t,e,i,n,r,a){var s=0,o=0,l=e._quenes,h=e._dynamicBatchManager;for(s=0,o=l.length;s<o;s++){var u=l[s];u&&u._clearRenderElements()}var _=Mt._staticBatchManagers;for(s=0,o=_.length;s<o;s++)_[s]._clearRenderElements();for(h._clearRenderElements(),e._cullingRenders.length=0,e.treeRoot.cullingObjects(t,!0,0,i.transform.position,a),s=0,o=_.length;s<o;s++)_[s]._addToRenderQueue(e,n,r,a);h._finishCombineDynamicBatch(e),h._addToRenderQueue(e,n,r,a)},t.renderObjectCullingNoBoundFrustum=function(t,e,i,n,r){var a=0,s=0,o=0,l=0,h=t._quenes,u=t._dynamicBatchManager,_=t._cullingRenders;for(a=0,s=h.length;a<s;a++){var c=h[a];c&&c._clearRenderElements()}var d=Mt._staticBatchManagers;for(a=0,s=d.length;a<s;a++)d[a]._clearRenderElements();u._clearRenderElements();var f=e.transform.position;for(a=0,s=t._cullingRendersLength;a<s;a++){var m=_[a];if(k.isVisible(m._owner.layer.mask)&&m.enable){m._renderUpdate(r),m._distanceForSort=Pe.distance(m.boundingSphere.center,f)+m.sortingFudge;var p=m._renderElements;for(o=0,l=p.length;o<l;o++){var v=p[o],g=v._staticBatch;if(g&&g._material===v._material)g._addBatchRenderElement(v);else{var E=v.renderObj;E.triangleCount<10&&1===E._vertexBufferCount&&E._getIndexBuffer()&&v._material.renderQueue<2&&v._canDynamicBatch&&!m._owner.isStatic?u._addPrepareRenderElement(v):t.getRenderQueue(v._material.renderQueue)._addRenderElement(v)}}}}for(a=0,s=d.length;a<s;a++)d[a]._addToRenderQueue(t,i,n,r);u._finishCombineDynamicBatch(t),u._addToRenderQueue(t,i,n,r)},t}(),Mt=function(){function t(){this._initBatchRenderElements=null,this._staticBatches=null,this._initBatchRenderElements=[],this._staticBatches={}}r(t,"laya.d3.graphics.StaticBatchManager");var e=t.prototype;return e._finishInit=function(){for(var t in this._staticBatches)this._staticBatches[t]._finishInit();this._initBatchRenderElements.length=0},e._initStaticBatchs=function(t){throw new Error("StaticBatchManager:must override this function.")},e._addInitBatchSprite=function(t){for(var e=t._render._renderElements,i=0,n=e.length;i<n;i++)this._initBatchRenderElements.push(e[i])},e._clearRenderElements=function(){for(var t in this._staticBatches)this._staticBatches[t]._clearRenderElements()},e._garbageCollection=function(t){var e=t._staticBatch,i=e._initBatchRenderElements,n=i.indexOf(t);i.splice(n,1),0===i.length&&(e.dispose(),delete this._staticBatches[e._key])},e._addToRenderQueue=function(t,e,i,n){for(var r in this._staticBatches){var a=this._staticBatches[r];a._batchRenderElements.length>0&&a._updateToRenderQueue(t,n)}},e.dispose=function(){this._staticBatches=null},t._addToStaticBatchQueue=function(e){e instanceof laya.d3.core.RenderableSprite3D&&e._addToInitStaticBatchManager();for(var i=0,n=e.numChildren;i<n;i++)t._addToStaticBatchQueue(e._childs[i])},t.combine=function(e,i){var n,r=0,a=0;if(i)for(r=0,a=i.length;r<a;r++){var s=i[r];s._addToInitStaticBatchManager()}else e&&t._addToStaticBatchQueue(e);for(r=0,a=t._staticBatchManagers.length;r<a;r++)n=t._staticBatchManagers[r],n._initStaticBatchs(e),n._finishInit()},t._staticBatchManagers=[],t}(),yt=function(){function t(t,e,i){this._combineRenderElementPoolIndex=0,this._combineRenderElementPool=null,this._initBatchRenderElements=null,this._batchRenderElements=null,this._material=null,this._rootOwner=null,this._key=null,this._manager=null,this._key=t,this._manager=e,this._combineRenderElementPoolIndex=0,this._combineRenderElementPool=[],this._initBatchRenderElements=[],this._batchRenderElements=[],this._rootOwner=i}r(t,"laya.d3.graphics.StaticBatch");var e=t.prototype;return i.imps(e,{"laya.d3.core.render.IRenderable":!0,"laya.resource.IDispose":!0}),e._binarySearch=function(t){for(var e=0,i=this._batchRenderElements.length-1,n=0;e<=i;)n=Math.floor((e+i)/2),this._compareBatchRenderElement(this._batchRenderElements[n],t)?i=n-1:e=n+1;return e},e._compareBatchRenderElement=function(t,e){throw new Error("StaticBatch:must override this function.")},e._getVertexDecLightMap=function(t){return t===ae.vertexDeclaration?te.vertexDeclaration:t===re.vertexDeclaration?Jt.vertexDeclaration:t===Zt.vertexDeclaration?zt.vertexDeclaration:t===he.vertexDeclaration?null:t===Ft.vertexDeclaration?Bt.vertexDeclaration:t===oe.vertexDeclaration?ie.vertexDeclaration:t===Qt.vertexDeclaration?$t.vertexDeclaration:t===se.vertexDeclaration?ee.vertexDeclaration:t===re.vertexDeclaration?Jt.vertexDeclaration:t===Kt.vertexDeclaration?kt.vertexDeclaration:t===he.vertexDeclaration?null:t===Ft.vertexDeclaration?Bt.vertexDeclaration:t===le.vertexDeclaration?ne.vertexDeclaration:t===Qt.vertexDeclaration?$t.vertexDeclaration:t},e._getCombineRenderElementFromPool=function(){throw new Error("StaticBatch:must override this function.")},e._addBatchRenderElement=function(t){this._batchRenderElements.splice(this._binarySearch(t),0,t)},e._updateToRenderQueue=function(t,e){this._combineRenderElementPoolIndex=0,this._getRenderElement(t.getRenderQueue(this._material.renderQueue)._renderElements,t,e)},e._getRenderElement=function(t,e,i){throw new Error("StaticBatch:must override this function.")},e._finishInit=function(){throw new Error("StaticBatch:must override this function.")},e._clearRenderElements=function(){this._batchRenderElements.length=0},e.dispose=function(){},e._getVertexBuffer=function(t){return void 0===t&&(t=0),null},e._getIndexBuffer=function(){return null},e._beforeRender=function(t){return!0},e._render=function(t){},e._getVertexBuffers=function(){return null},e._renderRuntime=function(t,e,i){},a(0,e,"_vertexBufferCount",function(){return 1}),a(0,e,"triangleCount",function(){return 0}),t.combine=function(t){console.log("StaticBatch: discard property,please use StaticBatchManager.combine() function instead."),Mt.combine(t)},t.maxBatchVertexCount=65535,t}(),At=function(){function t(e,i){if(this._id=0,this._shaderValues=null,this._shaderDefineValue=0,this._vertexStride=0,this._vertexElements=null,this._vertexElementsDic=null,this._conchVertexDeclaration=null,this._id=++t._uniqueIDCounter,this._id>t.maxVertexDeclaration)throw new Error("VertexDeclaration: VertexDeclaration count should not large than ",t.maxVertexDeclaration);this._shaderValues=new He,this._vertexElementsDic={},this._vertexStride=e,this._vertexElements=i,D.isConchNode&&(this._conchVertexDeclaration=new ConchVertexDeclare);for(var n=0;n<i.length;n++){var r=i[n],a=r.elementUsage;this._vertexElementsDic[a]=r;var s=[t._getTypeSize(r.elementFormat)/4,5126,!1,this._vertexStride,r.offset];switch(this._shaderValues.setValue(a,s),a){case 1:this._addShaderDefine(ui.SHADERDEFINE_COLOR);break;case 2:this._addShaderDefine(ui.SHADERDEFINE_UV0);break;case 15:this._addShaderDefine(ui.SHADERDEFINE_UV1)}}if(D.isConchNode){for(var o=[],l=0,h=i.length;l<h;l++){var u=i[l];switch(u.elementFormat){case"vector2":o.push({offset:u.offset,elementFormat:35664,elementUsage:u.elementUsage});break;case"vector3":o.push({offset:u.offset,elementFormat:35665,elementUsage:u.elementUsage});break;case"vector4":o.push({offset:u.offset,elementFormat:35666,elementUsage:u.elementUsage})}}this._conchVertexDeclaration.setDelcare(o)}}r(t,"laya.d3.graphics.VertexDeclaration");var e=t.prototype;return e._addShaderDefine=function(t){this._shaderDefineValue|=t,this._conchVertexDeclaration&&this._conchVertexDeclaration.addShaderDefine(t)},e._removeShaderDefine=function(t){this._shaderDefineValue&=~t,this._conchVertexDeclaration&&this._conchVertexDeclaration.removeShaderDefine(t)},e.getVertexElements=function(){return this._vertexElements.slice()},e.getVertexElementByUsage=function(t){return this._vertexElementsDic[t]},e.unBinding=function(){},a(0,e,"shaderDefineValue",function(){return this._shaderDefineValue}),a(0,e,"id",function(){return this._id}),a(0,e,"vertexStride",function(){return this._vertexStride}),a(0,e,"shaderValues",function(){return this._shaderValues}),t._getTypeSize=function(t){switch(t){case"single":return 4;case"vector2":return 8;case"vector3":return 12;case"vector4":return 16;case"color":case"byte4":case"short2":return 4;case"short4":return 8;case"normalizedshort2":return 4;case"normalizedshort4":return 8;case"halfvector2":return 4;case"halfvector4":return 8}return 0},t.getVertexStride=function(e){for(var i=0,n=0;n<e.Length;n++){var r=e[n],a=r.offset+t._getTypeSize(r.elementFormat);i<a&&(i=a)}return i},t._maxVertexDeclarationBit=1e3,t._uniqueIDCounter=1,n(t,["maxVertexDeclaration",function(){return this.maxVertexDeclaration=2147483647-1e3*Math.floor(2147483.647)}]),t}(),It=function(){function t(t,e,i){this.offset=0,this.elementFormat=null,this.elementUsage=0,this.offset=t,this.elementFormat=e,this.elementUsage=i}return r(t,"laya.d3.graphics.VertexElement"),t}(),Rt=(function(){function t(){}r(t,"laya.d3.graphics.VertexElementFormat"),t.Single="single",t.Vector2="vector2",t.Vector3="vector3",t.Vector4="vector4",t.Color="color",t.Byte4="byte4",t.Short2="short2",t.Short4="short4",t.NormalizedShort2="normalizedshort2",t.NormalizedShort4="normalizedshort4",t.HalfVector2="halfvector2",t.HalfVector4="halfvector4"}(),function(){function t(){}r(t,"laya.d3.graphics.VertexElementUsage"),t.POSITION0=0,t.COLOR0=1,t.TEXTURECOORDINATE0=2,t.NORMAL0=3,t.BINORMAL0=4,t.TANGENT0=5,t.BLENDINDICES0=6,t.BLENDWEIGHT0=7,t.DEPTH0=8,t.FOG0=9,t.POINTSIZE0=10,t.SAMPLE0=11,t.TESSELLATEFACTOR0=12,t.COLOR1=13,t.NEXTTEXTURECOORDINATE0=14,t.TEXTURECOORDINATE1=15,t.NEXTTEXTURECOORDINATE1=16,t.CORNERTEXTURECOORDINATE0=17,t.VELOCITY0=18,t.STARTCOLOR0=19,t.STARTSIZE=20,t.AGEADDSCALE0=21,t.STARTROTATION=22,t.ENDCOLOR0=23,t.STARTLIFETIME=24,t.TIME0=33,t.SHAPEPOSITIONSTARTLIFETIME=30,t.DIRECTIONTIME=32,t.SIZEROTATION0=27,t.RADIUS0=28,t.RADIAN0=29,t.STARTSPEED=31,t.RANDOM0=34,t.RANDOM1=35,t.SIMULATIONWORLDPOSTION=36,t.SIMULATIONWORLDROTATION=37,t.TEXTURECOORDINATE0X=38,t.TEXTURECOORDINATE0Y=39,t.OFFSETVECTOR=40}(),function(){function t(t,e,i){this._position=null,this._textureCoordinate0=null,this._time=NaN,this._position=t,this._textureCoordinate0=e,this._time=i}r(t,"laya.d3.graphics.VertexGlitter");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"textureCoordinate",function(){return this._textureCoordinate0}),a(0,e,"position",function(){return this._position}),a(0,e,"time",function(){return this._time}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(24,[new It(0,"vector3",0),new It(12,"vector2",2),new It(20,"single",33)])}]),t}()),Ct=(function(){function t(t,e,i,n,r,a,s,o,l,h){this._cornerTextureCoordinate=null,this._position=null,this._velocity=null,this._startColor=null,this._endColor=null,this._sizeRotation=null,this._radius=null,this._radian=null,this._ageAddScale=NaN,this._time=NaN,this._cornerTextureCoordinate=t,this._position=e,this._velocity=i,this._startColor=n,this._endColor=r,this._sizeRotation=a,this._radius=s,this._radian=o,this._ageAddScale=l,this._time=h}r(t,"laya.d3.graphics.VertexParticle");var e=t.prototype;i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"endColor",function(){return this._endColor}),a(0,e,"cornerTextureCoordinate",function(){return this._cornerTextureCoordinate}),a(0,e,"sizeRotation",function(){return this._sizeRotation}),a(0,e,"velocity",function(){return this._velocity}),a(0,e,"position",function(){return this._position}),a(0,e,"startColor",function(){return this._startColor}),a(0,e,"radius",function(){return this._radius}),a(0,e,"radian",function(){return this._radian}),a(0,e,"ageAddScale",function(){return this._ageAddScale}),a(0,e,"time",function(){return this._time}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(116,[new It(0,"vector4",17),new It(16,"vector3",0),new It(28,"vector3",18),new It(40,"vector4",19),new It(56,"vector4",23),new It(72,"vector3",27),new It(84,"vector2",28),new It(92,"vector4",29),new It(108,"single",24),new It(112,"single",33)])}])}(),function(){function t(t){this._position=null,this._position=t}r(t,"laya.d3.graphics.VertexPosition");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"position",function(){return this._position}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(12,[new It(0,"vector3",0)])}]),t}()),bt=function(){function t(t,e){this._position=null,this._normal=null,this._position=t,this._normal=e}r(t,"laya.d3.graphics.VertexPositionNormal");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(24,[new It(0,"vector3",0),new It(12,"vector3",3)])}]),t}(),wt=function(){function t(t,e,i){this._position=null,this._normal=null,this._color=null,this._position=t,this._normal=e,this._color=i}r(t,"laya.d3.graphics.VertexPositionNormalColor");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"color",function(){return this._color}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(40,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector4",1)])}]),t}(),Nt=function(){function t(t,e,i,n,r){this._position=null,this._normal=null,this._color=null,this._blendIndex=null,this._blendWeight=null,this._position=t,this._normal=e,this._color=i,this._blendIndex=n,this._blendWeight=r}r(t,"laya.d3.graphics.VertexPositionNormalColorSkin");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(0,e,"color",function(){return this._color}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(72,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector4",1),new It(40,"vector4",7),new It(56,"vector4",6)])}]),t}(),Pt=function(){function t(t,e,i,n,r,a){this._position=null,this._normal=null,this._color=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=t,this._normal=e,this._color=i,this._tangent=n,this._blendIndex=r,this._blendWeight=a}r(t,"laya.d3.graphics.VertexPositionNormalColorSkinSTangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(0,e,"color",function(){return this._color}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(88,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector4",1),new It(40,"vector4",7),new It(56,"vector4",6),new It(72,"vector4",5)])}]),t}(),Lt=function(){function t(t,e,i,n,r,a){this._position=null,this._normal=null,this._color=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=t,this._normal=e,this._color=i,this._tangent=n,this._blendIndex=r,this._blendWeight=a}r(t,"laya.d3.graphics.VertexPositionNormalColorSkinTangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(0,e,"color",function(){return this._color}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(84,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector4",1),new It(40,"vector4",7),new It(56,"vector4",6),new It(72,"vector3",5)])}]),t}(),Ot=function(){function t(t,e,i,n){this._position=null,this._normal=null,this._color=null,this._tangent=null,this._position=t,this._normal=e,this._color=i,this._tangent=n}r(t,"laya.d3.graphics.VertexPositionNormalColorSTangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"color",function(){return this._color}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(56,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector4",1),new It(40,"vector4",5)])}]),t}(),Vt=function(){function t(t,e,i,n){this._position=null,this._normal=null,this._color=null,this._tangent=null,this._position=t,this._normal=e,this._color=i,this._tangent=n}r(t,"laya.d3.graphics.VertexPositionNormalColorTangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"color",function(){return this._color}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(52,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector4",1),new It(40,"vector3",5)])}]),t}(),Ft=function(){function t(t,e,i,n){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._position=t,this._normal=e,this._color=i,this._textureCoordinate=n}r(t,"laya.d3.graphics.VertexPositionNormalColorTexture");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"textureCoordinate",function(){return this._textureCoordinate}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"color",function(){return this._color}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(48,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector4",1),new It(40,"vector2",2)])}]),t}(),Bt=function(){function t(t,e,i,n,r){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._position=t,this._normal=e,this._color=i,this._textureCoordinate0=n,this._textureCoordinate1=r}r(t,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"color",function(){return this._color}),a(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(56,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector4",1),new It(40,"vector2",2),new It(48,"vector2",15)])}]),t}(),Ut=function(){function t(t,e,i,n,r,a,s){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._position=t,this._normal=e,this._color=i,this._textureCoordinate0=n,this._textureCoordinate1=r,this._blendIndex=a,this._blendWeight=s}r(t,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1Skin");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(0,e,"color",function(){return this._color}),a(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(88,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector4",1),new It(40,"vector2",2),new It(48,"vector2",15),new It(56,"vector4",7),new It(72,"vector4",6)])}]),t}(),Ht=function(){function t(t,e,i,n,r,a,s,o){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=t,this._normal=e,this._color=i,this._textureCoordinate0=n,this._textureCoordinate1=r,this._tangent=a,this._blendIndex=s,this._blendWeight=o}r(t,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1SkinSTangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(0,e,"color",function(){return this._color}),a(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(104,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector4",1),new It(40,"vector2",2),new It(48,"vector2",15),new It(56,"vector4",7),new It(72,"vector4",6),new It(88,"vector4",5)])}]),t}(),Gt=function(){function t(){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null}r(t,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1SkinTangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),e.VertexPositionNormalColorTexture0SkinTangent=function(t,e,i,n,r,a,s,o){this._position=t,this._normal=e,this._color=i,this._textureCoordinate0=n,this._textureCoordinate1=r,this._tangent=a,this._blendIndex=s,this._blendWeight=o},a(0,e,"tangent",function(){return this._tangent}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(0,e,"color",function(){return this._color}),a(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(100,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector4",1),new It(40,"vector2",2),new It(48,"vector2",15),new It(56,"vector4",7),new It(72,"vector4",6),new It(88,"vector3",5)])}]),t}(),zt=function(){function t(t,e,i,n,r,a){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._tangent=null,this._position=t,this._normal=e,this._color=i,this._textureCoordinate0=n,this._textureCoordinate1=r,this._tangent=a}r(t,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1STangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"color",function(){return this._color}),a(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(72,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector4",1),new It(40,"vector2",2),new It(48,"vector2",15),new It(56,"vector4",5)])}]),t}(),kt=function(){function t(){this._position=null,this._normal=null,this._color=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._tangent=null}r(t,"laya.d3.graphics.VertexPositionNormalColorTexture0Texture1Tangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),e.VertexPositionNormalColorTexture0Tangent=function(t,e,i,n,r,a){this._position=t,this._normal=e,this._color=i,this._textureCoordinate0=n,this._textureCoordinate1=r,this._tangent=a},a(0,e,"tangent",function(){return this._tangent}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"color",function(){return this._color}),a(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(68,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector4",1),new It(40,"vector2",2),new It(48,"vector2",15),new It(56,"vector3",5)])}]),t}(),Wt=function(){function t(t,e,i,n,r,a){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._position=t,this._normal=e,this._color=i,this._textureCoordinate=n,this._blendIndex=r,this._blendWeight=a}r(t,"laya.d3.graphics.VertexPositionNormalColorTextureSkin");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"textureCoordinate",function(){return this._textureCoordinate}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(0,e,"color",function(){return this._color}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(80,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector4",1),new It(40,"vector2",2),new It(48,"vector4",7),new It(64,"vector4",6)])}]),t}(),Xt=function(){function t(t,e,i,n,r,a,s){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=t,this._normal=e,this._color=i,this._textureCoordinate=n,this._tangent=r,this._blendIndex=a,this._blendWeight=s}r(t,"laya.d3.graphics.VertexPositionNormalColorTextureSkinSTangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"textureCoordinate",function(){return this._textureCoordinate}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(0,e,"color",function(){return this._color}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(96,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector4",1),new It(40,"vector2",2),new It(48,"vector4",7),new It(64,"vector4",6),new It(80,"vector4",5)])}]),t}(),Yt=function(){function t(t,e,i,n,r,a,s){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=t,this._normal=e,this._color=i,this._textureCoordinate=n,this._tangent=r,this._blendIndex=a,this._blendWeight=s}r(t,"laya.d3.graphics.VertexPositionNormalColorTextureSkinTangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"textureCoordinate",function(){return this._textureCoordinate}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(0,e,"color",function(){return this._color}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(92,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector4",1),new It(40,"vector2",2),new It(48,"vector4",7),new It(64,"vector4",6),new It(80,"vector3",5)])}]),t}(),Zt=function(){function t(t,e,i,n,r){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._tangent=null,this._position=t,this._normal=e,this._color=i,this._textureCoordinate=n,this._tangent=r}r(t,"laya.d3.graphics.VertexPositionNormalColorTextureSTangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"textureCoordinate",function(){return this._textureCoordinate}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"color",function(){return this._color}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(64,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector4",1),new It(40,"vector2",2),new It(48,"vector4",5)])}]),t}(),Kt=function(){function t(t,e,i,n,r){this._position=null,this._normal=null,this._color=null,this._textureCoordinate=null,this._tangent=null,this._position=t,this._normal=e,this._color=i,this._textureCoordinate=n,this._tangent=r}r(t,"laya.d3.graphics.VertexPositionNormalColorTextureTangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"textureCoordinate",function(){return this._textureCoordinate}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"color",function(){return this._color}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(60,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector4",1),new It(40,"vector2",2),new It(48,"vector3",5)])}]),t}(),jt=function(){function t(t,e,i){this._position=null,this._normal=null,this._tangent=null,this._position=t,this._normal=e,this._tangent=i}r(t,"laya.d3.graphics.VertexPositionNormalSTangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(40,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector4",5)])}]),t}(),qt=function(){function t(t,e,i){this._position=null,this._normal=null,this._tangent=null,this._position=t,this._normal=e,this._tangent=i}r(t,"laya.d3.graphics.VertexPositionNormalTangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(36,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector3",5)])}]),t}(),Qt=function(){function t(t,e,i){this._position=null,this._normal=null,this._textureCoordinate=null,this._position=t,this._normal=e,this._textureCoordinate=i}r(t,"laya.d3.graphics.VertexPositionNormalTexture");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"textureCoordinate",function(){return this._textureCoordinate}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(32,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector2",2)])}]),t}(),$t=function(){function t(t,e,i,n){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._position=t,this._normal=e,this._textureCoordinate0=i,this._textureCoordinate1=n}r(t,"laya.d3.graphics.VertexPositionNormalTexture0Texture1");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(40,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector2",2),new It(32,"vector2",15)])}]),t}(),Jt=function(){function t(t,e,i,n,r,a){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._position=t,this._normal=e,this._textureCoordinate0=i,this._textureCoordinate1=n,this._blendIndex=r,this._blendWeight=a}r(t,"laya.d3.graphics.VertexPositionNormalTexture0Texture1Skin");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(72,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector2",2),new It(32,"vector2",15),new It(40,"vector4",7),new It(56,"vector4",6)])}]),t}(),te=function(){function t(t,e,i,n,r,a,s){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=t,this._normal=e,this._textureCoordinate0=i,this._textureCoordinate1=n,this._tangent=r,this._blendIndex=a,this._blendWeight=s}r(t,"laya.d3.graphics.VertexPositionNormalTexture0Texture1SkinSTangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(88,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector2",2),new It(32,"vector2",15),new It(40,"vector4",7),new It(56,"vector4",6),new It(72,"vector4",5)])}]),t}(),ee=function(){function t(){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null}r(t,"laya.d3.graphics.VertexPositionNormalTexture0Texture1SkinTangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),e.VertexPositionNormalTexture0SkinTangent=function(t,e,i,n,r,a,s){this._position=t,this._normal=e,this._textureCoordinate0=i,this._textureCoordinate1=n,this._tangent=r,this._blendIndex=a,this._blendWeight=s},a(0,e,"tangent",function(){return this._tangent}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(84,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector2",2),new It(32,"vector2",15),new It(40,"vector4",7),new It(56,"vector4",6),new It(72,"vector3",5)])}]),t}(),ie=function(){function t(t,e,i,n,r){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._tangent=null,this._position=t,this._normal=e,this._textureCoordinate0=i,this._textureCoordinate1=n,this._tangent=r}r(t,"laya.d3.graphics.VertexPositionNormalTexture0Texture1STangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(56,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector2",2),new It(32,"vector2",15),new It(40,"vector4",5)])}]),t}(),ne=function(){function t(){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._tangent=null}r(t,"laya.d3.graphics.VertexPositionNormalTexture0Texture1Tangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),e.VertexPositionNormalTexture0Tangent=function(t,e,i,n,r){this._position=t,this._normal=e,this._textureCoordinate0=i,this._textureCoordinate1=n,this._tangent=r},a(0,e,"tangent",function(){return this._tangent}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(52,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector2",2),new It(32,"vector2",15),new It(40,"vector3",5)])}]),t}(),re=function(){function t(t,e,i,n,r){this._position=null,this._normal=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._position=t,this._normal=e,this._textureCoordinate=i,this._blendIndex=n,this._blendWeight=r}r(t,"laya.d3.graphics.VertexPositionNormalTextureSkin");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"textureCoordinate",function(){return this._textureCoordinate}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(64,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector2",2),new It(32,"vector4",7),new It(48,"vector4",6)])}]),t}(),ae=function(){function t(t,e,i,n,r,a){this._position=null,this._normal=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=t,this._normal=e,this._textureCoordinate=i,this._tangent=n,this._blendIndex=r,this._blendWeight=a}r(t,"laya.d3.graphics.VertexPositionNormalTextureSkinSTangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"textureCoordinate",function(){return this._textureCoordinate}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(80,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector2",2),new It(32,"vector4",7),new It(48,"vector4",6),new It(64,"vector4",5)])}]),t}(),se=function(){function t(t,e,i,n,r,a){this._position=null,this._normal=null,this._textureCoordinate=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this._position=t,this._normal=e,this._textureCoordinate=i,this._tangent=n,this._blendIndex=r,this._blendWeight=a}r(t,"laya.d3.graphics.VertexPositionNormalTextureSkinTangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"textureCoordinate",function(){return this._textureCoordinate}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(76,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector2",2),new It(32,"vector4",7),new It(48,"vector4",6),new It(64,"vector3",5)])}]),t}(),oe=function(){function t(t,e,i,n){this._position=null,this._normal=null,this._textureCoordinate=null,this._tangent=null,this._position=t,this._normal=e,this._textureCoordinate=i,this._tangent=n}r(t,"laya.d3.graphics.VertexPositionNormalTextureSTangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"textureCoordinate",function(){return this._textureCoordinate}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(48,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector2",2),new It(32,"vector4",5)])}]),t}(),le=function(){function t(t,e,i,n){this._position=null,this._normal=null,this._textureCoordinate=null,this._tangent=null,this._position=t,this._normal=e,this._textureCoordinate=i,this._tangent=n}r(t,"laya.d3.graphics.VertexPositionNormalTextureTangent");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"textureCoordinate",function(){return this._textureCoordinate}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(44,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector2",2),new It(32,"vector3",5)])}]),t}(),he=function(){function t(t,e,i){this._position=null,this._normal=null,this._textureCoordinate=null,this._position=t,this._normal=e,this._textureCoordinate=i}r(t,"laya.d3.graphics.VertexPositionNTBTexture");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"textureCoordinate",function(){return this._textureCoordinate}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(56,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector3",5),new It(36,"vector3",4),new It(48,"vector2",2)])}]),t}(),ue=function(){function t(t,e,i,n,r,a,s,o){this._position=null,this._normal=null,this._textureCoordinate0=null,this._textureCoordinate1=null,this._blendIndex=null,this._blendWeight=null,this._tangent=null,this.binormal=null,this._position=t,this._normal=e,this._textureCoordinate0=n,this._textureCoordinate1=r,this._tangent=a,i=i,this._blendIndex=s,this._blendWeight=o}r(t,"laya.d3.graphics.VertexPositionNTBTexture0Texture1Skin");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"tangent",function(){return this._tangent}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(0,e,"textureCoordinate1",function(){return this._textureCoordinate1}),a(0,e,"blendIndex",function(){return this._blendIndex}),a(0,e,"blendWeight",function(){return this._blendWeight}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(96,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector3",5),new It(36,"vector3",4),new It(48,"vector2",2),new It(56,"vector2",15),new It(64,"vector4",7),new It(80,"vector4",6)])}]),t}(),_e=function(){function t(t,e,i){this._position=null,this._normal=null,this._textureCoordinate=null,this._position=t,this._normal=e,this._textureCoordinate=i}r(t,"laya.d3.graphics.VertexPositionNTBTextureSkin");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"textureCoordinate",function(){return this._textureCoordinate}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(88,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector3",5),new It(36,"vector3",4),new It(48,"vector2",2),new It(56,"vector4",7),new It(72,"vector4",6)])}]),t}(),ce=function(){function t(t,e,i,n){this._position=null,this._normal=null,this._textureCoord0=null,this._textureCoord1=null,this._position=t,this._normal=e,this._textureCoord0=i,this._textureCoord1=n}r(t,"laya.d3.graphics.VertexPositionTerrain");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"normal",function(){return this._normal}),a(0,e,"position",function(){return this._position}),a(0,e,"textureCoord0",function(){return this._textureCoord0}),a(0,e,"textureCoord1",function(){return this._textureCoord1}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(40,[new It(0,"vector3",0),new It(12,"vector3",3),new It(24,"vector2",2),new It(32,"vector2",15)])}]),t}(),de=function(){function t(t,e){this._position=null,this._textureCoordinate0=null,this._position=t,this._textureCoordinate0=e}r(t,"laya.d3.graphics.VertexPositionTexture0");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"position",function(){return this._position}),a(0,e,"textureCoordinate0",function(){return this._textureCoordinate0}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(20,[new It(0,"vector3",0),new It(12,"vector2",2)])}]),t}(),fe=function(){function t(t,e,i,n,r,a,s,o,l,h,u,_,c,d){this._cornerTextureCoordinate=null,this._positionStartLifeTime=null,this._velocity=null,this._startColor=null,this._startSize=null,this._startRotation0=null,this._startRotation1=null,this._startRotation2=null,this._startLifeTime=NaN,this._time=NaN,this._startSpeed=NaN,this._randoms0=null,this._randoms1=null,this._simulationWorldPostion=null,this._cornerTextureCoordinate=t,this._positionStartLifeTime=e,this._velocity=i,this._startColor=n,this._startSize=r,this._startRotation0=a,this._startRotation1=s,this._startRotation2=o,this._startLifeTime=l,this._time=h,this._startSpeed=u,this._randoms0=this.random0,this._randoms1=this.random1,this._simulationWorldPostion=d}r(t,"laya.d3.graphics.VertexShurikenParticleBillboard");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"cornerTextureCoordinate",function(){return this._cornerTextureCoordinate}),a(0,e,"random1",function(){return this._randoms1}),a(0,e,"startRotation2",function(){return this._startRotation2}),a(0,e,"positionStartLifeTime",function(){return this._positionStartLifeTime}),a(0,e,"velocity",function(){return this._velocity}),a(0,e,"random0",function(){return this._randoms0}),a(0,e,"startSize",function(){return this._startSize}),a(0,e,"startColor",function(){return this._startColor}),a(0,e,"startRotation0",function(){return this._startRotation0}),a(0,e,"startRotation1",function(){return this._startRotation1}),a(0,e,"startLifeTime",function(){return this._startLifeTime}),a(0,e,"time",function(){return this._time}),a(0,e,"startSpeed",function(){return this._startSpeed}),a(0,e,"simulationWorldPostion",function(){return this._simulationWorldPostion}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(152,[new It(0,"vector4",17),new It(16,"vector4",30),new It(32,"vector4",32),new It(48,"vector4",19),new It(64,"vector3",20),new It(76,"vector3",22),new It(88,"single",31),new It(92,"vector4",34),new It(108,"vector4",35),new It(124,"vector3",36),new It(136,"vector4",37)])}]),t}(),me=function(){function t(t,e,i,n,r,a,s,o,l,h,u,_,c,d){this._cornerTextureCoordinate=null,this._positionStartLifeTime=null,this._velocity=null,this._startColor=null,this._startSize=null,this._startRotation0=null,this._startRotation1=null,this._startRotation2=null,this._startLifeTime=NaN,this._time=NaN,this._startSpeed=NaN,this._randoms0=null,this._randoms1=null,this._simulationWorldPostion=null,this._cornerTextureCoordinate=t,this._positionStartLifeTime=e,this._velocity=i,this._startColor=n,this._startSize=r,this._startRotation0=a,this._startRotation1=s,this._startRotation2=o,this._startLifeTime=l,this._time=h,this._startSpeed=u,this._randoms0=this.random0,this._randoms1=this.random1,this._simulationWorldPostion=d}r(t,"laya.d3.graphics.VertexShurikenParticleMesh");var e=t.prototype;return i.imps(e,{"laya.d3.graphics.IVertex":!0}),a(0,e,"cornerTextureCoordinate",function(){return this._cornerTextureCoordinate}),a(0,e,"velocity",function(){return this._velocity}),a(0,e,"position",function(){return this._positionStartLifeTime}),a(0,e,"random0",function(){return this._randoms0}),a(0,e,"startSize",function(){return this._startSize}),a(0,e,"startColor",function(){return this._startColor}),a(0,e,"startRotation0",function(){return this._startRotation0}),a(0,e,"startRotation1",function(){return this._startRotation1}),a(0,e,"random1",function(){return this._randoms1}),a(0,e,"startRotation2",function(){return this._startRotation2}),a(0,e,"startLifeTime",function(){return this._startLifeTime}),a(0,e,"time",function(){return this._time}),a(0,e,"startSpeed",function(){return this._startSpeed}),a(0,e,"simulationWorldPostion",function(){return this._simulationWorldPostion}),a(0,e,"vertexDeclaration",function(){return t._vertexDeclaration}),a(1,t,"vertexDeclaration",function(){return t._vertexDeclaration}),n(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new At(172,[new It(0,"vector3",0),new It(12,"vector4",1),new It(28,"vector2",2),new It(36,"vector4",30),new It(52,"vector4",32),new It(68,"vector4",19),new It(84,"vector3",20),new It(96,"vector3",22),new It(108,"single",31),new It(112,"vector4",34),new It(128,"vector4",35),new It(144,"vector3",36),new It(156,"vector4",37)])}]),t}(),pe=function(){function t(t,e,i,n,r,a){this._version=null,this._strings=["BLOCK","DATA","STRINGS"],this._materials=null,this._subMeshes=null,this._materialMap=null,this._readData=null,this._mesh=null,this._BLOCK={count:0},this._DATA={offset:0,size:0},this._STRINGS={offset:0,size:0},this._shaderAttributes=null,this._mesh=i,this._materials=n,this._subMeshes=r,this._materialMap=a,this._version=e,this._onLoaded(t)}r(t,"laya.d3.loaders.LoadModelV01");var e=t.prototype;return e._onLoaded=function(t){this._readData=t,this.READ_BLOCK();for(var e=0;e<this._BLOCK.count;e++){var i=this._readData.getUint16(),n=this._strings[i],r=this["READ_"+n];if(null==r)throw new Error("model file err,no this function:"+i+" "+n);if(!r.call(this))break}return this._mesh},e.onError=function(){},e._readString=function(){return this._strings[this._readData.getUint16()]},e.READ_BLOCK=function(){this._readData.getUint16();return this._BLOCK.count=this._readData.getUint16(),!0},e.READ_DATA=function(){return this._DATA.offset=this._readData.getUint32(),this._DATA.size=this._readData.getUint32(),!0},e.READ_STRINGS=function(){this._STRINGS.offset=this._readData.getUint16(),this._STRINGS.size=this._readData.getUint16();var t=this._readData.pos;this._readData.pos=this._STRINGS.offset+this._DATA.offset;for(var e=0;e<this._STRINGS.size;e++)this._strings[e]=this._readData.readUTFString();return this._readData.pos=t,!0},e.READ_MATERIAL=function(){var t=this._readData.getUint16(),e=(this._readString(),this._readString());return this._materials[t]="null"!==e?E.getRes(this._materialMap[e]):new pi,!0},e.READ_MESH=function(){this._readString();switch(this._version){case"LAYAMODEL:01":console.log("Warning: The (.lm) file is converted by old fbxTools,please reConverted it use  lastest fbxTools version,later we will remove the  support of old version (.lm) support.");break;case"LAYASKINANI:01":case"LAYAMODEL:02":var t=this._readData.__getBuffer(),e=0,i=0,n=this._readData.getUint32(),r=this._readData.getUint32(),a=(new Float32Array(t.slice(n+this._DATA.offset,n+this._DATA.offset+r)),this._readData.getUint32()),s=this._readData.getUint32(),o=new Float32Array(t.slice(a+this._DATA.offset,a+this._DATA.offset+s));for(this.mesh._inverseBindPoses=[],e=0,i=o.length;e<i;e+=16){var l=new Ae(o[e+0],o[e+1],o[e+2],o[e+3],o[e+4],o[e+5],o[e+6],o[e+7],o[e+8],o[e+9],o[e+10],o[e+11],o[e+12],o[e+13],o[e+14],o[e+15]);this.mesh._inverseBindPoses.push(l)}break;default:throw new Error("LoadModel:unknown version.")}return!0},e.READ_SUBMESH=function(){var e=(this._readString(),this._readData.getUint8(),this._readString());this._shaderAttributes=e.match(t._attrReg);var i=this._readData.getUint32(),n=this._readData.getUint32(),r=(this._readData.getUint32(),this._readData.getUint32(),this._readData.getUint32()),a=this._readData.getUint32(),s=this._readData.getUint32(),o=this._readData.getUint32(),l=this._readData.__getBuffer(),h=new Fe(this._mesh),u=this._getVertexDeclaration(),_=Ki.create(u,a/u.vertexStride,35044,!0),c=r+this._DATA.offset,d=l.slice(c,c+a);_.setData(new Float32Array(d)),h._vertexBuffer=_;for(var f=_.vertexDeclaration.getVertexElements(),m=0;m<f.length;m++)h._bufferUsage[f[m].elementUsage]=_;var p=Zi.create("ushort",n/2,35044,!0),v=i+this._DATA.offset,g=l.slice(v,v+n);p.setData(new Uint16Array(g)),h._indexBuffer=p;var E=l.slice(s+this._DATA.offset,s+this._DATA.offset+o);return h._boneIndicesList[0]=new Uint8Array(E),this._subMeshes.push(h),!0},e.READ_DATAAREA=function(){return!1},e._getVertexDeclaration=function(){for(var t=!1,e=!1,i=!1,n=!1,r=!1,a=!1,s=!1,o=!1,l=!1,h=0;h<this._shaderAttributes.length;h+=8)switch(this._shaderAttributes[h]){case"POSITION":t=!0;break;case"NORMAL":e=!0;break;case"COLOR":i=!0;break;case"UV":n=!0;break;case"UV1":r=!0;break;case"BLENDWEIGHT":s=!0;break;case"BLENDINDICES":o=!0;break;case"TANGENT":a=!0;break;case"BINORMAL":l=!0}var u;return t&&e&&i&&n&&r&&s&&o&&a?u=Gt.vertexDeclaration:t&&e&&i&&n&&r&&s&&o?u=Ut.vertexDeclaration:t&&e&&n&&r&&s&&o&&a?u=ee.vertexDeclaration:t&&e&&n&&r&&s&&o?u=Jt.vertexDeclaration:t&&e&&i&&n&&s&&o&&a?u=Yt.vertexDeclaration:t&&e&&i&&n&&s&&o?u=Wt.vertexDeclaration:t&&e&&a&&l&&n&&s&&o?u=_e.vertexDeclaration:t&&e&&n&&s&&o&&a?u=se.vertexDeclaration:t&&e&&n&&s&&o?u=re.vertexDeclaration:t&&e&&i&&s&&o&&a?u=Lt.vertexDeclaration:t&&e&&i&&s&&o?u=Nt.vertexDeclaration:t&&e&&i&&n&&r&&a?u=kt.vertexDeclaration:t&&e&&i&&n&&r?u=Bt.vertexDeclaration:t&&e&&n&&r&&a?u=ne.vertexDeclaration:t&&e&&n&&r?u=$t.vertexDeclaration:t&&e&&i&&n&&a?u=Kt.vertexDeclaration:t&&e&&n&&a&&l?u=he.vertexDeclaration:t&&e&&i&&n?u=Ft.vertexDeclaration:t&&e&&n&&a?u=le.vertexDeclaration:t&&e&&n?u=Qt.vertexDeclaration:t&&e&&i&&a?u=Vt.vertexDeclaration:t&&e&&i&&(u=wt.vertexDeclaration),u},a(0,e,"mesh",function(){return this._mesh}),n(t,["_attrReg",function(){return this._attrReg=new RegExp("(\\w+)|([:,;])","g")}]),t}(),ve=function(){function t(){}return r(t,"laya.d3.loaders.LoadModelV02"),t.parse=function(e,i,n,r,a,s){t._mesh=n,t._materials=r,t._subMeshes=a,t._materialMap=s,t._version=i,t._readData=e,t.READ_DATA(),t.READ_BLOCK(),t.READ_STRINGS();for(var o=0,l=t._BLOCK.count;o<l;o++){t._readData.pos=t._BLOCK.blockStarts[o];var h=t._readData.getUint16(),u=t._strings[h],_=t["READ_"+u];if(null==_)throw new Error("model file err,no this function:"+h+" "+u);_.call()}t._strings.length=0,t._readData=null,t._version=null,t._mesh=null,t._materials=null,t._subMeshes=null,t._materialMap=null},t._readString=function(){return t._strings[t._readData.getUint16()]},t.READ_DATA=function(){t._DATA.offset=t._readData.getUint32(),t._DATA.size=t._readData.getUint32()},t.READ_BLOCK=function(){for(var e=t._BLOCK.count=t._readData.getUint16(),i=t._BLOCK.blockStarts=[],n=t._BLOCK.blockLengths=[],r=0;r<e;r++)i.push(t._readData.getUint32()),n.push(t._readData.getUint32())},t.READ_STRINGS=function(){var e=t._readData.getUint32(),i=t._readData.getUint16(),n=t._readData.pos;t._readData.pos=e+t._DATA.offset;for(var r=0;r<i;r++)t._strings[r]=t._readData.readUTFString();t._readData.pos=n},t.READ_MATERIAL=function(){var e=(t._readString(),t._readString(),t._readString());return""!==e&&t._materials.push(E.getRes(t._materialMap[e])),!0},t.READ_MESH=function(){var e=(t._readString(),t._readData.__getBuffer()),i=0,n=0,r=t._readData.getInt16(),a=t._DATA.offset;for(i=0;i<r;i++){var s=a+t._readData.getUint32(),o=t._readData.getUint32(),l=new Float32Array(e.slice(s,s+o)),h=t._readString(),u=h.match(t._attrReg),_=t._getVertexDeclaration(u),c=Ki.create(_,4*l.length/_.vertexStride,35044,!0);c.setData(l),t._mesh._vertexBuffers.push(c)}var d=a+t._readData.getUint32(),f=t._readData.getUint32(),m=new Uint16Array(e.slice(d,d+f)),p=Zi.create("ushort",f/2,35044,!0);p.setData(m),t._mesh._indexBuffer=p;var v=t._mesh._boneNames=[],g=t._readData.getUint16();for(v.length=g,i=0;i<g;i++)v[i]=t._strings[t._readData.getUint16()];var E=t._readData.getUint32(),x=t._readData.getUint32(),T=(new Float32Array(e.slice(a+E,a+E+x)),t._readData.getUint32()),S=t._readData.getUint32(),D=new Float32Array(e.slice(a+T,a+T+S));for(t._mesh._inverseBindPoses=[],i=0,n=D.length;i<n;i+=16){var M=new Ae(D[i+0],D[i+1],D[i+2],D[i+3],D[i+4],D[i+5],D[i+6],D[i+7],D[i+8],D[i+9],D[i+10],D[i+11],D[i+12],D[i+13],D[i+14],D[i+15]);t._mesh._inverseBindPoses.push(M)}return t._mesh._skinnedDatas=new Float32Array(16*D.length),!0},t.READ_SUBMESH=function(){var e=t._readData.__getBuffer(),i=new Fe(t._mesh),n=t._readData.getInt16(),r=t._readData.getUint32(),a=t._readData.getUint32();i._vertexBuffer=t._mesh._vertexBuffers[n],i._vertexStart=r,i._vertexCount=a;var s=t._readData.getUint32(),o=t._readData.getUint32(),l=t._mesh._indexBuffer;i._indexBuffer=l,i._indexStart=s,i._indexCount=o,i._indices=new Uint16Array(l.getData().buffer,2*s,o);var h=t._DATA.offset,u=i._subIndexBufferStart,_=i._subIndexBufferCount,c=i._boneIndicesList,d=t._readData.getUint16();u.length=d,_.length=d,c.length=d;for(var f=0;f<d;f++){u[f]=t._readData.getUint32(),_[f]=t._readData.getUint32();var m=t._readData.getUint32(),p=t._readData.getUint32();i._boneIndicesList[f]=new Uint8Array(e.slice(h+m,h+m+p))}return t._subMeshes.push(i),!0},t._getVertexDeclaration=function(t){for(var e=!1,i=!1,n=!1,r=!1,a=!1,s=!1,o=!1,l=!1,h=!1,u=0;u<t.length;u++)switch(t[u]){case"POSITION":e=!0;break;case"NORMAL":i=!0;break;case"COLOR":n=!0;break;case"UV":r=!0;break;case"UV1":a=!0;break;case"BLENDWEIGHT":o=!0;break;case"BLENDINDICES":l=!0;break;case"TANGENT":s=!0;break;case"BINORMAL":h=!0}var _;return e&&i&&n&&r&&a&&o&&l&&s?_=Gt.vertexDeclaration:e&&i&&n&&r&&a&&o&&l?_=Ut.vertexDeclaration:e&&i&&r&&a&&o&&l&&s?_=ee.vertexDeclaration:e&&i&&r&&a&&o&&l?_=Jt.vertexDeclaration:e&&i&&n&&r&&o&&l&&s?_=Yt.vertexDeclaration:e&&i&&n&&r&&o&&l?_=Wt.vertexDeclaration:e&&i&&r&&o&&l&&s?_=se.vertexDeclaration:e&&i&&r&&o&&l?_=re.vertexDeclaration:e&&i&&n&&o&&l&&s?_=Lt.vertexDeclaration:e&&i&&n&&o&&l?_=Nt.vertexDeclaration:e&&i&&n&&r&&a&&s?_=kt.vertexDeclaration:e&&i&&n&&r&&a?_=Bt.vertexDeclaration:e&&i&&r&&a&&s?_=ne.vertexDeclaration:e&&i&&r&&a?_=$t.vertexDeclaration:e&&i&&n&&r&&s?_=Kt.vertexDeclaration:e&&i&&r&&s&&h?_=he.vertexDeclaration:e&&i&&n&&r?_=Ft.vertexDeclaration:e&&i&&r&&s?_=le.vertexDeclaration:e&&i&&r?_=Qt.vertexDeclaration:e&&i&&n&&s?_=Vt.vertexDeclaration:e&&i&&n&&(_=wt.vertexDeclaration),_},t._strings=[],t._readData=null,t._version=null,t._mesh=null,t._materials=null,t._subMeshes=null,t._materialMap=null,n(t,["_attrReg",function(){return this._attrReg=new RegExp("(\\w+)|([:,;])","g")},"_BLOCK",function(){return this._BLOCK={count:0}},"_DATA",function(){return this._DATA={offset:0,size:0}}]),t}(),ge=function(){function t(){}return r(t,"laya.d3.loaders.LoadModelV03"),t.parse=function(e,i,n,r,a){t._mesh=n,t._subMeshes=r,t._materialMap=a,t._version=i,t._readData=e,t.READ_DATA(),t.READ_BLOCK(),t.READ_STRINGS();for(var s=0,o=t._BLOCK.count;s<o;s++){t._readData.pos=t._BLOCK.blockStarts[s];var l=t._readData.getUint16(),h=t._strings[l],u=t["READ_"+h];if(null==u)throw new Error("model file err,no this function:"+l+" "+h);u.call()}t._strings.length=0,t._readData=null,t._version=null,t._mesh=null,t._subMeshes=null,t._materialMap=null},t._readString=function(){return t._strings[t._readData.getUint16()]},t.READ_DATA=function(){t._DATA.offset=t._readData.getUint32(),t._DATA.size=t._readData.getUint32()},t.READ_BLOCK=function(){for(var e=t._BLOCK.count=t._readData.getUint16(),i=t._BLOCK.blockStarts=[],n=t._BLOCK.blockLengths=[],r=0;r<e;r++)i.push(t._readData.getUint32()),n.push(t._readData.getUint32())},t.READ_STRINGS=function(){var e=t._readData.getUint32(),i=t._readData.getUint16(),n=t._readData.pos;t._readData.pos=e+t._DATA.offset;for(var r=0;r<i;r++)t._strings[r]=t._readData.readUTFString();t._readData.pos=n},t.READ_MESH=function(){var e=(t._readString(),t._readData.__getBuffer()),i=0,n=0,r=t._readData.getInt16(),a=t._DATA.offset;for(i=0;i<r;i++){var s,o=a+t._readData.getUint32(),l=t._readData.getUint32(),h=new Float32Array(e.slice(o,o+l)),u=t._readString();switch(t._version){case"LAYAMODEL:03":s=t._vertexDeclarationMap_Discard[u];break;case"LAYAMODEL:0301":s=t._vertexDeclarationMap[u];break;default:throw new Error("LoadModelV03: unknown version.")}if(!s)throw new Error("LoadModelV03: unknown vertexDeclaration.");var _=Ki.create(s,4*h.length/s.vertexStride,35044,!0);_.setData(h),t._mesh._vertexBuffers.push(_)}var c=a+t._readData.getUint32(),d=t._readData.getUint32(),f=new Uint16Array(e.slice(c,c+d)),m=Zi.create("ushort",d/2,35044,!0);m.setData(f),t._mesh._indexBuffer=m;var p=t._mesh._boneNames=[],v=t._readData.getUint16();for(p.length=v,i=0;i<v;i++)p[i]=t._strings[t._readData.getUint16()];t._readData.pos+=8;var g=t._readData.getUint32(),E=t._readData.getUint32(),x=new Float32Array(e.slice(a+g,a+g+E));for(t._mesh._inverseBindPoses=[],i=0,n=x.length;i<n;i+=16){var T=new Ae(x[i+0],x[i+1],x[i+2],x[i+3],x[i+4],x[i+5],x[i+6],x[i+7],x[i+8],x[i+9],x[i+10],x[i+11],x[i+12],x[i+13],x[i+14],x[i+15]);t._mesh._inverseBindPoses.push(T)}return t._mesh._skinnedDatas=new Float32Array(16*x.length),!0},t.READ_SUBMESH=function(){var e=t._readData.__getBuffer(),i=new Fe(t._mesh),n=t._readData.getInt16(),r=t._readData.getUint32(),a=t._readData.getUint32();i._vertexBuffer=t._mesh._vertexBuffers[n],i._vertexStart=r,i._vertexCount=a;var s=t._readData.getUint32(),o=t._readData.getUint32(),l=t._mesh._indexBuffer;i._indexBuffer=l,i._indexStart=s,i._indexCount=o,i._indices=new Uint16Array(l.getData().buffer,2*s,o);var h=t._DATA.offset,u=i._subIndexBufferStart,_=i._subIndexBufferCount,c=i._boneIndicesList,d=t._readData.getUint16();u.length=d,_.length=d,c.length=d;for(var f=0;f<d;f++){u[f]=t._readData.getUint32(),_[f]=t._readData.getUint32();var m=t._readData.getUint32(),p=t._readData.getUint32();c[f]=new Uint8Array(e.slice(h+m,h+m+p))}return t._subMeshes.push(i),!0},t._strings=[],t._readData=null,t._version=null,t._mesh=null,t._subMeshes=null,t._materialMap=null,n(t,["_vertexDeclarationMap_Discard",function(){return this._vertexDeclarationMap_Discard={"POSITION,NORMAL,COLOR,UV,UV1,BLENDWEIGHT,BLENDINDICES,TANGENT":Gt.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,UV1,BLENDWEIGHT,BLENDINDICES":Ut.vertexDeclaration,"POSITION,NORMAL,TANGENT,BINORMAL,UV,UV1,BLENDWEIGHT,BLENDINDICES,":ue.vertexDeclaration,"POSITION,NORMAL,UV,UV1,BLENDWEIGHT,BLENDINDICES,TANGENT":ee.vertexDeclaration,"POSITION,NORMAL,UV,UV1,BLENDWEIGHT,BLENDINDICES":Jt.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,BLENDWEIGHT,BLENDINDICES,TANGENT":Yt.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,BLENDWEIGHT,BLENDINDICES":Wt.vertexDeclaration,"POSITION,NORMAL,UV,BLENDWEIGHT,BLENDINDICES,TANGENT":se.vertexDeclaration,"POSITION,NORMAL,UV,BLENDWEIGHT,BLENDINDICES":re.vertexDeclaration,"POSITION,NORMAL,COLOR,BLENDWEIGHT,BLENDINDICES,TANGENT":Lt.vertexDeclaration,"POSITION,NORMAL,COLOR,BLENDWEIGHT,BLENDINDICES":Nt.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,UV1,TANGENT":kt.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,UV1":Bt.vertexDeclaration,"POSITION,NORMAL,UV,UV1,TANGENT":ne.vertexDeclaration,"POSITION,NORMAL,UV,UV1":$t.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,TANGENT":Kt.vertexDeclaration,"POSITION,NORMAL,UV,TANGENT,BINORMAL":he.vertexDeclaration,"POSITION,NORMAL,COLOR,UV":Ft.vertexDeclaration,"POSITION,NORMAL,UV,TANGENT":le.vertexDeclaration,"POSITION,NORMAL,UV":Qt.vertexDeclaration,"POSITION,NORMAL,COLOR,TANGENT":Vt.vertexDeclaration,"POSITION,NORMAL,COLOR":wt.vertexDeclaration,"POSITION,NORMAL,TANGENT":qt.vertexDeclaration,"POSITION,NORMAL":bt.vertexDeclaration,"POSITION,UV":de.vertexDeclaration,POSITION:Ct.vertexDeclaration}},"_vertexDeclarationMap",function(){return this._vertexDeclarationMap={"POSITION,NORMAL,COLOR,UV,UV1,BLENDWEIGHT,BLENDINDICES,TANGENT":Ht.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,UV1,BLENDWEIGHT,BLENDINDICES":Ut.vertexDeclaration,"POSITION,NORMAL,TANGENT,BINORMAL,UV,UV1,BLENDWEIGHT,BLENDINDICES,":ue.vertexDeclaration,"POSITION,NORMAL,UV,UV1,BLENDWEIGHT,BLENDINDICES,TANGENT":te.vertexDeclaration,"POSITION,NORMAL,UV,UV1,BLENDWEIGHT,BLENDINDICES":Jt.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,BLENDWEIGHT,BLENDINDICES,TANGENT":Xt.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,BLENDWEIGHT,BLENDINDICES":Wt.vertexDeclaration,"POSITION,NORMAL,UV,BLENDWEIGHT,BLENDINDICES,TANGENT":ae.vertexDeclaration,"POSITION,NORMAL,UV,BLENDWEIGHT,BLENDINDICES":re.vertexDeclaration,"POSITION,NORMAL,COLOR,BLENDWEIGHT,BLENDINDICES,TANGENT":Pt.vertexDeclaration,"POSITION,NORMAL,COLOR,BLENDWEIGHT,BLENDINDICES":Nt.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,UV1,TANGENT":zt.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,UV1":Bt.vertexDeclaration,"POSITION,NORMAL,UV,UV1,TANGENT":ie.vertexDeclaration,"POSITION,NORMAL,UV,UV1":$t.vertexDeclaration,"POSITION,NORMAL,COLOR,UV,TANGENT":Zt.vertexDeclaration,"POSITION,NORMAL,UV,TANGENT,BINORMAL":he.vertexDeclaration,"POSITION,NORMAL,COLOR,UV":Ft.vertexDeclaration,"POSITION,NORMAL,UV,TANGENT":oe.vertexDeclaration,"POSITION,NORMAL,UV":Qt.vertexDeclaration,"POSITION,NORMAL,COLOR,TANGENT":Ot.vertexDeclaration,"POSITION,NORMAL,COLOR":wt.vertexDeclaration,"POSITION,NORMAL,TANGENT":jt.vertexDeclaration,"POSITION,NORMAL":bt.vertexDeclaration,"POSITION,UV":de.vertexDeclaration,POSITION:Ct.vertexDeclaration}},"_BLOCK",function(){return this._BLOCK={count:0}},"_DATA",function(){return this._DATA={offset:0,size:0}}]),t}(),Ee=function(){function t(){}return r(t,"laya.d3.loaders.MeshReader"),t.read=function(e,i,n,r,a){var s=new f(e);s.pos=0;var o=s.readUTFString();switch(o){case"LAYAMODEL:01":case"LAYASKINANI:01":t._readVersion01(s,o,i,n,r,a);break;case"LAYAMODEL:02":ve.parse(s,o,i,n,r,a);break;case"LAYAMODEL:03":case"LAYAMODEL:0301":ge.parse(s,o,i,r,a);break;default:throw new Error("MeshReader: unknown mesh version.")}i._setSubMeshes(r)},t._readVersion01=function(t,e,i,n,r,a){new pe(t,e,i,n,r,a)},t}(),xe=function(){function t(t,e){this.min=null,this.max=null,this.min=t,this.max=e}r(t,"laya.d3.math.BoundBox");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.getCorners=function(t){t.length=8;var e=this.min.elements,i=this.max.elements,n=e[0],r=e[1],a=e[2],s=i[0],o=i[1],l=i[2];t[0]=new Pe(n,o,l),t[1]=new Pe(s,o,l),t[2]=new Pe(s,r,l),t[3]=new Pe(n,r,l),t[4]=new Pe(n,o,a),t[5]=new Pe(s,o,a),t[6]=new Pe(s,r,a),t[7]=new Pe(n,r,a)},e.toDefault=function(){this.min.toDefault(),this.max.toDefault()},e.cloneTo=function(t){var e=t;this.min.cloneTo(e.min),this.max.cloneTo(e.max)},e.clone=function(){var t=new this.constructor(new Pe,new Pe);return this.cloneTo(t),t},t.createfromPoints=function(t,e){if(null==t)throw new Error("points");var i=e.min,n=e.max,r=i.elements;r[0]=Number.MAX_VALUE,r[1]=Number.MAX_VALUE,r[2]=Number.MAX_VALUE;var a=n.elements;a[0]=-Number.MAX_VALUE,a[1]=-Number.MAX_VALUE,a[2]=-Number.MAX_VALUE;for(var s=0,o=t.length;s<o;++s)Pe.min(i,t[s],i),Pe.max(n,t[s],n)},t.merge=function(t,e,i){Pe.min(t.min,e.min,i.min),Pe.max(t.max,e.max,i.max)},t}(),Te=function(){function t(e){this._matrix=null,this._near=null,this._far=null,this._left=null,this._right=null,this._top=null,this._bottom=null,this._matrix=e,this._near=new Re(new Pe),this._far=new Re(new Pe),this._left=new Re(new Pe),this._right=new Re(new Pe),this._top=new Re(new Pe),this._bottom=new Re(new Pe),t._getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom)}r(t,"laya.d3.math.BoundFrustum");var e=t.prototype;return e.equalsBoundFrustum=function(t){return this._matrix.equalsOtherMatrix(t.matrix)},e.equalsObj=function(t){if(t instanceof laya.d3.math.BoundFrustum){var e=t;return this.equalsBoundFrustum(e)}return!1},e.getPlane=function(t){switch(t){case 0:return this._near;case 1:return this._far;case 2:return this._left;case 3:return this._right;case 4:return this._top;case 5:return this._bottom;default:return null}},e.getCorners=function(e){t._get3PlaneInterPoint(this._near,this._bottom,this._right).cloneTo(e[0]),t._get3PlaneInterPoint(this._near,this._top,this._right).cloneTo(e[1]),t._get3PlaneInterPoint(this._near,this._top,this._left).cloneTo(e[2]),t._get3PlaneInterPoint(this._near,this._bottom,this._left).cloneTo(e[3]),t._get3PlaneInterPoint(this._far,this._bottom,this._right).cloneTo(e[4]),t._get3PlaneInterPoint(this._far,this._top,this._right).cloneTo(e[5]),t._get3PlaneInterPoint(this._far,this._top,this._left).cloneTo(e[6]),t._get3PlaneInterPoint(this._far,this._bottom,this._left).cloneTo(e[7])},e.containsPoint=function(t){for(var e=Re.PlaneIntersectionType_Front,i=Re.PlaneIntersectionType_Front,n=0;n<6;n++){switch(n){case 0:i=De.intersectsPlaneAndPoint(this._near,t);break;case 1:i=De.intersectsPlaneAndPoint(this._far,t);break;case 2:i=De.intersectsPlaneAndPoint(this._left,t);break;case 3:i=De.intersectsPlaneAndPoint(this._right,t);break;case 4:i=De.intersectsPlaneAndPoint(this._top,t);break;case 5:i=De.intersectsPlaneAndPoint(this._bottom,t)}switch(i){case Re.PlaneIntersectionType_Back:return 0;case Re.PlaneIntersectionType_Intersecting:e=Re.PlaneIntersectionType_Intersecting}}switch(e){case Re.PlaneIntersectionType_Intersecting:return 2;default:return 1}},e.containsBoundBox=function(e){for(var i,n=t._tempV30,r=t._tempV31,a=1,s=0;s<6;s++){if(i=this.getPlane(s),this._getBoxToPlanePVertexNVertex(e,i.normal,n,r),De.intersectsPlaneAndPoint(i,n)===Re.PlaneIntersectionType_Back)return 0;De.intersectsPlaneAndPoint(i,r)===Re.PlaneIntersectionType_Back&&(a=2)}return a},e.containsBoundSphere=function(t){for(var e=Re.PlaneIntersectionType_Front,i=Re.PlaneIntersectionType_Front,n=0;n<6;n++){switch(n){case 0:i=De.intersectsPlaneAndSphere(this._near,t);break;case 1:i=De.intersectsPlaneAndSphere(this._far,t);break;case 2:i=De.intersectsPlaneAndSphere(this._left,t);break;case 3:i=De.intersectsPlaneAndSphere(this._right,t);break;case 4:i=De.intersectsPlaneAndSphere(this._top,t);break;case 5:i=De.intersectsPlaneAndSphere(this._bottom,t)}switch(i){case Re.PlaneIntersectionType_Back:return 0;case Re.PlaneIntersectionType_Intersecting:e=Re.PlaneIntersectionType_Intersecting}}switch(e){case Re.PlaneIntersectionType_Intersecting:return 2;default:return 1}},e._getBoxToPlanePVertexNVertex=function(t,e,i,n){var r=t.min,a=r.elements,s=t.max,o=s.elements,l=e.elements,h=l[0],u=l[1],_=l[2];r.cloneTo(i);var c=i.elements;h>=0&&(c[0]=o[0]),u>=0&&(c[1]=o[1]),_>=0&&(c[2]=o[2]),s.cloneTo(n);var d=n.elements;h>=0&&(d[0]=a[0]),u>=0&&(d[1]=a[1]),_>=0&&(d[2]=a[2])},a(0,e,"top",function(){return this._top}),a(0,e,"matrix",function(){return this._matrix},function(e){this._matrix=e,t._getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom)}),a(0,e,"near",function(){return this._near}),a(0,e,"far",function(){return this._far}),a(0,e,"left",function(){return this._left}),a(0,e,"right",function(){return this._right}),a(0,e,"bottom",function(){return this._bottom}),t._getPlanesFromMatrix=function(t,e,i,n,r,a,s){var o=t.elements,l=o[0],h=o[1],u=o[2],_=o[3],c=o[4],d=o[5],f=o[6],m=o[7],p=o[8],v=o[9],g=o[10],E=o[11],x=o[12],T=o[13],S=o[14],D=o[15],M=e.normal.elements;M[0]=_+u,M[1]=m+f,M[2]=E+g,e.distance=D+S,e.normalize();var y=i.normal.elements;y[0]=_-u,y[1]=m-f,y[2]=E-g,i.distance=D-S,i.normalize();var A=n.normal.elements;A[0]=_+l,A[1]=m+c,A[2]=E+p,n.distance=D+x,n.normalize();var I=r.normal.elements;I[0]=_-l,I[1]=m-c,I[2]=E-p,r.distance=D-x,r.normalize();var R=a.normal.elements;R[0]=_-h,R[1]=m-d,R[2]=E-v,a.distance=D-T,a.normalize();var C=s.normal.elements;C[0]=_+h,C[1]=m+d,C[2]=E+v,s.distance=D+T,s.normalize()},t._get3PlaneInterPoint=function(e,i,n){var r=e.normal,a=i.normal,s=n.normal;Pe.cross(a,s,t._tempV30),Pe.cross(s,r,t._tempV31),Pe.cross(r,a,t._tempV32);var o=Pe.dot(r,t._tempV30),l=Pe.dot(a,t._tempV31),h=Pe.dot(s,t._tempV32);return Pe.scale(t._tempV30,-e.distance/o,t._tempV33),Pe.scale(t._tempV31,-i.distance/l,t._tempV34),Pe.scale(t._tempV32,-n.distance/h,t._tempV35),Pe.add(t._tempV33,t._tempV34,t._tempV36),Pe.add(t._tempV35,t._tempV36,t._tempV37),t._tempV37},n(t,["_tempV30",function(){return this._tempV30=new Pe},"_tempV31",function(){return this._tempV31=new Pe},"_tempV32",function(){return this._tempV32=new Pe},"_tempV33",function(){return this._tempV33=new Pe},"_tempV34",function(){return this._tempV34=new Pe},"_tempV35",function(){return this._tempV35=new Pe},"_tempV36",function(){return this._tempV36=new Pe},"_tempV37",function(){return this._tempV37=new Pe}]),t}(),Se=function(){function t(t,e){this.center=null,this.radius=NaN,this.center=t,this.radius=e}r(t,"laya.d3.math.BoundSphere");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.toDefault=function(){this.center.toDefault(),this.radius=0},e.intersectsRayDistance=function(t){return De.intersectsRayAndSphereRD(t,this)},e.intersectsRayPoint=function(t,e){return De.intersectsRayAndSphereRP(t,this,e)},e.cloneTo=function(t){var e=t;this.center.cloneTo(e.center),e.radius=this.radius},e.clone=function(){var t=new this.constructor(new Pe,new Pe);return this.cloneTo(t),t},t.createFromSubPoints=function(e,i,n,r){if(null==e)throw new Error("points");if(i<0||i>=e.length)throw new Error("start"+i+"Must be in the range [0, "+(e.length-1)+"]");if(n<0||i+n>e.length)throw new Error("count"+n+"Must be in the range <= "+e.length+"}");var a=i+n,s=t._tempVector3;s.elements[0]=0,s.elements[1]=0,s.elements[2]=0;for(var o=i;o<a;++o)Pe.add(e[o],s,s);var l=r.center;Pe.scale(s,1/n,l);var h=0;for(o=i;o<a;++o){var u=Pe.distanceSquared(l,e[o]);u>h&&(h=u)}r.radius=Math.sqrt(h)},t.createfromPoints=function(e,i){if(null==e)throw new Error("points");t.createFromSubPoints(e,0,e.length,i)},n(t,["_tempVector3",function(){return this._tempVector3=new Pe}]),t}(),De=function(){function t(){}return r(t,"laya.d3.math.Collision"),t.distancePlaneToPoint=function(t,e){return Pe.dot(t.normal,e)-t.distance},t.distanceBoxToPoint=function(t,e){var i=t.min.elements,n=i[0],r=i[1],a=i[2],s=t.max.elements,o=s[0],l=s[1],h=s[2],u=e.elements,_=u[0],c=u[1],d=u[2],f=0;return _<n&&(f+=(n-_)*(n-_)),_>o&&(f+=(o-_)*(o-_)),c<r&&(f+=(r-c)*(r-c)),c>l&&(f+=(l-c)*(l-c)),d<a&&(f+=(a-d)*(a-d)),d>h&&(f+=(h-d)*(h-d)),Math.sqrt(f)},t.distanceBoxToBox=function(t,e){var i=t.min.elements,n=i[0],r=i[1],a=i[2],s=t.max.elements,o=s[0],l=s[1],h=s[2],u=e.min.elements,_=u[0],c=u[1],d=u[2],f=e.max.elements,m=f[0],p=f[1],v=f[2],g=0,E=NaN;return n>m?(E=n-m,g+=E*E):_>o&&(E=_-o,g+=E*E),r>p?(E=r-p,g+=E*E):c>l&&(E=c-l,g+=E*E),a>v?(E=a-v,g+=E*E):d>h&&(E=d-h,g+=E*E),Math.sqrt(g)},t.distanceSphereToPoint=function(t,e){var i=Math.sqrt(Pe.distanceSquared(t.center,e));return i-=t.radius,Math.max(i,0)},t.distanceSphereToSphere=function(t,e){var i=Math.sqrt(Pe.distanceSquared(t.center,e.center));return i-=t.radius+e.radius,Math.max(i,0)},t.intersectsRayAndTriangleRD=function(e,i,n,r,a){var s=e.origin,o=s.elements,l=o[0],h=o[1],u=o[2],_=e.direction,c=_.elements,d=c[0],f=c[1],m=c[2],p=i.elements,v=p[0],g=p[1],E=p[2],x=n.elements,T=x[0],S=x[1],D=x[2],M=r.elements,y=M[0],A=M[1],I=M[2],R=t._tempV30.elements,C=R[0],b=R[1],w=R[2];C=T-v,b=S-g,w=D-E;var N=t._tempV31.elements,P=N[0],L=N[1],O=N[2];P=y-v,L=A-g,O=I-E;var V=t._tempV32.elements,F=V[0],B=V[1],U=V[2];F=f*O-m*L,B=m*P-d*O,U=d*L-f*P;var H=C*F+b*B+w*U;if(Me.isZero(H))return 0,!1;var G=1/H,z=t._tempV33.elements,k=z[0],W=z[1],X=z[2];k=l-v,W=h-g,X=u-E;var Y=k*F+W*B+X*U;if((Y*=G)<0||Y>1)return 0,!1;var Z=t._tempV34.elements,K=Z[0],j=Z[1],q=Z[2];K=W*w-X*b,j=X*C-k*w,q=k*b-W*C;var Q=d*K+f*j+m*q;if((Q*=G)<0||Y+Q>1)return 0,!1;var $=P*K+L*j+O*q;return($*=G)<0?(0,!1):($,!0)},t.intersectsRayAndTriangleRP=function(e,i,n,r,a){return t.intersectsRayAndTriangleRD(e,i,n,r,NaN)?(Pe.scale(e.direction,NaN,t._tempV30),Pe.add(e.origin,t._tempV30,a),!0):(a=Pe.ZERO,!1)},t.intersectsRayAndPoint=function(e,i){Pe.subtract(e.origin,i,t._tempV30);var n=Pe.dot(t._tempV30,e.direction),r=Pe.dot(t._tempV30,t._tempV30)-Me.zeroTolerance;return!(r>0&&n>0)&&!(n*n-r<0)},t.intersectsRayAndRay=function(e,i,n){var r=e.origin,a=r.elements,s=a[0],o=a[1],l=a[2],h=e.direction,u=h.elements,_=u[0],c=u[1],d=u[2],f=i.origin,m=f.elements,p=m[0],v=m[1],g=m[2],E=i.direction,x=E.elements,T=x[0],S=x[1],D=x[2];Pe.cross(h,E,t._tempV30);var M=t._tempV30.elements,y=Pe.scalarLength(t._tempV30);if(Me.isZero(y)&&Me.nearEqual(p,s)&&Me.nearEqual(v,o)&&Me.nearEqual(g,l))return Pe.ZERO,!0;y*=y;var A=p-s,I=v-o,R=g-l,C=T,b=S,w=D,N=M[0],P=M[1],L=M[2],O=A*b*L+I*w*N+R*C*P-A*w*P-I*C*L-R*b*N;C=_,b=c,w=d;var V=O/y;Pe.scale(h,V,t._tempV30),Pe.scale(E,V,t._tempV31),Pe.add(r,t._tempV30,t._tempV32),Pe.add(f,t._tempV31,t._tempV33);var F=t._tempV32.elements,B=t._tempV33.elements;return Me.nearEqual(B[0],F[0])&&Me.nearEqual(B[1],F[1])&&Me.nearEqual(B[2],F[2])?(t._tempV32,!0):(Pe.ZERO,!1)},t.intersectsPlaneAndTriangle=function(e,i,n,r){var a=t.intersectsPlaneAndPoint(e,i),s=t.intersectsPlaneAndPoint(e,n),o=t.intersectsPlaneAndPoint(e,r);return a==Re.PlaneIntersectionType_Front&&s==Re.PlaneIntersectionType_Front&&o==Re.PlaneIntersectionType_Front?Re.PlaneIntersectionType_Front:a==Re.PlaneIntersectionType_Back&&s==Re.PlaneIntersectionType_Back&&o==Re.PlaneIntersectionType_Back?Re.PlaneIntersectionType_Back:Re.PlaneIntersectionType_Intersecting},t.intersectsRayAndPlaneRD=function(t,e,i){var n=e.normal,r=Pe.dot(n,t.direction);if(Me.isZero(r))return 0,!1;var a=Pe.dot(n,t.origin);return!((-e.distance-a)/r<0)||(0,!1)},t.intersectsRayAndPlaneRP=function(e,i,n){return t.intersectsRayAndPlaneRD(e,i,NaN)?(Pe.scale(e.direction,NaN,t._tempV30),Pe.add(e.origin,t._tempV30,t._tempV31),t._tempV31,!0):(Pe.ZERO,!1)},t.intersectsRayAndBoxRD=function(t,e){var i=t.origin.elements,n=i[0],r=i[1],a=i[2],s=t.direction.elements,o=s[0],l=s[1],h=s[2],u=e.min.elements,_=u[0],c=u[1],d=u[2],f=e.max.elements,m=f[0],p=f[1],v=f[2],g=0,E=Me.MaxValue;if(Me.isZero(o)){if(n<_||n>m)return-1}else{var x=1/o,T=(_-n)*x,S=(m-n)*x;if(T>S){var D=T;T=S,S=D}if(g=Math.max(T,g),E=Math.min(S,E),g>E)return-1}if(Me.isZero(l)){if(r<c||r>p)return-1}else{var M=1/l,y=(c-r)*M,A=(p-r)*M;if(y>A){var I=y;y=A,A=I}if(g=Math.max(y,g),E=Math.min(A,E),g>E)return-1}if(Me.isZero(h)){if(a<d||a>v)return-1}else{var R=1/h,C=(d-a)*R,b=(v-a)*R;if(C>b){var w=C;C=b,b=w}if(g=Math.max(C,g),E=Math.min(b,E),g>E)return-1}return g},t.intersectsRayAndBoxRP=function(e,i,n){var r=t.intersectsRayAndBoxRD(e,i);return-1===r?(Pe.ZERO.cloneTo(n),r):(Pe.scale(e.direction,r,t._tempV30),Pe.add(e.origin,t._tempV30,t._tempV31),t._tempV31.cloneTo(n),r)},t.intersectsRayAndSphereRD=function(e,i){var n=i.radius;Pe.subtract(e.origin,i.center,t._tempV30);var r=Pe.dot(t._tempV30,e.direction),a=Pe.dot(t._tempV30,t._tempV30)-n*n;if(a>0&&r>0)return-1;var s=r*r-a;if(s<0)return-1;var o=-r-Math.sqrt(s);return o<0&&(o=0),o},t.intersectsRayAndSphereRP=function(e,i,n){var r=t.intersectsRayAndSphereRD(e,i);return-1===r?(Pe.ZERO.cloneTo(n),r):(Pe.scale(e.direction,r,t._tempV30),Pe.add(e.origin,t._tempV30,t._tempV31),t._tempV31.cloneTo(n),r)},t.intersectsSphereAndTriangle=function(e,i,n,r){var a=e.center,s=e.radius;return t.closestPointPointTriangle(a,i,n,r,t._tempV30),Pe.subtract(t._tempV30,a,t._tempV31),Pe.dot(t._tempV31,t._tempV31)<=s*s},t.intersectsPlaneAndPoint=function(t,e){var i=Pe.dot(t.normal,e)+t.distance;return i>0?Re.PlaneIntersectionType_Front:i<0?Re.PlaneIntersectionType_Back:Re.PlaneIntersectionType_Intersecting},t.intersectsPlaneAndPlane=function(e,i){Pe.cross(e.normal,i.normal,t._tempV30);var n=Pe.dot(t._tempV30,t._tempV30);return!Me.isZero(n)},t.intersectsPlaneAndPlaneRL=function(e,i,n){var r=e.normal,a=i.normal;Pe.cross(r,a,t._tempV34);var s=Pe.dot(t._tempV34,t._tempV34);return!Me.isZero(s)&&(Pe.scale(a,e.distance,t._tempV30),Pe.scale(r,i.distance,t._tempV31),Pe.subtract(t._tempV30,t._tempV31,t._tempV32),Pe.cross(t._tempV32,t._tempV34,t._tempV33),Pe.normalize(t._tempV34,t._tempV34),new we(t._tempV33,t._tempV34),!0)},t.intersectsPlaneAndBox=function(e,i){var n=e.distance,r=e.normal,a=r.elements,s=a[0],o=a[1],l=a[2],h=i.min.elements,u=h[0],_=h[1],c=h[2],d=i.max.elements,f=d[0],m=d[1],p=d[2];t._tempV30.elements[0]=s>0?u:f,t._tempV30.elements[1]=o>0?_:m,t._tempV30.elements[2]=l>0?c:p,t._tempV31.elements[0]=s>0?f:u,t._tempV31.elements[1]=o>0?m:_,t._tempV31.elements[2]=l>0?p:c;var v=Pe.dot(r,t._tempV30);return v+n>0?Re.PlaneIntersectionType_Front:(v=Pe.dot(r,t._tempV31),v+n<0?Re.PlaneIntersectionType_Back:Re.PlaneIntersectionType_Intersecting)},t.intersectsPlaneAndSphere=function(t,e){var i=e.radius,n=Pe.dot(t.normal,e.center)+t.distance;return n>i?Re.PlaneIntersectionType_Front:n<-i?Re.PlaneIntersectionType_Back:Re.PlaneIntersectionType_Intersecting},t.intersectsBoxAndBox=function(t,e){var i=t.min.elements,n=t.max.elements,r=e.min.elements,a=e.max.elements;return!(i[0]>a[0]||r[0]>n[0])&&(!(i[1]>a[1]||r[1]>n[1])&&!(i[2]>a[2]||r[2]>n[2]))},t.intersectsBoxAndSphere=function(e,i){var n=i.center,r=i.radius;return Pe.Clamp(n,e.min,e.max,t._tempV30),Pe.distanceSquared(n,t._tempV30)<=r*r},t.intersectsSphereAndSphere=function(t,e){var i=t.radius+e.radius;return Pe.distanceSquared(t.center,e.center)<=i*i},t.boxContainsPoint=function(t,e){var i=t.min.elements,n=t.max.elements,r=e.elements;return i[0]<=r[0]&&n[0]>=r[0]&&i[1]<=r[1]&&n[1]>=r[1]&&i[2]<=r[2]&&n[2]>=r[2]?1:0},t.boxContainsBox=function(t,e){var i=t.min.elements,n=i[0],r=i[1],a=i[2],s=t.max.elements,o=s[0],l=s[1],h=s[2],u=e.min.elements,_=u[0],c=u[1],d=u[2],f=e.max.elements,m=f[0],p=f[1],v=f[2];return o<_||n>m?0:l<c||r>p?0:h<d||a>v?0:n<=_&&m<=m&&r<=c&&p<=l&&a<=d&&v<=h?1:2},t.boxContainsSphere=function(e,i){var n=e.min,r=n.elements,a=r[0],s=r[1],o=r[2],l=e.max,h=l.elements,u=h[0],_=h[1],c=h[2],d=i.center,f=d.elements,m=f[0],p=f[1],v=f[2],g=i.radius;return Pe.Clamp(d,n,l,t._tempV30),Pe.distanceSquared(d,t._tempV30)>g*g?0:a+g<=m&&m<=u-g&&u-a>g&&s+g<=p&&p<=_-g&&_-s>g&&o+g<=v&&v<=c-g&&c-o>g?1:2},t.sphereContainsPoint=function(t,e){return Pe.distanceSquared(e,t.center)<=t.radius*t.radius?1:0},t.sphereContainsTriangle=function(e,i,n,r){var a=t.sphereContainsPoint(e,i),s=t.sphereContainsPoint(e,n),o=t.sphereContainsPoint(e,r);return 1==a&&1==s&&1==o?1:t.intersectsSphereAndTriangle(e,i,n,r)?2:0},t.sphereContainsBox=function(e,i){var n=e.center,r=n.elements,a=r[0],s=r[1],o=r[2],l=e.radius,h=i.min,u=h.elements,_=u[0],c=u[1],d=u[2],f=i.max,m=f.elements,p=m[0],v=m[1],g=m[2],E=t._tempV30.elements;E[0],E[1],E[2];if(!t.intersectsBoxAndSphere(i,e))return 0;var x=l*l;return a-_,s-v,o-g,Pe.scalarLengthSquared(t._tempV30)>x?2:(a-p,s-v,o-g,Pe.scalarLengthSquared(t._tempV30)>x?2:(a-p,s-c,o-g,Pe.scalarLengthSquared(t._tempV30)>x?2:(a-_,s-c,o-g,Pe.scalarLengthSquared(t._tempV30)>x?2:(a-_,s-v,o-d,Pe.scalarLengthSquared(t._tempV30)>x?2:(a-p,s-v,o-d,Pe.scalarLengthSquared(t._tempV30)>x?2:(a-p,s-c,o-d,Pe.scalarLengthSquared(t._tempV30)>x?2:(a-_,s-c,o-d,Pe.scalarLengthSquared(t._tempV30)>x?2:1)))))))},t.sphereContainsSphere=function(t,e){var i=t.radius,n=e.radius,r=Pe.distance(t.center,e.center);return i+n<r?0:i-n<r?2:1},t.closestPointPointTriangle=function(e,i,n,r,a){Pe.subtract(n,i,t._tempV30),Pe.subtract(r,i,t._tempV31),Pe.subtract(e,i,t._tempV32),Pe.subtract(e,n,t._tempV33),Pe.subtract(e,r,t._tempV34);var s=Pe.dot(t._tempV30,t._tempV32),o=Pe.dot(t._tempV31,t._tempV32),l=Pe.dot(t._tempV30,t._tempV33),h=Pe.dot(t._tempV31,t._tempV33),u=Pe.dot(t._tempV30,t._tempV34),_=Pe.dot(t._tempV31,t._tempV34);if(s<=0&&o<=0)return void i.cloneTo(a);if(l>=0&&h<=l)return void n.cloneTo(a);var c=s*h-l*o;if(c<=0&&s>=0&&l<=0){var d=s/(s-l);return Pe.scale(t._tempV30,d,a),void Pe.add(i,a,a)}if(_>=0&&u<=_)return void r.cloneTo(a);var f=u*o-s*_;if(f<=0&&o>=0&&_<=0){var m=o/(o-_);return Pe.scale(t._tempV31,m,a),void Pe.add(i,a,a)}var p=l*_-u*h;if(p<=0&&h-l>=0&&u-_>=0){var v=(h-l)/(h-l+(u-_));return Pe.subtract(r,n,a),Pe.scale(a,v,a),void Pe.add(n,a,a)}var g=1/(p+f+c),E=f*g,x=c*g;Pe.scale(t._tempV30,E,t._tempV35),Pe.scale(t._tempV31,x,t._tempV36),Pe.add(t._tempV35,t._tempV36,a),Pe.add(i,a,a)},t.closestPointPlanePoint=function(e,i,n){var r=e.normal,a=Pe.dot(r,i)-e.distance;Pe.scale(r,a,t._tempV30),Pe.subtract(i,t._tempV30,n)},t.closestPointBoxPoint=function(e,i,n){Pe.max(i,e.min,t._tempV30),Pe.min(t._tempV30,e.max,n)},t.closestPointSpherePoint=function(t,e,i){var n=t.center;Pe.subtract(e,n,i),Pe.normalize(i,i),Pe.scale(i,t.radius,i),Pe.add(i,n,i)},t.closestPointSphereSphere=function(t,e,i){var n=t.center;Pe.subtract(e.center,n,i),Pe.normalize(i,i),Pe.scale(i,t.radius,i),Pe.add(i,n,i)},n(t,["_tempV30",function(){return this._tempV30=new Pe},"_tempV31",function(){return this._tempV31=new Pe},"_tempV32",function(){return this._tempV32=new Pe},"_tempV33",function(){return this._tempV33=new Pe},"_tempV34",function(){return this._tempV34=new Pe},"_tempV35",function(){return this._tempV35=new Pe},"_tempV36",function(){return this._tempV36=new Pe}]),t}(),Me=(function(){function t(){}r(t,"laya.d3.math.ContainmentType"),t.Disjoint=0,t.Contains=1,t.Intersects=2}(),function(){function t(){}return r(t,"laya.d3.math.MathUtils3D"),t.isZero=function(e){return Math.abs(e)<t.zeroTolerance},t.nearEqual=function(e,i){return!!t.isZero(e-i)},t.fastInvSqrt=function(e){return t.isZero(e)?e:1/Math.sqrt(e)},n(t,["zeroTolerance",function(){return this.zeroTolerance=1e-6},"MaxValue",function(){return this.MaxValue=3.40282347e38},"MinValue",function(){return this.MinValue=-3.40282347e38}]),t}()),ye=function(){function t(){var t=this.elements=new Float32Array(9);t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1}r(t,"laya.d3.math.Matrix3x3");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.determinant=function(){var t=this.elements,e=t[0],i=t[1],n=t[2],r=t[3],a=t[4],s=t[5],o=t[6],l=t[7],h=t[8];return e*(h*a-s*l)+i*(-h*r+s*o)+n*(l*r-a*o)},e.translate=function(t,e){var i=e.elements,n=this.elements,r=t.elements,a=n[0],s=n[1],o=n[2],l=n[3],h=n[4],u=n[5],_=n[6],c=n[7],d=n[8],f=r[0],m=r[1];i[0]=a,i[1]=s,i[2]=o,i[3]=l,i[4]=h,i[5]=u,i[6]=f*a+m*l+_,i[7]=f*s+m*h+c,i[8]=f*o+m*u+d},e.rotate=function(t,e){var i=e.elements,n=this.elements,r=n[0],a=n[1],s=n[2],o=n[3],l=n[4],h=n[5],u=n[6],_=n[7],c=n[8],d=Math.sin(t),f=Math.cos(t);i[0]=f*r+d*o,i[1]=f*a+d*l,i[2]=f*s+d*h,i[3]=f*o-d*r,i[4]=f*l-d*a,i[5]=f*h-d*s,i[6]=u,i[7]=_,i[8]=c},e.scale=function(t,e){var i=e.elements,n=this.elements,r=t.elements,a=r[0],s=r[1];i[0]=a*n[0],i[1]=a*n[1],i[2]=a*n[2],i[3]=s*n[3],i[4]=s*n[4],i[5]=s*n[5],i[6]=n[6],i[7]=n[7],i[8]=n[8]},e.invert=function(t){var e=t.elements,i=this.elements,n=i[0],r=i[1],a=i[2],s=i[3],o=i[4],l=i[5],h=i[6],u=i[7],_=i[8],c=_*o-l*u,d=-_*s+l*h,f=u*s-o*h,m=n*c+r*d+a*f;m||(t=null),m=1/m,e[0]=c*m,e[1]=(-_*r+a*u)*m,e[2]=(l*r-a*o)*m,e[3]=d*m,e[4]=(_*n-a*h)*m,e[5]=(-l*n+a*s)*m,e[6]=f*m,e[7]=(-u*n+r*h)*m,e[8]=(o*n-r*s)*m},e.transpose=function(t){var e=t.elements,i=this.elements;if(t===this){var n=i[1],r=i[2],a=i[5];e[1]=i[3],e[2]=i[6],e[3]=n,e[5]=i[7],e[6]=r,e[7]=a}else e[0]=i[0],e[1]=i[3],e[2]=i[6],e[3]=i[1],e[4]=i[4],e[5]=i[7],e[6]=i[2],e[7]=i[5],e[8]=i[8]},e.identity=function(){var t=this.elements;t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1},e.cloneTo=function(t){var e,i,n;if(i=this.elements,n=t.elements,i!==n)for(e=0;e<9;++e)n[e]=i[e]},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},t.createFromTranslation=function(t,e){var i=(e.elements,t.elements);e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=i[0],e[7]=i[1],e[8]=1},t.createFromRotation=function(t,e){var i=e.elements,n=Math.sin(t),r=Math.cos(t);i[0]=r,i[1]=n,i[2]=0,i[3]=-n,i[4]=r,i[5]=0,i[6]=0,i[7]=0,i[8]=1},t.createFromScaling=function(t,e){var i=e.elements,n=t.elements;i[0]=n[0],i[1]=0,i[2]=0,i[3]=0,i[4]=n[1],i[5]=0,i[6]=0,i[7]=0,i[8]=1},t.createFromMatrix4x4=function(t,e){e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10]},t.multiply=function(t,e,i){var n=i.elements,r=t.elements,a=e.elements,s=r[0],o=r[1],l=r[2],h=r[3],u=r[4],_=r[5],c=r[6],d=r[7],f=r[8],m=a[0],p=a[1],v=a[2],g=a[3],E=a[4],x=a[5],T=a[6],S=a[7],D=a[8];n[0]=m*s+p*h+v*c,n[1]=m*o+p*u+v*d,n[2]=m*l+p*_+v*f,n[3]=g*s+E*h+x*c,n[4]=g*o+E*u+x*d,n[5]=g*l+E*_+x*f,n[6]=T*s+S*h+D*c,n[7]=T*o+S*u+D*d,n[8]=T*l+S*_+D*f},t.lookAt=function(e,i,n,r){Pe.subtract(e,i,t._tempV30),Pe.normalize(t._tempV30,t._tempV30),Pe.cross(n,t._tempV30,t._tempV31),Pe.normalize(t._tempV31,t._tempV31),Pe.cross(t._tempV30,t._tempV31,t._tempV32);var a=t._tempV30.elements,s=t._tempV31.elements,o=t._tempV32.elements,l=r.elements;l[0]=s[0],l[3]=s[1],l[6]=s[2],l[1]=o[0],l[4]=o[1],l[7]=o[2],l[2]=a[0],l[5]=a[1],l[8]=a[2]},n(t,["DEFAULT",function(){return this.DEFAULT=new t},"_tempV30",function(){return this._tempV30=new Pe},"_tempV31",function(){return this._tempV31=new Pe},"_tempV32",function(){return this._tempV32=new Pe}]),t}(),Ae=function(){function t(t,e,i,n,r,a,s,o,l,h,u,_,c,d,f,m){void 0===t&&(t=1),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=0),void 0===a&&(a=1),void 0===s&&(s=0),void 0===o&&(o=0),void 0===l&&(l=0),void 0===h&&(h=0),void 0===u&&(u=1),void 0===_&&(_=0),void 0===c&&(c=0),void 0===d&&(d=0),void 0===f&&(f=0),void 0===m&&(m=1);var p=this.elements=new Float32Array(16);p[0]=t,p[1]=e,p[2]=i,p[3]=n,p[4]=r,p[5]=a,p[6]=s,p[7]=o,p[8]=l,p[9]=h,p[10]=u,p[11]=_,p[12]=c,p[13]=d,p[14]=f,p[15]=m}r(t,"laya.d3.math.Matrix4x4");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.getElementByRowColumn=function(t,e){if(t<0||t>3)throw new Error("row","Rows and columns for matrices run from 0 to 3, inclusive.");if(e<0||e>3)throw new Error("column","Rows and columns for matrices run from 0 to 3, inclusive.");return this.elements[4*t+e]},e.setElementByRowColumn=function(t,e,i){if(t<0||t>3)throw new Error("row","Rows and columns for matrices run from 0 to 3, inclusive.");if(e<0||e>3)throw new Error("column","Rows and columns for matrices run from 0 to 3, inclusive.");this.elements[4*t+e]=i},e.equalsOtherMatrix=function(t){var e=this.elements,i=t.elements;return Me.nearEqual(e[0],i[0])&&Me.nearEqual(e[1],i[1])&&Me.nearEqual(e[2],i[2])&&Me.nearEqual(e[3],i[3])&&Me.nearEqual(e[4],i[4])&&Me.nearEqual(e[5],i[5])&&Me.nearEqual(e[6],i[6])&&Me.nearEqual(e[7],i[7])&&Me.nearEqual(e[8],i[8])&&Me.nearEqual(e[9],i[9])&&Me.nearEqual(e[10],i[10])&&Me.nearEqual(e[11],i[11])&&Me.nearEqual(e[12],i[12])&&Me.nearEqual(e[13],i[13])&&Me.nearEqual(e[14],i[14])&&Me.nearEqual(e[15],i[15])},e.decomposeTransRotScale=function(e,i,n){var r=t._tempMatrix4x4;return this.decomposeTransRotMatScale(e,r,n)?(Ce.createFromMatrix4x4(r,i),!0):(i.identity(),!1)},e.decomposeTransRotMatScale=function(e,i,n){var r=this.elements,a=e.elements,s=i.elements,o=n.elements;a[0]=r[12],a[1]=r[13],a[2]=r[14];var l=r[0],h=r[1],u=r[2],_=r[4],c=r[5],d=r[6],f=r[8],m=r[9],p=r[10],v=o[0]=Math.sqrt(l*l+h*h+u*u),g=o[1]=Math.sqrt(_*_+c*c+d*d),E=o[2]=Math.sqrt(f*f+m*m+p*p);if(Me.isZero(v)||Me.isZero(g)||Me.isZero(E))return s[1]=s[2]=s[3]=s[4]=s[6]=s[7]=s[8]=s[9]=s[11]=s[12]=s[13]=s[14]=0,s[0]=s[5]=s[10]=s[15]=1,!1;var x=t._tempVector0,T=x.elements;T[0]=f/E,T[1]=m/E,T[2]=p/E;var S=t._tempVector1,D=S.elements;D[0]=l/v,D[1]=h/v,D[2]=u/v;var M=t._tempVector2;Pe.cross(x,S,M);var y=t._tempVector1;return Pe.cross(M,x,y),s[3]=s[7]=s[11]=s[12]=s[13]=s[14]=0,s[15]=1,s[0]=y.x,s[1]=y.y,s[2]=y.z,s[4]=M.x,s[5]=M.y,s[6]=M.z,s[8]=x.x,s[9]=x.y,s[10]=x.z,s[0]*l+s[1]*h+s[2]*u<0&&(o[0]=-v),s[4]*_+s[5]*c+s[6]*d<0&&(o[1]=-g),s[8]*f+s[9]*m+s[10]*p<0&&(o[2]=-E),!0},e.decomposeYawPitchRoll=function(t){var e=t.elements,i=Math.asin(-this.elements[9]);e[1]=i,Math.cos(i)>Me.zeroTolerance?(e[2]=Math.atan2(this.elements[1],this.elements[5]),e[0]=Math.atan2(this.elements[8],this.elements[10])):(e[2]=Math.atan2(-this.elements[4],this.elements[0]),e[0]=0)},e.normalize=function(){var t=this.elements,e=t[0],i=t[1],n=t[2],r=Math.sqrt(e*e+i*i+n*n);if(!r)return t[0]=0,t[1]=0,void(t[2]=0);1!=r&&(r=1/r,t[0]=e*r,t[1]=i*r,t[2]=n*r)},e.transpose=function(){var t,e;return t=this.elements,e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this},e.invert=function(t){var e=this.elements,i=t.elements,n=e[0],r=e[1],a=e[2],s=e[3],o=e[4],l=e[5],h=e[6],u=e[7],_=e[8],c=e[9],d=e[10],f=e[11],m=e[12],p=e[13],v=e[14],g=e[15],E=n*l-r*o,x=n*h-a*o,T=n*u-s*o,S=r*h-a*l,D=r*u-s*l,M=a*u-s*h,y=_*p-c*m,A=_*v-d*m,I=_*g-f*m,R=c*v-d*p,C=c*g-f*p,b=d*g-f*v,w=E*b-x*C+T*R+S*I-D*A+M*y;0!==Math.abs(w)&&(w=1/w,i[0]=(l*b-h*C+u*R)*w,i[1]=(a*C-r*b-s*R)*w,i[2]=(p*M-v*D+g*S)*w,i[3]=(d*D-c*M-f*S)*w,i[4]=(h*I-o*b-u*A)*w,i[5]=(n*b-a*I+s*A)*w,i[6]=(v*T-m*M-g*x)*w,i[7]=(_*M-d*T+f*x)*w,i[8]=(o*C-l*I+u*y)*w,i[9]=(r*I-n*C-s*y)*w,i[10]=(m*D-p*T+g*E)*w,i[11]=(c*T-_*D-f*E)*w,i[12]=(l*A-o*R-h*y)*w,i[13]=(n*R-r*A+a*y)*w,i[14]=(p*x-m*S-v*E)*w,i[15]=(_*S-c*x+d*E)*w)},e.identity=function(){var t=this.elements;t[1]=t[2]=t[3]=t[4]=t[6]=t[7]=t[8]=t[9]=t[11]=t[12]=t[13]=t[14]=0,t[0]=t[5]=t[10]=t[15]=1},e.cloneTo=function(t){var e,i,n;if(i=this.elements,n=t.elements,i!==n)for(e=0;e<16;++e)n[e]=i[e]},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},e.getTranslationVector=function(t){var e=this.elements,i=t.elements;i[0]=e[12],i[1]=e[13],i[2]=e[14]},e.setTranslationVector=function(t){var e=this.elements,i=t.elements;e[12]=i[0],e[13]=i[1],e[14]=i[2]},e.getForward=function(t){var e=this.elements,i=t.elements;i[0]=-e[8],i[1]=-e[9],i[2]=-e[10]},e.setForward=function(t){var e=this.elements,i=t.elements;e[8]=-i[0],e[9]=-i[1],e[10]=-i[2]},t.createRotationX=function(t,e){var i=e.elements,n=Math.sin(t),r=Math.cos(t);i[1]=i[2]=i[3]=i[4]=i[7]=i[8]=i[11]=i[12]=i[13]=i[14]=0,i[0]=i[15]=1,i[5]=i[10]=r,i[6]=n,i[9]=-n},t.createRotationY=function(t,e){var i=e.elements,n=Math.sin(t),r=Math.cos(t);i[1]=i[3]=i[4]=i[6]=i[7]=i[9]=i[11]=i[12]=i[13]=i[14]=0,i[5]=i[15]=1,i[0]=i[10]=r,i[2]=-n,i[8]=n},t.createRotationZ=function(t,e){var i=e.elements,n=Math.sin(t),r=Math.cos(t);i[2]=i[3]=i[6]=i[7]=i[8]=i[9]=i[11]=i[12]=i[13]=i[14]=0,i[10]=i[15]=1,i[0]=i[5]=r,i[1]=n,i[4]=-n},t.createRotationYawPitchRoll=function(e,i,n,r){Ce.createFromYawPitchRoll(e,i,n,t._tempQuaternion),t.createRotationQuaternion(t._tempQuaternion,r)},t.createRotationAxis=function(t,e,i){var n=t.elements,r=n[0],a=n[1],s=n[2],o=Math.cos(e),l=Math.sin(e),h=r*r,u=a*a,_=s*s,c=r*a,d=r*s,f=a*s,m=i.elements;m[3]=m[7]=m[11]=m[12]=m[13]=m[14]=0,m[15]=1,m[0]=h+o*(1-h),m[1]=c-o*c+l*s,m[2]=d-o*d-l*a,m[4]=c-o*c-l*s,m[5]=u+o*(1-u),m[6]=f-o*f+l*r,m[8]=d-o*d+l*a,m[9]=f-o*f-l*r,m[10]=_+o*(1-_)},t.createRotationQuaternion=function(t,e){var i=t.elements,n=e.elements,r=i[0],a=i[1],s=i[2],o=i[3],l=r*r,h=a*a,u=s*s,_=r*a,c=s*o,d=s*r,f=a*o,m=a*s,p=r*o;n[3]=n[7]=n[11]=n[12]=n[13]=n[14]=0,n[15]=1,n[0]=1-2*(h+u),n[1]=2*(_+c),n[2]=2*(d-f),n[4]=2*(_-c),n[5]=1-2*(u+l),n[6]=2*(m+p),n[8]=2*(d+f),n[9]=2*(m-p),n[10]=1-2*(h+l)},t.createTranslate=function(t,e){var i=t.elements,n=e.elements;n[4]=n[8]=n[1]=n[9]=n[2]=n[6]=n[3]=n[7]=n[11]=0,n[0]=n[5]=n[10]=n[15]=1,n[12]=i[0],n[13]=i[1],n[14]=i[2]},t.createScaling=function(t,e){var i=t.elements,n=e.elements;n[0]=i[0],n[5]=i[1],n[10]=i[2],n[1]=n[4]=n[8]=n[12]=n[9]=n[13]=n[2]=n[6]=n[14]=n[3]=n[7]=n[11]=0,n[15]=1},t.multiply=function(t,e,i){var n,r,a,s,o,l,h,u;if(r=i.elements,a=t.elements,s=e.elements,r===s)for(s=new Float32Array(16),n=0;n<16;++n)s[n]=r[n];for(n=0;n<4;n++)o=a[n],l=a[n+4],h=a[n+8],u=a[n+12],r[n]=o*s[0]+l*s[1]+h*s[2]+u*s[3],r[n+4]=o*s[4]+l*s[5]+h*s[6]+u*s[7],r[n+8]=o*s[8]+l*s[9]+h*s[10]+u*s[11],r[n+12]=o*s[12]+l*s[13]+h*s[14]+u*s[15]},t.createFromQuaternion=function(t,e){var i=e.elements,n=t.elements,r=n[0],a=n[1],s=n[2],o=n[3],l=r+r,h=a+a,u=s+s,_=r*l,c=a*l,d=a*h,f=s*l,m=s*h,p=s*u,v=o*l,g=o*h,E=o*u;i[0]=1-d-p,i[1]=c+E,i[2]=f-g,i[3]=0,i[4]=c-E,i[5]=1-_-p,i[6]=m+v,i[7]=0,i[8]=f+g,i[9]=m-v,i[10]=1-_-d,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1},t.createAffineTransformation=function(t,e,i,n){var r=t.elements,a=e.elements,s=i.elements,o=n.elements,l=a[0],h=a[1],u=a[2],_=a[3],c=l+l,d=h+h,f=u+u,m=l*c,p=l*d,v=l*f,g=h*d,E=h*f,x=u*f,T=_*c,S=_*d,D=_*f,M=s[0],y=s[1],A=s[2];o[0]=(1-(g+x))*M,o[1]=(p+D)*M,o[2]=(v-S)*M,o[3]=0,o[4]=(p-D)*y,o[5]=(1-(m+x))*y,o[6]=(E+T)*y,o[7]=0,o[8]=(v+S)*A,o[9]=(E-T)*A,o[10]=(1-(m+g))*A,o[11]=0,o[12]=r[0],o[13]=r[1],o[14]=r[2],o[15]=1},t.createLookAt=function(e,i,n,r){var a=r.elements,s=t._tempVector0,o=t._tempVector1,l=t._tempVector2;Pe.subtract(e,i,l),Pe.normalize(l,l),Pe.cross(n,l,s),Pe.normalize(s,s),Pe.cross(l,s,o),r.identity(),a[0]=s.x,a[4]=s.y,a[8]=s.z,a[1]=o.x,a[5]=o.y,a[9]=o.z,a[2]=l.x,a[6]=l.y,a[10]=l.z,a[12]=-Pe.dot(s,e),a[13]=-Pe.dot(o,e),a[14]=-Pe.dot(l,e)},t.createPerspective=function(t,e,i,n,r){var a=r.elements,s=1/Math.tan(t/2),o=1/(i-n);a[0]=s/e,a[5]=s,a[10]=(n+i)*o,a[11]=-1,a[14]=2*n*i*o,a[1]=a[2]=a[3]=a[4]=a[6]=a[7]=a[8]=a[9]=a[12]=a[13]=a[15]=0},t.createOrthoOffCenterRH=function(t,e,i,n,r,a,s){var o=s.elements,l=1/(t-e),h=1/(i-n),u=1/(r-a);o[1]=o[2]=o[3]=o[4]=o[6]=o[7]=o[8]=o[9]=o[11]=0,o[15]=1,o[0]=-2*l,o[5]=-2*h,o[10]=2*u,o[12]=(t+e)*l,o[13]=(n+i)*h,o[14]=(a+r)*u},t.translation=function(t,e){var i=t.elements,n=e.elements;n[0]=n[5]=n[10]=n[15]=1,n[12]=i[0],n[13]=i[1],n[14]=i[2]},n(t,["_tempMatrix4x4",function(){return this._tempMatrix4x4=new t},"_tempVector0",function(){return this._tempVector0=new Pe},"_tempVector1",function(){return this._tempVector1=new Pe},"_tempVector2",function(){return this._tempVector2=new Pe},"_tempQuaternion",function(){return this._tempQuaternion=new Ce},"DEFAULT",function(){return this.DEFAULT=new t},"ZERO",function(){return this.ZERO=new t(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}]),t}(),Ie=function(){function t(t,e){this.extents=null,this.transformation=null,this.extents=t,this.transformation=e}r(t,"laya.d3.math.OrientedBoundBox");var e=t.prototype;return e.getCorners=function(e){var i=t._tempV30.elements,n=t._tempV31.elements,r=t._tempV32.elements,a=this.extents.elements;i[0]=a[0],i[1]=i[2]=0,n[1]=a[1],n[0]=n[2]=0,r[2]=a[2],r[0]=r[1]=0,Pe.TransformNormal(t._tempV30,this.transformation,t._tempV30),Pe.TransformNormal(t._tempV31,this.transformation,t._tempV31),Pe.TransformNormal(t._tempV32,this.transformation,t._tempV32);var s=t._tempV33;this.transformation.getTranslationVector(s),e.length=8,Pe.add(s,t._tempV30,t._tempV34),Pe.add(t._tempV34,t._tempV31,t._tempV34),Pe.add(t._tempV34,t._tempV32,e[0]),Pe.add(s,t._tempV30,t._tempV34),Pe.add(t._tempV34,t._tempV31,t._tempV34),Pe.subtract(t._tempV34,t._tempV32,e[1]),Pe.subtract(s,t._tempV30,t._tempV34),Pe.add(t._tempV34,t._tempV31,t._tempV34),Pe.subtract(t._tempV34,t._tempV32,e[2]),Pe.subtract(s,t._tempV30,t._tempV34),Pe.add(t._tempV34,t._tempV31,t._tempV34),Pe.add(t._tempV34,t._tempV32,e[3]),Pe.add(s,t._tempV30,t._tempV34),Pe.subtract(t._tempV34,t._tempV31,t._tempV34),Pe.add(t._tempV34,t._tempV32,e[4]),Pe.add(s,t._tempV30,t._tempV34),Pe.subtract(t._tempV34,t._tempV31,t._tempV34),Pe.subtract(t._tempV34,t._tempV32,e[5]),Pe.subtract(s,t._tempV30,t._tempV34),Pe.subtract(t._tempV34,t._tempV31,t._tempV34),Pe.subtract(t._tempV34,t._tempV32,e[6]),Pe.subtract(s,t._tempV30,t._tempV34),Pe.subtract(t._tempV34,t._tempV31,t._tempV34),Pe.add(t._tempV34,t._tempV32,e[7])},e.transform=function(t){Ae.multiply(this.transformation,t,this.transformation)},e.scale=function(t){Pe.multiply(this.extents,t,this.extents)},e.translate=function(e){this.transformation.getTranslationVector(t._tempV30),Pe.add(t._tempV30,e,t._tempV31),this.transformation.setTranslationVector(t._tempV31)},e.Size=function(t){Pe.scale(this.extents,2,t)},e.getSize=function(e){var i=this.extents.elements;t._tempV30.x=i[0],t._tempV31.y=i[1],t._tempV32.z=i[2],Pe.TransformNormal(t._tempV30,this.transformation,t._tempV30),Pe.TransformNormal(t._tempV31,this.transformation,t._tempV31),Pe.TransformNormal(t._tempV31,this.transformation,t._tempV32);var n=e.elements;n[0]=Pe.scalarLength(t._tempV30),n[1]=Pe.scalarLength(t._tempV31),n[2]=Pe.scalarLength(t._tempV32)},e.getSizeSquared=function(e){var i=this.extents.elements;t._tempV30.x=i[0],t._tempV31.y=i[1],t._tempV32.z=i[2],Pe.TransformNormal(t._tempV30,this.transformation,t._tempV30),Pe.TransformNormal(t._tempV31,this.transformation,t._tempV31),Pe.TransformNormal(t._tempV31,this.transformation,t._tempV32);var n=e.elements;n[0]=Pe.scalarLengthSquared(t._tempV30),n[1]=Pe.scalarLengthSquared(t._tempV31),n[2]=Pe.scalarLengthSquared(t._tempV32)},e.getCenter=function(t){this.transformation.getTranslationVector(t)},e.containsPoint=function(e){var i=this.extents.elements,n=i[0],r=i[1],a=i[2];this.transformation.invert(t._tempM0),Pe.transformCoordinate(e,t._tempM0,t._tempV30);var s=t._tempV30.elements,o=Math.abs(s[0]),l=Math.abs(s[1]),h=Math.abs(s[2]);return Me.nearEqual(o,n)&&Me.nearEqual(l,r)&&Me.nearEqual(h,a)?2:o<n&&l<r&&h<a?1:0},e.containsPoints=function(e){var i=this.extents.elements,n=i[0],r=i[1],a=i[2];this.transformation.invert(t._tempM0);for(var s=!0,o=!1,l=0;l<e.length;l++){Pe.transformCoordinate(e[l],t._tempM0,t._tempV30);var h=t._tempV30.elements,u=Math.abs(h[0]),_=Math.abs(h[1]),c=Math.abs(h[2]);Me.nearEqual(u,n)&&Me.nearEqual(_,r)&&Me.nearEqual(c,a)&&(o=!0),u<n&&_<r&&a<c?o=!0:s=!1}return s?1:o?2:0},e.containsSphere=function(e,i){void 0===i&&(i=!1);var n=this.extents.elements,r=n[0],a=n[1],s=n[2],o=e.radius;this.transformation.invert(t._tempM0),Pe.transformCoordinate(e.center,t._tempM0,t._tempV30);var l=NaN;if(i?l=o:(Pe.scale(Pe.UnitX,o,t._tempV31),Pe.TransformNormal(t._tempV31,t._tempM0,t._tempV31),l=Pe.scalarLength(t._tempV31)),Pe.scale(this.extents,-1,t._tempV32),Pe.Clamp(t._tempV30,t._tempV32,this.extents,t._tempV33),Pe.distanceSquared(t._tempV30,t._tempV33)>l*l)return 0;var h=t._tempV30.elements,u=h[0],_=h[1],c=h[2],d=t._tempV32.elements,f=d[0],m=d[1],p=d[2];return f+l<=u&&u<=r-l&&r-f>l&&m+l<=_&&_<=a-l&&a-m>l&&p+l<=c&&c<=s-l&&s-p>l?1:2},e.containsOrientedBoundBox=function(e){var i=0,n=0;e.getCorners(t._corners);var r=this.containsPoints(t._corners);if(0!=r)return r;var a=this.extents.elements;e.extents.cloneTo(t._tempV35);var s=t._tempV35.elements;t._getRows(this.transformation,t._rows1),t._getRows(e.transformation,t._rows2);var o=NaN,l=NaN,h=NaN;for(i=0;i<4;i++)for(n=0;n<4;n++)3==i||3==n?(t._tempM0.setElementByRowColumn(i,n,0),t._tempM1.setElementByRowColumn(i,n,0)):(h=Pe.dot(t._rows1[i],t._rows2[n]),t._tempM0.setElementByRowColumn(i,n,h),t._tempM1.setElementByRowColumn(i,n,Math.abs(h)));e.getCenter(t._tempV34),this.getCenter(t._tempV36),Pe.subtract(t._tempV34,t._tempV36,t._tempV30);var u=t._tempV31.elements;u[0]=Pe.dot(t._tempV30,t._rows1[0]),u[1]=Pe.dot(t._tempV30,t._rows1[1]),u[2]=Pe.dot(t._tempV30,t._rows1[2]);var _=t._tempV32.elements,c=t._tempV33.elements;for(i=0;i<3;i++)if(_[0]=t._tempM1.getElementByRowColumn(i,0),_[1]=t._tempM1.getElementByRowColumn(i,1),_[2]=t._tempM1.getElementByRowColumn(i,2),o=a[i],l=Pe.dot(t._tempV35,t._tempV32),Math.abs(u[i])>o+l)return 0;for(n=0;n<3;n++)if(_[0]=t._tempM1.getElementByRowColumn(0,n),_[1]=t._tempM1.getElementByRowColumn(1,n),_[2]=t._tempM1.getElementByRowColumn(2,n),c[0]=t._tempM0.getElementByRowColumn(0,n),c[1]=t._tempM0.getElementByRowColumn(1,n),c[2]=t._tempM0.getElementByRowColumn(2,n),o=Pe.dot(this.extents,t._tempV32),l=s[n],Math.abs(Pe.dot(t._tempV31,t._tempV33))>o+l)return 0;for(i=0;i<3;i++)for(n=0;n<3;n++){var d=(i+1)%3,f=(i+2)%3,m=(n+1)%3,p=(n+2)%3;if(o=a[d]*t._tempM1.getElementByRowColumn(f,n)+s[f]*t._tempM1.getElementByRowColumn(d,n),l=a[m]*t._tempM1.getElementByRowColumn(i,p)+s[p]*t._tempM1.getElementByRowColumn(i,m),Math.abs(u[f]*t._tempM0.getElementByRowColumn(d,n)-u[d]*t._tempM0.getElementByRowColumn(f,n))>o+l)return 0}return 2},e.containsLine=function(e,i){t._corners[0]=e,t._corners[1]=i;var n=this.containsPoints(t._corners);if(0!=n)return n;var r=this.extents.elements,a=r[0],s=r[1],o=r[2];this.transformation.invert(t._tempM0),Pe.transformCoordinate(e,t._tempM0,t._tempV30),Pe.transformCoordinate(i,t._tempM0,t._tempV31),Pe.add(t._tempV30,t._tempV31,t._tempV32),Pe.scale(t._tempV32,.5,t._tempV32),Pe.subtract(t._tempV30,t._tempV32,t._tempV33);var l=t._tempV33.elements,h=l[0],u=l[1],_=l[2],c=t._tempV34.elements,d=c[0]=Math.abs(l[0]),f=c[1]=Math.abs(l[1]),m=c[2]=Math.abs(l[2]),p=t._tempV32.elements,v=p[0],g=p[1],E=p[2];return Math.abs(v)>a+d?0:Math.abs(g)>s+f?0:Math.abs(E)>o+m?0:Math.abs(g*_-E*u)>s*m+o*f?0:Math.abs(v*_-E*h)>a*m+o*d?0:Math.abs(v*u-g*h)>a*f+s*d?0:2},e.containsBoundBox=function(e){var i=0,n=0,r=e.min,a=e.max;e.getCorners(t._corners);var s=this.containsPoints(t._corners);if(0!=s)return s;Pe.subtract(a,r,t._tempV30),Pe.scale(t._tempV30,.5,t._tempV30),Pe.add(r,t._tempV30,t._tempV30),Pe.subtract(a,t._tempV30,t._tempV31);var o=this.extents.elements,l=t._tempV31.elements;t._getRows(this.transformation,t._rows1),this.transformation.invert(t._tempM0);var h=NaN,u=NaN;for(i=0;i<3;i++)for(n=0;n<3;n++)t._tempM1.setElementByRowColumn(i,n,Math.abs(t._tempM0.getElementByRowColumn(i,n)));this.getCenter(t._tempV35),Pe.subtract(t._tempV30,t._tempV35,t._tempV32);var _=t._tempV31.elements;_[0]=Pe.dot(t._tempV32,t._rows1[0]),_[1]=Pe.dot(t._tempV32,t._rows1[1]),_[2]=Pe.dot(t._tempV32,t._rows1[2]);var c=t._tempV33.elements,d=t._tempV34.elements;for(i=0;i<3;i++)if(c[0]=t._tempM1.getElementByRowColumn(i,0),c[1]=t._tempM1.getElementByRowColumn(i,1),c[2]=t._tempM1.getElementByRowColumn(i,2),h=o[i],u=Pe.dot(t._tempV31,t._tempV33),Math.abs(_[i])>h+u)return 0;for(n=0;n<3;n++)if(c[0]=t._tempM1.getElementByRowColumn(0,n),c[1]=t._tempM1.getElementByRowColumn(1,n),c[2]=t._tempM1.getElementByRowColumn(2,n),d[0]=t._tempM0.getElementByRowColumn(0,n),d[1]=t._tempM0.getElementByRowColumn(1,n),d[2]=t._tempM0.getElementByRowColumn(2,n),h=Pe.dot(this.extents,t._tempV33),u=l[n],Math.abs(Pe.dot(t._tempV31,t._tempV34))>h+u)return 0;for(i=0;i<3;i++)for(n=0;n<3;n++){var f=(i+1)%3,m=(i+2)%3,p=(n+1)%3,v=(n+2)%3;if(h=o[f]*t._tempM1.getElementByRowColumn(m,n)+o[m]*t._tempM1.getElementByRowColumn(f,n),u=l[p]*t._tempM1.getElementByRowColumn(i,v)+l[v]*t._tempM1.getElementByRowColumn(i,p),Math.abs(_[m]*t._tempM0.getElementByRowColumn(f,n)-_[f]*t._tempM0.getElementByRowColumn(m,n))>h+u)return 0}return 2},e.intersectsRay=function(e,i){Pe.scale(this.extents,-1,t._tempV30),this.transformation.invert(t._tempM0),Pe.TransformNormal(e.direction,t._tempM0,t._ray.direction),Pe.transformCoordinate(e.origin,t._tempM0,t._ray.origin),t._boxBound1.min=t._tempV30,t._boxBound1.max=this.extents;var n=De.intersectsRayAndBoxRP(t._ray,t._boxBound1,i);return-1!==n&&Pe.transformCoordinate(i,this.transformation,i),n},e._getLocalCorners=function(e){e.length=8;var i=this.extents.elements;t._tempV30.x=i[0],t._tempV31.y=i[1],t._tempV32.z=i[2],Pe.add(t._tempV30,t._tempV31,t._tempV33),Pe.add(t._tempV33,t._tempV32,e[0]),Pe.add(t._tempV30,t._tempV31,t._tempV33),Pe.subtract(t._tempV33,t._tempV32,e[1]),Pe.subtract(t._tempV31,t._tempV30,t._tempV33),Pe.subtract(t._tempV33,t._tempV30,e[2]),Pe.subtract(t._tempV31,t._tempV30,t._tempV33),Pe.add(t._tempV33,t._tempV32,e[3]),Pe.subtract(t._tempV30,t._tempV31,t._tempV33),Pe.add(t._tempV33,t._tempV32,e[4]),Pe.subtract(t._tempV30,t._tempV31,t._tempV33),Pe.subtract(t._tempV33,t._tempV32,e[5]),Pe.scale(e[0],-1,e[6]),Pe.subtract(t._tempV32,t._tempV30,t._tempV33),Pe.subtract(t._tempV33,t._tempV31,e[7])},e.equals=function(t){return this.extents==t.extents&&this.transformation==t.transformation},e.cloneTo=function(t){var e=t;this.extents.cloneTo(e.extents),this.transformation.cloneTo(e.transformation)},t.createByBoundBox=function(e,i){var n=e.min,r=e.max;Pe.subtract(r,n,t._tempV30),Pe.scale(t._tempV30,.5,t._tempV30),Pe.add(n,t._tempV30,t._tempV31),Pe.subtract(r,t._tempV31,t._tempV32),Ae.translation(t._tempV31,t._tempM0);var a=t._tempV32.clone(),s=t._tempM0.clone();i.extents=a,i.transformation=s},t.createByMinAndMaxVertex=function(e,i){return Pe.subtract(i,e,t._tempV30),Pe.scale(t._tempV30,.5,t._tempV30),Pe.add(e,t._tempV30,t._tempV31),Pe.subtract(i,t._tempV31,t._tempV32),Ae.translation(t._tempV31,t._tempM0),new t(t._tempV32,t._tempM0)},t._getRows=function(t,e){e.length=3;var i=t.elements,n=e[0].elements;n[0]=i[0],n[1]=i[1],n[2]=i[2];var r=e[1].elements;r[0]=i[4],r[1]=i[5],r[2]=i[6];var a=e[2].elements;a[0]=i[8],a[1]=i[9],a[2]=i[10]},t.getObbtoObbMatrix4x4=function(e,i,n,r){var a=e.transformation,s=i.transformation;if(n){t._getRows(a,t._rows1),t._getRows(s,t._rows2);for(var o=0;o<3;o++)for(var l=0;l<3;l++)r.setElementByRowColumn(o,l,Pe.dot(t._rows2[o],t._rows1[l]));i.getCenter(t._tempV30),e.getCenter(t._tempV31),Pe.subtract(t._tempV30,t._tempV31,t._tempV32);var h=r.elements;h[12]=Pe.dot(t._tempV32,t._rows1[0]),h[13]=Pe.dot(t._tempV32,t._rows1[1]),h[14]=Pe.dot(t._tempV32,t._rows1[2]),h[15]=1}else a.invert(t._tempM0),Ae.multiply(s,t._tempM0,r)},t.merge=function(e,i,n){var r=e.extents,a=e.transformation;t.getObbtoObbMatrix4x4(e,i,n,t._tempM0),i._getLocalCorners(t._corners),Pe.transformCoordinate(t._corners[0],t._tempM0,t._corners[0]),Pe.transformCoordinate(t._corners[1],t._tempM0,t._corners[1]),Pe.transformCoordinate(t._corners[2],t._tempM0,t._corners[2]),Pe.transformCoordinate(t._corners[3],t._tempM0,t._corners[3]),Pe.transformCoordinate(t._corners[4],t._tempM0,t._corners[4]),Pe.transformCoordinate(t._corners[5],t._tempM0,t._corners[5]),Pe.transformCoordinate(t._corners[6],t._tempM0,t._corners[6]),Pe.transformCoordinate(t._corners[7],t._tempM0,t._corners[7]),Pe.scale(r,-1,t._boxBound1.min),r.cloneTo(t._boxBound1.max),xe.createfromPoints(t._corners,t._boxBound2),xe.merge(t._boxBound2,t._boxBound1,t._boxBound3);var s=t._boxBound3.min,o=t._boxBound3.max;Pe.subtract(o,s,t._tempV30),Pe.scale(t._tempV30,.5,t._tempV30),Pe.add(s,t._tempV30,t._tempV32),Pe.subtract(o,t._tempV32,r),Pe.transformCoordinate(t._tempV32,a,t._tempV33)},n(t,["_tempV30",function(){return this._tempV30=new Pe},"_tempV31",function(){return this._tempV31=new Pe},"_tempV32",function(){return this._tempV32=new Pe},"_tempV33",function(){return this._tempV33=new Pe},"_tempV34",function(){return this._tempV34=new Pe},"_tempV35",function(){return this._tempV35=new Pe},"_tempV36",function(){return this._tempV36=new Pe},"_tempM0",function(){return this._tempM0=new Ae},"_tempM1",function(){return this._tempM1=new Ae},"_corners",function(){return this._corners=[new Pe,new Pe,new Pe,new Pe,new Pe,new Pe,new Pe,new Pe]},"_rows1",function(){return this._rows1=[new Pe,new Pe,new Pe]},"_rows2",function(){return this._rows2=[new Pe,new Pe,new Pe]},"_ray",function(){return this._ray=new we(new Pe,new Pe)},"_boxBound1",function(){return this._boxBound1=new xe(new Pe,new Pe)},"_boxBound2",function(){return this._boxBound2=new xe(new Pe,new Pe)},"_boxBound3",function(){return this._boxBound3=new xe(new Pe,new Pe)}]),t}(),Re=function(){function t(t,e){this.normal=null,this.distance=NaN,void 0===e&&(e=0),this.normal=t,this.distance=e}return r(t,"laya.d3.math.Plane"),t.prototype.normalize=function(){var t=this.normal.elements,e=t[0],i=t[1],n=t[2],r=1/Math.sqrt(e*e+i*i+n*n);t[0]=e*r,t[1]=i*r,t[2]=n*r,this.distance*=r},t.createPlaneBy3P=function(e,i,n){var r=e.elements,a=i.elements,s=n.elements,o=a[0]-r[0],l=a[1]-r[1],h=a[2]-r[2],u=s[0]-r[0],_=s[1]-r[1],c=s[2]-r[2],d=l*c-h*_,f=h*u-o*c,m=o*_-l*u,p=1/Math.sqrt(d*d+f*f+m*m),v=d*p,g=f*p,E=m*p,x=t._TEMPVec3.elements;x[0]=v,x[1]=g,x[2]=E;var T=-(v*r[0]+g*r[1]+E*r[2]);return new t(t._TEMPVec3,T)},t.PlaneIntersectionType_Back=0,t.PlaneIntersectionType_Front=1,t.PlaneIntersectionType_Intersecting=2,n(t,["_TEMPVec3",function(){return this._TEMPVec3=new Pe}]),t}(),Ce=function(){function t(t,e,i,n){this.elements=new Float32Array(4),void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=1),this.elements[0]=t,this.elements[1]=e,this.elements[2]=i,this.elements[3]=n}r(t,"laya.d3.math.Quaternion");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.scaling=function(t,e){var i=e.elements,n=this.elements;i[0]=n[0]*t,i[1]=n[1]*t,i[2]=n[2]*t,i[3]=n[3]*t},e.normalize=function(t){var e=t.elements,i=this.elements,n=i[0],r=i[1],a=i[2],s=i[3],o=n*n+r*r+a*a+s*s;o>0&&(o=1/Math.sqrt(o),e[0]=n*o,e[1]=r*o,e[2]=a*o,e[3]=s*o)},e.length=function(){var t=this.elements,e=t[0],i=t[1],n=t[2],r=t[3];return Math.sqrt(e*e+i*i+n*n+r*r)},e.rotateX=function(t,e){var i=e.elements,n=this.elements;t*=.5;var r=n[0],a=n[1],s=n[2],o=n[3],l=Math.sin(t),h=Math.cos(t);i[0]=r*h+o*l,i[1]=a*h+s*l,i[2]=s*h-a*l,i[3]=o*h-r*l},e.rotateY=function(t,e){var i=e.elements,n=this.elements;t*=.5;var r=n[0],a=n[1],s=n[2],o=n[3],l=Math.sin(t),h=Math.cos(t);i[0]=r*h-s*l,i[1]=a*h+o*l,i[2]=s*h+r*l,i[3]=o*h-a*l},e.rotateZ=function(t,e){var i=e.elements,n=this.elements;t*=.5;var r=n[0],a=n[1],s=n[2],o=n[3],l=Math.sin(t),h=Math.cos(t);i[0]=r*h+a*l,i[1]=a*h-r*l,i[2]=s*h+o*l,i[3]=o*h-s*l},e.getYawPitchRoll=function(e){Pe.transformQuat(Pe.ForwardRH,this,t.TEMPVector31),Pe.transformQuat(Pe.Up,this,t.TEMPVector32);var i=t.TEMPVector32.elements;t.angleTo(Pe.ZERO,t.TEMPVector31,t.TEMPVector33);var n=t.TEMPVector33.elements;n[0]==Math.PI/2?(n[1]=t.arcTanAngle(i[2],i[0]),n[2]=0):n[0]==-Math.PI/2?(n[1]=t.arcTanAngle(-i[2],-i[0]),n[2]=0):(Ae.createRotationY(-n[1],t.TEMPMatrix0),Ae.createRotationX(-n[0],t.TEMPMatrix1),Pe.transformCoordinate(t.TEMPVector32,t.TEMPMatrix0,t.TEMPVector32),Pe.transformCoordinate(t.TEMPVector32,t.TEMPMatrix1,t.TEMPVector32),n[2]=t.arcTanAngle(i[1],-i[0])),n[1]<=-Math.PI&&(n[1]=Math.PI),n[2]<=-Math.PI&&(n[2]=Math.PI),n[1]>=Math.PI&&n[2]>=Math.PI&&(n[1]=0,n[2]=0,n[0]=Math.PI-n[0]);var r=e.elements;r[0]=n[1],r[1]=n[0],r[2]=n[2]},e.invert=function(t){var e=t.elements,i=this.elements,n=i[0],r=i[1],a=i[2],s=i[3],o=n*n+r*r+a*a+s*s,l=o?1/o:0;e[0]=-n*l,e[1]=-r*l,e[2]=-a*l,e[3]=s*l},e.identity=function(){var t=this.elements;t[0]=0,t[1]=0,t[2]=0,t[3]=1},e.fromArray=function(t,e){void 0===e&&(e=0),this.elements[0]=t[e+0],this.elements[1]=t[e+1],this.elements[2]=t[e+2],this.elements[3]=t[e+3]},e.cloneTo=function(t){var e,i,n;if(i=this.elements,n=t.elements,i!==n)for(e=0;e<4;++e)n[e]=i[e]},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},e.equals=function(t){var e=this.elements,i=t.elements;return Me.nearEqual(e[0],i[0])&&Me.nearEqual(e[1],i[1])&&Me.nearEqual(e[2],i[2])&&Me.nearEqual(e[3],i[3])},e.lengthSquared=function(){var t=this.elements[0],e=this.elements[1],i=this.elements[2],n=this.elements[3];return t*t+e*e+i*i+n*n},a(0,e,"x",function(){return this.elements[0]}),a(0,e,"y",function(){return this.elements[1]}),a(0,e,"z",function(){return this.elements[2]}),a(0,e,"w",function(){return this.elements[3]}),t.createFromYawPitchRoll=function(t,e,i,n){var r=.5*i,a=.5*e,s=.5*t,o=Math.sin(r),l=Math.cos(r),h=Math.sin(a),u=Math.cos(a),_=Math.sin(s),c=Math.cos(s),d=n.elements;d[0]=c*h*l+_*u*o,d[1]=_*u*l-c*h*o,d[2]=c*u*o-_*h*l,d[3]=c*u*l+_*h*o},t.multiply=function(t,e,i){var n=t.elements,r=e.elements,a=i.elements,s=n[0],o=n[1],l=n[2],h=n[3],u=r[0],_=r[1],c=r[2],d=r[3],f=o*c-l*_,m=l*u-s*c,p=s*_-o*u,v=s*u+o*_+l*c;a[0]=s*d+u*h+f,a[1]=o*d+_*h+m,a[2]=l*d+c*h+p,a[3]=h*d-v},t.arcTanAngle=function(t,e){return 0==t?1==e?Math.PI/2:-Math.PI/2:t>0?Math.atan(e/t):t<0?e>0?Math.atan(e/t)+Math.PI:Math.atan(e/t)-Math.PI:0},t.angleTo=function(e,i,n){Pe.subtract(i,e,t.TEMPVector30),Pe.normalize(t.TEMPVector30,t.TEMPVector30),n.elements[0]=Math.asin(t.TEMPVector30.y),n.elements[1]=t.arcTanAngle(-t.TEMPVector30.z,-t.TEMPVector30.x)},t.createFromAxisAngle=function(t,e,i){var n=i.elements,r=t.elements;e*=.5;var a=Math.sin(e);n[0]=a*r[0],n[1]=a*r[1],n[2]=a*r[2],n[3]=Math.cos(e)},t.createFromMatrix3x3=function(t,e){var i,n=e.elements,r=t.elements,a=r[0]+r[4]+r[8];if(a>0)i=Math.sqrt(a+1),n[3]=.5*i,i=.5/i,n[0]=(r[5]-r[7])*i,n[1]=(r[6]-r[2])*i,n[2]=(r[1]-r[3])*i;else{var s=0;r[4]>r[0]&&(s=1),r[8]>r[3*s+s]&&(s=2);var o=(s+1)%3,l=(s+2)%3;i=Math.sqrt(r[3*s+s]-r[3*o+o]-r[3*l+l]+1),n[s]=.5*i,i=.5/i,n[3]=(r[3*o+l]-r[3*l+o])*i,n[o]=(r[3*o+s]+r[3*s+o])*i,n[l]=(r[3*l+s]+r[3*s+l])*i}},t.createFromMatrix4x4=function(t,e){var i,n,r=t.elements,a=e.elements,s=r[0]+r[5]+r[10];s>0?(i=Math.sqrt(s+1),a[3]=.5*i,i=.5/i,a[0]=(r[6]-r[9])*i,a[1]=(r[8]-r[2])*i,a[2]=(r[1]-r[4])*i):r[0]>=r[5]&&r[0]>=r[10]?(i=Math.sqrt(1+r[0]-r[5]-r[10]),n=.5/i,a[0]=.5*i,a[1]=(r[1]+r[4])*n,a[2]=(r[2]+r[8])*n,a[3]=(r[6]-r[9])*n):r[5]>r[10]?(i=Math.sqrt(1+r[5]-r[0]-r[10]),n=.5/i,a[0]=(r[4]+r[1])*n,a[1]=.5*i,a[2]=(r[9]+r[6])*n,a[3]=(r[8]-r[2])*n):(i=Math.sqrt(1+r[10]-r[0]-r[5]),n=.5/i,a[0]=(r[8]+r[2])*n,a[1]=(r[9]+r[6])*n,a[2]=.5*i,a[3]=(r[1]-r[4])*n)},t.slerp=function(t,e,i,n){var r,a,s,o,l,h=t.elements,u=e.elements,_=n.elements,c=h[0],d=h[1],f=h[2],m=h[3],p=u[0],v=u[1],g=u[2],E=u[3];return a=c*p+d*v+f*g+m*E,a<0&&(a=-a,p=-p,v=-v,g=-g,E=-E),1-a>1e-6?(r=Math.acos(a),s=Math.sin(r),o=Math.sin((1-i)*r)/s,l=Math.sin(i*r)/s):(o=1-i,l=i),_[0]=o*c+l*p,_[1]=o*d+l*v,_[2]=o*f+l*g,_[3]=o*m+l*E,_},t.lerp=function(t,e,i,n){var r=n.elements,a=t.elements,s=e.elements,o=a[0],l=a[1],h=a[2],u=a[3];r[0]=o+i*(s[0]-o),r[1]=l+i*(s[1]-l),r[2]=h+i*(s[2]-h),r[3]=u+i*(s[3]-u)},t.add=function(t,e,i){var n=i.elements,r=t.elements,a=e.elements;n[0]=r[0]+a[0],n[1]=r[1]+a[1],n[2]=r[2]+a[2],n[3]=r[3]+a[3]},t.dot=function(t,e){var i=t.elements,n=e.elements;return i[0]*n[0]+i[1]*n[1]+i[2]*n[2]+i[3]*n[3]},t.rotationLookAt=function(e,i,n){t.lookAt(Pe.ZERO,e,i,n)},t.lookAt=function(e,i,n,r){ye.lookAt(e,i,n,t._tempMatrix3x3),t.rotationMatrix(t._tempMatrix3x3,r)},t.invert=function(t,e){var i=t.elements,n=e.elements,r=t.lengthSquared();Me.isZero(r)||(r=1/r,n[0]=-i[0]*r,n[1]=-i[1]*r,n[2]=-i[2]*r,n[3]=i[3]*r)},t.rotationMatrix=function(t,e){var i=t.elements,n=i[0],r=i[1],a=i[2],s=i[3],o=i[4],l=i[5],h=i[6],u=i[7],_=i[8],c=e.elements,d=NaN,f=NaN,m=n+o+_;m>0?(d=Math.sqrt(m+1),c[3]=.5*d,d=.5/d,c[0]=(l-u)*d,c[1]=(h-a)*d,c[2]=(r-s)*d):n>=o&&n>=_?(d=Math.sqrt(1+n-o-_),f=.5/d,c[0]=.5*d,c[1]=(r+s)*f,c[2]=(a+h)*f,c[3]=(l-u)*f):o>_?(d=Math.sqrt(1+o-n-_),f=.5/d,c[0]=(s+r)*f,c[1]=.5*d,c[2]=(u+l)*f,c[3]=(h-a)*f):(d=Math.sqrt(1+_-n-o),f=.5/d,c[0]=(h+a)*f,c[1]=(u+l)*f,c[2]=.5*d,c[3]=(r-s)*f)},n(t,["TEMPVector30",function(){return this.TEMPVector30=new Pe},"TEMPVector31",function(){return this.TEMPVector31=new Pe},"TEMPVector32",function(){return this.TEMPVector32=new Pe},"TEMPVector33",function(){return this.TEMPVector33=new Pe},"TEMPMatrix0",function(){return this.TEMPMatrix0=new Ae},"TEMPMatrix1",function(){return this.TEMPMatrix1=new Ae},"_tempMatrix3x3",function(){return this._tempMatrix3x3=new ye},"DEFAULT",function(){return this.DEFAULT=new t},"NAN",function(){return this.NAN=new t(NaN,NaN,NaN,NaN)}]),t}(),be=function(){function t(t){this._temp=new Uint32Array(1),this.seeds=new Uint32Array(4),this.seeds[0]=t,this.seeds[1]=1812433253*this.seeds[0]+1,this.seeds[2]=1812433253*this.seeds[1]+1,this.seeds[3]=1812433253*this.seeds[2]+1}r(t,"laya.d3.math.Rand");var e=t.prototype;return e.getUint=function(){return this._temp[0]=this.seeds[0]^this.seeds[0]<<11,this.seeds[0]=this.seeds[1],this.seeds[1]=this.seeds[2],this.seeds[2]=this.seeds[3],this.seeds[3]=this.seeds[3]^this.seeds[3]>>>19^this._temp[0]^this._temp[0]>>>8,this.seeds[3]},e.getFloat=function(){return this.getUint(),(8388607&this.seeds[3])*(1/8388607)},e.getSignedFloat=function(){return 2*this.getFloat()-1},a(0,e,"seed",function(){return this.seeds[0]},function(t){this.seeds[0]=t,this.seeds[1]=1812433253*this.seeds[0]+1,this.seeds[2]=1812433253*this.seeds[1]+1,this.seeds[3]=1812433253*this.seeds[2]+1}),t.getFloatFromInt=function(t){return 1/8388607*(8388607&t)},t.getByteFromInt=function(t){return(8388607&t)>>>15},t}(),we=(function(){function t(t){if(this._state0U=NaN,this._state0L=NaN,this._state1U=NaN,this._state1L=NaN,!(t instanceof Array)||4!==t.length)throw new Error("Rand:Seed must be an array with 4 numbers");this._state0U=0|t[0],this._state0L=0|t[1],this._state1U=0|t[2],this._state1L=0|t[3]}r(t,"laya.d3.math.RandX");var e=t.prototype;e.randomint=function(){var t=this._state0U,e=this._state0L,i=this._state1U,n=this._state1L,r=(n>>>0)+(e>>>0),a=i+t+(r/2>>>31)>>>0,s=r>>>0;this._state0U=i,this._state0L=n;var o=0,l=0,h=0,u=0;o=t<<23|(-512&e)>>>9,l=e<<23,t^=o,e^=l,o=t^i,l=e^n;h=t>>>18,u=e>>>18|(262143&t)<<14,o^=h,l^=u;return h=i>>>5,u=n>>>5|(31&i)<<27,o^=h,l^=u,this._state1U=o,this._state1L=l,[a,s]},e.random=function(){var e=this.randomint(),i=e[0],n=e[1],r=i>>>12,a=n>>>12|(4095&i)<<20,s=1023<<20|r,o=0|a;return t._CONVERTION_BUFFER.setUint32(0,s,!1),t._CONVERTION_BUFFER.setUint32(4,o,!1),be._CONVERTION_BUFFER.getFloat64(0,!1)-1},n(t,["_CONVERTION_BUFFER",function(){return this._CONVERTION_BUFFER=new DataView(new ArrayBuffer(8))},"defaultRand",function(){return this.defaultRand=new be([0,Date.now()/65536,0,Date.now()%65536])}])}(),function(){function t(t,e){this.origin=null,this.direction=null,this.origin=t,this.direction=e}return r(t,"laya.d3.math.Ray"),t}()),Ne=function(){function t(t,e){this.elements=new Float32Array(2),void 0===t&&(t=0),void 0===e&&(e=0);var i=this.elements;i[0]=t,i[1]=e}r(t,"laya.d3.math.Vector2");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.fromArray=function(t,e){void 0===e&&(e=0),this.elements[0]=t[e+0],this.elements[1]=t[e+1]},e.cloneTo=function(t){var e=t,i=e.elements,n=this.elements;i[0]=n[0],i[1]=n[1]},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},a(0,e,"x",function(){return this.elements[0]},function(t){this.elements[0]=t}),a(0,e,"y",function(){return this.elements[1]},function(t){this.elements[1]=t}),t.scale=function(t,e,i){var n=i.elements,r=t.elements;n[0]=r[0]*e,n[1]=r[1]*e},n(t,["ZERO",function(){return this.ZERO=new t(0,0)},"ONE",function(){return this.ONE=new t(1,1)}]),t}(),Pe=function(){function t(t,e,i){this.elements=new Float32Array(3),void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0);var n=this.elements;n[0]=t,n[1]=e,n[2]=i}r(t,"laya.d3.math.Vector3");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.fromArray=function(t,e){void 0===e&&(e=0),this.elements[0]=t[e+0],this.elements[1]=t[e+1],this.elements[2]=t[e+2]},e.cloneTo=function(t){var e=t,i=e.elements,n=this.elements;i[0]=n[0],i[1]=n[1],i[2]=n[2]},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},e.toDefault=function(){this.elements[0]=0,this.elements[1]=0,this.elements[2]=0},a(0,e,"x",function(){return this.elements[0]},function(t){this.elements[0]=t}),a(0,e,"y",function(){return this.elements[1]},function(t){this.elements[1]=t}),a(0,e,"z",function(){return this.elements[2]},function(t){this.elements[2]=t}),t.distanceSquared=function(t,e){var i=t.elements,n=e.elements,r=i[0]-n[0],a=i[1]-n[1],s=i[2]-n[2];return r*r+a*a+s*s},t.distance=function(t,e){var i=t.elements,n=e.elements,r=i[0]-n[0],a=i[1]-n[1],s=i[2]-n[2];return Math.sqrt(r*r+a*a+s*s)},t.min=function(t,e,i){var n=i.elements,r=t.elements,a=e.elements;n[0]=Math.min(r[0],a[0]),n[1]=Math.min(r[1],a[1]),n[2]=Math.min(r[2],a[2])},t.max=function(t,e,i){var n=i.elements,r=t.elements,a=e.elements;n[0]=Math.max(r[0],a[0]),n[1]=Math.max(r[1],a[1]),n[2]=Math.max(r[2],a[2])},t.transformQuat=function(t,e,i){var n=i.elements,r=t.elements,a=e.elements,s=r[0],o=r[1],l=r[2],h=a[0],u=a[1],_=a[2],c=a[3],d=c*s+u*l-_*o,f=c*o+_*s-h*l,m=c*l+h*o-u*s,p=-h*s-u*o-_*l;n[0]=d*c+p*-h+f*-_-m*-u,n[1]=f*c+p*-u+m*-h-d*-_,n[2]=m*c+p*-_+d*-u-f*-h},t.scalarLength=function(t){var e=t.elements,i=e[0],n=e[1],r=e[2];return Math.sqrt(i*i+n*n+r*r)},t.scalarLengthSquared=function(t){var e=t.elements,i=e[0],n=e[1],r=e[2];return i*i+n*n+r*r},t.normalize=function(t,e){var i=t.elements,n=e.elements,r=i[0],a=i[1],s=i[2],o=r*r+a*a+s*s;o>0&&(o=1/Math.sqrt(o),n[0]=i[0]*o,n[1]=i[1]*o,n[2]=i[2]*o)},t.multiply=function(t,e,i){var n=i.elements,r=t.elements,a=e.elements;n[0]=r[0]*a[0],n[1]=r[1]*a[1],n[2]=r[2]*a[2]},t.scale=function(t,e,i){var n=i.elements,r=t.elements;n[0]=r[0]*e,n[1]=r[1]*e,n[2]=r[2]*e},t.lerp=function(t,e,i,n){var r=n.elements,a=t.elements,s=e.elements,o=a[0],l=a[1],h=a[2];r[0]=o+i*(s[0]-o),r[1]=l+i*(s[1]-l),r[2]=h+i*(s[2]-h)},t.transformV3ToV3=function(e,i,n){var r=t._tempVector4;t.transformV3ToV4(e,i,r);var a=r.elements,s=n.elements;s[0]=a[0],s[1]=a[1],s[2]=a[2]},t.transformV3ToV4=function(t,e,i){var n=t.elements,r=n[0],a=n[1],s=n[2],o=e.elements,l=i.elements;l[0]=r*o[0]+a*o[4]+s*o[8]+o[12],l[1]=r*o[1]+a*o[5]+s*o[9]+o[13],l[2]=r*o[2]+a*o[6]+s*o[10]+o[14],l[3]=r*o[3]+a*o[7]+s*o[11]+o[15]},t.TransformNormal=function(t,e,i){var n=t.elements,r=n[0],a=n[1],s=n[2],o=e.elements,l=i.elements;l[0]=r*o[0]+a*o[4]+s*o[8],l[1]=r*o[1]+a*o[5]+s*o[9],l[2]=r*o[2]+a*o[6]+s*o[10]},t.transformCoordinate=function(e,i,n){var r=t._tempVector4.elements,a=e.elements,s=a[0],o=a[1],l=a[2],h=i.elements;r[0]=s*h[0]+o*h[4]+l*h[8]+h[12],r[1]=s*h[1]+o*h[5]+l*h[9]+h[13],r[2]=s*h[2]+o*h[6]+l*h[10]+h[14],r[3]=1/(s*h[3]+o*h[7]+l*h[11]+h[15]);var u=n.elements;u[0]=r[0]*r[3],u[1]=r[1]*r[3],u[2]=r[2]*r[3]},t.Clamp=function(t,e,i,n){var r=t.elements,a=r[0],s=r[1],o=r[2],l=e.elements,h=l[0],u=l[1],_=l[2],c=i.elements,d=c[0],f=c[1],m=c[2],p=n.elements;a=a>d?d:a,a=a<h?h:a,s=s>f?f:s,s=s<u?u:s,o=o>m?m:o,o=o<_?_:o,p[0]=a,p[1]=s,p[2]=o},t.add=function(t,e,i){var n=i.elements,r=t.elements,a=e.elements;n[0]=r[0]+a[0],n[1]=r[1]+a[1],n[2]=r[2]+a[2]},t.subtract=function(t,e,i){var n=i.elements,r=t.elements,a=e.elements;n[0]=r[0]-a[0],n[1]=r[1]-a[1],n[2]=r[2]-a[2]},t.cross=function(t,e,i){var n=t.elements,r=e.elements,a=i.elements,s=n[0],o=n[1],l=n[2],h=r[0],u=r[1],_=r[2];a[0]=o*_-l*u,a[1]=l*h-s*_,a[2]=s*u-o*h},t.dot=function(t,e){var i=t.elements,n=e.elements;return i[0]*n[0]+i[1]*n[1]+i[2]*n[2]},t.equals=function(t,e){var i=t.elements,n=e.elements;return Me.nearEqual(Math.abs(i[0]),Math.abs(n[0]))&&Me.nearEqual(Math.abs(i[1]),Math.abs(n[1]))&&Me.nearEqual(Math.abs(i[2]),Math.abs(n[2]))},n(t,["_tempVector4",function(){return this._tempVector4=new Le},"ZERO",function(){return this.ZERO=new t(0,0,0)},"ONE",function(){return this.ONE=new t(1,1,1)},"NegativeUnitX",function(){return this.NegativeUnitX=new t(-1,0,0)},"UnitX",function(){return this.UnitX=new t(1,0,0)},"UnitY",function(){return this.UnitY=new t(0,1,0)},"UnitZ",function(){return this.UnitZ=new t(0,0,1)},"ForwardRH",function(){return this.ForwardRH=new t(0,0,-1)},"ForwardLH",function(){return this.ForwardLH=new t(0,0,1)},"Up",function(){return this.Up=new t(0,1,0)},"NAN",function(){return this.NAN=new t(NaN,NaN,NaN)}]),t}(),Le=function(){function t(t,e,i,n){this.elements=new Float32Array(4),void 0===t&&(t=0),void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=0);var r=this.elements;r[0]=t,r[1]=e,r[2]=i,r[3]=n}r(t,"laya.d3.math.Vector4");var e=t.prototype;return i.imps(e,{"laya.d3.core.IClone":!0}),e.fromArray=function(t,e){void 0===e&&(e=0),this.elements[0]=t[e+0],this.elements[1]=t[e+1],this.elements[2]=t[e+2],this.elements[3]=t[e+3]},e.cloneTo=function(t){var e=t,i=e.elements,n=this.elements;i[0]=n[0],i[1]=n[1],i[2]=n[2],i[3]=n[3]},e.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},e.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},e.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},a(0,e,"x",function(){return this.elements[0]},function(t){this.elements[0]=t}),a(0,e,"y",function(){return this.elements[1]},function(t){this.elements[1]=t}),a(0,e,"z",function(){return this.elements[2]},function(t){this.elements[2]=t}),a(0,e,"w",function(){return this.elements[3]},function(t){this.elements[3]=t}),t.lerp=function(t,e,i,n){var r=n.elements,a=t.elements,s=e.elements,o=a[0],l=a[1],h=a[2],u=a[3];r[0]=o+i*(s[0]-o),r[1]=l+i*(s[1]-l),r[2]=h+i*(s[2]-h),r[3]=u+i*(s[3]-u)},t.transformByM4x4=function(t,e,i){var n=t.elements,r=n[0],a=n[1],s=n[2],o=n[3],l=e.elements,h=i.elements;h[0]=r*l[0]+a*l[4]+s*l[8]+o*l[12],h[1]=r*l[1]+a*l[5]+s*l[9]+o*l[13],h[2]=r*l[2]+a*l[6]+s*l[10]+o*l[14],h[3]=r*l[3]+a*l[7]+s*l[11]+o*l[15]},t.equals=function(t,e){var i=t.elements,n=e.elements;return Me.nearEqual(Math.abs(i[0]),Math.abs(n[0]))&&Me.nearEqual(Math.abs(i[1]),Math.abs(n[1]))&&Me.nearEqual(Math.abs(i[2]),Math.abs(n[2]))&&Me.nearEqual(Math.abs(i[3]),Math.abs(n[3]))},t.normalize=function(t,e){var i=t.elements,n=e.elements,r=t.length();r>0&&(n[0]=i[0]*r,n[1]=i[1]*r,n[2]=i[2]*r,n[3]=i[3]*r)},t.add=function(t,e,i){var n=i.elements,r=t.elements,a=e.elements;n[0]=r[0]+a[0],n[1]=r[1]+a[1],n[2]=r[2]+a[2],n[3]=r[3]+a[3]},t.subtract=function(t,e,i){var n=i.elements,r=t.elements,a=e.elements;n[0]=r[0]-a[0],n[1]=r[1]-a[1],n[2]=r[2]-a[2],n[3]=r[3]-a[3]},t.multiply=function(t,e,i){var n=i.elements,r=t.elements,a=e.elements;n[0]=r[0]*a[0],n[1]=r[1]*a[1],n[2]=r[2]*a[2],n[3]=r[3]*a[3]},t.scale=function(t,e,i){var n=i.elements,r=t.elements;n[0]=r[0]*e,n[1]=r[1]*e,n[2]=r[2]*e,n[3]=r[3]*e},t.Clamp=function(t,e,i,n){var r=t.elements,a=r[0],s=r[1],o=r[2],l=r[3],h=e.elements,u=h[0],_=h[1],c=h[2],d=h[3],f=i.elements,m=f[0],p=f[1],v=f[2],g=f[3],E=n.elements;a=a>m?m:a,a=a<u?u:a,s=s>p?p:s,s=s<_?_:s,o=o>v?v:o,o=o<c?c:o,l=l>g?g:l,l=l<d?d:l,E[0]=a,E[1]=s,E[2]=o,E[3]=l},t.distanceSquared=function(t,e){var i=t.elements,n=e.elements,r=i[0]-n[0],a=i[1]-n[1],s=i[2]-n[2],o=i[3]-n[3];return r*r+a*a+s*s+o*o},t.distance=function(t,e){var i=t.elements,n=e.elements,r=i[0]-n[0],a=i[1]-n[1],s=i[2]-n[2],o=i[3]-n[3];return Math.sqrt(r*r+a*a+s*s+o*o)},t.dot=function(t,e){var i=t.elements,n=e.elements;return i[0]*n[0]+i[1]*n[1]+i[2]*n[2]+i[3]*n[3]},t.min=function(t,e,i){var n=i.elements,r=t.elements,a=e.elements;n[0]=Math.min(r[0],a[0]),n[1]=Math.min(r[1],a[1]),n[2]=Math.min(r[2],a[2]),n[3]=Math.min(r[3],a[3])},t.max=function(t,e,i){var n=i.elements,r=t.elements,a=e.elements;n[0]=Math.max(r[0],a[0]),n[1]=Math.max(r[1],a[1]),n[2]=Math.max(r[2],a[2]),n[3]=Math.max(r[3],a[3])},n(t,["ZERO",function(){return this.ZERO=new t},"ONE",function(){return this.ONE=new t(1,1,1,1)},"UnitX",function(){return this.UnitX=new t(1,0,0,0)},"UnitY",function(){return this.UnitY=new t(0,1,0,0)},"UnitZ",function(){return this.UnitZ=new t(0,0,1,0)},"UnitW",function(){return this.UnitW=new t(0,0,0,1)}]),t}(),Oe=function(){function t(t,e,i,n){this.minDepth=0,this.maxDepth=1,this.x=t,this.y=e,this.width=i,this.height=n}r(t,"laya.d3.math.Viewport");var e=t.prototype;return e.project=function(t,e,i){Pe.transformV3ToV3(t,e,i);var n=t.elements,r=e.elements,a=i.elements,s=n[0]*r[3]+n[1]*r[7]+n[2]*r[11]+r[15];1!==s&&(a[0]=a[0]/s,a[1]=a[1]/s,a[2]=a[2]/s),a[0]=.5*(a[0]+1)*this.width+this.x,a[1]=.5*(1-a[1])*this.height+this.y,a[2]=a[2]*(this.maxDepth-this.minDepth)+this.minDepth},e.unprojectFromMat=function(t,e,i){var n=t.elements,r=e.elements,a=i.elements;a[0]=(n[0]-this.x)/this.width*2-1,a[1]=-((n[1]-this.y)/this.height*2-1);var s=(this.maxDepth-this.minDepth)/2;a[2]=(n[2]-this.minDepth-s)/s;var o=a[0]*r[3]+a[1]*r[7]+a[2]*r[11]+r[15];Pe.transformV3ToV3(i,e,i),1!==o&&(a[0]=a[0]/o,a[1]=a[1]/o,a[2]=a[2]/o)},e.unprojectFromWVP=function(e,i,n,r,a){Ae.multiply(i,n,t._tempMatrix4x4),r&&Ae.multiply(t._tempMatrix4x4,r,t._tempMatrix4x4),t._tempMatrix4x4.invert(t._tempMatrix4x4),this.unprojectFromMat(e,t._tempMatrix4x4,a)},n(t,["_tempMatrix4x4",function(){return this._tempMatrix4x4=new Ae}]),t}(),Ve=function(){function t(){this._alphaBlending=1,this._colorIntensity=1,this._shaderValue=new He,D.isConchNode&&(this._conchSky=new ConchSkyMesh)}r(t,"laya.d3.resource.models.Sky");var e=t.prototype;return e._setEnvironmentDiffuse=function(){this._environmentDiffuse.loaded?this.__ownerCamera._shaderValues.setValue(7,this._environmentDiffuse):this._environmentDiffuse.on("loaded",this,this._environmentDiffuseLoaded)},e._setEnvironmentSpecular=function(){if(this._environmentSpecular.loaded){var t=this._environmentSpecular.simLodInfo;t&&t instanceof Float32Array&&this.__ownerCamera._shaderValues.setValue(9,t),this.__ownerCamera._shaderValues.setValue(8,this._environmentSpecular)}else this._environmentSpecular.on("loaded",this,this._environmentSpecularLoaded)},e._environmentDiffuseLoaded=function(){this.__ownerCamera._shaderValues.setValue(7,this._environmentDiffuse)},e._environmentSpecularLoaded=function(){var t=this._environmentSpecular.simLodInfo;t&&t instanceof Float32Array&&this.__ownerCamera._shaderValues.setValue(9,t),this.__ownerCamera._shaderValues.setValue(8,this._environmentSpecular)},e._render=function(t){},e.destroy=function(){this.__ownerCamera=null},a(0,e,"_ownerCamera",null,function(t){this.__ownerCamera=t,this._environmentDiffuse&&this._setEnvironmentDiffuse(),this._environmentSpecular&&this._setEnvironmentSpecular()}),a(0,e,"alphaBlending",function(){return this._alphaBlending},function(t){this._alphaBlending=t,this._alphaBlending<0&&(this._alphaBlending=0),this._alphaBlending>1&&(this._alphaBlending=1),this._conchSky&&this._conchSky.setShaderValue(2,this._alphaBlending,2)}),a(0,e,"envDiffuseSHBlue",null,function(t){this.__ownerCamera._shaderValues.setValue(12,t)}),a(0,e,"colorIntensity",function(){return this._colorIntensity},function(t){this._colorIntensity=t,this._colorIntensity<0&&(this._colorIntensity=0),this._conchSky&&this._conchSky.setShaderValue(1,this._colorIntensity,2)}),a(0,e,"envDiffuseSHGreen",null,function(t){this.__ownerCamera._shaderValues.setValue(11,t)}),a(0,e,"envDiffuseSHRed",null,function(t){this.__ownerCamera._shaderValues.setValue(10,t)}),a(0,e,"environmentDiffuse",function(){return this._environmentDiffuse},function(t){t.minFifter=9728,this._environmentDiffuse=t,this.__ownerCamera&&this._setEnvironmentDiffuse()}),a(0,e,"environmentSpecular",function(){return this._environmentSpecular},function(t){this._environmentSpecular=t,this.__ownerCamera&&this._setEnvironmentSpecular()}),t.MVPMATRIX=0,t.INTENSITY=1,t.ALPHABLENDING=2,t.DIFFUSETEXTURE=3,t}(),Fe=function(){function t(t){this._mesh=null,this._boneIndicesList=null,this._subIndexBufferStart=null,this._subIndexBufferCount=null,this._skinAnimationDatas=null,this._bufferUsage=null,this._indexInMesh=0,this._vertexBuffer=null,this._vertexStart=0,this._vertexCount=0,this._indexBuffer=null,this._indexStart=0,this._indexCount=0,this._indices=null,this._bufferUsage={},this._mesh=t,this._boneIndicesList=[],this._subIndexBufferStart=[],this._subIndexBufferCount=[]}r(t,"laya.d3.resource.models.SubMesh");var e=t.prototype;return i.imps(e,{"laya.d3.core.render.IRenderable":!0,"laya.resource.IDispose":!0}),e._getVertexBuffer=function(t){return void 0===t&&(t=0),0===t?this._vertexBuffer:null},e._getIndexBuffer=function(){return this._indexBuffer},e._getStaticBatchBakedVertexs=function(e,i){var n,r,a=this._vertexBuffer,s=a.vertexDeclaration,o=s.getVertexElementByUsage(0).offset/4,l=s.getVertexElementByUsage(3).offset/4,h=i.meshRender.lightmapScaleOffset,u=0,_=0,c=0,d=0,f=0,m=0;if(h)if(r=s.getVertexElementByUsage(15))c=s.vertexStride/4,n=this._vertexCount>0?a.getData().slice(this._vertexStart*c,(this._vertexStart+this._vertexCount)*c):a.getData().slice(),d=r.offset/4;else{m=s.vertexStride/4,c=m+2,n=this._vertexCount?new Float32Array(this._vertexCount*(a.vertexDeclaration.vertexStride/4+2)):new Float32Array(a.vertexCount*(a.vertexDeclaration.vertexStride/4+2)),f=s.getVertexElementByUsage(2).offset/4,d=f+2;var p=a.getData();for(u=0,_=p.length/m;u<_;u++){var v=0;v=this._vertexCount>0?(this._vertexStart+u)*m:u*m;var g=u*c,E=0;for(E=0;E<d;E++)n[g+E]=p[v+E];for(E=d;E<m;E++)n[g+E+2]=p[v+E]}}else c=s.vertexStride/4,n=this._vertexCount?a.getData().slice(this._vertexStart*c,(this._vertexStart+this._vertexCount)*c):a.getData().slice();if(e){var x=e.worldMatrix,T=t._tempMatrix4x40;x.invert(T);var S=t._tempMatrix4x41,D=i.transform.worldMatrix;Ae.multiply(T,D,S)}else S=i.transform.worldMatrix;var M=t._tempQuaternion0;for(S.decomposeTransRotScale(t._tempVector30,M,t._tempVector31),u=0,_=n.length/c;u<_;u++){var y=u*c+o,A=u*c+l;if(qe.transformVector3ArrayToVector3ArrayCoordinate(n,y,S,n,y),qe.transformVector3ArrayByQuat(n,A,M,n,A),h){var I=u*c+d;if(r)qe.transformLightingMapTexcoordByUV1Array(n,I,h,n,I);else{var R=u*m+f;qe.transformLightingMapTexcoordByUV0Array(p,R,h,n,I)}}}return n},e._getVertexBuffers=function(){return null},e._beforeRender=function(t){return this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},e._render=function(t){var e,i=0,n=t.renderElement;if(this._indexCount>1){var r=this._boneIndicesList.length;if(r>1){for(var a=0;a<r;a++)e=n._skinAnimationDatas||this._skinAnimationDatas,e&&(n._shaderValue.setValue(0,e[a]),t._shader.uploadRenderElementUniforms(n._shaderValue.data)),P.mainContext.drawElements(4,this._subIndexBufferCount[a],5123,2*this._subIndexBufferStart[a]);C.drawCall+=r}else e=n._skinAnimationDatas||this._skinAnimationDatas,e&&(n._shaderValue.setValue(0,e[0]),t._shader.uploadRenderElementUniforms(n._shaderValue.data)),P.mainContext.drawElements(4,this._indexCount,5123,2*this._indexStart),C.drawCall++;i=this._indexCount}else i=this._indexBuffer.indexCount,e=n._skinAnimationDatas||this._skinAnimationDatas,e&&(n._shaderValue.setValue(0,e[0]),t._shader.uploadRenderElementUniforms(n._shaderValue.data)),P.mainContext.drawElements(4,i,5123,0),C.drawCall++;C.trianglesFaces+=i/3},e.getIndices=function(){return this._indexCount>0?this._indices:this._indexBuffer.getData()},e.dispose=function(){this._indexBuffer.destroy(),this._vertexBuffer.destroy(),this._mesh=null,this._boneIndicesList=null,this._subIndexBufferStart=null,this._subIndexBufferCount=null,this._skinAnimationDatas=null,this._bufferUsage=null,this._vertexBuffer=null,this._indexBuffer=null},e._renderRuntime=function(t,e,i){e._material,e._sprite3D;t.drawSubmesh(e._conchSubmesh,0,4,0,this._indexBuffer.indexCount)},a(0,e,"_vertexBufferCount",function(){return 1}),a(0,e,"triangleCount",function(){return this._indexBuffer.indexCount/3}),n(t,["_tempVector30",function(){return this._tempVector30=new Pe},"_tempVector31",function(){return this._tempVector31=new Pe},"_tempQuaternion0",function(){return this._tempQuaternion0=new Ce},"_tempMatrix4x40",function(){return this._tempMatrix4x40=new Ae},"_tempMatrix4x41",function(){return this._tempMatrix4x41=new Ae}]),t}(),Be=function(){function t(t){this.defineCounter=0,this.defines=null,t?(this.defineCounter=t.defineCounter,this.defines=t.defines.slice()):(this.defineCounter=0,this.defines=[])}return r(t,"laya.d3.shader.ShaderDefines",null,"ShaderDefines$1"),t.prototype.registerDefine=function(t){var e=Math.pow(2,this.defineCounter++);return this.defines[e]=t,e},t}(),Ue=function(){function t(){}return r(t,"laya.d3.shader.ShaderInit3D"),t.__init__=function(){ui._globalRegDefine("HIGHPRECISION",ui.SHADERDEFINE_HIGHPRECISION),ui._globalRegDefine("FOG",ui.SHADERDEFINE_FOG),ui._globalRegDefine("DIRECTIONLIGHT",ui.SHADERDEFINE_DIRECTIONLIGHT),ui._globalRegDefine("POINTLIGHT",ui.SHADERDEFINE_POINTLIGHT),ui._globalRegDefine("SPOTLIGHT",ui.SHADERDEFINE_SPOTLIGHT),ui._globalRegDefine("UV",ui.SHADERDEFINE_UV0),ui._globalRegDefine("COLOR",ui.SHADERDEFINE_COLOR),ui._globalRegDefine("UV1",ui.SHADERDEFINE_UV1),ui._globalRegDefine("CASTSHADOW",Ge.SHADERDEFINE_CAST_SHADOW),ui._globalRegDefine("SHADOWMAP_PSSM1",Ge.SHADERDEFINE_SHADOW_PSSM1),ui._globalRegDefine("SHADOWMAP_PSSM2",Ge.SHADERDEFINE_SHADOW_PSSM2),ui._globalRegDefine("SHADOWMAP_PSSM3",Ge.SHADERDEFINE_SHADOW_PSSM3),ui._globalRegDefine("SHADOWMAP_PCF_NO",Ge.SHADERDEFINE_SHADOW_PCF_NO),ui._globalRegDefine("SHADOWMAP_PCF1",Ge.SHADERDEFINE_SHADOW_PCF1),ui._globalRegDefine("SHADOWMAP_PCF2",Ge.SHADERDEFINE_SHADOW_PCF2),ui._globalRegDefine("SHADOWMAP_PCF3",Ge.SHADERDEFINE_SHADOW_PCF3),ui._globalRegDefine("DEPTHFOG",ui.SAHDERDEFINE_DEPTHFOG),Fi.addInclude("LightHelper.glsl","\nstruct DirectionLight\n{\n vec3 Direction;\n vec3 Diffuse;\n};\n\nstruct PointLight\n{\n vec3 Diffuse;\n vec3 Attenuation;\n vec3 Position;\n float Range;\n};\n\nstruct SpotLight\n{\n vec3 Diffuse;\n vec3 Attenuation;\n vec3 Position;\n vec3 Direction;\n float Spot;\n float Range;\n};\n\n\nvec3 NormalSampleToWorldSpace(vec3 normalMapSample, vec3 unitNormal, vec3 tangent)\n{\n\tvec3 normalT = 2.0*normalMapSample - 1.0;\n\n\t// Build orthonormal basis.\n\tvec3 N = normalize(unitNormal);\n\tvec3 T = normalize(tangent- dot(tangent, N)*N);\n\tvec3 B = cross(T, N);\n\n\tmat3 TBN = mat3(T, B, N);\n\n\t// Transform from tangent space to world space.\n\tvec3 bumpedNormal = TBN*normalT;\n\n\treturn bumpedNormal;\n}\n\n\nvoid  computeDirectionLight(in vec3 matDif,in vec3 matAmb,in vec4 matSpe,in DirectionLight dirLight,in vec3 ambinentColor,in vec3 normal,in vec3 toEye,out vec3 dif,out vec3 amb,out vec3 spec)\n{\n\tdif=vec3(0.0);//不初始化在IOS中闪烁，PC中不会闪烁\n\tamb=vec3(0.0);\n\tspec=vec3(0.0);\n\tvec3 lightVec=-normalize(dirLight.Direction);\n\t\n\tamb=matAmb*ambinentColor;\n\t\n\tfloat  diffuseFactor=dot(lightVec, normal);\n\t\n\tif(diffuseFactor>0.0)\n\t{\n\t   vec3 v = reflect(-lightVec, normal);\n\t   float specFactor = pow(max(dot(v, toEye), 0.0), matSpe.w);\n\t   \n\t   dif = diffuseFactor * matDif * dirLight.Diffuse;\n\t   spec = specFactor * matSpe.rgb;\n\t}\n\t\n}\n\nvoid computePointLight(in vec3 matDif,in vec3 matAmb,in vec4 matSpe,in PointLight poiLight,in vec3 ambinentColor, in vec3 pos,in vec3 normal,in vec3 toEye,out vec3 dif,out vec3 amb,out vec3 spec)\n{\n\tdif=vec3(0.0);\n\tamb=vec3(0.0);\n\tspec=vec3(0.0);\n\tvec3 lightVec = poiLight.Position - pos;\n\t\t\n\tfloat d = length(lightVec);\n\t\n\tif( d > poiLight.Range )\n\t\treturn;\n\t\t\n\tlightVec /= d; \n\t\n\tamb = matAmb*ambinentColor;\t\n\n\tfloat diffuseFactor = dot(lightVec, normal);\n\n\tif( diffuseFactor > 0.0 )\n\t{\n\t\tvec3 v= reflect(-lightVec, normal);\n\t\tfloat specFactor = pow(max(dot(v, toEye), 0.0), matSpe.w);\n\t\t\t\t\t\n\t\tdif = diffuseFactor * matDif * poiLight.Diffuse;\n\t\tspec = specFactor * matSpe.rgb;\n\t}\n\n\tfloat attenuate = 1.0 / dot(poiLight.Attenuation, vec3(1.0, d, d*d));\n\n\tdif *= attenuate;\n\tspec*= attenuate;\n}\n\nvoid ComputeSpotLight(in vec3 matDif,in vec3 matAmb,in vec4 matSpe,in SpotLight spoLight,in vec3 ambinentColor,in vec3 pos, in vec3 normal,in vec3 toEye,out vec3 dif,out vec3 amb,out vec3 spec)\n{\n\tamb = vec3(0.0);\n\tdif =vec3(0.0);\n\tspec= vec3(0.0);\n\tvec3 lightVec = spoLight.Position - pos;\n\t\t\n\tfloat d = length(lightVec);\n\t\n\tif( d > spoLight.Range)\n\t\treturn;\n\t\t\n\tlightVec /= d; \n\t\n\tamb = matAmb*ambinentColor;\t\n\n\tfloat diffuseFactor = dot(lightVec, normal);\n\n\tif(diffuseFactor > 0.0)\n\t{\n\t\tvec3 v= reflect(-lightVec, normal);\n\t\tfloat specFactor = pow(max(dot(v, toEye), 0.0), matSpe.w);\n\t\t\t\t\t\n\t\tdif = diffuseFactor * matDif * spoLight.Diffuse;\n\t\tspec = specFactor * matSpe.rgb;\n\t}\n\t\n\tfloat spot = pow(max(dot(-lightVec, normalize(spoLight.Direction)), 0.0), spoLight.Spot);\n\n\tfloat attenuate = spot/dot(spoLight.Attenuation, vec3(1.0, d, d*d));\n\n\tamb *= spot;\n\tdif *= attenuate;\n\tspec*= attenuate;\n}\n\n"),Fi.addInclude("Lighting.glsl","\nstruct DirectionLight\n{\n\tvec3 Color;\n\tvec3 Direction;\n};\n\nstruct PointLight\n{\n\tvec3 Color;\n\tvec3 Position;\n\tfloat Range;\n};\n\nstruct SpotLight\n{\n\tvec3 Color;\n\tvec3 Position;\n\tvec3 Direction;\n\tfloat Spot;\n\tfloat Range;\n};\n\n// U3D中使用衰减纹理,此函数模拟并非正确\n//float U3DAttenuation(in vec3 L,in float invLightRadius)\n//{\n//\tfloat fRatio = clamp(length(L) * invLightRadius,0.0,1.0);\n//\tfRatio *= fRatio;\n//\treturn 1.0 / (1.0 + 25.0 * fRatio)* clamp(4.0*(1.0 - fRatio),0.0,1.0); //fade to black as if 4 pixel texture\n//} \n\n// Same as Just Cause 2 and Crysis 2 (you can read GPU Pro 1 book for more information)\nfloat BasicAttenuation(in vec3 L,in float invLightRadius)\n{\n\tvec3 distance = L * invLightRadius;\n\tfloat attenuation = clamp(1.0 - dot(distance, distance),0.0,1.0); // Equals float attenuation = saturate(1.0f - dot(L, L) / (lightRadius *  lightRadius)); \t\n\treturn attenuation * attenuation;\n} \n\n// Inspired on http://fools.slindev.com/viewtopic.php?f=11&t=21&view=unread#unread\t\nfloat NaturalAttenuation(in vec3 L,in float invLightRadius)\n{\n\tfloat attenuationFactor = 30.0;\n\tvec3 distance = L * invLightRadius;\n\tfloat attenuation = dot(distance, distance); // Equals float attenuation = dot(L, L) / (lightRadius *  lightRadius);\n\tattenuation = 1.0 / (attenuation * attenuationFactor + 1.0);\n\t// Second we move down the function therewith it reaches zero at abscissa 1:\n\tattenuationFactor = 1.0 / (attenuationFactor + 1.0); //attenuationFactor contains now the value we have to subtract\n\tattenuation = max(attenuation - attenuationFactor, 0.0); // The max fixes a bug.\n\t// Finally we expand the equation along the y-axis so that it starts with a function value of 1 again.\n\tattenuation /= 1.0 - attenuationFactor;\n\treturn attenuation;\n} \n\nvoid LayaAirBlinnPhongLight (in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir,in vec3 lightColor, in vec3 lightVec,out vec3 diffuseColor,out vec3 specularColor)\n{\n    mediump vec3 h = normalize(viewDir-lightVec);\n    lowp float ln = max (0.0, dot (-lightVec,normal));\n    float nh = max (0.0, dot (h,normal));\n\tdiffuseColor=lightColor * ln;\n\tspecularColor=lightColor *specColor*pow (nh, specColorIntensity*128.0) * gloss;\n}\n\nvoid LayaAirBlinnPhongDiectionLight (in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in DirectionLight light,out vec3 diffuseColor,out vec3 specularColor)\n{\n\tvec3 lightVec=normalize(light.Direction);\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.Color,lightVec,diffuseColor,specularColor);\n}\n\nvoid LayaAirBlinnPhongPointLight (in vec3 pos,in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in PointLight light,out vec3 diffuseColor,out vec3 specularColor)\n{\n\tvec3 lightVec =  pos-light.Position;\n\t//if( length(lightVec) > light.Range )\n\t//\treturn;\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.Color,lightVec/length(lightVec),diffuseColor,specularColor);\n\tfloat attenuate = BasicAttenuation(lightVec, 1.0/light.Range);\n\tdiffuseColor *= attenuate;\n\tspecularColor*= attenuate;\n}\n\nvoid LayaAirBlinnPhongSpotLight (in vec3 pos,in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in SpotLight light,out vec3 diffuseColor,out vec3 specularColor)\n{\n\tvec3 lightVec =  pos-light.Position;\n\t//if( length(lightVec) > light.Range )\n\t//\treturn;\n\tvec3 normalLightVec=lightVec/length(lightVec);\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.Color,normalLightVec,diffuseColor,specularColor);\n\tfloat spot = pow(max(dot(normalLightVec, normalize(light.Direction)), 0.0), light.Spot);\n\tfloat attenuate = spot*BasicAttenuation(lightVec, 1.0/light.Range);\n\tdiffuseColor *= attenuate;\n\tspecularColor*= attenuate;\n}\n\nvec3 NormalSampleToWorldSpace(vec3 normalMapSample, vec3 unitNormal, vec3 tangent,vec3 binormal)\n{\n\tvec3 normalT =vec3(2.0*normalMapSample.x - 1.0,1.0-2.0*normalMapSample.y,2.0*normalMapSample.z - 1.0);\n\t\n\t// Build orthonormal basis.\n\tvec3 N = normalize(unitNormal);\n\tvec3 T = normalize(tangent);\n\tvec3 B = normalize(binormal);\n\tmat3 TBN = mat3(T, B, N);\n\t\n\t// Transform from tangent space to world space.\n\tvec3 bumpedNormal = TBN*normalT;\n\n\treturn bumpedNormal;\n}\n\n\n"),Fi.addInclude("ShadowHelper.glsl","uniform sampler2D u_shadowMap1;\nuniform sampler2D u_shadowMap2;\nuniform sampler2D u_shadowMap3;\nuniform vec2\t  u_shadowPCFoffset;\nuniform vec4     u_shadowPSSMDistance;\nvec4 packDepth(const in float depth)\n{\n\tconst vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);\n\tconst vec4 bitMask\t= vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);\n\tvec4 res = mod(depth*bitShift*vec4(255), vec4(256))/vec4(255);\n\tres -= res.xxyz * bitMask;\n\treturn res;\n}\nfloat unpackDepth(const in vec4 rgbaDepth)\n{\n\tconst vec4 bitShift = vec4(1.0/(256.0*256.0*256.0), 1.0/(256.0*256.0), 1.0/256.0, 1.0);\n\tfloat depth = dot(rgbaDepth, bitShift);\n\treturn depth;\n}\nfloat tex2DPCF( sampler2D shadowMap,vec2 texcoord,vec2 invsize,float zRef )\n{\n\tvec2 texelpos =texcoord / invsize;\n\tvec2 lerps = fract( texelpos );\n\tfloat sourcevals[4];\n\tsourcevals[0] = float( unpackDepth(texture2D(shadowMap,texcoord)) > zRef );\n\tsourcevals[1] = float( unpackDepth(texture2D(shadowMap,texcoord + vec2(invsize.x,0))) > zRef );\n\tsourcevals[2] = float( unpackDepth(texture2D(shadowMap,texcoord + vec2(0,invsize.y))) > zRef );\n\tsourcevals[3] = float( unpackDepth(texture2D(shadowMap,texcoord + vec2(invsize.x, invsize.y) )) > zRef );\n\treturn mix( mix(sourcevals[0],sourcevals[2],lerps.y),mix(sourcevals[1],sourcevals[3],lerps.y),lerps.x );\n}\nfloat getShadowPSSM3( sampler2D shadowMap1,sampler2D shadowMap2,sampler2D shadowMap3,mat4 lightShadowVP[4],vec4 pssmDistance,vec2 shadowPCFOffset,vec3 worldPos,float posViewZ,float zBias )\n{\n\tfloat value = 1.0;\n\tint nPSNum = int(posViewZ>pssmDistance.x);\n\tnPSNum += int(posViewZ>pssmDistance.y);\n\tnPSNum += int(posViewZ>pssmDistance.z);\n\t//真SB,webgl不支持在PS中直接访问数组\n\tmat4 lightVP;\n\tif( nPSNum == 0 )\n\t{\n\t\tlightVP = lightShadowVP[1];\n\t}\n\telse if( nPSNum == 1 )\n\t{\n\t\tlightVP = lightShadowVP[2];\n\t}\n\telse if( nPSNum == 2 )\n\t{\n\t\tlightVP = lightShadowVP[3];\n\t}\n\tvec4 vLightMVPPos = lightVP * vec4(worldPos,1.0);\n\t//为了效率，在CPU计算/2.0 + 0.5\n\t//vec3 vText = (vLightMVPPos.xyz / vLightMVPPos.w)/2.0 + 0.5;\n\tvec3 vText = vLightMVPPos.xyz / vLightMVPPos.w;\n\tfloat fMyZ = vText.z - zBias;\n\t/*\n\tbvec4 bInFrustumVec = bvec4 ( vText.x >= 0.0, vText.x <= 1.0, vText.y >= 0.0, vText.y <= 1.0 );\n\tbool bInFrustum = all( bInFrustumVec );\n\tbvec2 bFrustumTestVec = bvec2( bInFrustum, fMyZ <= 1.0 );\n\tbool bFrustumTest = all( bFrustumTestVec );\n\tif ( bFrustumTest ) \n\t*/\n\tif( fMyZ <= 1.0 )\n\t{\n\t\tfloat zdepth=0.0;\n#ifdef SHADOWMAP_PCF3\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue =  tex2DPCF( shadowMap1, vText.xy,shadowPCFOffset,fMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.xy),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.x,0),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(0,shadowPCFOffset.y),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue = value/4.0;\n\t\t} \n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 2 )\n\t\t{\n\t\t\tvec4 color = texture2D( shadowMap3,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF2\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 2 )\n\t\t{\n\t\t\tvec4 color = texture2D( shadowMap3,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n\t\t}\n\n#endif\n#ifdef SHADOWMAP_PCF1\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvec4 color = texture2D( shadowMap2,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n\t\t}\n\t\telse if( nPSNum == 2 )\n\t\t{\n\t\t\tvec4 color = texture2D( shadowMap3,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF_NO\n\t\tvec4 color;\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tcolor = texture2D( shadowMap1,vText.xy );\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tcolor = texture2D( shadowMap2,vText.xy );\n\t\t}\n\t\telse if( nPSNum == 2 )\n\t\t{\n\t\t\tcolor = texture2D( shadowMap3,vText.xy );\n\t\t}\n\t\tzdepth = unpackDepth(color);\n\t\tvalue = float(fMyZ < zdepth);\n#endif\n\t}\n\treturn value;\n}\nfloat getShadowPSSM2( sampler2D shadowMap1,sampler2D shadowMap2,mat4 lightShadowVP[4],vec4 pssmDistance,vec2 shadowPCFOffset,vec3 worldPos,float posViewZ,float zBias )\n{\n\tfloat value = 1.0;\n\tint nPSNum = int(posViewZ>pssmDistance.x);\n\tnPSNum += int(posViewZ>pssmDistance.y);\n\t//真SB,webgl不支持在PS中直接访问数组\n\tmat4 lightVP;\n\tif( nPSNum == 0 )\n\t{\n\t\tlightVP = lightShadowVP[1];\n\t}\n\telse if( nPSNum == 1 )\n\t{\n\t\tlightVP = lightShadowVP[2];\n\t}\n\tvec4 vLightMVPPos = lightVP * vec4(worldPos,1.0);\n\t//为了效率，在CPU计算/2.0 + 0.5\n\t//vec3 vText = (vLightMVPPos.xyz / vLightMVPPos.w)/2.0 + 0.5;\n\tvec3 vText = vLightMVPPos.xyz / vLightMVPPos.w;\n\tfloat fMyZ = vText.z - zBias;\n\t/*\n\tbvec4 bInFrustumVec = bvec4 ( vText.x >= 0.0, vText.x <= 1.0, vText.y >= 0.0, vText.y <= 1.0 );\n\tbool bInFrustum = all( bInFrustumVec );\n\tbvec2 bFrustumTestVec = bvec2( bInFrustum, fMyZ <= 1.0 );\n\tbool bFrustumTest = all( bFrustumTestVec );\n\tif ( bFrustumTest ) \n\t*/\n\tif( fMyZ <= 1.0 )\n\t{\n\t\tfloat zdepth=0.0;\n#ifdef SHADOWMAP_PCF3\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue =  tex2DPCF( shadowMap1, vText.xy,shadowPCFOffset,fMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.xy),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.x,0),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(0,shadowPCFOffset.y),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue = value/4.0;\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF2\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF1\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvec4 color = texture2D( shadowMap2,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF_NO\n\t\tvec4 color;\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tcolor = texture2D( shadowMap1,vText.xy );\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tcolor = texture2D( shadowMap2,vText.xy );\n\t\t}\n\t\tzdepth = unpackDepth(color);\n\t\tvalue = float(fMyZ < zdepth);\n#endif\n\t}\n\treturn value;\n}\nfloat getShadowPSSM1( sampler2D shadowMap1,vec4 lightMVPPos,vec4 pssmDistance,vec2 shadowPCFOffset,float posViewZ,float zBias )\n{\n\tfloat value = 1.0;\n\tif( posViewZ < pssmDistance.x )\n\t{\n\t\tvec3 vText = lightMVPPos.xyz / lightMVPPos.w;\n\t\tfloat fMyZ = vText.z - zBias;\n\t\t/*\n\t\tbvec4 bInFrustumVec = bvec4 ( vText.x >= 0.0, vText.x <= 1.0, vText.y >= 0.0, vText.y <= 1.0 );\n\t\tbool bInFrustum = all( bInFrustumVec );\n\t\tbvec2 bFrustumTestVec = bvec2( bInFrustum, fMyZ <= 1.0 );\n\t\tbool bFrustumTest = all( bFrustumTestVec );\n\t\t*/\n\t\tif ( fMyZ <= 1.0 ) \n\t\t{\n\t\t\tfloat zdepth=0.0;\n#ifdef SHADOWMAP_PCF3\n\t\t\tvalue =  tex2DPCF( shadowMap1, vText.xy,shadowPCFOffset,fMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.xy),shadowPCFOffset,fMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.x,0),shadowPCFOffset,fMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(0,shadowPCFOffset.y),shadowPCFOffset,fMyZ );\n\t\t\tvalue = value/4.0;\n#endif\n#ifdef SHADOWMAP_PCF2\t\t\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n#endif\n#ifdef SHADOWMAP_PCF1\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n#endif\n#ifdef SHADOWMAP_PCF_NO\t\t\n\t\t\tvec4 color = texture2D( shadowMap1,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n#endif\n\t\t}\n\t}\n\treturn value;\n}"),Fi.addInclude("WaveFunction.glsl","\nuniform vec2 u_WaveInfoD[20];\nuniform vec4 u_WaveInfo[20];\n\nuniform float TEXWAVE_UV_SCALE ;//= 20.0; //每texwidth像素代表的实际距离\n/**\n\t这里的计算都是\n*/\n\n/**\n* 计算一个波形\n*  开始计算的时候都按照z向上，最后输出的时候，颠倒一下。\n* @param tm {float} 毫秒\n*/\nvoid calcGerstnerWave(float curtm, vec3 pos, float deep, vec2 uvpos, out vec3 opos, out vec3 B, out vec3 T, out vec3 N, out float foamS){\n\tfloat tm = curtm/1000.;\n\topos = pos;\n\tvec3 wpos=vec3(0.);\t\t//累加的位置\n\tN=vec3(0.,0.,0.);\t//输出的法线初始化一下\n\tT=vec3(0.,0.,0.);\n\tB=vec3(0.,0.,0.);\n\tvec2 cD ;//= D;\n\t//float deepAtt = max(0.,min(deep,1.0));\n\t//A*=deepAtt; //TODO\n\t\n\tfor( int i=0; i<4; i++){\n\t\tcD = u_WaveInfoD[i];//vec2(wi.winfo[0],wi.winfo[1]);// wi.vDir;\n\t\tfloat Q = u_WaveInfo[i].x;//wi.QorK;\n\t\tfloat A = u_WaveInfo[i].y;//wi.A;\n\t\tfloat W = u_WaveInfo[i].z;//wi.omega;\n\t\tfloat P = u_WaveInfo[i].w;//wi.phi;\n\t\tfloat dop = dot(cD,uvpos);\n\t\tfloat c = cos(dop*W - tm*P);//TODO 优化\n\t\tfloat s = sin(dop*W - tm*P);\n\t\tfloat AWs = A*W*s;\n\t\tfloat AWc = A*W*c;\n\t\tfloat _QxyAWs = -Q*cD.x*cD.y*AWs;\n\t\t\n\t\twpos += vec3(Q*A*cD.x*c,\n\t\t\t\t\tQ*A*cD.y*c,\n\t\t\t\t\tA*s);\n\t\tN += vec3(-cD.x*AWc,\n\t\t\t\t-cD.y*AWc,\n\t\t\t\tQ*AWs);//记得最后1-\n\t\tT += vec3(_QxyAWs,\n\t\t\t\tQ*cD.y*cD.y*AWs,//记得1-\n\t\t\t\tcD.y*AWc\n\t\t\t);\n\t\tB += vec3(Q*cD.x*cD.x*AWs,//记得1-\n\t\t\t\t_QxyAWs,\n\t\t\t\tcD.x*AWc\n\t\t\t);\n\t\t//float v1 = exp(-tan((dop*W - tm*P)/2.+1.07));//除2，+pi/2 这样正好能对齐\n#ifdef USE_FOAM\t\t\n\t\tfloat v1 = 0.5-sin((dop*W - tm*P)/1.+2.0)/2.;\n\t\tfoamS += pow(v1,9.)/4.;\n#endif\n\t}\n\tT.y=1.-T.y; B.x=1.-B.x;N.z=1.-N.z;\n\topos += vec3(wpos.x,wpos.z*min(deep/10.,1.),wpos.y);\n\t//y和z交换一下。现在根据uv计算的位置，所以直接交换yz就行。其他情况下有问题么\n\tT.xyz=T.xzy;\n\tB.xyz=B.xzy;\n\tN.xyz=N.xzy;\n}\n\n\nvoid calcWave(float curtm, vec2 uv, out vec3 B, out vec3 T, out vec3 N){\n\tfloat tm = curtm/1000.;\n\tN=vec3(0.,0.,0.);\t//输出的法线初始化一下\n\tvec2 uvpos = uv*TEXWAVE_UV_SCALE; //TODO 这个范围是什么 就是1？\n\tuvpos.y*=-1.;\n\tvec2 cD;// = D;\n\tconst int NumWaves = 4;\n\tfloat scale = 1./float(NumWaves);\n\tfor( int i=0; i<NumWaves; i++){\n\t\tcD = u_WaveInfoD[i];//vec2(wi.winfo[0],wi.winfo[1]);// wi.vDir;\n\t\tfloat k = 1.5;//u_WaveInfo[i].x;//wi.QorK; TODO  不知道为什么，这个取u_WaveInfo[i].x，在mi3w上就会闪。测试发现实际值也传过来了，就是1.5\n\t\tfloat A = u_WaveInfo[i].y;//wi.A;\n\t\tfloat W = u_WaveInfo[i].z;//wi.omega;\n\t\tfloat P = u_WaveInfo[i].w;//wi.phi;\n\t\t\n\t\tfloat dop = dot(cD,uvpos);\n\t\tfloat c = cos(dop*W - tm*P);//TODO 优化\n\t\tfloat s = sin(dop*W - tm*P);\n\t\t/*\n\t\tfloat AWs = A*W*s;\n\t\tfloat AWc = A*W*c;\n\t\tfloat _QxyAWs = -Q*cD.x*cD.y*AWs;\n\t\t\n\t\tN += vec3(-cD.x*AWc,\n\t\t\t\t-cD.y*AWc,\n\t\t\t\tQ*AWs);//记得最后1-\n\t\t*/\n\t\tfloat kWAc = scale*c;//k*W*A*c;  为了提高精度，这里只保留sin，cos部分，实际使用的时候再乘回来。\n\t\t//float kWAc = k*W*A*c;  \n\t\tN += vec3(\n\t\t\t-kWAc*cD.x*pow((s+1.)/2.,k-1.),\n\t\t\t-kWAc*cD.y*pow((s+1.)/2.,k-1.),\n\t\t\t1.\n\t\t);\n\t}\n\t//N.z=1.-N.z;\n\t//y和z交换一下。现在根据uv计算的位置，所以直接交换yz就行。其他情况下有问题么\n\tN.xyz=N.xzy;\n}\n"),Fi.addInclude("BRDF.glsl","vec4 LayaAirBRDF(in vec3 diffuseColor, in vec3 specularColor, in float oneMinusReflectivity, in float smoothness, in vec3 normal, in vec3 viewDir, in vec3 lightDir, in vec3 lightColor, in vec3 gi)\n{\n\tfloat perceptualRoughness = SmoothnessToPerceptualRoughness(smoothness);\n\tvec3 halfDir = SafeNormalize(viewDir - lightDir);\n\t\n\tfloat nv = abs(dot(normal, viewDir));\n\t\n\tfloat nl = clamp(dot(normal,   -lightDir),  0.0, 1.0);\n\tfloat nh = clamp(dot(normal,     halfDir),  0.0, 1.0);\n\tfloat lv = clamp(dot(lightDir,   viewDir),  0.0, 1.0);\n\tfloat lh = clamp(dot(lightDir,  -halfDir),  0.0, 1.0);\n\t\n\tfloat diffuseTerm = DisneyDiffuse(nv, nl, lh, perceptualRoughness) * nl;\n\t\n\tfloat roughness = PerceptualRoughnessToRoughness(perceptualRoughness);\n\t\n\t//#if UNITY_BRDF_GGX\n\tfloat V = SmithJointGGXVisibilityTerm(nl, nv, roughness);\n\tfloat D = GGXTerm(nh, roughness);\n\t\n\tfloat specularTerm = V * D * PI;\n\t\n\tspecularTerm = sqrt(max(0.0001, specularTerm));\n\tspecularTerm = max(0.0, specularTerm * nl);\n\t\n\tvec4 color;\n\tcolor.rgb = diffuseColor * (gi + lightColor * diffuseTerm) + specularTerm * lightColor * FresnelTerm (specularColor, lh);\n\t\n\tcolor.a = 1.0;\n\treturn color;\n}"),Fi.addInclude("PBRUtils.glsl","struct DirectionLight\n{\n\tvec3 Color;\n\tvec3 Direction;\n};\n\nvec3 UnpackScaleNormal(in vec2 uv0)\n{\n\t#ifdef NORMALTEXTURE\n\t\tvec3 normalT;\n\t\tvec4 normalMapSample = texture2D(u_NormalTexture, uv0);\n\t\tnormalT.x = 2.0 * normalMapSample.x - 1.0;\n\t\tnormalT.y = 1.0 - 2.0 * normalMapSample.y;\n\t\tnormalT.xy *= u_normalScale;\n\t\tnormalT.z = sqrt(1.0 - clamp(dot(normalT.xy, normalT.xy), 0.0, 1.0));\n\t\t\n\t\tvec3 T = normalize(v_Tangent);\n\t\tvec3 B = normalize(v_Binormal);\n\t\tvec3 N = normalize(v_Normal);\n\t\tmat3 TBN = mat3(T, B, N);\n\t\t\n\t\tvec3 bumpedNormal = TBN * normalize(normalT);\n\t\treturn bumpedNormal;\n\t#else\n\t\treturn normalize(v_Normal);\n\t#endif\n}\n\nvec4 DielectricSpecularColor = vec4(0.220916301, 0.220916301, 0.220916301, 1.0 - 0.220916301);\n\nfloat PI = 3.14159265359;\n\nvec3 FresnelTerm (in vec3 F0, in float cosA)\n{\n\treturn F0 + (vec3(1.0) - F0) * pow(1.0 - cosA, 5.0);\n}\n\nfloat PerceptualRoughnessToRoughness(in float perceptualRoughness)\n{\n\treturn perceptualRoughness * perceptualRoughness;\n}\n\nfloat PerceptualRoughnessToSpecularPower(in float perceptualRoughness)\n{\n\tfloat m = PerceptualRoughnessToRoughness(perceptualRoughness);\n\tfloat sq = max(0.0001, m * m);\n\tfloat n = (2.0 / sq) - 2.0;\n\tn = max(n, 0.0001);\n\treturn n;\n}\n\nfloat RoughnessToPerceptualRoughness(in float roughness)\n{\n\treturn sqrt(roughness);\n}\n\nfloat SmoothnessToRoughness(in float smoothness)\n{\n\treturn (1.0 - smoothness) * (1.0 - smoothness);\n}\n\nfloat SmoothnessToPerceptualRoughness(in float smoothness)\n{\n\treturn (1.0 - smoothness);\n}\n\nvec3 SafeNormalize(in vec3 inVec)\n{\n\tfloat dp3 = max(0.001,dot(inVec,inVec));\n\treturn inVec * (1.0 / sqrt(dp3));\n}\n\nfloat DisneyDiffuse(in float NdotV, in float NdotL, in float LdotH, in float perceptualRoughness)\n{\n\tfloat fd90 = 0.5 + 2.0 * LdotH * LdotH * perceptualRoughness;\n\tfloat lightScatter\t= (1.0 + (fd90 - 1.0) * pow(1.0 - NdotL,5.0));\n\tfloat viewScatter\t= (1.0 + (fd90 - 1.0) * pow(1.0 - NdotV,5.0));\n\n\treturn lightScatter * viewScatter;\n}\n\nfloat SmithJointGGXVisibilityTerm (float NdotL, float NdotV, float roughness)\n{\n\tfloat a = roughness;\n\tfloat lambdaV = NdotL * (NdotV * (1.0 - a) + a);\n\tfloat lambdaL = NdotV * (NdotL * (1.0 - a) + a);\n\n\treturn 0.5 / (lambdaV + lambdaL + 0.00001);\n}\n\nfloat GGXTerm (float NdotH, float roughness)\n{\n\tfloat a2 = roughness * roughness;\n\tfloat d = (NdotH * a2 - NdotH) * NdotH + 1.0;\n\treturn 0.31830988618 * a2 / (d * d + 0.0000001);\n}\n\nfloat OneMinusReflectivityFromMetallic(in float metallic)\n{\n\tfloat oneMinusDielectricSpec = DielectricSpecularColor.a;\n\treturn oneMinusDielectricSpec - metallic * oneMinusDielectricSpec;\n}\n\nfloat SpecularStrength(vec3 specular)\n{\n    //(SHADER_TARGET < 30)return specular.r; \n    return max (max (specular.r, specular.g), specular.b);\n}\n\nvec3 DiffuseAndSpecularFromMetallic(in vec3 diffuseColor, in float metallic, out vec3 specularColor, out float oneMinusReflectivity)\n{\n\tspecularColor = mix(DielectricSpecularColor.rgb, diffuseColor, metallic);\n\toneMinusReflectivity = OneMinusReflectivityFromMetallic(metallic);\n\treturn diffuseColor * oneMinusReflectivity;\n}\n\nvec3 EnergyConservationBetweenDiffuseAndSpecular(in vec3 diffuseColor, in vec3 specularColor, out float oneMinusReflectivity)\n{\n\toneMinusReflectivity = 1.0 - SpecularStrength(specularColor);\n\treturn diffuseColor * oneMinusReflectivity;\n}\n\nvec4 Occlusion(in vec2 uv0){\n\t#ifdef OCCLUSIONTEXTURE\n\t\tvec4 occlusionTextureColor = texture2D(u_OcclusionTexture, uv0);\n\t\tfloat occ = occlusionTextureColor.g;\n\t\tfloat oneMinusT = 1.0 - u_occlusionStrength;\n\t\tfloat lerpOneTo = oneMinusT + occ * u_occlusionStrength;\n\t\treturn occlusionTextureColor * lerpOneTo;\n\t#else\n\t\treturn vec4(1.0);\n\t#endif\n}\n\nvec2 ParallaxOffset(in vec3 viewDir){\n\t#ifdef PARALLAXTEXTURE\n\t\tfloat h = texture2D(u_ParallaxTexture, v_Texcoord0).g;\n\t\th = h * u_parallaxScale - u_parallaxScale / 2.0;\n\t\tvec3 v = viewDir;\n\t\tv.z += 0.42;\n\t\tvec2 offset = h * (v.xy / v.z);\n\t\treturn v_Texcoord0 + offset;\n\t#else\n\t\treturn v_Texcoord0;\n\t#endif\n}\n\n"),Fi.addInclude("PBRStandardLighting.glsl",'#include "PBRUtils.glsl"\n#include "BRDF.glsl"\n\nvec4 PBRStandardLight(in vec3 diffuseColor, in float metallic, in float smoothness, in vec3 normal, in vec3 viewDir, in vec3 lightDir, in vec3 lightColor, in vec3 gi)\n{\n\tfloat oneMinusReflectivity;\n\tvec3 specularColor;\n\tdiffuseColor = DiffuseAndSpecularFromMetallic (diffuseColor, metallic, specularColor, oneMinusReflectivity);\n\t\n\tvec4 color = LayaAirBRDF(diffuseColor, specularColor, oneMinusReflectivity, smoothness, normal, viewDir, lightDir, lightColor, gi);\n\treturn color;\n}\n\nvec4 PBRStandardDiectionLight (in vec3 diffuseColor, in float metallic, in float smoothness, in vec3 normal, in vec3 viewDir, in DirectionLight light, in vec3 gi)\n{\n\tvec3 lightVec = normalize(light.Direction);\n\treturn PBRStandardLight(diffuseColor, metallic, smoothness, normal, viewDir, lightVec, light.Color, gi);\n}\n\nvec2 MetallicGloss(in float diffuseTextureAlpha, in vec2 uv0)\n{\n\tvec2 mg;\n\t\n\t#ifdef METALLICGLOSSTEXTURE\n\t\tvec4 metallicGlossTextureColor = texture2D(u_MetallicGlossTexture, uv0);\n\t\t#ifdef SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA\n\t\t\tmg.r = metallicGlossTextureColor.r;\n\t\t\tmg.g = diffuseTextureAlpha;\n\t\t#else\n\t\t    mg = metallicGlossTextureColor.ra;\n\t\t#endif\n\t\tmg.g *= u_smoothnessScale;\n\t#else\n\t\tmg.r = u_metallic;\n\t\t#ifdef SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA\n\t\t\tmg.g = diffuseTextureAlpha * u_smoothnessScale;\n\t\t#else\n\t\t\tmg.g = u_smoothness;\n\t\t#endif\n\t#endif\n\t\n\treturn mg;\n}\n\n'),Fi.addInclude("PBRSpecularLighting.glsl",'#include "PBRUtils.glsl"\n#include "BRDF.glsl"\n\nvec4 PBRSpecularLight(in vec3 diffuseColor, in vec3 specularColor, in float smoothness, in vec3 normal, in vec3 viewDir, in vec3 lightDir, in vec3 lightColor, in vec3 gi)\n{\n\tfloat oneMinusReflectivity;\n\tdiffuseColor = EnergyConservationBetweenDiffuseAndSpecular (diffuseColor, specularColor, oneMinusReflectivity);\n\t\n\tvec4 color = LayaAirBRDF(diffuseColor, specularColor, oneMinusReflectivity, smoothness, normal, viewDir, lightDir, lightColor, gi);\n\treturn color;\n}\n\nvec4 PBRSpecularDiectionLight (in vec3 diffuseColor, in vec3 specularColor, in float smoothness, in vec3 normal, in vec3 viewDir, in DirectionLight light, in vec3 gi)\n{\n\tvec3 lightVec = normalize(light.Direction);\n\treturn PBRSpecularLight(diffuseColor, specularColor, smoothness, normal, viewDir, lightVec, light.Color, gi);\n}\n\nvec4 SpecularGloss(float diffuseTextureAlpha, in vec2 uv0)\n{\n    vec4 sg;\n\t\n\t#ifdef SPECULARTEXTURE\n\t\tvec4 specularTextureColor = texture2D(u_SpecularTexture, uv0);\n\t\t#ifdef SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA\n\t\t\tsg.rgb = specularTextureColor.rgb;\n\t\t\tsg.a = diffuseTextureAlpha;\n\t\t#else\n\t\t\tsg = specularTextureColor;\n\t\t#endif\n\t\tsg.a *= u_smoothnessScale;\n\t#else\n\t\tsg.rgb = u_SpecularColor.rgb;\n\t\t#ifdef SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA\n\t\t\tsg.a = diffuseTextureAlpha * u_smoothnessScale;\n\t\t#else\n\t\t\tsg.a = u_smoothness;\n\t\t#endif\n\t#endif\n\t\n    return sg;\n}\n\n');var t,e,i={a_Position:0,a_Color:1,a_Normal:3,a_Texcoord0:2,a_Texcoord1:15,a_BoneWeights:7,a_BoneIndices:6,a_Tangent0:5},n={u_Bones:[0,0],u_DiffuseTexture:[1,1],u_SpecularTexture:[3,1],u_NormalTexture:[2,1],u_ReflectTexture:[5,1],u_AlphaTestValue:[0,1],u_DiffuseColor:[6,1],u_MaterialSpecular:[8,1],u_Shininess:[9,1],u_MaterialReflect:[10,1],u_TilingOffset:[11,1],u_WorldMat:[0,2],u_MvpMatrix:[1,2],u_LightmapScaleOffset:[2,2],u_LightMap:[3,2],u_CameraPos:[0,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Color":[4,4],"u_DirectionLight.Direction":[3,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Color":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Color":[14,4],u_AmbientColor:[21,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]},r=Fi.nameKey.add("BLINNPHONG");t='attribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\n\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))||(defined(LIGHTMAP)&&defined(UV))\n\tattribute vec2 a_Texcoord0;\n\tvarying vec2 v_Texcoord0;\n#endif\n\n#if defined(LIGHTMAP)&&defined(UV1)\n\tattribute vec2 a_Texcoord1;\n#endif\n\n#ifdef LIGHTMAP\n\tuniform vec4 u_LightmapScaleOffset;\n\tvarying vec2 v_LightMapUV;\n#endif\n\n#ifdef COLOR\n\tattribute vec4 a_Color;\n\tvarying vec4 v_Color;\n#endif\n\n#ifdef BONE\n\tconst int c_MaxBoneCount = 24;\n\tattribute vec4 a_BoneIndices;\n\tattribute vec4 a_BoneWeights;\n\tuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\tattribute vec3 a_Normal;\n\tvarying vec3 v_Normal; \n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\tuniform vec3 u_CameraPos;\n\tvarying vec3 v_ViewDir; \n#endif\n\n#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP))&&defined(NORMALMAP)\n\tattribute vec4 a_Tangent0;\n\tvarying vec3 v_Tangent;\n\tvarying vec3 v_Binormal;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)||defined(RECEIVESHADOW)\n\tuniform mat4 u_WorldMat;\n\tvarying vec3 v_PositionWorld;\n#endif\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n  #ifdef SHADOWMAP_PSSM1 \n  varying vec4 v_lightMVPPos;\n  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\n#ifdef TILINGOFFSET\n\tuniform vec4 u_TilingOffset;\n#endif\n\nvoid main_castShadow()\n{\n\t#ifdef BONE\n\t\tmat4 skinTransform=mat4(0.0);\n\t\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tvec4 position=skinTransform*a_Position;\n\t\tgl_Position = u_MvpMatrix * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * a_Position;\n\t#endif\n\t \n\t//TODO没考虑UV动画呢\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tv_Texcoord0=a_Texcoord0;\n\t#endif\n\t\tv_posViewZ = gl_Position.z;\n}\n\nvoid main_normal()\n{\n\t#ifdef BONE\n\t\tmat4 skinTransform=mat4(0.0);\n\t\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tvec4 position=skinTransform*a_Position;\n\t\tgl_Position = u_MvpMatrix * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * a_Position;\n\t#endif\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\t\tmat3 worldMat;\n\t\t#ifdef BONE\n\t\t\tworldMat=mat3(u_WorldMat*skinTransform);\n\t\t#else\n\t\t\tworldMat=mat3(u_WorldMat);\n\t\t#endif  \n\t\tv_Normal=worldMat*a_Normal;//TODO:法线可以用"魔法"矩阵\n\t\t#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n\t\t\tv_Tangent=worldMat*a_Tangent0.xyz;\n\t\t\tv_Binormal=cross(v_Normal,v_Tangent)*a_Tangent0.w;\n\t\t#endif\n\t#endif\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)||defined(RECEIVESHADOW)\n\t\t#ifdef BONE\n\t\t\tv_PositionWorld=(u_WorldMat*position).xyz;\n\t\t#else\n\t\t\tv_PositionWorld=(u_WorldMat*a_Position).xyz;\n\t\t#endif\n\t#endif\n\t\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\t\tv_ViewDir=u_CameraPos-v_PositionWorld;\n\t#endif\n\n\t#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))\n\t\tv_Texcoord0=a_Texcoord0;\n\t\t#ifdef TILINGOFFSET\n\t\t\tv_Texcoord0=(vec2(v_Texcoord0.x,v_Texcoord0.y-1.0)*u_TilingOffset.xy)+u_TilingOffset.zw;\n\t\t\tv_Texcoord0=vec2(v_Texcoord0.x,1.0+v_Texcoord0.y);\n\t\t#endif\n\t#endif\n\n\t#ifdef LIGHTMAP\n\t\t#ifdef UV1\n\t\t\tv_LightMapUV=vec2(a_Texcoord1.x*u_LightmapScaleOffset.x+u_LightmapScaleOffset.z,1.0+a_Texcoord1.y*u_LightmapScaleOffset.y+u_LightmapScaleOffset.w);\n\t\t#else\n\t\t\tv_LightMapUV=vec2(a_Texcoord0.x,a_Texcoord0.y-1.0)*u_LightmapScaleOffset.xy+u_LightmapScaleOffset.zw;\n\t\t#endif \n\t#endif\n\n\t#ifdef COLOR\n\t\tv_Color=a_Color;\n\t#endif\n\n\t#ifdef RECEIVESHADOW\n\t\tv_posViewZ = gl_Position.w;\n\t\t#ifdef SHADOWMAP_PSSM1 \n\t\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n\t\t#endif\n\t#endif\n}\n\nvoid main()\n{\n\t#ifdef CASTSHADOW\n\t\tmain_castShadow();\n\t#else\n\t\tmain_normal();\n\t#endif\n}',e='#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "Lighting.glsl";\n\nuniform vec4 u_DiffuseColor;\n\n#ifdef COLOR\n\tvarying vec4 v_Color;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\tvarying vec3 v_ViewDir; \n#endif\n\n#ifdef ALPHATEST\n\tuniform float u_AlphaTestValue;\n#endif\n\n#ifdef DIFFUSEMAP\n\tuniform sampler2D u_DiffuseTexture;\n#endif\n\n#ifdef REFLECTMAP\n\tuniform samplerCube u_ReflectTexture;\n\tuniform vec3 u_MaterialReflect;\n#endif\n\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))\n\tvarying vec2 v_Texcoord0;\n#endif\n\n#ifdef LIGHTMAP\n\tvarying vec2 v_LightMapUV;\n\tuniform sampler2D u_LightMap;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\tuniform vec3 u_MaterialSpecular;\n\tuniform float u_Shininess;\n\t#ifdef SPECULARMAP \n\t\tuniform sampler2D u_SpecularTexture;\n\t#endif\n#endif\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\t#ifdef ADDTIVEFOG\n\t#else\n\t\tuniform vec3 u_FogColor;\n\t#endif\n#endif\n\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\tvarying vec3 v_Normal;\n#endif\n\n#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n\tuniform sampler2D u_NormalTexture;\n\tvarying vec3 v_Tangent;\n\tvarying vec3 v_Binormal;\n#endif\n\n#ifdef DIRECTIONLIGHT\n\tuniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\n\tuniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\n\tuniform SpotLight u_SpotLight;\n#endif\n\nuniform vec3 u_AmbientColor;\n\n\n#if defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)||defined(RECEIVESHADOW)\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#include "ShadowHelper.glsl"\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\t\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\t\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\n\nvoid main_castShadow()\n{\n\t//gl_FragColor=vec4(v_posViewZ,0.0,0.0,1.0);\n\tgl_FragColor=packDepth(v_posViewZ);\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tfloat alpha = texture2D(u_DiffuseTexture,v_Texcoord0).w;\n\t\tif( alpha < u_AlphaTestValue )\n\t\t{\n\t\t\tdiscard;\n\t\t}\n\t#endif\n}\nvoid main_normal()\n{\n\tvec4 mainColor=u_DiffuseColor;\n\t#ifdef DIFFUSEMAP\n\t\tvec4 difTexColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n\t\tmainColor=mainColor*difTexColor;\n\t#endif \n\t#ifdef COLOR\n\t\tmainColor=mainColor*v_Color;\n\t#endif \n    \n\t#ifdef ALPHATEST\n\t\tif(mainColor.a<u_AlphaTestValue)\n\t\t\tdiscard;\n\t#endif\n  \n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\t\tvec3 normal;\n\t\t#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n\t\t\tvec3 normalMapSample = texture2D(u_NormalTexture, v_Texcoord0).rgb;\n\t\t\tnormal = normalize(NormalSampleToWorldSpace(normalMapSample, v_Normal, v_Tangent,v_Binormal));\n\t\t#else\n\t\t\tnormal = normalize(v_Normal);\n\t\t#endif\n\t#endif\n\t\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tvec3 viewDir= normalize(v_ViewDir);\n\t\tvec3 diffuse = vec3(0.0);\n\t\tvec3 specular= vec3(0.0);\n\t\tvec3 dif,spe;\n\t\t#ifdef SPECULARMAP\n\t\t\tvec3 gloss=texture2D(u_SpecularTexture, v_Texcoord0).rgb;\n\t\t#else\n\t\t\t#ifdef DIFFUSEMAP\n\t\t\t\tvec3 gloss=vec3(difTexColor.a);\n\t\t\t#else\n\t\t\t\tvec3 gloss=vec3(1.0);\n\t\t\t#endif\n\t\t#endif\n\t#endif\n\n\t\n\t#ifdef DIRECTIONLIGHT\n\t\tLayaAirBlinnPhongDiectionLight(u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_DirectionLight,dif,spe);\n\t\tdiffuse+=dif;\n\t\tspecular+=spe;\n\t#endif\n \n\t#ifdef POINTLIGHT\n\t\tLayaAirBlinnPhongPointLight(v_PositionWorld,u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_PointLight,dif,spe);\n\t\tdiffuse+=dif;\n\t\tspecular+=spe;\n\t#endif\n\n\t#ifdef SPOTLIGHT\n\t\tLayaAirBlinnPhongSpotLight(v_PositionWorld,u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_SpotLight,dif,spe);\n\t\tdiffuse+=dif;\n\t\tspecular+=spe;\n\t#endif\n\n\t\n\tvec3 finalDiffuse;\n\t#ifdef LIGHTMAP\n\t\tfinalDiffuse=texture2D(u_LightMap, v_LightMapUV).rgb*2.0;\n\t\t//float exponent = texture2D(u_LightMap, v_LightMapUV).a;\n\t\t//finalDiffuse = texture2D(u_LightMap, v_LightMapUV).rgb;\n\t\t//float ratio = pow(2.0, exponent * 255.0 - (128.0 + 8.0));\n\t\t//finalDiffuse = finalDiffuse * 255.0 * ratio;\t\n\t\t//finalDiffuse = sqrt(finalDiffuse);\n\t#else\n\t\tfinalDiffuse=vec3(0.0);\n\t#endif\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tfinalDiffuse+=diffuse;\n\t#endif\n\n\t#ifdef RECEIVESHADOW\n\t\tfloat shadowValue = 1.0;\n\t\t#ifdef SHADOWMAP_PSSM3\n\t\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t\t#endif\n\t\t#ifdef SHADOWMAP_PSSM2\n\t\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t\t#endif \n\t\t#ifdef SHADOWMAP_PSSM1\n\t\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n\t\t#endif\n\t\tgl_FragColor =vec4(mainColor.rgb*(u_AmbientColor + finalDiffuse)*shadowValue,mainColor.a);\n\t#else\n\t\tgl_FragColor =vec4(mainColor.rgb*(u_AmbientColor + finalDiffuse),mainColor.a);\n\t#endif\n\t\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\t#ifdef RECEIVESHADOW\n\t\t\tgl_FragColor.rgb+=specular*shadowValue;\n\t\t#else\n\t\t\tgl_FragColor.rgb+=specular;\n\t\t#endif\n\t#endif\n\n\n\t#ifdef REFLECTMAP\n\t\tvec3 incident = -viewDir;\n\t\tvec3 reflectionVector = reflect(incident,normal);\n\t\tvec3 reflectionColor  = textureCube(u_ReflectTexture,reflectionVector).rgb;\n\t\tgl_FragColor.rgb += u_MaterialReflect*reflectionColor;\n\t#endif\n\t  \n\t#ifdef FOG\n\t\tfloat lerpFact=clamp((1.0/gl_FragCoord.w-u_FogStart)/u_FogRange,0.0,1.0);\n\t\t#ifdef ADDTIVEFOG\n\t\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,vec3(0.0,0.0,0.0),lerpFact);\n\t\t#else\n\t\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n\t\t#endif\n\t#endif\n}\n\nvoid main()\n{\n\t#ifdef CASTSHADOW\t\t\n\t\tmain_castShadow();\n\t#else\n\t  main_normal();\n\t#endif  \n}\n\n';var a=ui.add(r,t,e,i,n);Bi.SHADERDEFINE_DIFFUSEMAP=a.registerMaterialDefine("DIFFUSEMAP"),Bi.SHADERDEFINE_NORMALMAP=a.registerMaterialDefine("NORMALMAP"),Bi.SHADERDEFINE_SPECULARMAP=a.registerMaterialDefine("SPECULARMAP"),Bi.SHADERDEFINE_REFLECTMAP=a.registerMaterialDefine("REFLECTMAP"),Bi.SHADERDEFINE_TILINGOFFSET=a.registerMaterialDefine("TILINGOFFSET"),Bi.SHADERDEFINE_ADDTIVEFOG=a.registerMaterialDefine("ADDTIVEFOG"),i={a_Position:0,a_Color:1,a_Normal:3,a_Texcoord0:2,a_Texcoord1:15,a_TexcoordNext0:14,a_BoneWeights:7,a_BoneIndices:6,a_Tangent0:5},n={u_Bones:[0,0],u_DiffuseTexture:[1,1],u_SpecularTexture:[3,1],u_NormalTexture:[2,1],u_AmbientTexture:[5,1],u_ReflectTexture:[6,1],u_AlphaTestValue:[0,1],u_Albedo:[7,1],u_UVMatrix:[13,1],u_UVAge:[14,1],u_UVAniAge:[8,1],u_MaterialDiffuse:[10,1],u_MaterialAmbient:[9,1],u_MaterialSpecular:[11,1],u_MaterialReflect:[12,1],u_TilingOffset:[15,1],u_WorldMat:[0,2],u_MvpMatrix:[1,2],u_LightmapScaleOffset:[2,2],u_LightMap:[3,2],u_CameraPos:[0,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Attenuation":[7,4],"u_PointLight.Diffuse":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Attenuation":[13,4],"u_SpotLight.Diffuse":[14,4],u_AmbientColor:[21,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]};var s=Fi.nameKey.add("SIMPLE");t="attribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\n\n\n\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(COLOR)&&defined(SPECULARMAP)||defined(NORMALMAP)))||(defined(LIGHTMAP)&&defined(UV))\nattribute vec2 a_Texcoord0;\nvarying vec2 v_Texcoord0;\n  #ifdef UVTRANSFORM \n  uniform mat4 u_UVMatrix;\n  #endif\n#endif\n\n#if defined(AMBIENTMAP)||(defined(LIGHTMAP)&&defined(UV1))\nattribute vec2 a_Texcoord1;\n#endif\n\n#if defined(AMBIENTMAP)||defined(LIGHTMAP)\nuniform vec4 u_LightmapScaleOffset;\nvarying vec2 v_LightMapUV;\n#endif\n\n\n#ifdef COLOR\nattribute vec4 a_Color;\nvarying vec4 v_Color;\n#endif\n\n#ifdef BONE\nattribute vec4 a_BoneIndices;\nattribute vec4 a_BoneWeights;\nconst int c_MaxBoneCount = 24;\nuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\nattribute vec3 a_Normal;\nvarying vec3 v_Normal;\n#endif\n\n#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP))&&defined(NORMALMAP)\nattribute vec3 a_Tangent0;\nvarying vec3 v_Tangent0;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(DEPTHFOG)||defined(REFLECTMAP)||defined(RECEIVESHADOW)\nuniform mat4 u_WorldMat;\nvarying vec3 v_PositionWorld;\n#endif\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n  #ifdef SHADOWMAP_PSSM1 \n  varying vec4 v_lightMVPPos;\n  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\n#ifdef TILINGOFFSET\n\tuniform vec4 u_TilingOffset;\n#endif\n\nvoid main_castShadow()\n{\n#ifdef BONE\n\tmat4 skinTransform=mat4(0.0);\n\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\tvec4 position=skinTransform*a_Position;\n\tgl_Position = u_MvpMatrix * position;\n#else\n\tgl_Position = u_MvpMatrix * a_Position;\n#endif\n \n//TODO没考虑UV动画呢\n#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\tv_Texcoord0=a_Texcoord0;\n#endif\n\tv_posViewZ = gl_Position.z;\n}\n\nvoid main_normal()\n{\n#ifdef BONE\n\tmat4 skinTransform=mat4(0.0);\n\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\tvec4 position=skinTransform*a_Position;\n\tgl_Position = u_MvpMatrix * position;\n#else\n\tgl_Position = u_MvpMatrix * a_Position;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\tmat3 worldMat;\n\t#ifdef BONE\n\t\tworldMat=mat3(u_WorldMat*skinTransform);\n\t#else\n\t\tworldMat=mat3(u_WorldMat);\n\t#endif  \n\tv_Normal=worldMat*a_Normal;\n\t#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n\t\tv_Tangent0=worldMat*a_Tangent0;\n\t#endif\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(DEPTHFOG)||defined(REFLECTMAP)||defined(RECEIVESHADOW)\n\t#ifdef BONE\n\t\tv_PositionWorld=(u_WorldMat*position).xyz;\n\t#else\n\t\tv_PositionWorld=(u_WorldMat*a_Position).xyz;\n\t#endif\n#endif\n\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(COLOR)&&defined(SPECULARMAP)||defined(NORMALMAP)))\n\tv_Texcoord0=a_Texcoord0;\n\t#ifdef TILINGOFFSET\n\t\tv_Texcoord0=(vec2(v_Texcoord0.x,v_Texcoord0.y-1.0)*u_TilingOffset.xy)+u_TilingOffset.zw;\n\t\tv_Texcoord0=vec2(v_Texcoord0.x,v_Texcoord0.y+1.0);\n\t#endif\n\t#ifdef UVTRANSFORM\n\t\tv_Texcoord0=(u_UVMatrix*vec4(v_Texcoord0,0.0,1.0)).xy;\n\t#endif\n#endif\n\n#if defined(AMBIENTMAP)||defined(LIGHTMAP)\n\t#ifdef SCALEOFFSETLIGHTINGMAPUV\n\t\t#ifdef UV1\n\t\t\tv_LightMapUV=vec2(a_Texcoord1.x*u_LightmapScaleOffset.x+u_LightmapScaleOffset.z,1.0+a_Texcoord1.y*u_LightmapScaleOffset.y+u_LightmapScaleOffset.w);\n\t\t#else\n\t\t\tv_LightMapUV=vec2(a_Texcoord0.x,a_Texcoord0.y-1.0)*u_LightmapScaleOffset.xy+u_LightmapScaleOffset.zw;\n\t\t#endif \n\t#else\n\t\t#ifdef UV1\n\t\t\tv_LightMapUV=a_Texcoord1;\n\t\t#else\n\t\t\tv_LightMapUV=a_Texcoord0;\n\t\t#endif \n\t#endif \n#endif\n\n#ifdef COLOR\n\tv_Color=a_Color;\n#endif\n\n#ifdef RECEIVESHADOW\n\tv_posViewZ = gl_Position.w;\n\t#ifdef SHADOWMAP_PSSM1 \n\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n\t#endif\n#endif\n}\n\nvoid main()\n{\n#ifdef CASTSHADOW\n\tmain_castShadow();\n#else\n\tmain_normal();\n#endif\n}",e='#ifdef HIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\n#include "LightHelper.glsl";\n\nuniform vec4 u_Albedo;\n\n#ifdef ALPHATEST\nuniform float u_AlphaTestValue;\n#endif\n\n#ifdef DIFFUSEMAP\nuniform sampler2D u_DiffuseTexture;\n#endif\n\n#ifdef REFLECTMAP\nuniform samplerCube u_ReflectTexture;\nuniform vec3 u_MaterialReflect;\n#endif\n\n#if   defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(COLOR)&&defined(SPECULARMAP)||defined(NORMALMAP)))\nvarying vec2 v_Texcoord0;\n#endif\n\n#if defined(AMBIENTMAP)||defined(LIGHTMAP)\nvarying vec2 v_LightMapUV;\n#endif\n#ifdef AMBIENTMAP\nuniform sampler2D u_AmbientTexture;\n#endif\n#ifdef LIGHTMAP\nuniform sampler2D u_LightMap;\n#endif\n\n#ifdef COLOR\nvarying vec4 v_Color;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\nuniform vec3 u_MaterialDiffuse;\nuniform vec4 u_MaterialSpecular;\n  #if (defined(DIFFUSEMAP)||defined(COLOR))&&defined(SPECULARMAP) \n  uniform sampler2D u_SpecularTexture;\n  #endif\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(AMBIENTMAP)||defined(LIGHTMAP)\nuniform vec3 u_MaterialAmbient;\n#endif\n\n#if defined(FOG)||defined(DEPTHFOG)\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\t#ifdef ADDTIVEFOG\n\t#else\n\t\tuniform vec3 u_FogColor;\n\t#endif\n#endif\n\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\nvarying vec3 v_Normal;\n#endif\n\n#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\nuniform sampler2D u_NormalTexture;\nvarying vec3 v_Tangent0;\n#endif\n\n#ifdef DIRECTIONLIGHT\nuniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\nuniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\nuniform SpotLight u_SpotLight;\n#endif\n\nuniform vec3 u_AmbientColor;\n\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(DEPTHFOG)||defined(REFLECTMAP)||(defined(RECEIVESHADOW)&&(defined(SHADOWMAP_PSM2)||defined(SHADOWMAP_PSM3)))\nuniform vec3 u_CameraPos;\n#endif\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(DEPTHFOG)||defined(REFLECTMAP)\nvarying vec3 v_PositionWorld;\n#endif\n\n#include "ShadowHelper.glsl"\n#ifdef RECEIVESHADOW\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\nvarying float v_posViewZ;\n\n\n\nvoid main_castShadow()\n{\n\t//gl_FragColor=vec4(v_posViewZ,0.0,0.0,1.0);\n\tgl_FragColor=packDepth(v_posViewZ);\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tfloat alpha = texture2D(u_DiffuseTexture,v_Texcoord0).w;\n\t\tif( alpha < u_AlphaTestValue )\n\t\t{\n\t\t\tdiscard;\n\t\t}\n\t#endif\n}\nvoid main_normal()\n{\n#if defined(DIFFUSEMAP)&&!defined(COLOR)\n\tgl_FragColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n#endif \n  \n#if defined(COLOR)&&!defined(DIFFUSEMAP)\n\tgl_FragColor=v_Color;\n#endif \n  \n#if defined(DIFFUSEMAP)&&defined(COLOR)\n\tvec4 texColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n\tgl_FragColor=texColor*v_Color;\n#endif\n  \n#if !defined(DIFFUSEMAP)&&!defined(COLOR)\n\tgl_FragColor=vec4(1.0,1.0,1.0,1.0);\n#endif \n    \n#ifdef ALPHATEST\n\tif(gl_FragColor.a-u_AlphaTestValue<0.0)\n\t\tdiscard;\n#endif\n  \n  \n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(REFLECTMAP)\n\tvec3 normal;\n    #if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n\t\tvec3 normalMapSample = texture2D(u_NormalTexture, v_Texcoord0).rgb;\n\t\tnormal = normalize(NormalSampleToWorldSpace(normalMapSample, v_Normal, v_Tangent0));\n\t#else\n\t\tnormal = normalize(v_Normal);\n    #endif\n#endif\n\t\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\tvec3 diffuse = vec3(0.0);\n\tvec3 ambient = vec3(0.0);\n\tvec3 specular= vec3(0.0);\n\tvec3 dif, amb, spe;\n#endif\n  \n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||defined(REFLECTMAP)\n\tvec3 toEye;\n\t#ifdef FOG\n\t\ttoEye=u_CameraPos-v_PositionWorld;\n\t\tfloat toEyeLength=length(toEye);\n\t\ttoEye/=toEyeLength;\n\t#else\n\t\ttoEye=normalize(u_CameraPos-v_PositionWorld);\n\t#endif\n#endif\n\t\n#ifdef DIRECTIONLIGHT\n\tcomputeDirectionLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_DirectionLight,u_AmbientColor,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n \n#ifdef POINTLIGHT\n\tcomputePointLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_PointLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n\n#ifdef SPOTLIGHT\n\tComputeSpotLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_SpotLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n\n#ifdef RECEIVESHADOW\n\tfloat shadowValue = 1.0;\n\t#ifdef SHADOWMAP_PSSM3\n\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t#endif\n\t#ifdef SHADOWMAP_PSSM2\n\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t#endif \n\t#ifdef SHADOWMAP_PSSM1\n\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n\t#endif\n#endif\n\n#ifdef AMBIENTMAP\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_AmbientTexture, v_LightMapUV).rgb); \n\t#else\n\t\t#if defined(RECEIVESHADOW)\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_AmbientTexture, v_LightMapUV).rgb * shadowValue);\n\t\t#else\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_AmbientTexture, v_LightMapUV).rgb); \n\t\t#endif\n\t#endif\n#endif\n\n#ifdef LIGHTMAP\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_LightMap, v_LightMapUV).rgb); \n\t#else\n\t\t#if defined(RECEIVESHADOW)\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_LightMap, v_LightMapUV).rgb * shadowValue);\n\t\t#else\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_LightMap, v_LightMapUV).rgb); \n\t\t#endif\n\t#endif\n#endif\n\ngl_FragColor=gl_FragColor*u_Albedo;\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t#if (defined(DIFFUSEMAP)||defined(COLOR))&&defined(SPECULARMAP)\n\t\tspecular =specular*texture2D(u_SpecularTexture, v_Texcoord0).rgb;\n    #endif\n\t#ifdef RECEIVESHADOW\n\t\tgl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse*shadowValue) + specular*shadowValue,gl_FragColor.a);\n\t#else\n\t\tgl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse) + specular,gl_FragColor.a);\n\t#endif\n#endif\n  \n#ifdef REFLECTMAP\n\tvec3 incident = -toEye;\n\tvec3 reflectionVector = reflect(incident,normal);\n\tvec3 reflectionColor  = textureCube(u_ReflectTexture,reflectionVector).rgb;\n\tgl_FragColor.rgb += u_MaterialReflect*reflectionColor;\n#endif\n  \n#ifdef FOG\n\tfloat lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n\t#ifdef ADDTIVEFOG\n\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,vec3(0.0,0.0,0.0),lerpFact);\n\t#else\n\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n\t#endif\n#endif\n#ifdef DEPTHFOG\n\tfloat lerpFact = (-v_PositionWorld.y-u_FogStart)/u_FogRange;\n\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n#endif\n}\n\nvoid main()\n{\n#ifdef CASTSHADOW\t\t\n\tmain_castShadow();\n#else\n  main_normal();\n#endif  \n}\n\n',a=ui.add(s,t,e,i,n),Wi.SHADERDEFINE_DIFFUSEMAP=a.registerMaterialDefine("DIFFUSEMAP"),Wi.SHADERDEFINE_NORMALMAP=a.registerMaterialDefine("NORMALMAP"),Wi.SHADERDEFINE_SPECULARMAP=a.registerMaterialDefine("SPECULARMAP"),Wi.SHADERDEFINE_EMISSIVEMAP=a.registerMaterialDefine("EMISSIVEMAP"),Wi.SHADERDEFINE_AMBIENTMAP=a.registerMaterialDefine("AMBIENTMAP"),Wi.SHADERDEFINE_REFLECTMAP=a.registerMaterialDefine("REFLECTMAP"),Wi.SHADERDEFINE_UVTRANSFORM=a.registerMaterialDefine("UVTRANSFORM"),Wi.SHADERDEFINE_TILINGOFFSET=a.registerMaterialDefine("TILINGOFFSET"),Wi.SHADERDEFINE_ADDTIVEFOG=a.registerMaterialDefine("ADDTIVEFOG"),i={a_Position:0,a_Color:1},n={u_MvpMatrix:[1,2]};var o=Fi.nameKey.add("LINE");t="attribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\nattribute vec4 a_Color;\nvarying vec4 v_Color;\n\n\nvoid main()\n{\n  gl_Position = u_MvpMatrix * a_Position;\n  v_Color=a_Color;\n}",e="#ifdef HIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nvarying vec4 v_Color;\n\nvoid main()\n{\n  gl_FragColor=v_Color; \n}\n\n",ui.add(o,t,e,i,n),i={a_position:0,a_normal:3,tangent:5,binormal:4,uv:2,a_BoneWeights:7,a_BoneIndices:6,a_Tangent0:5},n={u_Bones:[0,0],u_lodRect:[9,3],irrad_mat_red:[10,3],irrad_mat_green:[11,3],irrad_mat_blue:[12,3],u_hdrexposure:[13,3],u_aoObjPos:[14,1],texBaseColor:[1,1],texNormal:[2,1],texPbrInfo:[3,1],texPrefilterdEnv:[8,3],texHSNoise:[15,1],texPrefilterDiff:[7,3],u_AlphaTestValue:[0,1],texBRDFLUT:[4,1],u_UVAniAge:[5,1],u_roughness:[6,1],u_metaless:[7,1],u_UVMatrix:[8,1],u_UVAge:[9,1],modelMatrix:[0,2],mvp:[1,2],cameraPosition:[0,3],u_View:[1,3],u_Project:[2,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Attenuation":[7,4],"u_PointLight.Diffuse":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Attenuation":[13,4],"u_SpotLight.Diffuse":[14,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]};var l=Fi.nameKey.add("PBR");t="\nuniform mat4 modelMatrix;\n//uniform mat4 modelViewMatrix;\n//uniform mat4 projectionMatrix;\nuniform mat4 u_View;\nuniform mat4 u_Project;\nuniform mat4 mvp;\n//uniform mat4 viewMatrix;\nuniform vec3 cameraPosition;\n\nattribute vec3 a_position;\nattribute vec3 a_normal;\n#ifdef HAS_TANGENT\nattribute vec3 tangent;\nattribute vec3 binormal;\n#endif\nattribute vec2 uv;\n#ifdef BONE\nattribute vec4 a_BoneIndices;\nattribute vec4 a_BoneWeights;\nconst int c_MaxBoneCount = 24;\nuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\nvarying vec4 vViewPos;\nvarying vec4 vWorldPos;\nvarying vec3 vLightDir;\nvarying vec3 vViewDir;\n#ifdef HAS_TANGENT\nvarying vec3 vWorldTangent;\nvarying vec3 vWorldBinormal;\n#endif\n\n#ifdef RECEIVESHADOW\nvarying float v_posViewZ;\n  #ifdef SHADOWMAP_PSSM1 \n  varying vec4 v_lightMVPPos;\n  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\nvoid main() {\n#ifdef BONE\n\tmat4 skinTransform=mat4(0.0);\n\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\tgl_Position = mvp*skinTransform*vec4(a_position,1.);\n\tmat4 modelMat = modelMatrix*skinTransform;\n#else\n\tgl_Position = mvp*vec4(a_position,1.);\n\tmat4 modelMat = modelMatrix;\n#endif\t\n\tvWorldPos = modelMat*vec4(a_position,1.);\n\n#ifdef CASTSHADOW \n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tvUv = uv;\n\t#endif\t\n#else\n    vUv = uv;\n\tvWorldNorm = normalize((modelMat*vec4(a_normal,0.0)).xyz);\n\t#ifdef HAS_TANGENT\n\tvWorldTangent = normalize((modelMat*vec4(tangent,0.0)).xyz);\n\tvWorldBinormal = normalize((modelMat*vec4(binormal,0.0)).xyz);\n\t#endif\n    \n    vViewDir = (vWorldPos.xyz-cameraPosition);//这个不能normalize。否则无法线性差值了\n#ifdef RECEIVESHADOW\n\tv_posViewZ = gl_Position.z;\n\t#ifdef SHADOWMAP_PSSM1 \n\t\tv_lightMVPPos = u_lightShadowVP[0] * vWorldPos;\n\t#endif\n#endif\t\n#endif\n}\n",e='//#version 300 es\n\nprecision highp float;\nprecision lowp int;\n\nconst float PI = 3.14159265358979323846264;\nconst float _2PI = 6.2831853071796;\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\n#ifdef HAS_TANGENT\nvarying vec3 vWorldTangent;\nvarying vec3 vWorldBinormal;\n#endif\nvarying vec3 vViewDir;\nvarying vec4 vViewPos;\nvarying vec4 vWorldPos;\n//\nuniform sampler2D texBaseColor;\nuniform sampler2D texNormal;\n//预计算的贴图\nuniform sampler2D texPrefilterdEnv;\nuniform sampler2D texBRDFLUT;\nuniform sampler2D texPrefilterDiff;\n#ifdef HAS_PBRINFO\nuniform sampler2D texPbrInfo;   //Ao, Roughness, Metallic\n#endif\nuniform float u_hdrexposure;\nuniform float u_AlphaTestValue;\n\nuniform float u_roughness;\nuniform float u_metaless;\nconst float maxlv = 7.;\t//现在只支持512分辨率的环境贴图\nconst int nmaxlv = 9;//\n\t\t\t\t\t\t\t\nuniform mat4 irrad_mat_red;\nuniform mat4 irrad_mat_green;\nuniform mat4 irrad_mat_blue;\t\t\t\t\t\t\t\n\nvec3 speccontrib = vec3(0.);\n\nconst float _maxu8 = 255.0;\nconst float _maxu16 = 65535.0;\nconst float _shift8 = 256.0;    //平移的话是*256而不是255\nvec2 _RGBAToU16(const in vec4 rgba){\n    return vec2((rgba.r*_maxu8+rgba.g*_maxu8*_shift8)/_maxu16, (rgba.b*_maxu8+rgba.a*_maxu8*_shift8)/_maxu16);\n}\nvec3 _RGBEToRGB( const in vec4 rgba ){\n    float f = pow(2.0, rgba.w * 255.0 - (128.0 + 8.0));\n    return rgba.rgb * (255.0 * f);\n}\n\nfloat saturate(float v){\n    return min(max(v,0.),1.);\n}\n\nvec4 tex2dLod(sampler2D tex, float u, float v, float lod){\n\tvec2 uv = vec2(u,v);\n\tuv+=mod(gl_FragCoord.xy-vec2(0.5),2.0)*vec2(128.,0.);\n\treturn texture2D(tex,uv,lod-16.);\n}\n\n/*\n* 对一个全景图进行采样。假设x轴指向中心。\n*/\nvec4 texPanorama(sampler2D tex, const in vec3 dir){\n\tfloat envu = atan(dir.z,dir.x)/_2PI+0.5; \t\n\tfloat envv = acos(dir.y)/PI;//(1.0-dir.y)/2.0;\n\treturn texture2D(tex,vec2(envu,envv));\n}\n\nvec4 texPanoramaLod(sampler2D tex, const in vec3 dir, float lod){\n\tfloat envu = atan(dir.z,dir.x)/_2PI+0.5; \t\n\tfloat envv = acos(dir.y)/PI;//(1.0-dir.y)/2.0;\n\treturn tex2dLod(tex,envu,envv,lod);\n}\n\n/*\n    计算sh光照。\n    使用level=2，所以需要9个系数。\n    https://cseweb.ucsd.edu/~ravir/papers/envmap/envmap.pdf\n*/\nfloat environment_exposure = 1.0;\nvec3 diff_sh9(vec3 dir){\n\tvec4 shDir = vec4(dir.x,-dir.z,dir.y,1.0);\n  return max(vec3(0.0), vec3(\n\tdot(shDir, irrad_mat_red * shDir),\n\tdot(shDir, irrad_mat_green * shDir),\n\tdot(shDir, irrad_mat_blue * shDir)\n\t)) * environment_exposure;\t\n}\n\n#ifdef HAS_TANGENT\nvec3 applyNormalTex( vec3 norm, vec3 surf_norm ) {\n    vec3 mapN = norm * 2.0 - 1.0;\n    //mapN.xy = normalScale * mapN.xy;\n    mat3 tsn = mat3( vWorldTangent, vWorldBinormal, surf_norm );\n    return normalize( tsn * mapN );\n}\n#endif\n\nvec4 pbrlight(vec3 normal, float rough, float NoV, vec3 R){\n    vec4 basecolor = texture2D(texBaseColor,vUv);\n\tbasecolor.rgb = pow(basecolor.rgb,vec3(2.2));\n\tfloat metaless = 1.0; \t\n\tconst float ismetalinfov = (128./255.);\n\tif(basecolor.a>=ismetalinfov){//这时候表示金属度\n\t\tmetaless = (basecolor.a-ismetalinfov)*2.;\n\t\tbasecolor.a = 1.0;\n\t}else{\n\t\tmetaless = 0.;\n\t\tbasecolor.a = basecolor.a*2.0;\n\t}\n\t#ifdef FIX_METALESS\n\tmetaless = u_metaless;\n\t#endif\n\t#ifdef HAS_PBRINFO\t\n\tvec4 pbrinfo = texture2D(texPbrInfo, vUv);\n\tmetaless = pbrinfo.b;\n\trough = pbrinfo.g;\n\t#endif\n    const vec3 nonmetalF0 =vec3(0.02);\n    vec3 F0 =  mix(nonmetalF0, basecolor.rgb, metaless);\n\t\n    vec4 PrefilteredColor = texPanoramaLod(texPrefilterdEnv, R, rough*maxlv);\n    PrefilteredColor.rgb = _RGBEToRGB(PrefilteredColor);\n    vec4 EnvBRDF = texture2D(texBRDFLUT,vec2(rough , NoV));//TODO lod\n    vec2 rg = _RGBAToU16(EnvBRDF);    \n    speccontrib = (F0* rg.x + saturate( 50.0 * PrefilteredColor.g ) * rg.y);\n\tvec3 color_spec = PrefilteredColor.rgb*speccontrib;\n\t\n\tvec3 color_diff=diff_sh9(normal);\n\tvec3 outc =  color_diff*mix(basecolor.rgb,vec3(0.),metaless)*(vec3(1.0)-speccontrib)+color_spec;\n\t#ifdef HAS_PBRINFO\n\toutc*=pbrinfo.r;\n\t#endif\n\treturn vec4(outc, basecolor.a);\n}\n\nvec3 oldlight(vec4 normal, float NoV, vec3 R){\n    vec4 basecolor = texture2D(texBaseColor,vUv);\n\tconst vec3 lightdir=normalize(vec3(1.,1.,0.));\n\tconst vec3 spcecol = vec3(1.,0.8,0.8);\n\tconst vec3 amb = vec3(0.5);\n\tvec3 diffv =  (vec3(saturate(dot(lightdir,normal.xyz)))+amb);\n\t//vec3 spec = spcecol* pow(saturate(dot(R,lightdir)),(1.-pbrinfo.g)*5.);\n\treturn diffv*basecolor.rgb;//+spec;\n}\n\n#include "ShadowHelper.glsl"\n#ifdef RECEIVESHADOW\nvarying float v_posViewZ;\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\n\nvoid main() {\n#ifdef CASTSHADOW\n\tgl_FragColor=packDepth(gl_FragCoord.w);\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tfloat alpha = texture2D(texBaseColor,vUv).w;\n\t\tif( alpha < u_AlphaTestValue ){\n\t\t\tdiscard;\n\t\t}\n\t#endif\n#else\n\n\t#ifdef RECEIVESHADOW\n\t\tfloat shadowValue = 1.0;\n\t\t#ifdef SHADOWMAP_PSSM3\n\t\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,vWorldPos.xyz,v_posViewZ,0.0001);\n\t\t#endif\n\t\t#ifdef SHADOWMAP_PSSM2\n\t\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,vWorldPos.xyz,v_posViewZ,0.0001);\n\t\t#endif \n\t\t#ifdef SHADOWMAP_PSSM1\n\t\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.0001);\n\t\t#endif\n\t#endif\t\n\t\n    vec3 normal =  normalize(vWorldNorm);\n\tvec4 normtex = texture2D( texNormal, vUv );\n\t#ifdef HAS_TANGENT\t\n\tnormal = applyNormalTex(normtex.xyz, normal);\n\t#endif\n    vec3 view   = -normalize(vViewDir);\n    float NoV = saturate(dot( view, normal ));\n    vec3 R = 2. * NoV * normal - view;\n\tfloat roughness = normtex.a;\n\t#ifdef FIX_ROUGHNESS\n\troughness = u_roughness;\n\t#endif\n\t\n\tvec4 pbrl = pbrlight(normal,roughness,NoV,R)*u_hdrexposure;\n    gl_FragColor.rgb =  pow(pbrl.rgb,vec3(0.45455));\n\t//gl_FragColor.rgb = oldlight(normtex,NoV,R);\n\t#ifdef RECEIVESHADOW\n\tgl_FragColor.rgb *= max(shadowValue,0.7);\n\t#endif\n\t\n    gl_FragColor.a = pbrl.a;\n\n#endif\n}\n',a=ui.add(l,t,e,i,n),Gi.SHADERDEFINE_FIX_METALESS=a.registerMaterialDefine("FIX_METALESS"),Gi.SHADERDEFINE_FIX_ROUGHNESS=a.registerMaterialDefine("FIX_ROUGHNESS"),Gi.SHADERDEFINE_HAS_TANGENT=a.registerMaterialDefine("HAS_TANGENT"),Gi.SHADERDEFINE_HAS_PBRINFO=a.registerMaterialDefine("HAS_PBRINFO"),Gi.SHADERDEFINE_USE_GROUNDTRUTH=a.registerMaterialDefine("USE_GROUNDTRUTH"),Gi.SHADERDEFINE_TEST_CLIPZ=a.registerMaterialDefine("CLIPZ"),i={a_Position:0,a_Normal:3,a_Tangent0:5,a_Texcoord0:2,a_BoneWeights:7,a_BoneIndices:6},n={u_Bones:[0,0],u_MvpMatrix:[1,2],u_WorldMat:[0,2],u_CameraPos:[0,3],u_AlphaTestValue:[0,1],u_DiffuseColor:[7,1],u_EmissionColor:[8,1],u_DiffuseTexture:[1,1],u_NormalTexture:[3,1],u_ParallaxTexture:[4,1],u_MetallicGlossTexture:[2,1],u_OcclusionTexture:[5,1],u_EmissionTexture:[6,1],u_metallic:[9,1],u_smoothness:[10,1],u_smoothnessScale:[11,1],u_occlusionStrength:[13,1],u_normalScale:[14,1],u_parallaxScale:[15,1],u_TilingOffset:[17,1],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Color":[4,4],u_AmbientColor:[21,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]};var h=Fi.nameKey.add("PBRStandard");t="attribute vec4 a_Position;\nattribute vec3 a_Normal;\nattribute vec4 a_Tangent0;\nattribute vec2 a_Texcoord0;\n\nuniform mat4 u_MvpMatrix;\nuniform mat4 u_WorldMat;\nuniform vec3 u_CameraPos;\n\nvarying vec2 v_Texcoord0;\nvarying vec3 v_Normal;\nvarying vec3 v_Tangent;\nvarying vec3 v_Binormal;\nvarying vec3 v_ViewDir;\nvarying vec3 v_PositionWorld;\n\n#ifdef TILINGOFFSET\n\tuniform vec4 u_TilingOffset;\n#endif\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n  #ifdef SHADOWMAP_PSSM1 \n\t  varying vec4 v_lightMVPPos;\n\t  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\n#ifdef BONE\n\tconst int c_MaxBoneCount = 24;\n\tattribute vec4 a_BoneIndices;\n\tattribute vec4 a_BoneWeights;\n\tuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\nvoid main_castShadow()\n{\n\t#ifdef BONE\n\t\tmat4 skinTransform=mat4(0.0);\n\t\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tvec4 position = skinTransform * a_Position;\n\t\tgl_Position = u_MvpMatrix * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * a_Position;\n\t#endif\n\t \n\t//TODO没考虑UV动画呢\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tv_Texcoord0 = a_Texcoord0;\n\t#endif\n\t\tv_posViewZ = gl_Position.z;\n}\n\nvoid main_normal()\n{\n\tmat3 worldMat;\n\t#ifdef BONE\n\t\tmat4 skinTransform = mat4(0.0);\n\t\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tvec4 position = skinTransform * a_Position;\n\t\tgl_Position = u_MvpMatrix * position;\n\t\tworldMat=mat3(u_WorldMat*skinTransform);\n\t\tv_PositionWorld = (u_WorldMat * position).xyz;\n\t#else\n\t\tgl_Position = u_MvpMatrix * a_Position;\n\t\tworldMat = mat3(u_WorldMat);\n\t\tv_PositionWorld = (u_WorldMat * a_Position).xyz;\n\t#endif\n\t\n\tv_Normal = worldMat * a_Normal;\n\tv_Tangent = worldMat * a_Tangent0.xyz;\n\tv_Binormal = cross(v_Normal, v_Tangent) * a_Tangent0.w;\n  \n\tv_Texcoord0 = a_Texcoord0;\n\t#ifdef TILINGOFFSET\n\t\tv_Texcoord0=(vec2(v_Texcoord0.x,v_Texcoord0.y-1.0)*u_TilingOffset.xy)+u_TilingOffset.zw;\n\t#endif\n\t\tv_Texcoord0=vec2(v_Texcoord0.x,1.0 + v_Texcoord0.y);\n  \n\tv_ViewDir = u_CameraPos - v_PositionWorld;\n  \n\t#ifdef RECEIVESHADOW\n\t\tv_posViewZ = gl_Position.w;\n\t\t#ifdef SHADOWMAP_PSSM1 \n\t\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n\t\t#endif\n\t#endif\n}\n\nvoid main()\n{\n\t#ifdef CASTSHADOW\n\t\tmain_castShadow();\n\t#else\n\t\tmain_normal();\n\t#endif\n}",e='#ifdef FSHIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nvarying vec2 v_Texcoord0;\nvarying vec3 v_Normal;\nvarying vec3 v_Tangent;\nvarying vec3 v_Binormal;\nvarying vec3 v_ViewDir;\n\nuniform vec4 u_AmbientColor;\nuniform vec4 u_DiffuseColor;\n\n#ifdef DIFFUSETEXTURE\n\tuniform sampler2D u_DiffuseTexture;\n#endif\n#ifdef METALLICGLOSSTEXTURE\n\tuniform sampler2D u_MetallicGlossTexture;\n#endif\n#ifdef NORMALTEXTURE\n\tuniform sampler2D u_NormalTexture;\n\tuniform float u_normalScale;\n#endif\n#ifdef PARALLAXTEXTURE\n\tuniform sampler2D u_ParallaxTexture;\n\tuniform float u_parallaxScale;\n#endif\n#ifdef OCCLUSIONTEXTURE\n\tuniform sampler2D u_OcclusionTexture;\n\tuniform float u_occlusionStrength;\n#endif\n#ifdef EMISSION\n\t#ifdef EMISSIONTEXTURE\n\t\tuniform sampler2D u_EmissionTexture;\n\t#endif\n\tuniform vec4 u_EmissionColor;\n#endif\n\nuniform float u_AlphaTestValue;\nuniform float u_metallic;\nuniform float u_smoothness;\nuniform float u_smoothnessScale;\n\n#include "PBRStandardLighting.glsl"\n#include "ShadowHelper.glsl"\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\t\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\t\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\n\nuniform DirectionLight u_DirectionLight;\n\nvoid main_castShadow()\n{\n\tgl_FragColor=packDepth(v_posViewZ);\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tfloat alpha = texture2D(u_DiffuseTexture,v_Texcoord0).w;\n\t\tif( alpha < u_AlphaTestValue )\n\t\t{\n\t\t\tdiscard;\n\t\t}\n\t#endif\n}\n\nvoid main_normal()\n{\t\n\tvec3 viewDir = normalize(v_ViewDir);\n\t\n\tvec2 uv0 = ParallaxOffset(viewDir);\n\t\n\tvec2 mg;\n\t#ifdef DIFFUSETEXTURE\n\t\tvec4 diffuseTextureColor = texture2D(u_DiffuseTexture, uv0);\n\t\tvec4 diffuseColor = diffuseTextureColor * u_DiffuseColor;\n\t\tmg = MetallicGloss(diffuseTextureColor.a, uv0);\n\t#else\n\t\tvec4 diffuseColor = u_DiffuseColor;\n\t\tmg = MetallicGloss(1.0, uv0);\n\t#endif\n\t\n\t#ifdef ALPHATEST\n\t\tif(diffuseColor.a < u_AlphaTestValue)\n\t\t\tdiscard;\n\t#endif\n\t\n\tgl_FragColor = diffuseColor;\n\t\n\tvec3 normal = UnpackScaleNormal(uv0);\n  \n\tvec3 gi = (u_AmbientColor * Occlusion(uv0)).rgb;\n  \n\tvec4 color = PBRStandardDiectionLight(diffuseColor.rgb, mg.r, mg.g, normal, viewDir, u_DirectionLight, gi);\n\t\n\tcolor.a = diffuseColor.a;\n\t\n\t#ifdef EMISSION\n\t\tvec4 emissionColor = u_EmissionColor;\n\t\t#ifdef EMISSIONTEXTURE\n\t\t\temissionColor *=  texture2D(u_EmissionTexture, uv0);\n\t\t#endif\n\t\tcolor.rgb += emissionColor.rgb;\n\t#endif\n\t\n\t#ifdef RECEIVESHADOW\n\t\tfloat shadowValue = 1.0;\n\t\t#ifdef SHADOWMAP_PSSM3\n\t\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t\t#endif\n\t\t#ifdef SHADOWMAP_PSSM2\n\t\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t\t#endif \n\t\t#ifdef SHADOWMAP_PSSM1\n\t\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n\t\t#endif\n\t\tgl_FragColor = vec4(color.rgb * shadowValue, color.a);\n\t#else\n\t\tgl_FragColor = color;\n\t#endif\n}\n\nvoid main()\n{\n\t#ifdef CASTSHADOW\t\t\n\t\tmain_castShadow();\n\t#else\n\t\tmain_normal();\n\t#endif  \n}\n\n',a=ui.add(h,t,e,i,n),ki.SHADERDEFINE_DIFFUSETEXTURE=a.registerMaterialDefine("DIFFUSETEXTURE"),ki.SHADERDEFINE_METALLICGLOSSTEXTURE=a.registerMaterialDefine("METALLICGLOSSTEXTURE"),ki.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA=a.registerMaterialDefine("SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA"),ki.SHADERDEFINE_NORMALTEXTURE=a.registerMaterialDefine("NORMALTEXTURE"),ki.SHADERDEFINE_PARALLAXTEXTURE=a.registerMaterialDefine("PARALLAXTEXTURE"),ki.SHADERDEFINE_OCCLUSIONTEXTURE=a.registerMaterialDefine("OCCLUSIONTEXTURE"),ki.SHADERDEFINE_EMISSION=a.registerMaterialDefine("EMISSION"),ki.SHADERDEFINE_EMISSIONTEXTURE=a.registerMaterialDefine("EMISSIONTEXTURE"),ki.SHADERDEFINE_TILINGOFFSET=a.registerMaterialDefine("TILINGOFFSET"),i={a_Position:0,a_Normal:3,a_Tangent0:5,a_Texcoord0:2,a_BoneWeights:7,a_BoneIndices:6},n={u_Bones:[0,0],u_MvpMatrix:[1,2],u_WorldMat:[0,2],u_CameraPos:[0,3],u_AlphaTestValue:[0,1],u_DiffuseColor:[7,1],u_SpecularColor:[8,1],u_EmissionColor:[9,1],u_DiffuseTexture:[1,1],u_NormalTexture:[3,1],u_ParallaxTexture:[4,1],u_SpecularTexture:[2,1],u_OcclusionTexture:[5,1],u_EmissionTexture:[6,1],u_smoothness:[10,1],u_smoothnessScale:[11,1],u_occlusionStrength:[13,1],u_normalScale:[14,1],u_parallaxScale:[15,1],u_TilingOffset:[17,1],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Color":[4,4],u_AmbientColor:[21,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]};var u=Fi.nameKey.add("PBRSpecular");t="attribute vec4 a_Position;\nattribute vec3 a_Normal;\nattribute vec4 a_Tangent0;\nattribute vec2 a_Texcoord0;\n\nuniform mat4 u_MvpMatrix;\nuniform mat4 u_WorldMat;\nuniform vec3 u_CameraPos;\n\nvarying vec2 v_Texcoord0;\nvarying vec3 v_Normal;\nvarying vec3 v_Tangent;\nvarying vec3 v_Binormal;\nvarying vec3 v_ViewDir;\nvarying vec3 v_PositionWorld;\n\n#ifdef TILINGOFFSET\n\tuniform vec4 u_TilingOffset;\n#endif\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n  #ifdef SHADOWMAP_PSSM1 \n\t  varying vec4 v_lightMVPPos;\n\t  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\n#ifdef BONE\n\tconst int c_MaxBoneCount = 24;\n\tattribute vec4 a_BoneIndices;\n\tattribute vec4 a_BoneWeights;\n\tuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\nvoid main_castShadow()\n{\n\t#ifdef BONE\n\t\tmat4 skinTransform=mat4(0.0);\n\t\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tvec4 position = skinTransform * a_Position;\n\t\tgl_Position = u_MvpMatrix * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * a_Position;\n\t#endif\n\t \n\t//TODO没考虑UV动画呢\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tv_Texcoord0 = a_Texcoord0;\n\t#endif\n\t\tv_posViewZ = gl_Position.z;\n}\n\nvoid main_normal()\n{\n\tmat3 worldMat;\n\t#ifdef BONE\n\t\tmat4 skinTransform = mat4(0.0);\n\t\tskinTransform += u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tvec4 position = skinTransform * a_Position;\n\t\tgl_Position = u_MvpMatrix * position;\n\t\tworldMat=mat3(u_WorldMat*skinTransform);\n\t\tv_PositionWorld = (u_WorldMat * position).xyz;\n\t#else\n\t\tgl_Position = u_MvpMatrix * a_Position;\n\t\tworldMat = mat3(u_WorldMat);\n\t\tv_PositionWorld = (u_WorldMat * a_Position).xyz;\n\t#endif\n\t\n\tv_Normal = worldMat * a_Normal;\n\tv_Tangent = worldMat * a_Tangent0.xyz;\n\tv_Binormal = cross(v_Normal, v_Tangent) * a_Tangent0.w;\n  \n\tv_Texcoord0 = a_Texcoord0;\n\t#ifdef TILINGOFFSET\n\t\tv_Texcoord0=(vec2(v_Texcoord0.x,v_Texcoord0.y-1.0)*u_TilingOffset.xy)+u_TilingOffset.zw;\n\t#endif\n\t\tv_Texcoord0=vec2(v_Texcoord0.x,1.0 + v_Texcoord0.y);\n  \n\tv_ViewDir = u_CameraPos - v_PositionWorld;\n  \n\t#ifdef RECEIVESHADOW\n\t\tv_posViewZ = gl_Position.w;\n\t\t#ifdef SHADOWMAP_PSSM1 \n\t\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n\t\t#endif\n\t#endif\n}\n\nvoid main()\n{\n\t#ifdef CASTSHADOW\n\t\tmain_castShadow();\n\t#else\n\t\tmain_normal();\n\t#endif\n}",e='#ifdef FSHIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nvarying vec2 v_Texcoord0;\nvarying vec3 v_Normal;\nvarying vec3 v_Tangent;\nvarying vec3 v_Binormal;\nvarying vec3 v_ViewDir;\n\nuniform vec4 u_AmbientColor;\nuniform vec4 u_DiffuseColor;\nuniform vec4 u_SpecularColor;\n\n#ifdef DIFFUSETEXTURE\n\tuniform sampler2D u_DiffuseTexture;\n#endif\n#ifdef SPECULARTEXTURE\n\tuniform sampler2D u_SpecularTexture;\n#endif\n#ifdef NORMALTEXTURE\n\tuniform sampler2D u_NormalTexture;\n\tuniform float u_normalScale;\n#endif\n#ifdef PARALLAXTEXTURE\n\tuniform sampler2D u_ParallaxTexture;\n\tuniform float u_parallaxScale;\n#endif\n#ifdef OCCLUSIONTEXTURE\n\tuniform sampler2D u_OcclusionTexture;\n\tuniform float u_occlusionStrength;\n#endif\n#ifdef EMISSION\n\t#ifdef EMISSIONTEXTURE\n\t\tuniform sampler2D u_EmissionTexture;\n\t#endif\n\tuniform vec4 u_EmissionColor;\n#endif\n\nuniform float u_AlphaTestValue;\nuniform float u_metallic;\nuniform float u_smoothness;\nuniform float u_smoothnessScale;\n\n#include "PBRSpecularLighting.glsl"\n#include "ShadowHelper.glsl"\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\t\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\t\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\n\nuniform DirectionLight u_DirectionLight;\n\nvoid main_castShadow()\n{\n\tgl_FragColor=packDepth(v_posViewZ);\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tfloat alpha = texture2D(u_DiffuseTexture,v_Texcoord0).w;\n\t\tif( alpha < u_AlphaTestValue )\n\t\t{\n\t\t\tdiscard;\n\t\t}\n\t#endif\n}\n\nvoid main_normal()\n{\t\n\tvec3 viewDir = normalize(v_ViewDir);\n\t\n\tvec2 uv0 = ParallaxOffset(viewDir);\n\t\n\tvec4 sg;\n\t#ifdef DIFFUSETEXTURE\n\t\tvec4 diffuseTextureColor = texture2D(u_DiffuseTexture, uv0);\n\t\tvec4 diffuseColor = diffuseTextureColor * u_DiffuseColor;\n\t\tsg = SpecularGloss(diffuseTextureColor.a, uv0);\n\t#else\n\t\tvec4 diffuseColor = u_DiffuseColor;\n\t\tsg = SpecularGloss(1.0, uv0);\n\t#endif\n\t\n\t#ifdef ALPHATEST\n\t\tif(diffuseColor.a < u_AlphaTestValue)\n\t\t\tdiscard;\n\t#endif\n  \n\tvec3 normal = UnpackScaleNormal(uv0);\n\t\n\tvec3 gi = (u_AmbientColor * Occlusion(uv0)).rgb;\n\t\n\t//float a = (sg.r+sg.g+sg.b) / 3.0;\n  \n\tvec4 color = PBRSpecularDiectionLight(diffuseColor.rgb, sg.rgb, sg.a, normal,viewDir, u_DirectionLight, gi);\n\t\n\tcolor.a = diffuseColor.a;\n\t\n\t#ifdef EMISSION\n\t\tvec4 emissionColor = u_EmissionColor;\n\t\t#ifdef EMISSIONTEXTURE\n\t\t\temissionColor *=  texture2D(u_EmissionTexture, uv0);\n\t\t#endif\n\t\tcolor.rgb += emissionColor.rgb;\n\t#endif\n\t\n\t#ifdef RECEIVESHADOW\n\t\tfloat shadowValue = 1.0;\n\t\t#ifdef SHADOWMAP_PSSM3\n\t\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t\t#endif\n\t\t#ifdef SHADOWMAP_PSSM2\n\t\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t\t#endif \n\t\t#ifdef SHADOWMAP_PSSM1\n\t\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n\t\t#endif\n\t\tgl_FragColor = vec4(color.rgb * shadowValue, color.a);\n\t#else\n\t\tgl_FragColor = color;\n\t#endif\n}\n\nvoid main()\n{\n\t#ifdef CASTSHADOW\t\t\n\t\tmain_castShadow();\n\t#else\n\t\tmain_normal();\n\t#endif  \n}\n\n',a=ui.add(u,t,e,i,n),zi.SHADERDEFINE_DIFFUSETEXTURE=a.registerMaterialDefine("DIFFUSETEXTURE"),zi.SHADERDEFINE_SPECULARTEXTURE=a.registerMaterialDefine("SPECULARTEXTURE"),zi.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA=a.registerMaterialDefine("SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA"),zi.SHADERDEFINE_NORMALTEXTURE=a.registerMaterialDefine("NORMALTEXTURE"),zi.SHADERDEFINE_PARALLAXTEXTURE=a.registerMaterialDefine("PARALLAXTEXTURE"),zi.SHADERDEFINE_OCCLUSIONTEXTURE=a.registerMaterialDefine("OCCLUSIONTEXTURE"),zi.SHADERDEFINE_EMISSION=a.registerMaterialDefine("EMISSION"),zi.SHADERDEFINE_EMISSIONTEXTURE=a.registerMaterialDefine("EMISSIONTEXTURE"),zi.SHADERDEFINE_TILINGOFFSET=a.registerMaterialDefine("TILINGOFFSET"),i={a_position:0,a_normal:3,uv:2},n={irrad_mat_red:[10,3],irrad_mat_green:[11,3],irrad_mat_blue:[12,3],u_hdrexposure:[13,3],texBaseColor:[1,1],texNormal:[2,1],texSky:[11,1],texUnderWater:[3,1],texPrefilterdEnv:[8,3],texPrefilterDiff:[7,3],texWaterDisp:[4,1],texWaveDetail:[9,1],texDeepColor:[10,1],texWaterInfo:[16,1],texFoam:[17,1],GEOWAVE_UV_SCALE:[18,1],modelMatrix:[0,2],mvp:[1,2],cameraPosition:[0,3],u_curTm:[8,1],u_scrsize:[15,1],u_WaveInfoD:[13,1],u_WaveInfo:[12,1],u_WaveMainDir:[14,1],u_DeepScale:[20,1],u_SeaColor:[19,1],u_View:[1,3],u_Project:[2,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Attenuation":[7,4],"u_PointLight.Diffuse":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Attenuation":[13,4],"u_SpotLight.Diffuse":[14,4]};var _=Fi.nameKey.add("Water");t='\nuniform mat4 modelMatrix;\n//uniform mat4 modelViewMatrix;\n//uniform mat4 projectionMatrix;\nuniform mat4 u_View;\nuniform mat4 u_Project;\nuniform mat4 mvp;\n//uniform mat4 viewMatrix;\nuniform vec3 cameraPosition;\nuniform float u_curTm;\n\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 uv;\n//uniform sampler2D texWaterDisp;\n#ifdef USE_VERTEX_DEEPINFO\n#else\nuniform sampler2D texWaterInfo;\nvarying vec4 vWaterInfo;\nuniform float u_DeepScale;//texWaterInfo.r*vDeepScale\n#endif\nuniform float u_WaveMainDir;\t//主波方向\nuniform float GEOWAVE_UV_SCALE ;//= 100.0;\n\n\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\nvarying vec3 vWorldTan;\nvarying vec3 vWorldBin;\nvarying vec4 vViewPos;\nvarying vec4 vWorldPos;\nvarying vec3 vLightDir;\nvarying vec3 vViewDir;\nvarying vec3 vDisp;\nvarying float fDeep;\nvarying mat2 matUVTrans;\nvarying float fFoam;\n\nconst float PI = 3.14159265358979323846264;\n\n#include "WaveFunction.glsl"\n\nvec2 getPosFromUV(vec2 uv){\n\treturn uv*50.;\n}\n\nvoid main() {\n\tvec3 pos = a_position;\n    vUv = uv;\n\t\n\t//vDisp = texture2D(texWaterDisp,uv).rgb;\n\t//vec3 disp = vDisp;\n\t\n\t//TODO 这里有个潜规则。\n\tfloat tt = pos.y; pos.y=pos.z; pos.z=-tt;\n\t\n\t#ifdef USE_VERTEX_DEEPINFO\n\tfDeep = -pos.y;\n\tpos.y=0.0;\n\t#else\n\tvWaterInfo = texture2D(texWaterInfo,uv);\n\tfDeep = vWaterInfo.r*u_DeepScale;\n\t#endif\n\t\n\t\n\t//计算波形\n\tmat4 modelMat = modelMatrix;\n\tvec3 opos, T,B,N;\n\tfloat foams=0.;\n\tvec2 uvpos = uv*GEOWAVE_UV_SCALE+vec2(modelMat[3][0],0.);//TODO 如果有旋转缩放怎么办\n\tcalcGerstnerWave(u_curTm, pos,fDeep, uvpos,opos,B,T,N,foams);\n\tfFoam = foams;\n\tgl_Position = mvp*vec4(opos,1.);\n\tvWorldPos = modelMat*vec4(opos,1.);\n\n\tvWorldNorm = normalize((modelMatrix*vec4(N,0.0)).xyz);\n\tvWorldTan = normalize((modelMatrix*vec4(T,0.0)).xyz);\n\tvWorldBin = normalize((modelMatrix*vec4(B,0.0)).xyz);\n    vViewDir = vWorldPos.xyz-cameraPosition; //这个不能取normalize，否则会引入非线性\n\t\n\tfloat s = sin(u_WaveMainDir);\n\tfloat c = cos(u_WaveMainDir);\n\tmatUVTrans = mat2(c,-s,s,c);\n}\n',e="//#version 300 es\n\nprecision highp float;\nprecision lowp int;\n\nconst float PI = 3.14159265358979323846264;\nconst float _2PI = 6.2831853071796;\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\nvarying vec3 vWorldTan;\nvarying vec3 vWorldBin;\nvarying vec3 vViewDir;//入射。pos-cam\nvarying vec4 vViewPos;\nvarying vec4 vWorldPos;\nvarying float fDeep;\nvarying mat2 matUVTrans;\n#ifdef USE_VERTEX_DEEPINFO\n#else\nvarying vec4 vWaterInfo;\n#endif\nmat3 matTBNOff;//\n\n//\nuniform sampler2D texBaseColor;\nuniform sampler2D texNormal;\n#ifdef CUBE_ENV\nuniform samplerCube texSky;\n#else\nuniform sampler2D texSky;\n#endif\nuniform sampler2D texUnderWater;\nuniform sampler2D texWaveDetail;\n//uniform sampler2D texDeepColor;\nuniform sampler2D texFoam;\nvarying float fFoam;\nuniform float u_curTm;\nuniform vec2 u_scrsize;\nuniform vec3 u_SeaColor;//\n\nconst int NumTexWaves=4;\nconst float Amp_over_L = 0.01;\n//const vec3 SEA_COLOR1 = vec3(0.0292,0.672,0.7467);//大洋\n//const vec3 SEA_COLOR2 = vec3(0,0.927,0.43);//近海\n\nconst float _maxu8 = 255.0;\nconst float _maxu16 = 65535.0;\nconst float _shift8 = 256.0;    //平移的话是*256而不是255\nvec2 _RGBAToU16(const in vec4 rgba){\n    return vec2((rgba.r*_maxu8+rgba.g*_maxu8*_shift8)/_maxu16, (rgba.b*_maxu8+rgba.a*_maxu8*_shift8)/_maxu16);\n}\nvec3 _RGBEToRGB( const in vec4 rgba ){\n    float f = pow(2.0, rgba.w * 255.0 - (128.0 + 8.0));\n    return rgba.rgb * (255.0 * f);\n}\n\nfloat saturate(float v){\n    return min(max(v,0.),1.);\n}\n\n/*\n\t各种 ToneMap\n*/\n//Reinhard\nvec3 ReinhardToneMapping(vec3 color, float adapted_lum) {\n    const float MIDDLE_GREY = 1.;\n    color *= MIDDLE_GREY / adapted_lum;\n    return color / (1.0 + color);\n}\n\n//CE2\nvec3 CEToneMapping(vec3 color, float adapted_lum){\n    return 1. - exp(-adapted_lum * color);\n}\n\n//UC2\nvec3 F1(vec3 x){\n\tconst float A = 0.22;\n\tconst float B = 0.30;\n\tconst float C = 0.10;\n\tconst float D = 0.20;\n\tconst float E = 0.01;\n\tconst float F = 0.30;\n \n\treturn ((x * (A * x + C * B) + D * E) / (x * (A * x + B) + D * F)) - E / F;\n}\n\nvec3 Uncharted2ToneMapping(vec3 color, float adapted_lum){\n\tconst vec3 WHITE = vec3(11.2);\n\treturn F1(1.6 * adapted_lum * color) / F1(WHITE);\n}\n\n//ACES\nvec3 ACESToneMapping(vec3 color, float adapted_lum){\n\tconst float A = 2.51;\n\tconst float B = 0.03;\n\tconst float C = 2.43;\n\tconst float D = 0.59;\n\tconst float E = 0.14;\n\n\tcolor *= adapted_lum;\n\treturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\n\n/*\n* 对一个全景图进行采样。假设x轴指向中心。\n*/\nvec4 texPanorama(sampler2D tex, const in vec3 dir){\n\tfloat envu = atan(dir.z,dir.x)/_2PI+0.5; \t\n\tfloat envv = acos(dir.y)/PI;//(1.0-dir.y)/2.0;\n\treturn texture2D(tex,vec2(envu,envv));\n}\n\n/*\n\t与位于0点的测试棒的相交测试交点\n\t这个是瞎写的，只是为了测试\n*/\nbool hitClydiner(vec3 pos, vec3 dir, out vec3 hitpos, out vec3 hitnormal){\n\tconst float r = 0.5;\n\tfloat a = dir.x*dir.x+dir.z*dir.z;\n\tfloat b = 2.*dir.x*pos.x+2.*dir.z*pos.z;\n\tfloat c = pos.x*pos.x+pos.z*pos.z-r*r;\n\tfloat d = b*b-4.*a*c;\n\tif(d>=0.0){\n\t\tfloat t = (-b+sqrt(d))/2./a;\n\t\tt =min(t, (-b-sqrt(d))/2./a);\n\t\thitpos = pos+dir*t;\n\t\treturn true;\n\t}\n\t/*\n\tvec3 v1 = normalize(cross(dir,vec3(0.,1.,0.)));//公垂线\n\tfloat dist = dot(pos,v1);//最短距离\n\tif(abs(dist)<r){\n\t\treturn true;\n\t}\n\t*/\n\treturn false;\n}\n\n///* 根据散射公式来计算某个方向的颜色 *///\n//\nfloat phase_function(float costheta, float g, float g2){\n\treturn 1.5*( (1.0-g2) / (2.0+g2) ) * (1.0+costheta*costheta) / pow(1.0+g2-2.0*g*costheta, 1.5);\t\n}\n\nconst float _density = .2;\nconst vec3 _vLightDir=vec3(0.,-1.,0.);//必须是规格化的\nconst int _SAMPLENUM = 20;\nconst float _K1 = 1.0;\nconst float _g = -0.93;\n//\nvec3 calcScatter(vec3 start, vec3 dir, vec3 end){\n\tfloat len = length(end-start);\n\tfloat costheta = dot(dir,_vLightDir);\n\tfloat g2 = _g*_g;\n\tfloat K = _K1*len*_density*phase_function(costheta,_g,g2);\n\t//用分段的方式来积分\n\tfloat dlen = len/float(_SAMPLENUM);//距离平分\n\tfloat ddeep = (start.y-end.y)/float(_SAMPLENUM);//深度平分\n\tfloat sum=0.;\n\tfor( int i=0; i<_SAMPLENUM; i++){\n\t\tfloat fi = float(i);\n\t\tfloat v1 = exp(-_density*(dlen+ddeep)*fi);//TODO 应该可以用分析法计算出来\n\t\tsum += v1;\n\t}\n\treturn vec3(K*sum);\n}\n///* 根据散射公式来计算某个方向的亮度  END *///\n\nconst float cDeep = -2.;\t//假设水的深度\nvec3 getShuiDiColor(vec3 pos, vec3 dir, vec3 normal){\n\t//一个无限大的水底，黑白格纹理。纹理长度为1米\n\tfloat t = ( cDeep-pos.y )/dir.y;\n\tif(t<0.) return vec3(1.,0.,0.);//TEST\n\tbool bhit = false;\n\tvec3 hitpos;\n\tvec3 hitcolor;\n\tvec3 hn;\n\tif(hitClydiner(pos,dir,hitpos,hn) && hitpos.y>cDeep && hitpos.y<pos.y){\n\t\tbhit=true;\n\t\thitcolor = vec3(.8,.8,.8);\n\n\t}else\n\t{\n\t\thitpos = pos+dir*t;\n\t\tvec3 hp = floor(hitpos);\n\t\tfloat a = mod((hp.x+hp.z),2.);\n\t\thitcolor = (a<.9)?vec3(0.,0.,0.):vec3(1.,1.,1.);\n\t\t//hitcolor = texture2D(texUnderWater,hitpos.xz/10.).rgb;\n\t}\n\t\n\tfloat l = length(hitpos-pos);\n\t//return texture2D(texDeepColor,vec2(min(max(l/400.,0.),1.),0.5)).rgb;\n\t//return SEA_COLOR1*calcScatter(pos,dir,hitpos);\n\tfloat left = pow(0.8,l);//假设透过率为80%，则到达水底的时候的光强。\n\treturn mix(hitcolor,u_SeaColor,1.-left);\n}\n\n/*\n\tview已经normalize了\n*/\nvec3 getRefractColor(vec3 view,vec3 normal){\n\tvec3 T = refract(-view, normal, 0.7);\n\treturn getShuiDiColor(vWorldPos.xyz,T,normal); \n}\n\nvec4 calcWaterC(vec3 view, vec3 normal, float von, vec3 R, float rough){\n\t/*\n\t只有浪顶的法线向下，也就是波形形成了交叠的时候，才会这样，所以要通过参数控制避免出现这种情况，而不是在这里保护。\n\tif(dot(R,vec3(0.,1.,0.))<0.){\n\t\tR = -R;\n\t}\n\t*/\n\t//vec3 refr = getRefractColor(-view,normal);\n#ifdef USE_REFR_TEX\t\n\tvec3 refr = texture2D(texUnderWater, gl_FragCoord.xy/u_scrsize+normal.xz/8.).rgb;\n#else\n\tvec3 refr = u_SeaColor;\n#endif\n\tfloat F0=0.02;\n\t//菲涅尔，越大反射越强\n\tfloat f =  F0+(1.0-F0)*exp2((-5.55473*von-6.98316)*von);\n\t//float f = F0+(1.0-F0)*pow(1.-von,5.);\n\t//能看到水底的程度。反射剩余的*水中的衰减\n\t//float a = (1.-f)*(1.-deepk);\n#ifdef CUBE_ENV\n\tvec4 reflc = textureCube(texSky,R);\n#else\n\tvec4 reflc = texPanorama(texSky, R);\n#endif\n#ifdef HDR_ENV\n\tvec3 refl = _RGBEToRGB(reflc)*f;\n#else\n\tvec3 refl = reflc.rgb*f;\n#endif\n\t//return vec4(refl*(1.-rough),1.);\n\t\n\t//vec3 refl = reflc.rgb*f;\n\tvec3 final = mix(refr, u_SeaColor, min(fDeep/10.,1.))+refl*(max(0.,1.-rough));\n#ifdef HDR_ENV\n\tfinal = ACESToneMapping(final,1.);//TODO 这个要uniform传入\n#endif\n\treturn vec4(final,f);\n}\n\nvoid main() {\n    vec3 normal =  normalize(vWorldNorm);\n\t//如果uv=1为100米，希望每个细节纹理表示20米的小波形，则uv缩放是 100/20。细节纹理内部也要用这个值，即pos=uv*20\n\tvec2 ruv = matUVTrans*vUv;\n\tvec3 detailNorm = texture2D(texWaveDetail,fract(ruv*5.)).rgb*2.-vec3(1.);//TODO uv怎么算\n\tfloat texNormScale = 2.*PI*float(NumTexWaves)*Amp_over_L*2.5;\n\tdetailNorm *= vec3(texNormScale,1.,texNormScale);\n\t//旋转\n\t//细节纹理来自rendertarget，因此需要颠倒z\n\t\n\tmatTBNOff = mat3(matUVTrans[0][0],0.,matUVTrans[1][0],\n\t0.,1.,0.,\n\tmatUVTrans[0][1],0.,matUVTrans[1][1]\n\t);\n\t\n\t/*\n\tmatTBNOff = mat3(0.,0.,1.,\n\t0.,1.,0.,\n\t-1.,0.,0.\n\t);\n\t*/\n\n    mat3 tsn = mat3( vWorldBin, normal, vWorldTan);\t\n    //normal = normalize(tsn * matTBNOff * detailNorm);\n\tnormal = normalize(tsn * detailNorm); //这个应该更正确。因为本身方向就是根据uv算的，如果是静态图片才需要转换。\n\t//vec4 normtex = texture2D( texNormal, vUv );\n    vec3 view   = -normalize(vViewDir);//view 是指向camera的\n    float NoV = saturate(dot( view, normal ));\n    //vec3 R = 2. * NoV * normal - view;\n\t\n#ifdef USE_FOAM\t\n\tvec4 foamc = (texture2D(texFoam,vUv*50.)+texture2D(texFoam,vUv*20.))/2.;\n\tfloat nearcoast = 1.-min(fDeep/10.,1.);// 1.-vWaterInfo.r;\n\tfloat foams = (nearcoast/4.+fFoam)*2.*nearcoast;\n#else\n\tfloat foams =0.;\n#endif\n\t\n\tvec3 R = reflect(-view,normal);\n\tvec4 wc = calcWaterC(view, normal,NoV,R, foams);\n\n\tgl_FragColor.rgb = wc.rgb;//normalize(detailNorm).rrr;//((normal)+vec3(0.0))/1.;//normalize(normal).rgb;//texture2D(texWaveDetail,vUv).rgb;// fracColor * texture2D(texUnderWater, vUv*20.0).rgb;// vec3(1.0);//pbrl.rgb;\n    gl_FragColor.a = 1.0;//wc.a;\n#ifdef USE_FOAM\n\tgl_FragColor.rgb = mix(gl_FragColor.rgb,vec3(1.),foamc.a*foams);\n\tgl_FragColor.a = foamc.r;\n#endif\n\t//if(mod(vUv.x*100.,1.0)<0.02 || mod(vUv.y*100.,1.0)<0.02) gl_FragColor.rgb=vec3(0.5,.5,.5);\n\t//gl_FragColor.rgb = detailNorm;\n}\n",a=ui.add(_,t,e,i,n),Yi.SHADERDEFINE_CUBE_ENV=a.registerMaterialDefine("CUBE_ENV"),Yi.SHADERDEFINE_HDR_ENV=a.registerMaterialDefine("HDR_ENV"),Yi.SHADERDEFINE_SHOW_NORMAL=a.registerMaterialDefine("SHOW_NORMAL"),Yi.SHADERDEFINE_USEVERTEXHEIGHT=a.registerMaterialDefine("USE_VERTEX_DEEPINFO"),Yi.SHADERDEFINE_USE_FOAM=a.registerMaterialDefine("USE_FOAM"),Yi.SHADERDEFINE_USE_REFRACT_TEX=a.registerMaterialDefine("USE_REFR_TEX"),i={a_CornerTextureCoordinate:17,a_MeshPosition:0,a_MeshColor:1,a_MeshTextureCoordinate:2,a_ShapePositionStartLifeTime:30,a_DirectionTime:32,a_StartColor:19,a_EndColor:23,a_StartSize:20,a_StartRotation0:22,a_StartSpeed:31,a_Random0:34,a_Random1:35,a_SimulationWorldPostion:36,a_SimulationWorldRotation:37},n={u_Tintcolor:[2,1],u_TilingOffset:[3,1],u_texture:[1,1],u_WorldPosition:[0,2],u_WorldRotation:[1,2],u_PositionScale:[4,2],u_SizeScale:[5,2],u_ScalingMode:[6,2],u_Gravity:[7,2],u_ThreeDStartRotation:[8,2],u_StretchedBillboardLengthScale:[9,2],u_StretchedBillboardSpeedScale:[10,2],u_SimulationSpace:[11,2],u_CurrentTime:[12,2],u_ColorOverLifeGradientAlphas:[22,2],u_ColorOverLifeGradientColors:[23,2],u_MaxColorOverLifeGradientAlphas:[24,2],u_MaxColorOverLifeGradientColors:[25,2],u_VOLVelocityConst:[13,2],u_VOLVelocityGradientX:[14,2],u_VOLVelocityGradientY:[15,2],u_VOLVelocityGradientZ:[16,2],u_VOLVelocityConstMax:[17,2],u_VOLVelocityGradientMaxX:[18,2],u_VOLVelocityGradientMaxY:[19,2],u_VOLVelocityGradientMaxZ:[20,2],u_VOLSpaceType:[21,2],u_SOLSizeGradient:[26,2],u_SOLSizeGradientX:[27,2],u_SOLSizeGradientY:[28,2],u_SOLSizeGradientZ:[29,2],u_SOLSizeGradientMax:[30,2],u_SOLSizeGradientMaxX:[31,2],u_SOLSizeGradientMaxY:[32,2],u_SOLSizeGradientMaxZ:[33,2],u_ROLAngularVelocityConst:[34,2],u_ROLAngularVelocityConstSeprarate:[35,2],u_ROLAngularVelocityGradient:[36,2],u_ROLAngularVelocityGradientX:[37,2],u_ROLAngularVelocityGradientY:[38,2],u_ROLAngularVelocityGradientZ:[39,2],u_ROLAngularVelocityGradientW:[40,2],u_ROLAngularVelocityConstMax:[41,2],u_ROLAngularVelocityConstMaxSeprarate:[42,2],u_ROLAngularVelocityGradientMax:[43,2],u_ROLAngularVelocityGradientMaxX:[44,2],u_ROLAngularVelocityGradientMaxY:[45,2],u_ROLAngularVelocityGradientMaxZ:[46,2],u_ROLAngularVelocityGradientMaxW:[47,2],u_TSACycles:[48,2],u_TSASubUVLength:[49,2],u_TSAGradientUVs:[50,2],u_TSAMaxGradientUVs:[51,2],u_CameraPosition:[0,3],u_CameraDirection:[5,3],u_CameraUp:[6,3],u_View:[1,3],u_Projection:[2,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4]};var c=Fi.nameKey.add("PARTICLESHURIKEN");t="#ifdef HIGHPRECISION\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n\n#if defined(SPHERHBILLBOARD)||defined(STRETCHEDBILLBOARD)||defined(HORIZONTALBILLBOARD)||defined(VERTICALBILLBOARD)\n\tattribute vec4 a_CornerTextureCoordinate;\n#endif\n#ifdef RENDERMODE_MESH\n\tattribute vec3 a_MeshPosition;\n\tattribute vec4 a_MeshColor;\n\tattribute vec2 a_MeshTextureCoordinate;\n\tvarying vec4 v_MeshColor;\n#endif\n\nattribute vec4 a_ShapePositionStartLifeTime;\nattribute vec4 a_DirectionTime;\nattribute vec4 a_StartColor;\nattribute vec3 a_StartSize;\nattribute vec3 a_StartRotation0;\nattribute float a_StartSpeed;\n#if defined(COLOROVERLIFETIME)||defined(RANDOMCOLOROVERLIFETIME)||defined(SIZEOVERLIFETIMERANDOMCURVES)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n  attribute vec4 a_Random0;\n#endif\n#if defined(TEXTURESHEETANIMATIONRANDOMCURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  attribute vec4 a_Random1;\n#endif\nattribute vec3 a_SimulationWorldPostion;\nattribute vec4 a_SimulationWorldRotation;\n\nvarying float v_Discard;\nvarying vec4 v_Color;\n#ifdef DIFFUSEMAP\n\tvarying vec2 v_TextureCoordinate;\n#endif\n\nuniform float u_CurrentTime;\nuniform vec3 u_Gravity;\n\nuniform vec3 u_WorldPosition;\nuniform vec4 u_WorldRotation;\nuniform bool u_ThreeDStartRotation;\nuniform int u_ScalingMode;\nuniform vec3 u_PositionScale;\nuniform vec3 u_SizeScale;\nuniform mat4 u_View;\nuniform mat4 u_Projection;\n\n#ifdef STRETCHEDBILLBOARD\n\tuniform vec3 u_CameraPosition;\n#endif\nuniform vec3 u_CameraDirection;//TODO:只有几种广告牌模式需要用\nuniform vec3 u_CameraUp;\n\nuniform  float u_StretchedBillboardLengthScale;\nuniform  float u_StretchedBillboardSpeedScale;\nuniform int u_SimulationSpace;\n\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  uniform  int  u_VOLSpaceType;\n#endif\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)\n  uniform  vec3 u_VOLVelocityConst;\n#endif\n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  uniform  vec2 u_VOLVelocityGradientX[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientY[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientZ[4];//x为key,y为速度\n#endif\n#ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n  uniform  vec3 u_VOLVelocityConstMax;\n#endif\n#ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n  uniform  vec2 u_VOLVelocityGradientMaxX[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientMaxY[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientMaxZ[4];//x为key,y为速度\n#endif\n\n#ifdef COLOROVERLIFETIME\n  uniform  vec4 u_ColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_ColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n#endif\n#ifdef RANDOMCOLOROVERLIFETIME\n  uniform  vec4 u_ColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_ColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n  uniform  vec4 u_MaxColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_MaxColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n#endif\n\n\n#if defined(SIZEOVERLIFETIMECURVE)||defined(SIZEOVERLIFETIMERANDOMCURVES)\n  uniform  vec2 u_SOLSizeGradient[4];//x为key,y为尺寸\n#endif\n#ifdef SIZEOVERLIFETIMERANDOMCURVES\n  uniform  vec2 u_SOLSizeGradientMax[4];//x为key,y为尺寸\n#endif\n#if defined(SIZEOVERLIFETIMECURVESEPERATE)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)\n  uniform  vec2 u_SOLSizeGradientX[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientY[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientZ[4];//x为key,y为尺寸\n#endif\n#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n  uniform  vec2 u_SOLSizeGradientMaxX[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientMaxY[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientMaxZ[4];//x为key,y为尺寸\n#endif\n\n\n#ifdef ROTATIONOVERLIFETIME\n  #if defined(ROTATIONOVERLIFETIMECONSTANT)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)\n    uniform  float u_ROLAngularVelocityConst;\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n    uniform  float u_ROLAngularVelocityConstMax;\n  #endif\n  #if defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n    uniform  vec2 u_ROLAngularVelocityGradient[4];//x为key,y为旋转\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n    uniform  vec2 u_ROLAngularVelocityGradientMax[4];//x为key,y为旋转\n  #endif\n#endif\n#ifdef ROTATIONOVERLIFETIMESEPERATE\n  #if defined(ROTATIONOVERLIFETIMECONSTANT)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)\n    uniform  vec3 u_ROLAngularVelocityConstSeprarate;\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n    uniform  vec3 u_ROLAngularVelocityConstMaxSeprarate;\n  #endif\n  #if defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n    uniform  vec2 u_ROLAngularVelocityGradientX[4];\n    uniform  vec2 u_ROLAngularVelocityGradientY[4];\n    uniform  vec2 u_ROLAngularVelocityGradientZ[4];\n\tuniform  vec2 u_ROLAngularVelocityGradientW[4];\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n    uniform  vec2 u_ROLAngularVelocityGradientMaxX[4];\n    uniform  vec2 u_ROLAngularVelocityGradientMaxY[4];\n    uniform  vec2 u_ROLAngularVelocityGradientMaxZ[4];\n\tuniform  vec2 u_ROLAngularVelocityGradientMaxW[4];\n  #endif\n#endif\n\n#if defined(TEXTURESHEETANIMATIONCURVE)||defined(TEXTURESHEETANIMATIONRANDOMCURVE)\n  uniform  float u_TSACycles;\n  uniform  vec2 u_TSASubUVLength;\n  uniform  vec2 u_TSAGradientUVs[4];//x为key,y为frame\n#endif\n#ifdef TEXTURESHEETANIMATIONRANDOMCURVE\n  uniform  vec2 u_TSAMaxGradientUVs[4];//x为key,y为frame\n#endif\n\n#ifdef FOG\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#ifdef TILINGOFFSET\n\tuniform vec4 u_TilingOffset;\n#endif\n\nvec3 rotationByEuler(in vec3 vector,in vec3 rot)\n{\n\tfloat halfRoll = rot.z * 0.5;\n    float halfPitch = rot.x * 0.5;\n\tfloat halfYaw = rot.y * 0.5;\n\n\tfloat sinRoll = sin(halfRoll);\n\tfloat cosRoll = cos(halfRoll);\n\tfloat sinPitch = sin(halfPitch);\n\tfloat cosPitch = cos(halfPitch);\n\tfloat sinYaw = sin(halfYaw);\n\tfloat cosYaw = cos(halfYaw);\n\n\tfloat quaX = (cosYaw * sinPitch * cosRoll) + (sinYaw * cosPitch * sinRoll);\n\tfloat quaY = (sinYaw * cosPitch * cosRoll) - (cosYaw * sinPitch * sinRoll);\n\tfloat quaZ = (cosYaw * cosPitch * sinRoll) - (sinYaw * sinPitch * cosRoll);\n\tfloat quaW = (cosYaw * cosPitch * cosRoll) + (sinYaw * sinPitch * sinRoll);\n\t\n\t//vec4 q=vec4(quaX,quaY,quaZ,quaW);\n\t//vec3 temp = cross(q.xyz, vector) + q.w * vector;\n\t//return (cross(temp, -q.xyz) + dot(q.xyz,vector) * q.xyz + q.w * temp);\n\t\n\tfloat x = quaX + quaX;\n    float y = quaY + quaY;\n    float z = quaZ + quaZ;\n    float wx = quaW * x;\n    float wy = quaW * y;\n    float wz = quaW * z;\n\tfloat xx = quaX * x;\n    float xy = quaX * y;\n\tfloat xz = quaX * z;\n    float yy = quaY * y;\n    float yz = quaY * z;\n    float zz = quaZ * z;\n\n    return vec3(((vector.x * ((1.0 - yy) - zz)) + (vector.y * (xy - wz))) + (vector.z * (xz + wy)),\n                ((vector.x * (xy + wz)) + (vector.y * ((1.0 - xx) - zz))) + (vector.z * (yz - wx)),\n                ((vector.x * (xz - wy)) + (vector.y * (yz + wx))) + (vector.z * ((1.0 - xx) - yy)));\n\t\n}\n\n//假定axis已经归一化\nvec3 rotationByAxis(in vec3 vector,in vec3 axis, in float angle)\n{\n\tfloat halfAngle = angle * 0.5;\n\tfloat sin = sin(halfAngle);\n\t\n\tfloat quaX = axis.x * sin;\n\tfloat quaY = axis.y * sin;\n\tfloat quaZ = axis.z * sin;\n\tfloat quaW = cos(halfAngle);\n\t\n\t//vec4 q=vec4(quaX,quaY,quaZ,quaW);\n\t//vec3 temp = cross(q.xyz, vector) + q.w * vector;\n\t//return (cross(temp, -q.xyz) + dot(q.xyz,vector) * q.xyz + q.w * temp);\n\t\n\tfloat x = quaX + quaX;\n    float y = quaY + quaY;\n    float z = quaZ + quaZ;\n    float wx = quaW * x;\n    float wy = quaW * y;\n    float wz = quaW * z;\n\tfloat xx = quaX * x;\n    float xy = quaX * y;\n\tfloat xz = quaX * z;\n    float yy = quaY * y;\n    float yz = quaY * z;\n    float zz = quaZ * z;\n\n    return vec3(((vector.x * ((1.0 - yy) - zz)) + (vector.y * (xy - wz))) + (vector.z * (xz + wy)),\n                ((vector.x * (xy + wz)) + (vector.y * ((1.0 - xx) - zz))) + (vector.z * (yz - wx)),\n                ((vector.x * (xz - wy)) + (vector.y * (yz + wx))) + (vector.z * ((1.0 - xx) - yy)));\n\t\n}\n\nvec3 rotationByQuaternions(in vec3 v,in vec4 q) \n{\n\treturn v + 2.0 * cross(q.xyz, cross(q.xyz, v) + q.w * v);\n}\n\n \n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)||defined(SIZEOVERLIFETIMECURVE)||defined(SIZEOVERLIFETIMECURVESEPERATE)||defined(SIZEOVERLIFETIMERANDOMCURVES)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)\nfloat getCurValueFromGradientFloat(in vec2 gradientNumbers[4],in float normalizedAge)\n{\n\tfloat curValue;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientNumber=gradientNumbers[i];\n\t\tfloat key=gradientNumber.x;\n\t\tif(key>=normalizedAge)\n\t\t{\n\t\t\tvec2 lastGradientNumber=gradientNumbers[i-1];\n\t\t\tfloat lastKey=lastGradientNumber.x;\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\n\t\t\tcurValue=mix(lastGradientNumber.y,gradientNumber.y,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn curValue;\n}\n#endif\n\n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)||defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\nfloat getTotalValueFromGradientFloat(in vec2 gradientNumbers[4],in float normalizedAge)\n{\n\tfloat totalValue=0.0;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientNumber=gradientNumbers[i];\n\t\tfloat key=gradientNumber.x;\n\t\tvec2 lastGradientNumber=gradientNumbers[i-1];\n\t\tfloat lastValue=lastGradientNumber.y;\n\t\t\n\t\tif(key>=normalizedAge){\n\t\t\tfloat lastKey=lastGradientNumber.x;\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\n\t\t\ttotalValue+=(lastValue+mix(lastValue,gradientNumber.y,age))/2.0*a_ShapePositionStartLifeTime.w*(normalizedAge-lastKey);\n\t\t\tbreak;\n\t\t}\n\t\telse{\n\t\t\ttotalValue+=(lastValue+gradientNumber.y)/2.0*a_ShapePositionStartLifeTime.w*(key-lastGradientNumber.x);\n\t\t}\n\t}\n\treturn totalValue;\n}\n#endif\n\n#if defined(COLOROVERLIFETIME)||defined(RANDOMCOLOROVERLIFETIME)\nvec4 getColorFromGradient(in vec2 gradientAlphas[4],in vec4 gradientColors[4],in float normalizedAge)\n{\n\tvec4 overTimeColor;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientAlpha=gradientAlphas[i];\n\t\tfloat alphaKey=gradientAlpha.x;\n\t\tif(alphaKey>=normalizedAge)\n\t\t{\n\t\t\tvec2 lastGradientAlpha=gradientAlphas[i-1];\n\t\t\tfloat lastAlphaKey=lastGradientAlpha.x;\n\t\t\tfloat age=(normalizedAge-lastAlphaKey)/(alphaKey-lastAlphaKey);\n\t\t\toverTimeColor.a=mix(lastGradientAlpha.y,gradientAlpha.y,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\t\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec4 gradientColor=gradientColors[i];\n\t\tfloat colorKey=gradientColor.x;\n\t\tif(colorKey>=normalizedAge)\n\t\t{\n\t\t\tvec4 lastGradientColor=gradientColors[i-1];\n\t\t\tfloat lastColorKey=lastGradientColor.x;\n\t\t\tfloat age=(normalizedAge-lastColorKey)/(colorKey-lastColorKey);\n\t\t\toverTimeColor.rgb=mix(gradientColors[i-1].yzw,gradientColor.yzw,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn overTimeColor;\n}\n#endif\n\n\n#if defined(TEXTURESHEETANIMATIONCURVE)||defined(TEXTURESHEETANIMATIONRANDOMCURVE)\nfloat getFrameFromGradient(in vec2 gradientFrames[4],in float normalizedAge)\n{\n\tfloat overTimeFrame;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientFrame=gradientFrames[i];\n\t\tfloat key=gradientFrame.x;\n\t\tif(key>=normalizedAge)\n\t\t{\n\t\t\tvec2 lastGradientFrame=gradientFrames[i-1];\n\t\t\tfloat lastKey=lastGradientFrame.x;\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\n\t\t\toverTimeFrame=mix(lastGradientFrame.y,gradientFrame.y,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn floor(overTimeFrame);\n}\n#endif\n\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\nvec3 computeParticleLifeVelocity(in float normalizedAge)\n{\n  vec3 outLifeVelocity;\n  #ifdef VELOCITYOVERLIFETIMECONSTANT\n\t outLifeVelocity=u_VOLVelocityConst; \n  #endif\n  #ifdef VELOCITYOVERLIFETIMECURVE\n     outLifeVelocity= vec3(getCurValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge));\n  #endif\n  #ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n\t outLifeVelocity=mix(u_VOLVelocityConst,u_VOLVelocityConstMax,vec3(a_Random1.y,a_Random1.z,a_Random1.w)); \n  #endif\n  #ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n     outLifeVelocity=vec3(mix(getCurValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxX,normalizedAge),a_Random1.y),\n\t                 mix(getCurValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxY,normalizedAge),a_Random1.z),\n\t\t\t\t\t mix(getCurValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxZ,normalizedAge),a_Random1.w));\n  #endif\n\t\t\t\t\t\n  return outLifeVelocity;\n} \n#endif\n\nvec3 computeParticlePosition(in vec3 startVelocity, in vec3 lifeVelocity,in float age,in float normalizedAge,vec3 gravityVelocity,vec4 worldRotation)\n{\n   vec3 startPosition;\n   vec3 lifePosition;\n   #if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n\t#ifdef VELOCITYOVERLIFETIMECONSTANT\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=lifeVelocity*age;\n\t#endif\n\t#ifdef VELOCITYOVERLIFETIMECURVE\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=vec3(getTotalValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge));\n\t#endif\n\t#ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=lifeVelocity*age;\n\t#endif\n\t#ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=vec3(mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxX,normalizedAge),a_Random1.y)\n\t      ,mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxY,normalizedAge),a_Random1.z)\n\t      ,mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxZ,normalizedAge),a_Random1.w));\n\t#endif\n\t\n\tvec3 finalPosition;\n\tif(u_VOLSpaceType==0){\n\t  if(u_ScalingMode!=2)\n\t   finalPosition =rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition+lifePosition),worldRotation);\n\t  else\n\t   finalPosition =rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition+lifePosition,worldRotation);\n\t}\n\telse{\n\t  if(u_ScalingMode!=2)\n\t    finalPosition = rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition),worldRotation)+lifePosition;\n\t  else\n\t    finalPosition = rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation)+lifePosition;\n\t}\n  #else\n\t startPosition=startVelocity*age;\n\t vec3 finalPosition;\n\t if(u_ScalingMode!=2)\n\t   finalPosition = rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition),worldRotation);\n\t else\n\t   finalPosition = rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation);\n  #endif\n  \n  if(u_SimulationSpace==0)\n    finalPosition=finalPosition+a_SimulationWorldPostion;\n  else if(u_SimulationSpace==1) \n    finalPosition=finalPosition+u_WorldPosition;\n  \n  finalPosition+=0.5*gravityVelocity*age;\n \n  return  finalPosition;\n}\n\n\nvec4 computeParticleColor(in vec4 color,in float normalizedAge)\n{\n\t#ifdef COLOROVERLIFETIME\n\t  color*=getColorFromGradient(u_ColorOverLifeGradientAlphas,u_ColorOverLifeGradientColors,normalizedAge);\n\t#endif\n\t\n\t#ifdef RANDOMCOLOROVERLIFETIME\n\t  color*=mix(getColorFromGradient(u_ColorOverLifeGradientAlphas,u_ColorOverLifeGradientColors,normalizedAge),getColorFromGradient(u_MaxColorOverLifeGradientAlphas,u_MaxColorOverLifeGradientColors,normalizedAge),a_Random0.y);\n\t#endif\n\n    return color;\n}\n\nvec2 computeParticleSizeBillbard(in vec2 size,in float normalizedAge)\n{\n\t#ifdef SIZEOVERLIFETIMECURVE\n\t\tsize*=getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge);\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVES\n\t    size*=mix(getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMax,normalizedAge),a_Random0.z); \n\t#endif\n\t#ifdef SIZEOVERLIFETIMECURVESEPERATE\n\t\tsize*=vec2(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge));\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n\t    size*=vec2(mix(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxX,normalizedAge),a_Random0.z)\n\t    ,mix(getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxY,normalizedAge),a_Random0.z));\n\t#endif\n\treturn size;\n}\n\n#ifdef RENDERMODE_MESH\nvec3 computeParticleSizeMesh(in vec3 size,in float normalizedAge)\n{\n\t#ifdef SIZEOVERLIFETIMECURVE\n\t\tsize*=getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge);\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVES\n\t    size*=mix(getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMax,normalizedAge),a_Random0.z); \n\t#endif\n\t#ifdef SIZEOVERLIFETIMECURVESEPERATE\n\t\tsize*=vec3(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientZ,normalizedAge));\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n\t    size*=vec3(mix(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxX,normalizedAge),a_Random0.z)\n\t    ,mix(getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxY,normalizedAge),a_Random0.z)\n\t\t,mix(getCurValueFromGradientFloat(u_SOLSizeGradientZ,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxZ,normalizedAge),a_Random0.z));\n\t#endif\n\treturn size;\n}\n#endif\n\nfloat computeParticleRotationFloat(in float rotation,in float age,in float normalizedAge)\n{ \n\t#ifdef ROTATIONOVERLIFETIME\n\t\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tfloat ageRot=u_ROLAngularVelocityConst*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge);\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConst,u_ROLAngularVelocityConstMax,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMax,normalizedAge),a_Random0.w);\n\t\t#endif\n\t#endif\n\t#ifdef ROTATIONOVERLIFETIMESEPERATE\n\t\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tfloat ageRot=u_ROLAngularVelocityConstSeprarate.z*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge);\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConstSeprarate.z,u_ROLAngularVelocityConstMaxSeprarate.z,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxZ,normalizedAge),a_Random0.w));\n\t\t#endif\n\t#endif\n\treturn rotation;\n}\n\n\n#if defined(RENDERMODE_MESH)&&(defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE))\nvec3 computeParticleRotationVec3(in vec3 rotation,in float age,in float normalizedAge)\n{ \n\t#ifdef ROTATIONOVERLIFETIME\n\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tfloat ageRot=u_ROLAngularVelocityConst*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge);\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConst,u_ROLAngularVelocityConstMax,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMax,normalizedAge),a_Random0.w);\n\t\t#endif\n\t#endif\n\t#ifdef ROTATIONOVERLIFETIMESEPERATE\n\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tvec3 ageRot=u_ROLAngularVelocityConstSeprarate*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=vec3(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge));\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tvec3 ageRot=mix(u_ROLAngularVelocityConstSeprarate,u_ROLAngularVelocityConstMaxSeprarate,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=vec3(mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxX,normalizedAge),a_Random0.w)\n\t        ,mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxY,normalizedAge),a_Random0.w)\n\t        ,mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxZ,normalizedAge),a_Random0.w));\n\t\t#endif\n\t#endif\n\treturn rotation;\n}\n#endif\n\nvec2 computeParticleUV(in vec2 uv,in float normalizedAge)\n{ \n\t#ifdef TEXTURESHEETANIMATIONCURVE\n\t\tfloat cycleNormalizedAge=normalizedAge*u_TSACycles;\n\t\tfloat frame=getFrameFromGradient(u_TSAGradientUVs,cycleNormalizedAge-floor(cycleNormalizedAge));\n\t\tfloat totalULength=frame*u_TSASubUVLength.x;\n\t\tfloat floorTotalULength=floor(totalULength);\n\t    uv.x+=totalULength-floorTotalULength;\n\t\tuv.y+=floorTotalULength*u_TSASubUVLength.y;\n    #endif\n\t#ifdef TEXTURESHEETANIMATIONRANDOMCURVE\n\t\tfloat cycleNormalizedAge=normalizedAge*u_TSACycles;\n\t\tfloat uvNormalizedAge=cycleNormalizedAge-floor(cycleNormalizedAge);\n\t    float frame=floor(mix(getFrameFromGradient(u_TSAGradientUVs,uvNormalizedAge),getFrameFromGradient(u_TSAMaxGradientUVs,uvNormalizedAge),a_Random1.x));\n\t\tfloat totalULength=frame*u_TSASubUVLength.x;\n\t\tfloat floorTotalULength=floor(totalULength);\n\t    uv.x+=totalULength-floorTotalULength;\n\t\tuv.y+=floorTotalULength*u_TSASubUVLength.y;\n    #endif\n\treturn uv;\n}\n\nvoid main()\n{\n\tfloat age = u_CurrentTime - a_DirectionTime.w;\n\tfloat normalizedAge = age/a_ShapePositionStartLifeTime.w;\n\tvec3 lifeVelocity;\n\tif(normalizedAge<1.0){ \n\tvec3 startVelocity=a_DirectionTime.xyz*a_StartSpeed;\n\t#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n\t\tlifeVelocity= computeParticleLifeVelocity(normalizedAge);//计算粒子生命周期速度\n\t#endif \n\tvec3 gravityVelocity=u_Gravity*age;\n\t\n\tvec4 worldRotation;\n\tif(u_SimulationSpace==0)\n\t\tworldRotation=a_SimulationWorldRotation;\n\telse\n\t\tworldRotation=u_WorldRotation;\n\t\n\tvec3 center=computeParticlePosition(startVelocity, lifeVelocity, age, normalizedAge,gravityVelocity,worldRotation);//计算粒子位置\n   \n   \n   #ifdef SPHERHBILLBOARD\n\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n        vec3 cameraUpVector =normalize(u_CameraUp);//TODO:是否外面归一化\n        vec3 sideVector = normalize(cross(u_CameraDirection,cameraUpVector));\n        vec3 upVector = normalize(cross(sideVector,u_CameraDirection));\n\t    corner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n\t\t#if defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE)\n\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\tvec3 rotation=vec3(a_StartRotation0.xy,computeParticleRotationFloat(a_StartRotation0.z,age,normalizedAge));\n\t\t\t\tcenter += u_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,rotation);\n\t\t\t}\n\t\t\telse{\n\t\t\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n\t\t\t\tfloat c = cos(rot);\n\t\t\t\tfloat s = sin(rot);\n\t\t\t\tmat2 rotation= mat2(c, -s, s, c);\n\t\t\t\tcorner=rotation*corner;\n\t\t\t\tcenter += u_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);\n\t\t\t}\n\t\t#else\n\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\tcenter += u_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,a_StartRotation0);\n\t\t\t}\n\t\t\telse{\n\t\t\t\tfloat c = cos(a_StartRotation0.x);\n\t\t\t\tfloat s = sin(a_StartRotation0.x);\n\t\t\t\tmat2 rotation= mat2(c, -s, s, c);\n\t\t\t\tcorner=rotation*corner;\n\t\t\t\tcenter += u_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);\n\t\t\t}\n\t\t#endif\n   #endif\n   \n   #ifdef STRETCHEDBILLBOARD\n\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n\tvec3 velocity;\n\t#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n\t    if(u_VOLSpaceType==0)\n\t\t  velocity=rotationByQuaternions(u_SizeScale*(startVelocity+lifeVelocity),worldRotation)+gravityVelocity;\n\t    else\n\t\t  velocity=rotationByQuaternions(u_SizeScale*startVelocity,worldRotation)+lifeVelocity+gravityVelocity;\n    #else\n\t    velocity= rotationByQuaternions(u_SizeScale*startVelocity,worldRotation)+gravityVelocity;\n    #endif\t\n\t\tvec3 cameraUpVector = normalize(velocity);\n\t\tvec3 direction = normalize(center-u_CameraPosition);\n        vec3 sideVector = normalize(cross(direction,normalize(velocity)));\n\t\t\n\t\tsideVector=u_SizeScale.xzy*sideVector;\n\t\tcameraUpVector=length(vec3(u_SizeScale.x,0.0,0.0))*cameraUpVector;\n\t\t\n\t    vec2 size=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n\t\t\n\t    const mat2 rotaionZHalfPI=mat2(0.0, -1.0, 1.0, 0.0);\n\t    corner=rotaionZHalfPI*corner;\n\t    corner.y=corner.y-abs(corner.y);\n\t\t\n\t    float speed=length(velocity);//TODO:\n\t    center +=sign(u_SizeScale.x)*(sign(u_StretchedBillboardLengthScale)*size.x*corner.x*sideVector+(speed*u_StretchedBillboardSpeedScale+size.y*u_StretchedBillboardLengthScale)*corner.y*cameraUpVector);\n   #endif\n   \n   #ifdef HORIZONTALBILLBOARD\n\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n        const vec3 cameraUpVector=vec3(0.0,0.0,1.0);\n\t    const vec3 sideVector = vec3(-1.0,0.0,0.0);\n\t\t\n\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n        float c = cos(rot);\n        float s = sin(rot);\n        mat2 rotation= mat2(c, -s, s, c);\n\t    corner=rotation*corner*cos(0.78539816339744830961566084581988);//TODO:临时缩小cos45,不确定U3D原因\n\t\tcorner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n        center +=u_SizeScale.xzy*(corner.x*sideVector+ corner.y*cameraUpVector);\n   #endif\n   \n   #ifdef VERTICALBILLBOARD\n\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n        const vec3 cameraUpVector =vec3(0.0,1.0,0.0);\n        vec3 sideVector = normalize(cross(u_CameraDirection,cameraUpVector));\n\t\t\n\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n        float c = cos(rot);\n        float s = sin(rot);\n        mat2 rotation= mat2(c, -s, s, c);\n\t    corner=rotation*corner*cos(0.78539816339744830961566084581988);//TODO:临时缩小cos45,不确定U3D原因\n\t\tcorner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n        center +=u_SizeScale.xzy*(corner.x*sideVector+ corner.y*cameraUpVector);\n   #endif\n   \n   #ifdef RENDERMODE_MESH\n\t    vec3 size=computeParticleSizeMesh(a_StartSize,normalizedAge);\n\t\t#if defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE)\n\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\tvec3 rotation=vec3(a_StartRotation0.xy,-computeParticleRotationFloat(a_StartRotation0.z, age,normalizedAge));\n\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByEuler(a_MeshPosition*size,rotation),worldRotation);\n\t\t\t}\n\t\t\telse{\n\t\t\t\t#ifdef ROTATIONOVERLIFETIME\n\t\t\t\t\tfloat angle=computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n\t\t\t\t\tif(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0){\n\t\t\t\t\t\tcenter+= (rotationByQuaternions(rotationByAxis(u_SizeScale*a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),angle),worldRotation));//已验证\n\t\t\t\t\t}\n\t\t\t\t\telse{\n\t\t\t\t\t\t#ifdef SHAPE\n\t\t\t\t\t\t\tcenter+= u_SizeScale.xzy*(rotationByQuaternions(rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),angle),worldRotation));\n\t\t\t\t\t\t#else\n\t\t\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\t\t\tcenter+=rotationByAxis(u_SizeScale*a_MeshPosition*size,vec3(0.0,0.0,-1.0),angle);//已验证\n\t\t\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\t\t\tcenter+=rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),angle),worldRotation);//已验证\n\t\t\t\t\t\t#endif\n\t\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t\t#ifdef ROTATIONOVERLIFETIMESEPERATE\n\t\t\t\t\t//TODO:是否应合并if(u_ThreeDStartRotation)分支代码,待测试\n\t\t\t\t\tvec3 angle=computeParticleRotationVec3(vec3(0.0,0.0,a_StartRotation0.z), age,normalizedAge);\n\t\t\t\t\tcenter+= (rotationByQuaternions(rotationByEuler(u_SizeScale*a_MeshPosition*size,vec3(angle.x,angle.y,angle.z)),worldRotation));//已验证\n\t\t\t\t#endif\t\n\t\t\t}\n\t\t#else\n\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByEuler(a_MeshPosition*size,a_StartRotation0),worldRotation);//已验证\n\t\t\t}\n\t\t\telse{\n\t\t\t\tif(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0){\n\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\tcenter+= rotationByAxis(u_SizeScale*a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x);\n\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\tcenter+= (rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x),worldRotation));//已验证\n\t\t\t\t}\n\t\t\t\telse{\n\t\t\t\t\t#ifdef SHAPE\n\t\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\t\tcenter+= u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x);\n\t\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x),worldRotation);\t\n\t\t\t\t\t#else\n\t\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\t\tcenter+= rotationByAxis(u_SizeScale*a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x);\n\t\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x),worldRotation);//已验证\n\t\t\t\t\t#endif\n\t\t\t\t}\n\t\t\t}\n\t\t#endif\n\t\tv_MeshColor=a_MeshColor;\n   #endif\n   \n    gl_Position=u_Projection*u_View*vec4(center,1.0);\n    v_Color = computeParticleColor(a_StartColor, normalizedAge);\n\t#ifdef DIFFUSEMAP\n\t\t#if defined(SPHERHBILLBOARD)||defined(STRETCHEDBILLBOARD)||defined(HORIZONTALBILLBOARD)||defined(VERTICALBILLBOARD)\n\t\t\tv_TextureCoordinate =computeParticleUV(a_CornerTextureCoordinate.zw, normalizedAge);\n\t\t#endif\n\t\t#ifdef RENDERMODE_MESH\n\t\t\tv_TextureCoordinate =computeParticleUV(a_MeshTextureCoordinate, normalizedAge);\n\t\t#endif\n\t\t\n\t\t#ifdef TILINGOFFSET\n\t\t\tv_TextureCoordinate=vec2(v_TextureCoordinate.x,1.0-v_TextureCoordinate.y)*u_TilingOffset.xy+vec2(u_TilingOffset.z,-u_TilingOffset.w);//需要特殊处理\n\t\t\tv_TextureCoordinate=vec2(v_TextureCoordinate.x,1.0-v_TextureCoordinate.y);//需要特殊处理\n\t\t#endif\n\t#endif\n    v_Discard=0.0;\n\t  \n\t#ifdef FOG\n\t\tv_PositionWorld=center;\n\t#endif\n   }\n   else\n\t{\n\t\tv_Discard=1.0;\n\t}\n}\n\n",e="#ifdef HIGHPRECISION\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n\nvarying float v_Discard;\nvarying vec4 v_Color;\nvarying vec2 v_TextureCoordinate;\nuniform sampler2D u_texture;\nuniform vec4 u_Tintcolor;\n\n#ifdef RENDERMODE_MESH\n\tvarying vec4 v_MeshColor;\n#endif\n\n#ifdef FOG\n\tvarying vec3 v_PositionWorld;\n\tuniform vec3 u_CameraPosition;\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\t#ifdef ADDTIVEFOG\n\t#else\n\t\tuniform vec3 u_FogColor;\n\t#endif\n#endif\n\n\nvoid main()\n{\t\n\t#ifdef RENDERMODE_MESH\n\t\tgl_FragColor=v_MeshColor;\n\t#else\n\t\tgl_FragColor=vec4(1.0);\t\n\t#endif\n\t\t\n\t#ifdef DIFFUSEMAP\n\t\tif(v_Discard!=0.0)\n\t\t\tdiscard;\n\t\t#ifdef TINTCOLOR\n\t\t\tgl_FragColor*=texture2D(u_texture,v_TextureCoordinate)*u_Tintcolor*2.0*v_Color;\n\t\t#else\n\t\t\tgl_FragColor*=texture2D(u_texture,v_TextureCoordinate)*v_Color;\n\t\t#endif\n\t#else\n\t\t#ifdef TINTCOLOR\n\t\t\tgl_FragColor*=u_Tintcolor*2.0*v_Color;\n\t\t#else\n\t\t\tgl_FragColor*=v_Color;\n\t\t#endif\n\t#endif\n\t\n\t#ifdef FOG\n\t\tvec3 toEye=u_CameraPosition-v_PositionWorld;\n\t\tfloat toEyeLength=length(toEye);\n\t\ttoEye/=toEyeLength;\n\t\t\n\t\tfloat lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n\t\t#ifdef ADDTIVEFOG\n\t\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,vec3(0.0,0.0,0.0),lerpFact);\n\t\t#else\n\t\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n\t\t#endif\n\t#endif\n}",a=ui.add(c,t,e,i,n),ji.SHADERDEFINE_DIFFUSEMAP=a.registerMaterialDefine("DIFFUSEMAP"),ji.SHADERDEFINE_TINTCOLOR=a.registerMaterialDefine("TINTCOLOR"),ji.SHADERDEFINE_ADDTIVEFOG=a.registerMaterialDefine("ADDTIVEFOG"),ji.SHADERDEFINE_TILINGOFFSET=a.registerMaterialDefine("TILINGOFFSET"),gn.SHADERDEFINE_RENDERMODE_BILLBOARD=a.registerSpriteDefine("SPHERHBILLBOARD"),gn.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD=a.registerSpriteDefine("STRETCHEDBILLBOARD"),gn.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD=a.registerSpriteDefine("HORIZONTALBILLBOARD"),gn.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD=a.registerSpriteDefine("VERTICALBILLBOARD"),gn.SHADERDEFINE_COLOROVERLIFETIME=a.registerSpriteDefine("COLOROVERLIFETIME"),gn.SHADERDEFINE_RANDOMCOLOROVERLIFETIME=a.registerSpriteDefine("RANDOMCOLOROVERLIFETIME"),gn.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT=a.registerSpriteDefine("VELOCITYOVERLIFETIMECONSTANT"),gn.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE=a.registerSpriteDefine("VELOCITYOVERLIFETIMECURVE"),gn.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT=a.registerSpriteDefine("VELOCITYOVERLIFETIMERANDOMCONSTANT"),gn.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE=a.registerSpriteDefine("VELOCITYOVERLIFETIMERANDOMCURVE"),gn.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE=a.registerSpriteDefine("TEXTURESHEETANIMATIONCURVE"),gn.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE=a.registerSpriteDefine("TEXTURESHEETANIMATIONRANDOMCURVE"),gn.SHADERDEFINE_ROTATIONOVERLIFETIME=a.registerSpriteDefine("ROTATIONOVERLIFETIME"),gn.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE=a.registerSpriteDefine("ROTATIONOVERLIFETIMESEPERATE"),gn.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT=a.registerSpriteDefine("ROTATIONOVERLIFETIMECONSTANT"),gn.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE=a.registerSpriteDefine("ROTATIONOVERLIFETIMECURVE"),gn.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS=a.registerSpriteDefine("ROTATIONOVERLIFETIMERANDOMCONSTANTS"),gn.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES=a.registerSpriteDefine("ROTATIONOVERLIFETIMERANDOMCURVES"),gn.SHADERDEFINE_SIZEOVERLIFETIMECURVE=a.registerSpriteDefine("SIZEOVERLIFETIMECURVE"),gn.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE=a.registerSpriteDefine("SIZEOVERLIFETIMECURVESEPERATE"),gn.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES=a.registerSpriteDefine("SIZEOVERLIFETIMERANDOMCURVES"),gn.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE=a.registerSpriteDefine("SIZEOVERLIFETIMERANDOMCURVESSEPERATE"),gn.SHADERDEFINE_RENDERMODE_MESH=a.registerSpriteDefine("RENDERMODE_MESH"),gn.SHADERDEFINE_SHAPE=a.registerSpriteDefine("SHAPE"),i={a_Position:0,a_Texcoord0:2,a_Time:33},n={u_Texture:[1,1],u_Albedo:[2,1],u_Color:[3,1],u_CurrentTime:[2,2],u_Duration:[3,2],u_MvpMatrix:[1,2]};var d=Fi.nameKey.add("GLITTER");t="attribute vec4 a_Position;\nattribute vec2 a_Texcoord0;\nattribute float a_Time;\n\nuniform mat4 u_MvpMatrix;\nuniform  float u_CurrentTime;\nuniform  vec4 u_Color;\nuniform float u_Duration;\n\nvarying vec2 v_Texcoord;\nvarying vec4 v_Color;\n\n\nvoid main()\n{\n  gl_Position = u_MvpMatrix * a_Position;\n  \n  float age = u_CurrentTime-a_Time;\n  float normalizedAge = clamp(age / u_Duration,0.0,1.0);\n   \n  v_Texcoord=a_Texcoord0;\n  \n  v_Color=u_Color;\n  v_Color.a*=1.0-normalizedAge;\n}\n",e="#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nuniform vec4 u_Albedo;\nuniform sampler2D u_Texture;\n\nvarying vec2 v_Texcoord;\nvarying vec4 v_Color;\n\n\nvoid main()\n{\t\n  gl_FragColor=texture2D(u_Texture, v_Texcoord)*v_Color;\n  gl_FragColor=gl_FragColor*u_Albedo;\n}\n\n",a=ui.add(d,t,e,i,n),i={a_Position:0},n={u_Intensity:[1,1],u_AlphaBlending:[2,1],u_CubeTexture:[3,1],u_MvpMatrix:[4,3]};var f=Fi.nameKey.add("SkyBox");t="attribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\nvarying vec3 v_Texcoord;\n\n\nvoid main()\n{\n  gl_Position = (u_MvpMatrix*a_Position).xyww;\n  v_Texcoord=a_Position.xyz;\n}\n",e="#ifdef HIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform float u_Intensity;\nuniform float u_AlphaBlending;\nuniform samplerCube u_CubeTexture;\n\nvarying vec3 v_Texcoord;\n\n\nvoid main()\n{\t\n  gl_FragColor=vec4(textureCube(u_CubeTexture, v_Texcoord).rgb*u_Intensity,u_AlphaBlending);\n}\n\n",ui.add(f,t,e,i,n),i={a_Position:0,a_Texcoord0:2},n={u_Intensity:[1,1],u_AlphaBlending:[2,1],u_texture:[3,1],u_MvpMatrix:[4,3]};var m=Fi.nameKey.add("SkyDome");t="attribute vec4 a_Position;\nattribute vec2 a_Texcoord0;\nuniform mat4 u_MvpMatrix;\nvarying vec2 v_Texcoord;\n\n\nvoid main()\n{\n  gl_Position = (u_MvpMatrix*a_Position).xyww;\n  v_Texcoord = a_Texcoord0;\n}\n",e="#ifdef HIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nuniform float u_Intensity;\nuniform float u_AlphaBlending;\nuniform sampler2D u_texture;\n\nvarying vec2 v_Texcoord;\n\n\nvoid main()\n{\t\n  gl_FragColor=vec4(texture2D(u_texture, v_Texcoord).rgb*u_Intensity,u_AlphaBlending);\n}\n\n",ui.add(m,t,e,i,n),i={a_Position:0,a_Normal:3,a_Texcoord0:2,a_Texcoord1:15},n={u_MvpMatrix:[1,2],u_WorldMat:[0,2],u_LightmapScaleOffset:[2,2],u_LightMap:[3,2],u_SplatAlphaTexture:[0,1],u_NormalTexture:[1,1],u_DiffuseTexture1:[2,1],u_DiffuseTexture2:[3,1],u_DiffuseTexture3:[4,1],u_DiffuseTexture4:[5,1],u_DiffuseScale1:[6,1],u_DiffuseScale2:[7,1],u_DiffuseScale3:[8,1],u_DiffuseScale4:[9,1],u_MaterialDiffuse:[11,1],u_MaterialAmbient:[10,1],u_MaterialSpecular:[12,1],u_CameraPos:[0,3],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Attenuation":[7,4],"u_PointLight.Diffuse":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Attenuation":[13,4],"u_SpotLight.Diffuse":[14,4],u_AmbientColor:[21,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]};var p=Fi.nameKey.add("Terrain");t="attribute vec4 a_Position;\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(LIGHTMAP)\n\tattribute vec3 a_Normal;\n\tvarying vec3 v_Normal;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||(defined(RECEIVESHADOW)&&defined(SHADOWMAP_PSSM1))\n\tuniform mat4 u_WorldMat;\n\tvarying vec3 v_PositionWorld;\n#endif\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n  #ifdef SHADOWMAP_PSSM1 \n  varying vec4 v_lightMVPPos;\n  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\n#ifdef LIGHTMAP\n\tuniform vec4 u_LightmapScaleOffset;\n\tvarying vec2 v_LightMapUV;\n#endif\n\nattribute vec2 a_Texcoord0;\nattribute vec2 a_Texcoord1;\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\nuniform mat4 u_MvpMatrix;\n\nvoid main()\n{\n\tgl_Position = u_MvpMatrix * a_Position;\n\tv_Texcoord0=a_Texcoord0;\n\tv_Texcoord1=a_Texcoord1;\n\t\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\tv_Normal=a_Normal;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||(defined(RECEIVESHADOW)&&defined(SHADOWMAP_PSSM1))\n\tv_PositionWorld=(u_WorldMat*a_Position).xyz;\n#endif\n\n#ifdef LIGHTMAP\n\t//这个地方使用a_Normal 并不是真的代表normal，其实凑巧法线图的uv正好是符合 light_Map的UV\n\tv_LightMapUV=vec2(a_Normal.x*u_LightmapScaleOffset.x+u_LightmapScaleOffset.z,(a_Normal.y-1.0)*u_LightmapScaleOffset.y+u_LightmapScaleOffset.w);\n#endif\n\n#ifdef RECEIVESHADOW\n\tv_posViewZ = gl_Position.w;\n\t#ifdef SHADOWMAP_PSSM1\n\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n\t#endif\n#endif\n\n}",e='#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "LightHelper.glsl";\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\tuniform vec3 u_MaterialDiffuse;\n\tuniform vec4 u_MaterialSpecular;\n\tuniform vec3 u_CameraPos;\n\tvarying vec3 v_Normal;\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(LIGHTMAP)\n\tuniform vec3 u_MaterialAmbient;\n#endif\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\tuniform vec3 u_FogColor;\n#endif\n\n\n#ifdef DIRECTIONLIGHT\n\tuniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\n\tuniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\n\tuniform SpotLight u_SpotLight;\n#endif\n\nuniform vec3 u_AmbientColor;\n\n#include "ShadowHelper.glsl"\n#ifdef RECEIVESHADOW\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\nvarying float v_posViewZ;\n\n\nuniform sampler2D u_SplatAlphaTexture;\nuniform sampler2D u_NormalTexture;\nuniform sampler2D u_DiffuseTexture1;\nuniform sampler2D u_DiffuseTexture2;\nuniform sampler2D u_DiffuseTexture3;\nuniform sampler2D u_DiffuseTexture4;\nuniform vec2 u_DiffuseScale1;\nuniform vec2 u_DiffuseScale2;\nuniform vec2 u_DiffuseScale3;\nuniform vec2 u_DiffuseScale4;\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\n\n#ifdef LIGHTMAP\n\tuniform sampler2D u_LightMap;\n\tvarying vec2 v_LightMapUV;\n#endif\n\nvoid main()\n{\n#ifdef DETAIL_NUM1\n\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord1/u_DiffuseScale1);\n\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\tgl_FragColor.xyz = color1.xyz;\n#endif\n#ifdef DETAIL_NUM2\n\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord1/u_DiffuseScale1);\n\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord1/u_DiffuseScale2);\n\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\tgl_FragColor.xyz = color1.xyz * (1.0-splatAlpha.r) + color2.xyz * splatAlpha.r;\n#endif\n#ifdef DETAIL_NUM3\n\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord1/u_DiffuseScale1);\n\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord1/u_DiffuseScale2);\n\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord1/u_DiffuseScale3);\n\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\tgl_FragColor.xyz = color1.xyz * (1.0-(splatAlpha.r+splatAlpha.g)) + color2.xyz * splatAlpha.r + color3.xyz * splatAlpha.g;\n#endif\n#ifdef DETAIL_NUM4\n\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord1/u_DiffuseScale1);\n\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord1/u_DiffuseScale2);\n\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord1/u_DiffuseScale3);\n\tvec4 color4 = texture2D(u_DiffuseTexture4, v_Texcoord1/u_DiffuseScale4);\n\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\tgl_FragColor.xyz = color1.xyz * (1.0-(splatAlpha.r+splatAlpha.g+splatAlpha.b))+ color2.xyz * splatAlpha.r + color3.xyz * splatAlpha.g + color4.xyz * splatAlpha.b;\n#endif\n\tgl_FragColor.w = splatAlpha.a;\n\t\t\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n    vec3 normal = texture2D(u_NormalTexture,v_Normal.xy).xyz;\n\tnormal = normal*2.0 - vec3(1.0);\n\tvec3 diffuse = vec3(0.0);\n\tvec3 ambient = vec3(0.0);\n\tvec3 specular= vec3(0.0);\n\tvec3 dif, amb, spe;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\n\tvec3 toEye;\n\t#ifdef FOG\n\t\ttoEye=u_CameraPos-v_PositionWorld;\n\t\tfloat toEyeLength=length(toEye);\n\t\ttoEye/=toEyeLength;\n\t#else\n\t\ttoEye=normalize(u_CameraPos-v_PositionWorld);\n\t#endif\n#endif\n\n#ifdef DIRECTIONLIGHT\n\tcomputeDirectionLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_DirectionLight,u_AmbientColor,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n \n#ifdef POINTLIGHT\n\tcomputePointLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_PointLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n\n#ifdef SPOTLIGHT\n\tComputeSpotLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_SpotLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n\n#ifdef RECEIVESHADOW\n\tfloat shadowValue = 1.0;\n\t#ifdef SHADOWMAP_PSSM3\n\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t#endif\n\t#ifdef SHADOWMAP_PSSM2\n\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t#endif \n\t#ifdef SHADOWMAP_PSSM1\n\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n\t#endif\n#endif\n\n#ifdef LIGHTMAP\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb);\n\t#else\n\t\t#if defined(RECEIVESHADOW)\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb * shadowValue);\n\t\t#else\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb);\n\t\t#endif\n\t#endif\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t#ifdef RECEIVESHADOW\n\t\tgl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse*shadowValue) + specular * shadowValue,gl_FragColor.a);\n\t#else\n\t\tgl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse) + specular, gl_FragColor.a);\n\t#endif\n#endif\n\n#ifdef FOG\n\tfloat lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n#endif\n}\n\n';var v=ui.add(p,t,e,i,n);Xi.SHADERDEFINE_DETAIL_NUM1=v.registerMaterialDefine("DETAIL_NUM1"),Xi.SHADERDEFINE_DETAIL_NUM2=v.registerMaterialDefine("DETAIL_NUM2"),Xi.SHADERDEFINE_DETAIL_NUM4=v.registerMaterialDefine("DETAIL_NUM4"),Xi.SHADERDEFINE_DETAIL_NUM3=v.registerMaterialDefine("DETAIL_NUM3"),i={a_Position:0,a_Normal:3,a_Texcoord0:2},n={u_MvpMatrix:[1,2],u_WorldMat:[0,2],u_CameraPos:[0,3],u_LightmapScaleOffset:[2,2],u_LightMap:[3,2],u_SplatAlphaTexture:[0,1],u_DiffuseTexture1:[1,1],u_DiffuseTexture2:[2,1],u_DiffuseTexture3:[3,1],u_DiffuseTexture4:[4,1],u_DiffuseTexture5:[5,1],u_DiffuseScaleOffset1:[6,1],u_DiffuseScaleOffset2:[7,1],u_DiffuseScaleOffset3:[8,1],u_DiffuseScaleOffset4:[9,1],u_DiffuseScaleOffset5:[10,1],u_MaterialAlbedo:[14,1],u_MaterialDiffuse:[12,1],u_MaterialAmbient:[11,1],u_MaterialSpecular:[13,1],u_FogStart:[1,4],u_FogRange:[2,4],u_FogColor:[0,4],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Diffuse":[4,4],"u_PointLight.Position":[5,4],"u_PointLight.Range":[6,4],"u_PointLight.Attenuation":[7,4],"u_PointLight.Diffuse":[8,4],"u_SpotLight.Position":[9,4],"u_SpotLight.Direction":[10,4],"u_SpotLight.Range":[12,4],"u_SpotLight.Spot":[11,4],"u_SpotLight.Attenuation":[13,4],"u_SpotLight.Diffuse":[14,4],u_AmbientColor:[21,4],u_shadowMap1:[18,4],u_shadowMap2:[19,4],u_shadowMap3:[20,4],u_shadowPSSMDistance:[15,4],u_lightShadowVP:[16,4],u_shadowPCFoffset:[17,4]};var g=Fi.nameKey.add("ExtendTerrain");t="attribute vec4 a_Position;\nattribute vec2 a_Texcoord0;\n\nuniform mat4 u_MvpMatrix;\n\nvarying vec2 v_Texcoord0;\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(LIGHTMAP)\n\tattribute vec3 a_Normal;\n\tvarying vec3 v_Normal;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||(defined(RECEIVESHADOW)&&defined(SHADOWMAP_PSSM1))\n\tuniform mat4 u_WorldMat;\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#ifdef LIGHTMAP\n\tvarying vec2 v_LightMapUV;\n\tuniform vec4 u_LightmapScaleOffset;\n#endif\n\n#ifdef RECEIVESHADOW\n\tvarying float v_posViewZ;\n\t#ifdef SHADOWMAP_PSSM1 \n\t\tvarying vec4 v_lightMVPPos;\n\t\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n#endif\n\nvoid main()\n{\n\tgl_Position = u_MvpMatrix * a_Position;\n  \n\tv_Texcoord0 = a_Texcoord0;\n  \n\t#ifdef LIGHTMAP\n\t\tv_LightMapUV = vec2(a_Texcoord0.x*u_LightmapScaleOffset.x+u_LightmapScaleOffset.z,(a_Texcoord0.y-1.0)*u_LightmapScaleOffset.y+u_LightmapScaleOffset.w);\n\t#endif\n  \n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tv_Normal = a_Normal;\n\t#endif\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||(defined(RECEIVESHADOW)&&defined(SHADOWMAP_PSSM1))\n\t\tv_PositionWorld=(u_WorldMat*a_Position).xyz;\n\t#endif\n\n\t#ifdef RECEIVESHADOW\n\t\tv_posViewZ = gl_Position.w;\n\t\t#ifdef SHADOWMAP_PSSM1\n\t\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n\t\t#endif\n\t#endif\n}",e='#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "LightHelper.glsl";\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\n\tuniform vec3 u_MaterialDiffuse;\n\tuniform vec4 u_MaterialSpecular;\n\tuniform vec3 u_CameraPos;\n\tvarying vec3 v_Normal;\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\tuniform vec3 u_FogColor;\n#endif\n\n\n#ifdef DIRECTIONLIGHT\n\tuniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\n\tuniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\n\tuniform SpotLight u_SpotLight;\n#endif\n\nuniform vec3 u_AmbientColor;\n\n#include "ShadowHelper.glsl"\n#ifdef RECEIVESHADOW\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\nvarying float v_posViewZ;\n\n\nuniform sampler2D u_SplatAlphaTexture;\n\nuniform sampler2D u_DiffuseTexture1;\nuniform sampler2D u_DiffuseTexture2;\nuniform sampler2D u_DiffuseTexture3;\nuniform sampler2D u_DiffuseTexture4;\nuniform sampler2D u_DiffuseTexture5;\n\nuniform vec4 u_DiffuseScaleOffset1;\nuniform vec4 u_DiffuseScaleOffset2;\nuniform vec4 u_DiffuseScaleOffset3;\nuniform vec4 u_DiffuseScaleOffset4;\nuniform vec4 u_DiffuseScaleOffset5;\n\nvarying vec2 v_Texcoord0;\n\nuniform vec3 u_MaterialAmbient;\nuniform vec4 u_MaterialAlbedo;\n\n#ifdef LIGHTMAP\n\tuniform sampler2D u_LightMap;\n\tvarying vec2 v_LightMapUV;\n#endif\n\nvoid main()\n{\n\t#ifdef ExtendTerrain_DETAIL_NUM1\n\t\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r;\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM2\n\t\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r + color2.xyz * (1.0 - splatAlpha.r);\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM3\n\t\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * (1.0 - splatAlpha.r - splatAlpha.g);\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM4\n\t\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\n\t\tvec4 color4 = texture2D(u_DiffuseTexture4, v_Texcoord0 * u_DiffuseScaleOffset4.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * splatAlpha.b + color4.xyz * (1.0 - splatAlpha.r - splatAlpha.g - splatAlpha.b);\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM5\n\t\tvec4 splatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\n\t\tvec4 color4 = texture2D(u_DiffuseTexture4, v_Texcoord0 * u_DiffuseScaleOffset4.xy);\n\t\tvec4 color5 = texture2D(u_DiffuseTexture5, v_Texcoord0 * u_DiffuseScaleOffset5.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * splatAlpha.b + color4.xyz * splatAlpha.a + color5.xyz * (1.0 - splatAlpha.r - splatAlpha.g - splatAlpha.b - splatAlpha.a);\n\t#endif\n\t\tgl_FragColor.w = splatAlpha.a;\n\t\t\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n    vec3 normal = v_Normal;\n\tvec3 diffuse = vec3(0.0);\n\tvec3 ambient = vec3(0.0);\n\tvec3 specular= vec3(0.0);\n\tvec3 dif, amb, spe;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\n\tvec3 toEye;\n\t#ifdef FOG\n\t\ttoEye=u_CameraPos-v_PositionWorld;\n\t\tfloat toEyeLength=length(toEye);\n\t\ttoEye/=toEyeLength;\n\t#else\n\t\ttoEye=normalize(u_CameraPos-v_PositionWorld);\n\t#endif\n#endif\n\n#ifdef DIRECTIONLIGHT\n\tcomputeDirectionLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_DirectionLight,u_AmbientColor,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n \n#ifdef POINTLIGHT\n\tcomputePointLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_PointLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n\n#ifdef SPOTLIGHT\n\tComputeSpotLight(u_MaterialDiffuse,u_MaterialAmbient,u_MaterialSpecular,u_SpotLight,u_AmbientColor,v_PositionWorld,normal,toEye, dif, amb, spe);\n\tdiffuse+=dif;\n\tambient+=amb;\n\tspecular+=spe;\n#endif\n\n#ifdef RECEIVESHADOW\n\tfloat shadowValue = 1.0;\n\t#ifdef SHADOWMAP_PSSM3\n\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t#endif\n\t#ifdef SHADOWMAP_PSSM2\n\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t#endif \n\t#ifdef SHADOWMAP_PSSM1\n\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n\t#endif\n#endif\n\n#ifdef LIGHTMAP\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb);\n\t#else\n\t\t#if defined(RECEIVESHADOW)\t\t\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient+texture2D(u_LightMap, v_LightMapUV).rgb * shadowValue);\n\t\t\t//vec3 tColor= u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb * shadowValue + mix(vec3(0.15,0.15,0.15),vec3(0.0),shadowValue);\n\t\t\t//gl_FragColor.rgb*=tColor;\n\t\t#else\n\t\t\tgl_FragColor.rgb=gl_FragColor.rgb*(u_MaterialAmbient + texture2D(u_LightMap, v_LightMapUV).rgb);\n\t\t#endif\n\t#endif\n#endif\n\ngl_FragColor=gl_FragColor*u_MaterialAlbedo;\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t#ifdef RECEIVESHADOW\n\t\tgl_FragColor = vec4( gl_FragColor.rgb*(ambient + diffuse*shadowValue) + specular * shadowValue,gl_FragColor.a);\n\t#else\n\t\tgl_FragColor =vec4( gl_FragColor.rgb*(ambient + diffuse) + specular, gl_FragColor.a);\n\t#endif\n#endif\n\n#ifdef FOG\n\tfloat lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n#endif\n}\n\n\n\n\n\n';var E=ui.add(g,t,e,i,n);E.addSpriteDefines(cn.shaderDefines),E.addSpriteDefines(Ui.shaderDefines),i={a_Position:0,a_OffsetVector:40,a_Texcoord0X:38,a_Texcoord0Y:39,a_BirthTime:33},n={u_MvpMatrix:[1,2],u_VMatrix:[1,3],u_PMatrix:[2,3],u_TilingOffset:[3,1],u_MainTexture:[1,1],u_MainColor:[2,1],u_CurTime:[3,2],u_LifeTime:[4,2],u_WidthCurve:[5,2],u_WidthCurveKeyLength:[6,2],u_GradientColorkey:[7,2],u_GradientAlphakey:[8,2]};var x=Fi.nameKey.add("Trail");t="attribute vec3 a_Position;\nattribute vec3 a_OffsetVector;\nattribute vec4 a_Color;\nattribute float a_Texcoord0X;\nattribute float a_Texcoord0Y;\nattribute float a_BirthTime;\n\nuniform mat4 u_VMatrix;\nuniform mat4 u_PMatrix;\n\nuniform vec4 u_TilingOffset;\n\nuniform float u_CurTime;\nuniform float u_LifeTime;\nuniform vec4 u_WidthCurve[10];\nuniform int u_WidthCurveKeyLength;\n\nuniform vec4 u_GradientColorkey[10];\nuniform vec2 u_GradientAlphakey[10];\n\nvarying vec2 v_Texcoord0;\nvarying vec4 v_Color;\n\nfloat hermiteInterpolate(float t, float outTangent, float inTangent, float duration, float value1, float value2)\n{\n\tfloat t2 = t * t;\n\tfloat t3 = t2 * t;\n\tfloat a = 2.0 * t3 - 3.0 * t2 + 1.0;\n\tfloat b = t3 - 2.0 * t2 + t;\n\tfloat c = t3 - t2;\n\tfloat d = -2.0 * t3 + 3.0 * t2;\n\treturn a * value1 + b * outTangent * duration + c * inTangent * duration + d * value2;\n}\n\nfloat getCurWidth(in float normalizeTime)\n{\n\tif(normalizeTime == 0.0){\n\t\treturn u_WidthCurve[0].w;\n\t}\n\telse if(normalizeTime >= 1.0){\n\t\treturn u_WidthCurve[u_WidthCurveKeyLength - 1].w;\n\t}\n\telse{\n\t\tfor(int i = 0; i < 10; i ++ )\n\t\t{\n\t\t\tif(normalizeTime == u_WidthCurve[i].x)\n\t\t\t{\n\t\t\t\treturn u_WidthCurve[i].w;\n\t\t\t}\n\t\t\t\n\t\t\tvec4 lastFrame = u_WidthCurve[i];\n\t\t\tvec4 nextFrame = u_WidthCurve[i + 1];\n\t\t\tif(normalizeTime > lastFrame.x && normalizeTime < nextFrame.x)\n\t\t\t{\n\t\t\t\tfloat duration = nextFrame.x - lastFrame.x;\n\t\t\t\tfloat t = (normalizeTime - lastFrame.x) / duration;\n\t\t\t\tfloat outTangent = lastFrame.z;\n\t\t\t\tfloat inTangent = nextFrame.y;\n\t\t\t\tfloat value1 = lastFrame.w;\n\t\t\t\tfloat value2 = nextFrame.w;\n\t\t\t\treturn hermiteInterpolate(t, outTangent, inTangent, duration, value1, value2);\n\t\t\t}\n\t\t}\t\n\t}\n}\t\n\nvec4 getColorFromGradientByBlend(in vec4 gradientColors[10], in vec2 gradientAlphas[10], in float normalizeTime)\n{\n\tvec4 color;\n\tfor(int i = 1; i < 10; i++)\n\t{\n\t\tvec4 gradientColor = gradientColors[i];\n\t\tfloat colorKey = gradientColor.w;\n\t\tif(colorKey >= normalizeTime)\n\t\t{\n\t\t\tvec4 lastGradientColor = gradientColors[i-1];\n\t\t\tfloat lastColorKey = lastGradientColor.w;\n\t\t\tfloat age = (normalizeTime - lastColorKey) / (colorKey - lastColorKey);\n\t\t\tcolor.rgb = mix(gradientColors[i-1].xyz, gradientColor.xyz, age);\n\t\t\tbreak;\n\t\t}\n\t}\n\tfor(int i = 1; i < 10; i++)\n\t{\n\t\tvec2 gradientAlpha = gradientAlphas[i];\n\t\tfloat alphaKey = gradientAlpha.y;\n\t\tif(alphaKey >= normalizeTime)\n\t\t{\n\t\t\tvec2 lastGradientAlpha = gradientAlphas[i-1];\n\t\t\tfloat lastAlphaKey = lastGradientAlpha.y;\n\t\t\tfloat age = (normalizeTime - lastAlphaKey) / (alphaKey - lastAlphaKey);\n\t\t\tcolor.a = mix(lastGradientAlpha.x, gradientAlpha.x, age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn color;\n}\n\nvec4 getColorFromGradientByFixed(in vec4 gradientColors[10], in vec2 gradientAlphas[10], in float normalizeTime)\n{\n\tvec4 color;\n\tfor(int i = 1; i < 10; i++)\n\t{\n\t\tvec4 gradientColor = gradientColors[i];\n\t\tif(gradientColor.w >= normalizeTime)\n\t\t{\n\t\t\tcolor.rgb = gradientColor.xyz;\n\t\t\tbreak;\n\t\t}\n\t}\n\tfor(int i = 1; i < 10; i++)\n\t{\n\t\tvec2 gradientAlpha = gradientAlphas[i];\n\t\tif(gradientAlpha.y >= normalizeTime)\n\t\t{\n\t\t\tcolor.a = gradientAlpha.x;\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn color;\n}\n\nvoid main()\n{\n\tfloat normalizeTime = (u_CurTime - a_BirthTime) / u_LifeTime;\n\t\n\tgl_Position = u_PMatrix * u_VMatrix * vec4(a_Position + a_OffsetVector * getCurWidth(normalizeTime),1.0);\n\t\n\tv_Texcoord0 = vec2(a_Texcoord0X, a_Texcoord0Y);\n\t\n\t#ifdef TILINGOFFSET\n\t\tv_Texcoord0 = (vec2(v_Texcoord0.x, v_Texcoord0.y) * u_TilingOffset.xy) + u_TilingOffset.zw;\n\t#endif\n\t\tv_Texcoord0 = vec2(v_Texcoord0.x, v_Texcoord0.y);\n\t\t\n\tv_Texcoord0 = (vec2(v_Texcoord0.x, v_Texcoord0.y) * u_TilingOffset.xy) + u_TilingOffset.zw;\n\t\n\t#ifdef GRADIENTMODE_BLEND\n\t\tv_Color = getColorFromGradientByBlend(u_GradientColorkey, u_GradientAlphakey, normalizeTime);\n\t#else\n\t\tv_Color = getColorFromGradientByFixed(u_GradientColorkey, u_GradientAlphakey, normalizeTime);\n\t#endif\n}\n\n\n\n",e="#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nuniform sampler2D u_MainTexture;\nuniform vec4 u_MainColor;\n\nvarying vec2 v_Texcoord0;\nvarying vec4 v_Color;\n\nvoid main()\n{\t\n\tvec4 color = 2.0 * u_MainColor * v_Color;\n\t#ifdef DIFFUSETEXTURE\n\t\tvec4 mainTextureColor = texture2D(u_MainTexture, v_Texcoord0);\n\t\tcolor *= mainTextureColor;\n\t#endif\n\tgl_FragColor = color;\n}\n\n";var T=ui.add(x,t,e,i,n);qi.SHADERDEFINE_DIFFUSETEXTURE=T.registerMaterialDefine("DIFFUSETEXTURE"),qi.SHADERDEFINE_TILINGOFFSET=T.registerSpriteDefine("TILINGOFFSET"),xn.SHADERDEFINE_GRADIENTMODE_BLEND=T.registerSpriteDefine("GRADIENTMODE_BLEND")},t}(),He=function(){function t(){this._data=null,this._data=[]}r(t,"laya.d3.shader.ValusArray");var e=t.prototype;return e.setValue=function(t,e){this._data[t]=e},a(0,e,"data",function(){return this._data}),t}(),Ge=function(){function t(){this._currentPSSM=-1,this._numberOfPSSM=3,this._maxDistance=200,this._ratioOfDistance=1/this._numberOfPSSM,this._statesDirty=!0,this._lightCulling=null,this._renderTarget=null,this._lightVPMatrix=null,this._lightCameras=null,this._shadowQuenes=null,this._shadowMapTextureSize=1024,this._scene=null,this._PCFType=0,this._shaderValueLightVP=null,this._shaderValueVPs=null,this._spiltDistance=new Array(4),this._globalParallelLightDir=new Pe(0,-1,0),this._boundingSphere=new Array(4),this._boundingBox=new Array(4),this._frustumPos=new Array(16),this._uniformDistance=new Array(4),this._logDistance=new Array(4),this._dimension=new Array(4),this._tempLookAt3=new Pe,this._tempLookAt4=new Le,this._tempValue=new Le,this._tempPos=new Pe,this._tempLightUp=new Pe,this._tempMin=new Le,this._tempMax=new Le,this._tempMatrix44=new Ae,this._splitFrustumCulling=new Te(Ae.DEFAULT),this._tempScaleMatrix44=new Ae,this._shadowPCFOffset=new Ne(1/1024,1/1024),this._shaderValueDistance=new Le;var t=0;for(t=0;t<this._spiltDistance.length;t++)this._spiltDistance[t]=0;for(t=0;t<this._dimension.length;t++)this._dimension[t]=new Ne;for(t=0;t<this._frustumPos.length;t++)this._frustumPos[t]=new Pe;for(t=0;t<this._boundingBox.length;t++)this._boundingBox[t]=new xe(new Pe,new Pe);for(t=0;t<this._boundingSphere.length;t++)this._boundingSphere[t]=new Se(new Pe,0);Ae.createScaling(new Pe(.5,.5,1),this._tempScaleMatrix44),this._tempScaleMatrix44.elements[12]=.5,this._tempScaleMatrix44.elements[13]=.5}r(t,"laya.d3.shadowMap.ParallelSplitShadowMap");var e=t.prototype;return e.setInfo=function(t,e,i,n,r,a){r>3&&(this._numberOfPSSM=3),this._scene=t,this._maxDistance=e,this.PSSMNum=r,this._globalParallelLightDir=i,this._ratioOfDistance=1/this._numberOfPSSM;for(var s=0;s<this._spiltDistance.length;s++)this._spiltDistance[s]=0;this._shadowMapTextureSize=n,this._shadowPCFOffset.x=1/this._shadowMapTextureSize,this._shadowPCFOffset.y=1/this._shadowMapTextureSize,this.setPCFType(a),this._statesDirty=!0},e.setPCFType=function(t){switch(this._PCFType=t,this._PCFType){case 0:this._scene.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF_NO),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF1),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF2),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF3);break;case 1:this._scene.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF1),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF_NO),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF2),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF3);break;case 2:this._scene.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF2),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF_NO),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF1),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF3);break;case 3:this._scene.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF3),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF_NO),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF1),this._scene.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PCF2)}},e.getPCFType=function(){return this._PCFType},e.setFarDistance=function(t){this._maxDistance!=t&&(this._maxDistance=t,this._statesDirty=!0)},e.getFarDistance=function(){return this._maxDistance},e._setGlobalParallelLightDir=function(t){this._globalParallelLightDir=t},e.getGlobalParallelLightDir=function(){return this._globalParallelLightDir},e.getCurrentPSSM=function(){return this._currentPSSM},e.getLightCamera=function(t){return this._lightCameras[t]},e._beginSampler=function(t,e){if(t<0||t>this._numberOfPSSM)throw new Error("ParallelSplitShadowMap: beginSample invalid index");this._currentPSSM=t,this._update(e)},e.endSampler=function(t){this._currentPSSM=-1},e._calcAllLightCameraInfo=function(t){if(1===this._numberOfPSSM)this._beginSampler(0,t),this.endSampler(t);else for(var e=0,i=this._numberOfPSSM+1;e<i;e++)this._beginSampler(e,t),this.endSampler(t)},e._recalculate=function(t,e,i){this._calcSplitDistance(t),this._calcBoundingBox(e,i),this._rebuildRenderInfo()},e._update=function(t){var e=t.nearPlane,i=t.fieldOfView,n=t.aspectRatio;(this._statesDirty||this.lastNearPlane!==e||this.lastFieldOfView!==i||this.lastAspectRatio!==n)&&(this._recalculate(e,i,n),this._uploadShaderValue(),this._statesDirty=!1,this.lastNearPlane=e,this.lastFieldOfView=i,this.lastAspectRatio=n),this._calcLightViewProject(t)},e._uploadShaderValue=function(){var t=this._scene;switch(this._numberOfPSSM){case 1:t.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM1),t.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM2),t.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM3);break;case 2:t.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM2),t.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM1),t.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM3);break;case 3:t.addShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM3),t.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM1),t.removeShaderDefine(laya.d3.shadowMap.ParallelSplitShadowMap.SHADERDEFINE_SHADOW_PSSM2)}var e=t._shaderValues;switch(e.setValue(15,this._shaderValueDistance.elements),e.setValue(16,this._shaderValueLightVP),e.setValue(17,this._shadowPCFOffset.elements),this._numberOfPSSM){case 3:e.setValue(18,this.getRenderTarget(1)),e.setValue(19,this.getRenderTarget(2)),e.setValue(20,this.getRenderTarget(3));break;case 2:e.setValue(18,this.getRenderTarget(1)),e.setValue(19,this.getRenderTarget(2));break;case 1:e.setValue(18,this.getRenderTarget(1))}},e._calcSplitDistance=function(t){var e=this._maxDistance,i=1/this._numberOfPSSM,n=0;for(n=0;n<=this._numberOfPSSM;n++)this._uniformDistance[n]=t+(e-t)*n*i;var r=e/t;for(n=0;n<=this._numberOfPSSM;n++){var a=Math.pow(r,n*i);this._logDistance[n]=t*a}for(n=0;n<=this._numberOfPSSM;n++)this._spiltDistance[n]=this._uniformDistance[n]*this._ratioOfDistance+this._logDistance[n]*(1-this._ratioOfDistance);this._shaderValueDistance.x=this._spiltDistance[1],this._shaderValueDistance.y=this._spiltDistance[2],this._shaderValueDistance.z=this._spiltDistance[3],this._shaderValueDistance.w=this._spiltDistance[4]},e._calcBoundingBox=function(t,e){var i=3.1415926*t/180,n=Math.tan(i/2),r=NaN,a=NaN,s=NaN,o=0;for(o=0;o<=this._numberOfPSSM;o++){s=this._spiltDistance[o],r=s*n,a=r*e;var l=this._frustumPos[4*o+0].elements;l[0]=-a,l[1]=-r,l[2]=-s,l=this._frustumPos[4*o+1].elements,l[0]=a,l[1]=-r,l[2]=-s,l=this._frustumPos[4*o+2].elements,l[0]=-a,l[1]=r,l[2]=-s,l=this._frustumPos[4*o+3].elements,l[0]=a,l[1]=r,l[2]=-s,l=this._dimension[o].elements,l[0]=a,l[1]=r}var h,u,_,c;for(o=1;o<=this._numberOfPSSM;o++)h=this._dimension[o].elements,u=this._boundingBox[o].min.elements,u[0]=-h[0],u[1]=-h[1],u[2]=-this._spiltDistance[o],_=this._boundingBox[o].max.elements,_[0]=h[0],_[1]=h[1],_[2]=-this._spiltDistance[o-1],c=this._boundingSphere[o].center.elements,c[0]=.5*(u[0]+_[0]),c[1]=.5*(u[1]+_[1]),c[2]=.5*(u[2]+_[2]),this._boundingSphere[o].radius=.5*Math.sqrt(Math.pow(_[0]-u[0],2)+Math.pow(_[1]-u[1],2)+Math.pow(_[2]-u[2],2));u=this._boundingBox[0].min.elements,h=this._dimension[this._numberOfPSSM].elements,u[0]=-h[0],u[1]=-h[1],u[2]=-this._spiltDistance[this._numberOfPSSM],_=this._boundingBox[0].max.elements,_[0]=h[0],_[1]=h[1],_[2]=-this._spiltDistance[0],c=this._boundingSphere[0].center.elements,c[0]=.5*(u[0]+_[0]),c[1]=.5*(u[1]+_[1]),c[2]=.5*(u[2]+_[2]),this._boundingSphere[0].radius=.5*Math.sqrt(Math.pow(_[0]-u[0],2)+Math.pow(_[1]-u[1],2)+Math.pow(_[2]-u[2],2))},e.calcSplitFrustum=function(t){this._currentPSSM>0?Ae.createPerspective(3.1416*t.fieldOfView/180,t.aspectRatio,this._spiltDistance[this._currentPSSM-1],this._spiltDistance[this._currentPSSM],this._tempMatrix44):Ae.createPerspective(3.1416*t.fieldOfView/180,t.aspectRatio,this._spiltDistance[0],this._spiltDistance[this._numberOfPSSM],this._tempMatrix44),Ae.multiply(this._tempMatrix44,t.viewMatrix,this._tempMatrix44),this._splitFrustumCulling.matrix=this._tempMatrix44},e._rebuildRenderInfo=function(){var t=this._numberOfPSSM+1,e=0;if(null==this._renderTarget)for(this._renderTarget=s(t),this._renderTarget[0]=null,e=1;e<t;e++)this._renderTarget[e]=new an(this._shadowMapTextureSize,this._shadowMapTextureSize,6408,5121,33189,!1,!1,9728,9728);else if(this._renderTarget.length!=t)for(this.disposeAllRenderTarget(),this._renderTarget.length=t,this._renderTarget[0]=null,e=1;e<t;e++)this._renderTarget[e]=new an(this._shadowMapTextureSize,this._shadowMapTextureSize,6408,5121,33189,!1,!1,9728,9728);else for(e=1;e<t;e++)null!=this._renderTarget[e]&&this._renderTarget[e].width==this._shadowMapTextureSize&&this._renderTarget[e].height==this._shadowMapTextureSize||(null!=this._renderTarget[e]&&this._renderTarget[e].destroy(),this._renderTarget[e]=new an(this._shadowMapTextureSize,this._shadowMapTextureSize,6408,5121,33189,!1,!1,9728,9728));if(null==this._lightCulling||this._lightCulling.length!=t)for(this._lightCulling?this._lightCulling.length=t:this._lightCulling=s(t),e=0;e<this._lightCulling.length;e++)this._lightCulling[e]=new Te(Ae.DEFAULT);if(null==this._lightVPMatrix||this._lightVPMatrix.length!=t)for(this._lightVPMatrix?this._lightVPMatrix.length=t:this._lightVPMatrix=s(t),e=0;e<this._lightVPMatrix.length;e++)this._lightVPMatrix[e]=new Ae;if(null==this._lightCameras||this._lightCameras.length!=t)for(this._lightCameras?this._lightCameras.length=t:this._lightCameras=s(t),e=0;e<this._lightCameras.length;e++)this._lightCameras[e]=new mn,this._lightCameras[e].name="lightCamera"+e;if(null==this._shadowQuenes||this._shadowQuenes.length!=this._numberOfPSSM)for(this._shadowQuenes?this._shadowQuenes.length=this._numberOfPSSM:this._shadowQuenes=s(this._numberOfPSSM),e=0;e<this._shadowQuenes.length;e++)this._shadowQuenes[e]=new _t(this._scene);if(null==this._shaderValueVPs||this._shaderValueVPs.length!=t)for(this._shaderValueVPs?this._shaderValueVPs.length=t:this._shaderValueVPs=s(t),this._shaderValueLightVP=new Float32Array(16*t),e=0;e<t;e++)this._shaderValueVPs[e]=new Float32Array(this._shaderValueLightVP.buffer,64*e)},e._calcLightViewProject=function(e){var i=this._boundingSphere[this._currentPSSM],n=e.transform.worldMatrix;i.radius;i.center.cloneTo(this._tempLookAt3),Pe.transformV3ToV4(this._tempLookAt3,n,this._tempLookAt4);var r=this._tempLookAt3.elements,a=this._tempLookAt4.elements;r[0]=a[0],r[1]=a[1],r[2]=a[2];var s=this._tempLightUp.elements,o=e.forward.elements;s[0]=o[0],s[1]=1,s[2]=o[2],Pe.normalize(this._tempLightUp,this._tempLightUp),Pe.scale(this._globalParallelLightDir,4*i.radius,this._tempPos),Pe.subtract(this._tempLookAt3,this._tempPos,this._tempPos);var l=this._lightCameras[this._currentPSSM];l.transform.position=this._tempPos,l.transform.lookAt(this._tempLookAt3,this._tempLightUp,!1);var h=this._tempMax.elements,u=this._tempMin.elements;h[0]=h[1]=h[2]=-1e5,h[3]=1,u[0]=u[1]=u[2]=1e5,u[3]=1,Ae.multiply(l.viewMatrix,n,this._tempMatrix44);var _=this._tempValue.elements,c=[];c.length=8,this._boundingBox[this._currentPSSM].getCorners(c);for(var d=0;d<8;d++){var f=c[d].elements;_[0]=f[0],_[1]=f[1],_[2]=f[2],_[3]=1,Le.transformByM4x4(this._tempValue,this._tempMatrix44,this._tempValue),u[0]=_[0]<u[0]?_[0]:u[0],u[1]=_[1]<u[1]?_[1]:u[1],u[2]=_[2]<u[2]?_[2]:u[2],h[0]=_[0]>h[0]?_[0]:h[0],h[1]=_[1]>h[1]?_[1]:h[1],h[2]=_[2]>h[2]?_[2]:h[2]}Le.add(this._tempMax,this._tempMin,this._tempValue),_[0]*=.5,_[1]*=.5,_[2]*=.5,_[3]=1,Le.transformByM4x4(this._tempValue,l.transform.worldMatrix,this._tempValue);var m=Math.abs(-this._tempMax.z),p=m>this._maxDistance?m:this._maxDistance;Pe.scale(this._globalParallelLightDir,p,this._tempPos);var v=this._tempPos.elements;v[0]=_[0]-v[0],v[1]=_[1]-v[1],v[2]=_[2]-v[2],l.transform.position=this._tempPos,l.transform.lookAt(this._tempLookAt3,this._tempLightUp,!1),Ae.createOrthoOffCenterRH(u[0],h[0],u[1],h[1],1,p+.5*(h[2]-u[2]),l.projectionMatrix),l.projectionViewMatrix.cloneTo(this._lightVPMatrix[this._currentPSSM]),this._lightCulling[this._currentPSSM].matrix=this._lightVPMatrix[this._currentPSSM],t.multiplyMatrixOutFloat32Array(this._tempScaleMatrix44,this._lightVPMatrix[this._currentPSSM],this._shaderValueVPs[this._currentPSSM])},e.getLightFrustumCulling=function(t){return this._lightCulling[t]},e.getSplitFrustumCulling=function(){return this._splitFrustumCulling},e.getSplitDistance=function(t){return this._spiltDistance[t]},e.setShadowMapTextureSize=function(t){t!==this._shadowMapTextureSize&&(this._shadowMapTextureSize=t,this._shadowPCFOffset.x=1/this._shadowMapTextureSize,this._shadowPCFOffset.y=1/this._shadowMapTextureSize,this._statesDirty=!0)},e.getShadowMapTextureSize=function(){return this._shadowMapTextureSize},e.beginRenderTarget=function(t){this._renderTarget[t].start()},e.endRenderTarget=function(t){this._renderTarget[t].end()},e.getRenderTarget=function(t){return this._renderTarget[t]},e.disposeAllRenderTarget=function(){for(var t=0,e=this._numberOfPSSM+1;t<e;t++)this._renderTarget[t]&&(this._renderTarget[t].destroy(),this._renderTarget[t]=null)},a(0,e,"PSSMNum",function(){return this._numberOfPSSM},function(t){t=t>0?t:1,t=t<=3?t:3,this._numberOfPSSM!=t&&(this._numberOfPSSM=t,this._ratioOfDistance=1/this._numberOfPSSM,this._statesDirty=!0)}),t.multiplyMatrixOutFloat32Array=function(t,e,i){var n,r,a,s,o,l,h;for(r=t.elements,a=e.elements,n=0;n<4;n++)s=r[n],o=r[n+4],l=r[n+8],h=r[n+12],i[n]=s*a[0]+o*a[1]+l*a[2]+h*a[3],i[n+4]=s*a[4]+o*a[5]+l*a[6]+h*a[7],i[n+8]=s*a[8]+o*a[9]+l*a[10]+h*a[11],i[n+12]=s*a[12]+o*a[13]+l*a[14]+h*a[15]},t.SHADERDEFINE_RECEIVE_SHADOW=1,t.SHADERDEFINE_CAST_SHADOW=512,t.SHADERDEFINE_SHADOW_PSSM1=1024,t.SHADERDEFINE_SHADOW_PSSM2=2048,t.SHADERDEFINE_SHADOW_PSSM3=4096,t.SHADERDEFINE_SHADOW_PCF_NO=8192,t.SHADERDEFINE_SHADOW_PCF1=16384,t.SHADERDEFINE_SHADOW_PCF2=32768,t.SHADERDEFINE_SHADOW_PCF3=65536,t.MAX_PSSM_COUNT=3,t}(),ze=function(){function t(){this._boundingSphere=null,this._boundingBox=null,this._sizeOfY=null,this._currentLODLevel=0,this._lastDistanceToEye=NaN,this._originalBoundingSphere=null,this._originalBoundingBox=null,this._originalBoundingBoxCorners=null,this._bUseStrip=!1,this._gridSize=NaN,this._beginGridX=0,this._beginGridZ=0,this._LODError=null,t.__init__(),this._currentLODLevel=0}r(t,"laya.d3.terrain.TerrainLeaf");var e=t.prototype;return e.calcVertextNorml=function(e,i,n,r,a,s){var o=0,l=0;l=-1*t.getHeightFromTerrainHeightData(e-1,i-1,n,r,a),l+=-1*t.getHeightFromTerrainHeightData(e-1,i,n,r,a),l+=-1*t.getHeightFromTerrainHeightData(e-1,i+1,n,r,a),l+=1*t.getHeightFromTerrainHeightData(e+1,i-1,n,r,a),l+=1*t.getHeightFromTerrainHeightData(e+1,i,n,r,a),l+=1*t.getHeightFromTerrainHeightData(e+1,i+1,n,r,a),o=-1*t.getHeightFromTerrainHeightData(e-1,i-1,n,r,a),o+=-1*t.getHeightFromTerrainHeightData(e,i-1,n,r,a),o+=-1*t.getHeightFromTerrainHeightData(e+1,i-1,n,r,a),o+=1*t.getHeightFromTerrainHeightData(e-1,i+1,n,r,a),o+=1*t.getHeightFromTerrainHeightData(e,i+1,n,r,a),o+=1*t.getHeightFromTerrainHeightData(e+1,i+1,n,r,a),s.x=-l,s.y=6,s.z=-o,Pe.normalize(s,s)},e.calcVertextNormlUV=function(t,e,i,n,r){r.x=t/i,r.y=e/n,r.z=e/n},e.calcVertextBuffer=function(e,i,n,r,a,s,o,l,h,u,_,c){if(1==c&&!t.__ADAPT_MATRIX__){t.__ADAPT_MATRIX__=new Ae;var d=new Ae;Ae.createRotationY(Math.PI,t.__ADAPT_MATRIX__),Ae.createTranslate(new Pe(0,0,(_-1)*a),d),Ae.multiply(d,t.__ADAPT_MATRIX__,t.__ADAPT_MATRIX__),t.__ADAPT_MATRIX_INV__=new Ae,t.__ADAPT_MATRIX__.invert(t.__ADAPT_MATRIX_INV__)}this._gridSize=a,this._beginGridX=e*t.CHUNK_GRID_NUM+n,this._beginGridZ=i*t.CHUNK_GRID_NUM+r;for(var f=o*l,m=2147483647,p=-2147483648,v=new Pe,g=0,E=t.LEAF_GRID_NUM+1;g<E;g++)for(var x=0,T=t.LEAF_GRID_NUM+1;x<T;x++)t.__VECTOR3__.x=(this._beginGridX+x)*this._gridSize,t.__VECTOR3__.z=(this._beginGridZ+g)*this._gridSize,t.__VECTOR3__.y=h[(this._beginGridZ+g)*u+(this._beginGridX+x)],m=t.__VECTOR3__.y<m?t.__VECTOR3__.y:m,p=t.__VECTOR3__.y>p?t.__VECTOR3__.y:p,t.__ADAPT_MATRIX__&&Pe.transformV3ToV3(t.__VECTOR3__,t.__ADAPT_MATRIX__,t.__VECTOR3__),s[f]=t.__VECTOR3__.x,f++,s[f]=t.__VECTOR3__.y,f++,s[f]=t.__VECTOR3__.z,f++,this.calcVertextNormlUV(this._beginGridX+x,this._beginGridZ+g,u,_,v),s[f]=v.x,f++,s[f]=v.y,f++,s[f]=v.z,f++,s[f]=(n+x)/t.CHUNK_GRID_NUM,f++,s[f]=(r+g)/t.CHUNK_GRID_NUM,f++,s[f]=this._beginGridX+x,f++,s[f]=this._beginGridZ+g,f++;this._sizeOfY=new Ne(m-1,p+1),this.calcLODErrors(h,u,_),this.calcOriginalBoudingBoxAndSphere()},e.calcSkirtVertextBuffer=function(e,i,n,r,a,s,o,l,h,u,_){this._gridSize=a,this._beginGridX=e*t.CHUNK_GRID_NUM+n,this._beginGridZ=i*t.CHUNK_GRID_NUM+r;var c=o*l,d=0,f=0,m=t.LEAF_GRID_NUM+1,p=new Pe,v=0,g=0;for(d=0;d<2;d++)for(f=0;f<m;f++)t.__VECTOR3__.x=(this._beginGridX+f)*this._gridSize,t.__VECTOR3__.y=1==d?h[this._beginGridZ*u+(this._beginGridX+f)]:-this._gridSize,t.__VECTOR3__.z=(this._beginGridZ+0)*this._gridSize,t.__ADAPT_MATRIX__&&Pe.transformV3ToV3(t.__VECTOR3__,t.__ADAPT_MATRIX__,t.__VECTOR3__),s[c]=t.__VECTOR3__.x,c++,s[c]=t.__VECTOR3__.y,c++,s[c]=t.__VECTOR3__.z,c++,v=0==d?this._beginGridZ-1:this._beginGridZ,this.calcVertextNormlUV(this._beginGridX+f,v,u,_,p),s[c]=p.x,c++,s[c]=p.y,c++,s[c]=p.z,c++,s[c]=(n+f)/t.CHUNK_GRID_NUM,c++,s[c]=(r+0)/t.CHUNK_GRID_NUM,c++,s[c]=this._beginGridX+f,c++,s[c]=v,c++;for(d=0;d<2;d++)for(f=0;f<m;f++)t.__VECTOR3__.x=(this._beginGridX+f)*this._gridSize,t.__VECTOR3__.y=0==d?h[(this._beginGridZ+t.LEAF_GRID_NUM)*u+(this._beginGridX+f)]:-this._gridSize,t.__VECTOR3__.z=(this._beginGridZ+t.LEAF_GRID_NUM)*this._gridSize,t.__ADAPT_MATRIX__&&Pe.transformV3ToV3(t.__VECTOR3__,t.__ADAPT_MATRIX__,t.__VECTOR3__),s[c]=t.__VECTOR3__.x,c++,s[c]=t.__VECTOR3__.y,c++,s[c]=t.__VECTOR3__.z,c++,v=0==d?this._beginGridZ+t.LEAF_GRID_NUM:this._beginGridZ+t.LEAF_GRID_NUM+1,this.calcVertextNormlUV(this._beginGridX+f,v,u,_,p),s[c]=p.x,c++,s[c]=p.y,c++,s[c]=p.z,c++,s[c]=(n+f)/t.CHUNK_GRID_NUM,c++,s[c]=(r+t.LEAF_GRID_NUM)/t.CHUNK_GRID_NUM,c++,s[c]=this._beginGridX+f,c++,s[c]=v,c++;for(d=0;d<2;d++)for(f=0;f<m;f++)t.__VECTOR3__.x=(this._beginGridX+0)*this._gridSize,t.__VECTOR3__.y=0==d?h[(this._beginGridZ+f)*u+(this._beginGridX+0)]:-this._gridSize,t.__VECTOR3__.z=(this._beginGridZ+f)*this._gridSize,t.__ADAPT_MATRIX__&&Pe.transformV3ToV3(t.__VECTOR3__,t.__ADAPT_MATRIX__,t.__VECTOR3__),s[c]=t.__VECTOR3__.x,c++,s[c]=t.__VECTOR3__.y,c++,s[c]=t.__VECTOR3__.z,c++,g=0==d?this._beginGridX:this._beginGridX-1,this.calcVertextNormlUV(g,this._beginGridZ+f,u,_,p),s[c]=p.x,c++,s[c]=p.y,c++,s[c]=p.z,c++,s[c]=(n+0)/t.CHUNK_GRID_NUM,c++,s[c]=(r+f)/t.CHUNK_GRID_NUM,c++,s[c]=g,c++,s[c]=this._beginGridZ+f,c++;for(d=0;d<2;d++)for(f=0;f<m;f++)t.__VECTOR3__.x=(this._beginGridX+t.LEAF_GRID_NUM)*this._gridSize,t.__VECTOR3__.y=1==d?h[(this._beginGridZ+f)*u+(this._beginGridX+t.LEAF_GRID_NUM)]:-this._gridSize,t.__VECTOR3__.z=(this._beginGridZ+f)*this._gridSize,t.__ADAPT_MATRIX__&&Pe.transformV3ToV3(t.__VECTOR3__,t.__ADAPT_MATRIX__,t.__VECTOR3__),s[c]=t.__VECTOR3__.x,c++,s[c]=t.__VECTOR3__.y,c++,s[c]=t.__VECTOR3__.z,c++,g=0==d?this._beginGridX+t.LEAF_GRID_NUM+1:this._beginGridX+t.LEAF_GRID_NUM,this.calcVertextNormlUV(g,this._beginGridZ+f,u,_,p),s[c]=p.x,c++,s[c]=p.y,c++,s[c]=p.z,c++,s[c]=(n+t.LEAF_GRID_NUM)/t.CHUNK_GRID_NUM,c++,s[c]=(r+f)/t.CHUNK_GRID_NUM,c++,s[c]=g,c++,s[c]=this._beginGridZ+f,c++},e.calcOriginalBoudingBoxAndSphere=function(){var e=new Pe(this._beginGridX*this._gridSize,this._sizeOfY.x,this._beginGridZ*this._gridSize),i=new Pe((this._beginGridX+t.LEAF_GRID_NUM)*this._gridSize,this._sizeOfY.y,(this._beginGridZ+t.LEAF_GRID_NUM)*this._gridSize);t.__ADAPT_MATRIX__&&(Pe.transformV3ToV3(e,t.__ADAPT_MATRIX__,e),Pe.transformV3ToV3(i,t.__ADAPT_MATRIX__,i)),this._originalBoundingBox=new xe(e,i);var n=new Pe;Pe.subtract(i,e,n),Pe.scale(n,.5,n);var r=new Pe;Pe.add(e,n,r),this._originalBoundingSphere=new Se(r,Pe.scalarLength(n)),this._originalBoundingBoxCorners=s(8,null),this._originalBoundingBox.getCorners(this._originalBoundingBoxCorners),this._boundingBox=new xe(new Pe(-.5,-.5,-.5),new Pe(.5,.5,.5)),this._boundingSphere=new Se(new Pe(0,0,0),1)},e.calcLeafBoudingBox=function(t){for(var e=0;e<8;e++)Pe.transformCoordinate(this._originalBoundingBoxCorners[e],t,ei._tempBoundBoxCorners[e]);xe.createfromPoints(ei._tempBoundBoxCorners,this._boundingBox)},e.calcLeafBoudingSphere=function(t,e){Pe.transformCoordinate(this._originalBoundingSphere.center,t,this._boundingSphere.center),this._boundingSphere.radius=this._originalBoundingSphere.radius*e},e.calcLODErrors=function(e,i,n){this._LODError=new Float32Array(t._maxLODLevel+1);for(var r=1,a=0,s=t._maxLODLevel+1;a<s;a++){for(var o=0,l=0,h=t.LEAF_GRID_NUM;l<h;l+=r)for(var u=0,_=t.LEAF_GRID_NUM;u<_;u+=r)for(var c=e[(this._beginGridZ+l)*i+(this._beginGridX+u)],d=e[(this._beginGridZ+l)*i+(this._beginGridX+u)+r],f=e[(this._beginGridZ+l+r)*i+(this._beginGridX+u)],m=e[(this._beginGridZ+l+r)*i+(this._beginGridX+u)+r],p=0;p<r;p++)for(var v=p/r,g=0;g<r;g++){var E=g/r,x=e[(this._beginGridZ+l+p)*i+(this._beginGridX+u)+g],T=E+v<=1?c+(d-c)*E+(f-c)*v:m+(f-m)*(1-E)+(d-m)*(1-v),S=Math.abs(T-x);o=Math.max(o,S)}r*=2,this._LODError[a]=o}},e.determineLod=function(e,i,n,r){var a=Pe.distance(e,this._boundingSphere.center),s=t._maxLODLevel;if(!r){if(this._lastDistanceToEye==a)return this._currentLODLevel;this._lastDistanceToEye>a&&(s=this._currentLODLevel)}for(var o=s;o>=1;o--)if(fn.LOD_DISTANCE_FACTOR*this._LODError[o]/a*i<n){this._currentLODLevel=o;break}return this._lastDistanceToEye=a,this._currentLODLevel},t.__init__=function(){if(!t._bInit){var e=t.CHUNK_GRID_NUM/t.LEAF_GRID_NUM*(t.CHUNK_GRID_NUM/t.LEAF_GRID_NUM);t._planeLODIndex=s(e);var i=0,n=0,r=0,a=0,o=0,l=0,h=null,u=null;for(i=0;i<e;i++)t._planeLODIndex[i]=new Array(t._maxLODLevel+1);for(i=0,a=t._maxLODLevel+1;i<a;i++)t._planeLODIndex[0][i]=t.calcPlaneLODIndex(i);for(i=1;i<e;i++)for(l=i*t.LEAF_PLANE_VERTEXT_COUNT,n=0,o=t._maxLODLevel+1;n<o;n++){for(h=t._planeLODIndex[0][n],u=new Uint16Array(h.length),r=0;r<h.length;r++)u[r]=h[r]+l;t._planeLODIndex[i][n]=u}for(t._skirtLODIndex=s(e),i=0;i<e;i++)t._skirtLODIndex[i]=new Array(t._maxLODLevel+1);for(i=0,a=t._maxLODLevel+1;i<a;i++)t._skirtLODIndex[0][i]=t.calcSkirtLODIndex(i);for(i=1;i<e;i++)for(l=i*t.LEAF_SKIRT_VERTEXT_COUNT,n=0,o=t._maxLODLevel+1;n<o;n++){for(h=t._skirtLODIndex[0][n],u=new Uint16Array(h.length),r=0;r<h.length;r++)u[r]=h[r]+l;t._skirtLODIndex[i][n]=u}t._bInit=!0}},t.getPlaneLODIndex=function(e,i){return t._planeLODIndex[e][i]},t.getSkirtLODIndex=function(e,i){return t._skirtLODIndex[e][i]},t.calcPlaneLODIndex=function(e){e>t._maxLODLevel&&(e=t._maxLODLevel);var i=t.LEAF_GRID_NUM+1,n=0,r=null,a=laya.d3.terrain.TerrainLeaf.LEAF_GRID_NUM/Math.pow(2,e);r=new Uint16Array(a*a*6);for(var s=laya.d3.terrain.TerrainLeaf.LEAF_GRID_NUM/a,o=0;o<t.LEAF_GRID_NUM;o+=s)for(var l=0;l<t.LEAF_GRID_NUM;l+=s)r[n]=(o+s)*i+l,n++,r[n]=o*i+l,n++,r[n]=o*i+l+s,n++,r[n]=o*i+l+s,n++,r[n]=(o+s)*i+l+s,n++,r[n]=(o+s)*i+l,n++;return r},t.calcSkirtLODIndex=function(e){e>t._maxLODLevel&&(e=t._maxLODLevel);var i=t.CHUNK_GRID_NUM/t.LEAF_GRID_NUM*(t.CHUNK_GRID_NUM/t.LEAF_GRID_NUM)*t.LEAF_PLANE_VERTEXT_COUNT,n=t.LEAF_GRID_NUM+1,r=0,a=null,s=laya.d3.terrain.TerrainLeaf.LEAF_GRID_NUM/Math.pow(2,e);a=new Uint16Array(4*s*6);for(var o=laya.d3.terrain.TerrainLeaf.LEAF_GRID_NUM/s,l=0;l<4;l++){for(var h=0;h<t.LEAF_GRID_NUM;h+=o)a[r]=i+n+h,r++,a[r]=i+h,r++,a[r]=i+h+o,r++,a[r]=i+h+o,r++,a[r]=i+n+h+o,r++,a[r]=i+n+h,r++;i+=2*n}return a},t.getHeightFromTerrainHeightData=function(t,e,i,n,r){return t=t<0?0:t,t=t>=n?n-1:t,e=e<0?0:e,e=e>=r?r-1:e,i[e*n+t]},t.CHUNK_GRID_NUM=64,t.LEAF_GRID_NUM=32,t.__ADAPT_MATRIX__=null,t.__ADAPT_MATRIX_INV__=null,t._planeLODIndex=null,t._skirtLODIndex=null,t._bInit=!1,n(t,["LEAF_PLANE_VERTEXT_COUNT",function(){return this.LEAF_PLANE_VERTEXT_COUNT=(t.LEAF_GRID_NUM+1)*(t.LEAF_GRID_NUM+1)},"LEAF_SKIRT_VERTEXT_COUNT",function(){return this.LEAF_SKIRT_VERTEXT_COUNT=2*(t.LEAF_GRID_NUM+1)*4},"LEAF_VERTEXT_COUNT",function(){return this.LEAF_VERTEXT_COUNT=t.LEAF_PLANE_VERTEXT_COUNT+t.LEAF_SKIRT_VERTEXT_COUNT},"LEAF_PLANE_MAX_INDEX_COUNT",function(){return this.LEAF_PLANE_MAX_INDEX_COUNT=t.LEAF_GRID_NUM*t.LEAF_GRID_NUM*6},"LEAF_SKIRT_MAX_INDEX_COUNT",function(){return this.LEAF_SKIRT_MAX_INDEX_COUNT=4*t.LEAF_GRID_NUM*6},"LEAF_MAX_INDEX_COUNT",function(){return this.LEAF_MAX_INDEX_COUNT=t.LEAF_PLANE_MAX_INDEX_COUNT+t.LEAF_SKIRT_MAX_INDEX_COUNT},"__VECTOR3__",function(){return this.__VECTOR3__=new Pe},"_maxLODLevel",function(){return this._maxLODLevel=Math.log2(t.LEAF_GRID_NUM)}]),t}(),ke=function(){function t(){this.alphaMap=null,this.detailID=null,this.normalMap=null}return r(t,"laya.d3.terrain.unit.ChunkInfo"),t}(),We=function(){function t(){this.diffuseTexture=null,this.normalTexture=null,this.scale=null,this.offset=null}return r(t,"laya.d3.terrain.unit.DetailTextureInfo"),t}(),Xe=function(){function t(){this.ambientColor=null,this.diffuseColor=null,this.specularColor=null}return r(t,"laya.d3.terrain.unit.MaterialInfo"),t}(),Ye=function(){function t(){}return r(t,"laya.d3.utils.Physics"),t.__init__=function(){t._layerCollsionMatrix.length=31;for(var e=0;e<31;e++){var i=[],n=31-e;i.length=n;for(var r=0;r<n;r++)i[r]=r===n-1;t._layerCollsionMatrix[e]=i}},t.setLayerCollision=function(e,i,n){t._layerCollsionMatrix[e.number][30-i.number]=n},t.getLayerCollision=function(e,i){return t._layerCollsionMatrix[e.number][30-i.number]},t.setColliderCollision=function(t,e,i){i?(delete t._ignoreCollisonMap[e.id],delete e._ignoreCollisonMap[t.id]):(t._ignoreCollisonMap[e.id]=e,e._ignoreCollisonMap[t.id]=t)},t.getIColliderCollision=function(t,e){return!!t._ignoreCollisonMap[e.id]},t.rayCast=function(e,i,n,r){void 0===n&&(n=1.79e308),void 0===r&&(r=0),t._outHitAllInfo.length=0;for(var a=k.getLayerByNumber(r)._colliders,s=0,o=a.length;s<o;s++){var l=a[s];if(l.enable&&(l.raycast(e,t._outHitInfo,n),-1!==t._outHitInfo.distance&&t._outHitInfo.distance<=n)){var h=new Ke;t._outHitInfo.cloneTo(h),t._outHitAllInfo.push(h)}}if(0==t._outHitAllInfo.length)return i.sprite3D=null,void(i.distance=-1);for(var u=Number.MAX_VALUE,_=0,c=0;c<t._outHitAllInfo.length;c++)t._outHitAllInfo[c].distance<u&&(u=t._outHitAllInfo[c].distance,_=c);t._outHitAllInfo[_].cloneTo(i)},t.rayCastAll=function(e,i,n,r){void 0===n&&(n=1.79e308),void 0===r&&(r=0),i.length=0;for(var a=k.getLayerByNumber(r)._colliders,s=0,o=a.length;s<o;s++){var l=a[s];if(l.enable&&(t._outHitInfo.distance=-1,t._outHitInfo.sprite3D=null,l.raycast(e,t._outHitInfo,n),-1!==t._outHitInfo.distance&&t._outHitInfo.distance<=n)){var h=new Ke;t._outHitInfo.cloneTo(h),i.push(h)}}},t._outHitAllInfo=[],t._layerCollsionMatrix=[],n(t,["_outHitInfo",function(){return this._outHitInfo=new Ke},"collisionManager",function(){return this.collisionManager=new ni},"gravity",function(){return this.gravity=new Pe(0,-9.81,0)}]),t}(),Ze=function(){function t(){}return r(t,"laya.d3.utils.Picker"),t.calculateCursorRay=function(e,i,n,r,a,s){var o=e.elements[0],l=e.elements[1],h=t._tempVector30,u=h.elements;u[0]=o,u[1]=l,u[2]=i.minDepth;var _=t._tempVector31,c=_.elements;c[0]=o,c[1]=l,c[2]=i.maxDepth;var d=s.origin,f=t._tempVector32;i.unprojectFromWVP(h,n,r,a,d),i.unprojectFromWVP(_,n,r,a,f);var m=s.direction.elements;m[0]=f.x-d.x,m[1]=f.y-d.y,m[2]=f.z-d.z,Pe.normalize(s.direction,s.direction)},t.rayIntersectsPositionsAndIndices=function(e,i,n,r,a){for(var s=n.vertexStride/4,o=n.getVertexElementByUsage(0).offset/4,l=Number.MAX_VALUE,h=-1,u=-1,_=-1,c=0;c<r.length;c+=3){var d=t._tempVector35,f=d.elements,m=r[c]*s,p=m+o;f[0]=i[p],f[1]=i[p+1],f[2]=i[p+2];var v=t._tempVector36,g=v.elements,E=r[c+1]*s,x=E+o;g[0]=i[x],g[1]=i[x+1],g[2]=i[x+2];var T=t._tempVector37,S=T.elements,D=r[c+2]*s,M=D+o;S[0]=i[M],S[1]=i[M+1],S[2]=i[M+2];var y=laya.d3.utils.Picker.rayIntersectsTriangle(e,d,v,T);!isNaN(y)&&y<l&&(l=y,h=m,u=E,_=D)}if(l!==Number.MAX_VALUE){a.distance=l,Pe.scale(e.direction,l,a.position),Pe.add(e.origin,a.position,a.position);var A=a.trianglePositions,I=A[0],R=A[1],C=A[2],b=I.elements,w=R.elements,N=C.elements,P=h+o;b[0]=i[P],b[1]=i[P+1],b[2]=i[P+2];var L=u+o;w[0]=i[L],w[1]=i[L+1],w[2]=i[L+2];var O=_+o;N[0]=i[O],N[1]=i[O+1],N[2]=i[O+2];var V=n.getVertexElementByUsage(3);if(V){var F=V.offset/4,B=a.triangleNormals,U=B[0],H=B[1],G=B[2],z=U.elements,k=H.elements,W=G.elements,X=h+F;z[0]=i[X],z[1]=i[X+1],z[2]=i[X+2];var Y=u+F;k[0]=i[Y],k[1]=i[Y+1],k[2]=i[Y+2];var Z=_+F;W[0]=i[Z],W[1]=i[Z+1],W[2]=i[Z+2]}return!0}return a.position.toDefault(),a.distance=Number.MAX_VALUE,a.trianglePositions[0].toDefault(),a.trianglePositions[1].toDefault(),a.trianglePositions[2].toDefault(),a.triangleNormals[0].toDefault(),a.triangleNormals[1].toDefault(),a.triangleNormals[2].toDefault(),!1},t.rayIntersectsTriangle=function(e,i,n,r){var a=t._tempVector30,s=t._tempVector31;Pe.subtract(n,i,a),Pe.subtract(r,i,s);var o=t._tempVector32;Pe.cross(e.direction,s,o);var l;if((l=Pe.dot(a,o))>-Number.MIN_VALUE&&l<Number.MIN_VALUE)return Number.NaN;var h=1/l,u=t._tempVector33;Pe.subtract(e.origin,i,u);var _;if(_=Pe.dot(u,o),(_*=h)<0||_>1)return Number.NaN;var c=t._tempVector34;Pe.cross(u,a,c);var d;if(d=Pe.dot(e.direction,c),(d*=h)<0||_+d>1)return Number.NaN;var f;return f=Pe.dot(s,c),(f*=h)<0?Number.NaN:f},n(t,["_tempVector30",function(){return this._tempVector30=new Pe},"_tempVector31",function(){return this._tempVector31=new Pe},"_tempVector32",function(){return this._tempVector32=new Pe},"_tempVector33",function(){return this._tempVector33=new Pe},"_tempVector34",function(){return this._tempVector34=new Pe},"_tempVector35",function(){return this._tempVector35=new Pe},"_tempVector36",function(){return this._tempVector36=new Pe},"_tempVector37",function(){return this._tempVector37=new Pe}]),t}(),Ke=function(){function t(){this.distance=NaN,this.trianglePositions=null,this.triangleNormals=null,this.position=null,this.sprite3D=null,this.distance=-1,this.trianglePositions=[new Pe,new Pe,new Pe],this.trianglePositions.length=3,this.triangleNormals=[new Pe,new Pe,new Pe],this.triangleNormals.length=3,this.position=new Pe}return r(t,"laya.d3.utils.RaycastHit"),t.prototype.cloneTo=function(t){t.distance=this.distance,this.trianglePositions[0].cloneTo(t.trianglePositions[0]),this.trianglePositions[1].cloneTo(t.trianglePositions[1]),this.trianglePositions[2].cloneTo(t.trianglePositions[2]),this.triangleNormals[0].cloneTo(t.triangleNormals[0]),this.triangleNormals[1].cloneTo(t.triangleNormals[1]),this.triangleNormals[2].cloneTo(t.triangleNormals[2]),this.position.cloneTo(t.position),t.sprite3D=this.sprite3D},t}(),je=function(){function t(t,e){this._width=0,this._height=0,this._width=t,this._height=e}r(t,"laya.d3.utils.Size");var e=t.prototype;return a(0,e,"width",function(){return-1===this._width?ct.clientWidth:this._width}),a(0,e,"height",function(){return-1===this._height?ct.clientHeight:this._height}),a(1,t,"fullScreen",function(){return new t(-1,-1)}),t}(),qe=function(){function t(){}return r(t,"laya.d3.utils.Utils3D"),t._rotationTransformScaleSkinAnimation=function(e,i,n,r,a,s,o,l,h,u,_,c){var d=t._tempArray16_0,f=t._tempArray16_1,m=t._tempArray16_2,p=r+r,v=a+a,g=s+s,E=r*p,x=a*p,T=a*v,S=s*p,D=s*v,M=s*g,y=o*p,A=o*v,I=o*g;d[15]=1,d[0]=1-T-M,d[1]=x+I,d[2]=S-A,d[4]=x-I,d[5]=1-E-M,d[6]=D+y,d[8]=S+A,d[9]=D-y,d[10]=1-E-T,f[15]=1,f[0]=l,f[5]=h,f[10]=u;var R,C,b,w,N;for(R=0;R<4;R++)C=d[R],b=d[R+4],w=d[R+8],N=d[R+12],m[R]=C,m[R+4]=b,m[R+8]=w,m[R+12]=C*e+b*i+w*n+N;for(R=0;R<4;R++)C=m[R],b=m[R+4],w=m[R+8],N=m[R+12],_[R+c]=C*f[0]+b*f[1]+w*f[2]+N*f[3],_[R+c+4]=C*f[4]+b*f[5]+w*f[6]+N*f[7],_[R+c+8]=C*f[8]+b*f[9]+w*f[10]+N*f[11],_[R+c+12]=C*f[12]+b*f[13]+w*f[14]+N*f[15]},t._createNodeByJson=function(e,i,n,r){if(!n)switch(i.type){case"Sprite3D":n=new Vi;break;case"MeshSprite3D":n=new vn;break;case"SkinnedMeshSprite3D":n=new En;break;case"ShuriKenParticle3D":n=new gn;break;case"TrailSprite3D":n=new xn;break;case"Terrain":n=new fn;break;case"Camera":n=new mn;break;case"DirectionLight":n=new pn;break;default:throw new Error("Utils3D:unidentified class type in (.lh) file.")}var a=i.props;if(a)for(var s in a)n[s]=a[s];var o=i.customProps;o&&(n instanceof laya.d3.core.Sprite3D?(n._parseBaseCustomProps(o),n._parseCustomProps(e,r,o,i),n._parseCustomComponent(e,r,i.components)):n._parseCustomProps(e,r,o,i));var l=i.child;if(l)for(var h=0,u=l.length;h<u;h++){var _=t._createNodeByJson(e,l[h],null,r);n.addChild(_)}return n},t._computeBoneAndAnimationDatasByBindPoseMatrxix=function(t,e,i,n,r,a){var s,o,l=0,h=0,u=t.length;for(s=0;s<u;l+=t[s].keyframeWidth,h+=16,s++)laya.d3.utils.Utils3D._rotationTransformScaleSkinAnimation(e[l+0],e[l+1],e[l+2],e[l+3],e[l+4],e[l+5],e[l+6],e[l+7],e[l+8],e[l+9],n,h),0!=s&&(o=16*t[s].parentIndex,laya.d3.utils.Utils3D.mulMatrixByArray(n,o,n,h,n,h));var _=i.length;for(s=0;s<_;s++)laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(n,16*a[s],i[s],r,16*s)},t._computeAnimationDatasByArrayAndMatrixFast=function(t,e,i,n){for(var r=0,a=t.length;r<a;r++)laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(e,16*n[r],t[r],i,16*r)},t._computeBoneAndAnimationDatasByBindPoseMatrxixOld=function(t,e,i,n,r){var a,s,o=0,l=0,h=t.length;for(a=0;a<h;o+=t[a].keyframeWidth,l+=16,a++)laya.d3.utils.Utils3D._rotationTransformScaleSkinAnimation(e[o+7],e[o+8],e[o+9],e[o+3],e[o+4],e[o+5],e[o+6],e[o+0],e[o+1],e[o+2],n,l),0!=a&&(s=16*t[a].parentIndex,laya.d3.utils.Utils3D.mulMatrixByArray(n,s,n,l,n,l));var u=i.length;for(a=0;a<u;a++){var _=16*a;laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(n,_,i[a],r,_)}},t._computeAnimationDatasByArrayAndMatrixFastOld=function(t,e,i){for(var n=t.length,r=0;r<n;r++){var a=16*r;laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(e,a,t[r],i,a)}},t._computeRootAnimationData=function(t,e,i){for(var n=0,r=0,a=0,s=t.length;n<s;r+=t[n].keyframeWidth,a+=16,n++)laya.d3.utils.Utils3D.createAffineTransformationArray(e[r+0],e[r+1],e[r+2],e[r+3],e[r+4],e[r+5],e[r+6],e[r+7],e[r+8],e[r+9],i,a)},t.transformVector3ArrayByQuat=function(t,e,i,n,r){var a=i.elements,s=t[e],o=t[e+1],l=t[e+2],h=a[0],u=a[1],_=a[2],c=a[3],d=c*s+u*l-_*o,f=c*o+_*s-h*l,m=c*l+h*o-u*s,p=-h*s-u*o-_*l;n[r]=d*c+p*-h+f*-_-m*-u,n[r+1]=f*c+p*-u+m*-h-d*-_,n[r+2]=m*c+p*-_+d*-u-f*-h},t.mulMatrixByArray=function(e,i,n,r,a,s){var o,l,h,u,_;if(a===n){for(n=t._tempArray16_3,o=0;o<16;++o)n[o]=a[s+o];r=0}for(o=0;o<4;o++)l=e[i+o],h=e[i+o+4],u=e[i+o+8],_=e[i+o+12],a[s+o]=l*n[r+0]+h*n[r+1]+u*n[r+2]+_*n[r+3],a[s+o+4]=l*n[r+4]+h*n[r+5]+u*n[r+6]+_*n[r+7],a[s+o+8]=l*n[r+8]+h*n[r+9]+u*n[r+10]+_*n[r+11],a[s+o+12]=l*n[r+12]+h*n[r+13]+u*n[r+14]+_*n[r+15]},t.mulMatrixByArrayFast=function(t,e,i,n,r,a){var s,o,l,h,u;for(s=0;s<4;s++)o=t[e+s],l=t[e+s+4],h=t[e+s+8],u=t[e+s+12],r[a+s]=o*i[n+0]+l*i[n+1]+h*i[n+2]+u*i[n+3],r[a+s+4]=o*i[n+4]+l*i[n+5]+h*i[n+6]+u*i[n+7],r[a+s+8]=o*i[n+8]+l*i[n+9]+h*i[n+10]+u*i[n+11],r[a+s+12]=o*i[n+12]+l*i[n+13]+h*i[n+14]+u*i[n+15]},t.mulMatrixByArrayAndMatrixFast=function(t,e,i,n,r){var a,s,o,l,h,u=i.elements,_=u[0],c=u[1],d=u[2],f=u[3],m=u[4],p=u[5],v=u[6],g=u[7],E=u[8],x=u[9],T=u[10],S=u[11],D=u[12],M=u[13],y=u[14],A=u[15],I=e,R=e+4,C=e+8,b=e+12,w=r,N=r+4,P=r+8,L=r+12;for(a=0;a<4;a++)s=t[I+a],o=t[R+a],l=t[C+a],h=t[b+a],n[w+a]=s*_+o*c+l*d+h*f,n[N+a]=s*m+o*p+l*v+h*g,n[P+a]=s*E+o*x+l*T+h*S,n[L+a]=s*D+o*M+l*y+h*A},t.createAffineTransformationArray=function(t,e,i,n,r,a,s,o,l,h,u,_){var c=n+n,d=r+r,f=a+a,m=n*c,p=n*d,v=n*f,g=r*d,E=r*f,x=a*f,T=s*c,S=s*d,D=s*f;u[_+0]=(1-(g+x))*o,u[_+1]=(p+D)*o,u[_+2]=(v-S)*o,u[_+3]=0,u[_+4]=(p-D)*l,u[_+5]=(1-(m+x))*l,u[_+6]=(E+T)*l,u[_+7]=0,u[_+8]=(v+S)*h,u[_+9]=(E-T)*h,u[_+10]=(1-(m+g))*h,u[_+11]=0,u[_+12]=t,u[_+13]=e,u[_+14]=i,u[_+15]=1},t.transformVector3ArrayToVector3ArrayCoordinate=function(e,i,n,r,a){var s=t._tempArray4_0,o=e[i+0],l=e[i+1],h=e[i+2],u=n.elements;s[0]=o*u[0]+l*u[4]+h*u[8]+u[12],s[1]=o*u[1]+l*u[5]+h*u[9]+u[13],s[2]=o*u[2]+l*u[6]+h*u[10]+u[14],s[3]=1/(o*u[3]+l*u[7]+h*u[11]+u[15]),r[a+0]=s[0]*s[3],r[a+1]=s[1]*s[3],r[a+2]=s[2]*s[3]},t.transformLightingMapTexcoordByUV0Array=function(t,e,i,n,r){var a=i.elements;n[r+0]=t[e+0]*a[0]+a[2],n[r+1]=(t[e+1]-1)*a[1]+a[3]},t.transformLightingMapTexcoordByUV1Array=function(t,e,i,n,r){var a=i.elements;n[r+0]=t[e+0]*a[0]+a[2],n[r+1]=1+t[e+1]*a[1]+a[3]},t.getURLVerion=function(t){var e=t.indexOf("?");return e>=0?t.substr(e):null},t._quaternionCreateFromYawPitchRollArray=function(t,e,i,n){var r=.5*i,a=.5*e,s=.5*t,o=Math.sin(r),l=Math.cos(r),h=Math.sin(a),u=Math.cos(a),_=Math.sin(s),c=Math.cos(s);n[0]=c*h*l+_*u*o,n[1]=_*u*l-c*h*o,n[2]=c*u*o-_*h*l,n[3]=c*u*l+_*h*o},t._createAffineTransformationArray=function(t,e,i,n){var r=e[0],a=e[1],s=e[2],o=e[3],l=r+r,h=a+a,u=s+s,_=r*l,c=r*h,d=r*u,f=a*h,m=a*u,p=s*u,v=o*l,g=o*h,E=o*u,x=i[0],T=i[1],S=i[2];n[0]=(1-(f+p))*x,n[1]=(c+E)*x,n[2]=(d-g)*x,n[3]=0,n[4]=(c-E)*T,n[5]=(1-(_+p))*T,n[6]=(m+v)*T,n[7]=0,n[8]=(d+g)*S,n[9]=(m-v)*S,n[10]=(1-(_+f))*S,n[11]=0,n[12]=t[0],n[13]=t[1],n[14]=t[2],n[15]=1},t._mulMatrixArray=function(t,e,i,n){var r,a,s,o,l,h=e.elements,u=h[0],_=h[1],c=h[2],d=h[3],f=h[4],m=h[5],p=h[6],v=h[7],g=h[8],E=h[9],x=h[10],T=h[11],S=h[12],D=h[13],M=h[14],y=h[15],A=n,I=n+4,R=n+8,C=n+12;for(r=0;r<4;r++)a=t[r],s=t[r+4],o=t[r+8],l=t[r+12],i[A+r]=a*u+s*_+o*c+l*d,i[I+r]=a*f+s*m+o*p+l*v,i[R+r]=a*g+s*E+o*x+l*T,i[C+r]=a*S+s*D+o*M+l*y},t.getYawPitchRoll=function(e,i){t.transformQuat(Pe.ForwardRH,e,Ce.TEMPVector31),t.transformQuat(Pe.Up,e,Ce.TEMPVector32);var n=Ce.TEMPVector32.elements;t.angleTo(Pe.ZERO,Ce.TEMPVector31,Ce.TEMPVector33);var r=Ce.TEMPVector33.elements;r[0]==Math.PI/2?(r[1]=t.arcTanAngle(n[2],n[0]),r[2]=0):r[0]==-Math.PI/2?(r[1]=t.arcTanAngle(-n[2],-n[0]),r[2]=0):(Ae.createRotationY(-r[1],Ce.TEMPMatrix0),Ae.createRotationX(-r[0],Ce.TEMPMatrix1),Pe.transformCoordinate(Ce.TEMPVector32,Ce.TEMPMatrix0,Ce.TEMPVector32),Pe.transformCoordinate(Ce.TEMPVector32,Ce.TEMPMatrix1,Ce.TEMPVector32),r[2]=t.arcTanAngle(n[1],-n[0])),r[1]<=-Math.PI&&(r[1]=Math.PI),r[2]<=-Math.PI&&(r[2]=Math.PI),r[1]>=Math.PI&&r[2]>=Math.PI&&(r[1]=0,r[2]=0,r[0]=Math.PI-r[0]),i[0]=r[1],i[1]=r[0],i[2]=r[2]},t.arcTanAngle=function(t,e){return 0==t?1==e?Math.PI/2:-Math.PI/2:t>0?Math.atan(e/t):t<0?e>0?Math.atan(e/t)+Math.PI:Math.atan(e/t)-Math.PI:0},t.angleTo=function(e,i,n){Pe.subtract(i,e,Ce.TEMPVector30),Pe.normalize(Ce.TEMPVector30,Ce.TEMPVector30),n.elements[0]=Math.asin(Ce.TEMPVector30.y),n.elements[1]=t.arcTanAngle(-Ce.TEMPVector30.z,-Ce.TEMPVector30.x)},t.transformQuat=function(t,e,i){var n=i.elements,r=t.elements,a=e,s=r[0],o=r[1],l=r[2],h=a[0],u=a[1],_=a[2],c=a[3],d=c*s+u*l-_*o,f=c*o+_*s-h*l,m=c*l+h*o-u*s,p=-h*s-u*o-_*l;n[0]=d*c+p*-h+f*-_-m*-u,n[1]=f*c+p*-u+m*-h-d*-_,n[2]=m*c+p*-_+d*-u-f*-h},t.quaterionNormalize=function(t,e){var i=t[0],n=t[1],r=t[2],a=t[3],s=i*i+n*n+r*r+a*a;s>0&&(s=1/Math.sqrt(s),e[0]=i*s,e[1]=n*s,e[2]=r*s,e[3]=a*s)},t.matrix4x4MultiplyFFF=function(t,e,i){var n,r,a,s,o;if(i===e)for(e=new Float32Array(16),n=0;n<16;++n)e[n]=i[n];for(n=0;n<4;n++)r=t[n],a=t[n+4],s=t[n+8],o=t[n+12],i[n]=r*e[0]+a*e[1]+s*e[2]+o*e[3],i[n+4]=r*e[4]+a*e[5]+s*e[6]+o*e[7],i[n+8]=r*e[8]+a*e[9]+s*e[10]+o*e[11],i[n+12]=r*e[12]+a*e[13]+s*e[14]+o*e[15]},t.matrix4x4MultiplyMFM=function(e,i,n){t.matrix4x4MultiplyFFF(e.elements,i,n.elements)},n(t,["_typeToFunO",function(){return this._typeToFunO={INT16:"writeInt16",SHORT:"writeInt16",UINT16:"writeUint16",UINT32:"writeUint32",FLOAT32:"writeFloat32",INT:"writeInt32",UINT:"writeUint32",BYTE:"writeByte",STRING:"writeUTFString"}},"_tempVector3_0",function(){return this._tempVector3_0=new Pe},"_tempVector3_1",function(){return this._tempVector3_1=new Pe},"_tempVector3_2",function(){return this._tempVector3_2=new Pe},"_tempVector3_3",function(){return this._tempVector3_3=new Pe},"_tempVector3_4",function(){return this._tempVector3_4=new Pe},"_tempVector3_5",function(){return this._tempVector3_5=new Pe},"_tempVector3_6",function(){return this._tempVector3_6=new Pe},"_tempArray4_0",function(){return this._tempArray4_0=new Float32Array(4)},"_tempArray16_0",function(){return this._tempArray16_0=new Float32Array(16)},"_tempArray16_1",function(){return this._tempArray16_1=new Float32Array(16)},"_tempArray16_2",function(){return this._tempArray16_2=new Float32Array(16)},"_tempArray16_3",function(){return this._tempArray16_3=new Float32Array(16)}]),t}(),Qe=function(){function t(){}return r(t,"Laya3D"),t._changeWebGLSize=function(t,e){P.onStageResize(t,e),ct.clientWidth=t,ct.clientHeight=e},t.__init__=function(){var e=x.createMap;e.lh=[Vi,"SPRITE3DHIERARCHY"],e.ls=[Oi,"SPRITE3DHIERARCHY"],e.lm=[rn,"MESH"],e.lmat=[Wi,"MATERIAL"],e.lpbr=[Gi,"MATERIAL"],e.ltc=[hn,"TEXTURECUBE"],e.jpg=[ln,"nativeimage"],e.jpeg=[ln,"nativeimage"],e.png=[ln,"nativeimage"],e.pkm=[ln,"arraybuffer"],e.lsani=[l,"arraybuffer"],e.lrani=[l,"arraybuffer"],e.raw=[en,"arraybuffer"],e.mipmaps=[en,"arraybuffer"],e.thdata=[Ei,"arraybuffer"],e.lt=[xi,"TERRAIN"],e.lani=[fi,"arraybuffer"],e.lav=[mi,"json"],e.ani=[l,"arraybuffer"],E.parserMap.SPRITE3DHIERARCHY=t._loadHierarchy,E.parserMap.MESH=t._loadMesh,E.parserMap.MATERIAL=t._loadMaterial,E.parserMap.TEXTURECUBE=t._loadTextureCube,E.parserMap.TERRAIN=t._loadTerrain,t._innerFirstLevelLoaderManager.on("error",null,t._eventLoadManagerError),t._innerSecondLevelLoaderManager.on("error",null,t._eventLoadManagerError),t._innerThirdLevelLoaderManager.on("error",null,t._eventLoadManagerError),t._innerFourthLevelLoaderManager.on("error",null,t._eventLoadManagerError)},t.READ_BLOCK=function(){return t._readData.pos+=4,!0},t.READ_DATA=function(){return t._DATA.offset=t._readData.getUint32(),t._DATA.size=t._readData.getUint32(),!0},t.READ_STRINGS=function(){var e=[],i={offset:0,size:0};i.offset=t._readData.getUint16(),i.size=t._readData.getUint16();t._readData.pos;t._readData.pos=i.offset+t._DATA.offset;for(var n=0;n<i.size;n++){var r=t._readData.readUTFString();-1===r.lastIndexOf(".lmat")&&-1===r.lastIndexOf(".lpbr")||e.push(r)}return e},t._eventLoadManagerError=function(t){i.loader.event("error",t)},t._addHierarchyInnerUrls=function(t,e,i,n,r,a){var s=w.formatURL(r,n);i&&(s+=i),t.push({url:s,clas:a}),e[r]=s},t._getSprite3DHierarchyInnerUrls=function(e,i,n,r,a,s,o){var l,h=0,u=0;switch(e.type){case"Scene":var _=e.customProps.lightmaps;for(h=0,u=_.length;h<u;h++){var d=_[h].replace("exr","png");t._addHierarchyInnerUrls(r,a,s,o,d,ln)}break;case"MeshSprite3D":case"TrailSprite3D":case"SkinnedMeshSprite3D":var f;if(e.instanceParams)(f=e.instanceParams.loadPath)&&t._addHierarchyInnerUrls(i,a,s,o,f,rn);else{l=e.customProps,f=l.meshPath,f&&t._addHierarchyInnerUrls(i,a,s,o,f,rn);var m=l.materials;if(m)for(h=0,u=m.length;h<u;h++){var p=m[h],v=p.type.split("."),g=c.window;if(v.forEach(function(t){g=g[t]}),"function"!=typeof g)throw"_getSprite3DHierarchyInnerUrls 错误: "+p.type+" 不是类";t._addHierarchyInnerUrls(n,a,s,o,p.path,g)}}break;case"ShuriKenParticle3D":l=e.customProps;var E=l.meshPath;E&&t._addHierarchyInnerUrls(i,a,s,o,E,rn);var x=l.material;if(x)t._addHierarchyInnerUrls(n,a,s,o,x.path,ji);else{var T=l.materialPath;if(T)t._addHierarchyInnerUrls(n,a,s,o,T,ji);else{var S=l.texturePath;S&&t._addHierarchyInnerUrls(r,a,s,o,S,ln)}}break;case"Terrain":t._addHierarchyInnerUrls(r,a,s,o,e.customProps.dataPath,xi)}var D=e.components;for(var M in D){var y=D[M];switch(M){case"Animator":var A=y.avatarPath;if(A)t._addHierarchyInnerUrls(r,a,s,o,A,mi);else{var I=y.avatar;I&&t._addHierarchyInnerUrls(r,a,s,o,I.path,mi)}var R=y.clipPaths;for(h=0,u=R.length;h<u;h++)t._addHierarchyInnerUrls(r,a,s,o,R[h],fi)}}var C=e.child;for(h=0,u=C.length;h<u;h++)t._getSprite3DHierarchyInnerUrls(C[h],i,n,r,a,s,o)},t._loadHierarchy=function(e){e.on("loaded",null,t._onHierarchylhLoaded,[e,e._class._getGroup()]),e.load(e.url,"json",!1,null,!0)},t._onHierarchylhLoaded=function(e,i,n){if(e._class.destroyed)e.endLoad();else{var r=e.url,a=qe.getURLVerion(r),s=w.getPath(w.formatURL(r)),o=[],l=[],h=[],u={};t._getSprite3DHierarchyInnerUrls(n,o,l,h,u,a,s);var _=o.length+l.length+h.length,c=_+1,d=1/c;if(t._onProcessChange(e,0,d,1),h.length>0){var f=_/c,m=g.create(null,t._onProcessChange,[e,d,f],!1);t._innerFourthLevelLoaderManager.create(h,g.create(null,t._onHierarchyInnerForthLevResouLoaded,[e,i,m,n,u,o,l,d+f*h.length,f]),m,null,null,1,!0,i)}else t._onHierarchyInnerForthLevResouLoaded(e,i,null,n,u,o,l,d,f)}},t._onHierarchyInnerForthLevResouLoaded=function(e,i,n,r,a,s,o,l,h){if(e._class.destroyed)e.endLoad();else if(n&&n.recover(),o.length>0){var u=g.create(null,t._onProcessChange,[e,l,h],!1);t._innerSecondLevelLoaderManager.create(o,g.create(null,t._onHierarchyInnerSecondLevResouLoaded,[e,i,u,r,a,s,l+h*o.length,h]),n,null,null,1,!0,i)}else t._onHierarchyInnerSecondLevResouLoaded(e,i,null,r,a,s,l,h)},t._onHierarchyInnerSecondLevResouLoaded=function(e,i,n,r,a,s,o,l){if(e._class.destroyed)e.endLoad();else if(n&&n.recover(),s.length>0){var h=g.create(null,t._onProcessChange,[e,o,l],!1);t._innerFirstLevelLoaderManager.create(s,g.create(null,t._onHierarchyInnerFirstLevResouLoaded,[e,h,r,a]),n,null,null,1,!0,i)}else t._onHierarchyInnerFirstLevResouLoaded(e,null,r,a)},t._onHierarchyInnerFirstLevResouLoaded=function(t,e,i,n){e&&e.recover(),t.endLoad([i,n])},t._loadTerrain=function(e){e.on("loaded",null,t._onTerrainLtLoaded,[e,e._class._getGroup()]),e.load(e.url,"json",!1,null,!0)},t._onTerrainLtLoaded=function(e,i,n){if(e._class.destroyed)e.endLoad();else{var r,a,s=e.url,o=qe.getURLVerion(s),l=w.getPath(w.formatURL(s)),h=[],u={},_=0,c=0,d=n.heightData;r=d.url,a=w.formatURL(r,l),o&&(a+=o),u[r]=a,r=a;var f=n.detailTexture;for(_=0,c=f.length;_<c;_++)h.push({url:f[_].diffuse});var m=n.normalMap;for(_=0,c=m.length;_<c;_++)h.push({url:m[_]});var p=n.alphaMap;for(_=0,c=p.length;_<c;_++)h.push({url:p[_],params:[!1,!1,6408,!0]});for(_=0,c=h.length;_<c;_++){var v=h[_].url;a=w.formatURL(v,l),o&&(a+=o),h[_].url=a,u[v]=a}var E=h.length,x=E+2,T=1/x;t._onProcessChange(e,0,T,1);var S={heightMapLoaded:!1,texturesLoaded:!1},D=g.create(null,t._onProcessChange,[e,T,T],!1);t._innerFourthLevelLoaderManager.create(r,g.create(null,t._onTerrainHeightMapLoaded,[e,D,n,u,S]),D,null,[d.numX,d.numZ,d.bitType,d.value],1,!0,i);var M=g.create(null,t._onProcessChange,[e,2*T,E/x],!1);t._innerFourthLevelLoaderManager.create(h,g.create(null,t._onTerrainTexturesLoaded,[e,M,n,u,S]),M,null,null,1,!0,i)}},t._onTerrainHeightMapLoaded=function(t,e,i,n,r){r.heightMapLoaded=!0,r.texturesLoaded&&(t.endLoad([i,n]),e.recover())},t._onTerrainTexturesLoaded=function(t,e,i,n,r){r.texturesLoaded=!0,r.heightMapLoaded&&(t.endLoad([i,n]),e.recover())},t._loadMesh=function(e){e.on("loaded",null,t._onMeshLmLoaded,[e,e._class._getGroup()]),e.load(e.url,"arraybuffer",!1,null,!0)},t._onMeshLmLoaded=function(e,i,n){if(e._class.destroyed)e.endLoad();else{var r,a,s=e.url,o=qe.getURLVerion(s),l=w.getPath(w.formatURL(s)),h={},u=0,_=0,c=0;t._readData=new f(n),t._readData.pos=0;switch(t._readData.readUTFString()){case"LAYAMODEL:02":case"LAYAMODEL:03":case"LAYAMODEL:0301":var d=t._readData.getUint32();t._readData.pos=t._readData.pos+4,c=t._readData.getUint16(),t._readData.pos=t._readData.pos+8*c;var m=t._readData.getUint32();for(c=t._readData.getUint16(),t._readData.pos=d+m,r=[],u=0;u<c;u++){var p=t._readData.readUTFString();-1!==p.lastIndexOf(".lmat")&&r.push(p)}break;default:for(t.READ_BLOCK(),u=0;u<2;u++){var v=t._readData.getUint16(),E=t._strings[v],x=t["READ_"+E];if(null==x)throw new Error("model file err,no this function:"+v+" "+E);1===u?r=x.call():x.call()}}for(u=0,_=r.length;u<_;u++){var T=r[u];a=w.formatURL(T,l),o&&(a+=o),r[u]=a,h[T]=a}if(r.length>0){t._onProcessChange(e,0,.5,1);var S=g.create(null,t._onProcessChange,[e,.5,.5],!1);t._innerSecondLevelLoaderManager.create(r,g.create(null,t._onMeshMateialLoaded,[e,S,n,h]),S,null,null,1,!0,i)}else e.endLoad([n,h])}},t._onMeshMateialLoaded=function(t,e,i,n){t.endLoad([i,n]),e.recover()},t._getMaterialTexturePath=function(t,e,i){var n=t.length-4;return t.indexOf(".dds")!=n&&t.indexOf(".tga")!=n&&t.indexOf(".exr")!=n&&t.indexOf(".DDS")!=n&&t.indexOf(".TGA")!=n&&t.indexOf(".EXR")!=n||(t=t.substr(0,n)+".png"),t=w.formatURL(t,i),e&&(t+=e),t},t._loadMaterial=function(e){e.on("loaded",null,t._onMaterilLmatLoaded,[e,e._class._getGroup()]),e.load(e.url,"json",!1,null,!0)},t._onMaterilLmatLoaded=function(e,i,n){if(e._class.destroyed)e.endLoad();else{var r,a=e.url,s=qe.getURLVerion(a),o=w.getPath(w.formatURL(a)),l=[],h={},u=n.customProps,_=n.version;if(_)switch(_){case"LAYAMATERIAL:01":for(var c=n.props.textures,d=0,f=c.length;d<f;d++){var m=c[d],p=m.path;if(p){var v=p.length-4;p.indexOf(".exr")!=v&&p.indexOf(".EXR")!=v||(p=p.substr(0,v)+".png"),r=w.formatURL(p,o),s&&(r+=s),l.push({url:r,params:m.params}),h[p]=r}}break;default:throw new Error("Laya3D:unkonwn version.")}else{var E=u.diffuseTexture.texture2D;if(E&&(r=t._getMaterialTexturePath(E,s,o),l.push(r),h[E]=r),u.normalTexture){var x=u.normalTexture.texture2D;x&&(r=t._getMaterialTexturePath(x,s,o),l.push(r),h[x]=r)}if(u.specularTexture){var T=u.specularTexture.texture2D;T&&(r=t._getMaterialTexturePath(T,s,o),l.push(r),h[T]=r)}if(u.emissiveTexture){var S=u.emissiveTexture.texture2D;S&&(r=t._getMaterialTexturePath(S,s,o),l.push(r),h[S]=r)}if(u.ambientTexture){var D=u.ambientTexture.texture2D;D&&(r=t._getMaterialTexturePath(D,s,o),l.push(r),h[D]=r)}if(u.reflectTexture){var M=u.reflectTexture.texture2D;M&&(r=t._getMaterialTexturePath(M,s,o),l.push(r),h[M]=r)}}var y=l.length,A=y+1,I=1/A;if(t._onProcessChange(e,0,I,1),y>0){var R=g.create(null,t._onProcessChange,[e,I,y/A],!1);t._innerFourthLevelLoaderManager.create(l,g.create(null,t._onMateialTexturesLoaded,[e,R,n,h]),R,ln,null,1,!0,i)}else t._onMateialTexturesLoaded(e,null,n,null)}},t._onMateialTexturesLoaded=function(t,e,i,n){t.endLoad([i,n]),e&&e.recover()},t._loadTextureCube=function(e){e.on("loaded",null,t._onTextureCubeLtcLoaded,[e]),e.load(e.url,"json",!1,null,!0)},t._onTextureCubeLtcLoaded=function(e,i){if(e._class.destroyed)e.endLoad();else{var n=w.getPath(w.formatURL(e.url)),r=[w.formatURL(i.px,n),w.formatURL(i.nx,n),w.formatURL(i.py,n),w.formatURL(i.ny,n),w.formatURL(i.pz,n),w.formatURL(i.nz,n)];t._onProcessChange(e,0,1/7,1);var a=g.create(null,t._onProcessChange,[e,1/7,6/7],!1);t._innerFourthLevelLoaderManager.load(r,g.create(null,t._onTextureCubeImagesLoaded,[e,r,a]),a,"nativeimage")}},t._onTextureCubeImagesLoaded=function(t,e,i){var n=[];n.length=6;for(var r=0;r<6;r++){var a=e[r];n[r]=E.getRes(a),E.clearRes(a)}t.endLoad(n),i.recover()},t._onProcessChange=function(t,e,i,n){(n=e+n*i)<1&&t.event("progress",n)},t.init=function(e,n,r,a,s,o){if(void 0===r&&(r=!1),void 0===a&&(a=!1),void 0===s&&(s=!0),void 0===o&&(o=!0),A.update3DLoop=function(){ni._triggerCollision()},p.isAntialias=r,p.isAlpha=a,p.premultipliedAlpha=s,p.isStencil=o,!D.isConchNode&&!P.enable())return void alert("Laya3D init error,must support webGL!");A.changeWebGLSize=t._changeWebGLSize,D.is3DMode=!0,i.init(e,n),k.__init__(),Ye.__init__(),Ue.__init__(),vn.__init__(),B.__init__(),t.__init__(),u.maxTextureCount=2,(t.debugMode||dt.debugMode)&&(t._debugPhasorSprite=new ht)},t.HIERARCHY="SPRITE3DHIERARCHY",t.MESH="MESH",t.MATERIAL="MATERIAL",t.PBRMATERIAL="PBRMTL",t.TEXTURECUBE="TEXTURECUBE",t.TERRAIN="TERRAIN",t._readData=null,t._debugPhasorSprite=null,t.debugMode=!1,n(t,["_DATA",function(){return this._DATA={offset:0,size:0}},"_strings",function(){return this._strings=["BLOCK","DATA","STRINGS"]},"_innerFirstLevelLoaderManager",function(){return this._innerFirstLevelLoaderManager=new x},"_innerSecondLevelLoaderManager",function(){return this._innerSecondLevelLoaderManager=new x},"_innerThirdLevelLoaderManager",function(){return this._innerThirdLevelLoaderManager=new x},"_innerFourthLevelLoaderManager",function(){return this._innerFourthLevelLoaderManager=new x}]),t}(),$e=function(t){function e(t){e.__super.call(this),this._owner=t,this._childs=[],this._localMatrix=new Float32Array(16),this._localQuaternionUpdate=!1,this._locaEulerlUpdate=!1,this._localUpdate=!1,this._worldUpdate=!0}r(e,"laya.d3.animation.AnimationTransform3D",t);var i=e.prototype;return i._getlocalMatrix=function(){return this._localUpdate&&(qe._createAffineTransformationArray(this._localPosition,this._localRotation,this._localScale,this._localMatrix),this._localUpdate=!1),this._localMatrix},i._onWorldTransform=function(){if(!this._worldUpdate){this._worldUpdate=!0;for(var t=0,e=this._childs.length;t<e;t++)this._childs[t]._onWorldTransform()}},i._setWorldMatrixAndUpdate=function(t){if(this._worldMatrix=t,null==this._parent)throw new Error("don't need to set worldMatrix to root Node.");if(null==this._parent._parent)for(var e=this._getlocalMatrix(),i=0;i<16;++i)this._worldMatrix[i]=e[i];else qe.matrix4x4MultiplyFFF(this._parent.getWorldMatrix(),this._getlocalMatrix(),this._worldMatrix);this._worldUpdate=!1},i._setWorldMatrixNoUpdate=function(t){this._worldMatrix=t},i._setWorldMatrixIgnoreUpdate=function(t){this._worldMatrix=t,this._worldUpdate=!1},i.getLocalPosition=function(){return this._localPosition},i.setLocalPosition=function(t){if(this._parent)this._localPosition=t,this._localUpdate=!0,this._onWorldTransform();else{var e=this._entity.owner._transform,i=this._entity.localPosition;t.cloneTo(i),e.localPosition=i}},i.getLocalRotation=function(){if(this._localQuaternionUpdate){var t=this._localRotationEuler;qe._quaternionCreateFromYawPitchRollArray(t[1]/e._angleToRandin,t[0]/e._angleToRandin,t[2]/e._angleToRandin,this._localRotation),this._localQuaternionUpdate=!1}return this._localRotation},i.setLocalRotation=function(t){if(this._parent)this._localRotation=t,qe.quaterionNormalize(this._localRotation,this._localRotation),this._locaEulerlUpdate=!0,this._localQuaternionUpdate=!1,this._localUpdate=!0,this._onWorldTransform();else{var e=this._entity.owner._transform,i=this._entity.localRotation;t.cloneTo(i),e.localRotation=i}},i.getLocalScale=function(){return this._localScale},i.setLocalScale=function(t){if(this._parent)this._localScale=t,this._localUpdate=!0,this._onWorldTransform();else{var e=this._entity.owner._transform,i=this._entity.localScale;t.cloneTo(i),e.localScale=i}},i.getLocalRotationEuler=function(){if(this._locaEulerlUpdate){qe.getYawPitchRoll(this._localRotation,e._tempVector3);var t=e._tempVector3,i=this._localRotationEuler;i[0]=t[1]*e._angleToRandin,i[1]=t[0]*e._angleToRandin,i[2]=t[2]*e._angleToRandin,this._locaEulerlUpdate=!1}return this._localRotationEuler},i.setLocalRotationEuler=function(t){if(this._parent)qe._quaternionCreateFromYawPitchRollArray(t[1]/e._angleToRandin,t[0]/e._angleToRandin,t[2]/e._angleToRandin,this._localRotation),this._localRotationEuler=t,this._locaEulerlUpdate=!1,this._localQuaternionUpdate=!1,this._localUpdate=!0,this._onWorldTransform();else{var i=this._entity.owner._transform,n=this._entity.localRotationEuler,r=n.elements;r[0]=t[0],r[1]=t[1],r[2]=t[2],i.localRotationEuler=n}},i.getWorldMatrix=function(){if(this._worldUpdate){if(null!=this._parent._parent)qe.matrix4x4MultiplyFFF(this._parent.getWorldMatrix(),this._getlocalMatrix(),this._worldMatrix);else for(var t=this._getlocalMatrix(),e=0;e<16;++e)this._worldMatrix[e]=t[e];this._worldUpdate=!1}return this._worldMatrix},i.setParent=function(t){if(this._parent!==t){if(this._parent){var e=this._parent._childs,i=e.indexOf(this);e.splice(i,1)}t&&(t._childs.push(this),t&&this._onWorldTransform()),this._parent=t}},n(e,["_tempVector3",function(){return this._tempVector3=new Float32Array(3)},"_angleToRandin",function(){return this._angleToRandin=180/Math.PI}]),e}(v),Je=function(t){function e(){this._destroyed=!1,this._id=0,this._enable=!1,this._owner=null,this.started=!1,e.__super.call(this),this._destroyed=!1,this._id=e._uniqueIDCounter,e._uniqueIDCounter++}r(e,"laya.d3.component.Component3D",t);var n=e.prototype;return i.imps(n,{"laya.d3.core.render.IUpdate":!0,"laya.resource.IDestroy":!0}),n._initialize=function(t){this._owner=t,this._enable=!0,this.started=!1,this._load(t)},n._destroy=function(){this._unload(this._owner),this._owner=null,this._destroyed=!0},n._load=function(t){},n._start=function(t){},n._update=function(t){},n._lateUpdate=function(t){},n._preRenderUpdate=function(t){},n._postRenderUpdate=function(t){},n._unload=function(t){this.offAll()},n._cloneTo=function(t){},a(0,n,"id",function(){return this._id}),a(0,n,"destroyed",function(){return this._destroyed}),a(0,n,"owner",function(){return this._owner}),a(0,n,"enable",function(){return this._enable},function(t){this._enable!==t&&(this._enable=t,this.event("enablechanged",this._enable))}),a(0,n,"isSingleton",function(){return e._isSingleton}),e._isSingleton=!0,e._uniqueIDCounter=1,e}(v),ti=function(t){function e(){this._destroyed=!1,e.__super.call(this),this._destroyed=!1}r(e,"laya.d3.core.GeometryFilter",t);var n=e.prototype;return i.imps(n,{"laya.resource.IDestroy":!0}),n._destroy=function(){this.offAll(),this._destroyed=!0},a(0,n,"_isAsyncLoaded",function(){return!0}),a(0,n,"_originalBoundingBoxCorners",function(){throw new Error("BaseRender: must override it.")}),a(0,n,"_originalBoundingSphere",function(){throw new Error("BaseRender: must override it.")}),a(0,n,"_originalBoundingBox",function(){throw new Error("BaseRender: must override it.")}),a(0,n,"destroyed",function(){return this._destroyed}),e}(v),ei=function(t){function e(t){e.__super.call(this),this._id=++e._uniqueIDCounter,this._indexInSceneFrustumCullingObjects=-1,this._boundingBox=new xe(new Pe,new Pe),this._boundingBoxCenter=new Pe,this._boundingSphere=new Se(new Pe,0),this._boundingSphereNeedChange=!0,this._boundingBoxNeedChange=!0,this._boundingBoxCenterNeedChange=!0,this._octreeNodeNeedChange=!0,this._materials=[],this._renderElements=[],this._isPartOfStaticBatch=!1,this._destroyed=!1,this._owner=t,this._enable=!0,this._materialsInstance=[],this.lightmapIndex=-1,this.castShadow=!1,this.receiveShadow=!1,this.sortingFudge=0,this._owner.transform.on("worldmatrixneedchanged",this,this._onWorldMatNeedChange)}r(e,"laya.d3.core.render.BaseRender",t);var s=e.prototype;return i.imps(s,{"laya.resource.IDestroy":!0}),s._changeMaterialReference=function(t,e){t&&t._removeReference(),e._addReference()},s._getInstanceMaterial=function(t,e){var i=new t.constructor;return t.cloneTo(i),i.name=i.name+"(Instance)",this._materialsInstance[e]=!0,this._changeMaterialReference(this._materials[e],i),this._materials[e]=i,i},s._setShaderValuelightMap=function(t){this._setShaderValueTexture(3,t)},s._onWorldMatNeedChange=function(){this._boundingSphereNeedChange=!0,this._boundingBoxNeedChange=!0,this._boundingBoxCenterNeedChange=!0,this._octreeNodeNeedChange=!0},s._renderRenderableBoundBox=function(){var t=Qe._debugPhasorSprite,i=this.boundingBox,n=e._tempBoundBoxCorners;i.getCorners(n),t.line(n[0],e._greenColor,n[1],e._greenColor),t.line(n[2],e._greenColor,n[3],e._greenColor),t.line(n[4],e._greenColor,n[5],e._greenColor),t.line(n[6],e._greenColor,n[7],e._greenColor),t.line(n[0],e._greenColor,n[3],e._greenColor),t.line(n[1],e._greenColor,n[2],e._greenColor),t.line(n[2],e._greenColor,n[6],e._greenColor),t.line(n[3],e._greenColor,n[7],e._greenColor),t.line(n[0],e._greenColor,n[4],e._greenColor),t.line(n[1],e._greenColor,n[5],e._greenColor),t.line(n[4],e._greenColor,n[7],e._greenColor),t.line(n[5],e._greenColor,n[6],e._greenColor)},s._calculateBoundingSphere=function(){throw"BaseRender: must override it."},s._calculateBoundingBox=function(){throw"BaseRender: must override it."},s._setShaderValueTexture=function(t,e){this._owner._shaderValues.setValue(t,e)},s._setShaderValueMatrix4x4=function(t,e){this._owner._shaderValues.setValue(t,e?e.elements:null)},s._setShaderValueColor=function(t,e){this._owner._shaderValues.setValue(t,e?e.elements:null)},s._setShaderValueBuffer=function(t,e){this._owner._shaderValues.setValue(t,e)},s._setShaderValueInt=function(t,e){this._owner._shaderValues.setValue(t,e)},s._setShaderValueBool=function(t,e){this._owner._shaderValues.setValue(t,e)},s._setShaderValueNumber=function(t,e){this._owner._shaderValues.setValue(t,e)},s._setShaderValueVector2=function(t,e){this._owner._shaderValues.setValue(t,e?e.elements:null)},s._addShaderDefine=function(t){this._owner._shaderDefineValue|=t},s._removeShaderDefine=function(t){this._owner._shaderDefineValue&=~t},s._renderUpdate=function(t){return!0},s._applyLightMapParams=function(){if(this._lightmapIndex>=0){var t=this._owner.scene;if(t){var e=t.getlightmaps(),i=e[this._lightmapIndex];i?(this._addShaderDefine(cn.SAHDERDEFINE_LIGHTMAP),i.loaded?this._setShaderValuelightMap(i):i.once("loaded",this,this._setShaderValuelightMap)):this._removeShaderDefine(cn.SAHDERDEFINE_LIGHTMAP)}else this._removeShaderDefine(cn.SAHDERDEFINE_LIGHTMAP)}else this._removeShaderDefine(cn.SAHDERDEFINE_LIGHTMAP)},s._updateOctreeNode=function(){var t=this._treeNode;t&&this._octreeNodeNeedChange&&(t.updateObject(this),this._octreeNodeNeedChange=!1)},s._destroy=function(){this.offAll();var t=0,e=0;for(t=0,e=this._renderElements.length;t<e;t++)this._renderElements[t]._destroy();for(t=0,e=this._materials.length;t<e;t++)this._materials[t]._removeReference();this._renderElements=null,this._owner=null,this._materials=null,this._boundingBox=null,this._boundingBoxCenter=null,this._boundingSphere=null,this._lightmapScaleOffset=null,this._destroyed=!0},a(0,s,"boundingSphere",function(){return this._boundingSphereNeedChange&&(this._calculateBoundingSphere(),this._boundingSphereNeedChange=!1),this._boundingSphere}),a(0,s,"id",function(){return this._id}),a(0,s,"material",function(){var t=this._materials[0];if(t&&!this._materialsInstance[0]){var e=this._getInstanceMaterial(t,0);this.event("materialchanged",[this,0,e])}return this._materials[0]},function(t){this.sharedMaterial=t}),a(0,s,"sharedMaterial",function(){return this._materials[0]},function(t){var e=this._materials[0];e!==t&&(this._materials[0]=t,this._materialsInstance[0]=!1,this._changeMaterialReference(e,t),this.event("materialchanged",[this,0,t]))}),a(0,s,"lightmapIndex",function(){return this._lightmapIndex},function(t){this._lightmapIndex=t,this._applyLightMapParams()}),a(0,s,"lightmapScaleOffset",function(){return this._lightmapScaleOffset},function(t){this._lightmapScaleOffset=t,this._setShaderValueColor(2,t),this._addShaderDefine(cn.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV)}),a(0,s,"enable",function(){return this._enable},function(t){this._enable=t,this.event("enablechanged",[this,t])}),a(0,s,"materials",function(){for(var t=0,e=this._materials.length;t<e;t++)if(!this._materialsInstance[t]){var i=this._getInstanceMaterial(this._materials[t],t);this.event("materialchanged",[this,t,i])}return this._materials.slice()},function(t){this.sharedMaterials=t}),a(0,s,"sharedMaterials",function(){return this._materials.slice()},function(t){if(!t)throw new Error("MeshRender: shadredMaterials value can't be null.");var e=t.length;this._materialsInstance.length=e;for(var i=0;i<e;i++){var n=this._materials[i];n!==t[i]&&(this._materialsInstance[i]=!1,this._changeMaterialReference(n,t[i]),this.event("materialchanged",[this,i,t[i]]))}this._materials=t}),a(0,s,"boundingBox",function(){return this._boundingBoxNeedChange&&(this._calculateBoundingBox(),this._boundingBoxNeedChange=!1),this._boundingBox}),a(0,s,"boundingBoxCenter",function(){if(this._boundingBoxCenterNeedChange){var t=this.boundingBox;Pe.add(t.min,t.max,this._boundingBoxCenter),Pe.scale(this._boundingBoxCenter,.5,this._boundingBoxCenter),this._boundingBoxCenterNeedChange=!1}return this._boundingBoxCenter}),a(0,s,"receiveShadow",function(){return this._receiveShadow},function(t){this._receiveShadow!==t&&(this._receiveShadow=t,t?this._addShaderDefine(Ge.SHADERDEFINE_RECEIVE_SHADOW):this._removeShaderDefine(Ge.SHADERDEFINE_RECEIVE_SHADOW))}),a(0,s,"destroyed",function(){return this._destroyed}),e._uniqueIDCounter=0,n(e,["_tempBoundBoxCorners",function(){return this._tempBoundBoxCorners=[new Pe,new Pe,new Pe,new Pe,new Pe,new Pe,new Pe,new Pe]},"_greenColor",function(){return this._greenColor=new Le(0,1,0,1)}]),e}(v),ii=function(t){function e(t){this._owner=null,this._localQuaternionUpdate=!1,this._locaEulerlUpdate=!1,this._localUpdate=!1,this._worldUpdate=!0,this._positionUpdate=!0,this._rotationUpdate=!0,this._scaleUpdate=!0,this._parent=null,this._childs=null,this._dummy=null,this.pivot=null,e.__super.call(this),this._localPosition=new Pe,this._localRotation=new Ce(0,0,0,1),this._localScale=new Pe(1,1,1),this._localRotationEuler=new Pe,this._localMatrix=new Ae,this._position=new Pe,this._rotation=new Ce(0,0,0,1),this._scale=new Pe(1,1,1),this._worldMatrix=new Ae,this._forward=new Pe,this._up=new Pe,this._right=new Pe,this._owner=t,this._childs=[]}r(e,"laya.d3.core.Transform3D",t);var i=e.prototype;return i._updateLocalMatrix=function(){if(!this.pivot||0===this.pivot.x&&0===this.pivot.y&&0===this.pivot.z)Ae.createAffineTransformation(this._localPosition,this.localRotation,this._localScale,this._localMatrix);else{var t=e._tempVector30;Pe.multiply(this.pivot,this._localScale,t);var i=e._tempVector31;Pe.subtract(t,this.pivot,i);var n=e._tempVector32,r=this.localRotation;Pe.transformQuat(t,r,n),Pe.subtract(n,t,n);var a=e._tempVector33;Pe.subtract(this._localPosition,i,a),Pe.subtract(a,n,a),Ae.createAffineTransformation(a,r,this._localScale,this._localMatrix)}},i._onWorldPositionRotationTransform=function(){if(!this._worldUpdate||!this._positionUpdate||!this._rotationUpdate){this._worldUpdate=this._positionUpdate=this._rotationUpdate=!0,this.event("worldmatrixneedchanged");for(var t=0,e=this._childs.length;t<e;t++)this._childs[t]._onWorldPositionRotationTransform()}},i._onWorldPositionScaleTransform=function(){if(!this._worldUpdate||!this._positionUpdate||!this._scaleUpdate){this._worldUpdate=this._positionUpdate=this._scaleUpdate=!0,this.event("worldmatrixneedchanged");for(var t=0,e=this._childs.length;t<e;t++)this._childs[t]._onWorldPositionScaleTransform()}},i._onWorldPositionTransform=function(){if(!this._worldUpdate||!this._positionUpdate){this._worldUpdate=this._positionUpdate=!0,this.event("worldmatrixneedchanged");for(var t=0,e=this._childs.length;t<e;t++)this._childs[t]._onWorldPositionTransform()}},i._onWorldRotationTransform=function(){if(!this._worldUpdate||!this._rotationUpdate){this._worldUpdate=this._rotationUpdate=!0,this.event("worldmatrixneedchanged");for(var t=0,e=this._childs.length;t<e;t++)this._childs[t]._onWorldPositionRotationTransform()}},i._onWorldScaleTransform=function(){if(!this._worldUpdate||!this._scaleUpdate){this._worldUpdate=this._scaleUpdate=!0,this.event("worldmatrixneedchanged");for(var t=0,e=this._childs.length;t<e;t++)this._childs[t]._onWorldPositionScaleTransform()}},i._onWorldTransform=function(){if(!(this._worldUpdate&&this._positionUpdate&&this._rotationUpdate&&this._scaleUpdate)){this._worldUpdate=this._positionUpdate=this._rotationUpdate=this._scaleUpdate=!0,this.event("worldmatrixneedchanged");for(var t=0,e=this._childs.length;t<e;t++)this._childs[t]._onWorldTransform()}},i.translate=function(t,i){void 0===i&&(i=!0),i?(Ae.createFromQuaternion(this.localRotation,e._tempMatrix0),Pe.transformCoordinate(t,e._tempMatrix0,e._tempVector30),Pe.add(this.localPosition,e._tempVector30,this._localPosition),this.localPosition=this._localPosition):(Pe.add(this.position,t,this._position),this.position=this._position)},i.rotate=function(t,i,n){void 0===i&&(i=!0),void 0===n&&(n=!0);var r;n?r=t:(Pe.scale(t,Math.PI/180,e._tempVector30),r=e._tempVector30),Ce.createFromYawPitchRoll(r.y,r.x,r.z,e._tempQuaternion0),i?(Ce.multiply(this._localRotation,e._tempQuaternion0,this._localRotation),this.localRotation=this._localRotation):(Ce.multiply(e._tempQuaternion0,this.rotation,this._rotation),this.rotation=this._rotation)},i.lookAt=function(t,e,i){void 0===i&&(i=!1);var n,r=t.elements;if(i){if(n=this._localPosition.elements,Math.abs(n[0]-r[0])<Me.zeroTolerance&&Math.abs(n[1]-r[1])<Me.zeroTolerance&&Math.abs(n[2]-r[2])<Me.zeroTolerance)return;Ce.lookAt(this._localPosition,t,e,this._localRotation),this._localRotation.invert(this._localRotation),this.localRotation=this._localRotation}else{var a=this.position;if(n=a.elements,Math.abs(n[0]-r[0])<Me.zeroTolerance&&Math.abs(n[1]-r[1])<Me.zeroTolerance&&Math.abs(n[2]-r[2])<Me.zeroTolerance)return;Ce.lookAt(a,t,e,this._rotation),this._rotation.invert(this._rotation),this.rotation=this._rotation}},a(0,i,"_isFrontFaceInvert",function(){var t=this.scale,e=t.x<0;return t.y<0&&(e=!e),t.z<0&&(e=!e),e}),a(0,i,"owner",function(){return this._owner}),a(0,i,"localRotation",function(){if(this._localQuaternionUpdate){var t=this._localRotationEuler.elements;Ce.createFromYawPitchRoll(t[1]/e._angleToRandin,t[0]/e._angleToRandin,t[2]/e._angleToRandin,this._localRotation)}return this._localRotation},function(t){this._localRotation=t,this._localRotation.normalize(this._localRotation),this._locaEulerlUpdate=!0,this._localQuaternionUpdate=!1,this._localUpdate=!0,!this.pivot||0===this.pivot.x&&0===this.pivot.y&&0===this.pivot.z?this._onWorldRotationTransform():this._onWorldPositionRotationTransform()}),a(0,i,"worldMatrix",function(){return this._worldUpdate&&(null!=this._parent?Ae.multiply(this._parent.worldMatrix,this.localMatrix,this._worldMatrix):this.localMatrix.cloneTo(this._worldMatrix),this._worldUpdate=!1),this._worldMatrix},function(t){null===this._parent?t.cloneTo(this._localMatrix):(this._parent.worldMatrix.invert(this._localMatrix),Ae.multiply(this._localMatrix,t,this._localMatrix)),this.localMatrix=this._localMatrix,this._worldMatrix=t,this._worldUpdate=!1}),a(0,i,"worldNeedUpdate",function(){return this._worldUpdate}),a(0,i,"localMatrix",function(){return this._localUpdate&&(this._updateLocalMatrix(),this._localUpdate=!1),this._localMatrix},function(t){this._localMatrix=t,this._localMatrix.decomposeTransRotScale(this._localPosition,this._localRotation,this._localScale),this._localUpdate=!1,this._onWorldTransform()}),a(0,i,"dummy",function(){return this._dummy},function(t){this._dummy!==t&&(this._dummy&&(this._dummy._entity=null),t&&(t._entity=this),this._dummy=t)}),a(0,i,"localPosition",function(){return this._localPosition},function(t){this._localPosition=t,this._localUpdate=!0,this._onWorldPositionTransform()}),a(0,i,"position",function(){if(this._positionUpdate){if(null!=this._parent){var t=this._parent.position;Pe.multiply(this._localPosition,this._parent.scale,e._tempVector30),Pe.transformQuat(e._tempVector30,this._parent.rotation,e._tempVector30),Pe.add(t,e._tempVector30,this._position)}else this._localPosition.cloneTo(this._position);this._positionUpdate=!1}return this._position},function(t){if(null!=this._parent){Pe.subtract(t,this._parent.position,this._localPosition);var i=this._parent.scale.elements,n=i[0],r=i[1],a=i[2];if(1!==n||1!==r||1!==a){var s=e._tempVector30,o=s.elements;o[0]=1/n,o[1]=1/r,o[2]=1/a,Pe.multiply(this._localPosition,s,this._localPosition)}this._parent.rotation.invert(e._tempQuaternion0),Pe.transformQuat(this._localPosition,e._tempQuaternion0,this._localPosition)}else t.cloneTo(this._localPosition);this.localPosition=this._localPosition,this._position=t,this._positionUpdate=!1}),a(0,i,"localScale",function(){return this._localScale},function(t){this._localScale=t,this._localUpdate=!0,!this.pivot||0===this.pivot.x&&0===this.pivot.y&&0===this.pivot.z?this._onWorldScaleTransform():this._onWorldPositionScaleTransform()}),a(0,i,"localRotationEuler",function(){if(this._locaEulerlUpdate){this._localRotation.getYawPitchRoll(e._tempVector30);var t=e._tempVector30.elements,i=this._localRotationEuler.elements;i[0]=t[1]*e._angleToRandin,i[1]=t[0]*e._angleToRandin,i[2]=t[2]*e._angleToRandin}return this._localRotationEuler},function(t){this._localRotationEuler=t,this._locaEulerlUpdate=!1,this._localQuaternionUpdate=!0,this._localUpdate=!0,!this.pivot||0===this.pivot.x&&0===this.pivot.y&&0===this.pivot.z?this._onWorldRotationTransform():this._onWorldPositionRotationTransform()}),a(0,i,"rotation",function(){return this._rotationUpdate&&(null!=this._parent?Ce.multiply(this._parent.rotation,this.localRotation,this._rotation):this.localRotation.cloneTo(this._rotation),this._rotationUpdate=!1),this._rotation},function(t){null!=this._parent?(this._parent.rotation.invert(e._tempQuaternion0),Ce.multiply(t,e._tempQuaternion0,this._localRotation)):t.cloneTo(this._localRotation),this.localRotation=this._localRotation,this._rotation=t,this._rotationUpdate=!1}),a(0,i,"scale",function(){return this._scaleUpdate?(null!==this._parent?Pe.multiply(this._parent.scale,this._localScale,this._scale):this._localScale.cloneTo(this._scale),this._scaleUpdate=!1,this._scale):this._scale},function(t){if(null!==this._parent){var i=this._parent.scale.elements,n=e._tempVector30.elements;n[0]=1/i[0],n[1]=1/i[1],n[2]=1/i[2],Pe.multiply(t,e._tempVector30,this._localScale)}else t.cloneTo(this._localScale);this.localScale=this._localScale,this._scale=t,this._scaleUpdate=!1}),a(0,i,"rotationEuler",null,function(t){Ce.createFromYawPitchRoll(t.y,t.x,t.z,this._rotation),this.rotation=this._rotation}),a(0,i,"forward",function(){var t=this.worldMatrix.elements;return this._forward.elements[0]=-t[8],this._forward.elements[1]=-t[9],this._forward.elements[2]=-t[10],this._forward}),a(0,i,"up",function(){var t=this.worldMatrix.elements;return this._up.elements[0]=t[4],this._up.elements[1]=t[5],this._up.elements[2]=t[6],this._up}),a(0,i,"right",function(){var t=this.worldMatrix.elements;return this._right.elements[0]=t[0],this._right.elements[1]=t[1],this._right.elements[2]=t[2],this._right}),a(0,i,"parent",function(){return this._parent},function(t){if(this._parent!==t){if(this._parent){var e=this._parent._childs,i=e.indexOf(this);e.splice(i,1)}t&&(t._childs.push(this),t&&this._onWorldTransform()),this._parent=t}}),n(e,["_tempVector30",function(){return this._tempVector30=new Pe},"_tempVector31",function(){return this._tempVector31=new Pe},"_tempVector32",function(){return this._tempVector32=new Pe},"_tempVector33",function(){return this._tempVector33=new Pe},"_tempQuaternion0",function(){return this._tempQuaternion0=new Ce},"_tempMatrix0",function(){return this._tempMatrix0=new Ae},"_angleToRandin",function(){return this._angleToRandin=180/Math.PI}]),e}(v),ni=(function(t){function e(){this._rotation=0,this._matNeedUpdte=!1,e.__super.call(this),this._matrix=new Ae,this._offset=new Ne,this._tiling=new Ne(1,1)}r(e,"laya.d3.core.TransformUV",t);var s=e.prototype;i.imps(s,{"laya.d3.core.IClone":!0}),s._updateMatrix=function(){e._tempOffsetV3.elements[0]=this._offset.x,e._tempOffsetV3.elements[1]=this._offset.y,Ce.createFromYawPitchRoll(0,0,this._rotation,e._tempRotationQua),e._tempTitlingV3.elements[0]=this._tiling.x,e._tempTitlingV3.elements[1]=this._tiling.y,Ae.createAffineTransformation(e._tempOffsetV3,e._tempRotationQua,e._tempTitlingV3,this._matrix)},s.cloneTo=function(t){t._matrix=this._matrix.clone(),t._offset=this._offset.clone(),t._rotation=this._rotation,t._tiling=this._tiling.clone()},s.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},a(0,s,"matrix",function(){return this._matNeedUpdte&&(this._updateMatrix(),this._matNeedUpdte=!1),this._matrix}),a(0,s,"tiling",function(){return this._tiling},function(t){this._tiling=t,this._matNeedUpdte=!0}),a(0,s,"offset",function(){return this._offset},function(t){this._offset=t,this._matNeedUpdte=!0}),a(0,s,"rotation",function(){return this._rotation},function(t){this._rotation=t,this._matNeedUpdte=!0}),n(e,["_tempOffsetV3",function(){return this._tempOffsetV3=new Pe(0,0,0)},"_tempRotationQua",function(){return this._tempRotationQua=new Ce},"_tempTitlingV3",function(){return this._tempTitlingV3=new Pe(1,1,1)}])}(v),function(t){function e(){e.__super.call(this)}return r(e,"laya.d3.utils.CollisionManager",t),e._onTrigger=function(t,e,i,n,r){var a=0,s=0,o=t.id,l=e.id;if(!t._ignoreCollisonMap[l]){var h=Ye.collisionManager,u=t._runtimeCollisonTestMap[l];if(null!=u)if(u)if(t._collisonTo(e))if(t._runtimeCollisonMap[l]){for(a=0,s=i.length;a<s;a++)i[a].onTriggerStay(e);for(a=0,s=n.length;a<s;a++)n[a].onTriggerStay(t);h.event("triggerstay",[t,e])}else{for(t._runtimeCollisonMap[l]=e,t._runtimeCollisonTestMap[l]=!1,e._runtimeCollisonMap[o]=t,r&&(e._runtimeCollisonTestMap[o]=!1),a=0,s=i.length;a<s;a++)i[a].onTriggerEnter(e);for(a=0,s=n.length;a<s;a++)n[a].onTriggerEnter(t);h.event("triggerenter",[t,e])}else{var _=t._runtimeCollisonMap;if(_[l]){for(delete _[l],delete t._runtimeCollisonTestMap[l],delete e._runtimeCollisonMap[o],r&&delete e._runtimeCollisonTestMap[o],a=0,s=i.length;a<s;a++)i[a].onTriggerExit(e);for(a=0,s=n.length;a<s;a++)n[a].onTriggerExit(t);h.event("triggerexit",[t,e])}}else{for(a=0,s=i.length;a<s;a++)i[a].onTriggerStay(e);for(a=0,s=n.length;a<s;a++)n[a].onTriggerStay(t);h.event("triggerstay",[t,e])}else if(t._collisonTo(e)){for(t._runtimeCollisonMap[l]=e,t._runtimeCollisonTestMap[l]=!1,e._runtimeCollisonMap[o]=t,r&&(e._runtimeCollisonTestMap[o]=!1),a=0,s=i.length;a<s;a++)i[a].onTriggerEnter(e);for(a=0,s=n.length;a<s;a++)n[a].onTriggerEnter(t);h.event("triggerenter",[t,e])}}},e._triggerCollision=function(){for(var t=k._collsionTestList,i=t.length,n=Ye._layerCollsionMatrix,r=0;r<i;r++)for(var a=t[r],s=k.getLayerByNumber(a),o=s._colliders,l=s._nonRigidbodyOffset,h=i-1;h>=r;h--){var u=t[h],_=n[a][30-u];if(_){var c,d,f,m=0,p=0,v=0,g=0,E=k.getLayerByNumber(u),x=E._colliders,T=E._nonRigidbodyOffset;if(s!==E){for(m=0;m<l;m++)if(c=o[m],c.enable){for(f=c.owner._scripts,v=0,g=T;v<g;v++)d=x[v],d.enable&&e._onTrigger(c,d,f,d.owner._scripts,!0);for(v=T,g=x.length;v<g;v++)d=x[v],d.enable&&e._onTrigger(c,d,f,d.owner._scripts,!1)}for(m=l,p=o.length;m<p;m++)if(c=o[m],c.enable)for(f=c.owner._scripts,v=0,g=E._nonRigidbodyOffset;v<g;v++)d=x[v],d.enable&&e._onTrigger(d,c,f,d.owner._scripts,!1)}else for(m=0;m<l;m++)if(c=o[m],c.enable){for(f=c.owner._scripts,v=m+1,g=l;v<g;v++)d=x[v],d.enable&&e._onTrigger(c,d,f,d.owner._scripts,!0);for(v=l,g=o.length;v<g;v++)d=x[v],d.enable&&e._onTrigger(c,d,f,d.owner._scripts,!1)}}}},e}(v)),ri=(function(t){function e(){e.__super.call(this)}r(e,"laya.d3.core.glitter.SplineCurvePosition",t);var i=e.prototype;i._CalcVelocity=function(t,e,i){Pe.subtract(t,e,i),Pe.scale(i,.5,i)},i.Init=function(e,i,n,r){this._CalcVelocity(i,e,this._tempVector30),this._CalcVelocity(r,n,this._tempVector31),t.prototype.Init.call(this,i,this._tempVector30,r,this._tempVector31)}}(G),function(t){function e(){this.x=NaN,this.y=NaN,this.z=NaN,e.__super.call(this),this.x=1,this.y=1,this.z=1,this.randomDirection=!1}r(e,"laya.d3.core.particleShuriKen.module.shape.BoxShape",t);var i=e.prototype;return i._getShapeBoundBox=function(t){var e=t.min.elements;e[0]=.5*-this.x,e[1]=.5*-this.y,e[2]=.5*-this.z;var i=t.max.elements;i[0]=.5*this.x,i[1]=.5*this.y,i[2]=.5*this.z},i._getSpeedBoundBox=function(t){var e=t.min.elements;e[0]=0,e[1]=0,e[2]=0;var i=t.max.elements;i[0]=0,i[1]=1,i[2]=0},i.generatePositionAndDirection=function(t,e,i,n){var r=t.elements,a=e.elements;i?(i.seed=n[16],nt._randomPointInsideHalfUnitBox(t,i),n[16]=i.seed):nt._randomPointInsideHalfUnitBox(t),r[0]=this.x*r[0],r[1]=this.y*r[1],r[2]=this.z*r[2],this.randomDirection?i?(i.seed=n[17],nt._randomPointUnitSphere(e,i),n[17]=i.seed):nt._randomPointUnitSphere(e):(a[0]=0,a[1]=0,a[2]=1)},i.cloneTo=function(e){t.prototype.cloneTo.call(this,e);var i=e;i.x=this.x,i.y=this.y,i.z=this.z,i.randomDirection=this.randomDirection},e}(it)),ai=function(t){function e(){this.radius=NaN,this.arc=NaN,this.emitFromEdge=!1,e.__super.call(this),this.radius=1,this.arc=2*Math.PI,this.emitFromEdge=!1,this.randomDirection=!1}r(e,"laya.d3.core.particleShuriKen.module.shape.CircleShape",t);var i=e.prototype;return i._getShapeBoundBox=function(t){var e=t.min.elements;e[0]=e[2]=-this.radius,e[1]=0;var i=t.max.elements;i[0]=i[2]=this.radius,i[1]=0},i._getSpeedBoundBox=function(t){var e=t.min.elements;e[0]=e[1]=-1,e[2]=0;var i=t.max.elements;i[0]=i[1]=1,i[2]=0},i.generatePositionAndDirection=function(t,i,n,r){var a=t.elements,s=e._tempPositionPoint.elements;n?(n.seed=r[16],this.emitFromEdge?nt._randomPointUnitArcCircle(this.arc,e._tempPositionPoint,n):nt._randomPointInsideUnitArcCircle(this.arc,e._tempPositionPoint,n),r[16]=n.seed):this.emitFromEdge?nt._randomPointUnitArcCircle(this.arc,e._tempPositionPoint):nt._randomPointInsideUnitArcCircle(this.arc,e._tempPositionPoint),a[0]=-s[0],a[1]=s[1],a[2]=0,Pe.scale(t,this.radius,t),this.randomDirection?n?(n.seed=r[17],nt._randomPointUnitSphere(i,n),r[17]=n.seed):nt._randomPointUnitSphere(i):t.cloneTo(i)},i.cloneTo=function(e){t.prototype.cloneTo.call(this,e);var i=e;i.radius=this.radius,i.arc=this.arc,i.emitFromEdge=this.emitFromEdge,i.randomDirection=this.randomDirection},n(e,["_tempPositionPoint",function(){return this._tempPositionPoint=new Ne}]),e}(it),si=function(t){function e(){this.angle=NaN,this.radius=NaN,this.length=NaN,this.emitType=0,e.__super.call(this),this.angle=25/180*Math.PI,this.radius=1,this.length=5,this.emitType=0,this.randomDirection=!1}r(e,"laya.d3.core.particleShuriKen.module.shape.ConeShape",t);var i=e.prototype;return i._getShapeBoundBox=function(t){var e=this.radius+this.length*Math.sin(this.angle),i=this.length*Math.cos(this.angle),n=t.min.elements;n[0]=n[1]=-e,n[2]=0;var r=t.max.elements;r[0]=r[1]=e,r[2]=i},i._getSpeedBoundBox=function(t){var e=Math.sin(this.angle),i=t.min.elements;i[0]=i[1]=-e,i[2]=0;var n=t.max.elements;n[0]=i[1]=e,n[2]=1},i.generatePositionAndDirection=function(t,i,n,r){var a,s=t.elements,o=i.elements,l=e._tempPositionPoint.elements,h=NaN,u=NaN,_=Math.cos(this.angle),c=Math.sin(this.angle);switch(this.emitType){case 0:n?(n.seed=r[16],nt._randomPointInsideUnitCircle(e._tempPositionPoint,n),r[16]=n.seed):nt._randomPointInsideUnitCircle(e._tempPositionPoint),h=l[0],u=l[1],s[0]=h*this.radius,s[1]=u*this.radius,s[2]=0,this.randomDirection?(n?(n.seed=r[17],nt._randomPointInsideUnitCircle(e._tempDirectionPoint,n),r[17]=n.seed):nt._randomPointInsideUnitCircle(e._tempDirectionPoint),a=e._tempDirectionPoint.elements,o[0]=a[0]*c,o[1]=a[1]*c):(o[0]=h*c,o[1]=u*c),o[2]=_;break;case 1:n?(n.seed=r[16],nt._randomPointUnitCircle(e._tempPositionPoint,n),r[16]=n.seed):nt._randomPointUnitCircle(e._tempPositionPoint),h=l[0],u=l[1],s[0]=h*this.radius,s[1]=u*this.radius,s[2]=0,this.randomDirection?(n?(n.seed=r[17],nt._randomPointInsideUnitCircle(e._tempDirectionPoint,n),r[17]=n.seed):nt._randomPointInsideUnitCircle(e._tempDirectionPoint),a=e._tempDirectionPoint.elements,o[0]=a[0]*c,o[1]=a[1]*c):(o[0]=h*c,o[1]=u*c),o[2]=_;break;case 2:n?(n.seed=r[16],nt._randomPointInsideUnitCircle(e._tempPositionPoint,n)):nt._randomPointInsideUnitCircle(e._tempPositionPoint),h=l[0],u=l[1],s[0]=h*this.radius,s[1]=u*this.radius,s[2]=0,o[0]=h*c,o[1]=u*c,o[2]=_,Pe.normalize(i,i),n?(Pe.scale(i,this.length*n.getFloat(),i),r[16]=n.seed):Pe.scale(i,this.length*Math.random(),i),Pe.add(t,i,t),this.randomDirection&&(n?(n.seed=r[17],nt._randomPointUnitSphere(i,n),r[17]=n.seed):nt._randomPointUnitSphere(i));break;case 3:n?(n.seed=r[16],nt._randomPointUnitCircle(e._tempPositionPoint,n)):nt._randomPointUnitCircle(e._tempPositionPoint),h=l[0],u=l[1],s[0]=h*this.radius,s[1]=u*this.radius,s[2]=0,o[0]=h*c,o[1]=u*c,o[2]=_,Pe.normalize(i,i),n?(Pe.scale(i,this.length*n.getFloat(),i),r[16]=n.seed):Pe.scale(i,this.length*Math.random(),i),Pe.add(t,i,t),this.randomDirection&&(n?(n.seed=r[17],nt._randomPointUnitSphere(i,n),r[17]=n.seed):nt._randomPointUnitSphere(i));break;default:throw new Error("ConeShape:emitType is invalid.")}},i.cloneTo=function(e){t.prototype.cloneTo.call(this,e);var i=e;i.angle=this.angle,i.radius=this.radius,i.length=this.length,i.emitType=this.emitType,i.randomDirection=this.randomDirection},n(e,["_tempPositionPoint",function(){return this._tempPositionPoint=new Ne},"_tempDirectionPoint",function(){return this._tempDirectionPoint=new Ne}]),e}(it),oi=function(t){function e(){this.radius=NaN,this.emitFromShell=!1,e.__super.call(this),this.radius=1,this.emitFromShell=!1,this.randomDirection=!1}r(e,"laya.d3.core.particleShuriKen.module.shape.HemisphereShape",t);var i=e.prototype;return i._getShapeBoundBox=function(t){var e=t.min.elements;e[0]=e[1]=e[2]=-this.radius;var i=t.max.elements;i[0]=i[1]=this.radius,i[2]=0},i._getSpeedBoundBox=function(t){var e=t.min.elements;e[0]=e[1]=-1,e[2]=0;var i=t.max.elements;i[0]=i[1]=i[2]=1},i.generatePositionAndDirection=function(t,e,i,n){var r=t.elements;i?(i.seed=n[16],this.emitFromShell?nt._randomPointUnitSphere(t,i):nt._randomPointInsideUnitSphere(t,i),n[16]=i.seed):this.emitFromShell?nt._randomPointUnitSphere(t):nt._randomPointInsideUnitSphere(t),Pe.scale(t,this.radius,t);var a=r[2];a<0&&(r[2]=-1*a),this.randomDirection?i?(i.seed=n[17],nt._randomPointUnitSphere(e,i),n[17]=i.seed):nt._randomPointUnitSphere(e):t.cloneTo(e)},i.cloneTo=function(e){t.prototype.cloneTo.call(this,e);var i=e;i.radius=this.radius,i.emitFromShell=this.emitFromShell,i.randomDirection=this.randomDirection},e}(it),li=function(t){function e(){this.radius=NaN,this.emitFromShell=!1,e.__super.call(this),this.radius=1,this.emitFromShell=!1,this.randomDirection=!1}r(e,"laya.d3.core.particleShuriKen.module.shape.SphereShape",t);var i=e.prototype;return i._getShapeBoundBox=function(t){var e=t.min.elements;e[0]=e[1]=e[2]=-this.radius;var i=t.max.elements;i[0]=i[1]=i[2]=this.radius},i._getSpeedBoundBox=function(t){var e=t.min.elements;e[0]=e[1]=e[2]=-1;var i=t.max.elements;i[0]=i[1]=i[2]=1},i.generatePositionAndDirection=function(t,e,i,n){i?(i.seed=n[16],this.emitFromShell?nt._randomPointUnitSphere(t,i):nt._randomPointInsideUnitSphere(t,i),n[16]=i.seed):this.emitFromShell?nt._randomPointUnitSphere(t):nt._randomPointInsideUnitSphere(t),Pe.scale(t,this.radius,t),this.randomDirection?i?(i.seed=n[17],nt._randomPointUnitSphere(e,i),n[17]=i.seed):nt._randomPointUnitSphere(e):t.cloneTo(e)},i.cloneTo=function(e){t.prototype.cloneTo.call(this,e);var i=e;i.radius=this.radius,i.emitFromShell=this.emitFromShell,i.randomDirection=this.randomDirection},e}(it),hi=function(t){function e(){this._batchIndexStart=0,this._batchIndexEnd=0,this._skinAnimationDatas=null,e.__super.call(this)}return r(e,"laya.d3.core.render.SubMeshRenderElement",t),e}(ut),ui=function(t){function e(t,i,n,r,a,s){this._name=NaN,this._attributeMap=null,this._renderElementUniformMap=null,this._materialUniformMap=null,this._spriteUniformMap=null,this._cameraUniformMap=null,this._sceneUniformMap=null,this.sharders=null,this._spriteDefineCounter=3,this._spriteInt2name=[],this._spriteName2Int={},this._materialDefineCounter=1,this._materialInt2name=[],this._materialName2Int={},this._conchShader=null,this._name=t,this._renderElementUniformMap={},this._materialUniformMap={},this._spriteUniformMap={},this._cameraUniformMap={},this._sceneUniformMap={},this.sharders=[],this._spriteInt2name[Ge.SHADERDEFINE_RECEIVE_SHADOW]="RECEIVESHADOW",this._spriteInt2name[cn.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV]="SCALEOFFSETLIGHTINGMAPUV",this._spriteInt2name[cn.SAHDERDEFINE_LIGHTMAP]="LIGHTMAP",this._spriteInt2name[En.SHADERDEFINE_BONE]="BONE",this._materialInt2name[pi.SHADERDEFINE_ALPHATEST]="ALPHATEST";var o={};e.__super.call(this,t,i,n,null,o),this._attributeMap=r;var l;for(l in a){var h=a[l];switch(h[1]){case 0:this._renderElementUniformMap[l]=h[0];break;case 1:this._materialUniformMap[l]=h[0];break;case 2:this._spriteUniformMap[l]=h[0];break;case 3:this._cameraUniformMap[l]=h[0];break;case 4:this._sceneUniformMap[l]=h[0];break;default:throw new Error("ShaderCompile3D: period is unkonw.")}}if(D.isConchNode){this._conchShader=new ConchShader,this._conchShader.setSrc(this._VS.sd,this._PS.sd),delete this._VS.sd,delete this._PS.sd;var u=[];for(l in this._attributeMap)u.push({name:l,elementUsage:this._attributeMap[l]});this._conchShader.setAttrDeclare(u);var _=[];for(l in a){var c=a[l];_.push({name:l,elementUsage:c[0],periodType:c[1]})}this._conchShader.setUniformDeclare(_)}}r(e,"laya.d3.shader.ShaderCompile3D",t);var i=e.prototype;return i._definesToNameDic=function(t,e){for(var i={},n=1,r=0;r<32&&!((n=1<<r)>t);r++)if(t&n){var a=e[n];a&&(i[a]="")}return i},i.withCompile=function(t,i,n){var r,a,s;if(a=this.sharders[t])if(s=a[i]){if(r=s[n])return r}else s=a[i]=[];else a=this.sharders[t]=[],s=a[i]=[];var o,l=this._definesToNameDic(t,e._globalInt2name),h=this._definesToNameDic(i,this._spriteInt2name),u=this._definesToNameDic(n,this._materialInt2name);if(laya.d3.shader.ShaderCompile3D.debugMode){var _="";for(o in l)_+=o+" ";var c="";for(o in h)c+=o+" ";var d="";for(o in u)d+=o+" ";console.log("ShaderCompile3DDebugMode---(Name:"+Fi.nameKey.getName(this._name)+" PublicDefine:"+t+" SpriteDefine:"+i+" MaterialDefine:"+n+" PublicDefineGroup:"+_+" SpriteDefineGroup:"+c+"MaterialDefineGroup: "+d+")---ShaderCompile3DDebugMode")}var f={},m="";if(l)for(o in l)m+="#define "+o+"\n",f[o]=!0;if(h)for(o in h)m+="#define "+o+"\n",f[o]=!0;if(u)for(o in u)m+="#define "+o+"\n",f[o]=!0;var p=this._VS.toscript(f,[]),v=this._PS.toscript(f,[]);return r=Fi.create(m+p.join("\n"),m+v.join("\n"),this._attributeMap,this._sceneUniformMap,this._cameraUniformMap,this._spriteUniformMap,this._materialUniformMap,this._renderElementUniformMap),s[n]=r,r},i.precompileShaderWithShaderDefine=function(t,e,i){this.withCompile(t,e,i)},i.addMaterialDefines=function(t){var e=t.defines;for(var i in e){var n=e[i],r=parseInt(i);this._materialInt2name[r]=n,this._materialName2Int[n]=r}},i.addSpriteDefines=function(t){var e=t.defines;for(var i in e){var n=e[i],r=parseInt(i);this._spriteInt2name[r]=n,this._spriteName2Int[n]=r}},i.getMaterialDefineByName=function(t){return this._materialName2Int[t]},i.registerMaterialDefine=function(t){var e=Math.pow(2,this._materialDefineCounter++);return this._materialInt2name[e]=t,this._materialName2Int[t]=e,e},i.registerSpriteDefine=function(t){var e=Math.pow(2,this._spriteDefineCounter++);return this._spriteInt2name[e]=t,this._spriteName2Int[t]=e,e},e._globalRegDefine=function(t,i){e._globalInt2name[i]=t},e.add=function(t,i,n,r,a){return laya.d3.shader.ShaderCompile3D._preCompileShader[t]=new e(t,i,n,r,a,I.includes)},e.get=function(t){return laya.d3.shader.ShaderCompile3D._preCompileShader[Fi.nameKey.getID(t)]},e._preCompileShader={},e._globalInt2name=[],e.debugMode=!1,e.SHADERDEFINE_HIGHPRECISION=1,e.SHADERDEFINE_FOG=4,e.SHADERDEFINE_DIRECTIONLIGHT=8,e.SHADERDEFINE_POINTLIGHT=16,e.SHADERDEFINE_SPOTLIGHT=32,e.SHADERDEFINE_UV0=64,e.SHADERDEFINE_COLOR=128,e.SHADERDEFINE_UV1=256,e.SAHDERDEFINE_DEPTHFOG=131072,e}(I),_i=function(t){function e(){e.__super.call(this)}r(e,"laya.d3.graphics.MeshSprite3DStaticBatchManager",t);var i=e.prototype;return i._getStaticBatch=function(t,e,i,n){var r,a;return a=t?t.id.toString()+i.id.toString()+e.id.toString()+n.toString():i.id.toString()+e.id.toString()+n.toString(),this._staticBatches[a]?r=this._staticBatches[a]:this._staticBatches[a]=r=new ci(a,this,t,e,i),r},i._initStaticBatchs=function(t){this._initBatchRenderElements.sort(e._sortPrepareStaticBatch);for(var i,n,r,a=!1,s=0,o=0,l=this._initBatchRenderElements.length;o<l;o++){var h=this._initBatchRenderElements[o],u=h.renderObj._getVertexBuffer(0);h._sprite3D;if(n===u.vertexDeclaration&&i===h._material){var _;if(a)r._addCombineBatchRenderObjTest(h)?(_=h._staticBatch)!==r&&(_&&_._deleteCombineBatchRenderObj(h),r._addCombineBatchRenderObj(h)):(a=!1,s++);else{var c=this._initBatchRenderElements[o-1],d=c.renderObj,f=h.renderObj;d._getVertexBuffer().vertexCount+f._getVertexBuffer().vertexCount>65535?a=!1:(r=this._getStaticBatch(t,n,i,s),_=c._staticBatch,_!==r&&(_&&_._deleteCombineBatchRenderObj(c),r._addCombineBatchRenderObj(c)),_=h._staticBatch,_!==r&&(_&&_._deleteCombineBatchRenderObj(h),r._addCombineBatchRenderObj(h)),a=!0)}}else a=!1,s=0;i=h._material,n=u.vertexDeclaration}},e._sortPrepareStaticBatch=function(t,e){var i=t._render,n=e._render,r=i.lightmapIndex-n.lightmapIndex;if(0===r){var a=i.receiveShadow-n.receiveShadow;if(0===a){var s=t._mainSortID-e._mainSortID;return 0===s?t.renderObj.triangleCount-e.renderObj.triangleCount:s}return a}return r},e}(Mt),ci=function(t){function e(t,i,n,r,a){this._batchOwnerIndices=null,this._batchOwners=null,this._needFinishCombine=!1,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._vertexDeclaration=null,this._vertexBuffer=null,this._indexBuffer=null,e.__super.call(this,t,i,n),this._batchOwnerIndices=[],this._batchOwners=[],this._needFinishCombine=!1,this._currentCombineVertexCount=0,this._currentCombineIndexCount=0,this._vertexDeclaration=r,this._material=a}r(e,"laya.d3.graphics.SubMeshStaticBatch",t);var i=e.prototype;return i._compareBatchRenderElement=function(t,e){return t._batchIndexStart>e._batchIndexStart},i._addCombineBatchRenderObjTest=function(t){var e=t.renderObj._vertexCount;return!((e>0?this._currentCombineVertexCount+e:this._currentCombineVertexCount+t.renderObj._getVertexBuffer().vertexCount)>65535)},i._addCombineBatchRenderObj=function(t){var e=t.renderObj,i=e._vertexCount;this._initBatchRenderElements.push(t),t._staticBatch=this,i>0?(this._currentCombineIndexCount+=e._indexCount,this._currentCombineVertexCount+=i):(this._currentCombineIndexCount=this._currentCombineIndexCount+e._getIndexBuffer().indexCount,this._currentCombineVertexCount=this._currentCombineVertexCount+e._getVertexBuffer().vertexCount),this._needFinishCombine=!0},i._deleteCombineBatchRenderObj=function(t){var e=t.renderObj,i=this._initBatchRenderElements.indexOf(t);if(-1!==i){this._initBatchRenderElements.splice(i,1),t._staticBatch=null;var n=e._vertexCount;n>0?(this._currentCombineIndexCount=this._currentCombineIndexCount-e._indexCount,this._currentCombineVertexCount=this._currentCombineVertexCount-n):(this._currentCombineIndexCount=this._currentCombineIndexCount-e._getIndexBuffer().indexCount,this._currentCombineVertexCount=this._currentCombineVertexCount-e._getVertexBuffer().vertexCount),this._needFinishCombine=!0}},i._finishInit=function(){if(this._needFinishCombine){var t=0,e=0;this._initBatchRenderElements[0]._sprite3D._render.lightmapIndex>=0?this._vertexDeclaration=this._getVertexDecLightMap(this._vertexDeclaration):this._material instanceof laya.d3.core.material.StandardMaterial&&this._material.ambientTexture&&(this._vertexDeclaration=this._getVertexDecLightMap(this._vertexDeclaration));var i=new Float32Array(this._vertexDeclaration.vertexStride/4*this._currentCombineVertexCount),n=new Uint16Array(this._currentCombineIndexCount);this._vertexBuffer&&(this._vertexBuffer.destroy(),this._indexBuffer.destroy()),this._vertexBuffer=Ki.create(this._vertexDeclaration,this._currentCombineVertexCount,35044),this._indexBuffer=Zi.create("ushort",this._currentCombineIndexCount,35044);for(var r=0,a=this._initBatchRenderElements.length;r<a;r++){var s=this._initBatchRenderElements[r],o=s.renderObj,l=o._getStaticBatchBakedVertexs(this._rootOwner?this._rootOwner._transform:null,s._sprite3D),h=o.getIndices(),u=s._sprite3D.transform._isFrontFaceInvert,_=t/(this._vertexDeclaration.vertexStride/4)-o._vertexStart,c=e,d=c+h.length;s._batchIndexStart=c,s._batchIndexEnd=d,n.set(h,e);var f=0;if(u)for(f=c;f<d;f+=3){n[f]=_+n[f];var m=n[f+1],p=n[f+2];n[f+1]=_+p,n[f+2]=_+m}else for(f=c;f<d;f+=3)n[f]=_+n[f],n[f+1]=_+n[f+1],n[f+2]=_+n[f+2];e+=h.length,i.set(l,t),t+=l.length}this._vertexBuffer.setData(i),this._indexBuffer.setData(n),this._needFinishCombine=!1}},i._getCombineRenderElementFromPool=function(){return this._combineRenderElementPool[this._combineRenderElementPoolIndex++]||(this._combineRenderElementPool[this._combineRenderElementPoolIndex-1]=new hi)},i._getRenderElement=function(t,e,i){for(var n,r,a=this._batchRenderElements.length,s=!0,o=0;o<a;o++){r=this._batchRenderElements[o];var l,h=r._sprite3D._render;0!==o&&(n=this._batchRenderElements[o-1],l=n._sprite3D._render,s=l.lightmapIndex!==h.lightmapIndex||l.receiveShadow!==h.receiveShadow||n._batchIndexEnd!==r._batchIndexStart);var u;if(s){u=this._getCombineRenderElementFromPool(),u.renderObj=this,u._material=this._material,u._batchIndexStart=r._batchIndexStart,u._batchIndexEnd=r._batchIndexEnd;var _=h.lightmapIndex,c=_+1,d=this._batchOwnerIndices[c];d||(d=this._batchOwnerIndices[c]=[]);var f,m=d[r._render.receiveShadow?1:0];void 0===m?(d[h.receiveShadow?1:0]=this._batchOwners.length,f=new vn(null,"StaticBatchMeshSprite3D"),f._scene=e,f._transform=this._rootOwner?this._rootOwner._transform:null,f._render.lightmapIndex=_,f._render.receiveShadow=r._render.receiveShadow,this._batchOwners.push(f)):f=this._batchOwners[m],f._render._renderUpdate(i),u._sprite3D=f,t.push(u)}else u._batchIndexEnd=r._batchIndexEnd}},i._beforeRender=function(t){return this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},i._render=function(t){var e=t.renderElement,i=e._batchIndexStart,n=e._batchIndexEnd-i;P.mainContext.drawElements(4,n,5123,2*i),C.drawCall++,C.trianglesFaces+=n/3},i.dispose=function(){this._batchOwnerIndices=null,this._batchOwners=null,this._vertexDeclaration=null,this._vertexBuffer.destroy(),this._indexBuffer.destroy()},i._getVertexBuffer=function(t){return void 0===t&&(t=0),this._vertexBuffer},e}(yt),di=(function(t){function e(){e.__super.call(this),e._nameNumber++,this.loadShaderParams(),this.createResource(),this.alphaBlending=1,this.colorIntensity=1}r(e,"laya.d3.resource.models.SkyBox",t);var i=e.prototype;i._getShader=function(t){var e=t.scene._shaderDefineValue;return this._shader=this._shaderCompile.withCompile(e,0,0),this._shader},i.createResource=function(){this._numberVertices=36,this._numberIndices=36;var t=new Uint16Array(this._numberIndices),i=e._vertexDeclaration.vertexStride/4,n=new Float32Array(this._numberVertices*i),r=new Pe(-.5,.5,.5),a=new Pe(-.5,-.5,.5),s=new Pe(.5,.5,.5),o=new Pe(.5,-.5,.5),l=new Pe(-.5,.5,-.5),h=new Pe(.5,.5,-.5),u=new Pe(-.5,-.5,-.5),_=new Pe(.5,-.5,-.5),c=0;c=this._addVertex(n,c,r),c=this._addVertex(n,c,a),c=this._addVertex(n,c,s),c=this._addVertex(n,c,a),c=this._addVertex(n,c,o),c=this._addVertex(n,c,s),c=this._addVertex(n,c,l),c=this._addVertex(n,c,h),c=this._addVertex(n,c,u),c=this._addVertex(n,c,u),c=this._addVertex(n,c,h),c=this._addVertex(n,c,_),c=this._addVertex(n,c,r),c=this._addVertex(n,c,h),c=this._addVertex(n,c,l),c=this._addVertex(n,c,r),c=this._addVertex(n,c,s),c=this._addVertex(n,c,h),c=this._addVertex(n,c,a),c=this._addVertex(n,c,u),c=this._addVertex(n,c,_),c=this._addVertex(n,c,a),c=this._addVertex(n,c,_),c=this._addVertex(n,c,o),c=this._addVertex(n,c,r),c=this._addVertex(n,c,u),c=this._addVertex(n,c,a),c=this._addVertex(n,c,l),c=this._addVertex(n,c,u),c=this._addVertex(n,c,r),c=this._addVertex(n,c,s),c=this._addVertex(n,c,o),c=this._addVertex(n,c,_),c=this._addVertex(n,c,h),c=this._addVertex(n,c,s),c=this._addVertex(n,c,_);for(var d=0;d<36;d++)t[d]=d;this._vertexBuffer=new Ki(e._vertexDeclaration,this._numberVertices,35044,!0),this._indexBuffer=new Zi("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(n),this._indexBuffer.setData(t)},i._addVertex=function(t,e,i){var n=i.elements;return t[e+0]=n[0],t[e+1]=n[1],t[e+2]=n[2],e+3},i.loadShaderParams=function(){this._sharderNameID=Fi.nameKey.getID("SkyBox"),this._shaderCompile=ui._preCompileShader[this._sharderNameID]},i._render=function(t){this._textureCube&&this._textureCube.loaded&&(this._vertexBuffer._bind(),this._indexBuffer._bind(),this._shader=this._getShader(t),this._shader.bind(),t.camera.transform.worldMatrix.cloneTo(e._tempMatrix4x40),e._tempMatrix4x40.transpose(),Ae.multiply(t._projectionMatrix,e._tempMatrix4x40,e._tempMatrix4x41),t.camera._shaderValues.setValue(4,e._tempMatrix4x41.elements),this._shader.uploadCameraUniforms(t.camera._shaderValues.data),this._shaderValue.setValue(1,this._colorIntensity),this._shaderValue.setValue(2,this._alphaBlending),this._shaderValue.setValue(3,this.textureCube),this._shader.uploadAttributes(e._vertexDeclaration.shaderValues.data,null),this._shader.uploadMaterialUniforms(this._shaderValue.data),P.mainContext.drawElements(4,36,5123,0),C.trianglesFaces+=12,C.drawCall++)},i.destroy=function(){t.prototype.destroy.call(this),this._textureCube&&(this._textureCube._removeReference(),this._textureCube=null)},a(0,i,"textureCube",function(){return this._textureCube},function(t){this._textureCube!==t&&(this._textureCube&&this._textureCube._removeReference(),this._textureCube=t,t&&t._addReference())}),e._nameNumber=1,n(e,["_tempMatrix4x40",function(){return this._tempMatrix4x40=new Ae},"_tempMatrix4x41",function(){return this._tempMatrix4x41=new Ae},"_vertexDeclaration",function(){return this._vertexDeclaration=new At(12,[new It(0,"vector3",0)])}])}(Ve),function(t){function e(){this._stacks=16,this._slices=16,this._radius=1,e.__super.call(this),e._nameNumber++,this.loadShaderParams(),this.recreateResource(),this.alphaBlending=1,this.colorIntensity=1}r(e,"laya.d3.resource.models.SkyDome",t);var s=e.prototype;s._getShader=function(t){var e=t.scene._shaderDefineValue;return this._shader=this._shaderCompile.withCompile(e,0,0),this._shader},s.recreateResource=function(){this._numberVertices=(this._stacks+1)*(this._slices+1),this._numberIndices=3*this._stacks*(this._slices+1)*2;for(var t=new Uint16Array(this._numberIndices),i=e._vertexDeclaration.vertexStride/4,n=new Float32Array(this._numberVertices*i),r=Math.PI/this._stacks,a=2*Math.PI/this._slices,s=0,o=0,l=0,h=0;h<this._stacks+1;h++)for(var u=Math.sin(h*r),_=Math.cos(h*r),c=0;c<this._slices+1;c++){var d=u*Math.sin(c*a),f=u*Math.cos(c*a);n[o+0]=d*this._radius,n[o+1]=_*this._radius,n[o+2]=f*this._radius,n[o+3]=-c/this._slices+.75,n[o+4]=h/this._stacks,o+=i,h!=this._stacks-1&&(t[l++]=s+1,t[l++]=s,t[l++]=s+(this._slices+1),t[l++]=s+(this._slices+1),t[l++]=s,t[l++]=s+this._slices,s++)}if(this._vertexBuffer=new Ki(e._vertexDeclaration,this._numberVertices,35044),this._indexBuffer=new Zi("ushort",this._numberIndices,35044),this._vertexBuffer.setData(n),this._indexBuffer.setData(t),this._conchSky){this._conchSky.setVBIB(e._vertexDeclaration._conchVertexDeclaration,n,t),this._sharderNameID=Fi.nameKey.getID("SkyDome");var m=ui._preCompileShader[this._sharderNameID];this._conchSky.setShader(m._conchShader)}},s.loadShaderParams=function(){this._sharderNameID=Fi.nameKey.getID("SkyDome"),this._shaderCompile=ui._preCompileShader[this._sharderNameID]},s._render=function(t){this._texture&&this._texture.loaded&&(this._vertexBuffer._bind(),this._indexBuffer._bind(),this._shader=this._getShader(t),this._shader.bind(),t.camera.transform.worldMatrix.cloneTo(e._tempMatrix4x40),e._tempMatrix4x40.transpose(),Ae.multiply(t._projectionMatrix,e._tempMatrix4x40,e._tempMatrix4x41),t.camera._shaderValues.setValue(4,e._tempMatrix4x41.elements),this._shader.uploadCameraUniforms(t.camera._shaderValues.data),this._shaderValue.setValue(1,this._colorIntensity),this._shaderValue.setValue(2,this._alphaBlending),this._shaderValue.setValue(3,this.texture),this._shader.uploadAttributes(e._vertexDeclaration.shaderValues.data,null),this._shader.uploadMaterialUniforms(this._shaderValue.data),P.mainContext.drawElements(4,this._indexBuffer.indexCount,5123,0),C.trianglesFaces+=this._numberIndices/3,C.drawCall++)},s.onEnvDescLoaded=function(t){var e="",n=Math.max(t.lastIndexOf("/"),t.lastIndexOf("\\"));n>0&&(e=t.substr(0,n+1));var r=i.loader.getRes(t);void 0!=r.ev&&this.__ownerCamera?this.__ownerCamera._shaderValues.setValue(13,Math.pow(2,r.ev)):this.__ownerCamera._shaderValues.setValue(13,Math.pow(2,0)),this.texture=ln.load(e+r.skytex),this.environmentSpecular=en.load(e+r.prefiltedEnv);var a=new Float32Array(r.IrradianceMat);this.envDiffuseSHRed=a.slice(0,16),this.envDiffuseSHGreen=a.slice(16,32),this.envDiffuseSHBlue=a.slice(32,48)},s.loadEnvInfo=function(t){i.loader.load(t,g.create(this,this.onEnvDescLoaded,[t]))},s.destroy=function(){t.prototype.destroy.call(this),this._texture&&(this._texture._removeReference(),this._texture=null)},a(0,s,"texture",function(){return this._texture},function(t){this._texture!==t&&(this._texture&&this._texture._removeReference(),this._texture=t,t&&t._addReference())}),e._nameNumber=1,n(e,["_tempMatrix4x40",function(){return this._tempMatrix4x40=new Ae},"_tempMatrix4x41",function(){return this._tempMatrix4x41=new Ae},"_vertexDeclaration",function(){return this._vertexDeclaration=new At(20,[new It(0,"vector3",0),new It(12,"vector2",2)])}])}(Ve),function(t){function e(){this._componentsMap=null,this._typeComponentsIndices=null,this._components=null,this._scripts=null,e.__super.call(this),this._componentsMap=[],this._typeComponentsIndices=[],this._components=[],this._scripts=[]}r(e,"laya.d3.core.ComponentNode",t);var i=e.prototype;return i.addComponent=function(t){var e,i=this._componentsMap.indexOf(t);if(-1===i)e=[],this._componentsMap.push(t),this._typeComponentsIndices.push(e);else if(e=this._typeComponentsIndices[i],this._components[e[0]].isSingleton)throw new Error("无法单实例创建"+t+"组件，"+t+"组件已存在！");var n=m.getInstance(t);return e.push(this._components.length),this._components.push(n),n instanceof laya.d3.component.Script&&this._scripts.push(n),n._initialize(this),n},i._removeComponent=function(t,e){var i=this._typeComponentsIndices[t],n=i[e],r=this._components[n];this._components.splice(n,1),r instanceof laya.d3.component.Script&&this._scripts.splice(this._scripts.indexOf(r),1),i.splice(e,1),0===i.length&&(this._typeComponentsIndices.splice(t,1),this._componentsMap.splice(t,1));for(var a=0,s=this._componentsMap.length;a<s;a++){i=this._typeComponentsIndices[a];for(var o=i.length-1;o>=0;o--){var l=i[o];if(!(l>n))break;i[o]=--l}}r._destroy()},i.getComponentByType=function(t,e){void 0===e&&(e=0);var i=this._componentsMap.indexOf(t);return-1===i?null:this._components[this._typeComponentsIndices[i][e]]},i.getComponentsByType=function(t,e){var i=this._componentsMap.indexOf(t);if(-1===i)return void(e.length=0);var n=this._typeComponentsIndices[i],r=n.length;e.length=r;for(var a=0;a<r;a++)e[a]=this._components[n[a]]},i.getComponentByIndex=function(t){return this._components[t]},i.removeComponentByType=function(t,e){void 0===e&&(e=0);var i=this._componentsMap.indexOf(t);-1!==i&&this._removeComponent(i,e)},i.removeComponentsByType=function(t){var e=this._componentsMap.indexOf(t);if(-1!==e)for(var i=this._typeComponentsIndices[e],n=0,r=i.length;n<r;i.length<r?r--:n++)this._removeComponent(e,n)},i.removeAllComponent=function(){for(var t=0,e=this._componentsMap.length;t<e;this._componentsMap.length<e?e--:t++)this.removeComponentsByType(this._componentsMap[t])},i._updateComponents=function(t){for(var e=0,i=this._components.length;e<i;e++){var n=this._components[e];!n.started&&(n._start(t),n.started=!0),n.enable&&n._update(t)}},i._lateUpdateComponents=function(t){for(var e=0;e<this._components.length;e++){var i=this._components[e];!i.started&&(i._start(t),i.started=!0),i.enable&&i._lateUpdate(t)}},i._preRenderUpdateComponents=function(t){for(var e=0;e<this._components.length;e++){var i=this._components[e];!i.started&&(i._start(t),i.started=!0),i.enable&&i._preRenderUpdate(t)}},i._postRenderUpdateComponents=function(t){for(var e=0;e<this._components.length;e++){var i=this._components[e];!i.started&&(i._start(t),i.started=!0),i.enable&&i._postRenderUpdate(t)}},e}(S)),fi=function(t){function e(){this._realTimeCurrentFrameIndexes=null,this._realTimeCurrentTimes=null,this._fullKeyframeIndicesCache=null,this._animationDatasCache=null,this._avatarDatasCache=null,this._skinnedDatasCache=null,this._version=null,this._nodes=null,this._nodesMap=null,this._cachePropertyMap=null,this._nodeToCachePropertyMap=null,this._unCachePropertyMap=null,this._duration=NaN,this._frameRate=0,this._animationEvents=null,this._publicClipDatas=null,this.islooping=!1,e.__super.call(this),this._fullKeyframeIndicesCache={},this._animationDatasCache=[],this._avatarDatasCache=[],this._skinnedDatasCache=[],this._animationEvents=[]}r(e,"laya.d3.animation.AnimationClip",t);var n=e.prototype;return n.duration=function(){return this._duration},n._hermiteInterpolate=function(t,e,i,n){for(var r=t.data,a=t.outTangent,s=t.next,o=s.data,l=s.inTangent,h=!1,u=NaN,_=NaN,c=NaN,d=NaN,f=0,m=n.length;f<m;f++){var p=a[f],v=l[f];if(Number.isFinite(p)&&Number.isFinite(v)){if(!h){var g=e*e,E=g*e;u=2*E-3*g+1,_=E-2*g+e,c=E-g,d=-2*E+3*g,h=!0}n[f]=u*r[f]+_*p*i+c*v*i+d*o[f]}else n[f]=r[f]}},n._getFullKeyframeIndicesWithCache=function(t){return this._fullKeyframeIndicesCache[t]},n._cacheFullKeyframeIndices=function(t,e){this._fullKeyframeIndicesCache[t]=e},n._getAnimationDataWithCache=function(t,e){var i=this._animationDatasCache[t];return i?i[e]:null},n._cacheAnimationData=function(t,e,i){(this._animationDatasCache[t]||(this._animationDatasCache[t]=[]))[e]=i},n._getAvatarDataWithCache=function(t,e,i){var n=this._avatarDatasCache[t.id];if(n){var r=n[e];return r?r[i]:null}return null},n._cacheAvatarData=function(t,e,i,n){var r=this._avatarDatasCache[t.id]||(this._avatarDatasCache[t.id]=[]);(r[e]||(r[e]=[]))[i]=n},n._evaluateAnimationlDatasCacheMode=function(t,e,i,n,r){for(var a=0,s=0,o=0,l=r?r.length:this._nodes.length;o<l;o++){var h=r?r[o]:o,u=this._nodes[h],_=u._cacheProperty;if(t[h]){var c,d=e[h],f=d[i.currentFrameIndex],m=0;if(-1!==f){var p=u.keyFrames[f];if(p.next){r&&!_?(c=n[h])||(c=n[h]=new Float32Array(u.keyFrameWidth)):(c=new Float32Array(u.keyFrameWidth),n[o]=c);var v=NaN,g=p.duration;v=0!==g?(i.currentFrameTime-p.startTime)/g:0,this._hermiteInterpolate(p,v,g,c)}else{if(r&&!_)(c=n[h])||(c=n[h]=new Float32Array(u.keyFrameWidth));else{if(-1!==(m=i._lastFrameIndex)&&d[m]===f)continue;c=new Float32Array(u.keyFrameWidth),n[o]=c}var E=p.data;for(a=0,s=c.length;a<s;a++)c[a]=E[a]}}else{if(r&&!_)(c=n[h])||(c=n[h]=new Float32Array(u.keyFrameWidth));else{if(-1!==(m=i._lastFrameIndex)&&d[m]===f)continue;c=new Float32Array(u.keyFrameWidth),n[o]=c}var x=u.keyFrames[0].data;for(a=0,s=c.length;a<s;a++)c[a]=x[a]}}}},n._evaluateAnimationlDatasRealTime=function(t,e,i,n){var r=0,a=0,s=this._nodes;if(!this._realTimeCurrentFrameIndexes){for(this._realTimeCurrentFrameIndexes=new Int32Array(s.length),r=0,a=s.length;r<a;r++)this._realTimeCurrentFrameIndexes[r]=-1;this._realTimeCurrentTimes=new Float32Array(s.length)}for(r=0,a=n?n.length:this._nodes.length;r<a;r++){var o=n?n[r]:r,l=s[o];e<this._realTimeCurrentTimes[o]&&(this._realTimeCurrentFrameIndexes[o]=-1),this._realTimeCurrentTimes[o]=e;for(var h=this._realTimeCurrentFrameIndexes[o]+1,u=l.keyFrames,_=u.length;h<_;){if(u[h].startTime>e){this._realTimeCurrentFrameIndexes[o]=h-1;break}h++}h===_&&(this._realTimeCurrentFrameIndexes[o]=_-1);var c=0,d=0,f=i[o];f||(f=i[o]=new Float32Array(l.keyFrameWidth));var m=u[this._realTimeCurrentFrameIndexes[o]];if(m){if(m.next){var p=m.duration,v=NaN;v=0!==p?(e-m.startTime)/p:0,this._hermiteInterpolate(m,v,p,f)}else{var g=m.data;for(c=0,d=f.length;c<d;c++)f[c]=g[c]}}else{var E=l.keyFrames[0].data;for(c=0,d=f.length;c<d;c++)f[c]=E[c]}var x=t[o];x&&(n?B._propertySetFuncs[l.propertyNameID](x,null,f):B._propertySetFuncs[l.propertyNameID](null,x,f))}},n._binarySearchEventIndex=function(t){for(var e=0,i=this._animationEvents.length-1,n=0;e<=i;){n=Math.floor((e+i)/2);var r=this._animationEvents[n].time;if(r==t)return n;r>t?i=n-1:e=n+1}return e},n.addEvent=function(t){var e=this._binarySearchEventIndex(t.time);this._animationEvents.splice(e,0,t)},n.onAsynLoaded=function(t,e,i){var n=new f(e);switch(this._version=n.readUTFString(),this._version){case"LAYAANIMATION:01":O.parse(this,n);break;case"LAYAANIMATION:02":V.parse(this,n)}this.completeCreate(),this._endLoaded()},n.disposeResource=function(){this._realTimeCurrentFrameIndexes=null,this._realTimeCurrentTimes=null,this._fullKeyframeIndicesCache=null,this._animationDatasCache=null,this._avatarDatasCache=null,this._skinnedDatasCache=null,this._version=null,this._nodes=null,this._nodesMap=null,this._cachePropertyMap=null,this._nodeToCachePropertyMap=null,this._unCachePropertyMap=null,this._publicClipDatas=null},e.load=function(t){return i.loader.create(t,null,null,e)},e}(y),mi=function(t){function e(){e.__super.call(this)}r(e,"laya.d3.core.Avatar",t);var n=e.prototype;return i.imps(n,{"laya.d3.core.IClone":!0}),n._initCloneToAnimator=function(t,e){e._avatarNodeMap[t.name]=t,e._avatarNodes.push(t);for(var i=0,n=t.getChildCount();i<n;i++)this._initCloneToAnimator(t.getChildByIndex(i),e)},n._parseNode=function(t,e){var i=t.props.name;if(e.name=i,e._parent){var n=t.customProps,r=e.transform;r._localRotationEuler=new Float32Array(3),r.setLocalPosition(new Float32Array(n.translate)),r.setLocalRotation(new Float32Array(n.rotation)),r.setLocalScale(new Float32Array(n.scale)),r._setWorldMatrixAndUpdate(new Float32Array(16))}for(var a=t.child,s=0,o=a.length;s<o;s++){var l=a[s],h=new B;e.addChild(h),this._parseNode(l,h)}},n.onAsynLoaded=function(t,e,i){if(this._rootNode=new B,e.version){this._version=e.version;var n=e.rootNode;n&&this._parseNode(n,this._rootNode)}else this._parseNode(e,this._rootNode);this._endLoaded()},n._cloneDatasToAnimator=function(t){var e=this._rootNode.clone();e.transform._setWorldMatrixIgnoreUpdate(null);var i=[];t._avatarNodeMap={},t._avatarNodes=i,this._initCloneToAnimator(e,t)},n.cloneTo=function(t){var e=t,i=this._rootNode.clone();e._rootNode=i},n.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},e.load=function(t){return i.loader.create(t,null,null,e)},e}(y),pi=function(t){function e(){e.__super.call(this),this._shaderDefineValue=0,this._disablePublicShaderDefine=0,this._shaderValues=new He,this._values=[],this.renderQueue=1,this._alphaTest=!1,this.cull=2,this.blend=0,this.srcBlend=1,this.dstBlend=0,this.srcBlendRGB=1,this.dstBlendRGB=0,this.srcBlendAlpha=1,this.dstBlendAlpha=0,this.blendConstColor=new Le(1,1,1,1),this.blendEquation=0,this.blendEquationRGB=0,this.blendEquationAlpha=0,this.depthTest=513,this.depthWrite=!0}r(e,"laya.d3.core.material.BaseMaterial",t);var s=e.prototype;return i.imps(s,{"laya.d3.core.IClone":!0}),s._addShaderDefine=function(t){this._shaderDefineValue|=t},s._removeShaderDefine=function(t){this._shaderDefineValue&=~t},s._addDisablePublicShaderDefine=function(t){this._disablePublicShaderDefine|=t},s._removeDisablePublicShaderDefine=function(t){this._disablePublicShaderDefine&=~t},s._setBuffer=function(t,e){this._shaderValues.setValue(t,e),this._values[t]=e},s._getBuffer=function(t){return this._values[t]},s._setMatrix4x4=function(t,e){this._shaderValues.setValue(t,e?e.elements:null),this._values[t]=e},s._getMatrix4x4=function(t){return this._values[t]},s._setInt=function(t,e){this._shaderValues.setValue(t,e),this._values[t]=e},s._getInt=function(t){return this._values[t]},s._setNumber=function(t,e){this._shaderValues.setValue(t,e),this._values[t]=e},s._getNumber=function(t){return this._values[t]},s._setBool=function(t,e){this._shaderValues.setValue(t,e),this._values[t]=e},s._getBool=function(t){return this._values[t]},s._setVector2=function(t,e){this._shaderValues.setValue(t,e?e.elements:null),this._values[t]=e},s._getVector2=function(t){return this._values[t]},s._setColor=function(t,e){this._shaderValues.setValue(t,e?e.elements:null),this._values[t]=e},s._getColor=function(t){return this._values[t]},s._setTexture=function(t,e){var i=this._values[t];this._values[t]=e,this._shaderValues.setValue(t,e),this.referenceCount>0&&(i&&i._removeReference(),e&&e._addReference())},s._getTexture=function(t){return this._values[t]},s._upload=function(){this._shader.uploadMaterialUniforms(this._shaderValues.data)},s._getShader=function(t,e,i){var n=(t|e)&~this._disablePublicShaderDefine;return this._shader=this._shaderCompile.withCompile(n,i,this._shaderDefineValue),this._shader},s._setRenderStateBlendDepth=function(){var t=P.mainContext;switch(L.setDepthMask(t,this.depthWrite),0===this.depthTest?L.setDepthTest(t,!1):(L.setDepthTest(t,!0),L.setDepthFunc(t,this.depthTest)),this.blend){case 0:L.setBlend(t,!1);break;case 1:L.setBlend(t,!0),L.setBlendFunc(t,this.srcBlend,this.dstBlend);break;case 2:L.setBlend(t,!0)}},s._setRenderStateFrontFace=function(t,e){var i=P.mainContext,n=0;switch(this.cull){case 0:L.setCullFace(i,!1);break;case 1:L.setCullFace(i,!0),n=t?e&&e._isFrontFaceInvert?2305:2304:e&&e._isFrontFaceInvert?2304:2305,L.setFrontFace(i,n);break;case 2:L.setCullFace(i,!0),n=t?e&&e._isFrontFaceInvert?2304:2305:e&&e._isFrontFaceInvert?2305:2304,L.setFrontFace(i,n)}},s.onAsynLoaded=function(t,e,i){var n=e[0],r=e[1];switch(n.version){case"LAYAMATERIAL:01":var a=0,s=0,o=n.props;for(var l in o)switch(l){case"vectors":var h=o[l];for(a=0,s=h.length;a<s;a++){var u=h[a],_=u.value;switch(_.length){case 2:this[u.name]=new Ne(_[0],_[1]);break;case 3:this[u.name]=new Pe(_[0],_[1],_[2]);break;case 4:this[u.name]=new Le(_[0],_[1],_[2],_[3]);break;default:throw new Error("BaseMaterial:unkonwn color length.")}}break;case"textures":var c=o[l];for(a=0,s=c.length;a<s;a++){var d=c[a],f=d.path;f&&(this[d.name]=E.getRes(r[f]))}break;case"defines":var m=o[l];for(a=0,s=m.length;a<s;a++){var p=this._shaderCompile.getMaterialDefineByName(m[a]);this._addShaderDefine(p)}break;default:this[l]=o[l]}break;default:throw new Error("BaseMaterial:unkonwn version.")}this._endLoaded()},s._addReference=function(){t.prototype._addReference.call(this);for(var e=this._values.length,i=0,n=e;i<n;i++){var r=this._values[i];r&&r instanceof laya.d3.resource.BaseTexture&&r._addReference()}},s._removeReference=function(){t.prototype._removeReference.call(this);for(var e=this._values.length,i=0,n=e;i<n;i++){var r=this._values[i];r&&r instanceof laya.d3.resource.BaseTexture&&r._removeReference()}},s.disposeResource=function(){this.blendConstColor=null,this._shader=null,this._shaderValues=null;for(var t=this._values.length,e=0,i=t;e<i;e++){var n=this._values[e];n&&n instanceof laya.d3.resource.BaseTexture&&n._removeReference()}this._values=null},s.setShaderName=function(t){var e=Fi.nameKey.getID(t);if(-1===e)throw new Error("BaseMaterial: unknown shader name.");this._shaderCompile=ui._preCompileShader[e]},s.cloneTo=function(t){var e=t;e.name=this.name,e.cull=this.cull,e.blend=this.blend,e.srcBlend=this.srcBlend,e.dstBlend=this.dstBlend,e.srcBlendRGB=this.srcBlendRGB,e.dstBlendRGB=this.dstBlendRGB,e.srcBlendAlpha=this.srcBlendAlpha,e.dstBlendAlpha=this.dstBlendAlpha,this.blendConstColor.cloneTo(e.blendConstColor),e.blendEquation=this.blendEquation,e.blendEquationRGB=this.blendEquationRGB,e.blendEquationAlpha=this.blendEquationAlpha,e.depthTest=this.depthTest,e.depthWrite=this.depthWrite,e.renderQueue=this.renderQueue,e._shader=this._shader,e._disablePublicShaderDefine=this._disablePublicShaderDefine,e._shaderDefineValue=this._shaderDefineValue;var i=0,n=0,r=e._shaderValues;e._shaderValues.data.length=this._shaderValues.data.length;var a=this._values.length,s=e._values;for(s.length=a,i=0,n=a;i<n;i++){var o=this._values[i];if(o)if("number"==typeof o)s[i]=o,r.data[i]=o;else if("number"==typeof o&&Math.floor(o)==o)s[i]=o,r.data[i]=o;else if("boolean"==typeof o)s[i]=o,r.data[i]=o;else if(o instanceof laya.d3.math.Vector2){var l=s[i]||(s[i]=new Ne);o.cloneTo(l),r.data[i]=l.elements}else if(o instanceof laya.d3.math.Vector3){var h=s[i]||(s[i]=new Pe);o.cloneTo(h),r.data[i]=h.elements}else if(o instanceof laya.d3.math.Vector4){var u=s[i]||(s[i]=new Le);o.cloneTo(u),r.data[i]=u.elements}else if(o instanceof laya.d3.math.Matrix4x4){var _=s[i]||(s[i]=new Ae);o.cloneTo(_),r.data[i]=_.elements}else o instanceof laya.d3.resource.BaseTexture&&(s[i]=o,r.data[i]=o)}},s.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},a(0,s,"alphaTestValue",function(){return this._getNumber(0)},function(t){this._setNumber(0,t)}),a(0,s,"alphaTest",function(){return this._alphaTest},function(t){this._alphaTest=t,t?this._addShaderDefine(laya.d3.core.material.BaseMaterial.SHADERDEFINE_ALPHATEST):this._removeShaderDefine(laya.d3.core.material.BaseMaterial.SHADERDEFINE_ALPHATEST)}),e.__init__=function(){e.SHADERDEFINE_ALPHATEST=e.shaderDefines.registerDefine("ALPHATEST")},e.CULL_NONE=0,e.CULL_FRONT=1,e.CULL_BACK=2,e.BLEND_DISABLE=0,e.BLEND_ENABLE_ALL=1,e.BLEND_ENABLE_SEPERATE=2,e.BLENDPARAM_ZERO=0,e.BLENDPARAM_ONE=1,e.BLENDPARAM_SRC_COLOR=768,e.BLENDPARAM_ONE_MINUS_SRC_COLOR=769,e.BLENDPARAM_DST_COLOR=774,e.BLENDPARAM_ONE_MINUS_DST_COLOR=775,e.BLENDPARAM_SRC_ALPHA=770,e.BLENDPARAM_ONE_MINUS_SRC_ALPHA=771,e.BLENDPARAM_DST_ALPHA=772,e.BLENDPARAM_ONE_MINUS_DST_ALPHA=773,e.BLENDPARAM_SRC_ALPHA_SATURATE=776,e.BLENDEQUATION_ADD=0,e.BLENDEQUATION_SUBTRACT=1,e.BLENDEQUATION_REVERSE_SUBTRACT=2,e.DEPTHTEST_OFF=0,e.DEPTHTEST_NEVER=512,e.DEPTHTEST_LESS=513,e.DEPTHTEST_EQUAL=514,e.DEPTHTEST_LEQUAL=515,e.DEPTHTEST_GREATER=516,e.DEPTHTEST_NOTEQUAL=517,e.DEPTHTEST_GEQUAL=518,e.DEPTHTEST_ALWAYS=519,e.SHADERDEFINE_ALPHATEST=1,e.ALPHATESTVALUE=0,n(e,["shaderDefines",function(){return this.shaderDefines=new Be}]),e}(y),vi=function(t){function e(){this._type=0,this._width=0,this._height=0,this._size=null,this._repeat=!1,this._mipmap=!1,this._minFifter=0,this._magFifter=0,this._format=0,this._source=null,e.__super.call(this),this._conchTexture,D.isConchNode&&(this._conchTexture=new ConchTexture),this._repeat=!0,this.mipmap=!0,this.minFifter=-1,this.magFifter=-1}r(e,"laya.d3.resource.BaseTexture",t);var i=e.prototype;return a(0,i,"width",function(){return this._width}),a(0,i,"format",function(){return this._format}),a(0,i,"repeat",function(){return this._repeat},function(t){if(this._repeat!==t&&(this._repeat=t,this._source)){var e=P.mainContext;L.bindTexture(e,this._type,this._source);h.isPOT(this._width,this._height)&&this._repeat?(e.texParameteri(this._type,10242,10497),e.texParameteri(this._type,10243,10497)):(e.texParameteri(this._type,10242,33071),e.texParameteri(this._type,10243,33071))}}),a(0,i,"height",function(){return this._height}),a(0,i,"magFifter",function(){return this._magFifter},function(t){this._magFifter=t,t!=this._magFifter&&this._conchTexture&&this._conchTexture.setMaxFifter(t)}),a(0,i,"size",function(){return this._size}),a(0,i,"mipmap",function(){return this._mipmap},function(t){this._mipmap=t,this._mipmap!=t&&this._conchTexture&&this._conchTexture.setMipMap(t)}),a(0,i,"minFifter",function(){return this._minFifter},function(t){this._minFifter=t,this._minFifter!=t&&this._conchTexture&&this._conchTexture.setMinFifter(t)}),a(0,i,"source",function(){return this.activeResource(),this._source}),a(0,i,"defaulteTexture",function(){return sn.grayTexture}),e}(y),gi=function(t){function e(){this._subMeshCount=0,this._boundingBox=null,this._boundingSphere=null,this._boundingBoxCorners=null,this._positions=null,e.__super.call(this),this._boundingBoxCorners=s(8,null)}r(e,"laya.d3.resource.models.BaseMesh",t);var i=e.prototype;return i._getPositions=function(){throw new Error("未Override,请重载该属性！")},i._generateBoundingObject=function(){this._boundingSphere=new Se(new Pe,0),Se.createfromPoints(this._positions,this._boundingSphere),this._boundingBox=new xe(new Pe,new Pe),xe.createfromPoints(this._positions,this._boundingBox),this._boundingBox.getCorners(this._boundingBoxCorners)},i.getRenderElementsCount=function(){throw new Error("未Override,请重载该属性！")},i.getRenderElement=function(t){throw new Error("未Override,请重载该属性！")},a(0,i,"subMeshCount",function(){return this._subMeshCount}),a(0,i,"boundingBox",function(){return this._boundingBox}),a(0,i,"boundingBoxCorners",function(){return this._boundingBoxCorners}),a(0,i,"boundingSphere",function(){return this._boundingSphere}),e}(y),Ei=function(t){function e(){this._terrainHeightData=null,this._width=0,this._height=0,this._bitType=0,this._value=NaN,e.__super.call(this)}return r(e,"laya.d3.terrain.TerrainHeightData",t),e.prototype.onAsynLoaded=function(t,e,i){this._width=i[0],this._height=i[1],this._bitType=i[2],this._value=i[3];var n,r=NaN;8==this._bitType?(n=new Uint8Array(e),r=1/255):16==this._bitType&&(n=new Int16Array(e),r=1/32766),this._terrainHeightData=new Float32Array(this._height*this._width);for(var a=0,s=this._height*this._width;a<s;a++)this._terrainHeightData[a]=n[a]*r*this._value/2;this._endLoaded()},e.load=function(t,n,r,a,s){return i.loader.create(t,null,null,e,[n,r,a,s],1,!1)},e}(y),xi=function(t){function e(){this._version=NaN,this._cameraCoordinateInverse=!1,this._gridSize=NaN,this._chunkNumX=0,this._chunkNumZ=0,this._heightDataX=0,this._heightDataZ=0,this._heightDataBitType=0,this._heightDataValue=NaN,this._heightDataUrl=null,this._detailTextureInfos=null,this._chunkInfos=null,this._heightData=null,this._materialInfo=null,this._alphaMaps=null,this._normalMaps=null,e.__super.call(this)}r(e,"laya.d3.terrain.TerrainRes",t);var n=e.prototype;return n.parseData=function(t){var e=t[0],i=t[1];if(this._version=e.version,1==this._version){this._cameraCoordinateInverse=e.cameraCoordinateInverse,this._gridSize=e.gridSize,this._chunkNumX=e.chunkNumX,this._chunkNumZ=e.chunkNumZ;var n=e.heightData;if(this._heightDataX=n.numX,this._heightDataZ=n.numZ,this._heightDataBitType=n.bitType,this._heightDataValue=n.value,this._heightDataUrl=i[n.url],this._materialInfo=new Xe,e.material){var r=e.material.ambient,a=e.material.diffuse,o=e.material.specular;this._materialInfo.ambientColor=new Pe(r[0],r[1],r[2]),this._materialInfo.diffuseColor=new Pe(a[0],a[1],a[2]),this._materialInfo.specularColor=new Le(o[0],o[1],o[2],o[3])}var l=e.detailTexture;this._detailTextureInfos=s(l.length);for(var h=0;h<l.length;h++){var u=l[h],_=new We;_.diffuseTexture=i[u.diffuse],_.normalTexture=u.normal?i[u.normal]:null,u.scale?_.scale=new Ne(u.scale[0],u.scale[1]):_.scale=new Ne(1,1),u.offset?_.offset=new Ne(u.offset[0],u.offset[1]):_.offset=new Ne(0,0),this._detailTextureInfos[h]=_}var c=e.alphaMap;for(this._alphaMaps=s(c.length),h=0;h<this._alphaMaps.length;h++)this._alphaMaps[h]=e.alphaMap[h];var d=e.normalMap;for(this._normalMaps=s(d.length),h=0;h<this._normalMaps.length;h++)this._normalMaps[h]=e.normalMap[h];var f=e.chunkInfo;if(this._chunkNumX*this._chunkNumZ!=f.length)return alert("terrain data error"),!1;for(this._chunkInfos=s(f.length),h=0;h<f.length;h++){var m=f[h],p=new ke,v=m.alphaMap.length,g=m.detailID.length;if(v!=g)return alert("terrain chunk data error"),!1;p.alphaMap=s(v),p.detailID=s(g),p.normalMap=i[this._normalMaps[m.normalMap]];for(var x=0;x<v;x++){p.alphaMap[x]=i[this._alphaMaps[m.alphaMap[x]]];var T=m.detailID[x],S=T.length;p.detailID[x]=new Uint8Array(S);for(var D=0;D<S;D++)p.detailID[x][D]=T[D]}this._chunkInfos[h]=p}this._heightData=E.getRes(this._heightDataUrl),this.onLoadTerrainComplete(this._heightData)}return!0},n.onLoadTerrainComplete=function(t){this._endLoaded()},n.onAsynLoaded=function(t,e,i){this.parseData(e)},e.load=function(t){return i.loader.create(t,null,null,e,null,1,!1)},e}(y),Ti=function(t){function e(){this._player=null,this._templet=null,e.__super.call(this),this._player=new o}r(e,"laya.d3.component.animation.KeyframeAnimations",t);var n=e.prototype;return n._updateAnimtionPlayer=function(){this._player._update(i.timer.delta)},n._addUpdatePlayerToTimer=function(){i.timer.frameLoop(1,this,this._updateAnimtionPlayer)},n._removeUpdatePlayerToTimer=function(){i.timer.clear(this,this._updateAnimtionPlayer)},n._onOwnerActiveHierarchyChanged=function(t){this._owner.displayedInStage&&(t?this._addUpdatePlayerToTimer():this._removeUpdatePlayerToTimer())},n._load=function(t){t.activeInHierarchy&&this._addUpdatePlayerToTimer(),t.on("activeinhierarchychanged",this,this._onOwnerActiveHierarchyChanged)},n._unload=function(e){t.prototype._unload.call(this,e),e.activeInHierarchy&&this._removeUpdatePlayerToTimer(),e.off("activeinhierarchychanged",this,this._onOwnerActiveHierarchyChanged),this._player._destroy(),this._player=null,this._templet=null},a(0,n,"url",null,function(t){console.log("Warning: discard property,please use templet property instead.");var e=i.loader.create(t,null,null,l);this._templet!==e&&(0!==this._player.state&&this._player.stop(!0),this._templet=e,this._player.templet=e,this.event("animationchanged",this))}),a(0,n,"player",function(){return this._player}),a(0,n,"templet",function(){return this._templet},function(t){this._templet!==t&&(0!==this._player.state&&this._player.stop(!0),this._templet=t,this._player.templet=t,this.event("animationchanged",this))}),a(0,n,"currentFrameIndex",function(){return this._player.currentKeyframeIndex}),a(0,n,"currentAnimationClipIndex",function(){return this._player.currentAnimationClipIndex}),a(0,n,"nodeCount",function(){return this._templet.getNodeCount(this._player.currentAnimationClipIndex)}),e}(Je),Si=function(t){function e(){e.__super.call(this),this._clipNames=[],this._clips=[],this._playStartFrames=[],this._playEndFrames=[],this._cacheNodesSpriteOwners=[],this._cacheNodesAvatarOwners=[],this._cacheNodesDefaultlValues=[],this._cacheNodesToSpriteMap=[],this._cacheSpriteToNodesMap=[],this._cacheFullFrames=[],this._publicClipsDatas=[],this._playEventIndex=-1,this._updateTransformPropertyLoopCount=-1,this._lastFrameIndex=-1,this._defaultClipIndex=-1,this._cachePlayRate=1,this._currentPlayClip=null,this._currentFrameIndex=-1,this._currentTime=0,this._elapsedPlaybackTime=0,this._startUpdateLoopCount=-1,this.isCache=!0,this.cacheFrameRate=60,this.playbackRate=1,this.playOnWake=!0}r(e,"laya.d3.component.Animator",t);var s=e.prototype;return i.imps(s,{"laya.resource.IDestroy":!0}),s._getAvatarOwnersByClip=function(t){var e=this._clips[t]._nodes,i=e.length,n=this._cacheNodesAvatarOwners[t];n.length=i;var r=this._cacheNodesDefaultlValues[t];r.length=i;for(var a=0;a<i;a++){for(var s=this._avatarNodes[0],o=e[a],l=o.path,h=0,u=l.length;h<u;h++){var _=l[h];if(""===_)break;if(!(s=s.getChildByName(_)))break}if(s){n[a]=s;var c=B._propertyGetFuncs[o.propertyNameID](s);if(c){var d=new Float32Array(o.keyFrameWidth);for(r[a]=d,h=0,u=c.length;h<u;h++)d[h]=c[h]}}}},s._handleSpriteOwnersByClip=function(t){var e=this._clips[t]._nodes,i=e.length,n=this._cacheNodesSpriteOwners[t];n.length=i;var r=this._cacheNodesDefaultlValues[t];r.length=i;for(var a=0;a<i;a++){var s=this._owner,o=e[a],l=o.path,h=0,u=0;for(h=0,u=l.length;h<u;h++){var _=l[h];if(""===_)break;if(!(s=s.getChildByName(_)))break}if(s){n[a]=s;var c=B._propertyGetFuncs[o.propertyNameID](null,s);if(c){var d=new Float32Array(o.keyFrameWidth);for(r[a]=d,h=0,u=c.length;h<u;h++)d[h]=c[h]}}}},s._offClipAndAvatarRelateEvent=function(t,e){t.loaded?e.loaded||e.off("loaded",this,this._getAvatarOwnersByClip):t.off("loaded",this,this._getAvatarOwnersAndInitDatasAsync)},s._getAvatarOwnersByClipAsync=function(t,e){e.loaded?this._getAvatarOwnersByClip(t):e.once("loaded",this,this._getAvatarOwnersByClip,[t])},s._offGetSpriteOwnersByClipAsyncEvent=function(t){t.loaded||t.off("loaded",this,this._getSpriteOwnersByClipAsync)},s._getSpriteOwnersByClipAsync=function(t,e){e.loaded?this._handleSpriteOwnersByClip(t):e.once("loaded",this,this._handleSpriteOwnersByClip,[t])},s._getAvatarOwnersAndInitDatasAsync=function(){for(var t=0,e=this._clips.length;t<e;t++)this._getAvatarOwnersByClipAsync(t,this._clips[t]);for(this._avatar._cloneDatasToAnimator(this),t=0,e=this._avatarNodes.length;t<e;t++)this._checkAnimationNode(this._avatarNodes[t],this._owner)},s._offGetClipCacheFullKeyframeIndicesEvent=function(t){t.loaded||t.off("loaded",this,this._computeCacheFullKeyframeIndices)},s._computeCacheFullKeyframeIndices=function(t){var e=this._clips[t],i=this._cacheFrameRateInterval*this._cachePlayRate,n=e._getFullKeyframeIndicesWithCache(i);if(n)return void(this._cacheFullFrames[t]=n);n=this._cacheFullFrames[t]=[];var r=e._nodes,a=r.length;n.length=a;for(var s=Math.ceil(e._duration/i+1e-5)+1,o=0;o<a;o++){for(var l=r[o],h=new Int32Array(s),u=-1,_=l.keyFrames,c=0,d=_.length;c<d;c++){var f=_[c],m=f.startTime,p=m+f.duration;do{for(var v=Math.ceil(m/i-1e-5),g=u+1;g<v;g++)h[g]=-1;h[v]=c,u=v,m+=i}while(m<p)}n[o]=h}e._cacheFullKeyframeIndices(i,n)},s._updateAnimtionPlayer=function(){this._updatePlayer(i.timer.delta/1e3)},s._onOwnerActiveHierarchyChanged=function(){this._owner.activeInHierarchy?(i.timer.frameLoop(1,this,this._updateAnimtionPlayer),this.playOnWake&&this.clip&&this.play()):(0!==this.playState&&(this._stoped=!0),i.timer.clear(this,this._updateAnimtionPlayer))},s._eventScript=function(t,e){for(var i=this._currentPlayClip._animationEvents,n=i.length;this._playEventIndex<n;this._playEventIndex++){var r=i[this._playEventIndex],a=r.time;if(!(t<=a&&a<e))break;for(var s=this._owner._scripts,o=0,l=s.length;o<l;o++){var h=s[o],u=h[r.eventName];u&&u.apply(h,r.params)}}},s._setPlayParams=function(t,e){var i=this._currentTime;this._currentTime=t,this._currentFrameIndex=Math.floor(this.currentPlayTime/e+1e-5),this._currentFrameTime=this._currentFrameIndex*e,this._eventScript(i,t)},s._setPlayParamsWhenStop=function(t,e){var i=this._currentTime;this._currentTime=t,this._currentFrameIndex=Math.floor(t/e+1e-5),this._currentFrameTime=this._currentFrameIndex*e,this._eventScript(i,t),this._currentPlayClip=null},s._revertKeyframeNodes=function(t,e){if(this._avatar)for(var i=this._cacheNodesDefaultlValues[e],n=t._nodes,r=this._cacheNodesAvatarOwners[e],a=0,s=r.length;a<s;a++){var o=r[a];o&&B._propertySetFuncs[n[a].propertyNameID](o,null,i[a])}},s._onAnimationStop=function(){var t,e,i,n=0,r=0;this._lastFrameIndex=-1;var a=this._currentPlayClip._nodes;if(this._avatar){var s=this._cacheNodesAvatarOwners[this._currentPlayClipIndex];for(n=0,r=s.length;n<r;n++){var o=s[n];t=a[n],e=t.keyFrames,i=e[e.length-1].data,o&&B._propertySetFuncs[t.propertyNameID](o,null,i)}}else{var l=this._cacheNodesSpriteOwners[this._currentPlayClipIndex];for(n=0,r=l.length;n<r;n++){var h=l[n];t=a[n],e=t.keyFrames,i=e[e.length-1].data,h&&B._propertySetFuncs[t.propertyNameID](null,h,i)}}},s._setAnimationClipPropertyToAnimationNode=function(t,e,i){for(var n=0,r=e.length;n<r;n++){var a=e[n],s=t[a];if(s){var o=this._currentPlayClip._nodes[a],l=i[a];l&&B._propertySetFuncs[o.propertyNameID](s,null,l)}}},s._setAnimationClipPropertyToSprite3D=function(t,e){for(var i=0,n=t.length;i<n;i++){var r=t[i];if(r){var a=this._currentPlayClip._nodes[i],s=e[i];s&&B._propertySetFuncs[a.propertyNameID](null,r,s)}}},s._handleSpriteOwnersBySprite=function(t,e,i,n){var r=this._clips[t],a=i.join("/"),s=r._nodesMap[a];if(s)for(var o=this._cacheNodesSpriteOwners[t],l=r._nodes,h=this._cacheNodesDefaultlValues[t],u=0,_=s.length;u<_;u++){var c=s[u],d=l.indexOf(c);if(e){o[d]=n;var f=B._propertyGetFuncs[c.propertyNameID](null,n);if(f){var m=h[d];m||(h[d]=m=new Float32Array(c.keyFrameWidth));for(var p=0,v=f.length;p<v;p++)m[p]=f[p]}}else o[d]=null}},s._evaluateAvatarNodesCacheMode=function(t,i,n,r,a){i._evaluateAnimationlDatasCacheMode(t,this._cacheFullFrames[this._currentPlayClipIndex],this,n,a),this._setAnimationClipPropertyToAnimationNode(t,a,n);for(var s=0,o=this._avatarNodes.length;s<o;s++){var l=this._avatarNodes[s],h=l.transform;if(h._worldUpdate){var u=new Float32Array(16);r[s]=u,h._setWorldMatrixAndUpdate(u)}else r[s]=e.nanData}},s._evaluateAvatarNodesRealTime=function(t,i,n,r,a){i._evaluateAnimationlDatasRealTime(t,this.currentPlayTime,n,a),this._setAnimationClipPropertyToAnimationNode(t,a,n);for(var s=0,o=this._avatarNodes.length;s<o;s++){var l=this._avatarNodes[s].transform;l._worldUpdate?l._setWorldMatrixNoUpdate(r[s]):r[s]=e.nanData}},s._updateAvatarNodesToSpriteCacheMode=function(t,i){for(var n=0,r=this._cacheSpriteToNodesMap.length;n<r;n++){var a=this._cacheSpriteToNodesMap[n],s=i[a];if(s!==e.nanData){var o=this._avatarNodes[a].transform._entity,l=o.worldMatrix;qe.matrix4x4MultiplyMFM(this._owner._transform.worldMatrix,s,l),o.worldMatrix=l}}},s._updateAvatarNodesToSpriteRealTime=function(){for(var t=0,i=this._cacheSpriteToNodesMap.length;t<i;t++){var n=this._avatarNodes[this._cacheSpriteToNodesMap[t]],r=n.transform._entity,a=n.transform;if(a._worldUpdate){var s=e._tempMatrix4x40;a._setWorldMatrixAndUpdate(s);var o=r.worldMatrix;qe.matrix4x4MultiplyMFM(this._owner._transform.worldMatrix,s,o),r.worldMatrix=o}}},s._updatePlayer=function(t){if(null!=this._currentPlayClip&&!this._stoped&&this._currentPlayClip.loaded){var e=this._cacheFrameRateInterval*this._cachePlayRate,i=0;this._startUpdateLoopCount!==C.loopCount&&(i=t*this.playbackRate,this._elapsedPlaybackTime+=i);var n=this._currentPlayClip._frameRate,r=this._playStartFrames[this._currentPlayClipIndex]/n,a=Math.min(this._playEndFrames[this._currentPlayClipIndex]/n,this._currentPlayClip._duration),s=a-r;if(!this._currentPlayClip.islooping&&this._elapsedPlaybackTime>=s)return this._onAnimationStop(),this._setPlayParamsWhenStop(s,e),void this.event("stopped");if(i+=this._currentTime,s>0)if(i>=s)do{i-=s,i<s&&(this._setPlayParams(i,e),this.event("complete")),this._playEventIndex=0,this._eventScript(0,i)}while(i>=s);else this._setPlayParams(i,e);else this._currentTime=this._currentFrameTime=this._currentFrameIndex=this._playEventIndex=0,this.event("complete")}},s._update=function(t){var e=this._currentPlayClip;if(2===this.playState&&e&&e.loaded){var n=this.playbackRate*i.timer.scale,r=this._cachePlayRate;this._canCache=this.isCache&&n>=r;var a,s=-1;if(this._canCache){if(s=this._currentFrameIndex,this._lastFrameIndex===s)return;if(a=e._getAnimationDataWithCache(r,s),this._avatar){var o=this._cacheNodesAvatarOwners[this._currentPlayClipIndex],l=e._cachePropertyMap,h=l.length;h>0&&(a||(a=[],a.length=h,e._cacheAnimationData(r,s,a),e._evaluateAnimationlDatasCacheMode(o,this._cacheFullFrames[this._currentPlayClipIndex],this,a,l)),this._setAnimationClipPropertyToAnimationNode(o,l,a)),this._curAvatarNodeDatas=e._getAvatarDataWithCache(this._avatar,this._cachePlayRate,s),this._curAvatarNodeDatas||(this._curAvatarNodeDatas=[],this._curAvatarNodeDatas.length=this._avatarNodes.length,e._cacheAvatarData(this._avatar,this._cachePlayRate,s,this._curAvatarNodeDatas),this._evaluateAvatarNodesCacheMode(o,e,e._publicClipDatas,this._curAvatarNodeDatas,e._unCachePropertyMap)),this._updateAvatarNodesToSpriteCacheMode(e,this._curAvatarNodeDatas)}else{var u=this._cacheNodesSpriteOwners[this._currentPlayClipIndex];a||(a=[],a.length=this._currentPlayClip._nodes.length,e._evaluateAnimationlDatasCacheMode(u,this._cacheFullFrames[this._currentPlayClipIndex],this,a,null),e._cacheAnimationData(r,s,a)),this._setAnimationClipPropertyToSprite3D(u,a)}}else if(a=e._publicClipDatas,this._avatar){if(e._evaluateAnimationlDatasRealTime(this._cacheNodesAvatarOwners[this._currentPlayClipIndex],this.currentPlayTime,a,e._cachePropertyMap),!this._publicAvatarNodeDatas){this._publicAvatarNodeDatas=[];var _=this._avatarNodes.length;this._publicAvatarNodeDatas.length=_;for(var c=1;c<_;c++)this._publicAvatarNodeDatas[c]=new Float32Array(16)}this._curAvatarNodeDatas=this._publicAvatarNodeDatas,this._evaluateAvatarNodesRealTime(this._cacheNodesAvatarOwners[this._currentPlayClipIndex],e,a,this._curAvatarNodeDatas,e._unCachePropertyMap),this._updateAvatarNodesToSpriteRealTime()}else e._evaluateAnimationlDatasRealTime(this._cacheNodesSpriteOwners[this._currentPlayClipIndex],this.currentPlayTime,a,null);this._lastFrameIndex=s}},s._checkAnimationNode=function(t,e){t.name!==e.name||e._transform.dummy||e._isLinkSpriteToAnimationNode(this,t,!0);for(var i=0,n=e._childs.length;i<n;i++)this._checkAnimationNode(t,e.getChildAt(i))},s._load=function(t){t.activeInHierarchy&&i.timer.frameLoop(1,this,this._updateAnimtionPlayer),this._owner.on("activeinhierarchychanged",this,this._onOwnerActiveHierarchyChanged)},s._unload=function(e){t.prototype._unload.call(this,e),e.activeInHierarchy&&i.timer.clear(this,this._updateAnimtionPlayer),this._owner.off("activeinhierarchychanged",this,this._onOwnerActiveHierarchyChanged),this._curAvatarNodeDatas=null},s._destroy=function(){t.prototype._destroy.call(this);for(var e=0,i=this._clips.length;e<i;e++)this._clips[e]._removeReference();this._currentPlayClip=null,this._clipNames=null,this._cacheNodesSpriteOwners=null,this._cacheNodesAvatarOwners=null,this._cacheNodesDefaultlValues=null,this._clips=null,this._cacheFullFrames=null},s._cloneTo=function(t){var e=t;e.avatar=this.avatar;for(var i=(this._clips.length,0),n=this._clips.length;i<n;i++)e.addClip(this._clips[i]);this.clip&&(e.clip=this.clip)},s.addClip=function(t,e,i,n){void 0===i&&(i=0),void 0===n&&(n=4294967295),e=e||t.name;var r=this._clipNames.indexOf(e);if(-1!==r){if(this._clips[r]!==t)throw new Error("Animation:this playName has exist with another clip.")}else{var a=this._clips.indexOf(t);if(i<0||n<0)throw new Error("Animator:startFrame and endFrame must large than zero.");if(i>n)throw new Error("Animator:startFrame must less than endFrame.");this._clipNames.push(e),this._clips.push(t),this._playStartFrames.push(i),this._playEndFrames.push(n),this._cacheNodesSpriteOwners.push([]),this._cacheNodesAvatarOwners.push([]),this._cacheNodesDefaultlValues.push([]),this._publicClipsDatas.push([]),t._addReference(),a=this._clips.length-1,this._avatar?this._avatar.loaded?this._getAvatarOwnersByClipAsync(a,t):this._avatar.once("loaded",this,this._getAvatarOwnersByClipAsync,[a,t]):this._getSpriteOwnersByClipAsync(a,t),t.loaded?this._computeCacheFullKeyframeIndices(a):t.once("loaded",this,this._computeCacheFullKeyframeIndices,[a])}},s.removeClip=function(t){var e=this._clips.indexOf(t);-1!==e&&(this._avatar?this._offClipAndAvatarRelateEvent(this._avatar,t):this._offGetSpriteOwnersByClipAsyncEvent(t),this._offGetClipCacheFullKeyframeIndicesEvent(t),this._clipNames.splice(e,1),this._clips.splice(e,1),this._playStartFrames.splice(e,1),this._playEndFrames.splice(e,1),this._cacheNodesSpriteOwners.splice(e,1),this._cacheNodesAvatarOwners.splice(e,1),this._cacheNodesDefaultlValues.splice(e,1),this._publicClipsDatas.splice(e,1),t._removeReference())},s.removeClipByName=function(t){var e=this._clipNames.indexOf(t);if(-1!==e){var i=this._clips[e];this._avatar?this._offClipAndAvatarRelateEvent(this._avatar,i):this._offGetSpriteOwnersByClipAsyncEvent(i),this._offGetClipCacheFullKeyframeIndicesEvent(i),this._clipNames.splice(e,1),this._clips.splice(e,1),this._playStartFrames.splice(e,1),this._playEndFrames.splice(e,1),this._cacheNodesSpriteOwners.splice(e,1),this._cacheNodesAvatarOwners.splice(e,1),this._cacheNodesDefaultlValues.splice(e,1),this._publicClipsDatas.splice(e,1)}},s.getClip=function(t){var e=this._clipNames.indexOf(t);return-1!==e?this._clips[e]:null},s.getClipCount=function(){return this._clips.length},s.play=function(t,e){if(void 0===e&&(e=1),!t&&-1==this._defaultClipIndex)throw new Error("Animator:must have  default clip value,please set clip property.");t?(this._currentPlayClipIndex=this._clipNames.indexOf(t),this._currentPlayClip=this._clips[this._currentPlayClipIndex]):(this._currentPlayClipIndex=this._defaultClipIndex,this._currentPlayClip=this._clips[this._defaultClipIndex]),this._currentTime=0,this._currentFrameTime=0,this._elapsedPlaybackTime=0,this._playEventIndex=0,this.playbackRate=e,this._stoped=!1,this._currentFrameIndex=0,this._startUpdateLoopCount=C.loopCount,this._lastPlayAnimationClip&&this._lastPlayAnimationClip!==this._currentPlayClip&&this._revertKeyframeNodes(this._lastPlayAnimationClip,this._lastPlayAnimationClipIndex),this._updatePlayer(0),this._lastPlayAnimationClip=this._currentPlayClip,this._lastPlayAnimationClipIndex=this._currentPlayClipIndex},s.stop=function(){0!==this.playState&&(this._stoped=!0,this.event("stopped"))},s.linkSprite3DToAvatarNode=function(t,e){if(this._avatar){var i=this._avatarNodeMap[t];return!!i&&(e._isLinkSpriteToAnimationNode(this,i,!0),!0)}return!1},s.unLinkSprite3DToAvatarNode=function(t){if(this._avatar){var e=t.transform.dummy;if(e){var i=this._avatarNodeMap[e._owner.name];return t._isLinkSpriteToAnimationNode(this,i,!1),!0}return!1}return!1},a(0,s,"playState",function(){return null==this._currentPlayClip?0:this._stoped?0:2}),a(0,s,"avatar",function(){return this._avatar},function(t){if(this._avatar!==t){var e=this._avatar;this._avatar=t;for(var i=this._clips.length,n=0;n<i;n++)this._offClipAndAvatarRelateEvent(e,this._clips[n]);t&&(t.loaded?this._getAvatarOwnersAndInitDatasAsync():t.once("loaded",this,this._getAvatarOwnersAndInitDatasAsync))}}),a(0,s,"cacheFrameRate",function(){return this._cacheFrameRate},function(t){if(this._cacheFrameRate!==t){this._cacheFrameRate=t,this._cacheFrameRateInterval=1/this._cacheFrameRate;for(var e=0,i=this._clips.length;e<i;e++)this._clips[e].loaded&&this._computeCacheFullKeyframeIndices(e)}}),a(0,s,"clip",function(){return this._clips[this._defaultClipIndex]},function(t){var e=t?this._clips.indexOf(t):-1;this._defaultClipIndex!==e&&(-1!==this._defaultClipIndex&&this.removeClip(this._clips[this._defaultClipIndex]),-1!==e&&this.addClip(t,t.name),this._defaultClipIndex=e)}),a(0,s,"currentFrameIndex",function(){return this._currentFrameIndex}),a(0,s,"cachePlayRate",function(){return this._cachePlayRate},function(t){if(this._cachePlayRate!==t){this._cachePlayRate=t;for(var e=0,i=this._clips.length;e<i;e++)this._clips[e].loaded&&this._computeCacheFullKeyframeIndices(e)}}),a(0,s,"currentFrameTime",function(){return this._currentFrameTime}),a(0,s,"currentPlayClip",function(){return this._currentPlayClip}),a(0,s,"currentPlayTime",function(){return this._currentTime+this._playStartFrames[this._currentPlayClipIndex]/this._currentPlayClip._frameRate}),a(0,s,"playbackTime",null,function(t){if(null!=this._currentPlayClip&&this._currentPlayClip&&this._currentPlayClip.loaded){this._startUpdateLoopCount=C.loopCount;var e=this._cacheFrameRateInterval*this._cachePlayRate;this._currentTime=t,this._currentFrameIndex=Math.floor(this.currentPlayTime/e),this._currentFrameTime=this._currentFrameIndex*e}}),a(0,s,"paused",function(){return this._stoped},function(t){this._stoped=t,t&&this.event("paused")}),n(e,["nanData",function(){return this.nanData=new Float32Array},"_tempMatrix4x40",function(){return this._tempMatrix4x40=new Float32Array(16)}]),e}(Je),Di=(function(t){function e(){this._attachSkeleton=null,this._extenData=null,this.attachBones=null,this.matrixs=null,e.__super.call(this),this.attachBones=[],this.matrixs=[]}r(e,"laya.d3.component.AttachPoint",t);var i=e.prototype;i._load=function(e){t.prototype._load.call(this,e),this._attachSkeleton=e.getComponentByType(Qi)},i._update=function(t){if(this._attachSkeleton&&!this._attachSkeleton.destroyed&&0!==this._attachSkeleton.player.state&&this._attachSkeleton.curBonesDatas){var e=this._attachSkeleton.player,i=this._attachSkeleton.templet;this.matrixs.length=this.attachBones.length;for(var n=this._attachSkeleton.curBonesDatas,r=this.owner.transform.worldMatrix,a=0,s=this.attachBones.length;a<s;a++){var o=16*i.getNodeIndexWithName(e.currentAnimationClipIndex,this.attachBones[a]),l=this.matrixs[a];l||(l=this.matrixs[a]=new Ae);for(var h=l.elements,u=0;u<16;u++)h[u]=n[o+u];Ae.multiply(r,l,l)}this.event("complete")}}}(Je),function(t){function e(){e.__super.call(this),this._isRigidbody=!1,this._runtimeCollisonMap={},this._runtimeCollisonTestMap={},this._ignoreCollisonMap={},this.isTrigger=!0}r(e,"laya.d3.component.physics.Collider",t);var i=e.prototype;return i._clearCollsionMap=function(){for(var t in this._runtimeCollisonMap){var e=this._runtimeCollisonMap[t];delete e._runtimeCollisonMap[this.id],e._isRigidbody&&delete e._runtimeCollisonTestMap[this.id];var i=e.id;delete this._runtimeCollisonMap[i],this._isRigidbody&&delete this._runtimeCollisonTestMap[i]}},i._unload=function(t){for(var e in this._runtimeCollisonMap){var i=this._runtimeCollisonMap[e];delete i._runtimeCollisonMap[this.id],i._isRigidbody&&delete i._runtimeCollisonTestMap[this.id],delete this._ignoreCollisonMap[e]._ignoreCollisonMap[this.id]}},i._setIsRigidbody=function(t){if(this._isRigidbody!==t){this._isRigidbody=t;var e=this._owner;if(e.displayedInStage){var i=e.layer;i._removeCollider(this),i._addCollider(this)}}},i._getType=function(){return-1},i._collisonTo=function(t){return!1},i.raycast=function(t,e,i){throw void 0===i&&(i=1.79e308),new Error("Collider:Must override it.")},a(0,i,"enable",t.prototype._$get_enable,function(t){if(this._enable!==t){this._owner.displayedInStage&&(t||this._clearCollsionMap()),this._enable=t,this.event("enablechanged",this._enable)}}),a(0,i,"isSingleton",function(){return e._isSingleton}),e._isSingleton=!1,e}(Je)),Mi=function(t){function e(){e.__super.call(this)}r(e,"laya.d3.component.Rigidbody",t);var i=e.prototype;return a(0,i,"enable",t.prototype._$get_enable,function(t){if(this._enable!==t){for(var e=this._owner._colliders,i=0,n=e.length;i<n;i++){var r=e[i];r._setIsRigidbody(t);var a=r._runtimeCollisonMap,s=r._runtimeCollisonTestMap;if(!t)for(var o in a)delete s[o]}this._enable=t,this.event("enablechanged",this._enable)}}),e}(Je),yi=(function(t){function e(){e.__super.call(this)}r(e,"laya.d3.component.Script",t);var i=e.prototype;i.onTriggerEnter=function(t){},i.onTriggerExit=function(t){},i.onTriggerStay=function(t){},a(0,i,"isSingleton",function(){return e._isSingleton}),e._isSingleton=!1}(Je),function(t){function e(t){e.__super.call(this,t)}r(e,"laya.d3.core.GlitterRender",t);var i=e.prototype;return i._calculateBoundingBox=function(){var t=this._boundingBox.min.elements;t[0]=-Number.MAX_VALUE,t[1]=-Number.MAX_VALUE,t[2]=-Number.MAX_VALUE;var e=this._boundingBox.min.elements;e[0]=Number.MAX_VALUE,e[1]=Number.MAX_VALUE,e[2]=Number.MAX_VALUE},i._calculateBoundingSphere=function(){var t=this._boundingSphere.center.elements;t[0]=0,t[1]=0,t[2]=0,this._boundingSphere.radius=Number.MAX_VALUE},i._renderUpdate=function(t){this._setShaderValueMatrix4x4(0,this._owner.transform.worldMatrix);var e=this._owner.getProjectionViewWorldMatrix(t);this._setShaderValueMatrix4x4(1,e);var i=this._owner.templet;return this._setShaderValueNumber(3,i.lifeTime),this._setShaderValueNumber(2,i._currentTime),!0},e}(ei)),Ai=function(t){function e(t){this._owner=null,this._sharedMesh=null,e.__super.call(this),this._owner=t}r(e,"laya.d3.core.MeshFilter",t);var i=e.prototype;return i._sharedMeshLoaded=function(){this.event("loaded")},i._destroy=function(){t.prototype._destroy.call(this),this._owner=null,this._sharedMesh&&(this._sharedMesh._removeReference(),this._sharedMesh=null)},a(0,i,"sharedMesh",function(){return this._sharedMesh},function(t){var e=this._sharedMesh;e&&e._removeReference(),this._sharedMesh=t,t._addReference(),this.event("meshchanged",[this,e,t]),t.loaded||this._sharedMesh.once("loaded",this,this._sharedMeshLoaded)}),a(0,i,"_isAsyncLoaded",function(){return this._sharedMesh.loaded}),a(0,i,"_originalBoundingBoxCorners",function(){return this._sharedMesh.boundingBoxCorners}),a(0,i,"_originalBoundingSphere",function(){return this._sharedMesh.boundingSphere}),a(0,i,"_originalBoundingBox",function(){return this._sharedMesh.boundingBox}),e}(ti),Ii=function(t){function e(t){e.__super.call(this,t),t.meshFilter.on("meshchanged",this,this._onMeshChanged)}r(e,"laya.d3.core.MeshRender",t);var i=e.prototype;return i._onMeshChanged=function(t,e,i){i.loaded?this._boundingSphereNeedChange=this._boundingBoxNeedChange=this._boundingBoxCenterNeedChange=this._octreeNodeNeedChange=!0:i.once("loaded",this,this._onMeshLoaed)},i._onMeshLoaed=function(t,e){this._boundingSphereNeedChange=this._boundingBoxNeedChange=this._boundingBoxCenterNeedChange=this._octreeNodeNeedChange=!0},i._calculateBoundingSphereByInitSphere=function(t){var e=NaN,i=this._owner.transform,n=i.scale.elements,r=Math.abs(n[0]),a=Math.abs(n[1]),s=Math.abs(n[2]);e=r>=a&&r>=s?r:a>=s?a:s,Pe.transformCoordinate(t.center,i.worldMatrix,this._boundingSphere.center),this._boundingSphere.radius=t.radius*e},i._calculateBoundBoxByInitCorners=function(t){for(var e=this._owner.transform.worldMatrix,i=0;i<8;i++)Pe.transformCoordinate(t[i],e,ei._tempBoundBoxCorners[i]);xe.createfromPoints(ei._tempBoundBoxCorners,this._boundingBox)},i._calculateBoundingSphere=function(){var t=this._owner.meshFilter.sharedMesh;null==t||null==t.boundingSphere?this._boundingSphere.toDefault():this._calculateBoundingSphereByInitSphere(t.boundingSphere)},i._calculateBoundingBox=function(){var t=this._owner.meshFilter.sharedMesh;null==t||null==t.boundingBox?this._boundingBox.toDefault():this._calculateBoundBoxByInitCorners(t.boundingBoxCorners)},i._renderUpdate=function(t){var e=this._owner.transform;if(e){this._setShaderValueMatrix4x4(0,e.worldMatrix);var i=this._owner.getProjectionViewWorldMatrix(t);this._setShaderValueMatrix4x4(1,i)}else this._setShaderValueMatrix4x4(0,Ae.DEFAULT),this._setShaderValueMatrix4x4(1,t);return Qe.debugMode&&this._renderRenderableBoundBox(),!0},e}(ei),Ri=function(t){function e(t){e.__super.call(this),this._tempRotationMatrix=new Ae,this._uvLength=new Ne,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._owner=t,this._ownerRender=t.particleRender,this._boundingBoxCorners=s(8,null),this._boundingSphere=new Se(new Pe,Number.MAX_VALUE),this._boundingBox=new xe(new Pe(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),new Pe(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)),this._currentTime=0,this._isEmitting=!1,this._isPlaying=!1,this._isPaused=!1,this._burstsIndex=0,this._frameRateTime=0,this._emissionTime=0,this._totalDelayTime=0,this._simulateUpdate=!1,this._bufferMaxParticles=1,this.duration=5,this.looping=!0,this.prewarm=!1,this.startDelayType=0,this.startDelay=0,this.startDelayMin=0,this.startDelayMax=0,this._startLifetimeType=0,this._startLifetimeConstant=5,this._startLifeTimeGradient=new $,this._startLifetimeConstantMin=0,this._startLifetimeConstantMax=5,this._startLifeTimeGradientMin=new $,this._startLifeTimeGradientMax=new $,this._maxStartLifetime=5,this.startSpeedType=0,this.startSpeedConstant=5,this.startSpeedConstantMin=0,this.startSpeedConstantMax=5,this.threeDStartSize=!1,this.startSizeType=0,this.startSizeConstant=1,this.startSizeConstantSeparate=new Pe(1,1,1),this.startSizeConstantMin=0,this.startSizeConstantMax=1,this.startSizeConstantMinSeparate=new Pe(0,0,0),this.startSizeConstantMaxSeparate=new Pe(1,1,1),this.threeDStartRotation=!1,this.startRotationType=0,this.startRotationConstant=0,this.startRotationConstantSeparate=new Pe(0,0,0),this.startRotationConstantMin=0,this.startRotationConstantMax=0,this.startRotationConstantMinSeparate=new Pe(0,0,0),this.startRotationConstantMaxSeparate=new Pe(0,0,0),this.randomizeRotationDirection=0,this.startColorType=0,this.startColorConstant=new Le(1,1,1,1),this.startColorConstantMin=new Le(1,1,1,1),this.startColorConstantMax=new Le(1,1,1,1),this.gravityModifier=0,this.simulationSpace=1,this.scaleMode=0,this.playOnAwake=!0,this._rand=new be(0),this.autoRandomSeed=!0,this.randomSeed=new Uint32Array(1),this._randomSeeds=new Uint32Array(e._RANDOMOFFSET.length),this.isPerformanceMode=!0,this._emission=new Y,this._emission.enbale=!0,this._owner.on("activeinhierarchychanged",this,this._onOwnerActiveHierarchyChanged)}r(e,"laya.d3.core.particleShuriKen.ShurikenParticleSystem",t);var o=e.prototype;return i.imps(o,{"laya.d3.core.render.IRenderable":!0,"laya.d3.core.IClone":!0}),o._getVertexBuffer=function(t){return void 0===t&&(t=0),0===t?this._vertexBuffer:null},o._getIndexBuffer=function(){return this._indexBuffer},o._generateBoundingSphere=function(){var t=this._boundingSphere.center.elements;t[0]=0,t[1]=0,t[2]=0,this._boundingSphere.radius=Number.MAX_VALUE},o._generateBoundingBox=function(){var t=this._owner,i=t.particleRender,n=this._boundingBox.min,r=this._boundingBox.max,a=0,s=0,o=NaN;switch(this.startLifetimeType){case 0:o=this.startLifetimeConstant;break;case 1:o=-Number.MAX_VALUE;var l=l;for(a=0,s=l.gradientCount;a<s;a++)o=Math.max(o,l.getValueByIndex(a));break;case 2:o=Math.max(this.startLifetimeConstantMin,this.startLifetimeConstantMax);break;case 3:o=-Number.MAX_VALUE;var h=h;for(a=0,s=h.gradientCount;a<s;a++)o=Math.max(o,h.getValueByIndex(a));var u=u;for(a=0,s=u.gradientCount;a<s;a++)o=Math.max(o,u.getValueByIndex(a))}var _=NaN,c=NaN;switch(this.startSpeedType){case 0:_=c=this.startSpeedConstant;break;case 1:break;case 2:_=this.startLifetimeConstantMin,c=this.startLifetimeConstantMax}var d,f,m,p;this._shape&&this._shape.enable||(d=f=Pe.ZERO,m=Pe.ZERO,p=Pe.UnitZ);var v=new Pe(m.x*_,m.y*_,m.z*_),g=new Pe(p.x*c,p.y*c,p.z*c);if(this._velocityOverLifetime&&this._velocityOverLifetime.enbale){var E=this._velocityOverLifetime.velocity;switch(E.type){case 0:E.constant;break;case 1:new Pe(E.gradientX.getAverageValue(),E.gradientY.getAverageValue(),E.gradientZ.getAverageValue());break;case 2:E.constantMin,E.constantMax;break;case 3:new Pe(E.gradientXMin.getAverageValue(),E.gradientYMin.getAverageValue(),E.gradientZMin.getAverageValue()),new Pe(E.gradientXMax.getAverageValue(),E.gradientYMax.getAverageValue(),E.gradientZMax.getAverageValue())}}var x,T,S=this._owner.transform,D=S.position,M=e._tempVector39,y=M.elements,A=i.renderMode;switch(this.scaleMode){case 0:var I=S.scale;x=I,y[0]=I.x,y[1]=I.z,y[2]=I.y,1===A&&(T=I);break;case 1:var R=S.localScale;x=R,y[0]=R.x,y[1]=R.z,y[2]=R.y,1===A&&(T=R);break;case 2:x=S.scale,y[0]=y[1]=y[2]=1,1===A&&(T=Pe.ONE)}var C,b;switch(this._velocityOverLifetime&&this._velocityOverLifetime.enbale||(C=new Pe(v.x*o,v.y*o,v.z*o),b=new Pe(g.x*o,g.y*o,g.z*o),2!=this.scaleMode?(Pe.add(d,C,n),Pe.multiply(x,n,n),Pe.add(f,b,r),Pe.multiply(x,r,r)):(Pe.multiply(x,d,n),Pe.add(n,C,n),Pe.multiply(x,f,r),Pe.add(r,b,r))),this.simulationSpace){case 0:break;case 1:Pe.add(n,D,n),Pe.add(r,D,r)}var w=NaN,N=NaN;switch(this.startSizeType){case 0:if(this.threeDStartSize){var P=P;w=Math.max(P.x,P.y),1===A&&(N=P.y)}else w=this.startSizeConstant,1===A&&(N=this.startSizeConstant);break;case 1:break;case 2:if(this.threeDStartSize){var L=L;w=Math.max(L.x,L.y),1===A&&(N=L.y)}else w=this.startSizeConstantMax,1===A&&(N=this.startSizeConstantMax)}if(this._sizeOverLifetime&&this._sizeOverLifetime.enbale){this._sizeOverLifetime.size;w*=this._sizeOverLifetime.size.getMaxSizeInGradient()}var O=e._tempVector30,V=O.elements,F=NaN,B=NaN;switch(A){case 0:F=w*e.halfKSqrtOf2,Pe.scale(M,w,O),Pe.subtract(n,O,n),Pe.add(r,O,r);break;case 1:var U=e._tempVector31,H=e._tempVector32,G=e._tempVector33,z=e._tempVector34;this._velocityOverLifetime&&this._velocityOverLifetime.enbale||(Pe.multiply(T,g,H),Pe.multiply(T,v,G));var k=N*i.stretchedBillboardLengthScale,W=Pe.scalarLength(H)*i.stretchedBillboardSpeedScale+k,X=Pe.scalarLength(G)*i.stretchedBillboardSpeedScale+k,Y=e._tempVector35,Z=e._tempVector36;Pe.normalize(H,Y),Pe.scale(Y,W,z),Pe.subtract(b,z,z),Pe.normalize(G,Z),Pe.scale(Z,X,U),Pe.add(C,U,U),F=w*e.halfKSqrtOf2,Pe.scale(M,F,O);var K=e._tempVector37,j=e._tempVector38;Pe.scale(Y,.5,K),Pe.scale(Z,.5,j),Pe.multiply(K,M,K),Pe.multiply(j,M,j),Pe.add(n,j,n),Pe.min(n,z,n),Pe.subtract(n,O,n),Pe.subtract(r,K,r),Pe.max(r,U,r),Pe.add(r,O,r);break;case 2:w*=Math.cos(.7853981633974483),B=.5*w,V[0]=M.x*B,V[1]=M.z*B,Pe.subtract(n,O,n),Pe.add(r,O,r);break;case 3:w*=Math.cos(.7853981633974483),B=.5*w,Pe.scale(M,B,O),Pe.subtract(n,O,n),Pe.add(r,O,r)}this._boundingBox.getCorners(this._boundingBoxCorners)},o._updateEmission=function(){if(i.stage.isVisibility&&this.isAlive)if(this._simulateUpdate)this._simulateUpdate=!1;else{var t=this._startUpdateLoopCount===C.loopCount||this._isPaused?0:i.timer.delta/1e3;t=Math.min(e._maxElapsedTime,t),this._updateParticles(t)}},o._updateParticles=function(t){(4!==this._ownerRender.renderMode||this._ownerRender.mesh)&&(this._currentTime+=t,this._retireActiveParticles(),this._freeRetiredParticles(),this._totalDelayTime+=t,this._totalDelayTime<this._playStartDelay||this._emission.enbale&&this._isEmitting&&!this._isPaused&&this._advanceTime(t,this._currentTime))},o._updateParticlesSimulationRestart=function(t){this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._burstsIndex=0,this._frameRateTime=t,this._emissionTime=0,this._totalDelayTime=0,this._currentTime=t;var e=t;if(e<this._playStartDelay)return void(this._totalDelayTime=e);this._emission.enbale&&this._advanceTime(t,t)},o._addUpdateEmissionToTimer=function(){i.timer.frameLoop(1,this,this._updateEmission)},o._removeUpdateEmissionToTimer=function(){i.timer.clear(this,this._updateEmission)},o._onOwnerActiveHierarchyChanged=function(t){this._owner.displayedInStage&&(t?this._addUpdateEmissionToTimer():this._removeUpdateEmissionToTimer())},o._retireActiveParticles=function(){for(;this._firstActiveElement!=this._firstNewElement;){var t=this._firstActiveElement*this._floatCountPerVertex*this._vertexStride,e=t+this._timeIndex;if(this._currentTime-this._vertices[e]+1e-4<this._vertices[t+this._startLifeTimeIndex])break;this._vertices[e]=this._drawCounter,this._firstActiveElement++,this._firstActiveElement>=this._bufferMaxParticles&&(this._firstActiveElement=0)}},o._freeRetiredParticles=function(){for(;this._firstRetiredElement!=this._firstActiveElement;){var t=this._drawCounter-this._vertices[this._firstRetiredElement*this._floatCountPerVertex*this._vertexStride+this._timeIndex];if(this.isPerformanceMode&&t<3)break;this._firstRetiredElement++,this._firstRetiredElement>=this._bufferMaxParticles&&(this._firstRetiredElement=0)}},o._burst=function(t,e){for(var i=0,n=this._emission._bursts,r=n.length;this._burstsIndex<r;this._burstsIndex++){var a=n[this._burstsIndex],s=a.time;if(!(t<=s&&s<e))break;var o=0;this.autoRandomSeed?o=T.lerp(a.minCount,a.maxCount,Math.random()):(this._rand.seed=this._randomSeeds[0],o=T.lerp(a.minCount,a.maxCount,this._rand.getFloat()),this._randomSeeds[0]=this._rand.seed),i+=o}return i},o._advanceTime=function(t,e){var i=0,n=this._emissionTime;this._emissionTime+=t;var r=0;if(this._emissionTime>this.duration){if(!this.looping){for(r=Math.min(this.maxParticles-this.aliveParticleCount,r),i=0;i<r;i++)this.emit(e);return this._isPlaying=!1,void this.stop()}r+=this._burst(n,this._emissionTime),this._emissionTime-=this.duration,this.event("complete"),this._burstsIndex=0,r+=this._burst(0,this._emissionTime)}else r+=this._burst(n,this._emissionTime);for(r=Math.min(this.maxParticles-this.aliveParticleCount,r),i=0;i<r;i++)this.emit(e);var a=this.emission.emissionRate;if(a>0){var s=1/a;for(this._frameRateTime+=s,this._frameRateTime=this._currentTime-(this._currentTime-this._frameRateTime)%this._maxStartLifetime;this._frameRateTime<=e&&this.emit(this._frameRateTime);)this._frameRateTime+=s;this._frameRateTime=Math.floor(e/s)*s}},o._initBufferDatas=function(){this._vertexBuffer&&(this._vertexBuffer.destroy(),this._indexBuffer.destroy());var t=this._ownerRender,e=t.renderMode;if(-1!==e&&this.maxParticles>0){var i,n,r=0,a=0,s=0,o=0,l=0,h=t.mesh;if(4===e){if(h){var u=h._vertexBuffers.length;if(u>1)throw new Error("ShurikenParticleSystem: submesh Count mesh be One or all subMeshes have the same vertexDeclaration.");n=me.vertexDeclaration,this._floatCountPerVertex=n.vertexStride/4,this._startLifeTimeIndex=12,this._timeIndex=16,this._vertexStride=h._vertexBuffers[0].vertexCount;var _=this._bufferMaxParticles*this._vertexStride,c=Math.floor(_/65535)+1,d=_%65535;if(c>1)throw new Error("ShurikenParticleSystem:the maxParticleCount multiply mesh vertexCount is large than 65535.");this._vertexBuffer=Ki.create(n,d,35048),this._vertices=new Float32Array(this._floatCountPerVertex*d),this._indexStride=h._indexBuffer.indexCount;var f=h._indexBuffer.getData(),m=this._bufferMaxParticles*this._indexStride;for(this._indexBuffer=Zi.create("ushort",m,35044),i=new Uint16Array(m),o=0,r=0;r<this._bufferMaxParticles;r++){var p=r*this._vertexStride;for(a=0,s=f.length;a<s;a++)i[o++]=p+f[a]}this._indexBuffer.setData(i)}}else{for(n=fe.vertexDeclaration,this._floatCountPerVertex=n.vertexStride/4,this._startLifeTimeIndex=7,this._timeIndex=11,this._vertexStride=4,this._vertexBuffer=Ki.create(n,this._bufferMaxParticles*this._vertexStride,35048),this._vertices=new Float32Array(this._floatCountPerVertex*this._bufferMaxParticles*this._vertexStride),r=0;r<this._bufferMaxParticles;r++)l=r*this._floatCountPerVertex*this._vertexStride,this._vertices[l]=-.5,this._vertices[l+1]=-.5,this._vertices[l+2]=0,this._vertices[l+3]=1,l+=this._floatCountPerVertex,this._vertices[l]=.5,this._vertices[l+1]=-.5,this._vertices[l+2]=1,this._vertices[l+3]=1,l+=this._floatCountPerVertex,this._vertices[l]=.5,this._vertices[l+1]=.5,this._vertices[l+2]=1,this._vertices[l+3]=0,l+=this._floatCountPerVertex,this._vertices[l]=-.5,this._vertices[l+1]=.5,this._vertices[l+2]=0,this._vertices[l+3]=0;for(this._indexStride=6,this._indexBuffer=Zi.create("ushort",6*this._bufferMaxParticles,35044),i=new Uint16Array(6*this._bufferMaxParticles),r=0;r<this._bufferMaxParticles;r++){o=6*r;var v=r*this._vertexStride,g=v+2;i[o++]=v,i[o++]=g,i[o++]=v+1,i[o++]=v,i[o++]=v+3,i[o++]=g}this._indexBuffer.setData(i)}}},o._destroy=function(){t.prototype._destroy.call(this),this._owner.activeInHierarchy&&this._removeUpdateEmissionToTimer(),this._vertexBuffer.destroy(),this._indexBuffer.destroy(),this._emission._destroy(),this._owner=null,this._vertices=null,this._vertexBuffer=null,this._indexBuffer=null,this._emission=null,this._shape=null,this.startLifeTimeGradient=null,this.startLifeTimeGradientMin=null,this.startLifeTimeGradientMax=null,this.startSizeConstantSeparate=null,this.startSizeConstantMinSeparate=null,this.startSizeConstantMaxSeparate=null,this.startRotationConstantSeparate=null,this.startRotationConstantMinSeparate=null,this.startRotationConstantMaxSeparate=null,this.startColorConstant=null,this.startColorConstantMin=null,this.startColorConstantMax=null,this._velocityOverLifetime=null,this._colorOverLifetime=null,this._sizeOverLifetime=null,this._rotationOverLifetime=null,this._textureSheetAnimation=null},o.emit=function(t){var i=e._tempPosition,n=e._tempDirection;if(this._shape&&this._shape.enable)this.autoRandomSeed?this._shape.generatePositionAndDirection(i,n):this._shape.generatePositionAndDirection(i,n,this._rand,this._randomSeeds);else{var r=i.elements,a=n.elements;r[0]=r[1]=r[2]=0,a[0]=a[1]=0,a[2]=1}return this.addParticle(i,n,t)},o.addParticle=function(t,e,i){Pe.normalize(e,e);var n=this._firstFreeElement+1;if(n>=this._bufferMaxParticles&&(n=0),n===this._firstRetiredElement)return!1;if(lt.create(this,this._ownerRender,this._owner.transform),this._currentTime-i>=lt.startLifeTime)return!0;var r=NaN,a=NaN,s=NaN,o=NaN,l=NaN,h=NaN,u=NaN,_=this._velocityOverLifetime&&this._velocityOverLifetime.enbale;if(_){var c=this._velocityOverLifetime.velocity.type;2===c||3===c?this.autoRandomSeed?(r=Math.random(),a=Math.random(),s=Math.random()):(this._rand.seed=this._randomSeeds[9],r=this._rand.getFloat(),a=this._rand.getFloat(),s=this._rand.getFloat(),this._randomSeeds[9]=this._rand.seed):_=!1}else _=!1;var d=this._colorOverLifetime&&this._colorOverLifetime.enbale;if(d){3===this._colorOverLifetime.color.type?this.autoRandomSeed?o=Math.random():(this._rand.seed=this._randomSeeds[10],o=this._rand.getFloat(),this._randomSeeds[10]=this._rand.seed):d=!1}else d=!1;var f=this._sizeOverLifetime&&this._sizeOverLifetime.enbale;if(f){3===this._sizeOverLifetime.size.type?this.autoRandomSeed?l=Math.random():(this._rand.seed=this._randomSeeds[11],l=this._rand.getFloat(),this._randomSeeds[11]=this._rand.seed):f=!1}else f=!1;var m=this._rotationOverLifetime&&this._rotationOverLifetime.enbale;if(m){var p=this._rotationOverLifetime.angularVelocity.type;2===p||3===p?this.autoRandomSeed?h=Math.random():(this._rand.seed=this._randomSeeds[12],h=this._rand.getFloat(),this._randomSeeds[12]=this._rand.seed):m=!1}else m=!1;var v=this._textureSheetAnimation&&this._textureSheetAnimation.enable;if(v){3===this._textureSheetAnimation.frame.type?this.autoRandomSeed?u=Math.random():(this._rand.seed=this._randomSeeds[15],u=this._rand.getFloat(),this._randomSeeds[15]=this._rand.seed):v=!1}else v=!1;var g,E=this._firstFreeElement*this._floatCountPerVertex*this._vertexStride,x=lt.startUVInfo[0],T=lt.startUVInfo[1],S=lt.startUVInfo[2],D=lt.startUVInfo[3],M=t.elements,y=e.elements,A=0,I=0,R=0,C=0,b=0,w=this._ownerRender;if(4===w.renderMode){var N=w.mesh._vertexBuffers[0];g=N.getData();var P=N.vertexDeclaration;I=P.getVertexElementByUsage(0).offset/4;var L=P.getVertexElementByUsage(1);R=L?L.offset/4:-1;var O=P.getVertexElementByUsage(2);C=O?O.offset/4:-1,A=P.vertexStride/4,b=0}else{this._vertices[E+2]=S,this._vertices[E+3]=D+T;var V=E+this._floatCountPerVertex;this._vertices[V+2]=S+x,this._vertices[V+3]=D+T;var F=V+this._floatCountPerVertex;this._vertices[F+2]=S+x,this._vertices[F+3]=D;var B=F+this._floatCountPerVertex;this._vertices[B+2]=S,this._vertices[B+3]=D}for(var U=E,H=E+this._floatCountPerVertex*this._vertexStride;U<H;U+=this._floatCountPerVertex){var G=0;if(4===w.renderMode){G=U;var z=A*b++,k=z+I;this._vertices[G++]=g[k++],this._vertices[G++]=g[k++],this._vertices[G++]=g[k],-1===R?(this._vertices[G++]=1,this._vertices[G++]=1,this._vertices[G++]=1,this._vertices[G++]=1):(k=z+R,this._vertices[G++]=g[k++],this._vertices[G++]=g[k++],this._vertices[G++]=g[k++],this._vertices[G++]=g[k]),-1===C?(this._vertices[G++]=0,this._vertices[G++]=0):(k=z+C,this._vertices[G++]=S+g[k++]*x,this._vertices[G++]=D+g[k]*T)}else G=U+4;switch(this._vertices[G++]=M[0],this._vertices[G++]=M[1],this._vertices[G++]=M[2],this._vertices[G++]=lt.startLifeTime,this._vertices[G++]=y[0],this._vertices[G++]=y[1],this._vertices[G++]=y[2],this._vertices[G++]=i,this._vertices[G++]=lt.startColor[0],this._vertices[G++]=lt.startColor[1],this._vertices[G++]=lt.startColor[2],this._vertices[G++]=lt.startColor[3],this._vertices[G++]=lt.startSize[0],this._vertices[G++]=lt.startSize[1],this._vertices[G++]=lt.startSize[2],this._vertices[G++]=lt.startRotation[0],this._vertices[G++]=lt.startRotation[1],this._vertices[G++]=lt.startRotation[2],this._vertices[G++]=lt.startSpeed,d&&(this._vertices[G+1]=o),f&&(this._vertices[G+2]=l),m&&(this._vertices[G+3]=h),v&&(this._vertices[G+4]=u),_&&(this._vertices[G+5]=r,this._vertices[G+6]=a,this._vertices[G+7]=s),this.simulationSpace){case 0:G+=8,this._vertices[G++]=lt.simulationWorldPostion[0],this._vertices[G++]=lt.simulationWorldPostion[1],this._vertices[G++]=lt.simulationWorldPostion[2],this._vertices[G++]=lt.simulationWorldRotation[0],this._vertices[G++]=lt.simulationWorldRotation[1],this._vertices[G++]=lt.simulationWorldRotation[2],this._vertices[G++]=lt.simulationWorldRotation[3];break;case 1:break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.")}}return this._firstFreeElement=n,!0},o.addNewParticlesToVertexBuffer=function(){var t=0;this._firstNewElement<this._firstFreeElement?(t=this._firstNewElement*this._vertexStride*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,t,t,(this._firstFreeElement-this._firstNewElement)*this._vertexStride*this._floatCountPerVertex)):(t=this._firstNewElement*this._vertexStride*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,t,t,(this._bufferMaxParticles-this._firstNewElement)*this._vertexStride*this._floatCountPerVertex),this._firstFreeElement>0&&this._vertexBuffer.setData(this._vertices,0,0,this._firstFreeElement*this._vertexStride*this._floatCountPerVertex)),this._firstNewElement=this._firstFreeElement},o._beforeRender=function(t){return this._firstNewElement!=this._firstFreeElement&&this.addNewParticlesToVertexBuffer(),this._drawCounter++,this._firstActiveElement!=this._firstFreeElement&&(this._vertexBuffer._bind(),this._indexBuffer._bind(),!0)},o._render=function(t){var e=0,i=P.mainContext;this._firstActiveElement<this._firstFreeElement?(e=(this._firstFreeElement-this._firstActiveElement)*this._indexStride,i.drawElements(4,e,5123,2*this._firstActiveElement*this._indexStride),C.trianglesFaces+=e/3,C.drawCall++):(e=(this._bufferMaxParticles-this._firstActiveElement)*this._indexStride,i.drawElements(4,e,5123,2*this._firstActiveElement*this._indexStride),C.trianglesFaces+=e/3,C.drawCall++,this._firstFreeElement>0&&(e=this._firstFreeElement*this._indexStride,i.drawElements(4,e,5123,0),C.trianglesFaces+=e/3,C.drawCall++))},o.play=function(){if(this._burstsIndex=0,this._isEmitting=!0,this._isPlaying=!0,this._isPaused=!1,this._emissionTime=0,this._totalDelayTime=0,!this.autoRandomSeed)for(var t=0,i=this._randomSeeds.length;t<i;t++)this._randomSeeds[t]=this.randomSeed[0]+e._RANDOMOFFSET[t];switch(this.startDelayType){case 0:this._playStartDelay=this.startDelay;break;case 1:this.autoRandomSeed?this._playStartDelay=T.lerp(this.startDelayMin,this.startDelayMax,Math.random()):(this._rand.seed=this._randomSeeds[2],this._playStartDelay=T.lerp(this.startDelayMin,this.startDelayMax,this._rand.getFloat()),this._randomSeeds[2]=this._rand.seed);break;default:throw new Error("Utils3D: startDelayType is invalid.")}this._frameRateTime=this._currentTime+this._playStartDelay,this._startUpdateLoopCount=C.loopCount,this.event("played")},o.pause=function(){this._isPaused=!0,this.event("paused")},o.simulate=function(t,e){void 0===e&&(e=!0),this._simulateUpdate=!0,e?this._updateParticlesSimulationRestart(t):(this._isPaused=!1,this._updateParticles(t)),this.pause()},o.stop=function(){this._burstsIndex=0,this._isEmitting=!1,this._emissionTime=0,this.event("stopped")},o.cloneTo=function(t){var e=t;e.duration=this.duration,e.looping=this.looping,e.prewarm=this.prewarm,e.startDelayType=this.startDelayType,e.startDelay=this.startDelay,e.startDelayMin=this.startDelayMin,e.startDelayMax=this.startDelayMax,e._maxStartLifetime=this._maxStartLifetime,e.startLifetimeType=this.startLifetimeType,e.startLifetimeConstant=this.startLifetimeConstant,this.startLifeTimeGradient.cloneTo(e.startLifeTimeGradient),e.startLifetimeConstantMin=this.startLifetimeConstantMin,e.startLifetimeConstantMax=this.startLifetimeConstantMax,this.startLifeTimeGradientMin.cloneTo(e.startLifeTimeGradientMin),this.startLifeTimeGradientMax.cloneTo(e.startLifeTimeGradientMax),e.startSpeedType=this.startSpeedType,e.startSpeedConstant=this.startSpeedConstant,e.startSpeedConstantMin=this.startSpeedConstantMin,e.startSpeedConstantMax=this.startSpeedConstantMax,e.threeDStartSize=this.threeDStartSize,e.startSizeType=this.startSizeType,e.startSizeConstant=this.startSizeConstant,this.startSizeConstantSeparate.cloneTo(e.startSizeConstantSeparate),e.startSizeConstantMin=this.startSizeConstantMin,e.startSizeConstantMax=this.startSizeConstantMax,this.startSizeConstantMinSeparate.cloneTo(e.startSizeConstantMinSeparate),this.startSizeConstantMaxSeparate.cloneTo(e.startSizeConstantMaxSeparate),e.threeDStartRotation=this.threeDStartRotation,e.startRotationType=this.startRotationType,e.startRotationConstant=this.startRotationConstant,this.startRotationConstantSeparate.cloneTo(e.startRotationConstantSeparate),e.startRotationConstantMin=this.startRotationConstantMin,e.startRotationConstantMax=this.startRotationConstantMax,this.startRotationConstantMinSeparate.cloneTo(e.startRotationConstantMinSeparate),this.startRotationConstantMaxSeparate.cloneTo(e.startRotationConstantMaxSeparate),e.randomizeRotationDirection=this.randomizeRotationDirection,e.startColorType=this.startColorType,this.startColorConstant.cloneTo(e.startColorConstant),this.startColorConstantMin.cloneTo(e.startColorConstantMin),this.startColorConstantMax.cloneTo(e.startColorConstantMax),e.gravityModifier=this.gravityModifier,e.simulationSpace=this.simulationSpace,e.scaleMode=this.scaleMode,e.playOnAwake=this.playOnAwake,e.maxParticles=this.maxParticles,this._emission&&(e._emission=this._emission.clone()),this.shape&&(e.shape=this.shape.clone()),this.velocityOverLifetime&&(e.velocityOverLifetime=this.velocityOverLifetime.clone()),this.colorOverLifetime&&(e.colorOverLifetime=this.colorOverLifetime.clone()),this.sizeOverLifetime&&(e.sizeOverLifetime=this.sizeOverLifetime.clone()),this.rotationOverLifetime&&(e.rotationOverLifetime=this.rotationOverLifetime.clone()),this.textureSheetAnimation&&(e.textureSheetAnimation=this.textureSheetAnimation.clone()),e.isPerformanceMode=this.isPerformanceMode,e._isEmitting=this._isEmitting,e._isPlaying=this._isPlaying,e._isPaused=this._isPaused,e._playStartDelay=this._playStartDelay,e._frameRateTime=this._frameRateTime,e._emissionTime=this._emissionTime,e._totalDelayTime=this._totalDelayTime,e._burstsIndex=this._burstsIndex},o.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},o._getVertexBuffers=function(){return null},o._renderRuntime=function(t,e,i){},a(0,o,"maxParticles",function(){return this._bufferMaxParticles-1},function(t){var e=t+1;e!==this._bufferMaxParticles&&(this._bufferMaxParticles=e,this._initBufferDatas())}),a(0,o,"isEmitting",function(){return this._isEmitting}),a(0,o,"isAlive",function(){return!!(this._isPlaying||this.aliveParticleCount>0)}),a(0,o,"shape",function(){return this._shape},function(t){this._shape!==t&&(t&&t.enable?this._ownerRender._addShaderDefine(gn.SHADERDEFINE_SHAPE):this._ownerRender._removeShaderDefine(gn.SHADERDEFINE_SHAPE),this._shape=t)}),a(0,o,"rotationOverLifetime",function(){return this._rotationOverLifetime},function(t){var e=this._ownerRender;if(t){var i=t.angularVelocity;if(!i)return;var n=i.separateAxes,r=i.type;if(t.enbale)switch(n?e._addShaderDefine(gn.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE):e._addShaderDefine(gn.SHADERDEFINE_ROTATIONOVERLIFETIME),r){case 0:e._addShaderDefine(gn.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT);break;case 1:e._addShaderDefine(gn.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE);break;case 2:e._addShaderDefine(gn.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS);break;case 3:e._addShaderDefine(gn.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES)}else e._removeShaderDefine(gn.SHADERDEFINE_ROTATIONOVERLIFETIME),e._removeShaderDefine(gn.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE),e._removeShaderDefine(gn.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT),e._removeShaderDefine(gn.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE),e._removeShaderDefine(gn.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS),e._removeShaderDefine(gn.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES);switch(r){case 0:n?e._setShaderValueColor(35,i.constantSeparate):e._setShaderValueNumber(34,i.constant);break;case 1:n?(e._setShaderValueBuffer(37,i.gradientX._elements),e._setShaderValueBuffer(38,i.gradientY._elements),e._setShaderValueBuffer(39,i.gradientZ._elements),e._setShaderValueBuffer(40,i.gradientW._elements)):e._setShaderValueBuffer(36,i.gradient._elements);break;case 2:n?(e._setShaderValueColor(35,i.constantMinSeparate),e._setShaderValueColor(42,i.constantMaxSeparate)):(e._setShaderValueNumber(34,i.constantMin),e._setShaderValueNumber(41,i.constantMax));break;case 3:n?(e._setShaderValueBuffer(37,i.gradientXMin._elements),e._setShaderValueBuffer(44,i.gradientXMax._elements),e._setShaderValueBuffer(38,i.gradientYMin._elements),e._setShaderValueBuffer(45,i.gradientYMax._elements),e._setShaderValueBuffer(39,i.gradientZMin._elements),e._setShaderValueBuffer(46,i.gradientZMax._elements),e._setShaderValueBuffer(40,i.gradientWMin._elements),e._setShaderValueBuffer(47,i.gradientWMax._elements)):(e._setShaderValueBuffer(36,i.gradientMin._elements),e._setShaderValueBuffer(43,i.gradientMax._elements))}}else e._removeShaderDefine(gn.SHADERDEFINE_ROTATIONOVERLIFETIME),e._removeShaderDefine(gn.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE),e._removeShaderDefine(gn.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT),e._removeShaderDefine(gn.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE),e._removeShaderDefine(gn.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS),e._removeShaderDefine(gn.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES),e._setShaderValueColor(35,null),e._setShaderValueColor(42,null),e._setShaderValueNumber(34,void 0),e._setShaderValueNumber(41,void 0),e._setShaderValueBuffer(37,null),e._setShaderValueBuffer(44,null),e._setShaderValueBuffer(38,null),e._setShaderValueBuffer(45,null),e._setShaderValueBuffer(39,null),e._setShaderValueBuffer(46,null),e._setShaderValueBuffer(40,null),e._setShaderValueBuffer(47,null),e._setShaderValueBuffer(36,null),e._setShaderValueBuffer(43,null);this._rotationOverLifetime=t}),a(0,o,"emission",function(){return this._emission}),a(0,o,"emissionTime",function(){return this._emissionTime>this.duration?this.duration:this._emissionTime}),a(0,o,"aliveParticleCount",function(){return this._firstNewElement>=this._firstRetiredElement?this._firstNewElement-this._firstRetiredElement:this._bufferMaxParticles-this._firstRetiredElement+this._firstNewElement}),a(0,o,"isPlaying",function(){return this._isPlaying}),a(0,o,"isPaused",function(){return this._isPaused}),a(0,o,"startLifetimeType",function(){return this._startLifetimeType},function(t){var e=0,i=0;switch(this.startLifetimeType){case 0:this._maxStartLifetime=this.startLifetimeConstant;break;case 1:this._maxStartLifetime=-Number.MAX_VALUE;var n=n;for(e=0,i=n.gradientCount;e<i;e++)this._maxStartLifetime=Math.max(this._maxStartLifetime,n.getValueByIndex(e));break;case 2:this._maxStartLifetime=Math.max(this.startLifetimeConstantMin,this.startLifetimeConstantMax);break;case 3:this._maxStartLifetime=-Number.MAX_VALUE;var r=r;for(e=0,i=r.gradientCount;e<i;e++)this._maxStartLifetime=Math.max(this._maxStartLifetime,r.getValueByIndex(e));var a=a;for(e=0,i=a.gradientCount;e<i;e++)this._maxStartLifetime=Math.max(this._maxStartLifetime,a.getValueByIndex(e))}this._startLifetimeType=t}),a(0,o,"_originalBoundingSphere",function(){return this._boundingSphere}),a(0,o,"startLifetimeConstant",function(){return this._startLifetimeConstant},function(t){0===this._startLifetimeType&&(this._maxStartLifetime=t),this._startLifetimeConstant=t}),a(0,o,"startLifetimeConstantMin",function(){return this._startLifetimeConstantMin},function(t){2===this._startLifetimeType&&(this._maxStartLifetime=Math.max(t,this._startLifetimeConstantMax)),this._startLifetimeConstantMin=t}),a(0,o,"startLifeTimeGradient",function(){return this._startLifeTimeGradient},function(t){if(1===this._startLifetimeType){this._maxStartLifetime=-Number.MAX_VALUE;for(var e=0,i=t.gradientCount;e<i;e++)this._maxStartLifetime=Math.max(this._maxStartLifetime,t.getValueByIndex(e))}this._startLifeTimeGradient=t}),a(0,o,"startLifetimeConstantMax",function(){return this._startLifetimeConstantMax},function(t){2===this._startLifetimeType&&(this._maxStartLifetime=Math.max(this._startLifetimeConstantMin,t)),this._startLifetimeConstantMax=t}),a(0,o,"startLifeTimeGradientMin",function(){return this._startLifeTimeGradientMin},function(t){if(3===this._startLifetimeType){var e=0,i=0;for(this._maxStartLifetime=-Number.MAX_VALUE,e=0,i=t.gradientCount;e<i;e++)this._maxStartLifetime=Math.max(this._maxStartLifetime,t.getValueByIndex(e));for(e=0,i=this._startLifeTimeGradientMax.gradientCount;e<i;e++)this._maxStartLifetime=Math.max(this._maxStartLifetime,this._startLifeTimeGradientMax.getValueByIndex(e))}this._startLifeTimeGradientMin=t}),a(0,o,"startLifeTimeGradientMax",function(){return this._startLifeTimeGradientMax},function(t){if(3===this._startLifetimeType){var e=0,i=0;for(this._maxStartLifetime=-Number.MAX_VALUE,e=0,i=this._startLifeTimeGradientMin.gradientCount;e<i;e++)this._maxStartLifetime=Math.max(this._maxStartLifetime,this._startLifeTimeGradientMin.getValueByIndex(e));for(e=0,i=t.gradientCount;e<i;e++)this._maxStartLifetime=Math.max(this._maxStartLifetime,t.getValueByIndex(e))}this._startLifeTimeGradientMax=t}),a(0,o,"velocityOverLifetime",function(){return this._velocityOverLifetime},function(t){var e=this._ownerRender;if(t){var i=t.velocity,n=i.type;if(t.enbale)switch(n){case 0:e._addShaderDefine(gn.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT);break;case 1:e._addShaderDefine(gn.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE);break;case 2:e._addShaderDefine(gn.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT);break;case 3:e._addShaderDefine(gn.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE)}else e._removeShaderDefine(gn.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT),e._removeShaderDefine(gn.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE),e._removeShaderDefine(gn.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT),e._removeShaderDefine(gn.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE);switch(n){case 0:e._setShaderValueColor(13,i.constant);break;case 1:e._setShaderValueBuffer(14,i.gradientX._elements),e._setShaderValueBuffer(15,i.gradientY._elements),e._setShaderValueBuffer(16,i.gradientZ._elements);break;case 2:e._setShaderValueColor(13,i.constantMin),e._setShaderValueColor(17,i.constantMax);break;case 3:e._setShaderValueBuffer(14,i.gradientXMin._elements),e._setShaderValueBuffer(18,i.gradientXMax._elements),e._setShaderValueBuffer(15,i.gradientYMin._elements),e._setShaderValueBuffer(19,i.gradientYMax._elements),e._setShaderValueBuffer(16,i.gradientZMin._elements),e._setShaderValueBuffer(20,i.gradientZMax._elements)}e._setShaderValueInt(21,t.space)}else e._removeShaderDefine(gn.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT),e._removeShaderDefine(gn.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE),e._removeShaderDefine(gn.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT),e._removeShaderDefine(gn.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE),e._setShaderValueColor(13,null),e._setShaderValueBuffer(14,null),e._setShaderValueBuffer(15,null),e._setShaderValueBuffer(16,null),e._setShaderValueColor(13,null),e._setShaderValueColor(17,null),e._setShaderValueBuffer(14,null),e._setShaderValueBuffer(18,null),e._setShaderValueBuffer(15,null),e._setShaderValueBuffer(19,null),e._setShaderValueBuffer(16,null),e._setShaderValueBuffer(20,null),e._setShaderValueInt(21,void 0);this._velocityOverLifetime=t}),a(0,o,"colorOverLifetime",function(){return this._colorOverLifetime},function(t){var e=this._ownerRender;if(t){var i=t.color;if(t.enbale)switch(i.type){case 1:e._addShaderDefine(gn.SHADERDEFINE_COLOROVERLIFETIME);break;case 3:e._addShaderDefine(gn.SHADERDEFINE_RANDOMCOLOROVERLIFETIME)}else e._removeShaderDefine(gn.SHADERDEFINE_COLOROVERLIFETIME),e._removeShaderDefine(gn.SHADERDEFINE_RANDOMCOLOROVERLIFETIME);switch(i.type){case 1:var n=i.gradient;e._setShaderValueBuffer(22,n._alphaElements),e._setShaderValueBuffer(23,n._rgbElements);break;case 3:var r=i.gradientMin,a=i.gradientMax;e._setShaderValueBuffer(22,r._alphaElements),e._setShaderValueBuffer(23,r._rgbElements),e._setShaderValueBuffer(24,a._alphaElements),e._setShaderValueBuffer(25,a._rgbElements)}}else e._removeShaderDefine(gn.SHADERDEFINE_COLOROVERLIFETIME),e._removeShaderDefine(gn.SHADERDEFINE_RANDOMCOLOROVERLIFETIME),e._setShaderValueBuffer(22,n._alphaElements),e._setShaderValueBuffer(23,n._rgbElements),e._setShaderValueBuffer(22,r._alphaElements),e._setShaderValueBuffer(23,r._rgbElements),e._setShaderValueBuffer(24,a._alphaElements),e._setShaderValueBuffer(25,a._rgbElements);this._colorOverLifetime=t}),a(0,o,"sizeOverLifetime",function(){return this._sizeOverLifetime},function(t){var e=this._ownerRender;if(t){var i=t.size,n=i.separateAxes,r=i.type;if(t.enbale)switch(r){case 0:n?e._addShaderDefine(gn.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE):e._addShaderDefine(gn.SHADERDEFINE_SIZEOVERLIFETIMECURVE);break;case 2:n?e._addShaderDefine(gn.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE):e._addShaderDefine(gn.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES)}else e._removeShaderDefine(gn.SHADERDEFINE_SIZEOVERLIFETIMECURVE),e._removeShaderDefine(gn.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE),e._removeShaderDefine(gn.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES),e._removeShaderDefine(gn.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE);switch(r){case 0:n?(e._setShaderValueBuffer(27,i.gradientX._elements),e._setShaderValueBuffer(28,i.gradientY._elements),e._setShaderValueBuffer(29,i.gradientZ._elements)):e._setShaderValueBuffer(26,i.gradient._elements);break;case 2:n?(e._setShaderValueBuffer(27,i.gradientXMin._elements),e._setShaderValueBuffer(31,i.gradientXMax._elements),e._setShaderValueBuffer(28,i.gradientYMin._elements),e._setShaderValueBuffer(32,i.gradientYMax._elements),e._setShaderValueBuffer(29,i.gradientZMin._elements),e._setShaderValueBuffer(33,i.gradientZMax._elements)):(e._setShaderValueBuffer(26,i.gradientMin._elements),e._setShaderValueBuffer(30,i.gradientMax._elements))}}else e._removeShaderDefine(gn.SHADERDEFINE_SIZEOVERLIFETIMECURVE),e._removeShaderDefine(gn.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE),e._removeShaderDefine(gn.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES),e._removeShaderDefine(gn.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE),e._setShaderValueBuffer(27,null),e._setShaderValueBuffer(31,null),e._setShaderValueBuffer(28,null),e._setShaderValueBuffer(32,null),e._setShaderValueBuffer(29,null),e._setShaderValueBuffer(33,null),e._setShaderValueBuffer(26,null),e._setShaderValueBuffer(30,null);this._sizeOverLifetime=t}),a(0,o,"textureSheetAnimation",function(){return this._textureSheetAnimation},function(t){var e=this._ownerRender;if(t){var i=t.frame,n=i.type;if(t.enable)switch(n){case 1:e._addShaderDefine(gn.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE);break;case 3:e._addShaderDefine(gn.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE)}else e._removeShaderDefine(gn.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE),e._removeShaderDefine(gn.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE);if(1===n||3===n){e._setShaderValueInt(48,t.cycles);var r=t.tiles,a=this._uvLength.elements;a[0]=1/r.x,a[1]=1/r.y,e._setShaderValueVector2(49,this._uvLength)}switch(n){case 1:e._setShaderValueBuffer(50,i.frameOverTimeData._elements);break;case 3:e._setShaderValueBuffer(50,i.frameOverTimeDataMin._elements),e._setShaderValueBuffer(51,i.frameOverTimeDataMax._elements)}}else e._removeShaderDefine(gn.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE),e._removeShaderDefine(gn.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE),e._setShaderValueInt(48,void 0),e._setShaderValueVector2(49,null),e._setShaderValueBuffer(50,null),e._setShaderValueBuffer(51,null);this._textureSheetAnimation=t}),a(0,o,"_vertexBufferCount",function(){return 1}),a(0,o,"triangleCount",function(){return this._indexBuffer?this._indexBuffer.indexCount/3:0}),a(0,o,"_originalBoundingBox",function(){return this._boundingBox}),a(0,o,"_originalBoundingBoxCorners",function(){return this._boundingBoxCorners}),e.halfKSqrtOf2=.71,n(e,["_RANDOMOFFSET",function(){return this._RANDOMOFFSET=new Uint32Array([592910910,3276756734,322376503,306581307,1793934638,3737431713,2527743459,2368504881,4085612399,3774601268,326370691,1494990940,1089181156,3159510623,2941263940,2786374529,271901988,4233252447])},"_maxElapsedTime",function(){return this._maxElapsedTime=1/3},"_tempVector30",function(){return this._tempVector30=new Pe},"_tempVector31",function(){return this._tempVector31=new Pe},"_tempVector32",function(){return this._tempVector32=new Pe},"_tempVector33",function(){return this._tempVector33=new Pe},"_tempVector34",function(){return this._tempVector34=new Pe},"_tempVector35",function(){return this._tempVector35=new Pe},"_tempVector36",function(){return this._tempVector36=new Pe},"_tempVector37",function(){return this._tempVector37=new Pe},"_tempVector38",function(){return this._tempVector38=new Pe},"_tempVector39",function(){return this._tempVector39=new Pe},"_tempPosition",function(){return this._tempPosition=new Pe},"_tempDirection",function(){return this._tempDirection=new Pe}]),e}(ti),Ci=function(t){function e(t){this._finalGravity=new Pe,this._tempRotationMatrix=new Ae,e.__super.call(this,t),this._defaultBoundBox=new xe(new Pe,new Pe),this._renderMode=-1,this.stretchedBillboardCameraSpeedScale=0,this.stretchedBillboardSpeedScale=0,this.stretchedBillboardLengthScale=1}r(e,"laya.d3.core.particleShuriKen.ShurikenParticleRender",t);var n=e.prototype;return n._calculateBoundingBox=function(){var t=this._boundingBox.min.elements;t[0]=-Number.MAX_VALUE,t[1]=-Number.MAX_VALUE,t[2]=-Number.MAX_VALUE;var e=this._boundingBox.min.elements;e[0]=Number.MAX_VALUE,e[1]=Number.MAX_VALUE,e[2]=Number.MAX_VALUE},n._calculateBoundingSphere=function(){var t=this._owner.particleSystem._boundingSphere,e=NaN,i=this._owner.transform,n=i.scale.elements,r=Math.abs(n[0]),a=Math.abs(n[1]),s=Math.abs(n[2]);e=r>=a&&r>=s?r:a>=s?a:s,Pe.transformCoordinate(t.center,i.worldMatrix,this._boundingSphere.center),this._boundingSphere.radius=t.radius*e},n._renderUpdate=function(t){var e=this._owner.particleSystem;if(!i.stage.isVisibility||!e.isAlive)return!1;var n=this._owner.transform;switch(e.simulationSpace){case 0:break;case 1:this._setShaderValueColor(0,n.position),this._setShaderValueColor(1,n.rotation);break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.")}switch(e.scaleMode){case 0:var r=n.scale;this._setShaderValueColor(4,r),this._setShaderValueColor(5,r);break;case 1:var a=n.localScale;this._setShaderValueColor(4,a),this._setShaderValueColor(5,a);break;case 2:this._setShaderValueColor(4,n.scale),this._setShaderValueColor(5,Pe.ONE)}var s=this._finalGravity.elements,o=Ye.gravity.elements,l=e.gravityModifier;return s[0]=o[0]*l,s[1]=o[1]*l,s[2]=o[2]*l,this._setShaderValueBuffer(7,s),this._setShaderValueInt(11,e.simulationSpace),this._setShaderValueBool(8,e.threeDStartRotation),this._setShaderValueInt(6,e.scaleMode),this._setShaderValueInt(9,this.stretchedBillboardLengthScale),this._setShaderValueInt(10,this.stretchedBillboardSpeedScale),this._setShaderValueNumber(12,e._currentTime),Qe.debugMode&&this._renderRenderableBoundBox(),!0},n._destroy=function(){t.prototype._destroy.call(this),this._mesh&&(this._mesh._removeReference(),this._mesh=null)},a(0,n,"boundingBox",function(){return this._owner.particleSystem.isAlive?(this._boundingBoxNeedChange&&(this._calculateBoundingBox(),this._boundingBoxNeedChange=!1),this._boundingBox):this._defaultBoundBox}),a(0,n,"renderMode",function(){return this._renderMode},function(t){if(this._renderMode!==t){switch(this._renderMode){case 0:this._removeShaderDefine(gn.SHADERDEFINE_RENDERMODE_BILLBOARD);break;case 1:this._removeShaderDefine(gn.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD);break;case 2:this._removeShaderDefine(gn.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD);break;case 3:this._removeShaderDefine(gn.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD);break;case 4:this._removeShaderDefine(gn.SHADERDEFINE_RENDERMODE_MESH)}switch(this._renderMode=t,t){case 0:this._addShaderDefine(gn.SHADERDEFINE_RENDERMODE_BILLBOARD);break;case 1:this._addShaderDefine(gn.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD);break;case 2:this._addShaderDefine(gn.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD);break;case 3:this._addShaderDefine(gn.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD);break;case 4:this._addShaderDefine(gn.SHADERDEFINE_RENDERMODE_MESH);break;default:throw new Error("ShurikenParticleRender: unknown renderMode Value.")}this._owner.particleSystem._initBufferDatas()}}),a(0,n,"mesh",function(){return this._mesh},function(t){this._mesh!==t&&(this._mesh&&this._mesh._removeReference(),this._mesh=t,t&&t._addReference(),this._owner.particleSystem._initBufferDatas())}),e}(ei),bi=function(t){function e(t){this._owner=null,this._trailRenderElements=null,this._minVertexDistance=NaN,this._widthMultiplier=NaN,this._time=NaN,this._widthCurve=null,this._colorGradient=null,this._textureMode=0,this._curtime=0,this._curSubTrailFinishCurTime=0,this._curSubTrailFinished=!1,this._hasLifeSubTrail=!1,this._trailTotalLength=0,this._trailSupplementLength=0,this._trailDeadLength=0,this._trailRenderElementIndex=0,e.__super.call(this),this._curSubTrailFinishPosition=new Pe,this._curSubTrailFinishDirection=new Pe,this._owner=t,this._trailRenderElements=[],this.addRenderElement()}r(e,"laya.d3.core.trail.TrailFilter",t);var i=e.prototype;return i.getRenderElementsCount=function(){return this._trailRenderElements.length},i.addRenderElement=function(){for(var t=0;t<this._trailRenderElements.length;t++)if(1==this._trailRenderElements[t]._isDead)return this._trailRenderElements[t].reActivate(),t;var e=new Et(this);return this._trailRenderElements.push(e),this._trailRenderElements.length-1},i.getRenderElement=function(t){return this._trailRenderElements[t]},i._update=function(t){this._curtime+=t.elapsedTime/1e3,this._owner._render._setShaderValueNumber(3,this._curtime),this._curSubTrailFinished&&(this._curSubTrailFinished=!1,this._trailRenderElementIndex=this.addRenderElement(),this.event("trailfilterchange",[this._trailRenderElementIndex,this._trailRenderElements[this._trailRenderElementIndex]]))},i._destroy=function(){t.prototype._destroy.call(this);for(var e=0;e<this._trailRenderElements.length;e++)this._trailRenderElements[e]._destroy();this._trailRenderElements=null,this._widthCurve=null,this._colorGradient=null,this._curSubTrailFinishPosition=null,this._curSubTrailFinishDirection=null},a(0,i,"widthMultiplier",function(){return this._widthMultiplier},function(t){this._widthMultiplier=t}),a(0,i,"time",function(){return this._time},function(t){this._time=t,this._owner._render._setShaderValueNumber(4,t)}),a(0,i,"widthCurve",function(){return this._widthCurve},function(t){this._widthCurve=t;var e=new Float32Array(4*t.length),i=0,n=0,r=0;for(i=0,n=t.length;i<n;i++)e[r++]=t[i].time,e[r++]=t[i].inTangent,e[r++]=t[i].outTangent,e[r++]=t[i].value;this._owner._render._setShaderValueBuffer(5,e),this._owner._render._setShaderValueInt(6,t.length)}),a(0,i,"minVertexDistance",function(){return this._minVertexDistance},function(t){this._minVertexDistance=t}),a(0,i,"colorGradient",function(){return this._colorGradient},function(t){this._colorGradient=t,this._owner._render._setShaderValueBuffer(7,t._colorKeyData),this._owner._render._setShaderValueBuffer(8,t._alphaKeyData),0==t.mode?this._owner._render._addShaderDefine(xn.SHADERDEFINE_GRADIENTMODE_BLEND):this._owner._render._removeShaderDefine(xn.SHADERDEFINE_GRADIENTMODE_BLEND)}),a(0,i,"textureMode",function(){return this._textureMode},function(t){this._textureMode=t}),e}(ti),wi=function(t){function e(t){e.__super.call(this,t)}r(e,"laya.d3.core.trail.TrailRenderer",t);var i=e.prototype;return i._calculateBoundingBox=function(){var t=this._boundingBox.min.elements;t[0]=-Number.MAX_VALUE,t[1]=-Number.MAX_VALUE,t[2]=-Number.MAX_VALUE;var e=this._boundingBox.min.elements;e[0]=Number.MAX_VALUE,e[1]=Number.MAX_VALUE,e[2]=Number.MAX_VALUE},i._calculateBoundingSphere=function(){var t=this._boundingSphere.center.elements;t[0]=0,t[1]=0,t[2]=0,this._boundingSphere.radius=Number.MAX_VALUE},i._renderUpdate=function(t){return!0},e}(ei),Ni=function(t){function e(t){this._floatCountPerVertex=6,this._owner=null,this._vertices=null,this._vertexBuffer=null,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._currentTime=NaN,this._drawCounter=0,this.scLeft=null,this.scRight=null,this._numPositionMode=0,this._numPositionVelocityMode=0,this._lastTime=NaN,this._needPatch=!1,this._lastPatchAddPos0=null,this._lastPatchAddPos1=null,this._lastPatchAddTime=NaN,this.lifeTime=NaN,this.minSegmentDistance=NaN,this.minInterpDistance=NaN,this.maxSlerpCount=0,this._maxSegments=0,e.__super.call(this),this._tempVector0=new Pe,this._tempVector1=new Pe,this._tempVector2=new Pe,this._tempVector3=new Pe,this._posModeLastPosition0=new Pe,this._posModeLastPosition1=new Pe,this._posModePosition0=new Pe,this._posModePosition1=new Pe,this._posVelModePosition0=new Pe,this._posVelModeVelocity0=new Pe,this._posVelModePosition1=new Pe,this._posVelModeVelocity1=new Pe,this._owner=t,this._lastTime=0,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._currentTime=0,this._drawCounter=0,this._needPatch=!1,this._lastPatchAddPos0=new Pe,this._lastPatchAddPos1=new Pe,this.scLeft=new G,this.scRight=new G,this.lifeTime=.5,this.minSegmentDistance=.1,this.minInterpDistance=.6,this.maxSlerpCount=128,this._maxSegments=200,this._owner.on("activeinhierarchychanged",this,this._onActiveHierarchyChanged)}r(e,"laya.d3.resource.tempelet.GlitterTemplet",t);var n=e.prototype;return i.imps(n,{"laya.d3.core.render.IRenderable":!0}),n._getVertexBuffer=function(t){return void 0===t&&(t=0),0===t?this._vertexBuffer:null},n._getIndexBuffer=function(){return null},n._initialize=function(){this._vertexBuffer=Ki.create(Rt.vertexDeclaration,2*this.maxSegments,35048),this._vertices=new Float32Array(this.maxSegments*this._floatCountPerVertex*2)},n._onActiveHierarchyChanged=function(t){t||(this._numPositionMode=0,this._numPositionVelocityMode=0,this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._currentTime=0,this._drawCounter=0)},n._updateTextureCoordinates=function(){this._firstActiveElement<this._firstFreeElement?this._updateSubTextureCoordinates(this._firstActiveElement,2*(this._firstFreeElement-this._firstActiveElement)):(this._updateSubTextureCoordinates(this._firstActiveElement,2*(this.maxSegments-this._firstActiveElement)),this._firstFreeElement>0&&this._updateSubTextureCoordinates(0,2*this._firstFreeElement))},n._updateSubTextureCoordinates=function(t,e){for(var i=2*t,n=0;n<e;n+=2){var r=i+n,a=r*this._floatCountPerVertex,s=(r+1)*this._floatCountPerVertex;this._vertices[a+3]=this._vertices[s+3]=(this._vertices[a+5]-this._currentTime)/this.lifeTime}},n._retireActiveGlitter=function(){for(var t=this.lifeTime,e=2*this._floatCountPerVertex;this._firstActiveElement!=this._firstNewElement;){var i=this._firstActiveElement*e+5;if(this._currentTime-this._vertices[i]<t)break;this._vertices[i]=this._drawCounter,this._firstActiveElement++,this._firstActiveElement>=this.maxSegments&&(this._firstActiveElement=0)}},n._freeRetiredGlitter=function(){for(var t=2*this._floatCountPerVertex;this._firstRetiredElement!=this._firstActiveElement;){if(this._drawCounter-this._vertices[this._firstRetiredElement*t+5]<3)break;this._firstRetiredElement++,this._firstRetiredElement>=this.maxSegments&&(this._firstRetiredElement=0)}},n._calcVelocity=function(t,e,i){Pe.subtract(t,e,i),Pe.scale(i,.5,i)},n._addNewGlitterSegementToVertexBuffer=function(){var t=0;this._firstActiveElement<this._firstFreeElement?(t=2*this._firstActiveElement*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,t,t,2*(this._firstFreeElement-this._firstActiveElement)*this._floatCountPerVertex)):(t=2*this._firstActiveElement*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,t,t,2*(this.maxSegments-this._firstActiveElement)*this._floatCountPerVertex),this._firstFreeElement>0&&this._vertexBuffer.setData(this._vertices,0,0,2*this._firstFreeElement*this._floatCountPerVertex)),this._firstNewElement=this._firstFreeElement},n._addGlitter=function(t,e,i){this._needPatch&&(this._needPatch=!1,this._addGlitter(this._lastPatchAddPos0,this._lastPatchAddPos1,this._lastPatchAddTime));var n=this._firstFreeElement+1;n>=this.maxSegments&&(n=0,t.cloneTo(this._lastPatchAddPos0),e.cloneTo(this._lastPatchAddPos1),this._lastPatchAddTime=i,this._needPatch=!0),n===this._firstRetiredElement&&console.log("GlitterTemplet:current segement count have large than maxSegments,please adjust the  value of maxSegments or add Glitter Vertex Frequency.");var r=t.elements,a=e.elements,s=0,o=this._firstFreeElement*this._floatCountPerVertex*2;for(s=0;s<3;s++)this._vertices[o+s]=r[s];this._vertices[o+3]=0,this._vertices[o+4]=0,this._vertices[o+5]=i;var l=o+this._floatCountPerVertex;for(s=0;s<3;s++)this._vertices[l+s]=a[s];this._vertices[l+3]=0,this._vertices[l+4]=1,this._vertices[l+5]=i,this._firstFreeElement=n},n._update=function(t){this._currentTime+=t/1e3,this._retireActiveGlitter(),this._freeRetiredGlitter(),this._firstActiveElement==this._firstFreeElement&&(this._currentTime=0),this._firstRetiredElement==this._firstActiveElement&&(this._drawCounter=0),this._updateTextureCoordinates()},n._beforeRender=function(t){return this._firstNewElement!=this._firstFreeElement&&this._addNewGlitterSegementToVertexBuffer(),this._drawCounter++,this._firstActiveElement!=this._firstFreeElement&&(this._vertexBuffer.bindWithIndexBuffer(null),!0)},n._render=function(t){var e=0,i=P.mainContext;this._firstActiveElement<this._firstFreeElement?(e=2*(this._firstFreeElement-this._firstActiveElement),i.drawArrays(5,2*this._firstActiveElement,e),C.trianglesFaces+=e-2,C.drawCall++):(e=2*(this.maxSegments-this._firstActiveElement),i.drawArrays(5,2*this._firstActiveElement,e),C.trianglesFaces+=e-2,C.drawCall++,this._firstFreeElement>0&&(e=2*this._firstFreeElement,i.drawArrays(5,0,e),C.trianglesFaces+=e-2,C.drawCall++))},n.addVertexPosition=function(t,e){if(this._owner.activeInHierarchy)if(this._numPositionMode<2)0===this._numPositionMode?(t.cloneTo(this._posModeLastPosition0),e.cloneTo(this._posModeLastPosition1)):(t.cloneTo(this._posModePosition0),e.cloneTo(this._posModePosition1)),this._numPositionMode++;else{var i=this._tempVector2;this._calcVelocity(t,this._posModeLastPosition0,i);var n=this._tempVector3;this._calcVelocity(e,this._posModeLastPosition1,n),this.addVertexPositionVelocity(this._posModePosition0,i,this._posModePosition1,n),this._posModePosition0.cloneTo(this._posModeLastPosition0),this._posModePosition1.cloneTo(this._posModeLastPosition1),t.cloneTo(this._posModePosition0),e.cloneTo(this._posModePosition1)}},n.addVertexPositionVelocity=function(t,e,i,n){if(this._owner.activeInHierarchy){if(0===this._numPositionVelocityMode)this._numPositionVelocityMode++;else{var r=this._tempVector0;Pe.subtract(t,this._posVelModePosition0,r);var a=Pe.scalarLength(r);Pe.subtract(i,this._posVelModePosition1,r);var s=Pe.scalarLength(r),o=0,l=l;if(a<l&&s<l)return;if(1===(o=1+Math.floor(Math.max(a,s)/this.minInterpDistance)))this._addGlitter(t,i,this._currentTime);else{o=Math.min(o,this.maxSlerpCount),this.scLeft.Init(this._posVelModePosition0,this._posVelModeVelocity0,t,e),this.scRight.Init(this._posVelModePosition1,this._posVelModeVelocity1,i,n);for(var h=1/o,u=h,_=this._currentTime-this._lastTime,c=1;c<=o;c++){var d=this._tempVector0;this.scLeft.Slerp(u,d);var f=this._tempVector1;this.scRight.Slerp(u,f);var m=this._lastTime+_*c/o;this._addGlitter(d,f,m),u+=h}}}this._lastTime=this._currentTime,t.cloneTo(this._posVelModePosition0),e.cloneTo(this._posVelModeVelocity0),i.cloneTo(this._posVelModePosition1),n.cloneTo(this._posVelModeVelocity1)}},n._destroy=function(){t.prototype._destroy.call(this),this._tempVector0=null,this._tempVector1=null,this._tempVector2=null,this._tempVector3=null,this._owner=null,this._vertices=null,this._vertexBuffer.destroy(),this._vertexBuffer=null,this.scLeft=null,this.scRight=null,this._posModeLastPosition0=null,this._posModeLastPosition1=null,this._posModePosition0=null,this._posModePosition1=null,this._posVelModePosition0=null,this._posVelModeVelocity0=null,this._posVelModePosition1=null,this._posVelModeVelocity1=null,this._lastPatchAddPos0=null,this._lastPatchAddPos1=null},n._getVertexBuffers=function(){return null},n._renderRuntime=function(t,e,i){},a(0,n,"maxSegments",function(){return this._maxSegments-1},function(t){var e=t+1;e!==this._maxSegments&&(this._maxSegments=e,this._vertexBuffer&&this._vertexBuffer.destroy(),this._initialize())}),a(0,n,"_vertexBufferCount",function(){return 1}),a(0,n,"triangleCount",function(){var t=0;return this._firstActiveElement<this._firstFreeElement?t=2*(this._firstFreeElement-this._firstActiveElement)-2:(t=2*(this.maxSegments-this._firstActiveElement)-2,t+=2*this._firstFreeElement-2),t}),a(0,n,"_originalBoundingSphere",function(){return i.superGet(ti,this,"_originalBoundingSphere")}),a(0,n,"_originalBoundingBox",function(){return i.superGet(ti,this,"_originalBoundingBox")}),e}(ti),Pi=function(t){function e(t,i,n,r,a,o,l,h){this._owner=null,this._gridSize=NaN,this.memorySize=0,this._numberVertices=0,this._maxNumberIndices=0,this._currentNumberIndices=0,this._numberTriangle=0,this._vertexBuffer=null,this._indexBuffer=null,this._boundingSphere=null,this._boundingBox=null,this._indexArrayBuffer=null,this._boundingBoxCorners=null,this._leafs=null,this._leafNum=0,this._terrainHeightData=null,this._terrainHeightDataWidth=0,this._terrainHeightDataHeight=0,this._chunkOffsetX=0,this._chunkOffsetZ=0,this._cameraCoordinateInverse=!1,this._cameraPos=null,this._currentLOD=0,this._perspectiveFactor=NaN,this._LODTolerance=0,e.__super.call(this),this._owner=t,this._cameraPos=new Pe,this._chunkOffsetX=i,this._chunkOffsetZ=n,this._gridSize=r,this._terrainHeightData=a,this._terrainHeightDataWidth=o,this._terrainHeightDataHeight=l,this._leafNum=ze.CHUNK_GRID_NUM/ze.LEAF_GRID_NUM*(ze.CHUNK_GRID_NUM/ze.LEAF_GRID_NUM),this._leafs=s(this._leafNum),this._cameraCoordinateInverse=h;for(var u=0;u<this._leafNum;u++)this._leafs[u]=new ze;this.recreateResource()}r(e,"laya.d3.terrain.TerrainFilter",t);var o=e.prototype;return i.imps(o,{"laya.d3.core.render.IRenderable":!0}),o._destroy=function(){t.prototype._destroy.call(this),this._owner=null,this._vertexBuffer&&this._vertexBuffer.destroy(),this._indexBuffer&&this._indexBuffer.destroy()},o.recreateResource=function(){this._currentNumberIndices=0,this._numberTriangle=0;var t=ze.LEAF_VERTEXT_COUNT,e=ze.LEAF_MAX_INDEX_COUNT;this._numberVertices=t*this._leafNum,this._maxNumberIndices=e*this._leafNum,this._indexArrayBuffer=new Uint16Array(this._maxNumberIndices);var i=ce.vertexDeclaration,n=i.vertexStride/4,r=new Float32Array(this._numberVertices*n),a=ze.CHUNK_GRID_NUM/ze.LEAF_GRID_NUM,s=0,o=0,l=0;for(s=0;s<this._leafNum;s++)o=s%a,l=Math.floor(s/a),this._leafs[s].calcVertextBuffer(this._chunkOffsetX,this._chunkOffsetZ,o*ze.LEAF_GRID_NUM,l*ze.LEAF_GRID_NUM,this._gridSize,r,s*ze.LEAF_PLANE_VERTEXT_COUNT,n,this._terrainHeightData,this._terrainHeightDataWidth,this._terrainHeightDataHeight,this._cameraCoordinateInverse);for(s=0;s<this._leafNum;s++)o=s%a,l=Math.floor(s/a),this._leafs[s].calcSkirtVertextBuffer(this._chunkOffsetX,this._chunkOffsetZ,o*ze.LEAF_GRID_NUM,l*ze.LEAF_GRID_NUM,this._gridSize,r,this._leafNum*ze.LEAF_PLANE_VERTEXT_COUNT+s*ze.LEAF_SKIRT_VERTEXT_COUNT,n,this._terrainHeightData,this._terrainHeightDataWidth,this._terrainHeightDataHeight);this.assembleIndexInit(),this._vertexBuffer=new Ki(i,this._numberVertices,35044,!1),this._indexBuffer=new Zi("ushort",this._maxNumberIndices,35044,!1),this._vertexBuffer.setData(r),this._indexBuffer.setData(this._indexArrayBuffer),this.memorySize=2*(this._vertexBuffer._byteLength+this._indexBuffer._byteLength),this.calcOriginalBoudingBoxAndSphere()},o.setLODLevel=function(t){if(4!=t.length)return!0;var e=(t[0]+1<<24)+(t[1]+1<<16)+(t[2]+1<<8)+(t[3]+1);return this._currentLOD!=e&&(this._currentLOD=e,!0)},o.assembleIndexInit=function(){this._currentNumberIndices=0,this._numberTriangle=0;for(var t=0,e=0;e<this._leafNum;e++){var i=ze.getPlaneLODIndex(e,0);this._indexArrayBuffer.set(i,t),t+=i.length;var n=ze.getSkirtLODIndex(e,0);this._indexArrayBuffer.set(n,t),t+=n.length,this._currentNumberIndices+=i.length+n.length}this._numberTriangle=this._currentNumberIndices/3},o.isNeedAssemble=function(t,e){var i=Math.min(t.viewport.width,t.viewport.height)/(2*Math.tan(Math.PI*t.fieldOfView/180));return this._perspectiveFactor!=i?(this._perspectiveFactor=i,1):this._LODTolerance!=fn.LOD_TOLERANCE_VALUE?(this._LODTolerance=fn.LOD_TOLERANCE_VALUE,1):0==Pe.equals(e,this._cameraPos)?(this._cameraPos.x=e.x,this._cameraPos.y=e.y,this._cameraPos.z=e.z,2):0},o.assembleIndex=function(t,i){var n=this.isNeedAssemble(t,i);if(n>0){for(var r=0;r<this._leafNum;r++)e._TEMP_ARRAY_BUFFER[r]=this._leafs[r].determineLod(i,this._perspectiveFactor,fn.LOD_TOLERANCE_VALUE,1==n);if(this.setLODLevel(e._TEMP_ARRAY_BUFFER)){this._currentNumberIndices=0,this._numberTriangle=0;var a=0;for(r=0;r<this._leafNum;r++){var s=e._TEMP_ARRAY_BUFFER[r],o=ze.getPlaneLODIndex(r,s);this._indexArrayBuffer.set(o,a),a+=o.length;var l=ze.getSkirtLODIndex(r,s);this._indexArrayBuffer.set(l,a),a+=l.length,this._currentNumberIndices+=o.length+l.length}return this._numberTriangle=this._currentNumberIndices/3,!0}}return!1},o.calcOriginalBoudingBoxAndSphere=function(){for(var t=new Ne(2147483647,-2147483647),e=0;e<this._leafNum;e++)t.x=this._leafs[e]._sizeOfY.x<t.x?this._leafs[e]._sizeOfY.x:t.x,t.y=this._leafs[e]._sizeOfY.y>t.y?this._leafs[e]._sizeOfY.y:t.y;var i=new Pe(this._chunkOffsetX*ze.CHUNK_GRID_NUM*this._gridSize,t.x,this._chunkOffsetZ*ze.CHUNK_GRID_NUM*this._gridSize),n=new Pe((this._chunkOffsetX+1)*ze.CHUNK_GRID_NUM*this._gridSize,t.y,(this._chunkOffsetZ+1)*ze.CHUNK_GRID_NUM*this._gridSize);ze.__ADAPT_MATRIX__&&(Pe.transformV3ToV3(i,ze.__ADAPT_MATRIX__,i),Pe.transformV3ToV3(n,ze.__ADAPT_MATRIX__,n)),this._boundingBox=new xe(i,n);var r=new Pe;Pe.subtract(n,i,r),Pe.scale(r,.5,r);var a=new Pe;Pe.add(i,r,a),this._boundingSphere=new Se(a,Pe.scalarLength(r)),this._boundingBoxCorners=s(8,null),this._boundingBox.getCorners(this._boundingBoxCorners)},o.calcLeafBoudingBox=function(t){for(var e=0;e<this._leafNum;e++)this._leafs[e].calcLeafBoudingBox(t)},o.calcLeafBoudingSphere=function(t,e){for(var i=0;i<this._leafNum;i++)this._leafs[i].calcLeafBoudingSphere(t,e)},o._getVertexBuffer=function(t){return void 0===t&&(t=0),0==t?this._vertexBuffer:null},o._getIndexBuffer=function(){return this._indexBuffer},o._beforeRender=function(t){if(this._vertexBuffer._bind(),this._indexBuffer._bind(),0==t.renderElement._material.blend){var e=t.camera;this.assembleIndex(e,e.position)&&this._indexBuffer.setData(this._indexArrayBuffer)}return!0},o._getVertexBuffers=function(){return null},o._render=function(t){P.mainContext.drawElements(fn.RENDER_LINE_MODEL?1:4,this._currentNumberIndices,5123,0),C.trianglesFaces+=this._numberTriangle,C.drawCall++},o._renderRuntime=function(t,e,i){},a(0,o,"_originalBoundingSphere",function(){return this._boundingSphere}),a(0,o,"_originalBoundingBox",function(){return this._boundingBox}),a(0,o,"_vertexBufferCount",function(){return this._numberVertices}),a(0,o,"triangleCount",function(){return this._numberTriangle}),n(e,["_TEMP_ARRAY_BUFFER",function(){return this._TEMP_ARRAY_BUFFER=new Uint32Array(ze.CHUNK_GRID_NUM/ze.LEAF_GRID_NUM*ze.CHUNK_GRID_NUM/ze.LEAF_GRID_NUM)}]),e}(ti),Li=function(t){function e(t){this._terrainSprite3DOwner=null,e.__super.call(this,t),this._terrainSprite3DOwner=t}r(e,"laya.d3.terrain.TerrainRender",t);var i=e.prototype;return i._calculateBoundingSphere=function(){var t=this._terrainSprite3DOwner.terrainFilter;if(null==t)this._boundingSphere.toDefault();else{var e=t._originalBoundingSphere,i=NaN,n=this._terrainSprite3DOwner.transform,r=n.scale;i=r.x>=r.y&&r.x>=r.z?r.x:r.y>=r.z?r.y:r.z,Pe.transformCoordinate(e.center,n.worldMatrix,this._boundingSphere.center),this._boundingSphere.radius=e.radius*i,t.calcLeafBoudingSphere(n.worldMatrix,i)}},i._calculateBoundingBox=function(){var t=this._terrainSprite3DOwner.terrainFilter;if(null==t)this._boundingBox.toDefault();else{for(var e=this._terrainSprite3DOwner.transform.worldMatrix,i=t._boundingBoxCorners,n=0;n<8;n++)Pe.transformCoordinate(i[n],e,ei._tempBoundBoxCorners[n]);xe.createfromPoints(ei._tempBoundBoxCorners,this._boundingBox),t.calcLeafBoudingBox(e)}},i._renderUpdate=function(t){this._setShaderValueMatrix4x4(0,this._owner.transform.worldMatrix);var e=this._owner.getProjectionViewWorldMatrix(t);return this._setShaderValueMatrix4x4(1,e),!0},i._destroy=function(){t.prototype._destroy.call(this),this._terrainSprite3DOwner=null},e}(ei),Oi=(function(t){function e(t){e.__super.call(this,t)}r(e,"laya.d3.water.WaterRender",t);var i=e.prototype;i._calculateBoundingSphere=function(){},i._calculateBoundingBox=function(){},i._destroy=function(){t.prototype._destroy.call(this)}}(ei),function(t){function e(){this._enableLightCount=3,this._customRenderQueneIndex=11,this.enableLight=!0,e.__super.call(this),this._renderState=new ct,this._lights=[],this._quenes=[],this._cameraPool=[],this._renderableSprite3Ds=[],this.__loaded=!0,this._lightmaps=[],this._shaderValues=new He,this.parallelSplitShadowMaps=[],this._dynamicBatchManager=new St,this._cullingRenders=[],this._cullingRendersLength=0,this.enableFog=!1,this.fogStart=300,this.fogRange=1e3,this.fogColor=new Pe(.7,.7,.7),this.ambientColor=new Pe(.212,.227,.259),P.shaderHighPrecision&&this.addShaderDefine(ui.SHADERDEFINE_HIGHPRECISION),this.on("display",this,this._display),this.on("undisplay",this,this._unDisplay),this._componentsMap=[],this._typeComponentsIndices=[],this._components=[]}r(e,"laya.d3.core.scene.Scene",t);var n=e.prototype;return i.imps(n,{"laya.webgl.submit.ISubmit":!0,"laya.resource.ICreateResource":!0}),n._setUrl=function(t){this._url=t},n._getGroup=function(){return this._group},n._setGroup=function(t){this._group=t},n._display=function(){i.stage._scenes.push(this),i.stage._scenes.sort(e._sortScenes);for(var t=0,n=this._childs.length;t<n;t++){var r=this._childs[t];r.active&&r._activeHierarchy()}},n._unDisplay=function(){var t=i.stage._scenes;t.splice(t.indexOf(this),1);for(var e=0,n=this._childs.length;e<n;e++){var r=this._childs[e];r.active&&r._inActiveHierarchy()}},n._addChild3D=function(t){t.transform._onWorldTransform(),t._setBelongScene(this),this.displayedInStage&&t.active&&t._activeHierarchy()},n._removeChild3D=function(t){t.transform.parent=null,this.displayedInStage&&t.active&&t._inActiveHierarchy(),t._setUnBelongScene()},n.initOctree=function(t,e,i,n,r){void 0===r&&(r=6),this.treeSize=new Pe(t,e,i),this.treeLevel=r,this.treeRoot=new dt(this,0),this.treeRoot.init(n,this.treeSize)},n._prepareUpdateToRenderState=function(t,e){e.elapsedTime=this._lastCurrentTime?this.timer.currTimer-this._lastCurrentTime:0,this._lastCurrentTime=this.timer.currTimer,e.scene=this},n._prepareSceneToRender=function(t){var e=this._lights.length;if(e>0)for(var i=0,n=0;n<e&&!(this._lights[n]._prepareToScene(t)&&++i>=this._enableLightCount);n++);},n._updateChilds=function(t){for(var e=0,i=this._childs.length;e<i;++e)this._childs[e]._update(t)},n._updateChildsConch=function(t){for(var e=0,i=this._childs.length;e<i;++e)this._childs[e]._updateConch(t)},n._preRenderScene=function(t,e,i){var n=e._viewMatrix,r=e._projectionMatrix,a=e._projectionViewMatrix,s=0,o=0,l=e.camera;for(l.useOcclusionCulling?this.treeRoot?Dt.renderObjectCullingOctree(i,this,l,n,r,a):Dt.renderObjectCulling(i,this,l,n,r,a):Dt.renderObjectCullingNoBoundFrustum(this,l,n,r,a),s=0,o=this._quenes.length;s<o;s++)this._quenes[s]&&this._quenes[s]._preRender(e)},n._clear=function(t,e){var i=e._viewport,n=e.camera,r=i.x,a=n.renderTargetSize.height-i.y-i.height,s=i.width,o=i.height;t.viewport(r,a,s,o);var l=256,h=n.renderTarget;switch(n.clearFlag){case 0:var u=n.clearColor;if(u){t.enable(3089),t.scissor(r,a,s,o);var _=u.elements;t.clearColor(_[0],_[1],_[2],_[3]),l|=16384}if(h)switch(u||(l=16384),h.depthStencilFormat){case 33189:l|=256;break;case 36168:l|=1024;break;case 34041:l|=256,l|=1024}t.clear(l),u&&t.disable(3089);break;case 1:case 2:if(h)switch(l=16384,h.depthStencilFormat){case 33189:l|=256;break;case 36168:l|=1024;break;case 34041:l|=256,l|=1024}t.clear(l);break;case 3:break;default:throw new Error("BaseScene:camera clearFlag invalid.")}},n._renderScene=function(t,e){var i,n=e.camera,r=0,a=0;for(r=0;r<2;r++)(i=this._quenes[r])&&(n.renderTarget?i._render(e,!0):i._render(e,!1));if(1===n.clearFlag){var s=n.sky;s&&(L.setCullFace(t,!1),L.setDepthFunc(t,515),L.setDepthMask(t,!1),s._render(e),L.setDepthFunc(t,513),L.setDepthMask(t,!0))}for(r=2,a=this._quenes.length;r<a;r++)(i=this._quenes[r])&&(i._sortAlpha(e.camera.transform.position),n.renderTarget?i._render(e,!0):i._render(e,!1))},n._set3DRenderConfig=function(t){t.disable(3042),L._blend=!1,t.blendFunc(770,771),L._sFactor=770,L._dFactor=771,t.disable(2929),L._depthTest=!1,t.enable(2884),L._cullFace=!0,t.depthMask(1),L._depthMask=!0,t.frontFace(2304),L._frontFace=2304},n._set2DRenderConfig=function(t){L.setBlend(t,!0),L.setBlendFunc(t,1,771),L.setDepthTest(t,!1),L.setCullFace(t,!1),L.setDepthMask(t,!0),L.setFrontFace(t,2305),t.viewport(0,0,M.width,M.height)},n._parseCustomProps=function(t,e,i,n){var r=n.customProps.lightmaps,a=r.length,s=this._lightmaps;s.length=a;for(var o=0;o<a;o++)s[o]=E.getRes(e[r[o].replace("exr","png")]);this.setlightmaps(s);var l=n.customProps.ambientColor;l&&(this.ambientColor=new Pe(l[0],l[1],l[2]));var h=n.customProps.fogColor;h&&(this.fogColor=new Pe(h[0],h[1],h[2]))},n._addLight=function(t){this._lights.indexOf(t)<0&&this._lights.push(t)},n._removeLight=function(t){var e=this._lights.indexOf(t);e>=0&&this._lights.splice(e,1)},n._updateScene=function(){var t=this._renderState;this._prepareUpdateToRenderState(P.mainContext,t),this._updateComponents(t),this._updateChilds(t),this._lateUpdateComponents(t)},n._updateSceneConch=function(){var t=this._renderState;this._prepareUpdateToRenderState(P.mainContext,t),this._updateComponents(t),this._updateChildsConch(t),this._lateUpdateComponents(t),this._prepareSceneToRender(t);for(var e=0,i=this._cameraPool.length;e<i;e++){var n=this._cameraPool[e];t.camera=n,n._prepareCameraToRender()}},n._preRenderShadow=function(t,e,i,n,r){this.treeRoot?Dt.renderShadowObjectCullingOctree(this,e,i,n,r):Dt.renderShadowObjectCulling(this,e,i,n,r);for(var a=0,s=i.length;a<s;a++)i[a]&&i[a]._preRender(t)},n._renderShadowMap=function(t,e,i){var n=this.parallelSplitShadowMaps[0];n._calcAllLightCameraInfo(i);var r=n.PSSMNum;this._preRenderShadow(e,n._lightCulling,n._shadowQuenes,n._lightVPMatrix[0],r),this.addShaderDefine(Ge.SHADERDEFINE_CAST_SHADOW);var a,s,o;if(r>1)for(var l=0;l<r;l++)a=n.getRenderTarget(l+1),n.beginRenderTarget(l+1),t.clearColor(1,1,1,1),t.clear(16640),t.viewport(0,0,a.width,a.height),e.camera=o=n.getLightCamera(l),o._prepareCameraToRender(),o._prepareCameraViewProject(o.viewMatrix,o.projectionMatrix),e._projectionViewMatrix=n._lightVPMatrix[l+1],s=n._shadowQuenes[l],s._preRender(e),s._renderShadow(e,!1),n.endRenderTarget(l+1);else a=n.getRenderTarget(1),n.beginRenderTarget(1),t.clearColor(1,1,1,1),t.clear(16640),t.viewport(0,0,a.width,a.height),e.camera=o=n.getLightCamera(0),o._prepareCameraToRender(),o._prepareCameraViewProject(o.viewMatrix,o.projectionMatrix),e._projectionViewMatrix=n._lightVPMatrix[0],s=n._shadowQuenes[0],s._preRender(e),s._renderShadow(e,!0),n.endRenderTarget(1);this.removeShaderDefine(Ge.SHADERDEFINE_CAST_SHADOW)},n.addTreeNode=function(t){this.treeRoot.addTreeNode(t)},n.removeTreeNode=function(t){this.treeSize&&t._treeNode&&t._treeNode.removeObject(t)},n.setlightmaps=function(t){this._lightmaps=t;for(var e=0,i=this._renderableSprite3Ds.length;e<i;e++)this._renderableSprite3Ds[e]._render._applyLightMapParams()},n.getlightmaps=function(){return this._lightmaps},n.addChildAt=function(t,e){if(!(t instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");if(!t||this.destroyed||t===this)return t;if(t.zOrder&&this._set$P("hasZorder",!0),e>=0&&e<=this._childs.length){if(t._parent===this){var i=this.getChildIndex(t);this._childs.splice(i,1),this._childs.splice(e,0,t),this.conchModel&&(this.conchModel.removeChild(t.conchModel),this.conchModel.addChildAt(t.conchModel,e)),this._childChanged()}else t.parent&&t.parent.removeChild(t),this._childs===S.ARRAY_EMPTY&&(this._childs=[]),this._childs.splice(e,0,t),this.conchModel&&this.conchModel.addChildAt(t.conchModel,e),t.parent=this,this._addChild3D(t);return t}throw new Error("appendChildAt:The index is out of bounds")},n.addChild=function(t){if(!(t instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");if(!t||this.destroyed||t===this)return t;if(t.zOrder&&this._set$P("hasZorder",!0),t._parent===this){var e=this.getChildIndex(t);e!==this._childs.length-1&&(this._childs.splice(e,1),this._childs.push(t),this.conchModel&&(this.conchModel.removeChild(t.conchModel),this.conchModel.addChildAt(t.conchModel,this._childs.length-1)),this._childChanged())}else t.parent&&t.parent.removeChild(t),this._childs===S.ARRAY_EMPTY&&(this._childs=[]),this._childs.push(t),this.conchModel&&this.conchModel.addChildAt(t.conchModel,this._childs.length-1),t.parent=this,this._childChanged(),this._addChild3D(t);return t},n.removeChildAt=function(t){var e=this.getChildAt(t);return e&&(this._removeChild3D(e),this._childs.splice(t,1),this.conchModel&&this.conchModel.removeChild(e.conchModel),e.parent=null),e},n.removeChildren=function(t,e){if(void 0===t&&(t=0),void 0===e&&(e=2147483647),this._childs&&this._childs.length>0){var i=this._childs;if(0===t&&e>=a){var n=i;this._childs=S.ARRAY_EMPTY}else n=i.splice(t,e-t);for(var r=0,a=n.length;r<a;r++)this._removeChild3D(n[r]),n[r].parent=null,this.conchModel&&this.conchModel.removeChild(n[r].conchModel)}return this},n.addFrustumCullingObject=function(t){this.treeRoot?this.addTreeNode(t):(this._cullingRendersLength===this._cullingRenders.length?this._cullingRenders.push(t):this._cullingRenders[this._cullingRendersLength]=t,t._indexInSceneFrustumCullingObjects=this._cullingRendersLength++)},n.removeFrustumCullingObject=function(t){if(this.treeRoot)this.removeTreeNode(t);else{this._cullingRendersLength--;var e=t._indexInSceneFrustumCullingObjects;if(e!==this._cullingRendersLength){var i=this._cullingRenders[this._cullingRendersLength];this._cullingRenders[e]=i,i._indexInSceneFrustumCullingObjects=e,t._indexInSceneFrustumCullingObjects=-1}}},n.getRenderQueue=function(t){return this._quenes[t]||(this._quenes[t]=new _t(this))},n.addRenderQuene=function(){this._quenes[this._customRenderQueneIndex++]=new _t(this)},n.addShaderDefine=function(t){this._shaderDefineValue|=t},n.removeShaderDefine=function(t){this._shaderDefineValue&=~t},n.addScript=function(t){return this._addComponent(t)},n.getScriptByType=function(t,e){return void 0===e&&(e=0),this._getComponentByType(t,e)},n.getScriptsByType=function(t,e){this._getComponentsByType(t,e)},n.getScriptByIndex=function(t){return this._getComponentByIndex(t)},n.removeScriptByType=function(t,e){void 0===e&&(e=0),this._removeComponentByType(t,e)},n.removeScriptsByType=function(t){this._removeComponentByType(t)},n.removeAllScript=function(){this._removeAllComponent()},n.render=function(t,e,i){D._context.ctx._renderKey=0,this._childs.length>0&&t.addRenderObject(this)},n.renderSubmit=function(){var t=P.mainContext,e=this._renderState;this._set3DRenderConfig(t),this._prepareSceneToRender(this._renderState);var i,n=0,r=0;if(Qe.debugMode||dt.debugMode)for(n=0,r=this._cameraPool.length;n<r;n++)i=this._cameraPool[n],Qe._debugPhasorSprite.begin(1,i),i.activeInHierarchy&&i._renderCamera(t,e,this),Qe._debugPhasorSprite.end();else for(n=0,r=this._cameraPool.length;n<r;n++)i=this._cameraPool[n],i.activeInHierarchy&&i._renderCamera(t,e,this);return this._set2DRenderConfig(t),1},n.onAsynLoaded=function(t,e,i){var n=e[0];if("Scene"!==n.type)throw new Error("Scene: the .lh file root type must be Scene,please use other function to  load  this file.");var r=e[1];qe._createNodeByJson(this,n,this,r),this.event("hierarchyloaded",[this]),this.__loaded=!0},n.destroy=function(e){void 0===e&&(e=!0),this.destroyed||(t.prototype.destroy.call(this,e),this._renderState=null,this._lights=null,this._lightmaps=null,this._renderTargetTexture=null,this._shaderValues=null,this._cullingRenders=null,this._dynamicBatchManager=null,this._quenes=null,this._cameraPool=null,this._renderableSprite3Ds=null,this.treeRoot=null,this.treeSize=null,this.parallelSplitShadowMaps=null,this._typeComponentsIndices=null,this._components=null,E.clearRes(this.url))},n.getRenderType=function(){return 0},n.releaseRender=function(){},n.createConchModel=function(){var t=new ConchScene;return t.init(512,512,512,4),t},n._addComponent=function(t){var e,i=this._componentsMap.indexOf(t);if(-1===i)e=[],this._componentsMap.push(t),this._typeComponentsIndices.push(e);else if(e=this._typeComponentsIndices[i],this._components[e[0]].isSingleton)throw new Error("无法单实例创建"+t+"组件，"+t+"组件已存在！");var n=m.getInstance(t);e.push(this._components.length),this._components.push(n);var r=this;return n._initialize(r),n},n._removeComponent=function(t,e){var i=this._typeComponentsIndices[t],n=i[e],r=this._components[n];this._components.splice(n,1),i.splice(e,1),0===i.length&&(this._typeComponentsIndices.splice(t,1),this._componentsMap.splice(t,1));for(var a=0,s=this._componentsMap.length;a<s;a++){i=this._typeComponentsIndices[a];for(var o=i.length-1;o>=0;o--){var l=i[o];if(!(l>n))break;i[o]=--l}}r._destroy()},n._getComponentByType=function(t,e){void 0===e&&(e=0);var i=this._componentsMap.indexOf(t);return-1===i?null:this._components[this._typeComponentsIndices[i][e]]},n._getComponentsByType=function(t,e){var i=this._componentsMap.indexOf(t);if(-1===i)return void(e.length=0);var n=this._typeComponentsIndices[i],r=n.length;e.length=r;for(var a=0;a<r;a++)e[a]=this._components[n[a]]},n._getComponentByIndex=function(t){return this._components[t]},n._removeComponentByType=function(t,e){void 0===e&&(e=0);var i=this._componentsMap.indexOf(t);-1!==i&&this._removeComponent(i,e)},n._removeComponentsByType=function(t){var e=this._componentsMap.indexOf(t);if(-1!==e)for(var i=this._typeComponentsIndices[e],n=0,r=i.length;n<r;i.length<r?r--:n++)this._removeComponent(e,n)},n._removeAllComponent=function(){for(var t=0,e=this._componentsMap.length;t<e;this._componentsMap.length<e?e--:t++)this._removeComponentsByType(this._componentsMap[t])},n._updateComponents=function(t){for(var e=0,i=this._components.length;e<i;e++){var n=this._components[e];!n.started&&(n._start(t),n.started=!0),n.enable&&n._update(t)}},n._lateUpdateComponents=function(t){for(var e=0;e<this._components.length;e++){var i=this._components[e];!i.started&&(i._start(t),i.started=!0),i.enable&&i._lateUpdate(t)}},n._preRenderUpdateComponents=function(t){for(var e=0;e<this._components.length;e++){var i=this._components[e];!i.started&&(i._start(t),i.started=!0),i.enable&&i._preRenderUpdate(t)}},n._postRenderUpdateComponents=function(t){for(var e=0;e<this._components.length;e++){var i=this._components[e];!i.started&&(i._start(t),i.started=!0),i.enable&&i._postRenderUpdate(t)}},a(0,n,"_loaded",null,function(t){this.__loaded=t}),a(0,n,"fogColor",function(){return this._fogColor},function(t){this._fogColor=t,this._shaderValues.setValue(0,t.elements)}),a(0,n,"enableFog",function(){return this._enableFog},function(t){this._enableFog!==t&&(this._enableFog=t,t?(this.addShaderDefine(ui.SHADERDEFINE_FOG),this.removeShaderDefine(ui.SAHDERDEFINE_DEPTHFOG)):this.removeShaderDefine(ui.SHADERDEFINE_FOG))}),a(0,n,"url",function(){return this._url}),a(0,n,"loaded",function(){return this.__loaded}),a(0,n,"enableDepthFog",function(){return this._enableDepthFog},function(t){this._enableDepthFog!=t&&(this._enableDepthFog=t,t?(this.addShaderDefine(ui.SAHDERDEFINE_DEPTHFOG),this.removeShaderDefine(ui.SHADERDEFINE_FOG)):this.removeShaderDefine(ui.SAHDERDEFINE_DEPTHFOG))}),a(0,n,"fogStart",function(){return this._fogStart},function(t){this._fogStart=t,this._shaderValues.setValue(1,t)}),a(0,n,"fogRange",function(){return this._fogRange},function(t){this._fogRange=t,this._shaderValues.setValue(2,t)}),a(0,n,"ambientColor",function(){return this._ambientColor},function(t){this._ambientColor=t,this._shaderValues.setValue(21,t.elements)}),a(0,n,"scene",function(){return this}),a(0,n,"renderableSprite3Ds",function(){return this._renderableSprite3Ds.slice()}),e._sortScenes=function(t,n){if(t.parent===i.stage&&n.parent===i.stage){var r=i.stage._childs;return r.indexOf(t)-r.indexOf(n)}return t.parent!==i.stage&&n.parent!==i.stage?e._sortScenes(t.parent,n.parent):t.parent===i.stage?-1:1},e.load=function(t){return i.loader.create(t,null,null,e)},e.FOGCOLOR=0,e.FOGSTART=1,e.FOGRANGE=2,e.LIGHTDIRECTION=3,e.LIGHTDIRCOLOR=4,e.POINTLIGHTPOS=5,e.POINTLIGHTRANGE=6,e.POINTLIGHTATTENUATION=7,e.POINTLIGHTCOLOR=8,e.SPOTLIGHTPOS=9,e.SPOTLIGHTDIRECTION=10,e.SPOTLIGHTSPOT=11,e.SPOTLIGHTRANGE=12,e.SPOTLIGHTATTENUATION=13,e.SPOTLIGHTCOLOR=14,e.SHADOWDISTANCE=15,e.SHADOWLIGHTVIEWPROJECT=16,e.SHADOWMAPPCFOFFSET=17,e.SHADOWMAPTEXTURE1=18,e.SHADOWMAPTEXTURE2=19,e.SHADOWMAPTEXTURE3=20,e.AMBIENTCOLOR=21,e}(R)),Vi=function(t){function e(t){e.__super.call(this),this.__loaded=!0,this._projectionViewWorldUpdateLoopCount=-1,this._activeInHierarchy=!1,this._projectionViewWorldMatrix=new Ae,this._shaderValues=new He,this._colliders=[],this._id=++e._uniqueIDCounter,this._transform=new ii(this),this.name=t||"Sprite3D-"+e._nameNumberCounter++,this.layer=k.currentCreationLayer,this.active=!0}r(e,"laya.d3.core.Sprite3D",t);var n=e.prototype;return i.imps(n,{"laya.d3.core.render.IUpdate":!0,"laya.resource.ICreateResource":!0,"laya.d3.core.IClone":!0}),n._setUrl=function(t){this._url=t},n._getGroup=function(){return this._group},n._setGroup=function(t){this._group=t},n._addChild3D=function(t){t.transform.parent=this.transform,this._hierarchyAnimator&&(!t._hierarchyAnimator&&t._setHierarchyAnimator(this._hierarchyAnimator,null),this._getAnimatorToLinkSprite3D(t,!0,[t.name])),this._scene&&(t._setBelongScene(this._scene),this._activeInHierarchy&&t._active&&t._activeHierarchy())},n._removeChild3D=function(t){t.transform.parent=null,this._scene&&(this._activeInHierarchy&&t._active&&t._inActiveHierarchy(),t._setUnBelongScene()),this._hierarchyAnimator&&(t._hierarchyAnimator==this._hierarchyAnimator&&t._clearHierarchyAnimator(this._hierarchyAnimator,null),this._getAnimatorToLinkSprite3D(t,!1,[t.name]))},n._parseBaseCustomProps=function(t){var e=this.transform.localPosition;e.fromArray(t.translate),this.transform.localPosition=e;var i=this.transform.localRotation;i.fromArray(t.rotation),this.transform.localRotation=i;var n=this.transform.localScale;n.fromArray(t.scale),this.transform.localScale=n;var r=t.layer;null!=r&&(this.layer=k.getLayerByNumber(r))},n._parseCustomComponent=function(t,e,i){for(var n in i){var r=i[n];switch(n){case"Animator":var a=this.addComponent(Si);if(r.avatarPath)a.avatar=E.getRes(e[r.avatarPath]);else{var s=r.avatar;if(s){a.avatar=E.getRes(e[s.path]);var o=s.linkSprites;o&&t.once("hierarchyloaded",this,this._onRootNodeHierarchyLoaded,[a,o])}}for(var l=r.clipPaths,h=l.length,u=0;u<h;u++)a.addClip(E.getRes(e[l[u]]));a.clip=E.getRes(e[l[0]]);var _=r.playOnWake;void 0!==_&&(a.playOnWake=_);break;case"Rigidbody":this.addComponent(Mi);break;case"SphereCollider":var c=this.addComponent(tn);c.isTrigger=r.isTrigger;var d=c.center;d.fromArray(r.center),c.center=d,c.radius=r.radius;break;case"BoxCollider":var f=this.addComponent($i);f.isTrigger=r.isTrigger,f.center.fromArray(r.center);var m=f.size;m.fromArray(r.size),f.size=m;break;case"MeshCollider":this.addComponent(Ji)}}},n._onRootNodeHierarchyLoaded=function(t,e){for(var i in e){for(var n=this,r=e[i],a=0,s=r.length;a<s;a++){var o=r[a];if(""===o)break;if(!(n=n.getChildByName(o)))break}n&&t.linkSprite3DToAvatarNode(i,n)}},n._setHierarchyAnimator=function(t,e){this._changeHierarchyAnimator(t);for(var i=0,n=this._childs.length;i<n;i++){var r=this._childs[i];r._hierarchyAnimator==e&&r._setHierarchyAnimator(t,e)}},n._clearHierarchyAnimator=function(t,e){this._changeHierarchyAnimator(e);for(var i=0,n=this._childs.length;i<n;i++){var r=this._childs[i];r._hierarchyAnimator==t&&r._clearHierarchyAnimator(t,e)}},n._getAnimatorToLinkSprite3D=function(t,e,i){var n=this.getComponentByType(Si);if(n&&(n.avatar?n.avatar._version||t._setAnimatorToLinkAvatar(n,e):t._setAnimatorToLinkSprite3DNoAvatar(n,e,i)),this._parent&&this._parent instanceof laya.d3.core.Sprite3D){i.unshift(this._parent.name);var r=this._parent;r._hierarchyAnimator&&r._getAnimatorToLinkSprite3D(t,e,i)}},n._setAnimatorToLinkSprite3DNoAvatar=function(t,e,i){var n=0,r=0;for(n=0,r=t.getClipCount();n<r;n++)t._handleSpriteOwnersBySprite(n,e,i,this);for(n=0,r=this._childs.length;n<r;n++){var a=this._childs[n],s=i.length;i.push(a.name),a._setAnimatorToLinkSprite3DNoAvatar(t,e,i),i.splice(s,1)}},n._changeHierarchyAnimator=function(t){this._hierarchyAnimator=t},n._isLinkSpriteToAnimationNode=function(t,e,i){var n=t._avatarNodes.indexOf(e),r=t._cacheSpriteToNodesMap;if(i)this._transform.dummy=e.transform,t._cacheNodesToSpriteMap[n]=r.length,r.push(n);else{this._transform.dummy=null;var a=t._cacheNodesToSpriteMap[n];t._cacheNodesToSpriteMap[n]=null,r.splice(a,1)}},n._setBelongScene=function(t){this._scene=t;for(var e=0,i=this._childs.length;e<i;e++)this._childs[e]._setBelongScene(t)},n._setUnBelongScene=function(){this._scene=null;for(var t=0,e=this._childs.length;t<e;t++)this._childs[t]._setUnBelongScene()},n._activeHierarchy=function(){var t=0,e=0;for(this._activeInHierarchy=!0,this._addSelfRenderObjects(),t=0,e=this._colliders.length;t<e;t++)this._layer._addCollider(this._colliders[t]);for(this.event("activeinhierarchychanged",!0),t=0,e=this._childs.length;t<e;t++){var i=this._childs[t];i._active&&i._activeHierarchy()}},n._inActiveHierarchy=function(){var t=0,e=0;for(this._activeInHierarchy=!1,this._clearSelfRenderObjects(),t=0,e=this._colliders.length;t<e;t++){var i=this._colliders[t];i._clearCollsionMap(),this._layer._removeCollider(i)}for(this.event("activeinhierarchychanged",!1),t=0,e=this._childs.length;t<e;t++){var n=this._childs[t];n._active&&n._inActiveHierarchy()}},n.addComponent=function(t){var e,i=this._componentsMap.indexOf(t);if(-1===i)e=[],this._componentsMap.push(t),this._typeComponentsIndices.push(e);else if(e=this._typeComponentsIndices[i],this._components[e[0]].isSingleton)throw new Error("无法单实例创建"+t+"组件，"+t+"组件已存在！");var n=m.getInstance(t);if(e.push(this._components.length),this._components.push(n),n instanceof laya.d3.component.physics.Collider){this.getComponentByType(Mi)&&(n._isRigidbody=!0),this.displayedInStage&&this._layer._addCollider(n),this._colliders.push(n)}else if(n instanceof laya.d3.component.Animator){var r=n;this._setHierarchyAnimator(r,this._parent?this._parent._hierarchyAnimator:null),this._setAnimatorToLinkSprite3DNoAvatar(r,!0,[])}else if(n instanceof laya.d3.component.Rigidbody)for(var a=0,s=this._colliders.length;a<s;a++)this._colliders[a]._setIsRigidbody(!0);return n instanceof laya.d3.component.Script&&this._scripts.push(n),n._initialize(this),n},n._removeComponent=function(t,e){var i=0,n=0,r=this._typeComponentsIndices[t],a=r[e],s=this._components[a];if(s instanceof laya.d3.component.physics.Collider){var o=s;this.displayedInStage&&this._layer._removeCollider(o),this._colliders.splice(this._colliders.indexOf(o),1)}else if(s instanceof laya.d3.component.Animator){var l=s;this._clearHierarchyAnimator(l,this._parent?this._parent._hierarchyAnimator:null)}else if(s instanceof laya.d3.component.Rigidbody)for(i=0,n=this._colliders.length;i<n;i++){var h=this._colliders[i];h._setIsRigidbody(!1);var u=h._runtimeCollisonMap,_=h._runtimeCollisonTestMap;for(var c in u)delete _[c]}for(this._components.splice(a,1),s instanceof laya.d3.component.Script&&this._scripts.splice(this._scripts.indexOf(s),1),r.splice(e,1),0===r.length&&(this._typeComponentsIndices.splice(t,1),this._componentsMap.splice(t,1)),i=0,n=this._componentsMap.length;i<n;i++){r=this._typeComponentsIndices[i];for(var d=r.length-1;d>=0;d--){var f=r[d];if(!(f>a))break;r[d]=--f}}s._destroy()},n.createConchModel=function(){return null},n._clearSelfRenderObjects=function(){},n._addSelfRenderObjects=function(){},n._parseCustomProps=function(t,e,i,n){},n._updateChilds=function(t){var e=this._childs.length;if(0!==e)for(var i=0;i<e;++i)this._childs[i]._update(t)},n._updateChildsConch=function(t){var e=this._childs.length;if(0!==e)for(var i=0;i<e;++i)this._childs[i]._update(t)},n._getSortID=function(t,e){return 1e3*e.id+t._getVertexBuffer().vertexDeclaration.id},n._update=function(t){t.owner=this,this._activeInHierarchy&&(this._updateComponents(t),this._lateUpdateComponents(t),C.spriteCount++,this._childs.length&&this._updateChilds(t))},n._updateConch=function(t){t.owner=this,this._activeInHierarchy&&(this._updateComponents(t),this._lateUpdateComponents(t),C.spriteCount++,this._childs.length&&this._updateChilds(t))},n.getProjectionViewWorldMatrix=function(t){return Ae.multiply(t,this.transform.worldMatrix,this._projectionViewWorldMatrix),this._projectionViewWorldMatrix},n.loadHierarchy=function(t){this.addChild(laya.d3.core.Sprite3D.load(t))},n.addChildAt=function(t,e){if(!(t instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");if(!t||this.destroyed||t===this)return t;if(t.zOrder&&this._set$P("hasZorder",!0),e>=0&&e<=this._childs.length){if(t._parent===this){var i=this.getChildIndex(t);this._childs.splice(i,1),this._childs.splice(e,0,t),this.conchModel&&(this.conchModel.removeChild(t.conchModel),this.conchModel.addChildAt(t.conchModel,e)),this._childChanged()}else t.parent&&t.parent.removeChild(t),this._childs===S.ARRAY_EMPTY&&(this._childs=[]),this._childs.splice(e,0,t),this.conchModel&&this.conchModel.addChildAt(t.conchModel,e),t.parent=this,this._addChild3D(t);return t}throw new Error("appendChildAt:The index is out of bounds")},n.addChild=function(t){if(!(t instanceof laya.d3.core.Sprite3D))throw new Error("Sprite3D:Node type must Sprite3D.");if(!t||this.destroyed||t===this)return t;if(t.zOrder&&this._set$P("hasZorder",!0),t._parent===this){var e=this.getChildIndex(t);e!==this._childs.length-1&&(this._childs.splice(e,1),this._childs.push(t),this.conchModel&&(this.conchModel.removeChild(t.conchModel),this.conchModel.addChildAt(t.conchModel,this._childs.length-1)),this._childChanged())}else t.parent&&t.parent.removeChild(t),this._childs===S.ARRAY_EMPTY&&(this._childs=[]),this._childs.push(t),this.conchModel&&this.conchModel.addChildAt(t.conchModel,this._childs.length-1),t.parent=this,this._childChanged(),this._addChild3D(t);return t},n.removeChildAt=function(t){var e=this.getChildAt(t);return e&&(this._removeChild3D(e),this._childs.splice(t,1),this.conchModel&&this.conchModel.removeChild(e.conchModel),e.parent=null),e},n.removeChildren=function(t,e){if(void 0===t&&(t=0),void 0===e&&(e=2147483647),this._childs&&this._childs.length>0){var i=this._childs;if(0===t&&e>=a){var n=i;this._childs=S.ARRAY_EMPTY}else n=i.splice(t,e-t);for(var r=0,a=n.length;r<a;r++)this._removeChild3D(n[r]),n[r].parent=null,this.conchModel&&this.conchModel.removeChild(n[r].conchModel)}return this},n.onAsynLoaded=function(t,e,i){var n=e[0];if("Sprite3D"!==n.type)throw new Error("Sprite3D: The .lh file root type must be Sprite3D,please use other function to  load  this file.");var r=e[1];qe._createNodeByJson(this,n,this,r),this.event("hierarchyloaded",[this]),this.__loaded=!0},n.cloneTo=function(t){if(this.destroyed)throw new Error("Sprite3D: Can't be cloned if the Sprite3D has destroyed.");var e=t;e.name=this.name,e._destroyed=this._destroyed,e.timer=this.timer,e._$P=this._$P,e.active=this._active;var i=e.transform.localPosition;this.transform.localPosition.cloneTo(i),e.transform.localPosition=i;var n=e.transform.localRotation;this.transform.localRotation.cloneTo(n),e.transform.localRotation=n;var r=e.transform.localScale;this.transform.localScale.cloneTo(r),e.transform.localScale=r,e.isStatic=this.isStatic;var a=0,s=0;for(a=0,s=this._componentsMap.length;a<s;a++){var o=e.addComponent(this._componentsMap[a]);this._components[a]._cloneTo(o)}for(a=0,s=this._childs.length;a<s;a++)e.addChild(this._childs[a].clone())},n.clone=function(){var t=new this.constructor;return this.cloneTo(t),t},n.destroy=function(t){if(void 0===t&&(t=!0),!this.destroyed){laya.display.Node.prototype.destroy.call(this,t);var e=0,i=0;for(e=0,i=this._components.length;e<i;e++)this._components[e]._destroy();this._components=null,this._componentsMap=null,this._typeComponentsIndices=null,this._transform=null,this._colliders=null,E.clearRes(this.url)}},n._handleSpriteToAvatar=function(t,e){var i=(t._avatarNodes,t._avatarNodeMap[this.name]);i&&i.name===this.name&&!this._transform.dummy&&this._isLinkSpriteToAnimationNode(t,i,e)},n._setAnimatorToLinkAvatar=function(t,e){this._handleSpriteToAvatar(t,e);for(var i=0,n=this._childs.length;i<n;i++){this._childs[i]._setAnimatorToLinkAvatar(t,e)}},a(0,n,"activeInHierarchy",function(){return this._activeInHierarchy}),a(0,n,"_loaded",null,function(t){this.__loaded=t}),a(0,n,"active",function(){return this._active},function(t){this._active!==t&&(this._active=t,this._parent&&(this._parent===this._scene&&this._parent.displayedInStage||this._parent._activeInHierarchy)&&(t?this._activeHierarchy():this._inActiveHierarchy()))}),a(0,n,"componentsCount",function(){return this._components.length}),a(0,n,"loaded",function(){return this.__loaded}),a(0,n,"id",function(){return this._id}),a(0,n,"url",function(){return this._url}),a(0,n,"layer",function(){return this._layer},function(t){if(!t)throw new Error("Layer value can be null.");if(this.displayedInStage){var e=0,i=this._colliders.length;if(this._layer)for(e=0;e<i;e++)this._layer._removeCollider(this._colliders[e]);for(e=0;e<i;e++)t._addCollider(this._colliders[e])}this._layer=t,this.event("layerchanged",t)}),a(0,n,"scene",function(){return this._scene}),a(0,n,"transform",function(){return this._transform}),e.instantiate=function(t,e,i,n,r){void 0===i&&(i=!0);var a=t.clone();e&&e.addChild(a);var s=a.transform;if(i){var o=s.worldMatrix;t.transform.worldMatrix.cloneTo(o),s.worldMatrix=o}else n&&(s.position=n),r&&(s.rotation=r);return a},e.load=function(t){return i.loader.create(t,null,null,e)},e.WORLDMATRIX=0,e.MVPMATRIX=1,e._uniqueIDCounter=0,e._nameNumberCounter=0,e}(di),Fi=function(t){function e(t,i,n,r,a,s,o,l){if(this.customCompile=!1,this._curActTexIndex=0,this._program=null,this._attributeParams=null,this._uniformParams=null,this._attributeParamsMap=[],this._sceneUniformParamsMap=[],this._cameraUniformParamsMap=[],this._spriteUniformParamsMap=[],this._materialUniformParamsMap=[],this._renderElementUniformParamsMap=[],e.__super.call(this),!t||!i)throw"Shader Error";(D.isConchApp||D.isFlash)&&(this.customCompile=!0),this._id=++e._count,this._vs=t,this._ps=i,this._attributeMap=n,this._sceneUniformMap=r,this._cameraUniformMap=a,this._spriteUniformMap=s,this._materialUniformMap=o,this._renderElementUniformMap=l,this.recreateResource()}r(e,"laya.d3.shader.Shader3D",t);var i=e.prototype;return i.recreateResource=function(){this._compile(),this.completeCreate(),this.memorySize=0},i.disposeResource=function(){P.mainContext.deleteShader(this._vshader),P.mainContext.deleteShader(this._pshader),P.mainContext.deleteProgram(this._program),this._vshader=this._pshader=this._program=null,this._attributeParams=null,this._uniformParams=null,this.memorySize=0,this._curActTexIndex=0},i._compile=function(){if(this._vs&&this._ps&&!this._attributeParams&&!this._uniformParams){this._reCompile=!0,this._attributeParams=[],this._uniformParams=[];var t=[this._vs,this._ps],i=P.mainContext;if(this._program=i.createProgram(),this._vshader=e._createShader(i,t[0],35633),this._pshader=e._createShader(i,t[1],35632),i.attachShader(this._program,this._vshader),i.attachShader(this._program,this._pshader),i.linkProgram(this._program),ui.debugMode&&!this.customCompile&&!i.getProgramParameter(this._program,35714))throw i.getProgramInfoLog(this._program);var n,r,a=0,s=0,o=this.customCompile?(void 0).attributes.length:i.getProgramParameter(this._program,35721);for(a=0;a<o;a++){var l=this.customCompile?(void 0).attributes[a]:i.getActiveAttrib(this._program,a);r=i.getAttribLocation(this._program,l.name),n={vartype:"attribute",ivartype:0,attrib:l,location:r,name:l.name,type:l.type,isArray:!1,isSame:!1,preValue:null,indexOfParams:0},this._attributeParams.push(n)}var h=this.customCompile?(void 0).uniforms.length:i.getProgramParameter(this._program,35718);for(a=0;a<h;a++){var u=this.customCompile?(void 0).uniforms[a]:i.getActiveUniform(this._program,a);r=i.getUniformLocation(this._program,u.name),n={vartype:"uniform",ivartype:1,attrib:l,location:r,name:u.name,type:u.type,isArray:!1,isSame:!1,preValue:null,indexOfParams:0},n.name.indexOf("[0]")>0&&(n.name=n.name.substr(0,n.name.length-3),n.isArray=!0,n.location=i.getUniformLocation(this._program,n.name)),this._uniformParams.push(n)}for(a=0,s=this._attributeParams.length;a<s;a++)n=this._attributeParams[a],n.indexOfParams=a,n.index=1,n.value=[n.location,null],n.codename=n.name,n.name=null!=this._attributeMap[n.codename]?this._attributeMap[n.codename]:n.codename,this._attributeParamsMap.push(n.name),this._attributeParamsMap.push(n),n._this=this,n.uploadedValue=[],n.fun=this._attribute;for(a=0,s=this._uniformParams.length;a<s;a++)switch(n=this._uniformParams[a],n.indexOfParams=a,n.index=1,n.value=[n.location,null],n.codename=n.name,null!=this._sceneUniformMap[n.codename]?(n.name=this._sceneUniformMap[n.codename],this._sceneUniformParamsMap.push(n.name),this._sceneUniformParamsMap.push(n)):null!=this._cameraUniformMap[n.codename]?(n.name=this._cameraUniformMap[n.codename],this._cameraUniformParamsMap.push(n.name),this._cameraUniformParamsMap.push(n)):null!=this._spriteUniformMap[n.codename]?(n.name=this._spriteUniformMap[n.codename],this._spriteUniformParamsMap.push(n.name),this._spriteUniformParamsMap.push(n)):null!=this._materialUniformMap[n.codename]?(n.name=this._materialUniformMap[n.codename],this._materialUniformParamsMap.push(n.name),this._materialUniformParamsMap.push(n)):null!=this._renderElementUniformMap[n.codename]?(n.name=this._renderElementUniformMap[n.codename],this._renderElementUniformParamsMap.push(n.name),this._renderElementUniformParamsMap.push(n)):console.log("Shader:can't find uinform name:"+n.codename+" in shader file."),n._this=this,n.uploadedValue=[],n.type){case 5124:n.fun=n.isArray?this._uniform1iv:this._uniform1i;break;case 5126:n.fun=n.isArray?this._uniform1fv:this._uniform1f;break;case 35664:n.fun=n.isArray?this._uniform_vec2v:this._uniform_vec2;break;case 35665:n.fun=n.isArray?this._uniform_vec3v:this._uniform_vec3;break;case 35666:n.fun=n.isArray?this._uniform_vec4v:this._uniform_vec4;break;case 35678:n.fun=this._uniform_sampler2D;break;case 35680:n.fun=this._uniform_samplerCube;break;case 35676:n.fun=this._uniformMatrix4fv;break;case 35670:n.fun=this._uniform1i;break;case 35674:n.fun=this._uinformMatrix2fv;break;case 35675:n.fun=this._uinformMatrix3fv;break;default:throw new Error("compile shader err!")}}},i._attribute=function(t,e){var i=P.mainContext,n=d._enableAtributes,r=t.location;return n[r]||i.enableVertexAttribArray(r),i.vertexAttribPointer(r,e[0],e[1],e[2],e[3],e[4]),n[r]=d._bindVertexBuffer,1},i._uniform1f=function(t,e){var i=t.uploadedValue;return i[0]!==e?(P.mainContext.uniform1f(t.location,i[0]=e),1):0},i._uniform1fv=function(t,e){if(e.length<4){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]||i[2]!==e[2]||i[3]!==e[3]?(P.mainContext.uniform1fv(t.location,e),i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],1):0}return P.mainContext.uniform1fv(t.location,e),1},i._uniform_vec2=function(t,e){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]?(P.mainContext.uniform2f(t.location,i[0]=e[0],i[1]=e[1]),1):0},i._uniform_vec2v=function(t,e){if(e.length<2){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]||i[2]!==e[2]||i[3]!==e[3]?(P.mainContext.uniform2fv(t.location,e),i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],1):0}return P.mainContext.uniform2fv(t.location,e),1},i._uniform_vec3=function(t,e){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]||i[2]!==e[2]?(P.mainContext.uniform3f(t.location,i[0]=e[0],i[1]=e[1],i[2]=e[2]),1):0},i._uniform_vec3v=function(t,e){return P.mainContext.uniform3fv(t.location,e),1},i._uniform_vec4=function(t,e){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]||i[2]!==e[2]||i[3]!==e[3]?(P.mainContext.uniform4f(t.location,i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3]),1):0},i._uniform_vec4v=function(t,e){return P.mainContext.uniform4fv(t.location,e),1},i._uniformMatrix2fv=function(t,e){return P.mainContext.uniformMatrix2fv(t.location,!1,e),1},i._uniformMatrix3fv=function(t,e){return P.mainContext.uniformMatrix3fv(t.location,!1,e),1},i._uniformMatrix4fv=function(t,e){return P.mainContext.uniformMatrix4fv(t.location,!1,e),1},i._uinformMatrix2fv=function(t,e){return P.mainContext.uniformMatrix2fv(t.location,!1,e),1},i._uinformMatrix3fv=function(t,e){return P.mainContext.uniformMatrix3fv(t.location,!1,e),1},i._uniform1i=function(t,e){var i=t.uploadedValue;return i[0]!==e?(P.mainContext.uniform1i(t.location,i[0]=e),1):0},i._uniform1iv=function(t,e){return P.mainContext.uniform1iv(t.location,e),1},i._uniform_ivec2=function(t,e){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]?(P.mainContext.uniform2i(t.location,i[0]=e[0],i[1]=e[1]),1):0},i._uniform_ivec2v=function(t,e){return P.mainContext.uniform2iv(t.location,e),1},i._uniform_vec3i=function(t,e){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]||i[2]!==e[2]?(P.mainContext.uniform3i(t.location,i[0]=e[0],i[1]=e[1],i[2]=e[2]),1):0},i._uniform_vec3vi=function(t,e){return P.mainContext.uniform3iv(t.location,e),1},i._uniform_vec4i=function(t,e){var i=t.uploadedValue;return i[0]!==e[0]||i[1]!==e[1]||i[2]!==e[2]||i[3]!==e[3]?(P.mainContext.uniform4i(t.location,i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3]),1):0},i._uniform_vec4vi=function(t,e){return P.mainContext.uniform4iv(t.location,e),1},i._uniform_sampler2D=function(t,i){var n=i.source||i.defaulteTexture.source,r=P.mainContext,a=t.uploadedValue;if(null==a[0]){if(this._curActTexIndex>7)throw new Error("Shader3D: shader support textures max count is 8,can't large than it.");return a[0]=this._curActTexIndex,r.uniform1i(t.location,this._curActTexIndex),r.activeTexture(e._TEXTURES[this._curActTexIndex]),n&&L.bindTexture(r,3553,n),this._curActTexIndex++,1}return r.activeTexture(e._TEXTURES[a[0]]),n&&L.bindTexture(r,3553,n),0},i._uniform_samplerCube=function(t,i){var n=i.source||i.defaulteTexture.source,r=P.mainContext,a=t.uploadedValue;if(null==a[0]){if(this._curActTexIndex>7)throw new Error("Shader3D: shader support textures max count is 8,can't large than it.");return a[0]=this._curActTexIndex,r.uniform1i(t.location,this._curActTexIndex),r.activeTexture(e._TEXTURES[this._curActTexIndex]),n?L.bindTexture(r,34067,n):L.bindTexture(r,34067,on.grayTexture.source),this._curActTexIndex++,1}return r.activeTexture(e._TEXTURES[a[0]]),n?L.bindTexture(r,34067,n):L.bindTexture(r,34067,on.grayTexture.source),0},i._noSetValue=function(t){console.log("no....:"+t.name)},i.bind=function(){return _.activeShader=this,_.bindShader=this,this.activeResource(),L.UseProgram(this._program)},i.uploadAttributes=function(t,e){for(var i,n,r=0,a=0,s=this._attributeParamsMap.length;a<s;a+=2)n=this._attributeParamsMap[a+1],null!=(i=t[this._attributeParamsMap[a]])&&(e&&e[n.name]&&e[n.name].bind(),r+=n.fun.call(this,n,i));C.shaderCall+=r},i.uploadAttributesX=function(t,e){for(var i,n,r=0,a=0,s=this._attributeParamsMap.length;a<s;a+=2)n=this._attributeParamsMap[a+1],null!=(i=t[this._attributeParamsMap[a]])&&(e._bind(),r+=n.fun.call(this,n,i));C.shaderCall+=r},i.uploadSceneUniforms=function(t){for(var e,i,n=0,r=0,a=this._sceneUniformParamsMap.length;r<a;r+=2)i=this._sceneUniformParamsMap[r+1],null!=(e=t[this._sceneUniformParamsMap[r]])&&(n+=i.fun.call(this,i,e));C.shaderCall+=n},i.uploadCameraUniforms=function(t){for(var e,i,n=0,r=0,a=this._cameraUniformParamsMap.length;r<a;r+=2)i=this._cameraUniformParamsMap[r+1],null!=(e=t[this._cameraUniformParamsMap[r]])&&(n+=i.fun.call(this,i,e));C.shaderCall+=n},i.uploadSpriteUniforms=function(t){for(var e,i,n=0,r=0,a=this._spriteUniformParamsMap.length;r<a;r+=2)i=this._spriteUniformParamsMap[r+1],null!=(e=t[this._spriteUniformParamsMap[r]])&&(n+=i.fun.call(this,i,e));C.shaderCall+=n},i.uploadMaterialUniforms=function(t){for(var e,i,n=0,r=0,a=this._materialUniformParamsMap.length;r<a;r+=2)i=this._materialUniformParamsMap[r+1],null!=(e=t[this._materialUniformParamsMap[r]])&&(n+=i.fun.call(this,i,e));C.shaderCall+=n},i.uploadRenderElementUniforms=function(t){for(var e,i,n=0,r=0,a=this._renderElementUniformParamsMap.length;r<a;r+=2)i=this._renderElementUniformParamsMap[r+1],null!=(e=t[this._renderElementUniformParamsMap[r]])&&(n+=i.fun.call(this,i,e));C.shaderCall+=n},e.create=function(t,i,n,r,a,s,o,l){return new e(t,i,n,r,a,s,o,l)},e.addInclude=function(t,e){I.addInclude(t,e)},e._createShader=function(t,e,i){var n=t.createShader(i);if(t.shaderSource(n,e),t.compileShader(n),ui.debugMode&&!t.getShaderParameter(n,35713))throw t.getShaderInfoLog(n);return n},e.PERIOD_RENDERELEMENT=0,e.PERIOD_MATERIAL=1,e.PERIOD_SPRITE=2,e.PERIOD_CAMERA=3,e.PERIOD_SCENE=4,e._count=0,n(e,["_TEXTURES",function(){return this._TEXTURES=[33984,33985,33986,33987,33988,33989,33990,33991]},"shaderParamsMap",function(){return this.shaderParamsMap={float:5126,int:5124,bool:35670,vec2:35664,vec3:35665,vec4:35666,ivec2:35667,ivec3:35668,ivec4:35669,bvec2:35671,bvec3:35672,bvec4:35673,mat2:35674,mat3:35675,mat4:35676,sampler2D:35678,samplerCube:35680}},"nameKey",function(){return this.nameKey=new b}]),e}(_),Bi=function(t){function e(){e.__super.call(this),this.setShaderName("BLINNPHONG"),this._albedoIntensity=1,this._albedoColor=new Le(1,1,1,1),this._setColor(6,new Le(1,1,1,1)),this._setColor(8,new Pe(1,1,1)),this._setNumber(9,.078125),this._setColor(10,new Pe(1,1,1)),this._setNumber(0,.5),this._setColor(11,new Le(1,1,0,0)),this._enableLighting=!0,this.renderMode=0}r(e,"laya.d3.core.material.BlinnPhongMaterial",t);var s=e.prototype;return s.disableLight=function(){this._addDisablePublicShaderDefine(ui.SHADERDEFINE_POINTLIGHT|ui.SHADERDEFINE_SPOTLIGHT|ui.SHADERDEFINE_DIRECTIONLIGHT)},s.disableFog=function(){this._addDisablePublicShaderDefine(ui.SHADERDEFINE_FOG)},a(0,s,"renderMode",null,function(t){switch(t){case 0:this.renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0,this.alphaTest=!1,this.depthTest=513,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 1:this.depthWrite=!0,this.cull=2,this.blend=0,this.renderQueue=1,this.alphaTest=!0,this.depthTest=513,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 2:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this.depthTest=513,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 3:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this.depthTest=513,this._addShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("Material:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(t)}),a(0,s,"normalTexture",function(){return this._getTexture(2)},function(t){t?this._addShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_NORMALMAP):this._removeShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_NORMALMAP),this._setTexture(2,t)}),a(0,s,"reflectColor",function(){return this._getColor(10)},function(t){this._setColor(10,t)}),a(0,s,"tilingOffset",function(){return this._getColor(11)},function(t){if(t){var e=t.elements;1!=e[0]||1!=e[1]||0!=e[2]||0!=e[3]?this._addShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_TILINGOFFSET):this._removeShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_TILINGOFFSET)}else this._removeShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_TILINGOFFSET);this._setColor(11,t)}),a(0,s,"specularColor",function(){return this._getColor(8)},function(t){this._setColor(8,t)}),a(0,s,"albedoColor",function(){return this._albedoColor},function(t){var e=this._getColor(6);Le.scale(t,this._albedoIntensity,e),this._albedoColor=t}),a(0,s,"albedoIntensity",function(){return this._albedoIntensity},function(t){if(this._albedoIntensity!==t){var e=this._getColor(6);Le.scale(this._albedoColor,t,e),this._albedoIntensity=t}}),a(0,s,"albedoTexture",function(){return this._getTexture(1)},function(t){t?this._addShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_DIFFUSEMAP):this._removeShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_DIFFUSEMAP),this._setTexture(1,t)}),a(0,s,"shininess",function(){return this._getNumber(9)},function(t){t=Math.max(0,Math.min(1,t)),this._setNumber(9,t)}),a(0,s,"specularTexture",function(){return this._getTexture(3)},function(t){t?this._addShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_SPECULARMAP):this._removeShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_SPECULARMAP),this._setTexture(3,t)}),a(0,s,"reflectTexture",function(){return this._getTexture(5)},function(t){t?this._addShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_REFLECTMAP):this._removeShaderDefine(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_REFLECTMAP),this._setTexture(5,t)}),a(0,s,"enableLighting",function(){return this._enableLighting},function(t){this._enableLighting!==t&&(t?this._removeDisablePublicShaderDefine(ui.SHADERDEFINE_POINTLIGHT|ui.SHADERDEFINE_SPOTLIGHT|ui.SHADERDEFINE_DIRECTIONLIGHT):this._addDisablePublicShaderDefine(ui.SHADERDEFINE_POINTLIGHT|ui.SHADERDEFINE_SPOTLIGHT|ui.SHADERDEFINE_DIRECTIONLIGHT),this._enableLighting=t)}),e.__init__=function(){e.SHADERDEFINE_DIFFUSEMAP=e.shaderDefines.registerDefine("DIFFUSEMAP"),e.SHADERDEFINE_NORMALMAP=e.shaderDefines.registerDefine("NORMALMAP"),e.SHADERDEFINE_SPECULARMAP=e.shaderDefines.registerDefine("SPECULARMAP"),e.SHADERDEFINE_REFLECTMAP=e.shaderDefines.registerDefine("REFLECTMAP"),e.SHADERDEFINE_TILINGOFFSET=e.shaderDefines.registerDefine("TILINGOFFSET"),e.SHADERDEFINE_ADDTIVEFOG=e.shaderDefines.registerDefine("ADDTIVEFOG")},e.load=function(t){return i.loader.create(t,null,null,e)},e.SPECULARSOURCE_DIFFUSEMAPALPHA=0,e.SPECULARSOURCE_SPECULARMAP=0,e.RENDERMODE_OPAQUE=0,e.RENDERMODE_CUTOUT=1,e.RENDERMODE_TRANSPARENT=2,e.RENDERMODE_ADDTIVE=3,e.SHADERDEFINE_DIFFUSEMAP=0,e.SHADERDEFINE_NORMALMAP=0,e.SHADERDEFINE_SPECULARMAP=0,e.SHADERDEFINE_REFLECTMAP=0,e.SHADERDEFINE_TILINGOFFSET=0,e.SHADERDEFINE_ADDTIVEFOG=0,e.ALBEDOTEXTURE=1,e.NORMALTEXTURE=2,e.SPECULARTEXTURE=3,e.EMISSIVETEXTURE=4,e.REFLECTTEXTURE=5,e.ALBEDOCOLOR=6,e.MATERIALSPECULAR=8,e.SHININESS=9,e.MATERIALREFLECT=10,e.TILINGOFFSET=11,n(e,["defaultMaterial",function(){return this.defaultMaterial=new e},"shaderDefines",function(){return this.shaderDefines=new Be(pi.shaderDefines)}]),e}(pi),Ui=function(t){function e(){e.__super.call(this),this.setShaderName("ExtendTerrain"),this.renderMode=1}r(e,"laya.d3.core.material.ExtendTerrainMaterial",t);var i=e.prototype;return i._setDetailNum=function(t){switch(t){case 1:this._addShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 2:this._addShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 3:this._addShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 4:this._addShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 5:this._addShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4)}},i.disableLight=function(){this._addDisablePublicShaderDefine(ui.SHADERDEFINE_POINTLIGHT|ui.SHADERDEFINE_SPOTLIGHT|ui.SHADERDEFINE_DIRECTIONLIGHT)},a(0,i,"diffuseScaleOffset2",null,function(t){this._setColor(7,t)}),a(0,i,"splatAlphaTexture",function(){return this._getTexture(0)},function(t){this._setTexture(0,t)}),a(0,i,"diffuseScaleOffset3",null,function(t){this._setColor(8,t)}),a(0,i,"diffuseTexture1",null,function(t){this._setTexture(1,t),this._setDetailNum(1)}),a(0,i,"renderMode",null,function(t){switch(t){case 1:this.renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0,this.depthTest=513;break;case 2:this.renderQueue=1,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.depthTest=515;break;default:throw new Error("ExtendTerrainMaterial:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(t)}),a(0,i,"diffuseTexture2",function(){return this._getTexture(2)},function(t){this._setTexture(2,t),this._setDetailNum(2)}),a(0,i,"diffuseScaleOffset1",null,function(t){this._setColor(6,t)}),a(0,i,"diffuseTexture3",function(){return this._getTexture(3)},function(t){this._setTexture(3,t),this._setDetailNum(3)}),a(0,i,"diffuseTexture4",function(){return this._getTexture(4)},function(t){this._setTexture(4,t),this._setDetailNum(4)}),a(0,i,"diffuseTexture5",function(){return this._getTexture(5)},function(t){this._setTexture(5,t),this._setDetailNum(5)}),a(0,i,"diffuseScaleOffset4",null,function(t){this._setColor(9,t)}),a(0,i,"diffuseScaleOffset5",null,function(t){this._setColor(10,t)}),a(0,i,"albedo",function(){return this._getColor(14)},function(t){this._setColor(14,t)}),a(0,i,"ambientColor",function(){return this._getColor(11)},function(t){this._setColor(11,t)}),a(0,i,"diffuseColor",function(){return this._getColor(12)},function(t){this._setColor(12,t)}),a(0,i,"specularColor",function(){return this._getColor(13)},function(t){this._setColor(13,t)}),e.__init__=function(){e.SHADERDEFINE_DETAIL_NUM1=e.shaderDefines.registerDefine("ExtendTerrain_DETAIL_NUM1"),e.SHADERDEFINE_DETAIL_NUM2=e.shaderDefines.registerDefine("ExtendTerrain_DETAIL_NUM2"),e.SHADERDEFINE_DETAIL_NUM3=e.shaderDefines.registerDefine("ExtendTerrain_DETAIL_NUM3"),e.SHADERDEFINE_DETAIL_NUM4=e.shaderDefines.registerDefine("ExtendTerrain_DETAIL_NUM4"),e.SHADERDEFINE_DETAIL_NUM5=e.shaderDefines.registerDefine("ExtendTerrain_DETAIL_NUM5")},e.RENDERMODE_OPAQUE=1,e.RENDERMODE_TRANSPARENT=2,e.SPLATALPHATEXTURE=0,e.DIFFUSETEXTURE1=1,e.DIFFUSETEXTURE2=2,e.DIFFUSETEXTURE3=3,e.DIFFUSETEXTURE4=4,e.DIFFUSETEXTURE5=5,e.DIFFUSESCALEOFFSET1=6,e.DIFFUSESCALEOFFSET2=7,e.DIFFUSESCALEOFFSET3=8,e.DIFFUSESCALEOFFSET4=9,e.DIFFUSESCALEOFFSET5=10,e.MATERIALAMBIENT=11,e.MATERIALDIFFUSE=12,e.MATERIALSPECULAR=13,e.MATERIALALBEDO=14,e.SHADERDEFINE_DETAIL_NUM1=0,e.SHADERDEFINE_DETAIL_NUM2=0,e.SHADERDEFINE_DETAIL_NUM3=0,e.SHADERDEFINE_DETAIL_NUM4=0,e.SHADERDEFINE_DETAIL_NUM5=0,n(e,["shaderDefines",function(){return this.shaderDefines=new Be(pi.shaderDefines)}]),e}(pi),Hi=function(t){function e(){e.__super.call(this),this.setShaderName("GLITTER"),this.renderMode=1,this._setColor(3,new Le(1,1,1,1)),this._setColor(2,new Le(1,1,1,1))}r(e,"laya.d3.core.material.GlitterMaterial",t);var s=e.prototype;return s.setShaderName=function(e){t.prototype.setShaderName.call(this,e)},a(0,s,"renderMode",null,function(t){switch(t){case 1:this.renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0;break;case 2:this.renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0;break;case 13:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 14:this.renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 15:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;case 16:this.renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;case 5:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 6:this.renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 7:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;case 8:this.renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;case 9:this.renderQueue=2,this.depthTest=513,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 10:this.renderQueue=2,this.depthTest=513,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;case 11:this.renderQueue=2,this.depthTest=513,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;case 12:this.renderQueue=2,this.depthTest=513,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1;break;default:throw new Error("Material:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(t)}),a(0,s,"diffuseTexture",function(){return this._getTexture(1)},function(t){this._setTexture(1,t)}),a(0,s,"albedo",function(){return this._getColor(2)},function(t){this._setColor(2,t)}),a(0,s,"color",function(){return this._getColor(3)},function(t){this._setColor(3,t)}),e.load=function(t){return i.loader.create(t,null,null,e)},e.RENDERMODE_OPAQUE=1,e.RENDERMODE_OPAQUEDOUBLEFACE=2,e.RENDERMODE_TRANSPARENT=13,e.RENDERMODE_TRANSPARENTDOUBLEFACE=14,e.RENDERMODE_ADDTIVE=15,e.RENDERMODE_ADDTIVEDOUBLEFACE=16,e.RENDERMODE_DEPTHREAD_TRANSPARENT=5,e.RENDERMODE_DEPTHREAD_TRANSPARENTDOUBLEFACE=6,e.RENDERMODE_DEPTHREAD_ADDTIVE=7,e.RENDERMODE_DEPTHREAD_ADDTIVEDOUBLEFACE=8,e.RENDERMODE_NONDEPTH_TRANSPARENT=9,e.RENDERMODE_NONDEPTH_TRANSPARENTDOUBLEFACE=10,e.RENDERMODE_NONDEPTH_ADDTIVE=11,e.RENDERMODE_NONDEPTH_ADDTIVEDOUBLEFACE=12,e.DIFFUSETEXTURE=1,e.ALBEDO=2,e.UNICOLOR=3,n(e,["defaultMaterial",function(){return this.defaultMaterial=new e}]),e}(pi),Gi=function(t){function e(){if(this._transformUV=null,e.__super.call(this),!laya.d3.core.material.PBRMaterial.pbrlutTex){var t=c.window.__pbrlutdata;if(!t)throw alert("no pbr lutdata, need pbrlut.js"),"no pbr lutdata, need pbrlut.js";var i=en.create(new Uint32Array(t).buffer,256,256,9728,9728,!1);laya.d3.core.material.PBRMaterial.pbrlutTex=i}this._setTexture(4,laya.d3.core.material.PBRMaterial.pbrlutTex),this.setShaderName("PBR"),this._setNumber(0,.5),this.use_groundtruth=!1}r(e,"laya.d3.core.material.PBRMaterial",t);var s=e.prototype;return s.disableLight=function(){this._addDisablePublicShaderDefine(ui.SHADERDEFINE_POINTLIGHT|ui.SHADERDEFINE_SPOTLIGHT|ui.SHADERDEFINE_DIRECTIONLIGHT)},s.disableFog=function(){this._addDisablePublicShaderDefine(ui.SHADERDEFINE_FOG)},s.onAsynLoaded=function(e,i,n){t.prototype.onAsynLoaded.call(this,e,i,n)},s.radicalInverse_VdC=function(t){var e=new Uint32Array(1);return function(t){return t=t<<16|t>>>16,t=(1431655765&t)<<1|(2863311530&t)>>>1,t=(858993459&t)<<2|(3435973836&t)>>>2,t=(252645135&t)<<4|(4042322160&t)>>>4,t=(16711935&t)<<8|(4278255360&t)>>>8,e[0]=t,2.3283064365386963e-10*e[0]}(t)},s.createHammersleyTex=function(t,e){var i=new Uint8Array(t*e*4),n=0,r=0;for(r=0;r<t*e;r++){var a=this.radicalInverse_VdC(r);i[n++]=255*a,i[n++]=0,i[n++]=0,i[n++]=255}return i},a(0,s,"normalTexture",function(){return this._getTexture(2)},function(t){this._setTexture(2,t)}),a(0,s,"has_tangent",null,function(t){this._addShaderDefine(e.SHADERDEFINE_HAS_TANGENT)}),a(0,s,"roughness",function(){return this._getNumber(6)},function(t){this._setNumber(6,t),this._addShaderDefine(e.SHADERDEFINE_FIX_ROUGHNESS)}),a(0,s,"metaless",function(){return this._getNumber(7)},function(t){this._setNumber(7,t),this._addShaderDefine(e.SHADERDEFINE_FIX_METALESS)}),a(0,s,"pbrlutTexture",function(){return this._getTexture(4)},function(t){this._setTexture(4,t)}),a(0,s,"use_groundtruth",null,function(t){if(t){if(this._addShaderDefine(e.SHADERDEFINE_USE_GROUNDTRUTH),!laya.d3.core.material.PBRMaterial.HammersleyNoiseTex){var i=this.createHammersleyTex(32,32);laya.d3.core.material.PBRMaterial.HammersleyNoiseTex=en.create(i.buffer,32,32,9728,9728,!1)}this._setTexture(15,e.HammersleyNoiseTex)}else laya.d3.core.material.PBRMaterial.HammersleyNoiseTex=null,this._removeShaderDefine(e.SHADERDEFINE_USE_GROUNDTRUTH)}),a(0,s,"transformUV",function(){return this._transformUV},function(t){this._transformUV=t,this._setMatrix4x4(8,t.matrix),this._conchMaterial&&this._conchMaterial.setShaderValue(8,t.matrix.elements,0)}),a(0,s,"diffuseTexture",function(){return this._getTexture(1)},function(t){this._setTexture(1,t)}),a(0,s,"renderMode",null,function(t){switch(t){case 1:this.renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0,this.alphaTest=!1;break;case 2:this.renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!1;break;case 3:this.depthWrite=!0,this.cull=2,this.blend=0,this.renderQueue=1;break;case 13:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;default:throw new Error("PBRMaterial:renderMode value error.")}}),a(0,s,"pbrInfoTexture",function(){return this._getTexture(3)},function(t){this._setTexture(3,t),this._addShaderDefine(e.SHADERDEFINE_HAS_PBRINFO)}),a(0,s,"testClipZ",null,function(t){this._addShaderDefine(e.SHADERDEFINE_TEST_CLIPZ)}),e.__init__=function(){e.SHADERDEFINE_FIX_METALESS=e.shaderDefines.registerDefine("FIX_METALESS"),e.SHADERDEFINE_FIX_ROUGHNESS=e.shaderDefines.registerDefine("FIX_ROUGHNESS"),e.SHADERDEFINE_HAS_TANGENT=e.shaderDefines.registerDefine("HAS_TANGENT"),e.SHADERDEFINE_HAS_PBRINFO=e.shaderDefines.registerDefine("HAS_PBRINFO"),e.SHADERDEFINE_USE_GROUNDTRUTH=e.shaderDefines.registerDefine("USE_GROUNDTRUTH"),e.SHADERDEFINE_TEST_CLIPZ=e.shaderDefines.registerDefine("CLIPZ")},e.load=function(t){return i.loader.create(t,null,null,e)},e.DIFFUSETEXTURE=1,e.NORMALTEXTURE=2,e.PBRINFOTEXTURE=3,e.PBRLUTTEXTURE=4,e.UVANIAGE=5,e.MATERIALROUGHNESS=6,e.MATERIALMETALESS=7,e.UVMATRIX=8,e.UVAGE=9,e.AOOBJPOS=14,e.HSNOISETEXTURE=15,e.SHADERDEFINE_FIX_ROUGHNESS=0,e.SHADERDEFINE_FIX_METALESS=0,e.SHADERDEFINE_HAS_TANGENT=0,e.SHADERDEFINE_TEST_CLIPZ=0,e.SHADERDEFINE_HAS_PBRINFO=0,e.SHADERDEFINE_USE_GROUNDTRUTH=0,e.RENDERMODE_OPAQUE=1,e.RENDERMODE_OPAQUEDOUBLEFACE=2,e.RENDERMODE_CUTOUT=3,e.RENDERMODE_CUTOUTDOUBLEFACE=4,e.RENDERMODE_TRANSPARENT=13,e.pbrlutTex=null,e.HammersleyNoiseTex=null,n(e,["defaultMaterial",function(){return this.defaultMaterial=new e},"shaderDefines",function(){return this.shaderDefines=new Be(pi.shaderDefines)}]),e}(pi),zi=function(t){function e(){e.__super.call(this),this.setShaderName("PBRSpecular"),this._setColor(7,new Le(1,1,1,1)),this._setColor(9,new Le(0,0,0,0)),this._setColor(8,new Le(.2,.2,.2,.2)),this._setNumber(10,.5),this._setNumber(11,1),this._setNumber(12,0),this._setNumber(13,1),this._setNumber(14,1),this._setNumber(15,.001),this._setBool(16,!1),this._setNumber(0,.5)}r(e,"laya.d3.core.material.PBRSpecularMaterial",t);var i=e.prototype;return a(0,i,"albedoColor",function(){return this._getColor(7)},function(t){this._setColor(7,t)}),a(0,i,"specularTexture",function(){return this._getTexture(2)},function(t){t?this._addShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_SPECULARTEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_SPECULARTEXTURE),this._setTexture(2,t)}),a(0,i,"albedoTexture",function(){return this._getTexture(1)},function(t){t?this._addShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_DIFFUSETEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_DIFFUSETEXTURE),this._setTexture(1,t)}),a(0,i,"occlusionTexture",function(){return this._getTexture(5)},function(t){t?this._addShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_OCCLUSIONTEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_OCCLUSIONTEXTURE),this._setTexture(5,t)}),a(0,i,"normalTexture",function(){return this._getTexture(3)},function(t){t?this._addShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_NORMALTEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_NORMALTEXTURE),this._setTexture(3,t)}),a(0,i,"parallaxTexture",function(){return this._getTexture(4)},function(t){t?this._addShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_PARALLAXTEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_PARALLAXTEXTURE),this._setTexture(4,t)}),a(0,i,"emissionColor",function(){return this._getColor(9)},function(t){this._setColor(9,t)}),a(0,i,"normalTextureScale",function(){return this._getNumber(14)},function(t){this._setNumber(14,t)}),a(0,i,"parallaxTextureScale",function(){return this._getNumber(15)},function(t){t=Math.max(.005,Math.min(.08,t)),this._setNumber(15,t)}),a(0,i,"occlusionTextureStrength",function(){return this._getNumber(13)},function(t){t=Math.max(0,Math.min(1,t)),this._setNumber(13,t)}),a(0,i,"specularColor",function(){return this._getColor(8)},function(t){this._setColor(8,t)}),a(0,i,"smoothness",function(){return this._getNumber(10)},function(t){t=Math.max(0,Math.min(1,t)),this._setNumber(10,t)}),a(0,i,"smoothnessTextureScale",function(){return this._getNumber(11)},function(t){t=Math.max(0,Math.min(1,t)),this._setNumber(11,t)}),a(0,i,"smoothnessSource",function(){return this._getNumber(12)},function(t){1==t?this._addShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA):(this._removeShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA),t=0),this._setNumber(12,t)}),a(0,i,"enableEmission",function(){return this._getBool(16)},function(t){t?this._addShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_EMISSION):this._removeShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_EMISSION),this._setBool(16,t)}),a(0,i,"emissionTexture",function(){return this._getTexture(6)},function(t){t?this._addShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_EMISSIONTEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_EMISSIONTEXTURE),this._setTexture(6,t)}),a(0,i,"tilingOffset",function(){return this._getColor(17)},function(t){if(t){var e=t.elements;1!=e[0]||1!=e[1]||0!=e[2]||0!=e[3]?this._addShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_TILINGOFFSET):this._removeShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_TILINGOFFSET)}else this._removeShaderDefine(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_TILINGOFFSET);this._setColor(17,t)}),e.__init__=function(){e.SHADERDEFINE_DIFFUSETEXTURE=e.shaderDefines.registerDefine("DIFFUSETEXTURE"),e.SHADERDEFINE_SPECULARTEXTURE=e.shaderDefines.registerDefine("SPECULARTEXTURE"),e.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA=e.shaderDefines.registerDefine("SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA"),e.SHADERDEFINE_NORMALTEXTURE=e.shaderDefines.registerDefine("NORMALTEXTURE"),e.SHADERDEFINE_PARALLAXTEXTURE=e.shaderDefines.registerDefine("PARALLAXTEXTURE"),e.SHADERDEFINE_OCCLUSIONTEXTURE=e.shaderDefines.registerDefine("OCCLUSIONTEXTURE"),e.SHADERDEFINE_EMISSION=e.shaderDefines.registerDefine("EMISSION"),e.SHADERDEFINE_EMISSIONTEXTURE=e.shaderDefines.registerDefine("EMISSIONTEXTURE"),e.SHADERDEFINE_TILINGOFFSET=e.shaderDefines.registerDefine("TILINGOFFSET")},e.SmoothnessSource_MetallicGlossTexture_Alpha=0,e.SmoothnessSource_DiffuseTexture_Alpha=1,e.SHADERDEFINE_DIFFUSETEXTURE=0,e.SHADERDEFINE_NORMALTEXTURE=0,e.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA=0,e.SHADERDEFINE_SPECULARTEXTURE=0,e.SHADERDEFINE_OCCLUSIONTEXTURE=0,e.SHADERDEFINE_PARALLAXTEXTURE=0,e.SHADERDEFINE_EMISSION=0,e.SHADERDEFINE_EMISSIONTEXTURE=0,e.SHADERDEFINE_TILINGOFFSET=0,e.DIFFUSETEXTURE=1,e.SPECULARTEXTURE=2,e.NORMALTEXTURE=3,e.PARALLAXTEXTURE=4,e.OCCLUSIONTEXTURE=5,e.EMISSIONTEXTURE=6,e.DIFFUSECOLOR=7,e.SPECULARCOLOR=8,e.EMISSIONCOLOR=9,e.SMOOTHNESS=10,e.SMOOTHNESSSCALE=11,e.SMOOTHNESSSOURCE=12,e.OCCLUSIONSTRENGTH=13,e.NORMALSCALE=14,e.PARALLAXSCALE=15,e.ENABLEEMISSION=16,e.TILINGOFFSET=17,n(e,["shaderDefines",function(){return this.shaderDefines=new Be(pi.shaderDefines)}]),e}(pi),ki=function(t){function e(){e.__super.call(this),this.setShaderName("PBRStandard"),this._setColor(7,new Le(1,1,1,1)),this._setColor(8,new Le(0,0,0,0)),this._setNumber(9,0),this._setNumber(10,.5),this._setNumber(11,1),this._setNumber(12,0),this._setNumber(13,1),this._setNumber(14,1),this._setNumber(15,.001),this._setBool(16,!1),this._setNumber(0,.5)}r(e,"laya.d3.core.material.PBRStandardMaterial",t);var i=e.prototype;return a(0,i,"albedoColor",function(){return this._getColor(7)},function(t){this._setColor(7,t)}),a(0,i,"albedoTexture",function(){return this._getTexture(1)},function(t){t?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_DIFFUSETEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_DIFFUSETEXTURE),this._setTexture(1,t)}),a(0,i,"enableEmission",function(){return this._getBool(16)},function(t){t?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_EMISSION):this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_EMISSION),this._setBool(16,t)}),a(0,i,"metallicGlossTexture",function(){return this._getTexture(2)},function(t){t?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_METALLICGLOSSTEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_METALLICGLOSSTEXTURE),this._setTexture(2,t)}),a(0,i,"occlusionTexture",function(){return this._getTexture(5)},function(t){t?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_OCCLUSIONTEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_OCCLUSIONTEXTURE),this._setTexture(5,t)}),a(0,i,"normalTexture",function(){return this._getTexture(3)},function(t){t?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_NORMALTEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_NORMALTEXTURE),this._setTexture(3,t)}),a(0,i,"parallaxTexture",function(){return this._getTexture(4)},function(t){t?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_PARALLAXTEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_PARALLAXTEXTURE),this._setTexture(4,t)}),a(0,i,"emissionColor",function(){return this._getColor(8)},function(t){this._setColor(8,t)}),a(0,i,"normalTextureScale",function(){return this._getNumber(14)},function(t){this._setNumber(14,t)}),a(0,i,"parallaxTextureScale",function(){return this._getNumber(15)},function(t){t=Math.max(.005,Math.min(.08,t)),this._setNumber(15,t)}),a(0,i,"occlusionTextureStrength",function(){return this._getNumber(13)},function(t){t=Math.max(0,Math.min(1,t)),this._setNumber(13,t)}),a(0,i,"metallic",function(){return this._getNumber(9)},function(t){t=Math.max(0,Math.min(1,t)),this._setNumber(9,t)}),a(0,i,"smoothness",function(){return this._getNumber(10)},function(t){t=Math.max(0,Math.min(1,t)),this._setNumber(10,t)}),a(0,i,"smoothnessTextureScale",function(){return this._getNumber(11)},function(t){t=Math.max(0,Math.min(1,t)),this._setNumber(11,t)}),a(0,i,"smoothnessSource",function(){return this._getNumber(12)},function(t){1==t?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA):(this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA),t=0),this._setNumber(12,t)}),a(0,i,"emissionTexture",function(){return this._getTexture(6)},function(t){t?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_EMISSIONTEXTURE):this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_EMISSIONTEXTURE),this._setTexture(6,t)}),a(0,i,"tilingOffset",function(){return this._getColor(17)},function(t){if(t){var e=t.elements;1!=e[0]||1!=e[1]||0!=e[2]||0!=e[3]?this._addShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_TILINGOFFSET):this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_TILINGOFFSET)}else this._removeShaderDefine(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_TILINGOFFSET);this._setColor(17,t)}),e.__init__=function(){e.SHADERDEFINE_DIFFUSETEXTURE=e.shaderDefines.registerDefine("DIFFUSETEXTURE"),e.SHADERDEFINE_METALLICGLOSSTEXTURE=e.shaderDefines.registerDefine("METALLICGLOSSTEXTURE"),e.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA=e.shaderDefines.registerDefine("SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA"),e.SHADERDEFINE_NORMALTEXTURE=e.shaderDefines.registerDefine("NORMALTEXTURE"),e.SHADERDEFINE_PARALLAXTEXTURE=e.shaderDefines.registerDefine("PARALLAXTEXTURE"),e.SHADERDEFINE_OCCLUSIONTEXTURE=e.shaderDefines.registerDefine("OCCLUSIONTEXTURE"),e.SHADERDEFINE_EMISSION=e.shaderDefines.registerDefine("EMISSION"),e.SHADERDEFINE_EMISSIONTEXTURE=e.shaderDefines.registerDefine("EMISSIONTEXTURE"),e.SHADERDEFINE_TILINGOFFSET=e.shaderDefines.registerDefine("TILINGOFFSET")},e.SmoothnessSource_MetallicGlossTexture_Alpha=0,e.SmoothnessSource_DiffuseTexture_Alpha=1,e.SHADERDEFINE_DIFFUSETEXTURE=0,e.SHADERDEFINE_NORMALTEXTURE=0,e.SHADERDEFINE_SMOOTHNESSSOURCE_DIFFUSETEXTURE_ALPHA=0,e.SHADERDEFINE_METALLICGLOSSTEXTURE=0,e.SHADERDEFINE_OCCLUSIONTEXTURE=0,e.SHADERDEFINE_PARALLAXTEXTURE=0,e.SHADERDEFINE_EMISSION=0,e.SHADERDEFINE_EMISSIONTEXTURE=0,e.SHADERDEFINE_TILINGOFFSET=0,e.DIFFUSETEXTURE=1,e.METALLICGLOSSTEXTURE=2,e.NORMALTEXTURE=3,e.PARALLAXTEXTURE=4,e.OCCLUSIONTEXTURE=5,e.EMISSIONTEXTURE=6,e.DIFFUSECOLOR=7,e.EMISSIONCOLOR=8,e.METALLIC=9,e.SMOOTHNESS=10,e.SMOOTHNESSSCALE=11,e.SMOOTHNESSSOURCE=12,e.OCCLUSIONSTRENGTH=13,e.NORMALSCALE=14,e.PARALLAXSCALE=15,e.ENABLEEMISSION=16,e.TILINGOFFSET=17,n(e,["shaderDefines",function(){return this.shaderDefines=new Be(pi.shaderDefines)}]),e}(pi),Wi=function(t){function e(){this._transformUV=null,e.__super.call(this),this.setShaderName("SIMPLE"),this._setColor(9,new Pe(.6,.6,.6)),this._setColor(10,new Pe(1,1,1)),this._setColor(11,new Le(1,1,1,8)),this._setColor(12,new Pe(1,1,1)),this._setColor(7,new Le(1,1,1,1)),this._setNumber(0,.5),this._setColor(15,new Le(1,1,0,0)),this.renderMode=1}r(e,"laya.d3.core.material.StandardMaterial",t);var s=e.prototype;return s.disableLight=function(){this._addDisablePublicShaderDefine(ui.SHADERDEFINE_POINTLIGHT|ui.SHADERDEFINE_SPOTLIGHT|ui.SHADERDEFINE_DIRECTIONLIGHT)},s.disableFog=function(){this._addDisablePublicShaderDefine(ui.SHADERDEFINE_FOG)},s.onAsynLoaded=function(i,n,r){var a=n[0];if(a.version)t.prototype.onAsynLoaded.call(this,i,n,r);else{var s=n[1],o=a.props;for(var l in o)this[l]=o[l];e._parseStandardMaterial(s,this,a),this._endLoaded()}},s.cloneTo=function(e){t.prototype.cloneTo.call(this,e);var i=e;this._transformUV&&(i._transformUV=this._transformUV.clone())},a(0,s,"ambientColor",function(){return this._getColor(9)},function(t){this._setColor(9,t)}),a(0,s,"ambientTexture",function(){return this._getTexture(5)},function(t){t?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_AMBIENTMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_AMBIENTMAP),this._setTexture(5,t)}),a(0,s,"renderMode",null,function(t){switch(t){case 1:this.renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 2:this.renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 3:this.depthWrite=!0,this.cull=2,this.blend=0,this.renderQueue=1,this.alphaTest=!0,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 4:this.renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!0,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 13:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 14:this.renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 15:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 16:this.renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 5:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 6:this.renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 7:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 8:this.renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 9:this.renderQueue=2,this.depthTest=513,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 10:this.renderQueue=2,this.depthTest=513,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 11:this.renderQueue=2,this.depthTest=513,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 12:this.renderQueue=2,this.depthTest=513,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("Material:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(t)}),a(0,s,"reflectColor",function(){return this._getColor(12)},function(t){this._setColor(12,t)}),a(0,s,"tilingOffset",function(){return this._getColor(15)},function(t){if(t){var e=t.elements;1!=e[0]||1!=e[1]||0!=e[2]||0!=e[3]?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_TILINGOFFSET):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_TILINGOFFSET)}else this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_TILINGOFFSET);this._setColor(15,t)}),a(0,s,"albedo",function(){return this._getColor(7)},function(t){this._setColor(7,t)}),a(0,s,"diffuseColor",function(){return this._getColor(10)},function(t){this._setColor(10,t)}),a(0,s,"albedoColor",function(){return this._getColor(7)},function(t){this._setColor(7,t)}),a(0,s,"specularColor",function(){return this._getColor(11)},function(t){this._setColor(11,t)}),a(0,s,"diffuseTexture",function(){return this._getTexture(1)},function(t){t?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_DIFFUSEMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_DIFFUSEMAP),this._setTexture(1,t)}),a(0,s,"normalTexture",function(){return this._getTexture(2)},function(t){t?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_NORMALMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_NORMALMAP),this._setTexture(2,t)}),a(0,s,"specularTexture",function(){return this._getTexture(3)},function(t){t?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_SPECULARMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_SPECULARMAP),this._setTexture(3,t)}),a(0,s,"emissiveTexture",function(){return this._getTexture(4)},function(t){t?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_EMISSIVEMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_EMISSIVEMAP),this._setTexture(4,t)}),a(0,s,"reflectTexture",function(){return this._getTexture(6)},function(t){t?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_REFLECTMAP):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_REFLECTMAP),this._setTexture(6,t)}),a(0,s,"transformUV",function(){return this._transformUV},function(t){this._transformUV=t,this._setMatrix4x4(13,t.matrix),t?this._addShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_UVTRANSFORM):this._removeShaderDefine(laya.d3.core.material.StandardMaterial.SHADERDEFINE_UVTRANSFORM),this._conchMaterial&&this._conchMaterial.setShaderValue(13,t.matrix.elements,0)}),e.__init__=function(){e.SHADERDEFINE_DIFFUSEMAP=e.shaderDefines.registerDefine("DIFFUSEMAP"),e.SHADERDEFINE_NORMALMAP=e.shaderDefines.registerDefine("NORMALMAP"),e.SHADERDEFINE_SPECULARMAP=e.shaderDefines.registerDefine("SPECULARMAP"),e.SHADERDEFINE_EMISSIVEMAP=e.shaderDefines.registerDefine("EMISSIVEMAP"),e.SHADERDEFINE_AMBIENTMAP=e.shaderDefines.registerDefine("AMBIENTMAP"),e.SHADERDEFINE_REFLECTMAP=e.shaderDefines.registerDefine("REFLECTMAP"),e.SHADERDEFINE_UVTRANSFORM=e.shaderDefines.registerDefine("UVTRANSFORM"),e.SHADERDEFINE_TILINGOFFSET=e.shaderDefines.registerDefine("TILINGOFFSET"),e.SHADERDEFINE_ADDTIVEFOG=e.shaderDefines.registerDefine("ADDTIVEFOG")},e.load=function(t){return i.loader.create(t,null,null,e)},e._parseStandardMaterial=function(t,e,i){var n=i.customProps,r=n.ambientColor;e.ambientColor=new Pe(r[0],r[1],r[2]);var a=n.diffuseColor;e.diffuseColor=new Pe(a[0],a[1],a[2]);var s=n.specularColor;e.specularColor=new Le(s[0],s[1],s[2],s[3]);var o=n.reflectColor;e.reflectColor=new Pe(o[0],o[1],o[2]);var l=n.albedoColor;l&&(e.albedo=new Le(l[0],l[1],l[2],l[3]));var h=n.diffuseTexture.texture2D;h&&(e.diffuseTexture=E.getRes(t[h]));var u=n.normalTexture.texture2D;u&&(e.normalTexture=E.getRes(t[u]));var _=n.specularTexture.texture2D;_&&(e.specularTexture=E.getRes(t[_]));var c=n.emissiveTexture.texture2D;c&&(e.emissiveTexture=E.getRes(t[c]));var d=n.ambientTexture.texture2D;d&&(e.ambientTexture=E.getRes(t[d]));var f=n.reflectTexture.texture2D;f&&(e.reflectTexture=E.getRes(t[f]))},e.RENDERMODE_OPAQUE=1,e.RENDERMODE_OPAQUEDOUBLEFACE=2,e.RENDERMODE_CUTOUT=3,e.RENDERMODE_CUTOUTDOUBLEFACE=4,e.RENDERMODE_TRANSPARENT=13,e.RENDERMODE_TRANSPARENTDOUBLEFACE=14,e.RENDERMODE_ADDTIVE=15,e.RENDERMODE_ADDTIVEDOUBLEFACE=16,e.RENDERMODE_DEPTHREAD_TRANSPARENT=5,e.RENDERMODE_DEPTHREAD_TRANSPARENTDOUBLEFACE=6,e.RENDERMODE_DEPTHREAD_ADDTIVE=7,e.RENDERMODE_DEPTHREAD_ADDTIVEDOUBLEFACE=8,e.RENDERMODE_NONDEPTH_TRANSPARENT=9,e.RENDERMODE_NONDEPTH_TRANSPARENTDOUBLEFACE=10,e.RENDERMODE_NONDEPTH_ADDTIVE=11,e.RENDERMODE_NONDEPTH_ADDTIVEDOUBLEFACE=12,e.SHADERDEFINE_DIFFUSEMAP=0,e.SHADERDEFINE_NORMALMAP=0,e.SHADERDEFINE_SPECULARMAP=0,e.SHADERDEFINE_EMISSIVEMAP=0,e.SHADERDEFINE_AMBIENTMAP=0,e.SHADERDEFINE_REFLECTMAP=0,e.SHADERDEFINE_UVTRANSFORM=0,e.SHADERDEFINE_TILINGOFFSET=0,e.SHADERDEFINE_ADDTIVEFOG=0,e.DIFFUSETEXTURE=1,e.NORMALTEXTURE=2,e.SPECULARTEXTURE=3,e.EMISSIVETEXTURE=4,e.AMBIENTTEXTURE=5,e.REFLECTTEXTURE=6,e.ALBEDO=7,e.UVANIAGE=8,e.MATERIALAMBIENT=9,e.MATERIALDIFFUSE=10,e.MATERIALSPECULAR=11,e.MATERIALREFLECT=12,e.UVMATRIX=13,e.UVAGE=14,e.TILINGOFFSET=15,n(e,["defaultMaterial",function(){return this.defaultMaterial=new e},"shaderDefines",function(){return this.shaderDefines=new Be(pi.shaderDefines)}]),e}(pi),Xi=function(t){function e(){this._diffuseScale1=null,this._diffuseScale2=null,this._diffuseScale3=null,this._diffuseScale4=null,e.__super.call(this),this.setShaderName("Terrain"),this.renderMode=1,this._diffuseScale1=new Ne,this._diffuseScale2=new Ne,this._diffuseScale3=new Ne,this._diffuseScale4=new Ne,this.ambientColor=new Pe(.6,.6,.6),this.diffuseColor=new Pe(1,1,1),this.specularColor=new Le(.2,.2,.2,32)}r(e,"laya.d3.core.material.TerrainMaterial",t);var s=e.prototype;return s.setDiffuseScale1=function(t,e){this._diffuseScale1.x=t,this._diffuseScale1.y=e,this._setColor(6,this._diffuseScale1)},s.setDiffuseScale2=function(t,e){this._diffuseScale2.x=t,this._diffuseScale2.y=e,this._setColor(7,this._diffuseScale2)},s.setDiffuseScale3=function(t,e){this._diffuseScale3.x=t,this._diffuseScale3.y=e,this._setColor(8,this._diffuseScale3)},s.setDiffuseScale4=function(t,e){this._diffuseScale4.x=t,this._diffuseScale4.y=e,this._setColor(9,this._diffuseScale4)},s.setDetailNum=function(t){switch(t){case 1:this._addShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM4);break;case 2:this._addShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM4);break;case 3:this._addShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM4);break;case 4:this._addShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._removeShaderDefine(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM3)}},s.disableLight=function(){this._addDisablePublicShaderDefine(ui.SHADERDEFINE_POINTLIGHT|ui.SHADERDEFINE_SPOTLIGHT|ui.SHADERDEFINE_DIRECTIONLIGHT)},s.setShaderName=function(e){t.prototype.setShaderName.call(this,e)},a(0,s,"renderMode",null,function(t){switch(t){case 1:this.renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0,this.depthTest=513;break;case 2:this.renderQueue=1,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.depthTest=515;break;default:throw new Error("TerrainMaterial:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(t)}),a(0,s,"diffuseTexture2",function(){return this._getTexture(3)},function(t){this._setTexture(3,t)}),a(0,s,"ambientColor",function(){return this._getColor(10)},function(t){this._setColor(10,t)}),a(0,s,"diffuseTexture4",function(){return this._getTexture(5)},function(t){this._setTexture(5,t)}),a(0,s,"diffuseColor",function(){return this._getColor(11)},function(t){this._setColor(11,t)}),a(0,s,"diffuseTexture1",function(){return this._getTexture(2)},function(t){this._setTexture(2,t)}),a(0,s,"specularColor",function(){return this._getColor(12)},function(t){this._setColor(12,t)}),a(0,s,"diffuseTexture3",function(){return this._getTexture(4)},function(t){this._setTexture(4,t)}),a(0,s,"splatAlphaTexture",function(){return this._getTexture(0)},function(t){this._setTexture(0,t)}),a(0,s,"normalTexture",function(){return this._getTexture(1)},function(t){this._setTexture(1,t)}),e.__init__=function(){e.SHADERDEFINE_DETAIL_NUM1=e.shaderDefines.registerDefine("DETAIL_NUM1"),e.SHADERDEFINE_DETAIL_NUM2=e.shaderDefines.registerDefine("DETAIL_NUM2"),e.SHADERDEFINE_DETAIL_NUM4=e.shaderDefines.registerDefine("DETAIL_NUM4"),e.SHADERDEFINE_DETAIL_NUM3=e.shaderDefines.registerDefine("DETAIL_NUM3")},e.load=function(t){return i.loader.create(t,null,null,e)},e.RENDERMODE_OPAQUE=1,e.RENDERMODE_TRANSPARENT=2,e.SPLATALPHATEXTURE=0,e.NORMALTEXTURE=1,e.DIFFUSETEXTURE1=2,e.DIFFUSETEXTURE2=3,e.DIFFUSETEXTURE3=4,e.DIFFUSETEXTURE4=5,e.DIFFUSESCALE1=6,e.DIFFUSESCALE2=7,e.DIFFUSESCALE3=8,e.DIFFUSESCALE4=9,e.MATERIALAMBIENT=10,e.MATERIALDIFFUSE=11,e.MATERIALSPECULAR=12,e.SHADERDEFINE_DETAIL_NUM1=0,e.SHADERDEFINE_DETAIL_NUM2=0,e.SHADERDEFINE_DETAIL_NUM3=0,e.SHADERDEFINE_DETAIL_NUM4=0,n(e,["defaultMaterial",function(){return this.defaultMaterial=new e},"shaderDefines",function(){return this.shaderDefines=new Be(pi.shaderDefines)}]),e}(pi),Yi=function(t){function e(){this._useVertexDeep=!1,e.__super.call(this),this.setShaderName("Water")}r(e,"laya.d3.core.material.WaterMaterial",t);var s=e.prototype;return s.disableFog=function(){this._addDisablePublicShaderDefine(ui.SHADERDEFINE_FOG)},s.onAsynLoaded=function(e,i,n){t.prototype.onAsynLoaded.call(this,e,i,n)},a(0,s,"diffuseTexture",function(){return this._getTexture(1)},function(t){this._setTexture(1,t)}),a(0,s,"normalTexture",function(){return this._getTexture(2)},function(t){this._setTexture(2,t)}),a(0,s,"underWaterTexture",function(){return this._getTexture(3)},function(t){this._setTexture(3,t)}),a(0,s,"deepColorTexture",function(){return this._getTexture(10)},function(t){this._setTexture(10,t)}),a(0,s,"useFoam",null,function(t){t?this._addShaderDefine(e.SHADERDEFINE_USE_FOAM):this._removeShaderDefine(e.SHADERDEFINE_USE_FOAM)}),a(0,s,"skyTexture",function(){return this._getTexture(11)},function(t){this._setTexture(11,t)}),a(0,s,"deepScale",function(){return this._getNumber(20)},function(t){this._setNumber(20,t)}),a(0,s,"detailTexture",function(){return this._getTexture(9)},function(t){this._setTexture(9,t)}),a(0,s,"foamTexture",function(){return this._getTexture(17)},function(t){this._setTexture(17,t)}),a(0,s,"waterInfoTexture",function(){return this._getTexture(16)},function(t){this._setTexture(16,t)}),a(0,s,"vertexDispTexture",function(){return this._getTexture(4)},function(t){this._setTexture(4,t)}),a(0,s,"currentTm",function(){return this._getNumber(8)},function(t){this._setNumber(8,t)}),a(0,s,"waveInfo",function(){return this._getBuffer(12)},function(t){this._setBuffer(12,t)}),a(0,s,"waveInfoD",function(){return this._getBuffer(13)},function(t){this._setBuffer(13,t)}),a(0,s,"waveMainDir",function(){return this._getNumber(14)},function(t){this._setNumber(14,t*Math.PI/180)}),a(0,s,"geoWaveUVScale",function(){return this._getNumber(18)},function(t){this._setNumber(18,t)}),a(0,s,"windSpeed",function(){return 0},function(t){}),a(0,s,"scrsize",null,function(t){this._setBuffer(15,t)}),a(0,s,"seaColor",function(){return this._getBuffer(19)},function(t){this._setBuffer(19,t)}),a(0,s,"useVertexDeep",function(){return this._useVertexDeep},function(t){this._useVertexDeep=t,t?this._addShaderDefine(e.SHADERDEFINE_USEVERTEXHEIGHT):this._removeShaderDefine(e.SHADERDEFINE_USEVERTEXHEIGHT)}),a(0,s,"windDir",function(){return 0},function(t){}),a(0,s,"useRefractTexture",null,function(t){t?this._addShaderDefine(e.SHADERDEFINE_USE_REFRACT_TEX):this._removeShaderDefine(e.SHADERDEFINE_USE_REFRACT_TEX)}),a(0,s,"renderMode",null,function(t){switch(t){case 1:this.renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0,this.alphaTest=!1;break;case 2:this.renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!1;break;case 3:this.depthWrite=!0,this.cull=2,this.blend=0,this.renderQueue=1;break;case 13:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771;break;default:throw new Error("PBRMaterial:renderMode value error.")}}),e.__init__=function(){e.SHADERDEFINE_CUBE_ENV=e.shaderDefines.registerDefine("CUBE_ENV"),e.SHADERDEFINE_HDR_ENV=e.shaderDefines.registerDefine("HDR_ENV"),e.SHADERDEFINE_SHOW_NORMAL=e.shaderDefines.registerDefine("SHOW_NORMAL"),e.SHADERDEFINE_USEVERTEXHEIGHT=e.shaderDefines.registerDefine("USE_VERTEX_DEEPINFO"),e.SHADERDEFINE_USE_FOAM=e.shaderDefines.registerDefine("USE_FOAM"),e.SHADERDEFINE_USE_REFRACT_TEX=e.shaderDefines.registerDefine("USE_REFR_TEX")},e.load=function(t){return i.loader.create(t,null,null,e)},e.DIFFUSETEXTURE=1,e.NORMALTEXTURE=2,e.UNDERWATERTEXTURE=3,e.VERTEXDISPTEXTURE=4,e.UVANIAGE=5,e.UVMATRIX=6,e.UVAGE=7,e.CURTM=8,e.DETAILTEXTURE=9,e.DEEPCOLORTEXTURE=10,e.SKYTEXTURE=11,e.WAVEINFO=12,e.WAVEINFOD=13,e.WAVEMAINDIR=14,e.SCRSIZE=15,e.WATERINFO=16,e.FOAMTEXTURE=17,e.GEOWAVE_UV_SCALE=18,e.SEA_COLOR=19,e.WAVEINFODEEPSCALE=20,e.SHADERDEFINE_SHOW_NORMAL=0,e.SHADERDEFINE_CUBE_ENV=0,e.SHADERDEFINE_HDR_ENV=0,e.SHADERDEFINE_USE_FOAM=0,e.SHADERDEFINE_USE_REFRACT_TEX=0,e.SHADERDEFINE_USEVERTEXHEIGHT=0,e.RENDERMODE_OPAQUE=1,e.RENDERMODE_OPAQUEDOUBLEFACE=2,e.RENDERMODE_CUTOUT=3,e.RENDERMODE_CUTOUTDOUBLEFACE=4,e.RENDERMODE_TRANSPARENT=13,n(e,["defaultMaterial",function(){return this.defaultMaterial=new e},"shaderDefines",function(){return this.shaderDefines=new Be(pi.shaderDefines)}]),e}(pi),Zi=function(t){function e(t,i,n,r){this._indexType=null,this._indexTypeByteCount=0,this._indexCount=0,this._canRead=!1,void 0===n&&(n=35044),void 0===r&&(r=!1),e.__super.call(this),this._indexType=t,this._indexCount=i,this._bufferUsage=n,this._bufferType=34963,this._canRead=r;var a=0;if("ushort"==t)this._indexTypeByteCount=2;else{if("ubyte"!=t)throw new Error("unidentification index type.");this._indexTypeByteCount=1}a=this._indexTypeByteCount*i,this._byteLength=a,D.isConchNode||(this._bind(),d._gl.bufferData(this._bufferType,a,this._bufferUsage)),r?("ushort"==t?this._buffer=new Uint16Array(i):"ubyte"==t&&(this._buffer=new Uint8Array(i)),this.memorySize=2*a):this.memorySize=a}r(e,"laya.d3.graphics.IndexBuffer3D",t);var i=e.prototype;return i.setData=function(t,e,i,n){void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=4294967295);var r=0;if("ushort"==this._indexType?(r=2,0===i&&4294967295===n||(t=new Uint16Array(t.buffer,i*r,n))):"ubyte"==this._indexType&&(r=1,0===i&&4294967295===n||(t=new Uint8Array(t.buffer,i*r,n))),D.isConchNode||(this._bind(),d._gl.bufferSubData(this._bufferType,e*r,t)),this._canRead)if(0!==e||0!==i||4294967295!==n){var a=this._buffer.length-e;n>a&&(n=a);for(var s=0;s<n;s++)this._buffer[e+s]=t[s]}else this._buffer=t},i.getData=function(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!")},i.disposeResource=function(){t.prototype.disposeResource.call(this),this._buffer=null,this.memorySize=0},a(0,i,"indexType",function(){return this._indexType}),a(0,i,"indexTypeByteCount",function(){return this._indexTypeByteCount}),a(0,i,"indexCount",function(){return this._indexCount}),a(0,i,"canRead",function(){return this._canRead}),e.INDEXTYPE_UBYTE="ubyte",e.INDEXTYPE_USHORT="ushort",e.create=function(t,i,n,r){return void 0===n&&(n=35044),void 0===r&&(r=!1),new e(t,i,n,r)},e}(d),Ki=function(t){function e(t,i,n,r){this._vertexDeclaration=null,this._vertexCount=0,this._canRead=!1,void 0===r&&(r=!1),e.__super.call(this),this._vertexDeclaration=t,this._vertexCount=i,this._bufferUsage=n,this._bufferType=34962,this._canRead=r,this.memorySize=this._byteLength=this._vertexDeclaration.vertexStride*i,D.isConchNode||(this._bind(),d._gl.bufferData(this._bufferType,this._byteLength,this._bufferUsage)),r&&(this._buffer=new Float32Array(this._byteLength/4))}r(e,"laya.d3.graphics.VertexBuffer3D",t);var i=e.prototype;return i.bindWithIndexBuffer=function(t){t&&t._bind(),this._bind()},i.setData=function(t,e,i,n){if(void 0===e&&(e=0),void 0===i&&(i=0),void 0===n&&(n=4294967295),0===i&&4294967295===n||(t=new Float32Array(t.buffer,4*i,n)),D.isConchNode||(this._bind(),d._gl.bufferSubData(this._bufferType,4*e,t)),this._canRead)if(0!==e||0!==i||4294967295!==n){var r=this._buffer.length-e;n>r&&(n=r);for(var a=0;a<n;a++)this._buffer[e+a]=t[a]}else this._buffer=t},i.getData=function(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!")},i.disposeResource=function(){for(var e=P.mainContext,i=this._vertexDeclaration.getVertexElements(),n=d._enableAtributes,r=0,a=i.length;r<a;r++)n[r]===this._glBuffer&&(e.disableVertexAttribArray(r),n[r]=null);t.prototype.disposeResource.call(this),this._buffer=null,this._vertexDeclaration=null,this.memorySize=0},a(0,i,"vertexDeclaration",function(){return this._vertexDeclaration}),a(0,i,"vertexCount",function(){return this._vertexCount}),a(0,i,"canRead",function(){return this._canRead}),e.create=function(t,i,n,r){return void 0===n&&(n=35044),void 0===r&&(r=!1),new e(t,i,n,r)},e}(d),ji=function(t){function e(){e.__super.call(this),this.setShaderName("PARTICLESHURIKEN"),this.renderMode=6}r(e,"laya.d3.core.particleShuriKen.ShurikenParticleMaterial",t);var s=e.prototype;return s.onAsynLoaded=function(i,n,r){var a=n[0];if(a.version)t.prototype.onAsynLoaded.call(this,i,n,r);else{var s=n[1],o=a.props;for(var l in o)this[l]=o[l];e._parseShurikenParticleMaterial(s,this,a),this._endLoaded()}},a(0,s,"renderMode",null,function(t){switch(t){case 1:this.renderQueue=1,this.depthWrite=!0,this.cull=2,this.blend=0,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 2:this.renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 3:this.depthWrite=!0,this.cull=2,this.blend=0,this.renderQueue=1,this.alphaTest=!0,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 4:this.renderQueue=1,this.depthWrite=!0,this.cull=0,this.blend=0,this.alphaTest=!0,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 13:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 14:this.renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 15:this.renderQueue=2,this.depthWrite=!0,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 16:this.renderQueue=2,this.depthWrite=!0,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 5:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 6:this.renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 7:this.renderQueue=2,this.depthWrite=!1,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 8:this.renderQueue=2,this.depthWrite=!1,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 9:this.renderQueue=2,this.depthTest=513,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 10:this.renderQueue=2,this.depthTest=513,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=771,this.alphaTest=!1,this._removeShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 11:this.renderQueue=2,this.depthTest=513,this.cull=2,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;case 12:this.renderQueue=2,this.depthTest=513,this.cull=0,this.blend=1,this.srcBlend=770,this.dstBlend=1,this.alphaTest=!1,this._addShaderDefine(e.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("Material:renderMode value error.")}this._conchMaterial&&this._conchMaterial.setRenderMode(t)}),a(0,s,"tintColor",function(){return this._getColor(2)},function(t){t?this._addShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TINTCOLOR):this._removeShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TINTCOLOR),this._setColor(2,t)}),a(0,s,"tilingOffset",function(){return this._getColor(3)},function(t){if(t){var e=t.elements;1!=e[0]||1!=e[1]||0!=e[2]||0!=e[3]?this._addShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TILINGOFFSET):this._removeShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TILINGOFFSET)}else this._removeShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TILINGOFFSET);this._setColor(3,t)}),a(0,s,"diffuseTexture",function(){return this._getTexture(1)},function(t){t?this._addShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_DIFFUSEMAP):this._removeShaderDefine(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_DIFFUSEMAP),this._setTexture(1,t)}),e.__init__=function(){e.SHADERDEFINE_DIFFUSEMAP=e.shaderDefines.registerDefine("DIFFUSEMAP"),e.SHADERDEFINE_TINTCOLOR=e.shaderDefines.registerDefine("TINTCOLOR"),e.SHADERDEFINE_ADDTIVEFOG=e.shaderDefines.registerDefine("ADDTIVEFOG"),e.SHADERDEFINE_TILINGOFFSET=e.shaderDefines.registerDefine("TILINGOFFSET")},e.load=function(t){return i.loader.create(t,null,null,e)},e._parseShurikenParticleMaterial=function(t,e,i){var n=i.customProps,r=n.diffuseTexture.texture2D;r&&(e.diffuseTexture=E.getRes(t[r]));var a=n.tintColor;a&&(e.tintColor=new Le(a[0],a[1],a[2],a[3]))},e.RENDERMODE_OPAQUE=1,e.RENDERMODE_OPAQUEDOUBLEFACE=2,e.RENDERMODE_CUTOUT=3,e.RENDERMODE_CUTOUTDOUBLEFACE=4,e.RENDERMODE_TRANSPARENT=13,e.RENDERMODE_TRANSPARENTDOUBLEFACE=14,e.RENDERMODE_ADDTIVE=15,e.RENDERMODE_ADDTIVEDOUBLEFACE=16,e.RENDERMODE_DEPTHREAD_TRANSPARENT=5,e.RENDERMODE_DEPTHREAD_TRANSPARENTDOUBLEFACE=6,e.RENDERMODE_DEPTHREAD_ADDTIVE=7,e.RENDERMODE_DEPTHREAD_ADDTIVEDOUBLEFACE=8,e.RENDERMODE_NONDEPTH_TRANSPARENT=9,e.RENDERMODE_NONDEPTH_TRANSPARENTDOUBLEFACE=10,e.RENDERMODE_NONDEPTH_ADDTIVE=11,e.RENDERMODE_NONDEPTH_ADDTIVEDOUBLEFACE=12,e.SHADERDEFINE_DIFFUSEMAP=0,e.SHADERDEFINE_TINTCOLOR=0,e.SHADERDEFINE_TILINGOFFSET=0,e.SHADERDEFINE_ADDTIVEFOG=0,e.DIFFUSETEXTURE=1,e.TINTCOLOR=2,e.TILINGOFFSET=3,n(e,["defaultMaterial",function(){return this.defaultMaterial=new e},"shaderDefines",function(){return this.shaderDefines=new Be(pi.shaderDefines)}]),e}(pi),qi=function(t){function e(){e.__super.call(this),this.setShaderName("Trail"),this._setColor(2,new Le(1,1,1,1))}r(e,"laya.d3.core.trail.TrailMaterial",t);var s=e.prototype;return a(0,s,"tintColor",function(){return this._getColor(2)},function(t){this._setColor(2,t)}),a(0,s,"diffuseTexture",function(){return this._getTexture(1)},function(t){t?this._addShaderDefine(laya.d3.core.trail.TrailMaterial.SHADERDEFINE_DIFFUSETEXTURE):this._removeShaderDefine(laya.d3.core.trail.TrailMaterial.SHADERDEFINE_DIFFUSETEXTURE),this._setTexture(1,t)}),a(0,s,"tilingOffset",function(){return this._getColor(3)},function(t){if(t){var e=t.elements;1!=e[0]||1!=e[1]||0!=e[2]||0!=e[3]?this._addShaderDefine(laya.d3.core.trail.TrailMaterial.SHADERDEFINE_TILINGOFFSET):this._removeShaderDefine(laya.d3.core.trail.TrailMaterial.SHADERDEFINE_TILINGOFFSET)}else this._removeShaderDefine(laya.d3.core.trail.TrailMaterial.SHADERDEFINE_TILINGOFFSET);this._setColor(3,t)}),e.__init__=function(){e.SHADERDEFINE_DIFFUSETEXTURE=e.shaderDefines.registerDefine("DIFFUSETEXTURE"),e.SHADERDEFINE_TILINGOFFSET=e.shaderDefines.registerDefine("TILINGOFFSET")},e.load=function(t){return i.loader.create(t,null,null,e)},e.SHADERDEFINE_DIFFUSETEXTURE=0,e.SHADERDEFINE_TILINGOFFSET=0,e.DIFFUSETEXTURE=1,e.TINTCOLOR=2,e.TILINGOFFSET=3,n(e,["defaultMaterial",function(){return this.defaultMaterial=new e},"shaderDefines",function(){return this.shaderDefines=new Be(pi.shaderDefines)}]),e}(pi),Qi=(function(t){function e(){e.__super.call(this),this.setShaderName("CartoonShader"),this._setColor(5,new Le(.6663285,.6544118,1,1)),this._setNumber(6,0),this._setNumber(7,.7956449),this._setNumber(8,.9820514),this._setNumber(9,1)}r(e,"laya.d3.extension.cartoonRender.CartoonMaterial",t);var i=e.prototype;a(0,i,"specularTexture",function(){return this._getTexture(2)},function(t){t?this._addShaderDefine(laya.d3.extension.cartoonRender.CartoonMaterial.SHADERDEFINE_SPECULARTEXTURE):this._removeShaderDefine(laya.d3.extension.cartoonRender.CartoonMaterial.SHADERDEFINE_SPECULARTEXTURE),this._setTexture(2,t)}),a(0,i,"albedoTexture",function(){return this._getTexture(1)},function(t){t?this._addShaderDefine(laya.d3.extension.cartoonRender.CartoonMaterial.SHADERDEFINE_ALBEDOTEXTURE):this._removeShaderDefine(laya.d3.extension.cartoonRender.CartoonMaterial.SHADERDEFINE_ALBEDOTEXTURE),this._setTexture(1,t)}),a(0,i,"shadowColor",function(){return this._getColor(5)},function(t){this._setColor(5,t)}),a(0,i,"shadowIntensity",function(){return this._getNumber(7)},function(t){t=Math.max(0,Math.min(1,t)),this._setNumber(7,t)}),a(0,i,"shadowRange",function(){return this._getNumber(6)},function(t){t=Math.max(0,Math.min(1,t)),this._setNumber(6,t)}),a(0,i,"tilingOffset",function(){return this._getColor(4)},function(t){if(t){var e=t.elements;1!=e[0]||1!=e[1]||0!=e[2]||0!=e[3]?this._addShaderDefine(laya.d3.extension.cartoonRender.CartoonMaterial.SHADERDEFINE_TILINGOFFSET):this._removeShaderDefine(laya.d3.extension.cartoonRender.CartoonMaterial.SHADERDEFINE_TILINGOFFSET)}else this._removeShaderDefine(laya.d3.extension.cartoonRender.CartoonMaterial.SHADERDEFINE_TILINGOFFSET);this._setColor(4,t)}),a(0,i,"specularRange",function(){return this._getNumber(8)},function(t){t=Math.max(.9,Math.min(1,t)),this._setNumber(8,t)}),a(0,i,"specularIntensity",function(){return this._getNumber(9)},function(t){t=Math.max(0,Math.min(1,t)),this._setNumber(9,t)}),e.__init__=function(){e.SHADERDEFINE_ALBEDOTEXTURE=e.shaderDefines.registerDefine("DIFFUSETEXTURE"),e.SHADERDEFINE_SPECULARTEXTURE=e.shaderDefines.registerDefine("SPECULARTEXTURE")},e.initShader=function(){var t={a_Position:0,a_Normal:3,a_Texcoord0:2},e={u_MvpMatrix:[1,2],u_WorldMat:[0,2],u_CameraPos:[0,3],u_AlbedoTexture:[1,1],u_SpecularTexture:[2,1],u_ShadowColor:[5,1],u_ShadowRange:[6,1],u_ShadowIntensity:[7,1],u_SpecularRange:[8,1],u_SpecularIntensity:[9,1],"u_DirectionLight.Direction":[3,4],"u_DirectionLight.Color":[4,4]},i=Fi.nameKey.add("CartoonShader"),n=ui.add(i,"attribute vec4 a_Position;\nattribute vec3 a_Normal;\nattribute vec2 a_Texcoord0;\n\nuniform mat4 u_MvpMatrix;\nuniform mat4 u_WorldMat;\nuniform vec3 u_CameraPos;\n\nvarying vec2 v_Texcoord0;\nvarying vec3 v_Normal;\nvarying vec3 v_PositionWorld;\nvarying vec3 v_ViewDir;\n\nvoid main()\n{\n\tgl_Position = u_MvpMatrix * a_Position;\n\t\n\tmat3 worldMat = mat3(u_WorldMat);\n\tv_PositionWorld = (u_WorldMat * a_Position).xyz;\n\tv_Normal = worldMat * a_Normal;\n\tv_Texcoord0 = a_Texcoord0;\n\t\n\tv_ViewDir = u_CameraPos - v_PositionWorld;\n}","#ifdef FSHIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nstruct DirectionLight\n{\n\tvec3 Color;\n\tvec3 Direction;\n};\n\nvarying vec2 v_Texcoord0;\nvarying vec3 v_Normal;\nvarying vec3 v_PositionWorld;\nvarying vec3 v_ViewDir;\n\n#ifdef ALBEDOTEXTURE\n\tuniform sampler2D u_AlbedoTexture;\n#endif\n\n#ifdef SPECULARTEXTURE\n\tuniform sampler2D u_SpecularTexture;\n#endif\n\nuniform vec4 u_ShadowColor;\nuniform float u_ShadowRange;\nuniform float u_ShadowIntensity;\nuniform float u_SpecularRange;\nuniform float u_SpecularIntensity;\n\nuniform DirectionLight u_DirectionLight;\n\nvoid main()\n{\n\tvec3 normal = normalize(v_Normal);\n\tvec3 viewdir = normalize(v_ViewDir);\n\tvec3 lightDir = normalize(u_DirectionLight.Direction);\n\t\n\tvec4 albedoTextureColor = vec4(1.0);\n\t#ifdef ALBEDOTEXTURE\n\t\talbedoTextureColor = texture2D(u_AlbedoTexture, v_Texcoord0);\n\t#endif\n\t\n\tvec4 specularTextureColor = vec4(1.0); \n\t#ifdef SPECULARTEXTURE\n\t\tspecularTextureColor = texture2D(u_SpecularTexture, v_Texcoord0);\n\t#endif\n\t\n\tspecularTextureColor = specularTextureColor;\n\t\n\t//specularTextureColor = vec4(1.0, 1.0, 1.0, 1.0);\n\t\n\tfloat specTexColorG = specularTextureColor.g;\n\t\n\t//Overlay BlendMode 叠加\n\tvec3 albedoColor;\n\talbedoColor.r = albedoTextureColor.r > 0.5 ? 1.0 - 2.0 * (1.0 - albedoTextureColor.r) * (1.0 - specTexColorG) : 2.0 * albedoTextureColor.r * specTexColorG;\n\talbedoColor.g = albedoTextureColor.g > 0.5 ? 1.0 - 2.0 * (1.0 - albedoTextureColor.g) * (1.0 - specTexColorG) : 2.0 * albedoTextureColor.g * specTexColorG;\n\talbedoColor.b = albedoTextureColor.b > 0.5 ? 1.0 - 2.0 * (1.0 - albedoTextureColor.b) * (1.0 - specTexColorG) : 2.0 * albedoTextureColor.b * specTexColorG;\n\t\n\talbedoColor = clamp(albedoColor, 0.0, 1.0);\n\t\n\tfloat nl = max(dot(normal, -lightDir), 0.0);\n\t\n\tfloat shadowValue = nl + specTexColorG - 0.5;\n\tfloat shadow = step(shadowValue, u_ShadowRange);\n\tif(u_ShadowRange > (shadowValue + 0.01))\n\t\tshadow = 1.0;\n\telse if(u_ShadowRange < (shadowValue - 0.01))\n\t\tshadow = 0.0;\n\telse\n\t\tshadow = (u_ShadowRange - (shadowValue - 0.01)) / 0.02;\n\t\t\n\tshadow = clamp(shadow, 0.0, 1.0);\n\t\n\t//specularTextureColor.r 影响高光范围\n\tfloat specular = step(u_SpecularRange, clamp(pow(nl, specularTextureColor.r), 0.0, 1.0));\n\t//specularTextureColor.b 影响高光强度\n\tspecular = step(0.1, specular * specularTextureColor.b);\n\t\n\tvec3 albedoAreaColor = (1.0 - shadow) * albedoColor;\n\tvec3 shadowAreaColor = shadow * albedoColor * u_ShadowColor.rgb * u_ShadowIntensity;\n\tvec3 speculAreaColor = (1.0 - shadow) * albedoColor * u_SpecularIntensity * specular;\n\t\n\tvec3 finalColor = albedoAreaColor + speculAreaColor + shadowAreaColor;\n\t\n\tgl_FragColor = vec4(finalColor, 1.0);\n}\n",t,e);laya.d3.extension.cartoonRender.CartoonMaterial.SHADERDEFINE_ALBEDOTEXTURE=n.registerMaterialDefine("ALBEDOTEXTURE"),laya.d3.extension.cartoonRender.CartoonMaterial.SHADERDEFINE_SPECULARTEXTURE=n.registerMaterialDefine("SPECULARTEXTURE"),laya.d3.extension.cartoonRender.CartoonMaterial.SHADERDEFINE_TILINGOFFSET=n.registerMaterialDefine("TILINGOFFSET")},e.ALBEDOTEXTURE=1,e.SPECULARTEXTURE=2,e.TILINGOFFSET=4,e.SHADOWCOLOR=5,e.SHADOWRANGE=6,e.SHADOWINTENSITY=7,e.SPECULARRANGE=8,e.SPECULARINTENSITY=9,e.SHADERDEFINE_ALBEDOTEXTURE=0,e.SHADERDEFINE_SPECULARTEXTURE=0,e.SHADERDEFINE_TILINGOFFSET=0,n(e,["shaderDefines",function(){return this.shaderDefines=new Be(pi.shaderDefines)}])}(pi),function(t){function e(){e.__super.call(this),this.setShaderName("OutlineShader"),this._setNumber(2,.01581197),this._setNumber(3,1)}r(e,"laya.d3.extension.cartoonRender.OutlineMaterial",t);var i=e.prototype;a(0,i,"outlineTexture",function(){return this._getTexture(1)},function(t){t?this._addShaderDefine(laya.d3.extension.cartoonRender.OutlineMaterial.SHADERDEFINE_OUTLINETEXTURE):this._removeShaderDefine(laya.d3.extension.cartoonRender.OutlineMaterial.SHADERDEFINE_OUTLINETEXTURE),this._setTexture(1,t)}),a(0,i,"outlineWidth",function(){return this._getNumber(2)},function(t){t=Math.max(0,Math.min(.05,t)),this._setNumber(2,t)}),a(0,i,"outlineLightness",function(){return this._getNumber(3)},function(t){t=Math.max(0,Math.min(1,t)),this._setNumber(3,t)}),e.__init__=function(){e.SHADERDEFINE_OUTLINETEXTURE=e.shaderDefines.registerDefine("OUTLINETEXTURE")},e.initShader=function(){var t={a_Position:0,a_Normal:3,a_Texcoord0:2},e={u_MvpMatrix:[1,2],u_OutlineTexture:[1,1],u_OutlineWidth:[2,1],u_OutlineLightness:[3,1]},i=Fi.nameKey.add("OutlineShader"),n=ui.add(i,"attribute vec4 a_Position;\nattribute vec3 a_Normal;\nattribute vec2 a_Texcoord0;\n\nuniform mat4 u_MvpMatrix;\nuniform float u_OutlineWidth;\n\nvarying vec2 v_Texcoord0;\n\nvoid main()\n{\n\tv_Texcoord0 = a_Texcoord0;\n\t\n\tvec4 position = vec4(a_Position.xyz + a_Normal * u_OutlineWidth, 1.0);\n\tgl_Position = u_MvpMatrix * position;\n}","#ifdef FSHIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nstruct DirectionLight\n{\n\tvec3 Color;\n\tvec3 Direction;\n};\n\nvarying vec2 v_Texcoord0;\n\n#ifdef OUTLINETEXTURE\n\tuniform sampler2D u_OutlineTexture;\n#endif\nuniform float u_OutlineLightness;\n\nvoid main()\n{\n\tvec4 outlineTextureColor = vec4(1.0);\n\t#ifdef OUTLINETEXTURE\n\t\toutlineTextureColor = texture2D(u_OutlineTexture, v_Texcoord0);\n\t#endif\n\t\n\tvec3 finalColor = outlineTextureColor.rgb * u_OutlineLightness;\n\t\n\tgl_FragColor = vec4(finalColor,0.0);\n}\n",t,e);laya.d3.extension.cartoonRender.OutlineMaterial.SHADERDEFINE_OUTLINETEXTURE=n.registerMaterialDefine("OUTLINETEXTURE")},e.OUTLINETEXTURE=1,e.OUTLINEWIDTH=2,e.OUTLINELIGHTNESS=3,e.SHADERDEFINE_OUTLINETEXTURE=0,n(e,["shaderDefines",function(){return this.shaderDefines=new Be(pi.shaderDefines)}])}(pi),function(t){function e(){this._startTm=0,e.__super.call(this),laya.d3.water.WaterDetailMaterial.init(),this.setShaderName("WaterDetail"),this.cull=0,this._startTm=i.timer.currTimer}r(e,"laya.d3.water.WaterDetailMaterial",t);var n=e.prototype;a(0,n,"currentTm",function(){return this._getNumber(1)},function(t){this._setNumber(1,t-this._startTm)}),a(0,n,"waveInfo",function(){return this._getBuffer(12)},function(t){this._setBuffer(12,t)}),a(0,n,"waveInfoD",function(){return this._getBuffer(13)},function(t){this._setBuffer(13,t)}),a(0,n,"texWaveUVScale",function(){return this._getNumber(15)},function(t){this._setNumber(15,t)}),e.init=function(){if(!laya.d3.water.WaterDetailMaterial._bInited){laya.d3.water.WaterDetailMaterial._bInited=!0;var t={a_position:0,a_normal:3,uv:2},e={u_curTm:[1,1],u_WaveInfo:[12,1],u_WaveInfoD:[13,1],TEXWAVE_UV_SCALE:[15,1]},i=Fi.nameKey.add("WaterDetail");ui.add(i,"\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 uv;\n\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\nvarying vec3 vWorldTangent;\nvarying vec3 vWorldBinormal;\n\n\nvoid main() {\n\tvec3 pos = a_position;\n\tif(pos.z!=0.)pos.y=pos.z;\n\tpos.z=0.5;\n\tgl_Position = vec4(pos,1.);\n    vUv = uv;\n\t//vWorldNorm = normalize((modelMat*vec4(a_normal,0.0)).xyz);\n\t//vWorldTangent = normalize((modelMat*vec4(tangent,0.0)).xyz);\n\t//vWorldBinormal = normalize((modelMat*vec4(binormal,0.0)).xyz);\n}\n",'precision highp float;\nprecision lowp int;\n\nconst float PI = 3.14159265358979323846264;\nconst float _2PI = 6.2831853071796;\nvarying vec2 vUv;\nvarying vec3 vWorldNorm;\nvarying vec3 vWorldTangent;\nvarying vec3 vWorldBinormal;\n\nuniform float u_curTm;\n\n#include "WaveFunction.glsl"\n\nvoid main() {\n\tvec3 wave_N,wave_B,wave_T;\n\tcalcWave(u_curTm, vUv,wave_B,wave_T,wave_N);\n\tgl_FragColor.rgb = normalize(wave_N)*0.5+vec3(0.5);// vec3(0.1,.4,0.1);\n    gl_FragColor.a = 1.0;\n}\n',t,e)}},e.CURTM=1,e.WAVEINFO=12,e.WAVEINFOD=13,e.WAVEMAINDIR=14,e.TEXWAVE_UV_SCALE=15,e._bInited=!1}(pi),function(t){function e(){this._animationSprites=null,this._animationSpritesInitLocalMatrix=null,this._tempCurAnimationData=null,this._curOriginalData=null,this._lastFrameIndex=-1,this._curAnimationDatas=null,e.__super.call(this),this._animationSprites=[],this._animationSpritesInitLocalMatrix=[]}r(e,"laya.d3.component.animation.RigidAnimations",t);var n=e.prototype;n._init=function(){for(var t=this._templet.getNodes(this.currentAnimationClipIndex),e=this._owner,i=t.length,n=0,r=new Uint16Array(this._templet.getPublicExtData()),a=0;a<i;a++){var s=r.slice(n+1,n+1+r[n]);n+=r[n]+1;for(var o=1;o<s.length;o++){s[o];e=e._childs[s[o]]}var l=e.getChildByName(t[a].name);if(!l)break;this._animationSprites[a]=l;var h=this._animationSpritesInitLocalMatrix[a];h||(h=this._animationSpritesInitLocalMatrix[a]=new Ae),l.transform.localMatrix.cloneTo(h),e=this._owner}},n._animtionPlay=function(){this._templet.loaded?this._init():this._templet.once("loaded",this,this._init)},n._animtionStop=function(){if(this._lastFrameIndex=-1,this._player.returnToZeroStopped){this._curAnimationDatas=null;for(var t=0;t<this._animationSprites.length;t++)this._animationSprites[t].transform.localMatrix=this._animationSpritesInitLocalMatrix[t]}},n._effectAnimation=function(t){for(var e=0,i=this._animationSprites.length;e<i;e++){for(var n=this._animationSprites[e],r=n.transform.localMatrix,a=r.elements,s=0;s<16;s++)a[s]=this._curAnimationDatas[16*e+s];n.transform.localMatrix=r}},n._load=function(e){t.prototype._load.call(this,e),this._player.on("stopped",this,this._animtionStop),this._player.on("played",this,this._animtionPlay)},n._update=function(t){if(2===this._player.state&&this._templet&&this._templet.loaded){var e=this._player.playbackRate*i.timer.scale,n=this._player.cachePlayRate,r=this._player.isCache&&e>=n,a=r?this.currentFrameIndex:-1;if(-1===a||this._lastFrameIndex!==a){var s=this.currentAnimationClipIndex,o=this._templet.getNodes(s),l=this._templet._animationDatasCache;if(r){var h=this._templet.getAnimationDataWithCache(n,l,s,a);if(h)return this._curAnimationDatas=h,this._lastFrameIndex=a,void this._effectAnimation(o)}var u=16*o.length;r?this._curAnimationDatas=new Float32Array(u):(this._tempCurAnimationData||(this._tempCurAnimationData=new Float32Array(u)),this._curAnimationDatas=this._tempCurAnimationData),this._curOriginalData||(this._curOriginalData=new Float32Array(this._templet.getTotalkeyframesLength(s))),r?this._templet.getOriginalData(s,this._curOriginalData,this._player._fullFrames[s],a,this._player.currentFrameTime):this._templet.getOriginalDataUnfixedRate(s,this._curOriginalData,this._player.currentPlayTime),qe._computeRootAnimationData(o,this._curOriginalData,this._curAnimationDatas),r&&this._templet.setAnimationDataWithCache(n,l,s,a,this._curAnimationDatas),this._lastFrameIndex=a,this._effectAnimation(o)}}},n._unload=function(e){t.prototype._unload.call(this,e),this._animationSprites=null,this._animationSpritesInitLocalMatrix=null,this._tempCurAnimationData=null,this._curOriginalData=null,this._curAnimationDatas=null},a(0,n,"url",null,function(t){console.log("Warning: discard property,please use templet property instead.");var e=i.loader.create(t,null,null,l);this._templet!==e&&(0!==this._player.state&&this._player.stop(!0),this._templet=e,this._player.templet=e,this._curOriginalData=null,this._curAnimationDatas=null,this._tempCurAnimationData=null,this._templet._animationDatasCache||(this._templet._animationDatasCache=[]),this.event("animationchanged",this))}),a(0,n,"templet",t.prototype._$get_templet,function(t){this._templet!==t&&(0!==this._player.state&&this._player.stop(!0),this._templet=t,this._player.templet=t,this._curOriginalData=null,this._curAnimationDatas=null,this._tempCurAnimationData=null,this._templet._animationDatasCache||(this._templet._animationDatasCache=[]),this.event("animationchanged",this))})}(Ti),function(t){function e(){this._tempCurAnimationData=null,this._tempCurBonesData=null,this._curOriginalData=null,this._lastFrameIndex=-1,this._curMeshAnimationData=null,this._curBonesDatas=null,this._curAnimationDatas=null,this._ownerMesh=null,this._boneIndexToMeshList=null,this._oldVersion=!1,e.__super.call(this),this._boneIndexToMeshList=[]}r(e,"laya.d3.component.animation.SkinAnimations",t);var n=e.prototype;return n._computeBoneIndexToMeshOnTemplet=function(){this._templet.loaded?this._computeBoneIndexToMeshOnMesh():this._templet.once("loaded",this,this._computeBoneIndexToMeshOnMesh)},n._computeBoneIndexToMeshOnMesh=function(){"LAYAANIMATION:02"===this._templet._aniVersion?this._oldVersion=!1:this._oldVersion=!0;var t=this._owner.meshFilter.sharedMesh;t.loaded?this._computeBoneIndexToMesh(t):t.on("loaded",this,this._computeBoneIndexToMesh)},n._computeBoneIndexToMesh=function(t){var e=t._boneNames;if(e)for(var i=e.length,n=this._templet._anis,r=0,a=n.length;r<a;r++){var s=this._boneIndexToMeshList[r];s||(s=this._boneIndexToMeshList[r]=[]),s.length=i;for(var o=n[r],l=0;l<i;l++)s[l]=o.bone3DMap[e[l]]}},n._getAnimationDatasWithCache=function(t,e,i,n,r){var a=i[n];if(a){var s=a[t];if(s){var o=s[e.id];return o?o[r]:null}return null}return null},n._setAnimationDatasWithCache=function(t,e,i,n,r,a){var s=i[n]||(i[n]={}),o=s[t]||(s[t]={});(o[e.id]||(o[e.id]=[]))[r]=a},n._onAnimationPlayMeshLoaded=function(){for(var t=this._ownerMesh.meshRender._renderElements,e=0,i=t.length;e<i;e++)t[e]._canDynamicBatch=!1},n._onAnimationPlay=function(){this._ownerMesh._render._addShaderDefine(En.SHADERDEFINE_BONE);var t=this._ownerMesh.meshFilter.sharedMesh;t.loaded?this._onAnimationPlayMeshLoaded():t.once("loaded",this,this._onAnimationPlayMeshLoaded)},n._onAnimationStop=function(){this._lastFrameIndex=-1,this._player.returnToZeroStopped&&(this._curBonesDatas=null,this._curAnimationDatas=null,this._ownerMesh._render._removeShaderDefine(En.SHADERDEFINE_BONE));for(var t=this._ownerMesh.meshRender._renderElements,e=0,i=t.length;e<i;e++)t[e]._canDynamicBatch=!0},n._load=function(e){t.prototype._load.call(this,e),this._ownerMesh=e,this._player.on("played",this,this._onAnimationPlay),this._player.on("stopped",this,this._onAnimationStop),this._owner.meshFilter.on("meshchanged",this,this._computeBoneIndexToMeshOnTemplet)},n._update=function(t){var n=this._ownerMesh.meshFilter.sharedMesh;if(2===this._player.state&&this._templet&&this._templet.loaded&&n.loaded){var r=this._player.playbackRate*i.timer.scale,a=this._player.cachePlayRate,s=this._player.isCache&&r>=a,o=s?this.currentFrameIndex:-1;if(-1===o||this._lastFrameIndex!==o){var l=this.currentAnimationClipIndex,h=this._templet._animationDatasCache[0],u=this._templet._animationDatasCache[1];if(s){var _=this._getAnimationDatasWithCache(a,n,u,l,o);if(_)return this._curAnimationDatas=_,this._curBonesDatas=this._templet.getAnimationDataWithCache(a,h,l,o),void(this._lastFrameIndex=o)}var c=!1;s&&(this._curBonesDatas=this._templet.getAnimationDataWithCache(a,h,l,o),c=!!this._curBonesDatas);var d=this._templet.getNodes(l),f=16*d.length,m=n.InverseAbsoluteBindPoses;this._oldVersion?this._curMeshAnimationData||(this._curMeshAnimationData=new Float32Array(f)):this._curMeshAnimationData||(this._curMeshAnimationData=new Float32Array(16*m.length));var p,v,g=0,E=0,x=0,T=n.getSubMeshCount();if(s){for(this._curAnimationDatas=[],this._curAnimationDatas.length=T,g=0;g<T;g++)for(p=this._curAnimationDatas[g]=[],v=n.getSubMesh(g),x=v._boneIndicesList.length,p.length=x,E=0;E<x;E++)p[E]=new Float32Array(16*v._boneIndicesList[E].length);c||(this._curBonesDatas=new Float32Array(f))}else{if(!this._tempCurAnimationData)for(this._tempCurAnimationData=[],this._tempCurAnimationData.length=T,g=0;g<T;g++)for(p=this._tempCurAnimationData[g]=[],v=n.getSubMesh(g),x=v._boneIndicesList.length,p.length=x,E=0;E<x;E++)p[E]=new Float32Array(16*v._boneIndicesList[E].length);this._tempCurBonesData||(this._tempCurBonesData=new Float32Array(f)),this._curAnimationDatas=this._tempCurAnimationData,this._curBonesDatas=this._tempCurBonesData}if(this._curOriginalData||(this._curOriginalData=new Float32Array(this._templet.getTotalkeyframesLength(l))),s?this._templet.getOriginalData(l,this._curOriginalData,this._player._fullFrames[l],o,this._player.currentFrameTime):this._templet.getOriginalDataUnfixedRate(l,this._curOriginalData,this._player.currentPlayTime),this._oldVersion)s&&c?qe._computeAnimationDatasByArrayAndMatrixFastOld(m,this._curBonesDatas,this._curMeshAnimationData):qe._computeBoneAndAnimationDatasByBindPoseMatrxixOld(d,this._curOriginalData,m,this._curBonesDatas,this._curMeshAnimationData);else{var S=this._boneIndexToMeshList[l];s&&c?qe._computeAnimationDatasByArrayAndMatrixFast(m,this._curBonesDatas,this._curMeshAnimationData,S):qe._computeBoneAndAnimationDatasByBindPoseMatrxix(d,this._curOriginalData,m,this._curBonesDatas,this._curMeshAnimationData,S)}for(g=0;g<T;g++){var D=n.getSubMesh(g)._boneIndicesList;for(x=D.length,p=this._curAnimationDatas[g],E=0;E<x;E++)e._splitAnimationDatas(D[E],this._curMeshAnimationData,p[E])}s&&(this._setAnimationDatasWithCache(a,n,u,l,o,this._curAnimationDatas),c||this._templet.setAnimationDataWithCache(a,h,l,o,this._curBonesDatas)),this._lastFrameIndex=o}}},n._preRenderUpdate=function(t){var e=t.renderElement.renderObj;this._curAnimationDatas?e._skinAnimationDatas=this._curAnimationDatas[e._indexInMesh]:e._skinAnimationDatas=null},n._unload=function(e){2==this.player.state&&this._ownerMesh._render._removeShaderDefine(En.SHADERDEFINE_BONE),this._templet&&!this._templet.loaded&&this._templet.off("loaded",this,this._computeBoneIndexToMeshOnMesh);var i=this._ownerMesh.meshFilter.sharedMesh;i.loaded||i.off("loaded",this,this._onAnimationPlayMeshLoaded),t.prototype._unload.call(this,e),this._tempCurAnimationData=null,this._tempCurBonesData=null,this._curOriginalData=null,this._curMeshAnimationData=null,this._curBonesDatas=null,this._curAnimationDatas=null,this._ownerMesh=null},a(0,n,"curBonesDatas",function(){return this._curBonesDatas}),a(0,n,"templet",t.prototype._$get_templet,function(t){this._templet!==t&&(0!==this._player.state&&this._player.stop(!0),this._templet=t,this._player.templet=t,this._computeBoneIndexToMeshOnTemplet(),this._curOriginalData=null,this._curMeshAnimationData=null,this._tempCurBonesData=null,this._tempCurAnimationData=null,this._templet._animationDatasCache||(this._templet._animationDatasCache=[[],[]]),this.event("animationchanged",this))}),e._splitAnimationDatas=function(t,e,i){for(var n=0,r=t.length,a=0;n<r;n++)for(var s=0;s<16;s++,a++)i[a]=e[(t[n]<<4)+s]},e}(Ti)),$i=function(t){function e(){this._size=null,this._transformOrientedBoundBox=null,this.center=null,e.__super.call(this),this._needUpdate=!1}r(e,"laya.d3.component.physics.BoxCollider",t);var i=e.prototype;return i._updateCollider=function(){if(this._needUpdate){var t=this._owner.transform;t.worldMatrix.cloneTo(this._transformOrientedBoundBox.transformation),Pe.multiply(t.scale,this.center,e._deviationV3),Pe.transformQuat(e._deviationV3,t.rotation,e._deviationV3),this._transformOrientedBoundBox.getCenter(e._obbCenterV3),Pe.add(e._obbCenterV3,e._deviationV3,e._deviationV3),this._transformOrientedBoundBox.transformation.setTranslationVector(e._deviationV3),this._needUpdate=!1}},i._onWorldMatrixChanged=function(){this._needUpdate=!0;for(var t in this._runtimeCollisonMap)this._runtimeCollisonTestMap[t]=!0,this._runtimeCollisonMap[t]._runtimeCollisonTestMap[this.id]=!0},i._initialize=function(t){laya.d3.component.Component3D.prototype._initialize.call(this,t),this._transformOrientedBoundBox=new Ie(new Pe,new Ae),this._size=new Pe,this.center=new Pe,t.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChanged),this._needUpdate=!0},i._getType=function(){return 1},i._collisonTo=function(t){switch(t._getType()){case 0:return 0!==this.boundBox.containsSphere(t.boundSphere);case 1:return 0!==this.boundBox.containsOrientedBoundBox(t.boundBox);case 2:var e=t;if(0!==this.boundBox.containsBoundBox(e._boundBox)){for(var i=t.mesh._positions,n=0,r=i.length;n<r;n++)if(1===this.boundBox.containsPoint(i[n]))return!0;return!1}return!1;default:throw new Error("BoxCollider:unknown collider type.")}},i._cloneTo=function(t){var e=t,i=e.size;this.size.cloneTo(i),e.size=i,this.center.cloneTo(e.center)},i.raycast=function(t,e,i){void 0===i&&(i=1.79e308),this._updateCollider();var n=this._transformOrientedBoundBox.intersectsRay(t,e.position);return-1!==n&&n<=i?(e.distance=n,e.sprite3D=this._owner,!0):(e.distance=-1,e.sprite3D=null,!1)},i.setFromBoundBox=function(t){Ie.createByBoundBox(t,this._transformOrientedBoundBox);var e=this._transformOrientedBoundBox.extents;this._size=new Pe(2*e.x,2*e.y,2*e.z),this.center=new Pe,Pe.add(t.min,t.max,this.center),Pe.scale(this.center,.5,this.center),this._needUpdate=!0},a(0,i,"boundBox",function(){return this._updateCollider(),this._transformOrientedBoundBox}),a(0,i,"size",function(){return this._size},function(t){this._size=t,Pe.scale(t,.5,this._transformOrientedBoundBox.extents)}),n(e,["_deviationV3",function(){return this._deviationV3=new Pe},"_obbCenterV3",function(){return this._obbCenterV3=new Pe}]),e}(Di),Ji=function(t){function e(){this._transformBoundingBox=null,this._mesh=null,e.__super.call(this),this._transformBoundingBox=new xe(new Pe,new Pe),this._needUpdate=!1}r(e,"laya.d3.component.physics.MeshCollider",t);var i=e.prototype;return i._updateBoundBoxCollider=function(){if(this._needUpdate){for(var t=this._owner.transform.worldMatrix,i=this._mesh.boundingBoxCorners,n=0;n<8;n++)Pe.transformCoordinate(i[n],t,e._tempBoundBoxCorners[n]);xe.createfromPoints(e._tempBoundBoxCorners,this._transformBoundingBox),this._needUpdate=!1}},i._raycastMesh=function(t,i,n,r){void 0===r&&(r=1.79e308);var a=i.transform.worldMatrix,s=e._tempMatrix4x40;a.invert(s);var o=t.origin,l=t.direction,h=e._tempRay0;Pe.transformCoordinate(o,s,h.origin),Pe.TransformNormal(l,s,h.direction);for(var u=Number.MAX_VALUE,_=0,c=this._mesh.getRenderElementsCount();_<c;_++){var d=this._mesh.getRenderElement(_),f=d._getVertexBuffer(0),m=f.getData(),p=d._getIndexBuffer().getData(),v=e._tempRaycastHit;if(Ze.rayIntersectsPositionsAndIndices(h,m,f.vertexDeclaration,p,v)){Pe.transformCoordinate(v.position,a,v.position);var g=e._tempVector30;Pe.subtract(o,v.position,g);var E=Pe.scalarLength(g);if(E<r&&E<u){v.distance=E,v.sprite3D=i;var x=v.trianglePositions;Pe.transformCoordinate(x[0],a,x[0]),Pe.transformCoordinate(x[1],a,x[1]),Pe.transformCoordinate(x[2],a,x[2]);var T=v.triangleNormals;return Pe.transformCoordinate(T[0],a,T[0]),Pe.transformCoordinate(T[1],a,T[1]),Pe.transformCoordinate(T[2],a,T[2]),u=E,v.cloneTo(n),!0}return!1}}return!1},i._onWorldMatrixChanged=function(){this._needUpdate=!0},i._initialize=function(t){laya.d3.component.Component3D.prototype._initialize.call(this,t),t.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChanged),this._needUpdate=!0},i._getType=function(){return 2},i._collisonTo=function(t){var e=0,i=0,n=this.mesh._positions;switch(t._getType()){case 0:var r=t;if(0!==De.sphereContainsBox(r.boundSphere,this._boundBox)){for(e=0,i=n.length;e<i;e++)if(1===De.sphereContainsPoint(r.boundSphere,n[e]))return!0;return!1}return!1;case 1:var a=t;if(0!==a.boundBox.containsBoundBox(this._boundBox)){for(e=0,i=n.length;e<i;e++)if(1===a.boundBox.containsPoint(n[e]))return!0;return!1}return!1;case 2:var s=t;return 1!==De.intersectsBoxAndBox(s._boundBox,this._boundBox);default:throw new Error("MeshCollider:unknown collider type.")}},i._cloneTo=function(t){t.mesh=this._mesh},i.raycast=function(t,e,i){if(void 0===i&&(i=1.79e308),null==this._mesh||!this._mesh.loaded)return!1;var n=De.intersectsRayAndBoxRD(t,this._boundBox);return!!(-1!==n&&n<=i&&this._raycastMesh(t,this._owner,e,i))||(e.distance=-1,e.sprite3D=null,!1)},a(0,i,"_boundBox",function(){return this._updateBoundBoxCollider(),this._transformBoundingBox}),a(0,i,"mesh",function(){return this._mesh},function(t){this._mesh=t}),n(e,["_tempRay0",function(){return this._tempRay0=new we(new Pe,new Pe)},"_tempVector30",function(){return this._tempVector30=new Pe},"_tempMatrix4x40",function(){return this._tempMatrix4x40=new Ae},"_tempRaycastHit",function(){return this._tempRaycastHit=new Ke},"_tempBoundBoxCorners",function(){return this._tempBoundBoxCorners=[new Pe,new Pe,new Pe,new Pe,new Pe,new Pe,new Pe,new Pe]}]),e}(Di),tn=function(t){function e(){this._originalBoundSphere=null,this._transformBoundSphere=null,e.__super.call(this),this._needUpdate=!1}r(e,"laya.d3.component.physics.SphereCollider",t);var i=e.prototype;return i._updateCollider=function(){if(this._needUpdate){var t=NaN,e=this._owner.transform,i=e.scale;t=i.x>=i.y&&i.x>=i.z?i.x:i.y>=i.z?i.y:i.z,Pe.transformCoordinate(this._originalBoundSphere.center,e.worldMatrix,this._transformBoundSphere.center),this._transformBoundSphere.radius=this._originalBoundSphere.radius*t,this._needUpdate=!1}},i._onWorldMatrixChanged=function(){this._needUpdate=!0;for(var t in this._runtimeCollisonMap)this._runtimeCollisonTestMap[t]=!0,this._runtimeCollisonMap[t]._runtimeCollisonTestMap[this.id]=!0},i._initialize=function(t){laya.d3.component.Component3D.prototype._initialize.call(this,t),this._originalBoundSphere=new Se(new Pe(0,0,0),.5),this._transformBoundSphere=new Se(new Pe(0,0,0),.5),t.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChanged),this._needUpdate=!0},i._getType=function(){return 0},i._collisonTo=function(t){switch(t._getType()){case 0:return 0!==De.sphereContainsSphere(this.boundSphere,t.boundSphere);case 1:return 0!==t.boundBox.containsSphere(this.boundSphere);case 2:var e=t;if(0!==De.sphereContainsBox(this.boundSphere,e._boundBox)){for(var i=e.mesh._positions,n=0,r=i.length;n<r;n++)if(1===De.sphereContainsPoint(this.boundSphere,i[n]))return!0;return!1}return!1;default:throw new Error("SphereCollider:unknown collider type.")}},i._cloneTo=function(t){var e=t;e.radius=this.radius;var i=e.center;this.center.cloneTo(i),e.center=i},i.raycast=function(t,e,i){void 0===i&&(i=1.79e308),this._updateCollider();var n=this._transformBoundSphere.intersectsRayPoint(t,e.position);return-1!==n&&n<=i?(e.distance=n,e.sprite3D=this._owner,!0):(e.distance=-1,e.sprite3D=null,!1)},a(0,i,"center",function(){return this._originalBoundSphere.center},function(t){this._originalBoundSphere.center=t}),a(0,i,"radius",function(){return this._originalBoundSphere.radius},function(t){this._originalBoundSphere.radius=t}),a(0,i,"boundSphere",function(){return this._updateCollider(),this._transformBoundSphere}),e}(Di),en=function(t){function e(){this.simLodInfo=null,this._src=null,this._buffer=null,this._mipmaps=null,this._recreateLock=!1,this._needReleaseAgain=!1,e.__super.call(this),this._type=3553}r(e,"laya.d3.resource.DataTexture2D",t);var s=e.prototype;return s.genDebugMipmaps=function(){var t=[];return t.push(new Uint8Array(new Uint32Array(131072).fill(4278190335).buffer)),t.push(new Uint8Array(new Uint32Array(32768).fill(4278223103).buffer)),t.push(new Uint8Array(new Uint32Array(8192).fill(4278255615).buffer)),t.push(new Uint8Array(new Uint32Array(2048).fill(4278255360).buffer)),t.push(new Uint8Array(new Uint32Array(512).fill(4286595072).buffer)),t.push(new Uint8Array(new Uint32Array(128).fill(4294901760).buffer)),t.push(new Uint8Array(new Uint32Array(32).fill(4294901888).buffer)),t.push(new Uint8Array(new Uint32Array(8).fill(0).buffer)),t.push(new Uint8Array(new Uint32Array(2).fill(4286611584).buffer)),t.push(new Uint8Array(new Uint32Array(1).fill(4294967295).buffer)),t},s._onTextureLoaded=function(t){},s._createWebGlTexture=function(){if(!this._buffer&&!this._mipmaps)throw"create GLTextur err:no data";var t=P.mainContext;t.getExtension("EXT_shader_texture_lod");var i=this._source=t.createTexture(),n=this._width,r=this._height,a=L.curBindTexTarget,s=L.curBindTexValue;if(L.bindTexture(t,this._type,i),this._mipmaps){if(laya.d3.resource.DataTexture2D.lodasatlas){var o=0;t.texImage2D(this._type,0,6408,this._width,this._height,0,6408,5121,null);for(var l=0;l<this._mipmaps.length;l++){if(this._mipmaps[l].byteLength!=u*_*4)throw"mipmap size error  level:"+l;t.texSubImage2D(this._type,0,e.simLodRect[o++],e.simLodRect[o++],e.simLodRect[o++],e.simLodRect[o++],6408,5121,new Uint8Array(this._mipmaps[l]))}this.minFifter=9729,this.magFifter=9729}else{var u=this._width,_=this._height;for(o=0,t.texImage2D(this._type,0,6408,this._width,this._height,0,6408,5121,null),l=0;l<this._mipmaps.length;l++){if(this._mipmaps[l].byteLength!=u*_*4)throw"mipmap size error  level:"+l;t.texImage2D(this._type,l,6408,u,_,0,6408,5121,new Uint8Array(this._mipmaps[l])),u/=2,_/=2,u<1&&(u=1),_<1&&(_=1),this.minFifter=9987,this.magFifter=9729}}this.mipmap=!1}else t.texImage2D(this._type,0,6408,n,r,0,6408,5121,new Uint8Array(this._buffer));var c=this._minFifter,d=this._magFifter,f=this._repeat?10497:33071,m=h.isPOT(n,r);if(!m)throw"data texture must be POT";this._mipmap||this._mipmaps?-1!==c||(c=9987):-1!==c||(c=9729),-1!==d||(d=9729),t.texParameteri(this._type,10241,c),t.texParameteri(this._type,10240,d),t.texParameteri(this._type,10242,f),this._mipmaps?t.texParameteri(this._type,10243,33071):t.texParameteri(this._type,10243,f),this._mipmap&&t.generateMipmap(this._type),a&&s&&L.bindTexture(t,a,s),this.src&&this.src.length>0&&(this._buffer=null),this.memorySize=m?n*r*4*(1+1/3):n*r*4,this._recreateLock=!1},s.recreateResource=function(){if(this._buffer||null!=this._src&&""!==this._src)if(this._needReleaseAgain=!1,this._buffer||this._mipmaps){if(this._recreateLock)return;this._createWebGlTexture(),this.completeCreate()}else{this._recreateLock=!0}},s.onAsynLoaded=function(t,e,i){var n;i&&(n=i[0].call(this,e)),n&&(this._width=n.width,this._height=n.height,this._buffer=n.data),this._src=t,this._size=new je(this._width,this._height),this._conchTexture?alert("怎么给runtime传递datatexture数据"):this.activeResource(),this._endLoaded()},s.getPixels=function(){return new Uint8Array(this._buffer)},s.disposeResource=function(){this._recreateLock&&(this._needReleaseAgain=!0),this._source&&(P.mainContext.deleteTexture(this._source),this._source=null,this._buffer=null,this.memorySize=0)},a(0,s,"src",function(){return this._src}),e.create=function(t,i,n,r,a,s){if(void 0===r&&(r=9729),void 0===a&&(a=9729),void 0===s&&(s=!0),!t||t.byteLength<i*n*4)throw"DataTexture2D create error";var o=new e;return o._buffer=t,o._width=i,o._height=n,o._mipmap=s,o._magFifter=r,o._minFifter=a,o._size=new je(o._width,o._height),o._conchTexture?alert("怎么给runtime传递datatexture数据"):o.activeResource(),o},e.load=function(t,n,r,a,s){if(void 0===n&&(n=0),void 0===r&&(r=0),void 0===a&&(a=9729),void 0===s&&(s=9729),"mipmaps"===N.getFileExtension(t)){var o=i.loader.create(t,null,null,e,[function(t){this._mipmaps=[];var e=new Uint32Array(t);this._width=e[0];var i=512;if(laya.d3.resource.DataTexture2D.lodasatlas&&(this._width*=2,i=1024),this._width!=i)throw console.error("现在只支持512x256的环境贴图。当前的是"+e[0]),"现在只支持512x256的环境贴图。当前的是"+e[0];this._height=e[1];for(var n=laya.d3.resource.DataTexture2D.lodasatlas?this._width/2:this._width,r=this._height,a=8;;){var s=n*r*4;if(a+s>t.byteLength)throw"load mipmaps data size error ";var o=new Uint8Array(t,a,s);if(this._mipmaps.push(o),a+=s,1==n&&1==r)break;n/=2,r/=2,n<1&&(n=1),r<1&&(r=1)}return null}]);if(laya.d3.resource.DataTexture2D.lodasatlas){o.simLodInfo=new Float32Array(40);for(var l=0;l<o.simLodInfo.length;)o.simLodInfo[l]=(e.simLodRect[l]+.5)/1024,l++,o.simLodInfo[l]=(e.simLodRect[l]+.5)/256,l++,o.simLodInfo[l]=Math.max(e.simLodRect[l]-1,.1)/1024,l++,o.simLodInfo[l]=Math.max(e.simLodRect[l]-1.5,.1)/256,l++}return o}if("number"==typeof n)return i.loader.create(t,null,null,e,[function(t){return this._width=n,this._height=r,this._buffer=t,null}]);if("function"==typeof n)return i.loader.create(t,null,null,e,[n]);throw new Error("unknown params.")},e.lodasatlas=!1,n(e,["simLodRect",function(){return this.simLodRect=new Uint32Array([0,0,512,256,512,0,256,128,768,0,128,64,896,0,64,32,960,0,32,16,992,0,16,8,1008,0,8,4,1016,0,4,2,1020,0,2,1,1022,0,1,1])}]),e}(vi),nn=function(t){function e(){this._numberVertices=0,this._numberIndices=0,this._vertexBuffer=null,this._indexBuffer=null,e.__super.call(this)}r(e,"laya.d3.resource.models.PrimitiveMesh",t);var n=e.prototype;return i.imps(n,{"laya.d3.core.render.IRenderable":!0}),n._getVertexBuffer=function(t){return void 0===t&&(t=0),0===t?this._vertexBuffer:null},n._getVertexBuffers=function(){return null},n._getIndexBuffer=function(){return this._indexBuffer},n._getPositions=function(){var t,e=[],i=this._vertexBuffer.vertexDeclaration.getVertexElements(),n=0;for(n=0;n<i.length;n++){var r=i[n];if("vector3"===r.elementFormat&&0===r.elementUsage){t=r;break}}var a=this._vertexBuffer.getData();for(n=0;n<a.length;n+=this._vertexBuffer.vertexDeclaration.vertexStride/4){var s=n+t.offset/4,o=new Pe(a[s+0],a[s+1],a[s+2]);e.push(o)}return e},n.getRenderElement=function(t){return this},n.getRenderElementsCount=function(){return 1},n.disposeResource=function(){this._vertexBuffer&&(this._vertexBuffer.destroy(),this._vertexBuffer=null),this._indexBuffer&&(this._indexBuffer.destroy(),this._indexBuffer=null),this.memorySize=0},n._beforeRender=function(t){return this._vertexBuffer._bind(),this._indexBuffer._bind(),!0},n._render=function(t){P.mainContext.drawElements(4,this._numberIndices,5123,0),C.drawCall++,C.trianglesFaces+=this._numberIndices/3},n._renderRuntime=function(t,e,i){t.drawSubmesh(e._conchSubmesh,0,4,0,this._numberIndices)},a(0,n,"_vertexBufferCount",function(){return 1}),a(0,n,"triangleCount",function(){return this._indexBuffer.indexCount/3}),e}(gi),rn=function(t){function e(){this._materials=null,this._subMeshes=null,this._vertexBuffers=null,this._indexBuffer=null,this._boneNames=null,this._inverseBindPoses=null,this._skinnedDatas=null,e.__super.call(this),this._subMeshes=[],this._materials=[],this._vertexBuffers=[]}r(e,"laya.d3.resource.models.Mesh",t);var n=e.prototype;return n._getPositions=function(){var t,e,i,n,r,a=[],s=0,o=0,l=0;if(0!==this._vertexBuffers.length){var h=this._vertexBuffers.length;for(s=0;s<h;s++){for(t=this._vertexBuffers[s],i=t.vertexDeclaration.getVertexElements(),o=0;o<i.length;o++)if(n=i[o],"vector3"===n.elementFormat&&0===n.elementUsage){e=n;break}for(r=t.getData(),o=0;o<r.length;o+=t.vertexDeclaration.vertexStride/4)l=o+e.offset/4,a.push(new Pe(r[l+0],r[l+1],r[l+2]))}}else{var u=this._subMeshes.length;for(s=0;s<u;s++){var _=this._subMeshes[s];for(t=_._getVertexBuffer(),i=t.vertexDeclaration.getVertexElements(),o=0;o<i.length;o++)if(n=i[o],"vector3"===n.elementFormat&&0===n.elementUsage){e=n;break}for(r=t.getData(),o=0;o<r.length;o+=t.vertexDeclaration.vertexStride/4)l=o+e.offset/4,a.push(new Pe(r[l+0],r[l+1],r[l+2]))}}return a},n._setSubMeshes=function(t){this._subMeshes=t,this._subMeshCount=t.length;for(var e=0;e<this._subMeshCount;e++)t[e]._indexInMesh=e;this._positions=this._getPositions(),this._generateBoundingObject()},n.onAsynLoaded=function(t,e,i){var n=e[0],r=e[1];Ee.read(n,this,this._materials,this._subMeshes,r),this.completeCreate(),this._endLoaded()},n.getSubMesh=function(t){return this._subMeshes[t]},n.getSubMeshCount=function(){return this._subMeshes.length},n.getRenderElementsCount=function(){return this._subMeshes.length},n.getRenderElement=function(t){return this._subMeshes[t]},n.disposeResource=function(){for(var t=0;t<this._subMeshes.length;t++)this._subMeshes[t].dispose();this._materials=null,this._subMeshes=null,this._vertexBuffers=null,this._indexBuffer=null,this._boneNames=null,this._inverseBindPoses=null},a(0,n,"materials",function(){return this._materials.slice()}),a(0,n,"InverseAbsoluteBindPoses",function(){return this._inverseBindPoses}),e.load=function(t){return i.loader.create(t,null,null,e)},e}(gi),an=function(t){function e(t,i,n,r,a,s,o,l,h){this._alreadyResolved=!1,this._surfaceFormat=0,this._surfaceType=0,this._depthStencilFormat=0,this._frameBuffer=null,this._depthStencilBuffer=null,void 0===n&&(n=6408),void 0===r&&(r=5121),void 0===a&&(a=33189),void 0===s&&(s=!1),void 0===o&&(o=!1),void 0===l&&(l=-1),void 0===h&&(h=-1),e.__super.call(this),this._type=3553,this._width=t,this._height=i,this._size=new je(t,i),this._surfaceFormat=n,this._surfaceType=r,this._depthStencilFormat=a,this._mipmap=s,this._repeat=o,this._minFifter=l,this._magFifter=h,this.activeResource(),this._alreadyResolved=!0}r(e,"laya.d3.resource.RenderTexture",t);var n=e.prototype;return n.recreateResource=function(){var t=P.mainContext;this._frameBuffer=t.createFramebuffer(),this._source=t.createTexture();var e=L.curBindTexTarget,i=L.curBindTexValue;L.bindTexture(t,this._type,this._source),t.texImage2D(this._type,0,6408,this._width,this._height,0,this._surfaceFormat,this._surfaceType,null);var n=this._minFifter,r=this._magFifter,a=this._repeat?10497:33071;if(h.isPOT(this._width,this._height)?(this._mipmap?-1!==n||(n=9987):-1!==n||(n=9729),-1!==r||(r=9729),t.texParameteri(this._type,10241,n),t.texParameteri(this._type,10240,r),t.texParameteri(this._type,10242,a),t.texParameteri(this._type,10243,a),this._mipmap&&t.generateMipmap(this._type)):(-1!==n||(n=9729),-1!==r||(r=9729),t.texParameteri(this._type,10241,n),t.texParameteri(this._type,10240,r),t.texParameteri(this._type,10242,33071),t.texParameteri(this._type,10243,33071)),t.bindFramebuffer(36160,this._frameBuffer),t.framebufferTexture2D(36160,36064,3553,this._source,0),this._depthStencilFormat)switch(this._depthStencilBuffer=t.createRenderbuffer(),t.bindRenderbuffer(36161,this._depthStencilBuffer),t.renderbufferStorage(36161,this._depthStencilFormat,this._width,this._height),this._depthStencilFormat){case 33189:t.framebufferRenderbuffer(36160,36096,36161,this._depthStencilBuffer);break;case 36168:t.framebufferRenderbuffer(36160,36128,36161,this._depthStencilBuffer);break;case 34041:t.framebufferRenderbuffer(36160,33306,36161,this._depthStencilBuffer)}t.bindFramebuffer(36160,null),e&&i&&L.bindTexture(t,e,i),t.bindRenderbuffer(36161,null),this.memorySize=this._width*this._height*4,this.completeCreate()},n.start=function(){P.mainContext.bindFramebuffer(36160,this.frameBuffer),e._currentRenderTarget=this,this._alreadyResolved=!1},n.end=function(){P.mainContext.bindFramebuffer(36160,null),e._currentRenderTarget=null,this._alreadyResolved=!0},n.getData=function(t,e,i,n){var r=P.mainContext;if(r.bindFramebuffer(36160,this._frameBuffer),!(36053===r.checkFramebufferStatus(36160)))return r.bindFramebuffer(36160,null),null;var a=new Uint8Array(this._width*this._height*4);return r.readPixels(t,e,i,n,this._surfaceFormat,this._surfaceType,a),r.bindFramebuffer(36160,null),a},n.disposeResource=function(){if(this._frameBuffer){var t=P.mainContext;t.deleteTexture(this._source),t.deleteFramebuffer(this._frameBuffer),t.deleteRenderbuffer(this._depthStencilBuffer),this._source=null,this._frameBuffer=null,this._depthStencilBuffer=null,this.memorySize=0}},a(0,n,"surfaceFormat",function(){return this._surfaceFormat}),a(0,n,"surfaceType",function(){return this._surfaceType}),a(0,n,"depthStencilFormat",function(){return this._depthStencilFormat}),a(0,n,"source",function(){return this._alreadyResolved?i.superGet(vi,this,"source"):null}),a(0,n,"depthStencilBuffer",function(){return this._depthStencilBuffer}),a(0,n,"frameBuffer",function(){return this._frameBuffer}),e._currentRenderTarget=null,e}(vi),sn=function(t){function e(t){this._color=null,this._pixels=null,e.__super.call(this),this._type=3553,this._width=1,this._height=1,this._size=new je(this.width,this.height),this._color=t,this._pixels=new Uint8Array([255*t.x,255*t.y,255*t.z,255*t.w])}r(e,"laya.d3.resource.SolidColorTexture2D",t);var i=e.prototype;return i._createWebGlTexture=function(){var t=P.mainContext,e=this._source=t.createTexture(),i=this._width,n=this._height,r=L.curBindTexTarget,a=L.curBindTexValue;L.bindTexture(t,this._type,e),t.texImage2D(this._type,0,6408,i,n,0,6408,5121,this._pixels);var s=this._minFifter,o=this._magFifter,l=this._repeat?10497:33071,u=h.isPOT(i,n);u?(this._mipmap?-1!==s||(s=9987):-1!==s||(s=9729),-1!==o||(o=9729),t.texParameteri(this._type,10241,s),t.texParameteri(this._type,10240,o),t.texParameteri(this._type,10242,l),t.texParameteri(this._type,10243,l),this._mipmap&&t.generateMipmap(this._type)):(-1!==s||(s=9729),-1!==o||(o=9729),t.texParameteri(this._type,10241,s),t.texParameteri(this._type,10240,o),t.texParameteri(this._type,10242,33071),t.texParameteri(this._type,10243,33071)),r&&a&&L.bindTexture(t,r,a),this.memorySize=u?i*n*4*(1+1/3):i*n*4},i.recreateResource=function(){this._createWebGlTexture(),this.completeCreate()},i.disposeResource=function(){this._source&&(P.mainContext.deleteTexture(this._source),this._source=null,this.memorySize=0)},n(e,["magentaTexture",function(){return this.magentaTexture=new e(new Le(1,0,1,1))},"grayTexture",function(){return this.grayTexture=new e(new Le(.5,.5,.5,1))}]),e}(vi),on=function(t){function e(t){this._color=null,this._pixels=null,this._texCount=6,e.__super.call(this),this._type=34067,this._width=1,this._height=1,this._size=new je(this.width,this.height),this._color=t,this._pixels=new Uint8Array([255*t.x,255*t.y,255*t.z,255*t.w])}r(e,"laya.d3.resource.SolidColorTextureCube",t);var i=e.prototype;return i._createWebGlTexture=function(){var t=P.mainContext,e=this._source=t.createTexture(),i=this._width,n=this._height,r=L.curBindTexTarget,a=L.curBindTexValue;L.bindTexture(t,this._type,e),t.texImage2D(34069,0,6408,i,n,0,6408,5121,this._pixels),t.texImage2D(34070,0,6408,i,n,0,6408,5121,this._pixels),t.texImage2D(34071,0,6408,i,n,0,6408,5121,this._pixels),t.texImage2D(34072,0,6408,i,n,0,6408,5121,this._pixels),t.texImage2D(34073,0,6408,i,n,0,6408,5121,this._pixels),t.texImage2D(34074,0,6408,i,n,0,6408,5121,this._pixels);var s=this.minFifter,o=this.magFifter,l=this._repeat?10497:33071,u=h.isPOT(i,n);u?(this.mipmap?-1!==s||(s=9987):-1!==s||(s=9729),-1!==o||(o=9729),t.texParameteri(this._type,10241,s),t.texParameteri(this._type,10240,o),t.texParameteri(this._type,10242,l),t.texParameteri(this._type,10243,l),this.mipmap&&t.generateMipmap(this._type)):(-1!==s||(s=9729),-1!==o||(o=9729),t.texParameteri(this._type,10241,s),t.texParameteri(this._type,10240,o),t.texParameteri(this._type,10242,33071),t.texParameteri(this._type,10243,33071)),r&&a&&L.bindTexture(t,r,a),this.memorySize=u?i*n*4*(1+1/3)*this._texCount:i*n*4*this._texCount},i.recreateResource=function(){this._createWebGlTexture(),this.completeCreate()},i.disposeResource=function(){this._source&&(P.mainContext.deleteTexture(this._source),this._source=null,this.memorySize=0)},n(e,["magentaTexture",function(){return this.magentaTexture=new e(new Le(1,0,1,1))},"grayTexture",function(){return this.grayTexture=new e(new Le(.5,.5,.5,1))}]),e}(vi),ln=function(t){function e(t,i,n,r){this._canRead=!1,this._image=null,this._pixels=null,void 0===t&&(t=!1),void 0===i&&(i=!0),void 0===n&&(n=6408),void 0===r&&(r=!0),e.__super.call(this),this._type=3553,this._repeat=i,this._canRead=t,this._format=n,this._mipmap=r}r(e,"laya.d3.resource.Texture2D",t);var n=e.prototype;return n._createWebGlTexture=function(){if(!this._image)throw"create GLTextur err:no data:"+this._image;var t=P.mainContext,e=this._source=t.createTexture(),i=this._width,n=this._height,r=L.curBindTexTarget,a=L.curBindTexValue;switch(L.bindTexture(t,this._type,e),this._format){case 6407:case 6408:this._canRead?t.texImage2D(this._type,0,this._format,i,n,0,this._format,5121,this._pixels):t.texImage2D(this._type,0,this._format,this._format,5121,this._image);break;case P.compressEtc1.COMPRESSED_RGB_ETC1_WEBGL:t.compressedTexImage2D(this._type,0,this._format,this._width,this._height,0,this._image)}var s=this._minFifter,o=this._magFifter,l=this._repeat?10497:33071,u=h.isPOT(i,n);u?(this._mipmap?-1!==s||(s=9987):-1!==s||(s=9729),-1!==o||(o=9729),t.texParameteri(this._type,10241,s),t.texParameteri(this._type,10240,o),t.texParameteri(this._type,10242,l),t.texParameteri(this._type,10243,l),this._mipmap&&t.generateMipmap(this._type)):(-1!==s||(s=9729),-1!==o||(o=9729),t.texParameteri(this._type,10241,s),t.texParameteri(this._type,10240,o),t.texParameteri(this._type,10242,33071),t.texParameteri(this._type,10243,33071)),r&&a&&L.bindTexture(t,r,a),this._image.onload=null,this._image=null,this.memorySize=u?i*n*4*(1+1/3):i*n*4},n.recreateResource=function(){this._createWebGlTexture(),this.completeCreate()},n.onAsynLoaded=function(t,e,i){if(i){var n=i[0];void 0!==n&&(this._canRead=n);var r=i[1];void 0!==r&&(this._repeat=r);var a=i[2];void 0!==a&&(this._format=a);var s=i[3];void 0!==s&&(this._mipmap=s)}switch(this._format){case 6407:case 6408:this._image=e;var o=e.width,l=e.height;this._width=o,this._height=l,this._size=new je(o,l),this._canRead&&(c.canvas.size(o,l),c.canvas.clear(),c.context.drawImage(e,0,0,o,l),this._pixels=new Uint8Array(c.context.getImageData(0,0,o,l).data.buffer));break;case P.compressEtc1.COMPRESSED_RGB_ETC1_WEBGL:var h=new f(e);h.readUTFBytes(4),h.readUTFBytes(2),h.getInt16();h.endian="bigEndian",this._width=h.getInt16(),this._height=h.getInt16(),this._size=new je(this._width,this._height);h.getInt16(),h.getInt16();this._image=new Uint8Array(e,h.pos)}this.recreateResource(),this._endLoaded()},n.getPixels=function(){if(this._canRead)return this._pixels;throw new Error("Texture2D: must set texture canRead is true.")},n.disposeResource=function(){this._source&&(P.mainContext.deleteTexture(this._source),this._source=null,this._image=null,this.memorySize=0)},a(0,n,"_src",function(){return this.url}),a(0,n,"src",function(){return this.url}),e.load=function(t){return i.loader.create(t,null,null,e)},e}(vi),hn=function(t){function e(){e.__super.call(this),this._type=34067}r(e,"laya.d3.resource.TextureCube",t);var n=e.prototype;return n._onTextureLoaded=function(t){this._images=t;for(var e=2147483647,i=2147483647,n=0;n<6;n++){var r=t[n];e=Math.min(e,r.width),i=Math.min(i,r.height)}this._width=e,this._height=i,this._size=new je(e,i)},n._createWebGlTexture=function(){var t=0;for(t=0;t<6;t++)if(!this._images[t])throw"create GLTextur err:no data:"+this._images[t];var e=P.mainContext,i=this._source=e.createTexture(),n=this._width,r=this._height,a=L.curBindTexTarget,s=L.curBindTexValue;L.bindTexture(e,this._type,i),e.texImage2D(34069,0,6408,6408,5121,this._images[0]),e.texImage2D(34070,0,6408,6408,5121,this._images[1]),e.texImage2D(34071,0,6408,6408,5121,this._images[2]),e.texImage2D(34072,0,6408,6408,5121,this._images[3]),e.texImage2D(34073,0,6408,6408,5121,this._images[4]),e.texImage2D(34074,0,6408,6408,5121,this._images[5]);var o=this.minFifter,l=this.magFifter,u=this._repeat?10497:33071,_=h.isPOT(n,r);for(_?(this.mipmap?-1!==o||(o=9987):-1!==o||(o=9729),-1!==l||(l=9729),e.texParameteri(this._type,10241,o),e.texParameteri(this._type,10240,l),e.texParameteri(this._type,10242,u),e.texParameteri(this._type,10243,u),this.mipmap&&e.generateMipmap(this._type)):(-1!==o||(o=9729),-1!==l||(l=9729),e.texParameteri(this._type,10241,o),e.texParameteri(this._type,10240,l),e.texParameteri(this._type,10242,33071),e.texParameteri(this._type,10243,33071)),a&&s&&L.bindTexture(e,a,s),t=0;t<6;t++)this._images[t].onload=null,this._images[t]=null;this.memorySize=_?n*r*4*(1+1/3)*6:n*r*4*6},n.recreateResource=function(){null!=this._url&&(this._createWebGlTexture(),this.completeCreate())},n.onAsynLoaded=function(t,e,i){this._onTextureLoaded(e),this.activeResource(),this._endLoaded()},n.disposeResource=function(){this._source&&(P.mainContext.deleteTexture(this._source),this._source=null,this.memorySize=0)},a(0,n,"defaulteTexture",function(){return on.grayTexture}),e.load=function(t){return i.loader.create(t,null,null,e)},e}(vi),un=function(t){function e(t){this._hasIndependentBound=!0,e.__super.call(this,t),this._owner.transform.off("worldmatrixneedchanged",this,this._onWorldMatNeedChange),this._cacheAnimationNodeIndex=[],this._cacheAnimationNode=[],this._localBoundingBoxCorners=s(8,null),this._owner.meshFilter.on("meshchanged",this,this._$3__onMeshChanged)}r(e,"laya.d3.core.SkinnedMeshRender",t);var i=e.prototype;return i._getCacheAnimationNodes=function(){var t=this._cacheMesh._boneNames,e=t.length;this._cacheAnimationNode.length=e,this._cacheAnimationNodeIndex.length=e;for(var i=this._cacheAnimator._avatarNodes,n=this._cacheAnimator._avatarNodeMap,r=0;r<e;r++){var a=n[t[r]];this._cacheAnimationNode[r]=a,this._cacheAnimationNodeIndex[r]=i.indexOf(a)}},i._offComputeBoneIndexToMeshEvent=function(t,e){t.loaded?e.loaded||e.off("loaded",this,this._getCacheAnimationNodes):t.off("loaded",this,this._computeBoneIndexToMeshWithAsyncMesh)},i._computeBoneIndexToMeshWithAsyncAvatar=function(){this._cacheAvatar.loaded?this._computeBoneIndexToMeshWithAsyncMesh():this._cacheAvatar.once("loaded",this,this._computeBoneIndexToMeshWithAsyncMesh)},i._computeBoneIndexToMeshWithAsyncMesh=function(){this._cacheMesh.loaded?this._getCacheAnimationNodes():this._cacheMesh.on("loaded",this,this._getCacheAnimationNodes)},i._$3__onMeshChanged=function(t,e,i){this._cacheMesh=i,e&&!e.loaded&&i.off("loaded",this,this._onMeshLoaded),i.loaded?this._onMeshLoaded(i):i.on("loaded",this,this._onMeshLoaded),this._cacheAvatar&&(e&&this._offComputeBoneIndexToMeshEvent(this._cacheAvatar,e),i&&this._computeBoneIndexToMeshWithAsyncAvatar())},i._onMeshLoaded=function(t){var e=t.subMeshCount;this._subSkinnedDatas=[],this._subSkinnedDatas.length=e;for(var i=0;i<e;i++)for(var n=this._subSkinnedDatas[i]=[],r=t.getSubMesh(i)._boneIndicesList,a=0,s=r.length;a<s;a++)n[a]=new Float32Array(16*r[a].length)},i._setCacheAnimator=function(t){this._cacheAnimator=t,this._rootBone&&(this._rootIndex=t._avatarNodes.indexOf(t._avatarNodeMap[this._rootBone]))},i._setRootBone=function(t){this._rootBone=t,this._cacheAnimator&&(this._rootIndex=this._cacheAnimator._avatarNodes.indexOf(this._cacheAnimator._avatarNodeMap[t]))},i._setCacheAvatar=function(t){this._cacheAvatar!==t&&(this._cacheMesh?(this._cacheAvatar&&this._offComputeBoneIndexToMeshEvent(this._cacheAvatar,this._cacheMesh),this._cacheAvatar=t,t&&(this._addShaderDefine(En.SHADERDEFINE_BONE),this._computeBoneIndexToMeshWithAsyncAvatar())):this._cacheAvatar=t)},i._calculateBoundingBox=function(){if(this._hasIndependentBound){if(this._cacheAnimator){var e=this._cacheAnimator._avatarNodeMap[this._rootBone];null==e||null==this._localBoundBox?this._boundingBox.toDefault():this._calculateBoundBoxByInitCorners(this._localBoundingBoxCorners)}}else t.prototype._calculateBoundingBox.call(this)},i._calculateBoundingSphere=function(){if(this._hasIndependentBound){if(this._cacheAnimator){var e=this._cacheAnimator._avatarNodeMap[this._rootBone];null==e||null==this.localBoundSphere?this._boundingSphere.toDefault():this._calculateBoundingSphereByInitSphere(this.localBoundSphere)}}else t.prototype._calculateBoundingSphere.call(this)},i._updateOctreeNode=function(){var t=this._treeNode;t&&t.updateObject(this)},i._renderUpdate=function(t){var i,n=this._cacheAnimator,r=this._cacheMesh.subMeshCount,a=this._owner.transform,s=n._canCache;if(n){var o=this._cacheAnimator._curAvatarNodeDatas;if(this._hasIndependentBound){var l=a.worldMatrix;s?qe.matrix4x4MultiplyMFM(this._cacheAnimator.owner.transform.worldMatrix,o[this._rootIndex],l):qe.matrix4x4MultiplyMFM(this._cacheAnimator.owner.transform.worldMatrix,n._avatarNodeMap[this._rootBone].transform.getWorldMatrix(),l),a.worldMatrix=l}var h=n.owner;if(this._setShaderValueMatrix4x4(0,h._transform.worldMatrix),i=h.getProjectionViewWorldMatrix(t),this._setShaderValueMatrix4x4(1,i),this._cacheMesh&&this._cacheMesh.loaded&&this._cacheAvatar&&this._cacheAvatar.loaded){var u=0,_=0,c=this._cacheMesh._inverseBindPoses,d=this._cacheMesh._skinnedDatas;if(s)for(u=0,_=c.length;u<_;u++)qe._mulMatrixArray(o[this._cacheAnimationNodeIndex[u]],c[u],d,16*u);else for(u=0,_=c.length;u<_;u++)qe._mulMatrixArray(this._cacheAnimationNode[u].transform.getWorldMatrix(),c[u],d,16*u);for(u=0;u<r;u++){for(var f=this._cacheMesh.getSubMesh(u)._boneIndicesList,m=f.length,p=this._subSkinnedDatas[u],v=0;v<m;v++)e._splitAnimationDatas(f[v],d,p[v]);this._renderElements[u]._skinAnimationDatas=p}}}else this._setShaderValueMatrix4x4(0,a.worldMatrix),i=this._owner.getProjectionViewWorldMatrix(t),this._setShaderValueMatrix4x4(1,i);return Qe.debugMode&&this._renderRenderableBoundBox(),!0},a(0,i,"localBoundBox",function(){return this._localBoundBox},function(t){this._localBoundBox=t,t.getCorners(this._localBoundingBoxCorners)}),a(0,i,"boundingSphere",function(){return this._calculateBoundingSphere(),this._boundingSphere}),a(0,i,"boundingBox",function(){return this._calculateBoundingBox(),this._boundingBox}),a(0,i,"boundingBoxCenter",function(){var t=this.boundingBox;return Pe.add(t.min,t.max,this._boundingBoxCenter),Pe.scale(this._boundingBoxCenter,.5,this._boundingBoxCenter),this._boundingBoxCenter}),e._splitAnimationDatas=function(t,e,i){for(var n=0,r=t.length,a=0;n<r;n++)for(var s=t[n]<<4,o=0;o<16;o++,a++)i[a]=e[s+o]},e}(Ii),_n=function(t){function e(t,n){e.__super.call(this),void 0===t&&(t=.3),void 0===n&&(n=1e3),this._tempVector3=new Pe,this._position=new Pe,this._up=new Pe,this._forward=new Pe,this._right=new Pe,this._fieldOfView=60,this._useUserProjectionMatrix=!1,this._orthographic=!1,this._viewportExpressedInClipSpace=!0,this._renderTargetSize=je.fullScreen,this._orthographicVerticalSize=10,this.renderingOrder=0,this._nearPlane=t,this._farPlane=n,this.cullingMask=2147483647,this.clearFlag=0,this.useOcclusionCulling=!0,this._calculateProjectionMatrix(),i.stage.on("resize",this,this._onScreenSizeChanged)}r(e,"laya.d3.core.BaseCamera",t);var s=e.prototype;return s.createConchModel=function(){return new ConchCamera},s._sortCamerasByRenderingOrder=function(){if(this._displayedInStage)for(var t=this.scene._cameraPool,e=t.length-1,i=0;i<e;i++)if(t[i].renderingOrder>t[e].renderingOrder){var n=t[i];t[i]=t[e],t[e]=n}},s._calculateProjectionMatrix=function(){},s._onScreenSizeChanged=function(){this._calculateProjectionMatrix()},s._prepareCameraToRender=function(){k._currentCameraCullingMask=this.cullingMask;var t=this._shaderValues;t.setValue(0,this.transform.position.elements),t.setValue(5,this.forward.elements),t.setValue(6,this.up.elements)},s._prepareCameraViewProject=function(t,e){var i=this._shaderValues;i.setValue(1,t.elements),i.setValue(2,e.elements)},s._renderCamera=function(t,e,i){},s.addLayer=function(t){29!==t.number&&30!=t.number&&(this.cullingMask=this.cullingMask|t.mask)},s.removeLayer=function(t){29!==t.number&&30!=t.number&&(this.cullingMask=this.cullingMask&~t.mask)},s.addAllLayers=function(){this.cullingMask=2147483647},s.removeAllLayers=function(){this.cullingMask=0|k.getLayerByNumber(29).mask|k.getLayerByNumber(30).mask},s.ResetProjectionMatrix=function(){this._useUserProjectionMatrix=!1,this._calculateProjectionMatrix()},s.moveForward=function(t){this._tempVector3.elements[0]=this._tempVector3.elements[1]=0,this._tempVector3.elements[2]=t,this.transform.translate(this._tempVector3)},s.moveRight=function(t){this._tempVector3.elements[1]=this._tempVector3.elements[2]=0,this._tempVector3.elements[0]=t,this.transform.translate(this._tempVector3)},s.moveVertical=function(t){this._tempVector3.elements[0]=this._tempVector3.elements[2]=0,this._tempVector3.elements[1]=t,this.transform.translate(this._tempVector3,!1)},s._addSelfRenderObjects=function(){var t=this.scene._cameraPool,e=t.length;if(e>0){for(var i=e-1;i>=0;i--)if(this.renderingOrder<=t[i].renderingOrder){t.splice(i+1,0,this);break}}else t.push(this),this.scene.conchModel&&this.scene.conchModel.setCurrentCamera(this.conchModel)},s._clearSelfRenderObjects=function(){var t=this.scene._cameraPool;t.splice(t.indexOf(this),1)},s.destroy=function(e){void 0===e&&(e=!0),this._sky&&this._sky.destroy(),this.renderTarget=null,i.stage.off("resize",this,this._onScreenSizeChanged),t.prototype.destroy.call(this,e)},a(0,s,"sky",function(){return this._sky},function(t){this._sky=t,t._ownerCamera=this,this.conchModel&&this.conchModel.setSkyMesh(this._sky._conchSky)}),a(0,s,"forward",function(){var t=this.transform.worldMatrix.elements,e=this._forward.elements;return e[0]=-t[8],e[1]=-t[9],e[2]=-t[10],this._forward}),a(0,s,"position",function(){var t=this.transform.worldMatrix.elements,e=this._position.elements;return e[0]=t[12],e[1]=t[13],e[2]=t[14],this._position}),a(0,s,"renderTarget",function(){return this._renderTarget},function(t){this._renderTarget=t,null!=t&&(this._renderTargetSize=t.size)}),a(0,s,"up",function(){var t=this.transform.worldMatrix.elements,e=this._up.elements;return e[0]=t[4],e[1]=t[5],e[2]=t[6],this._up}),a(0,s,"right",function(){var t=this.transform.worldMatrix.elements,e=this._right.elements;return e[0]=t[0],e[1]=t[1],e[2]=t[2],this._right}),a(0,s,"renderTargetSize",function(){return this._renderTargetSize},function(t){null!=this.renderTarget&&this._renderTargetSize,this._renderTargetSize=t,this._calculateProjectionMatrix()}),a(0,s,"fieldOfView",function(){return this._fieldOfView},function(t){this._fieldOfView=t,this._calculateProjectionMatrix()}),a(0,s,"nearPlane",function(){return this._nearPlane},function(t){this._nearPlane=t,this._calculateProjectionMatrix()}),a(0,s,"farPlane",function(){return this._farPlane},function(t){this._farPlane=t,this._calculateProjectionMatrix()}),a(0,s,"orthographic",function(){return this._orthographic},function(t){this._orthographic=t,this._calculateProjectionMatrix()}),a(0,s,"orthographicVerticalSize",function(){return this._orthographicVerticalSize},function(t){this._orthographicVerticalSize=t,this._calculateProjectionMatrix()}),a(0,s,"renderingOrder",function(){return this._renderingOrder},function(t){this._renderingOrder=t,this._sortCamerasByRenderingOrder()}),e.CAMERAPOS=0,e.VIEWMATRIX=1,e.PROJECTMATRIX=2,e.VPMATRIX=3,e.VPMATRIX_NO_TRANSLATE=4,e.CAMERADIRECTION=5,e.CAMERAUP=6,e.ENVIRONMENTDIFFUSE=7,e.ENVIRONMENTSPECULAR=8,e.SIMLODINFO=9,e.DIFFUSEIRRADMATR=10,e.DIFFUSEIRRADMATG=11,e.DIFFUSEIRRADMATB=12,e.HDREXPOSURE=13,e.RENDERINGTYPE_DEFERREDLIGHTING="DEFERREDLIGHTING",e.RENDERINGTYPE_FORWARDRENDERING="FORWARDRENDERING",e.CLEARFLAG_SOLIDCOLOR=0,e.CLEARFLAG_SKY=1,e.CLEARFLAG_DEPTHONLY=2,e.CLEARFLAG_NONE=3,n(e,["_invertYScaleMatrix",function(){return this._invertYScaleMatrix=new Ae(1,0,0,0,0,-1,0,0,0,0,1,0,0,0,0,1)},"_invertYProjectionMatrix",function(){return this._invertYProjectionMatrix=new Ae},"_invertYProjectionViewMatrix",function(){return this._invertYProjectionViewMatrix=new Ae}]),e}(Vi),cn=function(t){function e(t){this._render=null,this._geometryFilter=null,e.__super.call(this,t)}r(e,"laya.d3.core.RenderableSprite3D",t);var i=e.prototype;return i._addToInitStaticBatchManager=function(){},i._setBelongScene=function(e){t.prototype._setBelongScene.call(this,e),e._renderableSprite3Ds.push(this),this._render._applyLightMapParams()},i._setUnBelongScene=function(){var e=this._scene._renderableSprite3Ds,i=e.indexOf(this);e.splice(i,1),this._render._removeShaderDefine(laya.d3.core.RenderableSprite3D.SAHDERDEFINE_LIGHTMAP),t.prototype._setUnBelongScene.call(this)},i._update=function(t){t.owner=this,this._activeInHierarchy&&(this._updateComponents(t),this._render._updateOctreeNode(),this._lateUpdateComponents(t),C.spriteCount++,this._childs.length&&this._updateChilds(t))},i.destroy=function(e){void 0===e&&(e=!0),t.prototype.destroy.call(this,e),this._render._destroy(),this._render=null},i._updateConch=function(t){t.owner=this,this._activeInHierarchy&&(this._updateComponents(t),this._render._updateOctreeNode(),this._lateUpdateComponents(t),C.spriteCount++,this._childs.length&&this._updateChildsConch(t))},e.__init__=function(){e.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV=e.shaderDefines.registerDefine("SCALEOFFSETLIGHTINGMAPUV"),e.SAHDERDEFINE_LIGHTMAP=e.shaderDefines.registerDefine("LIGHTMAP")},e.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV=2,e.SAHDERDEFINE_LIGHTMAP=4,e.LIGHTMAPSCALEOFFSET=2,e.LIGHTMAP=3,n(e,["shaderDefines",function(){return this.shaderDefines=new Be}]),e}(Vi),dn=function(t){function e(){this._intensityColor=null,this._intensity=NaN,this._shadow=!1,this._shadowFarPlane=0,this._shadowMapSize=0,this._shadowMapCount=0,this._shadowMapPCFType=0,this._parallelSplitShadowMap=null,this._lightmapBakedType=0,this.color=null,e.__super.call(this),this._intensity=1,this._intensityColor=new Pe,this.color=new Pe(1,1,1),this._shadow=!1,this._shadowFarPlane=8,this._shadowMapSize=512,this._shadowMapCount=1,this._shadowMapPCFType=0,this._lightmapBakedType=e.LIGHTMAPBAKEDTYPE_REALTIME}r(e,"laya.d3.core.light.LightSprite",t);var i=e.prototype;return i._parseCustomProps=function(t,e,i,n){var r=i.color,a=this.color.elements;a[0]=r[0],a[1]=r[1],a[2]=r[2]},i._addSelfRenderObjects=function(){this.lightmapBakedType!==e.LIGHTMAPBAKEDTYPE_BAKED&&this._scene._addLight(this)},i._clearSelfRenderObjects=function(){this.lightmapBakedType!==e.LIGHTMAPBAKEDTYPE_BAKED&&this._scene._removeLight(this)},i._prepareToScene=function(t){return!1},a(0,i,"lightmapBakedType",function(){return this._lightmapBakedType},function(t){this._lightmapBakedType!==t&&(this._lightmapBakedType=t,this._activeInHierarchy&&(t!==e.LIGHTMAPBAKEDTYPE_BAKED?this._scene._addLight(this):this._scene._removeLight(this)))}),a(0,i,"shadowPCFType",function(){return this._shadowMapPCFType},function(t){this._shadowMapPCFType=t,this._parallelSplitShadowMap&&this._parallelSplitShadowMap.setPCFType(t)}),a(0,i,"intensity",function(){return this._intensity},function(t){this._intensity=t}),a(0,i,"shadow",function(){return this._shadow},function(t){throw new Error("LightSprite: must override it.")}),a(0,i,"shadowDistance",function(){return this._shadowFarPlane},function(t){this._shadowFarPlane=t,this._parallelSplitShadowMap&&this._parallelSplitShadowMap.setFarDistance(t)}),a(0,i,"shadowPSSMCount",function(){return this._shadowMapCount},function(t){this._shadowMapCount=t,this._parallelSplitShadowMap&&(this._parallelSplitShadowMap.PSSMNum=t)}),a(0,i,"shadowResolution",function(){return this._shadowMapSize},function(t){this._shadowMapSize=t,this._parallelSplitShadowMap&&this._parallelSplitShadowMap.setShadowMapTextureSize(t)}),a(0,i,"diffuseColor",function(){return console.log("LightSprite: discard property,please use color property instead."),this.color},function(t){console.log("LightSprite: discard property,please use color property instead."),this.color=t}),e.LIGHTMAPBAKEDTYPE_REALTIME=0,e.LIGHTMAPBAKEDTYPE_MIXED=1,e.LIGHTMAPBAKEDTYPE_BAKED=2,e}(Vi),fn=function(t){function e(t){this._terrainRes=null,this._lightmapScaleOffset=null,e.__super.call(this),this._lightmapScaleOffset=new Le(1,1,0,0),t&&(this._terrainRes=t,t.loaded?this.buildTerrain(t):t.once("loaded",this,this.buildTerrain))}r(e,"laya.d3.terrain.Terrain",t);var n=e.prototype;return n._parseCustomProps=function(t,e,i,n){this.terrainRes=E.getRes(e[i.dataPath]);var r=i.lightmapIndex;null!=r&&this.setLightmapIndex(r);var a=i.lightmapScaleOffset;a&&this.setLightmapScaleOffset(new Le(a[0],a[1],a[2],a[3]))},n.setLightmapIndex=function(t){for(var e=0;e<this._childs.length;e++){this._childs[e].terrainRender.lightmapIndex=t}},n.setLightmapScaleOffset=function(t){if(t){t.cloneTo(this._lightmapScaleOffset);for(var e=0;e<this._childs.length;e++){this._childs[e].terrainRender.lightmapScaleOffset=this._lightmapScaleOffset}}},n.disableLight=function(){for(var t=0,e=this._childs.length;t<e;t++)for(var i=this._childs[t],n=0,r=i._render.sharedMaterials.length;n<r;n++){var a=i._render.sharedMaterials[n];a.disableLight()}},n.buildTerrain=function(t){for(var e=t._chunkNumX,i=t._chunkNumZ,n=t._heightData,r=0,a=0;a<i;a++)for(var s=0;s<e;s++){for(var o=new Tn(s,a,t._gridSize,n._terrainHeightData,n._width,n._height,t._cameraCoordinateInverse),l=t._chunkInfos[r++],h=0;h<l.alphaMap.length;h++){var u=l.detailID[h].length,_=u>0?t._detailTextureInfos[l.detailID[h][0]].diffuseTexture:null,c=u>1?t._detailTextureInfos[l.detailID[h][1]].diffuseTexture:null,d=u>2?t._detailTextureInfos[l.detailID[h][2]].diffuseTexture:null,f=u>3?t._detailTextureInfos[l.detailID[h][3]].diffuseTexture:null,m=u>0?t._detailTextureInfos[l.detailID[h][0]].scale:null,p=u>1?t._detailTextureInfos[l.detailID[h][1]].scale:null,v=u>2?t._detailTextureInfos[l.detailID[h][2]].scale:null,g=u>3?t._detailTextureInfos[l.detailID[h][3]].scale:null;o.buildRenderElementAndMaterial(u,l.normalMap,l.alphaMap[h],_,c,d,f,t._materialInfo.ambientColor,t._materialInfo.diffuseColor,t._materialInfo.specularColor,m?m.x:1,m?m.y:1,p?p.x:1,p?p.y:1,v?v.x:1,v?v.y:1,g?g.x:1,g?g.y:1)}o.terrainRender.receiveShadow=!0,o.terrainRender.lightmapScaleOffset=this._lightmapScaleOffset,this.addChild(o)}},n.width=function(){return this._terrainRes._chunkNumX*ze.CHUNK_GRID_NUM*this._terrainRes._gridSize},n.depth=function(){return this._terrainRes._chunkNumZ*ze.CHUNK_GRID_NUM*this._terrainRes._gridSize},n.getHeightXZ=function(t,i){if(!this._terrainRes||!this._terrainRes.loaded)return NaN;if(t-=this.transform.position.x,i-=this.transform.position.z,e.__VECTOR3__||(e.__VECTOR3__=new Pe),e.__VECTOR3__.elements[0]=t,e.__VECTOR3__.elements[1]=0,e.__VECTOR3__.elements[2]=i,Pe.transformV3ToV3(e.__VECTOR3__,ze.__ADAPT_MATRIX_INV__,e.__VECTOR3__),t=e.__VECTOR3__.elements[0],i=e.__VECTOR3__.elements[2],t<0||t>this.width()||i<0||i>this.depth())return NaN;var n=this._terrainRes._gridSize,r=parseInt(""+t/n),a=parseInt(""+i/n),s=t-r*n,o=i-a*n,l=NaN,h=NaN,u=NaN,_=NaN,c=NaN,d=this._terrainRes._heightData;return s+o>n?(l=d._terrainHeightData[(a+1-1)*d._width+r+1],h=d._terrainHeightData[(a+1-1)*d._width+r],u=d._terrainHeightData[(a-1)*d._width+r+1],_=(n-s)/n,c=(n-o)/n,l+(h-l)*_+(u-l)*c):(l=d._terrainHeightData[Math.max(0,a-1)*d._width+r],h=d._terrainHeightData[Math.min(d._width*d._height-1,(a+1-1)*d._width+r)],u=d._terrainHeightData[Math.min(d._width*d._height-1,Math.max(0,a-1)*d._width+r+1)],_=s/n,c=o/n,l+(h-l)*c+(u-l)*_)},a(0,n,"terrainRes",null,function(t){t&&(this._terrainRes=t,t.loaded?this.buildTerrain(t):t.once("loaded",this,this.buildTerrain))}),e.load=function(t){return i.loader.create(t,null,null,e,null,1,!1)},e.RENDER_LINE_MODEL=!1,e.LOD_TOLERANCE_VALUE=4,e.LOD_DISTANCE_FACTOR=2,e.__VECTOR3__=null,e}(Vi),mn=(function(t){function e(t,i,n){this._long=NaN,this._width=NaN,this._height=NaN,void 0===t&&(t=1),void 0===i&&(i=1),void 0===n&&(n=1),e.__super.call(this),this._long=t,this._width=i,this._height=n,this.activeResource(),this._positions=this._getPositions(),this._generateBoundingObject()}r(e,"laya.d3.resource.models.BoxMesh",t);var i=e.prototype;i.recreateResource=function(){this._numberVertices=24,this._numberIndices=36;var t=Qt.vertexDeclaration,e=(t.vertexStride,this._long/2),i=this._height/2,n=this._width/2,r=new Float32Array([-e,i,-n,0,1,0,0,0,e,i,-n,0,1,0,1,0,e,i,n,0,1,0,1,1,-e,i,n,0,1,0,0,1,-e,-i,-n,0,-1,0,0,1,e,-i,-n,0,-1,0,1,1,e,-i,n,0,-1,0,1,0,-e,-i,n,0,-1,0,0,0,-e,i,-n,-1,0,0,0,0,-e,i,n,-1,0,0,1,0,-e,-i,n,-1,0,0,1,1,-e,-i,-n,-1,0,0,0,1,e,i,-n,1,0,0,1,0,e,i,n,1,0,0,0,0,e,-i,n,1,0,0,0,1,e,-i,-n,1,0,0,1,1,-e,i,n,0,0,1,0,0,e,i,n,0,0,1,1,0,e,-i,n,0,0,1,1,1,-e,-i,n,0,0,1,0,1,-e,i,-n,0,0,-1,1,0,e,i,-n,0,0,-1,0,0,e,-i,-n,0,0,-1,0,1,-e,-i,-n,0,0,-1,1,1]),a=new Uint16Array([0,1,2,2,3,0,4,7,6,6,5,4,8,9,10,10,11,8,12,15,14,14,13,12,16,17,18,18,19,16,20,23,22,22,21,20]);this._vertexBuffer=new Ki(t,this._numberVertices,35044,!0),this._indexBuffer=new Zi("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(r),this._indexBuffer.setData(a),this.memorySize=2*(this._vertexBuffer._byteLength+this._indexBuffer._byteLength),this.completeCreate()},a(0,i,"long",function(){return this._long},function(t){this._long!==t&&(this._long=t,this.releaseResource(),this.activeResource())}),a(0,i,"width",function(){return this._width},function(t){this._width!==t&&(this._width=t,this.releaseResource(),this.activeResource())}),a(0,i,"height",function(){return this._height},function(t){this._height!==t&&(this._height=t,this.releaseResource(),this.activeResource())})}(nn),function(t){function e(t,i,n,r){this._radius=NaN,this._height=NaN,this._slices=0,this._stacks=0,void 0===t&&(t=.5),void 0===i&&(i=2),void 0===n&&(n=16),void 0===r&&(r=32),e.__super.call(this),this._radius=t,this._height=i<2*t?2*t:i,this._stacks=n,this._slices=r,this.recreateResource(),this._positions=this._getPositions(),this._generateBoundingObject()}r(e,"laya.d3.resource.models.CapsuleMesh",t);var i=e.prototype;i.recreateResource=function(){this._numberVertices=(this._stacks+1)*(this.slices+1)*2+2*(this._slices+1),this._numberIndices=3*this._stacks*(this._slices+1)*2*2+2*this._slices*3;var t=Qt.vertexDeclaration,e=t.vertexStride/4,i=new Float32Array(this._numberVertices*e),n=new Uint16Array(this._numberIndices),r=Math.PI/2/this._stacks,a=2*Math.PI/this._slices,s=this._height/2-this._radius,o=0,l=0,h=0,u=0,_=0,c=0,d=0,f=0;for(d=0;d<=this._stacks;d++)for(f=0;f<=this._slices;f++)o=this._radius*Math.cos(d*r)*Math.cos(f*a+Math.PI),l=this._radius*Math.sin(d*r),h=this._radius*Math.cos(d*r)*Math.sin(f*a+Math.PI),i[u++]=o,i[u++]=l+s,i[u++]=h,i[u++]=o,i[u++]=l,i[u++]=h,i[u++]=1-f/this._slices,i[u++]=(1-d/this._stacks)*(Math.PI*this._radius/2/(this._height+Math.PI*this._radius)),d<this._stacks&&(n[_++]=d*(this._slices+1)+f+(this._slices+1),n[_++]=d*(this._slices+1)+f,n[_++]=d*(this._slices+1)+f+1,n[_++]=d*(this._slices+1)+f+this._slices,n[_++]=d*(this._slices+1)+f,n[_++]=d*(this._slices+1)+f+(this._slices+1));for(c+=(this._stacks+1)*(this._slices+1),d=0;d<=this._stacks;d++)for(f=0;f<=this._slices;f++)o=this._radius*Math.cos(d*r)*Math.cos(f*a+Math.PI),l=this._radius*Math.sin(-d*r),h=this._radius*Math.cos(d*r)*Math.sin(f*a+Math.PI),i[u++]=o,i[u++]=l-s,i[u++]=h,i[u++]=o,i[u++]=l,i[u++]=h,i[u++]=1-f/this._slices,i[u++]=(d/this._stacks*(Math.PI*this._radius/2)+(this._height+Math.PI*this._radius/2))/(this._height+Math.PI*this._radius),d<this._stacks&&(n[_++]=c+d*(this._slices+1)+f,n[_++]=c+d*(this._slices+1)+f+(this._slices+1),n[_++]=c+d*(this._slices+1)+f+1,n[_++]=c+d*(this._slices+1)+f,n[_++]=c+d*(this._slices+1)+f+this._slices,n[_++]=c+d*(this._slices+1)+f+(this._slices+1));for(c+=(this._stacks+1)*(this._slices+1),f=0;f<=this._slices;f++)o=this._radius*Math.cos(f*a+Math.PI),l=s,h=this._radius*Math.sin(f*a+Math.PI),i[u++]=o,i[u+8*(this._slices+1)-1]=o,i[u++]=l,i[u+8*(this._slices+1)-1]=-l,i[u++]=h,i[u+8*(this._slices+1)-1]=h,i[u++]=o,i[u+8*(this._slices+1)-1]=o,i[u++]=0,i[u+8*(this._slices+1)-1]=0,i[u++]=h,i[u+8*(this._slices+1)-1]=h,i[u++]=1-1*f/this._slices,i[u+8*(this._slices+1)-1]=1-1*f/this._slices,i[u++]=Math.PI*this._radius/2/(this._height+Math.PI*this._radius),i[u+8*(this._slices+1)-1]=(Math.PI*this._radius/2+this._height)/(this._height+Math.PI*this._radius);for(f=0;f<this._slices;f++)n[_++]=f+c+(this._slices+1),n[_++]=f+c+1,n[_++]=f+c,n[_++]=f+c+(this._slices+1),n[_++]=f+c+(this._slices+1)+1,n[_++]=f+c+1;c+=2*(this._slices+1),this._vertexBuffer=new Ki(t,this._numberVertices,35044,!0),this._indexBuffer=new Zi("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(i),this._indexBuffer.setData(n),this.memorySize=2*(this._vertexBuffer._byteLength+this._indexBuffer._byteLength),this.completeCreate()},a(0,i,"radius",function(){return this._radius},function(t){this._radius!==t&&(this._radius=t,this.releaseResource(),this.activeResource())}),a(0,i,"height",function(){return this._height},function(t){this._height!==t&&(this._height=t,this.releaseResource(),this.activeResource())}),a(0,i,"stacks",function(){return this._stacks},function(t){this._stacks!==t&&(this._stacks=t,this.releaseResource(),this.activeResource())}),a(0,i,"slices",function(){return this._slices},function(t){this._slices!==t&&(this._slices=t,this.releaseResource(),this.activeResource())})}(nn),function(t){function e(t,i,n){this._radius=NaN,this._height=NaN,this._slices=0,void 0===t&&(t=.5),void 0===i&&(i=2),void 0===n&&(n=32),e.__super.call(this),this._radius=t,this._height=i,this._slices=n,this.recreateResource(),this._positions=this._getPositions(),this._generateBoundingObject()}r(e,"laya.d3.resource.models.CylinderMesh",t);var i=e.prototype;i.recreateResource=function(){this._numberVertices=this._slices+1+1+2*(this._slices+1)+(this._slices+1+1),this._numberIndices=3*this._slices+6*this._slices+3*this._slices;for(var t=Qt.vertexDeclaration,e=t.vertexStride/4,i=new Float32Array(this._numberVertices*e),n=new Uint16Array(this._numberIndices),r=2*Math.PI/this._slices,a=this._height/2,s=0,o=0,l=0,h=0,u=0,_=0,c=0,d=0;d<=this._slices;d++)0===d&&(i[_++]=0,i[_++]=a,i[_++]=0,i[_++]=0,i[_++]=1,i[_++]=0,i[_++]=.5,i[_++]=.5),s=d*r,l=Math.cos(s)*this._radius,h=a,u=Math.sin(s)*this._radius,i[_++]=l,i[_++]=h,i[_++]=u,i[_++]=0,i[_++]=1,i[_++]=0,i[_++]=.5+.5*Math.cos(s),i[_++]=.5+.5*Math.sin(s);for(var f=0;f<this._slices;f++)n[c++]=0,n[c++]=f+1,n[c++]=f+2;o+=this._slices+1+1;for(var m=0;m<=this._slices;m++)s=m*r,l=Math.cos(s+Math.PI)*this._radius,h=a,u=Math.sin(s+Math.PI)*this._radius,i[_++]=l,i[_+8*(this._slices+1)-1]=l,i[_++]=h,i[_+8*(this._slices+1)-1]=-h,i[_++]=u,i[_+8*(this._slices+1)-1]=u,i[_++]=l,i[_+8*(this._slices+1)-1]=l,i[_++]=0,i[_+8*(this._slices+1)-1]=0,i[_++]=u,i[_+8*(this._slices+1)-1]=u,i[_++]=1-1*m/this._slices,i[_+8*(this._slices+1)-1]=1-1*m/this._slices,i[_++]=0,i[_+8*(this._slices+1)-1]=1;_+=8*(this._slices+1);for(var p=0;p<this._slices;p++)n[c++]=p+o+(this._slices+1),n[c++]=p+o+1,n[c++]=p+o,n[c++]=p+o+(this._slices+1),n[c++]=p+o+(this._slices+1)+1,n[c++]=p+o+1;o+=2*(this._slices+1);for(var v=0;v<=this._slices;v++)0===v&&(i[_++]=0,i[_++]=-a,i[_++]=0,i[_++]=0,i[_++]=-1,i[_++]=0,i[_++]=.5,i[_++]=.5),s=v*r,l=Math.cos(s+Math.PI)*this._radius,h=-a,u=Math.sin(s+Math.PI)*this._radius,i[_++]=l,i[_++]=h,i[_++]=u,i[_++]=0,i[_++]=-1,i[_++]=0,i[_++]=.5+.5*Math.cos(s),i[_++]=.5+.5*Math.sin(s);for(var g=0;g<this._slices;g++)n[c++]=0+o,n[c++]=g+2+o,n[c++]=g+1+o;o+=this._slices+1+1,this._vertexBuffer=new Ki(t,this._numberVertices,35044,!0),this._indexBuffer=new Zi("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(i),this._indexBuffer.setData(n),this.memorySize=2*(this._vertexBuffer._byteLength+this._indexBuffer._byteLength),this.completeCreate()},a(0,i,"radius",function(){return this._radius},function(t){this._radius!==t&&(this._radius=t,this.releaseResource(),this.activeResource())}),a(0,i,"height",function(){return this._height},function(t){this._height!==t&&(this._height=t,this.releaseResource(),this.activeResource())}),a(0,i,"slices",function(){return this._slices},function(t){this._slices!==t&&(this._slices=t,this.releaseResource(),this.activeResource())})}(nn),function(t){function e(t,i,n,r){this._long=NaN,this._width=NaN,this._stacks=0,this._slices=0,void 0===t&&(t=10),void 0===i&&(i=10),void 0===n&&(n=10),void 0===r&&(r=10),e.__super.call(this),this._long=t,this._width=i,this._stacks=n,this._slices=r,this.activeResource(),this._positions=this._getPositions(),this._generateBoundingObject()}r(e,"laya.d3.resource.models.PlaneMesh",t);var i=e.prototype;i.recreateResource=function(){this._numberVertices=(this._stacks+1)*(this._slices+1),this._numberIndices=this._stacks*this._slices*2*3;for(var t=new Uint16Array(this._numberIndices),e=Qt.vertexDeclaration,i=e.vertexStride/4,n=new Float32Array(this._numberVertices*i),r=this._long/2,a=this._width/2,s=this._long/this._stacks,o=this._width/this._slices,l=0,h=0;h<=this._slices;h++)for(var u=0;u<=this._stacks;u++)n[l++]=u*s-r,n[l++]=0,n[l++]=h*o-a,n[l++]=0,n[l++]=1,n[l++]=0,n[l++]=1*u/this._stacks,n[l++]=1*h/this._slices;var _=0;for(h=0;h<this._slices;h++)for(u=0;u<this._stacks;u++)t[_++]=(h+1)*(this._stacks+1)+u,t[_++]=h*(this._stacks+1)+u,t[_++]=(h+1)*(this._stacks+1)+u+1,t[_++]=h*(this._stacks+1)+u,t[_++]=h*(this._stacks+1)+u+1,t[_++]=(h+1)*(this._stacks+1)+u+1;this._vertexBuffer=new Ki(e,this._numberVertices,35044,!0),this._indexBuffer=new Zi("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(n),this._indexBuffer.setData(t),this.memorySize=2*(this._vertexBuffer._byteLength+this._indexBuffer._byteLength),this.completeCreate()},a(0,i,"long",function(){return this._long},function(t){this._long!==t&&(this._long=t,this.releaseResource(),this.activeResource())}),a(0,i,"width",function(){return this._width},function(t){this._width!==t&&(this._width=t,this.releaseResource(),this.activeResource())}),a(0,i,"stacks",function(){return this._stacks},function(t){this._stacks!==t&&(this._stacks=t,this.releaseResource(),this.activeResource())}),a(0,i,"slices",function(){return this._slices},function(t){this._slices!==t&&(this._slices=t,this.releaseResource(),this.activeResource())})}(nn),function(t){function e(t,i){this._long=NaN,this._width=NaN,void 0===t&&(t=1),void 0===i&&(i=1),e.__super.call(this),this._long=t,this._width=i,this.activeResource(),this._positions=this._getPositions(),this._generateBoundingObject()}r(e,"laya.d3.resource.models.QuadMesh",t);var i=e.prototype;i.recreateResource=function(){this._numberVertices=4,this._numberIndices=6;var t=Qt.vertexDeclaration,e=(t.vertexStride,this._long/2),i=this._width/2,n=new Float32Array([-e,i,0,0,0,1,0,0,e,i,0,0,0,1,1,0,-e,-i,0,0,0,1,0,1,e,-i,0,0,0,1,1,1]),r=new Uint16Array([0,1,2,3,2,1]);this._vertexBuffer=new Ki(t,this._numberVertices,35044,!0),this._indexBuffer=new Zi("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(n),this._indexBuffer.setData(r),this.memorySize=2*(this._vertexBuffer._byteLength+this._indexBuffer._byteLength),this.completeCreate()},a(0,i,"long",function(){return this._long},function(t){this._long!==t&&(this._long=t,this.releaseResource(),this.activeResource())}),a(0,i,"width",function(){return this._width},function(t){this._width!==t&&(this._width=t,this.releaseResource(),this.activeResource())})}(nn),function(t){function e(t,i,n){this._radius=NaN,this._slices=0,this._stacks=0,void 0===t&&(t=.5),void 0===i&&(i=32),void 0===n&&(n=32),e.__super.call(this),this._radius=t,this._stacks=i,this._slices=n,this.activeResource(),this._positions=this._getPositions(),this._generateBoundingObject()}r(e,"laya.d3.resource.models.SphereMesh",t);var i=e.prototype;i.recreateResource=function(){this._numberVertices=(this._stacks+1)*(this._slices+1),this._numberIndices=3*this._stacks*(this._slices+1)*2;for(var t=new Uint16Array(this._numberIndices),e=Qt.vertexDeclaration,i=e.vertexStride/4,n=new Float32Array(this._numberVertices*i),r=Math.PI/this._stacks,a=2*Math.PI/this._slices,s=0,o=0,l=0,h=0;h<this._stacks+1;h++)for(var u=Math.sin(h*r),_=Math.cos(h*r),c=0;c<this._slices+1;c++){var d=u*Math.sin(c*a+1*Math.PI/2),f=u*Math.cos(c*a+1*Math.PI/2);n[o+0]=d*this._radius,n[o+1]=_*this._radius,n[o+2]=f*this._radius,n[o+3]=d,n[o+4]=_,n[o+5]=f,n[o+6]=c/this._slices,n[o+7]=h/this._stacks,o+=i,h!=this._stacks-1&&(t[l++]=s+(this._slices+1),t[l++]=s,t[l++]=s+1,t[l++]=s+this._slices,t[l++]=s,t[l++]=s+(this._slices+1),s++)}this._vertexBuffer=new Ki(e,this._numberVertices,35044,!0),this._indexBuffer=new Zi("ushort",this._numberIndices,35044,!0),this._vertexBuffer.setData(n),this._indexBuffer.setData(t),this.memorySize=2*(this._vertexBuffer._byteLength+this._indexBuffer._byteLength),this.completeCreate()},a(0,i,"radius",function(){return this._radius},function(t){this._radius!==t&&(this._radius=t,this.releaseResource(),this.activeResource())}),a(0,i,"slices",function(){return this._slices},function(t){this._slices!==t&&(this._slices=t,this.releaseResource(),this.activeResource())}),a(0,i,"stacks",function(){return this._stacks},function(t){this._stacks!==t&&(this._stacks=t,this.releaseResource(),this.activeResource())})}(nn),function(t){function e(t,i,n){void 0===t&&(t=0),void 0===i&&(i=.3),void 0===n&&(n=1e3),this._viewMatrix=new Ae,this._projectionMatrix=new Ae,this._projectionViewMatrix=new Ae,this._viewport=new Oe(0,0,0,0),this._normalizedViewport=new Oe(0,0,1,1),this._aspectRatio=t,this._boundFrustumUpdate=!0,this._boundFrustum=new Te(Ae.DEFAULT),e.__super.call(this,i,n),this.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChanged)}r(e,"laya.d3.core.Camera",t);var s=e.prototype;return s._onWorldMatrixChanged=function(){this._boundFrustumUpdate=!0},s._parseCustomProps=function(t,e,i,n){var r=i.clearColor;this.clearColor=new Le(r[0],r[1],r[2],r[3]);var a=i.viewport;this.normalizedViewport=new Oe(a[0],a[1],a[2],a[3])},s._calculateProjectionMatrix=function(){if(!this._useUserProjectionMatrix)if(this._orthographic){var t=this.orthographicVerticalSize*this.aspectRatio*.5,e=.5*this.orthographicVerticalSize;Ae.createOrthoOffCenterRH(-t,t,-e,e,this.nearPlane,this.farPlane,this._projectionMatrix)}else Ae.createPerspective(3.1416*this.fieldOfView/180,this.aspectRatio,this.nearPlane,this.farPlane,this._projectionMatrix);this._boundFrustumUpdate=!0},s._update=function(t){this.conchModel&&(this.conchModel.setViewMatrix(this.viewMatrix.elements),this.conchModel.setProjectMatrix(this.projectionMatrix.elements)),laya.d3.core.Sprite3D.prototype._update.call(this,t)},s._renderCamera=function(t,e,i){i.parallelSplitShadowMaps[0]&&i._renderShadowMap(t,e,this),e.camera=this,this._prepareCameraToRender(),i._preRenderUpdateComponents(e);var n,r;n=e._viewMatrix=this.viewMatrix;var a=this._renderTarget;a?(a.start(),Ae.multiply(_n._invertYScaleMatrix,this._projectionMatrix,_n._invertYProjectionMatrix),Ae.multiply(_n._invertYScaleMatrix,this.projectionViewMatrix,_n._invertYProjectionViewMatrix),r=e._projectionMatrix=_n._invertYProjectionMatrix,e._projectionViewMatrix=_n._invertYProjectionViewMatrix):(r=e._projectionMatrix=this._projectionMatrix,e._projectionViewMatrix=this.projectionViewMatrix),this._prepareCameraViewProject(n,r),e._viewport=this.viewport,i._preRenderScene(t,e,this.boundFrustum),i._clear(t,e),i._renderScene(t,e),i._postRenderUpdateComponents(e),a&&a.end()},s.viewportPointToRay=function(t,e){Ze.calculateCursorRay(t,this.viewport,this._projectionMatrix,this.viewMatrix,null,e)},s.normalizedViewportPointToRay=function(t,i){var n=e._tempVector20,r=this.viewport,a=t.elements,s=n.elements;s[0]=a[0]*r.width,s[1]=a[1]*r.height,Ze.calculateCursorRay(n,this.viewport,this._projectionMatrix,this.viewMatrix,null,i)},s.worldToViewportPoint=function(t,e){Ae.multiply(this._projectionMatrix,this._viewMatrix,this._projectionViewMatrix),this.viewport.project(t,this._projectionViewMatrix,e);var n=e.elements;e.z<0||e.z>1?n[0]=n[1]=n[2]=NaN:(n[0]=n[0]/i.stage.clientScaleX,n[1]=n[1]/i.stage.clientScaleY)},s.worldToNormalizedViewportPoint=function(t,e){Ae.multiply(this._projectionMatrix,this._viewMatrix,this._projectionViewMatrix),this.normalizedViewport.project(t,this._projectionViewMatrix,e);var n=e.elements;e.z<0||e.z>1?n[0]=n[1]=n[2]=NaN:(n[0]=n[0]/i.stage.clientScaleX,n[1]=n[1]/i.stage.clientScaleY)},s.convertScreenCoordToOrthographicCoord=function(t,e){if(this._orthographic){var i=ct.clientWidth,n=ct.clientHeight,r=this.orthographicVerticalSize*this.aspectRatio/i,a=this.orthographicVerticalSize/n,s=t.elements,o=e.elements;return o[0]=(-i/2+s[0])*r,o[1]=(n/2-s[1])*a,o[2]=(this.nearPlane-this.farPlane)*(s[2]+1)/2-this.nearPlane,Pe.transformCoordinate(e,this.transform.worldMatrix,e),!0}return!1},a(0,s,"projectionViewMatrix",function(){return Ae.multiply(this.projectionMatrix,this.viewMatrix,this._projectionViewMatrix),this._projectionViewMatrix}),a(0,s,"aspectRatio",function(){if(0===this._aspectRatio){var t=this.viewport;return t.width/t.height}return this._aspectRatio},function(t){if(t<0)throw new Error("Camera: the aspect ratio has to be a positive real number.");this._aspectRatio=t,this._calculateProjectionMatrix()}),a(0,s,"boundFrustum",function(){return this._boundFrustumUpdate&&(this._boundFrustum.matrix=this.projectionViewMatrix),this._boundFrustum}),a(0,s,"needViewport",function(){var t=this.normalizedViewport;return 0===t.x&&0===t.y&&1===t.width&&1===t.height}),a(0,s,"viewport",function(){if(this._viewportExpressedInClipSpace){var t=this._normalizedViewport,e=this.renderTargetSize,i=e.width,n=e.height;this._viewport.x=t.x*i,this._viewport.y=t.y*n,this._viewport.width=t.width*i,this._viewport.height=t.height*n}return this._viewport},function(t){if(null!=this.renderTarget&&(t.x<0||t.y<0||0==t.width||0==t.height))throw new Error("Camera: viewport size invalid.","value");this._viewportExpressedInClipSpace=!1,this._viewport=t,this._calculateProjectionMatrix()}),a(0,s,"normalizedViewport",function(){if(!this._viewportExpressedInClipSpace){var t=this._viewport,e=this.renderTargetSize,i=e.width,n=e.height;this._normalizedViewport.x=t.x/i,this._normalizedViewport.y=t.y/n,this._normalizedViewport.width=t.width/i,this._normalizedViewport.height=t.height/n}return this._normalizedViewport},function(t){t.x<0&&(t.x=0,console.warn("Camera: viewport.x must large than 0.0.")),t.y<0&&(t.y=0,console.warn("Camera: viewport.y must large than 0.0.")),t.x+t.width>1&&(t.width=1-t.x,console.warn("Camera: viewport.width + viewport.x must less than 1.0.")),t.y+t.height>1&&(t.height=1-t.y,console.warn("Camera: viewport.height + viewport.y must less than 1.0.")),this._viewportExpressedInClipSpace=!0,this._normalizedViewport=t,this._calculateProjectionMatrix()}),a(0,s,"projectionMatrix",function(){return this._projectionMatrix},function(t){this._projectionMatrix=t,this._useUserProjectionMatrix=!0}),a(0,s,"viewMatrix",function(){return this.transform.worldMatrix.invert(this._viewMatrix),this._viewMatrix}),n(e,["_tempVector20",function(){return this._tempVector20=new Ne}]),e}(_n)),pn=(function(t){function e(){e.__super.call(this),this._render=new yi(this),this._render.on("materialchanged",this,this._onMaterialChanged);var t=new Hi;this._render.sharedMaterial=t,this._geometryFilter=new Ni(this),t.renderMode=8,this._changeRenderObject(0)}r(e,"laya.d3.core.glitter.Glitter",t);var i=e.prototype;i._changeRenderObject=function(t){var e=this._render._renderElements,i=e[t];i||(i=e[t]=new ut),i._render=this._render;var n=this._render.sharedMaterials[t];n||(n=Hi.defaultMaterial);var r=this._geometryFilter;return i._mainSortID=0,i._sprite3D=this,i.renderObj=r,i._material=n,i},i._onMaterialChanged=function(t,e,i){e<t._renderElements.length&&this._changeRenderObject(e)},i._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render)},i._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render)},i._update=function(e){this._geometryFilter._update(e.elapsedTime),t.prototype._update.call(this,e)},i.addGlitterByPositions=function(t,e){this._geometryFilter.addVertexPosition(t,e)},i.addGlitterByPositionsVelocitys=function(t,e,i,n){this._geometryFilter.addVertexPositionVelocity(t,e,i,n)},i.cloneTo=function(t){var e=t,i=e.templet,n=this._geometryFilter;i.lifeTime=n.lifeTime,i.minSegmentDistance=n.minSegmentDistance,i.minInterpDistance=n.minInterpDistance,i.maxSlerpCount=n.maxSlerpCount,i._maxSegments=n._maxSegments;var r=e._render,a=this._render;r.sharedMaterials=a.sharedMaterials,r.enable=a.enable,laya.d3.core.Sprite3D.prototype.cloneTo.call(this,t)},i.destroy=function(e){void 0===e&&(e=!0),this.destroyed||(t.prototype.destroy.call(this,e),this._geometryFilter._destroy(),this._geometryFilter=null)},a(0,i,"templet",function(){return this._geometryFilter}),a(0,i,"glitterRender",function(){return this._render}),e.CURRENTTIME=2,e.DURATION=3}(cn),function(t){function e(){this._direction=null,this._updateDirection=!1,e.__super.call(this),this._updateDirection=!1,this._direction=new Pe,this.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChange)}r(e,"laya.d3.core.light.DirectionLight",t);var i=e.prototype;return i._initShadow=function(){if(this._shadow)this._parallelSplitShadowMap=new Ge,this.scene.parallelSplitShadowMaps.push(this._parallelSplitShadowMap),this.transform.worldMatrix.getForward(this._direction),Pe.normalize(this._direction,this._direction),this._parallelSplitShadowMap.setInfo(this.scene,this._shadowFarPlane,this._direction,this._shadowMapSize,this._shadowMapCount,this._shadowMapPCFType);else{var t=this.scene.parallelSplitShadowMaps;t.splice(t.indexOf(this._parallelSplitShadowMap),1),this._parallelSplitShadowMap.disposeAllRenderTarget(),this._parallelSplitShadowMap=null,this.scene.removeShaderDefine(Ge.SHADERDEFINE_SHADOW_PSSM1),this.scene.removeShaderDefine(Ge.SHADERDEFINE_SHADOW_PSSM2),this.scene.removeShaderDefine(Ge.SHADERDEFINE_SHADOW_PSSM3)}},i._addSelfRenderObjects=function(){t.prototype._addSelfRenderObjects.call(this),this._shadow&&this._initShadow()},i._clearSelfRenderObjects=function(){var t=this.scene,e=t._shaderValues;e.setValue(4,null),e.setValue(3,null),t.removeShaderDefine(ui.SHADERDEFINE_DIRECTIONLIGHT)},i._prepareToScene=function(t){var e=t.scene;if(e.enableLight&&this._activeInHierarchy){var i=e._shaderValues;return e.addShaderDefine(ui.SHADERDEFINE_DIRECTIONLIGHT),Pe.scale(this.color,this._intensity,this._intensityColor),i.setValue(4,this._intensityColor.elements),this.transform.worldMatrix.getForward(this._direction),Pe.normalize(this._direction,this._direction),i.setValue(3,this._direction.elements),!0}return e.removeShaderDefine(ui.SHADERDEFINE_DIRECTIONLIGHT),!1},i._onWorldMatrixChange=function(){this._updateDirection=!0},a(0,i,"shadow",t.prototype._$get_shadow,function(t){this._shadow!==t&&(this._shadow=t,this.scene&&this._initShadow())}),a(0,i,"direction",function(){return console.log("Warning: discard property,please use transform's property instead."),this._updateDirection&&(this.transform.worldMatrix.getForward(this._direction),Pe.normalize(this._direction,this._direction),this._updateDirection=!1),this._direction},function(t){console.log("Warning: discard property,please use transform's property instead.");var e=this.transform.worldMatrix;e.setForward(t),this.transform.worldMatrix=e,Pe.normalize(t,t),this._direction=t,this.shadow&&this._parallelSplitShadowMap&&this._parallelSplitShadowMap._setGlobalParallelLightDir(this._direction)}),e}(dn)),vn=(function(t){function e(){this._range=NaN,this._attenuation=null,e.__super.call(this),this._range=6,this._attenuation=new Pe(.6,.6,.6)}r(e,"laya.d3.core.light.PointLight",t);var i=e.prototype;i._clearSelfRenderObjects=function(){var t=this.scene,e=t._shaderValues;e.setValue(8,null),e.setValue(5,null),e.setValue(6,null),e.setValue(7,null),t.removeShaderDefine(ui.SHADERDEFINE_POINTLIGHT)},i._prepareToScene=function(t){var e=t.scene;if(e.enableLight&&this._activeInHierarchy){var i=e._shaderValues;return e.addShaderDefine(ui.SHADERDEFINE_POINTLIGHT),Pe.scale(this.color,this._intensity,this._intensityColor),i.setValue(8,this._intensityColor.elements),i.setValue(5,this.transform.position.elements),i.setValue(6,this.range),i.setValue(7,this.attenuation.elements),!0}return e.removeShaderDefine(ui.SHADERDEFINE_POINTLIGHT),!1},a(0,i,"range",function(){return this._range},function(t){this._range=t}),a(0,i,"attenuation",function(){return this._attenuation},function(t){this._attenuation=t})}(dn),function(t){function e(){this._updateDirection=!1,this._direction=null,this._spot=NaN,this._range=NaN,this._attenuation=null,e.__super.call(this),this._updateDirection=!1,this.direction=new Pe(0,-1,-1),this._attenuation=new Pe(.6,.6,.6),this._spot=96,this._range=6,this.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChange)}r(e,"laya.d3.core.light.SpotLight",t);var i=e.prototype;i._onWorldMatrixChange=function(){this._updateDirection=!0},i._clearSelfRenderObjects=function(){var t=this.scene,e=t._shaderValues;e.setValue(14,null),e.setValue(9,null),e.setValue(10,null),e.setValue(12,null),e.setValue(11,null),e.setValue(13,null),t.removeShaderDefine(ui.SHADERDEFINE_SPOTLIGHT)},i._prepareToScene=function(t){var e=t.scene;if(e.enableLight&&this._activeInHierarchy){var i=e._shaderValues;return e.addShaderDefine(ui.SHADERDEFINE_SPOTLIGHT),Pe.scale(this.color,this._intensity,this._intensityColor),i.setValue(14,this._intensityColor.elements),i.setValue(9,this.transform.position.elements),this.transform.worldMatrix.getForward(this._direction),Pe.normalize(this._direction,this._direction),i.setValue(10,this._direction.elements),i.setValue(12,this.range),i.setValue(11,this.spot),i.setValue(13,this.attenuation.elements),!0}return e.removeShaderDefine(ui.SHADERDEFINE_SPOTLIGHT),!1},a(0,i,"spot",function(){return this._spot},function(t){this._spot=t}),a(0,i,"direction",function(){return console.log("Warning: discard property,please use transform's property instead."),this._updateDirection&&(this.transform.worldMatrix.getForward(this._direction),this._updateDirection=!1),this._direction},function(t){console.log("Warning: discard property,please use transform's property instead.");var e=this.transform.worldMatrix;e.setForward(t),this.transform.worldMatrix=e,this._direction=t}),a(0,i,"range",function(){return this._range},function(t){this._range=t}),a(0,i,"attenuation",function(){return this._attenuation},function(t){this._attenuation=t})}(dn),function(t){function e(t,i){e.__super.call(this,i),this._geometryFilter=new Ai(this),this._render=new Ii(this),this._geometryFilter.on("meshchanged",this,this._onMeshChanged),this._render.on("materialchanged",this,this._onMaterialChanged),t&&(this._geometryFilter.sharedMesh=t,t instanceof laya.d3.resource.models.Mesh&&(t.loaded?this._render.sharedMaterials=t.materials:t.once("loaded",this,this._applyMeshMaterials)))}r(e,"laya.d3.core.MeshSprite3D",t);var s=e.prototype;return s._changeRenderObjectByMesh=function(t){var e=this._render._renderElements,i=e[t];i||(i=e[t]=new hi),i._render=this._render;var n=this._render.sharedMaterials[t];n||(n=Wi.defaultMaterial);var r=this._geometryFilter.sharedMesh.getRenderElement(t);if(i._mainSortID=this._getSortID(r,n),i._sprite3D=this,i.renderObj=r,i._material=n,D.isConchNode){var a=r._getVertexBuffer();i._conchSubmesh.setVBIB(a.vertexDeclaration._conchVertexDeclaration,a.getData(),r._getIndexBuffer().getData())}return i},s._changeRenderObjectByMaterial=function(t,e){var i=this._render._renderElements[t];e||(e=Wi.defaultMaterial);var n=this._geometryFilter.sharedMesh.getRenderElement(t);return i._mainSortID=this._getSortID(n,e),i._sprite3D=this,i.renderObj=n,i._material=e,D.isConchNode&&i._conchSubmesh.setMaterial(e._conchMaterial),i},s._changeRenderObjectsByMesh=function(){D.isConchNode;var t=this._geometryFilter.sharedMesh.getRenderElementsCount();this._render._renderElements.length=t;for(var e=0;e<t;e++)this._changeRenderObjectByMesh(e)},s._onMeshChanged=function(t){var e=t.sharedMesh;e.loaded?this._changeRenderObjectsByMesh():e.once("loaded",this,this._onMeshLoaded)},s._onMeshLoaded=function(t){t===this.meshFilter.sharedMesh&&this._changeRenderObjectsByMesh()},s._onMaterialChanged=function(t,e,i){e<this._render._renderElements.length&&this._changeRenderObjectByMaterial(e,i)},s._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render)},s._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render)},s._parseCustomProps=function(t,e,i,n){var r=this.meshRender,a=i.lightmapIndex;null!=a&&(r.lightmapIndex=a);var s=i.lightmapScaleOffset;s&&(r.lightmapScaleOffset=new Le(s[0],s[1],s[2],s[3]));var o,l;if(n.instanceParams)(o=n.instanceParams.loadPath)&&(l=E.getRes(e[o]),this.meshFilter.sharedMesh=l,l.loaded?r.sharedMaterials=l.materials:l.once("loaded",this,this._applyMeshMaterials));else{o=i.meshPath,o&&(l=E.getRes(e[o]),this.meshFilter.sharedMesh=l);var h=i.materials;if(h){var u=r.sharedMaterials,_=h.length;u.length=_;for(var c=0;c<_;c++)u[c]=E.getRes(e[h[c].path]);r.sharedMaterials=u}}},s._applyMeshMaterials=function(t){for(var e=this._render.sharedMaterials,i=t.materials,n=0,r=i.length;n<r;n++)e[n]||(e[n]=i[n]);this._render.sharedMaterials=e},s._addToInitStaticBatchManager=function(){e._staticBatchManager._addInitBatchSprite(this)},s.cloneTo=function(t){var e=t;e._geometryFilter.sharedMesh=this._geometryFilter.sharedMesh;var i=this._render,n=e._render;n.enable=i.enable,n.sharedMaterials=i.sharedMaterials,n.castShadow=i.castShadow;var r=i.lightmapScaleOffset;r&&(n.lightmapScaleOffset=r.clone()),n.lightmapIndex=i.lightmapIndex,n.receiveShadow=i.receiveShadow,n.sortingFudge=i.sortingFudge,laya.d3.core.Sprite3D.prototype.cloneTo.call(this,t)},s.destroy=function(e){if(void 0===e&&(e=!0),!this.destroyed){var i=this.meshFilter.sharedMesh;i.loaded||i.off("loaded",this,this._applyMeshMaterials),t.prototype.destroy.call(this,e),this._geometryFilter._destroy()}},s.createConchModel=function(){return null},a(0,s,"meshFilter",function(){return this._geometryFilter}),a(0,s,"meshRender",function(){return this._render}),e.__init__=function(){Mt._staticBatchManagers.push(e._staticBatchManager)},e.load=function(t){return i.loader.create(t,null,null,e)},n(e,["_staticBatchManager",function(){return this._staticBatchManager=new _i}]),e}(cn)),gn=function(t){function e(t){e.__super.call(this),this._render=new Ci(this),this._render.on("materialchanged",this,this._onMaterialChanged),this._geometryFilter=new Ri(this),this._createRenderElement(0),t&&(this._render.sharedMaterial=t)}r(e,"laya.d3.core.particleShuriKen.ShuriKenParticle3D",t);var s=e.prototype;return s._initParticleVelocity=function(t){for(var e=new $,i=t.velocitys,n=0,r=i.length;n<r;n++){var a=i[n];e.add(a.key,a.value)}return e},s._initParticleColor=function(t){var e=new q,i=t.alphas,n=0,r=0;for(n=0,r=i.length;n<r;n++){var a=i[n];e.addAlpha(a.key,a.value)}var s=t.rgbs;for(n=0,r=s.length;n<r;n++){var o=s[n],l=o.value;e.addRGB(o.key,new Pe(l[0],l[1],l[2]))}return e},s._initParticleSize=function(t){for(var e=new $,i=t.sizes,n=0,r=i.length;n<r;n++){var a=i[n];e.add(a.key,a.value)}return e},s._initParticleRotation=function(t){for(var e=new $,i=t.angularVelocitys,n=0,r=i.length;n<r;n++){var a=i[n];e.add(a.key,a.value/180*Math.PI)}return e},s._initParticleFrame=function(t){for(var e=new Q,i=t.frames,n=0,r=i.length;n<r;n++){var a=i[n];e.add(a.key,a.value)}return e},s._createRenderElement=function(t){var e=this._render._renderElements,i=e[t]=new ut;i._render=this._render;var n=this._render.sharedMaterials[t];n||(n=ji.defaultMaterial);var r=this._geometryFilter;i._mainSortID=0,i._sprite3D=this,i.renderObj=r,i._material=n},s._onMaterialChanged=function(t,e,i){var n=t._renderElements;if(e<n.length){n[e]._material=i||ji.defaultMaterial}},s._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render)},s._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render)},s._parseCustomProps=function(t,i,n,r){var a,s=Math.PI/180,o=0,l=0,h=this.particleRender,u=n.material;if(u)a=E.getRes(i[u.path]);else{var _=n.materialPath;_?a=E.getRes(i[_]):(a=new ji,a.diffuseTexture=i?E.getRes(i[n.texturePath]):ln.load(n.texturePath))}h.sharedMaterial=a;var c=n.meshPath;c&&(h.mesh=E.getRes(i[c])),h.renderMode=n.renderMode,h.stretchedBillboardCameraSpeedScale=n.stretchedBillboardCameraSpeedScale,h.stretchedBillboardSpeedScale=n.stretchedBillboardSpeedScale,h.stretchedBillboardLengthScale=n.stretchedBillboardLengthScale,h.sortingFudge=n.sortingFudge?n.sortingFudge:0;var d=this.particleSystem;d.isPerformanceMode=n.isPerformanceMode,d.duration=n.duration,d.looping=n.looping,d.prewarm=n.prewarm,d.startDelayType=n.startDelayType,d.startDelay=n.startDelay,d.startDelayMin=n.startDelayMin,d.startDelayMax=n.startDelayMax,d.startLifetimeType=n.startLifetimeType,d.startLifetimeConstant=n.startLifetimeConstant,d.startLifeTimeGradient=e._initStartLife(n.startLifetimeGradient),d.startLifetimeConstantMin=n.startLifetimeConstantMin,d.startLifetimeConstantMax=n.startLifetimeConstantMax,d.startLifeTimeGradientMin=e._initStartLife(n.startLifetimeGradientMin),d.startLifeTimeGradientMax=e._initStartLife(n.startLifetimeGradientMax),d.startSpeedType=n.startSpeedType,d.startSpeedConstant=n.startSpeedConstant,d.startSpeedConstantMin=n.startSpeedConstantMin,d.startSpeedConstantMax=n.startSpeedConstantMax,d.threeDStartSize=n.threeDStartSize,d.startSizeType=n.startSizeType,d.startSizeConstant=n.startSizeConstant;var f=n.startSizeConstantSeparate,m=d.startSizeConstantSeparate.elements;m[0]=f[0],m[1]=f[1],m[2]=f[2],d.startSizeConstantMin=n.startSizeConstantMin,d.startSizeConstantMax=n.startSizeConstantMax;var p=n.startSizeConstantMinSeparate,v=d.startSizeConstantMinSeparate.elements;v[0]=p[0],v[1]=p[1],v[2]=p[2];var g=n.startSizeConstantMaxSeparate,x=d.startSizeConstantMaxSeparate.elements;x[0]=g[0],x[1]=g[1],x[2]=g[2],d.threeDStartRotation=n.threeDStartRotation,d.startRotationType=n.startRotationType,d.startRotationConstant=n.startRotationConstant*s;var T=n.startRotationConstantSeparate,S=d.startRotationConstantSeparate.elements;S[0]=T[0]*s,S[1]=T[1]*s,S[2]=T[2]*s,d.startRotationConstantMin=n.startRotationConstantMin*s,d.startRotationConstantMax=n.startRotationConstantMax*s;var D=n.startRotationConstantMinSeparate,M=d.startRotationConstantMinSeparate.elements;M[0]=D[0]*s,M[1]=D[1]*s,M[2]=D[2]*s;var y=n.startRotationConstantMaxSeparate,A=d.startRotationConstantMaxSeparate.elements;A[0]=y[0]*s,A[1]=y[1]*s,A[2]=y[2]*s,d.randomizeRotationDirection=n.randomizeRotationDirection,d.startColorType=n.startColorType;var I=n.startColorConstant,R=d.startColorConstant.elements;R[0]=I[0],R[1]=I[1],R[2]=I[2],R[3]=I[3];var C=n.startColorConstantMin,b=d.startColorConstantMin.elements;b[0]=C[0],b[1]=C[1],b[2]=C[2],b[3]=C[3];var w=n.startColorConstantMax,N=d.startColorConstantMax.elements;N[0]=w[0],N[1]=w[1],N[2]=w[2],N[3]=w[3],d.gravityModifier=n.gravityModifier,d.simulationSpace=n.simulationSpace,d.scaleMode=n.scaleMode,d.playOnAwake=n.playOnAwake,d.maxParticles=n.maxParticles;var P=n.autoRandomSeed;null!=P&&(d.autoRandomSeed=P);var L=n.randomSeed;null!=L&&(d.randomSeed[0]=L);var O=n.emission;if(O){var V=d.emission;V.emissionRate=O.emissionRate;var F=O.bursts;if(F)for(o=0,l=F.length;o<l;o++){var B=F[o];V.addBurst(new W(B.time,B.min,B.max))}V.enbale=O.enable}else V.enbale=!1;var U=n.shape;if(U){var H;switch(U.shapeType){case 0:var G;H=G=new li,G.radius=U.sphereRadius,G.emitFromShell=U.sphereEmitFromShell,G.randomDirection=U.sphereRandomDirection;break;case 1:var z;H=z=new oi,z.radius=U.hemiSphereRadius,z.emitFromShell=U.hemiSphereEmitFromShell,z.randomDirection=U.hemiSphereRandomDirection;break;case 2:var k;H=k=new si,k.angle=U.coneAngle*s,k.radius=U.coneRadius,k.length=U.coneLength,k.emitType=U.coneEmitType,k.randomDirection=U.coneRandomDirection;break;case 3:var Y;H=Y=new ri,Y.x=U.boxX,Y.y=U.boxY,Y.z=U.boxZ,Y.randomDirection=U.boxRandomDirection;break;case 7:var q;H=q=new ai,q.radius=U.circleRadius,q.arc=U.circleArc*s,q.emitFromEdge=U.circleEmitFromEdge,q.randomDirection=U.circleRandomDirection;break;default:var Q;H=Q=new ai,Q.radius=U.circleRadius,Q.arc=U.circleArc*s,Q.emitFromEdge=U.circleEmitFromEdge,Q.randomDirection=U.circleRandomDirection}H.enable=U.enable,d.shape=H}var $=n.velocityOverLifetime;if($){var it,nt=$.velocity;switch(nt.type){case 0:var lt=nt.constant;it=tt.createByConstant(new Pe(lt[0],lt[1],lt[2]));break;case 1:it=tt.createByGradient(this._initParticleVelocity(nt.gradientX),this._initParticleVelocity(nt.gradientY),this._initParticleVelocity(nt.gradientZ));break;case 2:var ht=nt.constantMin,ut=nt.constantMax;it=tt.createByRandomTwoConstant(new Pe(ht[0],ht[1],ht[2]),new Pe(ut[0],ut[1],ut[2]));break;case 3:it=tt.createByRandomTwoGradient(this._initParticleVelocity(nt.gradientXMin),this._initParticleVelocity(nt.gradientXMax),this._initParticleVelocity(nt.gradientYMin),this._initParticleVelocity(nt.gradientYMax),this._initParticleVelocity(nt.gradientZMin),this._initParticleVelocity(nt.gradientZMax))}var _t=new ot(it);_t.space=$.space,_t.enbale=$.enable,d.velocityOverLifetime=_t}var ct=n.colorOverLifetime;if(ct){var dt,ft=ct.color;switch(ft.type){case 0:var mt=ft.constant;dt=j.createByConstant(new Le(mt[0],mt[1],mt[2],mt[3]));break;case 1:dt=j.createByGradient(this._initParticleColor(ft.gradient));break;case 2:var pt=ft.constantMin,vt=ft.constantMax;dt=j.createByRandomTwoConstant(new Le(pt[0],pt[1],pt[2],pt[3]),new Le(vt[0],vt[1],vt[2],vt[3]));break;case 3:dt=j.createByRandomTwoGradient(this._initParticleColor(ft.gradientMin),this._initParticleColor(ft.gradientMax))}var gt=new X(dt);gt.enbale=ct.enable,d.colorOverLifetime=gt}var Et=n.sizeOverLifetime;if(Et){var xt,Tt=Et.size;switch(Tt.type){case 0:xt=Tt.separateAxes?J.createByGradientSeparate(this._initParticleSize(Tt.gradientX),this._initParticleSize(Tt.gradientY),this._initParticleSize(Tt.gradientZ)):J.createByGradient(this._initParticleSize(Tt.gradient));break;case 1:if(Tt.separateAxes){var St=Tt.constantMinSeparate,Dt=Tt.constantMaxSeparate;xt=J.createByRandomTwoConstantSeparate(new Pe(St[0],St[1],St[2]),new Pe(Dt[0],Dt[1],Dt[2]))}else xt=J.createByRandomTwoConstant(Tt.constantMin,Tt.constantMax);break;case 2:xt=Tt.separateAxes?J.createByRandomTwoGradientSeparate(this._initParticleSize(Tt.gradientXMin),this._initParticleSize(Tt.gradientYMin),this._initParticleSize(Tt.gradientZMin),this._initParticleSize(Tt.gradientXMax),this._initParticleSize(Tt.gradientYMax),this._initParticleSize(Tt.gradientZMax)):J.createByRandomTwoGradient(this._initParticleSize(Tt.gradientMin),this._initParticleSize(Tt.gradientMax))}var Mt=new rt(xt);Mt.enbale=Et.enable,d.sizeOverLifetime=Mt}var yt=n.rotationOverLifetime;if(yt){var At,It=yt.angularVelocity;switch(It.type){case 0:It.separateAxes||(At=K.createByConstant(It.constant*s));break;case 1:It.separateAxes||(At=K.createByGradient(this._initParticleRotation(It.gradient)));break;case 2:if(It.separateAxes){var Rt=It.constantMinSeparate,Ct=It.constantMaxSeparate;At=K.createByRandomTwoConstantSeparate(new Pe(Rt[0]*s,Rt[1]*s,Rt[2]*s),new Pe(Ct[0]*s,Ct[1]*s,Ct[2]*s))}else At=K.createByRandomTwoConstant(It.constantMin*s,It.constantMax*s);break;case 3:It.separateAxes||(At=K.createByRandomTwoGradient(this._initParticleRotation(It.gradientMin),this._initParticleRotation(It.gradientMax)))}var bt=new et(At);bt.enbale=yt.enable,d.rotationOverLifetime=bt}var wt=n.textureSheetAnimation;if(wt){var Nt,Pt=wt.frame;switch(Pt.type){case 0:Nt=Z.createByConstant(Pt.constant);break;case 1:Nt=Z.createByOverTime(this._initParticleFrame(Pt.overTime));break;case 2:Nt=Z.createByRandomTwoConstant(Pt.constantMin,Pt.constantMax);break;case 3:Nt=Z.createByRandomTwoOverTime(this._initParticleFrame(Pt.overTimeMin),this._initParticleFrame(Pt.overTimeMax))}var Lt,Ot=wt.startFrame;switch(Ot.type){case 0:Lt=at.createByConstant(Ot.constant);break;case 1:Lt=at.createByRandomTwoConstant(Ot.constantMin,Ot.constantMax)}var Vt=new st(Nt,Lt);Vt.enable=wt.enable;var Ft=wt.tiles;Vt.tiles=new Ne(Ft[0],Ft[1]),Vt.type=wt.type,Vt.randomRow=wt.randomRow;var Bt=wt.rowIndex;void 0!==Bt&&(Vt.rowIndex=Bt),Vt.cycles=wt.cycles,d.textureSheetAnimation=Vt}},s._activeHierarchy=function(){laya.d3.core.Sprite3D.prototype._activeHierarchy.call(this),this.particleSystem.playOnAwake&&this.particleSystem.play()},s._inActiveHierarchy=function(){laya.d3.core.Sprite3D.prototype._inActiveHierarchy.call(this),this.particleSystem.isAlive&&this.particleSystem.simulate(0,!0)},s.cloneTo=function(t){var e=t,i=e._geometryFilter;this._geometryFilter.cloneTo(i);var n=e._render,r=this._render;n.sharedMaterials=r.sharedMaterials,n.enable=r.enable,n.renderMode=r.renderMode,n.mesh=r.mesh,n.stretchedBillboardCameraSpeedScale=r.stretchedBillboardCameraSpeedScale,n.stretchedBillboardSpeedScale=r.stretchedBillboardSpeedScale,n.stretchedBillboardLengthScale=r.stretchedBillboardLengthScale,n.sortingFudge=r.sortingFudge,laya.d3.core.Sprite3D.prototype.cloneTo.call(this,t)},s.destroy=function(e){void 0===e&&(e=!0),this.destroyed||(t.prototype.destroy.call(this,e),this._geometryFilter._destroy(),this._geometryFilter=null)},a(0,s,"particleSystem",function(){return this._geometryFilter}),a(0,s,"particleRender",function(){return this._render}),e.__init__=function(){e.SHADERDEFINE_RENDERMODE_BILLBOARD=e.shaderDefines.registerDefine("SPHERHBILLBOARD"),e.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD=e.shaderDefines.registerDefine("STRETCHEDBILLBOARD"),e.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD=e.shaderDefines.registerDefine("HORIZONTALBILLBOARD"),e.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD=e.shaderDefines.registerDefine("VERTICALBILLBOARD"),e.SHADERDEFINE_COLOROVERLIFETIME=e.shaderDefines.registerDefine("COLOROVERLIFETIME"),e.SHADERDEFINE_RANDOMCOLOROVERLIFETIME=e.shaderDefines.registerDefine("RANDOMCOLOROVERLIFETIME"),e.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT=e.shaderDefines.registerDefine("VELOCITYOVERLIFETIMECONSTANT"),e.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE=e.shaderDefines.registerDefine("VELOCITYOVERLIFETIMECURVE"),e.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT=e.shaderDefines.registerDefine("VELOCITYOVERLIFETIMERANDOMCONSTANT"),e.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE=e.shaderDefines.registerDefine("VELOCITYOVERLIFETIMERANDOMCURVE"),e.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE=e.shaderDefines.registerDefine("TEXTURESHEETANIMATIONCURVE"),e.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE=e.shaderDefines.registerDefine("TEXTURESHEETANIMATIONRANDOMCURVE"),e.SHADERDEFINE_ROTATIONOVERLIFETIME=e.shaderDefines.registerDefine("ROTATIONOVERLIFETIME"),e.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE=e.shaderDefines.registerDefine("ROTATIONOVERLIFETIMESEPERATE"),e.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT=e.shaderDefines.registerDefine("ROTATIONOVERLIFETIMECONSTANT"),e.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE=e.shaderDefines.registerDefine("ROTATIONOVERLIFETIMECURVE"),e.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS=e.shaderDefines.registerDefine("ROTATIONOVERLIFETIMERANDOMCURVES"),e.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES=e.shaderDefines.registerDefine("ROTATIONOVERLIFETIMERANDOMCURVES"),e.SHADERDEFINE_SIZEOVERLIFETIMECURVE=e.shaderDefines.registerDefine("SIZEOVERLIFETIMECURVE"),e.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE=e.shaderDefines.registerDefine("SIZEOVERLIFETIMECURVESEPERATE"),e.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES=e.shaderDefines.registerDefine("SIZEOVERLIFETIMERANDOMCURVES"),e.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE=e.shaderDefines.registerDefine("SIZEOVERLIFETIMERANDOMCURVESSEPERATE"),e.SHADERDEFINE_RENDERMODE_MESH=e.shaderDefines.registerDefine("RENDERMODE_MESH"),e.SHADERDEFINE_SHAPE=e.shaderDefines.registerDefine("SHAPE")},e.load=function(t){return i.loader.create(t,null,null,e)},e._initStartLife=function(t){for(var e=new $,i=t.startLifetimes,n=0,r=i.length;n<r;n++){var a=i[n];e.add(a.key,a.value)}return e},e.SHADERDEFINE_RENDERMODE_BILLBOARD=0,e.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD=0,e.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD=0,e.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD=0,e.SHADERDEFINE_COLOROVERLIFETIME=0,e.SHADERDEFINE_RANDOMCOLOROVERLIFETIME=0,e.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT=0,e.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE=0,e.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT=0,e.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE=0,e.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE=0,e.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE=0,e.SHADERDEFINE_ROTATIONOVERLIFETIME=0,e.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE=0,e.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT=0,e.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE=0,e.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS=0,e.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES=0,e.SHADERDEFINE_SIZEOVERLIFETIMECURVE=0,e.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE=0,e.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES=0,e.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE=0,e.SHADERDEFINE_RENDERMODE_MESH=0,e.SHADERDEFINE_SHAPE=0,e.WORLDPOSITION=0,e.WORLDROTATION=1,e.POSITIONSCALE=4,e.SIZESCALE=5,e.SCALINGMODE=6,e.GRAVITY=7,e.THREEDSTARTROTATION=8,e.STRETCHEDBILLBOARDLENGTHSCALE=9,e.STRETCHEDBILLBOARDSPEEDSCALE=10,e.SIMULATIONSPACE=11,e.CURRENTTIME=12,e.VOLVELOCITYCONST=13,e.VOLVELOCITYGRADIENTX=14,e.VOLVELOCITYGRADIENTY=15,e.VOLVELOCITYGRADIENTZ=16,e.VOLVELOCITYCONSTMAX=17,e.VOLVELOCITYGRADIENTXMAX=18,e.VOLVELOCITYGRADIENTYMAX=19,e.VOLVELOCITYGRADIENTZMAX=20,e.VOLSPACETYPE=21,e.COLOROVERLIFEGRADIENTALPHAS=22,e.COLOROVERLIFEGRADIENTCOLORS=23,e.MAXCOLOROVERLIFEGRADIENTALPHAS=24,e.MAXCOLOROVERLIFEGRADIENTCOLORS=25,e.SOLSIZEGRADIENT=26,e.SOLSIZEGRADIENTX=27,e.SOLSIZEGRADIENTY=28,e.SOLSizeGradientZ=29,e.SOLSizeGradientMax=30,e.SOLSIZEGRADIENTXMAX=31,e.SOLSIZEGRADIENTYMAX=32,e.SOLSizeGradientZMAX=33,e.ROLANGULARVELOCITYCONST=34,e.ROLANGULARVELOCITYCONSTSEPRARATE=35,e.ROLANGULARVELOCITYGRADIENT=36,e.ROLANGULARVELOCITYGRADIENTX=37,e.ROLANGULARVELOCITYGRADIENTY=38,e.ROLANGULARVELOCITYGRADIENTZ=39,e.ROLANGULARVELOCITYGRADIENTW=40,e.ROLANGULARVELOCITYCONSTMAX=41,e.ROLANGULARVELOCITYCONSTMAXSEPRARATE=42,e.ROLANGULARVELOCITYGRADIENTMAX=43,e.ROLANGULARVELOCITYGRADIENTXMAX=44,e.ROLANGULARVELOCITYGRADIENTYMAX=45,e.ROLANGULARVELOCITYGRADIENTZMAX=46,e.ROLANGULARVELOCITYGRADIENTWMAX=47,e.TEXTURESHEETANIMATIONCYCLES=48,e.TEXTURESHEETANIMATIONSUBUVLENGTH=49,e.TEXTURESHEETANIMATIONGRADIENTUVS=50,e.TEXTURESHEETANIMATIONGRADIENTMAXUVS=51,n(e,["shaderDefines",function(){return this.shaderDefines=new Be(cn.shaderDefines)}]),e}(cn),En=function(t){function e(t,i){this._subMeshOffset=null,e.__super.call(this,i),this._subMeshOffset=[],this._geometryFilter=new Ai(this),this._render=new un(this),this._geometryFilter.on("meshchanged",this,this._onMeshChanged),this._render.on("materialchanged",this,this._onMaterialChanged),t&&(this._geometryFilter.sharedMesh=t)}r(e,"laya.d3.core.SkinnedMeshSprite3D",t);var s=e.prototype;return s._changeRenderObjectByMesh=function(t){var e=this._render._renderElements,i=e[t];i||(i=e[t]=new hi),i._render=this._render;var n=this._render.sharedMaterials[t];n||(n=Wi.defaultMaterial);var r=this._geometryFilter.sharedMesh.getRenderElement(t);return i._mainSortID=this._getSortID(r,n),i._sprite3D=this,i.renderObj=r,i._material=n,i},s._changeRenderObjectByMaterial=function(t,e){var i=this._render._renderElements[t];e||(e=Wi.defaultMaterial);var n=this._geometryFilter.sharedMesh.getRenderElement(t);return i._mainSortID=this._getSortID(n,e),i._sprite3D=this,i.renderObj=n,i._material=e,i},s._changeRenderObjectsByMesh=function(){var t=this._geometryFilter.sharedMesh.getRenderElementsCount();this._render._renderElements.length=t;for(var e=0;e<t;e++)this._changeRenderObjectByMesh(e)},s._onMeshChanged=function(t){var e=t.sharedMesh;e.loaded?this._changeRenderObjectsByMesh():e.once("loaded",this,this._changeRenderObjectsByMesh)},s._onMaterialChanged=function(t,e,i){e<this._render._renderElements.length&&this._changeRenderObjectByMaterial(e,i)},s._parseCustomProps=function(t,e,i,n){var r=this.skinnedMeshRender,a=i.lightmapIndex;null!=a&&(r.lightmapIndex=a);var s=i.lightmapScaleOffset;s&&(r.lightmapScaleOffset=new Le(s[0],s[1],s[2],s[3]));var o,l;if(n.instanceParams)(o=n.instanceParams.loadPath)&&(l=E.getRes(e[o]),this.meshFilter.sharedMesh=l,l.loaded?r.sharedMaterials=l.materials:l.once("loaded",this,this._applyMeshMaterials));else{o=i.meshPath,o&&(l=E.getRes(e[o]),this.meshFilter.sharedMesh=l);var h=i.materials;if(h){var u=r.sharedMaterials,_=h.length;u.length=_;for(var c=0;c<_;c++)u[c]=E.getRes(e[h[c].path]);r.sharedMaterials=u}var d=i.rootBone;d&&r._setRootBone(d);var f=i.boundBox;if(f){var m=f.min,p=f.max,v=new xe(new Pe(m[0],m[1],m[2]),new Pe(p[0],p[1],p[2]));r.localBoundBox=v}else r._hasIndependentBound=!1;var g=i.boundSphere;if(g){var x=g.center,T=new Se(new Pe(x[0],x[1],x[2]),g.radius);r.localBoundSphere=T}}},s._changeHierarchyAnimator=function(t){if(t){var e=this.skinnedMeshRender;e._setCacheAnimator(t);var i=t.avatar;i&&e._setCacheAvatar(i)}laya.d3.core.Sprite3D.prototype._changeHierarchyAnimator.call(this,t)},s._clearSelfRenderObjects=function(){this._scene.removeFrustumCullingObject(this._render)},s._addSelfRenderObjects=function(){this._scene.addFrustumCullingObject(this._render)},s._applyMeshMaterials=function(t){for(var e=this._render.sharedMaterials,i=t.materials,n=0,r=i.length;n<r;n++)e[n]||(e[n]=i[n]);this._render.sharedMaterials=e},s.cloneTo=function(t){var e=t;e._geometryFilter.sharedMesh=this._geometryFilter.sharedMesh;var i=this._render,n=e._render;n.enable=i.enable,n.sharedMaterials=i.sharedMaterials,n.castShadow=i.castShadow;var r=i.lightmapScaleOffset;r&&(n.lightmapScaleOffset=r.clone()),n.receiveShadow=i.receiveShadow,n.sortingFudge=i.sortingFudge,n._rootBone=i._rootBone;var a=i.localBoundSphere;a&&(n.localBoundSphere=a.clone());var s=i.localBoundBox;s&&(n.localBoundBox=s.clone()),n._hasIndependentBound=i._hasIndependentBound,laya.d3.core.Sprite3D.prototype.cloneTo.call(this,t)},s.destroy=function(e){void 0===e&&(e=!0),this.destroyed||(t.prototype.destroy.call(this,e),this._geometryFilter._destroy())},s.createConchModel=function(){return null},a(0,s,"meshFilter",function(){return this._geometryFilter}),a(0,s,"skinnedMeshRender",function(){return this._render}),e.__init__=function(){e.SHADERDEFINE_BONE=e.shaderDefines.registerDefine("BONE")},e.load=function(t){return i.loader.create(t,null,null,e)},e.SHADERDEFINE_BONE=8,e.BONES=0,n(e,["shaderDefines",function(){return this.shaderDefines=new Be(cn.shaderDefines)}]),e}(cn),xn=(function(t){function e(t,i,n,r,a){void 0===t&&(t=.1),void 0===i&&(i=0),void 0===n&&(n=0),void 0===r&&(r=.3),void 0===a&&(a=1e3),this._tempMatrix=new Ae,this._leftViewMatrix=new Ae,this._leftProjectionMatrix=new Ae,this._leftProjectionViewMatrix=new Ae,this._leftViewport=new Oe(0,0,0,0),this._leftNormalizedViewport=new Oe(0,0,.5,1),this._leftAspectRatio=i,this._rightViewMatrix=new Ae,this._rightProjectionMatrix=new Ae,this._rightProjectionViewMatrix=new Ae,this._rightViewport=new Oe(0,0,0,0),this._rightNormalizedViewport=new Oe(.5,0,.5,1),this._rightAspectRatio=n,this._pupilDistande=t,this._leftBoundFrustumUpdate=!0,this._leftBoundFrustum=new Te(Ae.DEFAULT),this._rightBoundFrustumUpdate=!0,this._rightBoundFrustum=new Te(Ae.DEFAULT),e.__super.call(this,r,a),this.transform.on("worldmatrixneedchanged",this,this._onWorldMatrixChanged)}r(e,"laya.d3.core.VRCamera",t);var i=e.prototype;i._onWorldMatrixChanged=function(){this._leftBoundFrustumUpdate=this._rightBoundFrustumUpdate=!0},i._calculatePupilOffset=function(){var t=this._tempVector3;return Pe.scale(this.right,this._pupilDistande/2,t),t.elements},i._calculateLeftProjectionMatrix=function(){if(!this._useUserProjectionMatrix)if(this._orthographic){var t=this.orthographicVerticalSize*this.leftAspectRatio*.5,e=.5*this.orthographicVerticalSize;Ae.createOrthoOffCenterRH(-t,t,-e,e,this.nearPlane,this.farPlane,this._leftProjectionMatrix)}else Ae.createPerspective(3.1416*this.fieldOfView/180,this.leftAspectRatio,this.nearPlane,this.farPlane,this._rightProjectionMatrix);this._leftBoundFrustumUpdate=!0},i._calculateRightProjectionMatrix=function(){if(!this._useUserProjectionMatrix)if(this._orthographic){var t=this.orthographicVerticalSize*this.rightAspectRatio*.5,e=.5*this.orthographicVerticalSize;Ae.createOrthoOffCenterRH(-t,t,e,e,this.nearPlane,this.farPlane,this._rightProjectionMatrix)}else Ae.createPerspective(3.1416*this.fieldOfView/180,this.rightAspectRatio,this.nearPlane,this.farPlane,this._rightProjectionMatrix);this._rightBoundFrustumUpdate=!0},i._calculateProjectionMatrix=function(){if(!this._useUserProjectionMatrix)if(this._orthographic){var t=this.orthographicVerticalSize*this.leftAspectRatio*.5,e=.5*this.orthographicVerticalSize,i=this.orthographicVerticalSize*this.rightAspectRatio*.5,n=.5*this.orthographicVerticalSize;Ae.createOrthoOffCenterRH(-t,t,-e,e,this.nearPlane,this.farPlane,this._leftProjectionMatrix),Ae.createOrthoOffCenterRH(-i,i,n,n,this.nearPlane,this.farPlane,this._rightProjectionMatrix)}else Ae.createPerspective(3.1416*this.fieldOfView/180,this.leftAspectRatio,this.nearPlane,this.farPlane,this._leftProjectionMatrix),Ae.createPerspective(3.1416*this.fieldOfView/180,this.rightAspectRatio,this.nearPlane,this.farPlane,this._rightProjectionMatrix);this._leftBoundFrustumUpdate=this._rightBoundFrustumUpdate=!0},i._renderCamera=function(t,e,i){e.camera=this,this._prepareCameraToRender(),i._preRenderUpdateComponents(e);var n,r;n=e._viewMatrix=this.leftViewMatrix;var a=this._renderTarget;a?(a.start(),Ae.multiply(_n._invertYScaleMatrix,this._leftProjectionMatrix,_n._invertYProjectionMatrix),Ae.multiply(_n._invertYScaleMatrix,this.leftProjectionViewMatrix,_n._invertYProjectionViewMatrix),r=e._projectionMatrix=_n._invertYProjectionMatrix,e._projectionViewMatrix=_n._invertYProjectionViewMatrix):(r=e._projectionMatrix=this._leftProjectionMatrix,e._projectionViewMatrix=this.leftProjectionViewMatrix),this._prepareCameraViewProject(n,r),e._viewport=this.leftViewport,i._preRenderScene(t,e,this.leftBoundFrustum),i._clear(t,e),i._renderScene(t,e);var s,o;s=e._viewMatrix=this.rightViewMatrix,a?(a.start(),Ae.multiply(_n._invertYScaleMatrix,this._rightProjectionMatrix,_n._invertYProjectionMatrix),Ae.multiply(_n._invertYScaleMatrix,this.rightProjectionViewMatrix,_n._invertYProjectionViewMatrix),e._projectionMatrix=_n._invertYProjectionMatrix,o=e._projectionViewMatrix=_n._invertYProjectionViewMatrix):(o=e._projectionMatrix=this._rightProjectionMatrix,e._projectionViewMatrix=this.rightProjectionViewMatrix),this._prepareCameraViewProject(s,o),e._viewport=this.rightViewport,i._preRenderScene(t,e,this.rightBoundFrustum),i._clear(t,e),i._renderScene(t,e),i._postRenderUpdateComponents(e),a&&a.end()},a(0,i,"rightBoundFrustum",function(){return this._rightBoundFrustumUpdate&&(this._rightBoundFrustum.matrix=this.rightProjectionViewMatrix),this._rightBoundFrustum}),a(0,i,"leftNormalizedViewport",function(){if(!this._viewportExpressedInClipSpace){var t=this._leftViewport,e=this.renderTargetSize,i=e.width,n=e.height;this._leftNormalizedViewport.x=t.x/i,this._leftNormalizedViewport.y=t.y/n,this._leftNormalizedViewport.width=t.width/i,this._leftNormalizedViewport.height=t.height/n}return this._leftNormalizedViewport}),a(0,i,"rightViewport",function(){if(this._viewportExpressedInClipSpace){var t=this._rightNormalizedViewport,e=this.renderTargetSize,i=e.width,n=e.height;this._rightViewport.x=t.x*i,this._rightViewport.y=t.y*n,this._rightViewport.width=t.width*i,this._rightViewport.height=t.height*n}return this._rightViewport}),a(0,i,"viewport",null,function(t){if(null!=this.renderTarget&&(t.x<0||t.y<0||0==t.width||0==t.height))throw new Error("VRCamera: viewport size invalid.","value");this._viewportExpressedInClipSpace=!1,this._leftViewport=new Oe(0,0,t.width/2,t.height),this._rightViewport=new Oe(t.width/2,0,t.width/2,t.height),this._calculateProjectionMatrix()}),a(0,i,"leftAspectRatio",function(){if(0===this._leftAspectRatio){var t=this.leftViewport;return t.width/t.height}return this._leftAspectRatio}),a(0,i,"rightAspectRatio",function(){if(0===this._rightAspectRatio){var t=this.rightViewport;return t.width/t.height}return this._rightAspectRatio}),a(0,i,"aspectRatio",null,function(t){if(t<0)throw new Error("VRCamera: the aspect ratio has to be a positive real number.");this._leftAspectRatio=t,this._rightAspectRatio=t,this._calculateRightProjectionMatrix()}),a(0,i,"rightNormalizedViewport",function(){if(!this._viewportExpressedInClipSpace){var t=this._rightViewport,e=this.renderTargetSize,i=e.width,n=e.height;this._rightNormalizedViewport.x=t.x/i,this._rightNormalizedViewport.y=t.y/n,this._rightNormalizedViewport.width=t.width/i,this._rightNormalizedViewport.height=t.height/n}return this._rightNormalizedViewport}),a(0,i,"normalizedViewport",null,function(t){if(t.x<0||t.y<0||t.x+t.width>1||t.x+t.height>1)throw new Error("VRCamera: viewport size invalid.","value");this._viewportExpressedInClipSpace=!0,this._leftNormalizedViewport=new Oe(0,0,t.width/2,t.height),this._rightNormalizedViewport=new Oe(t.width/2,0,t.width/2,t.height),this._calculateProjectionMatrix()}),a(0,i,"leftViewport",function(){if(this._viewportExpressedInClipSpace){var t=this._leftNormalizedViewport,e=this.renderTargetSize,i=e.width,n=e.height;this._leftViewport.x=t.x*i,this._leftViewport.y=t.y*n,this._leftViewport.width=t.width*i,this._leftViewport.height=t.height*n}return this._leftViewport}),a(0,i,"needLeftViewport",function(){var t=this.leftNormalizedViewport;return 0===t.x&&0===t.y&&1===t.width&&1===t.height}),a(0,i,"needRightViewport",function(){var t=this.rightNormalizedViewport;return 0===t.x&&0===t.y&&1===t.width&&1===t.height}),a(0,i,"leftViewMatrix",function(){var t=this._calculatePupilOffset(),e=this._tempMatrix;this.transform.worldMatrix.cloneTo(e);var i=e.elements;return i[12]-=t[0],i[13]-=t[1],i[14]-=t[2],e.invert(this._leftViewMatrix),this._leftViewMatrix}),a(0,i,"rightViewMatrix",function(){var t=this._calculatePupilOffset(),e=this._tempMatrix;this.transform.worldMatrix.cloneTo(e);var i=e.elements;return i[12]+=t[0],i[13]+=t[1],i[14]+=t[2],e.invert(this._rightViewMatrix),this._rightViewMatrix}),a(0,i,"leftProjectionMatrix",function(){return this._leftProjectionMatrix}),a(0,i,"leftProjectionViewMatrix",function(){return Ae.multiply(this.leftProjectionMatrix,this.leftViewMatrix,this._leftProjectionViewMatrix),this._leftProjectionViewMatrix}),a(0,i,"rightProjectionMatrix",function(){return this._rightProjectionMatrix}),a(0,i,"rightProjectionViewMatrix",function(){return Ae.multiply(this.rightProjectionMatrix,this.rightViewMatrix,this._rightProjectionViewMatrix),this._rightProjectionViewMatrix}),a(0,i,"leftBoundFrustum",function(){return this._leftBoundFrustumUpdate&&(this._leftBoundFrustum.matrix=this.leftProjectionViewMatrix),this._leftBoundFrustum})}(_n),function(t){function e(){e.__super.call(this),this._geometryFilter=new bi(this),this._render=new wi(this),this._changeRenderObjectsByMaterial(this._render,0,qi.defaultMaterial),this._render.on("materialchanged",this,this._changeRenderObjectsByMaterial),this._geometryFilter.on("trailfilterchange",this,this._changeRenderObjectsByRenderElement)}r(e,"laya.d3.core.trail.TrailSprite3D",t);var i=e.prototype;return i._changeRenderObjectsByMaterial=function(t,e,i){var n=this._geometryFilter.getRenderElementsCount();this._render._renderElements.length=n;for(var r=0;r<n;r++)this._changeRenderObjectByMaterial(r,i)},i._changeRenderObjectByMaterial=function(t,e){var i=this._render._renderElements;e||(e=qi.defaultMaterial);var n=i[t];n||(n=i[t]=new ut),n._sprite3D=this,n.renderObj=this._geometryFilter.getRenderElement(t),n._render=this._render,n._material=e},i._changeRenderObjectsByRenderElement=function(t,e){var i=this._render._renderElements,n=i[t];n||(n=i[t]=new ut),n._sprite3D=this,n.renderObj=e,n._render=this._render,n._material=this._render.sharedMaterial},i._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render)},i._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render)},i._update=function(e){t.prototype._update.call(this,e),this._geometryFilter._update(e)},i._parseCustomProps=function(t,e,i,n){var r=this._render,a=this._geometryFilter,s=0,o=0,l=i.materials;if(l){var h=r.sharedMaterials,u=l.length;for(h.length=u,s=0;s<u;s++)h[s]=E.getRes(e[l[s].path]);r.sharedMaterials=h}var _=n.props;a.time=_.time,a.minVertexDistance=_.minVertexDistance,a.widthMultiplier=_.widthMultiplier,a.textureMode=_.textureMode;var c=[],d=i.widthCurve;for(s=0,o=d.length;s<o;s++){var f=new gt;f.time=d[s].time,f.inTangent=d[s].inTangent,f.outTangent=d[s].outTangent,f.value=d[s].value,c.push(f)}a.widthCurve=c;var m=i.colorGradient,p=new mt;p.mode=m.mode;var v,g,x=[],T=m.colorKeys;for(s=0,o=T.length;s<o;s++)g=T[s],v=new vt(new ft(g.value[0],g.value[1],g.value[2],1),g.time),x.push(v);var S,D,M=[],y=m.alphaKeys;for(s=0,o=y.length;s<o;s++)D=y[s],S=new pt(D.value,D.time),M.push(S);p.setKeys(x,M),a.colorGradient=p},i.destroy=function(e){void 0===e&&(e=!0),this.destroyed||(t.prototype.destroy.call(this,e),this._geometryFilter._destroy(),this._geometryFilter=null)},a(0,i,"trailFilter",function(){return this._geometryFilter}),a(0,i,"trailRender",function(){return this._render}),e.__init__=function(){e.SHADERDEFINE_GRADIENTMODE_BLEND=e.shaderDefines.registerDefine("GRADIENTMODE_BLEND")},e.CURTIME=3,e.LIFETIME=4,e.WIDTHCURVE=5,e.WIDTHCURVEKEYLENGTH=6,e.GRADIENTCOLORKEY=7,e.GRADIENTALPHAKEY=8,e.SHADERDEFINE_GRADIENTMODE_BLEND=0,n(e,["shaderDefines",function(){return this.shaderDefines=new Be(cn.shaderDefines)}]),e}(cn)),Tn=function(t){function e(t,i,n,r,a,s,o,l){e.__super.call(this,l),this._geometryFilter=new Pi(this,t,i,n,r,a,s,o),this._render=new Li(this)}r(e,"laya.d3.terrain.TerrainChunk",t);var n=e.prototype;return n.buildRenderElementAndMaterial=function(t,e,i,n,r,a,s,o,l,h,u,_,c,d,f,m,p,v){void 0===u&&(u=1),void 0===_&&(_=1),void 0===c&&(c=1),void 0===d&&(d=1),void 0===f&&(f=1),void 0===m&&(m=1),void 0===p&&(p=1),void 0===v&&(v=1);var g=new Xi;l&&(g.diffuseColor=l),o&&(g.ambientColor=o),h&&(g.specularColor=h),g.splatAlphaTexture=E.getRes(i),g.normalTexture=e?E.getRes(e):null,g.diffuseTexture1=n?E.getRes(n):null,g.diffuseTexture2=r?E.getRes(r):null,g.diffuseTexture3=a?E.getRes(a):null,g.diffuseTexture4=s?E.getRes(s):null,g.setDiffuseScale1(u,_),g.setDiffuseScale2(c,d),g.setDiffuseScale3(f,m),g.setDiffuseScale4(p,v),g.setDetailNum(t),0!=this._render._renderElements.length&&(g.renderMode=2);var x=new ut;x._mainSortID=0,x._sprite3D=this,x.renderObj=this._geometryFilter,x._material=g,this._render._materials.push(g),this._render._renderElements.push(x)},n.createConchModel=function(){return null},n._clearSelfRenderObjects=function(){this.scene.removeFrustumCullingObject(this._render)},n._addSelfRenderObjects=function(){this.scene.addFrustumCullingObject(this._render)},n._applyMeshMaterials=function(t){for(var e=this._render.sharedMaterials,i=t.materials,n=0,r=i.length;n<r;n++)e[n]||(e[n]=i[n]);this._render.sharedMaterials=e},n.cloneTo=function(t){console.log("Terrain Chunk can't clone")},n.destroy=function(e){void 0===e&&(e=!0),this.destroyed||(t.prototype.destroy.call(this,e),this._geometryFilter._destroy())},a(0,n,"terrainFilter",function(){return this._geometryFilter}),a(0,n,"terrainRender",function(){return this._render}),e.load=function(t){return i.loader.create(t,null,null,e,null,1,!1)},e}(cn);!function(t){function e(t,i,n){this._minX=NaN,this._minZ=NaN,this._cellSize=null,this._heightMap=null,e.__super.call(this,t,n),this._heightMap=i,this._cellSize=new Ne}r(e,"laya.d3.core.MeshTerrainSprite3D",t);var i=e.prototype;i._disableRotation=function(){var t=this.transform.rotation;t.elements[0]=0,t.elements[1]=0,t.elements[2]=0,t.elements[3]=1,this.transform.rotation=t},i._getScaleX=function(){var t=this.transform.worldMatrix,e=t.elements,i=e[0],n=e[1],r=e[2];return Math.sqrt(i*i+n*n+r*r)},i._getScaleZ=function(){var t=this.transform.worldMatrix,e=t.elements,i=e[8],n=e[9],r=e[10];return Math.sqrt(i*i+n*n+r*r)},i._initCreateFromMesh=function(t,e){this._heightMap=z.creatFromMesh(this.meshFilter.sharedMesh,t,e,this._cellSize);var i=this.meshFilter.sharedMesh.boundingBox,n=i.min;i.max;this._minX=n.x,this._minZ=n.z},i._initCreateFromMeshHeightMap=function(t,e,i){var n=this,r=this.meshFilter.sharedMesh.boundingBox;t.loaded?(this._heightMap=z.createFromImage(t,e,i),this._computeCellSize(r)):t.once("loaded",null,function(){n._heightMap=z.createFromImage(t,e,i),n._computeCellSize(r)});var a=r.min;r.max;this._minX=a.x,this._minZ=a.z},i._computeCellSize=function(t){var e=t.min,i=t.max,n=e.x,r=e.z,a=i.x,s=i.z,o=a-n,l=s-r;this._cellSize.elements[0]=o/(this._heightMap.width-1),this._cellSize.elements[1]=l/(this._heightMap.height-1)},i._update=function(t){this._disableRotation(),laya.d3.core.RenderableSprite3D.prototype._update.call(this,t)},i.getHeight=function(t,i){e._tempVector3.elements[0]=t,e._tempVector3.elements[1]=0,e._tempVector3.elements[2]=i,this._disableRotation();var n=this.transform.worldMatrix;n.invert(e._tempMatrix4x4),Pe.transformCoordinate(e._tempVector3,e._tempMatrix4x4,e._tempVector3),t=e._tempVector3.elements[0],i=e._tempVector3.elements[2];var r=(t-this._minX)/this._cellSize.x,a=(i-this._minZ)/this._cellSize.y,s=Math.floor(a),o=Math.floor(r),l=r-o,h=a-s,u=NaN,_=NaN,c=n.elements,d=c[4],f=c[5],m=c[6],p=Math.sqrt(d*d+f*f+m*m),v=c[13],g=this._heightMap.getHeight(s,o+1),E=this._heightMap.getHeight(s+1,o);if(isNaN(g)||isNaN(E))return NaN;if(l+h<=1){var x=this._heightMap.getHeight(s,o);return isNaN(x)?NaN:(u=g-x,_=E-x,(x+l*u+h*_)*p+v)}var T=this._heightMap.getHeight(s+1,o+1);return isNaN(T)?NaN:(u=E-T,_=g-T,(T+(1-l)*u+(1-h)*_)*p+v)},a(0,i,"minX",function(){var t=this.transform.worldMatrix,e=t.elements;return this._minX*this._getScaleX()+e[12]}),a(0,i,"width",function(){return(this._heightMap.width-1)*this._cellSize.x*this._getScaleX()}),a(0,i,"minZ",function(){var t=this.transform.worldMatrix,e=t.elements;return this._minZ*this._getScaleZ()+e[14]}),a(0,i,"depth",function(){return(this._heightMap.height-1)*this._cellSize.y*this._getScaleZ()}),e.createFromMesh=function(t,i,n,r){var a=new e(t,null,r);return t.loaded?a._initCreateFromMesh(i,n):t.once("loaded",a,a._initCreateFromMesh,[i,n]),a},e.createFromMeshAndHeightMap=function(t,i,n,r,a){var s=new e(t,null,a);return t.loaded?s._initCreateFromMeshHeightMap(i,n,r):t.once("loaded",s,s._initCreateFromMeshHeightMap,[i,n,r]),s},n(e,["_tempVector3",function(){return this._tempVector3=new Pe},"_tempMatrix4x4",function(){return this._tempMatrix4x4=new Ae}])}(vn)}(window,document,Laya),n=[i,e],void 0!==(r=function(t,e){"use strict";Object.defineProperty(e,"__esModule",{value:!0});for(var i in Laya){var n=Laya[i];n&&n.__isclass&&(e[i]=n)}}.apply(e,n))&&(t.exports=r)}],[2]);